<html>
<head>
<title>test_random.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_random.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">collections</span>
<span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">math</span>
<span class="s0">import </span><span class="s1">multiprocessing</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">random</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">from </span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">dedent</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">import </span><span class="s1">unittest</span>

<span class="s0">import </span><span class="s1">numba</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">jit</span><span class="s2">, </span><span class="s1">_helperlib</span><span class="s2">, </span><span class="s1">njit</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">types</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">support </span><span class="s0">import </span><span class="s1">TestCase</span><span class="s2">, </span><span class="s1">compile_function</span><span class="s2">, </span><span class="s1">tag</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">TypingError</span>


<span class="s3"># State size of the Mersenne Twister</span>
<span class="s1">N </span><span class="s2">= </span><span class="s4">624</span>


<span class="s0">def </span><span class="s1">get_py_state_ptr</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_get_py_state_ptr</span><span class="s2">()</span>

<span class="s0">def </span><span class="s1">get_np_state_ptr</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_get_np_state_ptr</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">numpy_randint1</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_randint2</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">random_randint</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">random_randrange1</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">random</span><span class="s2">.</span><span class="s1">randrange</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">random_randrange2</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">random</span><span class="s2">.</span><span class="s1">randrange</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">random_randrange3</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">random</span><span class="s2">.</span><span class="s1">randrange</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_choice1</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_choice2</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_choice3</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s1">replace</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_multinomial2</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">multinomial</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_multinomial3</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">multinomial</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">=</span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_dirichlet</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">dirichlet</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_dirichlet_default</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">dirichlet</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_noncentral_chisquare</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">noncentral_chisquare</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_noncentral_chisquare_default</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">noncentral_chisquare</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">numpy_check_rand</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">got </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span>

<span class="s0">def </span><span class="s1">numpy_check_randn</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">got </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span>

<span class="s0">def </span><span class="s1">jit_with_args</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">argstring</span><span class="s2">):</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s5">&quot;&quot;&quot;def func(%(argstring)s): 
        return %(name)s(%(argstring)s) 
&quot;&quot;&quot; </span><span class="s2">% </span><span class="s1">locals</span><span class="s2">()</span>
    <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s5">&quot;func&quot;</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>
    <span class="s0">return </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">jit_with_kwargs</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">kwarg_list</span><span class="s2">):</span>
    <span class="s3"># Similar to jit_with_args, but uses keyword arguments</span>
    <span class="s1">call_args_with_kwargs </span><span class="s2">= </span><span class="s5">','</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s5">f'</span><span class="s0">{</span><span class="s1">kw</span><span class="s0">}</span><span class="s5">=</span><span class="s0">{</span><span class="s1">kw</span><span class="s0">}</span><span class="s5">' </span><span class="s0">for </span><span class="s1">kw </span><span class="s0">in </span><span class="s1">kwarg_list</span><span class="s2">])</span>
    <span class="s1">signature </span><span class="s2">= </span><span class="s5">','</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">kwarg_list</span><span class="s2">)</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s5">f&quot;&quot;&quot;def func(</span><span class="s0">{</span><span class="s1">signature</span><span class="s0">}</span><span class="s5">):</span>
        <span class="s5">return </span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s5">(</span><span class="s0">{</span><span class="s1">call_args_with_kwargs</span><span class="s0">}</span><span class="s5">)</span>
<span class="s5">&quot;&quot;&quot;</span>
    <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s5">&quot;func&quot;</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>
    <span class="s0">return </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">jit_with_args</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">jit_with_args</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">jit_with_args</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s5">&quot;a, b&quot;</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">jit_ternary</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">jit_with_args</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s5">&quot;a, b, c&quot;</span><span class="s2">)</span>


<span class="s1">random_gauss </span><span class="s2">= </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.gauss&quot;</span><span class="s2">)</span>
<span class="s1">random_random </span><span class="s2">= </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;random.random&quot;</span><span class="s2">)</span>
<span class="s1">random_seed </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;random.seed&quot;</span><span class="s2">)</span>

<span class="s1">numpy_normal </span><span class="s2">= </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.normal&quot;</span><span class="s2">)</span>
<span class="s1">numpy_random </span><span class="s2">= </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.random&quot;</span><span class="s2">)</span>
<span class="s1">numpy_seed </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.seed&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_copy_py_state</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Copy state of Python random *r* to Numba state *ptr*. 
    &quot;&quot;&quot;</span>
    <span class="s1">mt </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">getstate</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">ints</span><span class="s2">, </span><span class="s1">index </span><span class="s2">= </span><span class="s1">mt</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">mt</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_set_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">, (</span><span class="s1">index</span><span class="s2">, </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ints</span><span class="s2">)))</span>
    <span class="s0">return </span><span class="s1">ints</span><span class="s2">, </span><span class="s1">index</span>

<span class="s0">def </span><span class="s1">_copy_np_state</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Copy state of Numpy random *r* to Numba state *ptr*. 
    &quot;&quot;&quot;</span>
    <span class="s1">ints</span><span class="s2">, </span><span class="s1">index </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">get_state</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">:</span><span class="s4">3</span><span class="s2">]</span>
    <span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_set_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">, (</span><span class="s1">index</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">ints</span><span class="s2">]))</span>
    <span class="s0">return </span><span class="s1">ints</span><span class="s2">, </span><span class="s1">index</span>

<span class="s0">def </span><span class="s1">sync_to_numpy</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
    <span class="s1">_ver</span><span class="s2">, </span><span class="s1">mt_st</span><span class="s2">, </span><span class="s1">_gauss_next </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">getstate</span><span class="s2">()</span>
    <span class="s1">mt_pos </span><span class="s2">= </span><span class="s1">mt_st</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">mt_ints </span><span class="s2">= </span><span class="s1">mt_st</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">mt_ints</span><span class="s2">) == </span><span class="s4">624</span>

    <span class="s1">np_st </span><span class="s2">= (</span><span class="s5">'MT19937'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">mt_ints</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">'uint32'</span><span class="s2">), </span><span class="s1">mt_pos</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">_gauss_next </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">np_st </span><span class="s2">+= (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">np_st </span><span class="s2">+= (</span><span class="s4">1</span><span class="s2">, </span><span class="s1">_gauss_next</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">set_state</span><span class="s2">(</span><span class="s1">np_st</span><span class="s2">)</span>

<span class="s3"># Pure Python equivalents of some of the Numpy distributions, using</span>
<span class="s3"># Python's basic generators.</span>

<span class="s0">def </span><span class="s1">py_chisquare</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">r</span><span class="s2">.</span><span class="s1">gammavariate</span><span class="s2">(</span><span class="s1">df </span><span class="s2">/ </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">py_f</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">denom</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">((</span><span class="s1">py_chisquare</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">num</span><span class="s2">) * </span><span class="s1">denom</span><span class="s2">) /</span>
            <span class="s2">(</span><span class="s1">py_chisquare</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">denom</span><span class="s2">) * </span><span class="s1">num</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">BaseTest</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s4">2</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">random</span><span class="s2">.</span><span class="s1">Random</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">_copy_py_state</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">r</span>

    <span class="s0">def </span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s4">2</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">_copy_np_state</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">r</span>


<span class="s0">class </span><span class="s1">TestInternals</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test low-level internals of the implementation. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">_check_get_set_state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_get_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">ints </span><span class="s2">= </span><span class="s1">state</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">ints</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ints</span><span class="s2">), </span><span class="s1">N</span><span class="s2">)</span>
        <span class="s1">j </span><span class="s2">= (</span><span class="s1">i </span><span class="s2">* </span><span class="s4">100007</span><span class="s2">) % </span><span class="s1">N</span>
        <span class="s1">ints </span><span class="s2">= [</span><span class="s1">i </span><span class="s2">* </span><span class="s4">3 </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s3"># Roundtrip</span>
        <span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_set_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">, (</span><span class="s1">j</span><span class="s2">, </span><span class="s1">ints</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_get_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">), (</span><span class="s1">j</span><span class="s2">, </span><span class="s1">ints</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_check_shuffle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s3"># We test shuffling against CPython</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">random</span><span class="s2">.</span><span class="s1">Random</span><span class="s2">()</span>
        <span class="s1">ints</span><span class="s2">, </span><span class="s1">index </span><span class="s2">= </span><span class="s1">_copy_py_state</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s3"># Force shuffling in CPython generator</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">N </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">r</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_shuffle</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s3"># Check new integer keys</span>
        <span class="s1">mt </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">getstate</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">ints</span><span class="s2">, </span><span class="s1">index </span><span class="s2">= </span><span class="s1">mt</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">mt</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_get_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ints</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_check_init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s3"># We use the same integer seeding as Numpy</span>
        <span class="s3"># (CPython is different: it treats the integer as a byte array)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">125</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">32 </span><span class="s2">- </span><span class="s4">5</span><span class="s2">]:</span>
            <span class="s3"># Need to cast to a C-sized int (for Numpy &lt;= 1.7)</span>
            <span class="s1">r</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>
            <span class="s1">st </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">get_state</span><span class="s2">()</span>
            <span class="s1">ints </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">st</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">st</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">index </span><span class="s2">== </span><span class="s1">N  </span><span class="s3"># sanity check</span>
            <span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_seed</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_get_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">), (</span><span class="s1">index</span><span class="s2">, </span><span class="s1">ints</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_check_perturb</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s1">states </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">):</span>
            <span class="s3"># Initialize with known state</span>
            <span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_seed</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s3"># Perturb with entropy</span>
            <span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_seed</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">urandom</span><span class="s2">(</span><span class="s4">512</span><span class="s2">))</span>
            <span class="s1">states</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">rnd_get_state</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s3"># No two identical states</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">states</span><span class="s2">)), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">states</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_get_set_state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_get_set_state</span><span class="s2">(</span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_shuffle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_shuffle</span><span class="s2">(</span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_init</span><span class="s2">(</span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_perturb</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_perturb</span><span class="s2">(</span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>


<span class="s0">class </span><span class="s1">TestRandom</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>

    <span class="s3"># NOTE: there may be cascading imprecision issues (e.g. between x87-using</span>
    <span class="s3"># C code and SSE-using LLVM code), which is especially brutal for some</span>
    <span class="s3"># iterative algorithms with sensitive exit conditions.</span>
    <span class="s3"># Therefore we stick to hardcoded integers for seed values.</span>

    <span class="s0">def </span><span class="s1">_check_random_seed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">seedfunc</span><span class="s2">, </span><span class="s1">randomfunc</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check seed()- and random()-like functions. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our seed() mimics NumPy's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">125</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">32 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]:</span>
            <span class="s3"># Need to cast to a C-sized int (for Numpy &lt;= 1.7)</span>
            <span class="s1">r</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>
            <span class="s1">seedfunc</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s3"># Be sure to trigger a reshuffle</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N </span><span class="s2">+ </span><span class="s4">10</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">randomfunc</span><span class="s2">(), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_random_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_seed</span><span class="s2">(</span><span class="s1">random_seed</span><span class="s2">, </span><span class="s1">random_random</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_seed</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">numpy_random</span><span class="s2">)</span>
        <span class="s3"># Test aliases</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_seed</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.random_sample&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_seed</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.ranf&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_seed</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.sample&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_seed</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.rand&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_check_random_sized</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">seedfunc</span><span class="s2">, </span><span class="s1">randomfunc</span><span class="s2">):</span>
        <span class="s3"># Our seed() mimics NumPy's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">125</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">32 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]:</span>
            <span class="s3"># Need to cast to a C-sized int (for Numpy &lt;= 1.7)</span>
            <span class="s1">r</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>
            <span class="s1">seedfunc</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">randomfunc</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_random_sized</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_sized</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.random_sample&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_sized</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.ranf&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_sized</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.sample&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_random_sized</span><span class="s2">(</span><span class="s1">numpy_seed</span><span class="s2">, </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.rand&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_independent_generators</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># PRNGs for Numpy and Python are independent.</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">random_seed</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">py_numbers </span><span class="s2">= [</span><span class="s1">random_random</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">numpy_seed</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">np_numbers </span><span class="s2">= [</span><span class="s1">numpy_random</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">random_seed</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">numpy_seed</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">pairs </span><span class="s2">= [(</span><span class="s1">random_random</span><span class="s2">(), </span><span class="s1">numpy_random</span><span class="s2">()) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">([</span><span class="s1">p</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">pairs</span><span class="s2">], </span><span class="s1">py_numbers</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">([</span><span class="s1">p</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">pairs</span><span class="s2">], </span><span class="s1">np_numbers</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_getrandbits</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a getrandbits()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows CPython's for bits &lt;= 64.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">nbits </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">65</span><span class="s2">):</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">getrandbits</span><span class="s2">(</span><span class="s1">nbits</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">nbits</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">OverflowError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s4">65</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">OverflowError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s4">9999999</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">OverflowError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_getrandbits</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_getrandbits</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;random.getrandbits&quot;</span><span class="s2">), </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s3"># Explanation for the large ulps value: on 32-bit platforms, our</span>
    <span class="s3"># LLVM-compiled functions use SSE but they are compared against</span>
    <span class="s3"># C functions which use x87.</span>
    <span class="s3"># On some distributions, the errors seem to accumulate dramatically.</span>

    <span class="s0">def </span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">argslist</span><span class="s2">, </span><span class="s1">niters</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
                    <span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">12</span><span class="s2">, </span><span class="s1">pydtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">argslist</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">args </span><span class="s0">in </span><span class="s1">argslist</span><span class="s2">:</span>
            <span class="s1">results </span><span class="s2">= [</span><span class="s1">func</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">niters</span><span class="s2">)]</span>
            <span class="s1">pyresults </span><span class="s2">= [(</span><span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">pydtype</span><span class="s2">) </span><span class="s0">if </span><span class="s1">pydtype </span><span class="s0">else </span><span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">))</span>
                         <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">niters</span><span class="s2">)]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">results</span><span class="s2">, </span><span class="s1">pyresults</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s1">prec</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s1">ulps</span><span class="s2">,</span>
                                    <span class="s1">msg</span><span class="s2">=</span><span class="s5">&quot;for arguments %s&quot; </span><span class="s2">% (</span><span class="s1">args</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">_check_dist_kwargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">kwargslist</span><span class="s2">, </span><span class="s1">niters</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
                           <span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">12</span><span class="s2">, </span><span class="s1">pydtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">kwargslist</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">kwargs </span><span class="s0">in </span><span class="s1">kwargslist</span><span class="s2">:</span>
            <span class="s1">results </span><span class="s2">= [</span><span class="s1">func</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">niters</span><span class="s2">)]</span>
            <span class="s1">pyresults </span><span class="s2">= [(</span><span class="s1">pyfunc</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">pydtype</span><span class="s2">) </span><span class="s0">if </span><span class="s1">pydtype </span><span class="s0">else </span><span class="s1">pyfunc</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">))</span>
                         <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">niters</span><span class="s2">)]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">results</span><span class="s2">, </span><span class="s1">pyresults</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s1">prec</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s1">ulps</span><span class="s2">,</span>
                                    <span class="s1">msg</span><span class="s2">=</span><span class="s5">&quot;for arguments %s&quot; </span><span class="s2">% (</span><span class="s1">kwargs</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">_check_gauss</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s1">func0</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a gauss()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Numpy's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func2 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">,</span>
                             <span class="s2">[(</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), (</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">), (-</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)],</span>
                             <span class="s1">niters</span><span class="s2">=</span><span class="s1">N </span><span class="s2">// </span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func1 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func1</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, [(</span><span class="s4">0.5</span><span class="s2">,)])</span>
        <span class="s0">if </span><span class="s1">func0 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, [()])</span>

    <span class="s0">def </span><span class="s1">test_random_gauss</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gauss</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.gauss&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_random_normalvariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># normalvariate() is really an alias to gauss() in Numba</span>
        <span class="s3"># (not in Python, though - they use different algorithms)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gauss</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.normalvariate&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">,</span>
                          <span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_normal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gauss</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.normal&quot;</span><span class="s2">),</span>
                          <span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.normal&quot;</span><span class="s2">),</span>
                          <span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.normal&quot;</span><span class="s2">),</span>
                          <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_normal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gauss</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.standard_normal&quot;</span><span class="s2">),</span>
                          <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_randn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gauss</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.randn&quot;</span><span class="s2">),</span>
                          <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_lognormvariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s1">func0</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a lognormvariate()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Numpy's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func2 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">lognormal</span><span class="s2">,</span>
                             <span class="s2">[(</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), (</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">), (-</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)],</span>
                             <span class="s1">niters</span><span class="s2">=</span><span class="s1">N </span><span class="s2">// </span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func1 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func1</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">lognormal</span><span class="s2">, [(</span><span class="s4">0.5</span><span class="s2">,)])</span>
        <span class="s0">if </span><span class="s1">func0 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">lognormal</span><span class="s2">, [()])</span>

    <span class="s0">def </span><span class="s1">test_random_lognormvariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_lognormvariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.lognormvariate&quot;</span><span class="s2">),</span>
                                   <span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_lognormal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_lognormvariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.lognormal&quot;</span><span class="s2">),</span>
                                   <span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.lognormal&quot;</span><span class="s2">),</span>
                                   <span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.lognormal&quot;</span><span class="s2">),</span>
                                   <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_randrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s1">func3</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">max_width</span><span class="s2">, </span><span class="s1">is_numpy</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a randrange()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Sanity check</span>
        <span class="s1">ints </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">):</span>
            <span class="s1">ints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">func1</span><span class="s2">(</span><span class="s4">500000000</span><span class="s2">))</span>
            <span class="s1">ints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">func2</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">500000000</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">func3 </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">ints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">func3</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">500000000</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">is_numpy</span><span class="s2">:</span>
            <span class="s1">rr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">).</span><span class="s1">randint</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">rr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">).</span><span class="s1">randrange</span>
        <span class="s1">widths </span><span class="s2">= [</span><span class="s1">w </span><span class="s0">for </span><span class="s1">w </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">5000</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">40</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">62 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">**</span><span class="s4">61</span><span class="s2">] </span><span class="s0">if </span><span class="s1">w </span><span class="s2">&lt; </span><span class="s1">max_width</span><span class="s2">]</span>
        <span class="s1">pydtype </span><span class="s2">= </span><span class="s1">tp </span><span class="s0">if </span><span class="s1">is_numpy </span><span class="s0">else None</span>
        <span class="s0">for </span><span class="s1">width </span><span class="s0">in </span><span class="s1">widths</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func1</span><span class="s2">, </span><span class="s1">rr</span><span class="s2">, [(</span><span class="s1">width</span><span class="s2">,)], </span><span class="s1">niters</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
                            <span class="s1">pydtype</span><span class="s2">=</span><span class="s1">pydtype</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func2</span><span class="s2">, </span><span class="s1">rr</span><span class="s2">, [(-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">+</span><span class="s1">width</span><span class="s2">)], </span><span class="s1">niters</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
                            <span class="s1">pydtype</span><span class="s2">=</span><span class="s1">pydtype</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">func3 </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func3</span><span class="s2">(-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">, </span><span class="s4">6</span><span class="s2">),</span>
                                        <span class="s1">rr</span><span class="s2">(-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">, </span><span class="s4">6</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func3</span><span class="s2">(</span><span class="s4">2 </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">),</span>
                                        <span class="s1">rr</span><span class="s2">(</span><span class="s4">2 </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s3"># Empty ranges</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, -</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func3 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func3</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_randrange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">tp</span><span class="s2">, </span><span class="s1">max_width </span><span class="s0">in </span><span class="s2">[(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">63</span><span class="s2">), (</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">31</span><span class="s2">)]:</span>
            <span class="s1">cf1 </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">((</span><span class="s1">tp</span><span class="s2">,))(</span><span class="s1">random_randrange1</span><span class="s2">)</span>
            <span class="s1">cf2 </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">((</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">,),)(</span><span class="s1">random_randrange2</span><span class="s2">)</span>
            <span class="s1">cf3 </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">((</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">,))(</span><span class="s1">random_randrange3</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_randrange</span><span class="s2">(</span><span class="s1">cf1</span><span class="s2">, </span><span class="s1">cf2</span><span class="s2">, </span><span class="s1">cf3</span><span class="s2">, </span><span class="s1">get_py_state_ptr</span><span class="s2">(),</span>
                                  <span class="s1">max_width</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_randint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">tp</span><span class="s2">, </span><span class="s1">np_tp</span><span class="s2">, </span><span class="s1">max_width </span><span class="s0">in </span><span class="s2">[(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">63</span><span class="s2">),</span>
                                     <span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">31</span><span class="s2">)]:</span>
            <span class="s1">cf1 </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">((</span><span class="s1">tp</span><span class="s2">,))(</span><span class="s1">numpy_randint1</span><span class="s2">)</span>
            <span class="s1">cf2 </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">((</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">,))(</span><span class="s1">numpy_randint2</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_randrange</span><span class="s2">(</span><span class="s1">cf1</span><span class="s2">, </span><span class="s1">cf2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">get_np_state_ptr</span><span class="s2">(), </span><span class="s1">max_width</span><span class="s2">,</span>
                                  <span class="s0">True</span><span class="s2">, </span><span class="s1">np_tp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_randint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">max_width</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a randint()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Sanity check</span>
        <span class="s1">ints </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">):</span>
            <span class="s1">ints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">500000000</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ints</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">ints</span><span class="s2">)), </span><span class="s1">ints</span><span class="s2">)</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">args </span><span class="s0">in </span><span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (</span><span class="s4">13</span><span class="s2">, </span><span class="s4">5000</span><span class="s2">), (</span><span class="s4">20</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">62 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">**</span><span class="s4">61</span><span class="s2">)]:</span>
            <span class="s0">if </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &gt; </span><span class="s1">max_width</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">, [</span><span class="s1">args</span><span class="s2">], </span><span class="s1">niters</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s3"># Empty ranges</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_randint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">tp</span><span class="s2">, </span><span class="s1">max_width </span><span class="s0">in </span><span class="s2">[(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">63</span><span class="s2">), (</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">31</span><span class="s2">)]:</span>
            <span class="s1">cf </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">((</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">,))(</span><span class="s1">random_randint</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_randint</span><span class="s2">(</span><span class="s1">cf</span><span class="s2">, </span><span class="s1">get_py_state_ptr</span><span class="s2">(), </span><span class="s1">max_width</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_uniform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a uniform()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Python's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1e6</span><span class="s2">), (-</span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">1e3</span><span class="s2">), (</span><span class="s4">1.5</span><span class="s2">, -</span><span class="s4">2.5</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">_check_any_distrib_kwargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">distrib</span><span class="s2">, </span><span class="s1">paramlist</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check any numpy distribution function. Does Numba use the same keyword 
        argument names as Numpy? 
        And given a fixed seed, do they both return the same samples? 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Numpy's (not Python's)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s1">distrib_method_of_numpy </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">distrib</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist_kwargs</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">distrib_method_of_numpy</span><span class="s2">, </span><span class="s1">paramlist</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">test_random_uniform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_uniform</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.uniform&quot;</span><span class="s2">), </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_uniform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_uniform</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.uniform&quot;</span><span class="s2">), </span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_uniform_kwargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_any_distrib_kwargs</span><span class="s2">(</span>
            <span class="s1">jit_with_kwargs</span><span class="s2">(</span><span class="s5">&quot;np.random.uniform&quot;</span><span class="s2">, [</span><span class="s5">'low'</span><span class="s2">, </span><span class="s5">'high'</span><span class="s2">]),</span>
            <span class="s1">get_np_state_ptr</span><span class="s2">(),</span>
            <span class="s5">'uniform'</span><span class="s2">,</span>
            <span class="s1">paramlist</span><span class="s2">=[{</span><span class="s5">'low'</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">, </span><span class="s5">'high'</span><span class="s2">: </span><span class="s4">1e6</span><span class="s2">},</span>
                       <span class="s2">{</span><span class="s5">'low'</span><span class="s2">: -</span><span class="s4">2.5</span><span class="s2">, </span><span class="s5">'high'</span><span class="s2">: </span><span class="s4">1e3</span><span class="s2">},</span>
                       <span class="s2">{</span><span class="s5">'low'</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">, </span><span class="s5">'high'</span><span class="s2">: -</span><span class="s4">2.5</span><span class="s2">}])</span>

    <span class="s0">def </span><span class="s1">_check_triangular</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s1">func3</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a triangular()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Python's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func2 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">triangular</span><span class="s2">,</span>
                             <span class="s2">[(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">), (-</span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">), (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func3</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">triangular</span><span class="s2">, [(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_random_triangular</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_triangular</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.triangular&quot;</span><span class="s2">),</span>
                               <span class="s1">jit_ternary</span><span class="s2">(</span><span class="s5">&quot;random.triangular&quot;</span><span class="s2">),</span>
                               <span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_triangular</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">triangular </span><span class="s2">= </span><span class="s1">jit_ternary</span><span class="s2">(</span><span class="s5">&quot;np.random.triangular&quot;</span><span class="s2">)</span>
        <span class="s1">fixed_triangular </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">m</span><span class="s2">: </span><span class="s1">triangular</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_triangular</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">fixed_triangular</span><span class="s2">, </span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_gammavariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a gammavariate()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Python's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func2 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">gammavariate</span><span class="s2">,</span>
                             <span class="s2">[(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">), (</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">), (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">)])</span>
        <span class="s0">if </span><span class="s1">func1 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func1</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">gammavariate</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">))</span>
        <span class="s3"># Invalid inputs</span>
        <span class="s0">if </span><span class="s1">func2 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func1 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_gammavariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gammavariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.gammavariate&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">,</span>
                                 <span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_gamma</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gammavariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.gamma&quot;</span><span class="s2">),</span>
                                 <span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.gamma&quot;</span><span class="s2">),</span>
                                 <span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gammavariate</span><span class="s2">(</span><span class="s0">None</span><span class="s2">,</span>
                                 <span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.standard_gamma&quot;</span><span class="s2">),</span>
                                 <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_betavariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a betavariate()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Python's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">betavariate</span><span class="s2">, [(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">)])</span>
        <span class="s3"># Invalid inputs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_betavariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_betavariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.betavariate&quot;</span><span class="s2">), </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_beta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_betavariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.beta&quot;</span><span class="s2">), </span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_vonmisesvariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a vonmisesvariate()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">vonmisesvariate</span><span class="s2">, [(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_random_vonmisesvariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_vonmisesvariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.vonmisesvariate&quot;</span><span class="s2">),</span>
                                    <span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_vonmises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_vonmisesvariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.vonmises&quot;</span><span class="s2">),</span>
                                    <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_expovariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a expovariate()-like function.  Note the second argument 
        is inversed compared to np.random.exponential(). 
        &quot;&quot;&quot;</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">lambd </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">lambd</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">exponential</span><span class="s2">(</span><span class="s4">1 </span><span class="s2">/ </span><span class="s1">lambd</span><span class="s2">),</span>
                                        <span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_expovariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_expovariate</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;random.expovariate&quot;</span><span class="s2">), </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_exponential</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s1">func0</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a exponential()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func1 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func1</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">exponential</span><span class="s2">, [(</span><span class="s4">0.5</span><span class="s2">,), (</span><span class="s4">1.0</span><span class="s2">,), (</span><span class="s4">1.5</span><span class="s2">,)])</span>
        <span class="s0">if </span><span class="s1">func0 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">exponential</span><span class="s2">, [()])</span>

    <span class="s0">def </span><span class="s1">test_numpy_exponential</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_exponential</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.exponential&quot;</span><span class="s2">),</span>
                                <span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.exponential&quot;</span><span class="s2">),</span>
                                <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_exponential</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_exponential</span><span class="s2">(</span><span class="s0">None</span><span class="s2">,</span>
                                <span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.standard_exponential&quot;</span><span class="s2">),</span>
                                <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_paretovariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a paretovariate()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Python's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">paretovariate</span><span class="s2">, [(</span><span class="s4">0.5</span><span class="s2">,), (</span><span class="s4">3.5</span><span class="s2">,)])</span>

    <span class="s0">def </span><span class="s1">test_random_paretovariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_paretovariate</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;random.paretovariate&quot;</span><span class="s2">), </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_pareto</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pareto </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.pareto&quot;</span><span class="s2">)</span>
        <span class="s1">fixed_pareto </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">pareto</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) + </span><span class="s4">1.0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_paretovariate</span><span class="s2">(</span><span class="s1">fixed_pareto</span><span class="s2">, </span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_check_weibullvariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func2</span><span class="s2">, </span><span class="s1">func1</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a weibullvariate()-like function. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Our implementation follows Python's.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">func2 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">func2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">weibullvariate</span><span class="s2">, [(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">)])</span>
        <span class="s0">if </span><span class="s1">func1 </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func1</span><span class="s2">(</span><span class="s4">2.5</span><span class="s2">),</span>
                                        <span class="s1">r</span><span class="s2">.</span><span class="s1">weibullvariate</span><span class="s2">(</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_random_weibullvariate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_weibullvariate</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;random.weibullvariate&quot;</span><span class="s2">),</span>
                                   <span class="s0">None</span><span class="s2">, </span><span class="s1">get_py_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_weibull</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_weibullvariate</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.weibull&quot;</span><span class="s2">),</span>
                                   <span class="s1">get_np_state_ptr</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_numpy_binomial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># We follow Numpy's algorithm up to n*p == 30</span>
        <span class="s1">binomial </span><span class="s2">= </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.binomial&quot;</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">(), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">binomial</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">binomial</span><span class="s2">, [(</span><span class="s4">18</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">)])</span>
        <span class="s3"># Sanity check many values</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">, </span><span class="s4">10000</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">binomial</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">binomial</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0.0001</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">, </span><span class="s4">0.49999</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.50001</span><span class="s2">, </span><span class="s4">0.8</span><span class="s2">, </span><span class="s4">0.9</span><span class="s2">, </span><span class="s4">0.9999</span><span class="s2">):</span>
                <span class="s1">r </span><span class="s2">= </span><span class="s1">binomial</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">p </span><span class="s2">&gt; </span><span class="s4">0.5</span><span class="s2">:</span>
                    <span class="s1">r </span><span class="s2">= </span><span class="s1">n </span><span class="s2">- </span><span class="s1">r</span>
                    <span class="s1">p </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">- </span><span class="s1">p</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">p </span><span class="s2">* </span><span class="s1">n</span>
                <span class="s1">tol </span><span class="s2">= </span><span class="s4">3 </span><span class="s2">* </span><span class="s1">n </span><span class="s2">/ </span><span class="s1">math</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">expected </span><span class="s2">- </span><span class="s1">tol</span><span class="s2">, (</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">r</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">expected </span><span class="s2">+ </span><span class="s1">tol</span><span class="s2">, (</span><span class="s1">p</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">r</span><span class="s2">))</span>
        <span class="s3"># Invalid values</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">binomial</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">binomial</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">binomial</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">1.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_chisquare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">chisquare </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.chisquare&quot;</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">chisquare</span><span class="s2">,</span>
                         <span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">(</span><span class="s1">py_chisquare</span><span class="s2">, </span><span class="s1">r</span><span class="s2">),</span>
                         <span class="s2">[(</span><span class="s4">1.5</span><span class="s2">,), (</span><span class="s4">2.5</span><span class="s2">,)])</span>

    <span class="s0">def </span><span class="s1">test_numpy_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.f&quot;</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">(</span><span class="s1">py_f</span><span class="s2">, </span><span class="s1">r</span><span class="s2">),</span>
                         <span class="s2">[(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">), (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.8</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_numpy_geometric</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">geom </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.geometric&quot;</span><span class="s2">)</span>
        <span class="s3"># p out of domain</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">geom</span><span class="s2">, -</span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">geom</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">geom</span><span class="s2">, </span><span class="s4">1.001</span><span class="s2">)</span>
        <span class="s3"># Some basic checks</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">geom</span><span class="s2">(</span><span class="s4">1.0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">] * </span><span class="s1">N</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">geom</span><span class="s2">(</span><span class="s4">0.9</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">N </span><span class="s2">// </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLess</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertFalse</span><span class="s2">([</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">r </span><span class="s0">if </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">1000</span><span class="s2">])  </span><span class="s3"># unlikely</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">geom</span><span class="s2">(</span><span class="s4">0.4</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">([</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">r </span><span class="s0">if </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">4</span><span class="s2">])  </span><span class="s3"># likely</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">geom</span><span class="s2">(</span><span class="s4">0.01</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">([</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">r </span><span class="s0">if </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">50</span><span class="s2">])  </span><span class="s3"># likely</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">geom</span><span class="s2">(</span><span class="s4">1e-15</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">([</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">r </span><span class="s0">if </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">2</span><span class="s2">**</span><span class="s4">32</span><span class="s2">])  </span><span class="s3"># likely</span>

    <span class="s0">def </span><span class="s1">test_numpy_gumbel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">gumbel </span><span class="s2">= </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.gumbel&quot;</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">gumbel</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">gumbel</span><span class="s2">, [(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), (-</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_numpy_gumbel_kwargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_any_distrib_kwargs</span><span class="s2">(</span>
            <span class="s1">jit_with_kwargs</span><span class="s2">(</span><span class="s5">&quot;np.random.gumbel&quot;</span><span class="s2">, [</span><span class="s5">'loc'</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">]),</span>
            <span class="s1">get_np_state_ptr</span><span class="s2">(),</span>
            <span class="s1">distrib</span><span class="s2">=</span><span class="s5">&quot;gumbel&quot;</span><span class="s2">,</span>
            <span class="s1">paramlist</span><span class="s2">=[{</span><span class="s5">'loc'</span><span class="s2">: </span><span class="s4">0.0</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.0</span><span class="s2">},</span>
                       <span class="s2">{</span><span class="s5">'loc'</span><span class="s2">: -</span><span class="s4">1.5</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">3.5</span><span class="s2">}])</span>


    <span class="s0">def </span><span class="s1">test_numpy_hypergeometric</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Our implementation follows Numpy's up to nsamples = 10.</span>
        <span class="s1">hg </span><span class="s2">= </span><span class="s1">jit_ternary</span><span class="s2">(</span><span class="s5">&quot;np.random.hypergeometric&quot;</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">hg</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">hypergeometric</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">1000</span><span class="s2">, </span><span class="s4">5000</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s4">5000</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)],</span>
                         <span class="s1">niters</span><span class="s2">=</span><span class="s4">30</span><span class="s2">)</span>
        <span class="s3"># Sanity checks</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">hg</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">, </span><span class="s4">100</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">all</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s4">100 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">r</span><span class="s2">), </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">r</span><span class="s2">), </span><span class="s4">40.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">r</span><span class="s2">), </span><span class="s4">60.0</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">hg</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">, </span><span class="s4">100000</span><span class="s2">, </span><span class="s4">100</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">all</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s4">100 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">r</span><span class="s2">), </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">r</span><span class="s2">), </span><span class="s4">10.0</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= [</span><span class="s1">hg</span><span class="s2">(</span><span class="s4">100000</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">, </span><span class="s4">100</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">all</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s4">100 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">r</span><span class="s2">), </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">r</span><span class="s2">), </span><span class="s4">90.0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_laplace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.laplace&quot;</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">laplace</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), (-</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.laplace&quot;</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">laplace</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.0</span><span class="s2">,), (-</span><span class="s4">1.5</span><span class="s2">,)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.laplace&quot;</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">laplace</span><span class="s2">, [()])</span>

    <span class="s0">def </span><span class="s1">test_numpy_logistic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.logistic&quot;</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">logistic</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), (-</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.logistic&quot;</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">logistic</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.0</span><span class="s2">,), (-</span><span class="s4">1.5</span><span class="s2">,)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.logistic&quot;</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">logistic</span><span class="s2">, [()])</span>

    <span class="s0">def </span><span class="s1">test_numpy_logseries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">logseries </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.logseries&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">logseries</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">logseries</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.1</span><span class="s2">,), (</span><span class="s4">0.99</span><span class="s2">,), (</span><span class="s4">0.9999</span><span class="s2">,)],</span>
                         <span class="s1">niters</span><span class="s2">=</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s3"># Numpy's logseries overflows on 32-bit builds, so instead</span>
        <span class="s3"># hardcode Numpy's (correct) output on 64-bit builds.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">(), </span><span class="s1">seed</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">([</span><span class="s1">logseries</span><span class="s2">(</span><span class="s4">0.9999999999999</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)],</span>
                         <span class="s2">[</span><span class="s4">2022733531</span><span class="s2">, </span><span class="s4">77296</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, </span><span class="s4">52204</span><span class="s2">, </span><span class="s4">9341294</span><span class="s2">, </span><span class="s4">703057324</span><span class="s2">,</span>
                          <span class="s4">413147702918</span><span class="s2">, </span><span class="s4">1870715907</span><span class="s2">, </span><span class="s4">16009330</span><span class="s2">, </span><span class="s4">738</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">logseries</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">logseries</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">logseries</span><span class="s2">, </span><span class="s4">1.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_poisson</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">poisson </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.poisson&quot;</span><span class="s2">)</span>
        <span class="s3"># Our implementation follows Numpy's.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">poisson</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">poisson</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.0</span><span class="s2">,), (</span><span class="s4">0.5</span><span class="s2">,), (</span><span class="s4">2.0</span><span class="s2">,), (</span><span class="s4">10.0</span><span class="s2">,), (</span><span class="s4">900.5</span><span class="s2">,)],</span>
                         <span class="s1">niters</span><span class="s2">=</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">poisson</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_negative_binomial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">(), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">negbin </span><span class="s2">= </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.negative_binomial&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">([</span><span class="s1">negbin</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">0.9</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)],</span>
                         <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">([</span><span class="s1">negbin</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)],</span>
                         <span class="s2">[</span><span class="s4">55</span><span class="s2">, </span><span class="s4">71</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">57</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s4">34</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">101</span><span class="s2">, </span><span class="s4">67</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">([</span><span class="s1">negbin</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)],</span>
                         <span class="s2">[</span><span class="s4">9203</span><span class="s2">, </span><span class="s4">8640</span><span class="s2">, </span><span class="s4">9081</span><span class="s2">, </span><span class="s4">9292</span><span class="s2">, </span><span class="s4">8938</span><span class="s2">,</span>
                          <span class="s4">9165</span><span class="s2">, </span><span class="s4">9149</span><span class="s2">, </span><span class="s4">8774</span><span class="s2">, </span><span class="s4">8886</span><span class="s2">, </span><span class="s4">9117</span><span class="s2">])</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">([</span><span class="s1">negbin</span><span class="s2">(</span><span class="s4">1000000000</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">)</span>
                     <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreater</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">9e9 </span><span class="s2">* </span><span class="s4">0.99</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLess</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">9e9 </span><span class="s2">* </span><span class="s4">1.01</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">negbin</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">negbin</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">negbin</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">negbin</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">1.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">power </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.power&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">power</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">power</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.1</span><span class="s2">,), (</span><span class="s4">0.5</span><span class="s2">,), (</span><span class="s4">0.9</span><span class="s2">,), (</span><span class="s4">6.0</span><span class="s2">,)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">power</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">power</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_rayleigh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">rayleigh1 </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.rayleigh&quot;</span><span class="s2">)</span>
        <span class="s1">rayleigh0 </span><span class="s2">= </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.rayleigh&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">rayleigh1</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">rayleigh</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s4">0.1</span><span class="s2">,), (</span><span class="s4">0.8</span><span class="s2">,), (</span><span class="s4">25.</span><span class="s2">,), (</span><span class="s4">1e3</span><span class="s2">,)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">rayleigh0</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">rayleigh</span><span class="s2">, [()])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">rayleigh1</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">rayleigh1</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_cauchy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">cauchy </span><span class="s2">= </span><span class="s1">jit_nullary</span><span class="s2">(</span><span class="s5">&quot;np.random.standard_cauchy&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">cauchy</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">standard_cauchy</span><span class="s2">, [()])</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_t</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># We use CPython's algorithm for the gamma dist and numpy's</span>
        <span class="s3"># for the normal dist.  Standard T calls both so we can't check</span>
        <span class="s3"># against either generator's output.</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">standard_t </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.standard_t&quot;</span><span class="s2">)</span>
        <span class="s1">avg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">([</span><span class="s1">standard_t</span><span class="s2">(</span><span class="s4">5</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5000</span><span class="s2">)])</span>
        <span class="s3"># Sanity check</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLess</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">avg</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_wald</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">wald </span><span class="s2">= </span><span class="s1">jit_binary</span><span class="s2">(</span><span class="s5">&quot;np.random.wald&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">wald</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">wald</span><span class="s2">, [(</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), (</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">)])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">wald</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">wald</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">wald</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">wald</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_wald_kwargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">numba_version </span><span class="s2">= </span><span class="s1">jit_with_kwargs</span><span class="s2">(</span><span class="s5">&quot;np.random.wald&quot;</span><span class="s2">, [</span><span class="s5">'mean'</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_any_distrib_kwargs</span><span class="s2">(</span><span class="s1">numba_version</span><span class="s2">,</span>
                                       <span class="s1">get_np_state_ptr</span><span class="s2">(),</span>
                                       <span class="s1">distrib</span><span class="s2">=</span><span class="s5">&quot;wald&quot;</span><span class="s2">,</span>
                                       <span class="s1">paramlist</span><span class="s2">=[{</span><span class="s5">'mean'</span><span class="s2">: </span><span class="s4">1.0</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.0</span><span class="s2">},</span>
                                                  <span class="s2">{</span><span class="s5">'mean'</span><span class="s2">: </span><span class="s4">2.0</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">5.0</span><span class="s2">}])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">numba_version</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">numba_version</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">numba_version</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">numba_version</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_zipf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">zipf </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.zipf&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">zipf</span><span class="s2">, </span><span class="s1">r</span><span class="s2">.</span><span class="s1">zipf</span><span class="s2">, [(</span><span class="s4">1.5</span><span class="s2">,), (</span><span class="s4">2.5</span><span class="s2">,)], </span><span class="s1">niters</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s2">(</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, -</span><span class="s4">0.1</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">zipf</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_shuffle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">is_numpy</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check a shuffle()-like function for arrays. 
        &quot;&quot;&quot;</span>
        <span class="s1">arrs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">20</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">8</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))]</span>
        <span class="s0">if </span><span class="s1">is_numpy</span><span class="s2">:</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
                <span class="s1">got </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">func</span><span class="s2">(</span><span class="s1">got</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">is_numpy </span><span class="s0">or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">) == </span><span class="s4">1</span><span class="s2">:</span>
                    <span class="s1">r</span><span class="s2">.</span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
        <span class="s3"># Test with an arbitrary buffer-providing object</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arrs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">func</span><span class="s2">(</span><span class="s1">memoryview</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertNotEqual</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
        <span class="s3"># Read-only object</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertTypingError</span><span class="s2">():</span>
            <span class="s1">func</span><span class="s2">(</span><span class="s1">memoryview</span><span class="s2">(</span><span class="s7">b&quot;xyz&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_random_shuffle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_shuffle</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;random.shuffle&quot;</span><span class="s2">), </span><span class="s1">get_py_state_ptr</span><span class="s2">(), </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_shuffle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_shuffle</span><span class="s2">(</span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.shuffle&quot;</span><span class="s2">), </span><span class="s1">get_np_state_ptr</span><span class="s2">(), </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_startup_randomness</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func_name</span><span class="s2">, </span><span class="s1">func_args</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check that the state is properly randomized at startup. 
        &quot;&quot;&quot;</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s5">&quot;&quot;&quot;if 1: 
            from numba.tests import test_random 
            func = getattr(test_random, %(func_name)r) 
            print(func(*%(func_args)r)) 
            &quot;&quot;&quot; </span><span class="s2">% (</span><span class="s1">locals</span><span class="s2">())</span>
        <span class="s1">numbers </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">popen </span><span class="s2">= </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">Popen</span><span class="s2">([</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s5">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">code</span><span class="s2">],</span>
                                     <span class="s1">stdout</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">PIPE</span><span class="s2">, </span><span class="s1">stderr</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">PIPE</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">, </span><span class="s1">err </span><span class="s2">= </span><span class="s1">popen</span><span class="s2">.</span><span class="s1">communicate</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">popen</span><span class="s2">.</span><span class="s1">returncode </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s5">&quot;process failed with code %s: stderr follows</span><span class="s0">\n</span><span class="s5">%s</span><span class="s0">\n</span><span class="s5">&quot;</span>
                                     <span class="s2">% (</span><span class="s1">popen</span><span class="s2">.</span><span class="s1">returncode</span><span class="s2">, </span><span class="s1">err</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">()))</span>
            <span class="s1">numbers</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">numbers</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s1">numbers</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_random_startup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_startup_randomness</span><span class="s2">(</span><span class="s5">&quot;random_random&quot;</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">test_random_gauss_startup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_startup_randomness</span><span class="s2">(</span><span class="s5">&quot;random_gauss&quot;</span><span class="s2">, (</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_random_startup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_startup_randomness</span><span class="s2">(</span><span class="s5">&quot;numpy_random&quot;</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">test_numpy_gauss_startup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_startup_randomness</span><span class="s2">(</span><span class="s5">&quot;numpy_normal&quot;</span><span class="s2">, (</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_random_permutation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">jit_unary</span><span class="s2">(</span><span class="s5">&quot;np.random.permutation&quot;</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s2">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">15</span><span class="s2">, </span><span class="s4">20</span><span class="s2">]:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s3"># Test array version</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">permutation</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
            <span class="s3"># Test int version</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">s</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">permutation</span><span class="s2">(</span><span class="s1">s</span><span class="s2">))</span>
            <span class="s3"># Permutation should not modify its argument</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s3"># Check multi-dimensional arrays</span>
        <span class="s1">arrs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">27</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">36</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">r</span><span class="s2">.</span><span class="s1">permutation</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRandomArrays</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test array-producing variants of np.random.* functions. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">_compile_array_dist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">nargs</span><span class="s2">):</span>
        <span class="s1">qualname </span><span class="s2">= </span><span class="s5">&quot;np.random.%s&quot; </span><span class="s2">% (</span><span class="s1">funcname</span><span class="s2">,)</span>
        <span class="s1">argstring </span><span class="s2">= </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s5">'abcd'</span><span class="s2">[:</span><span class="s1">nargs</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">jit_with_args</span><span class="s2">(</span><span class="s1">qualname</span><span class="s2">, </span><span class="s1">argstring</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">scalar_args</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check returning an array according to a given distribution. 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile_array_dist</span><span class="s2">(</span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">scalar_args</span><span class="s2">) + </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_numpy</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s2">(</span><span class="s4">8</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)):</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s1">scalar_args </span><span class="s2">+ (</span><span class="s1">size</span><span class="s2">,)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s3"># Numpy may return int32s where we return int64s, adjust</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'int32'</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">got</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'int64'</span><span class="s2">)):</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">scalar_args </span><span class="s2">+ (</span><span class="s0">None</span><span class="s2">,)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_array_dist_gamma</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">,  </span><span class="s1">scalar_args</span><span class="s2">, </span><span class="s1">extra_pyfunc_args</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check returning an array according to a given gamma distribution, 
        where we use CPython's implementation rather than NumPy's. 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile_array_dist</span><span class="s2">(</span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">scalar_args</span><span class="s2">) + </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_follow_cpython</span><span class="s2">(</span><span class="s1">get_np_state_ptr</span><span class="s2">())</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s5">&quot;gammavariate&quot;</span><span class="s2">)</span>
        <span class="s1">pyfunc_args </span><span class="s2">= </span><span class="s1">scalar_args </span><span class="s2">+ </span><span class="s1">extra_pyfunc_args</span>
        <span class="s1">pyrandom </span><span class="s2">= </span><span class="s0">lambda </span><span class="s2">*</span><span class="s1">_args</span><span class="s2">: </span><span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">pyfunc_args</span><span class="s2">)</span>

        <span class="s1">args </span><span class="s2">= </span><span class="s1">scalar_args </span><span class="s2">+ (</span><span class="s0">None</span><span class="s2">,)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyrandom</span><span class="s2">()</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s2">(</span><span class="s4">8</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)):</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s1">scalar_args </span><span class="s2">+ (</span><span class="s1">size</span><span class="s2">,)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">expected_flat </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">flat</span>
            <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">expected_flat</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">pyrandom</span><span class="s2">()</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_array_dist_self</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">scalar_args</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check function returning an array against its scalar implementation. 
        Because we use the CPython gamma distribution rather than the NumPy one, 
        distributions which use the gamma distribution vary in ways that are 
        difficult to compare. Instead, we compile both the array and scalar 
        versions and check that the array is filled with the same values as 
        we would expect from the scalar version. 
        &quot;&quot;&quot;</span>
        <span class="s2">@</span><span class="s1">numba</span><span class="s2">.</span><span class="s1">njit</span>
        <span class="s0">def </span><span class="s1">reset</span><span class="s2">():</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>

        <span class="s1">array_func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile_array_dist</span><span class="s2">(</span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">scalar_args</span><span class="s2">) + </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">qualname </span><span class="s2">= </span><span class="s5">&quot;np.random.%s&quot; </span><span class="s2">% (</span><span class="s1">funcname</span><span class="s2">,)</span>
        <span class="s1">argstring </span><span class="s2">= </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s5">'abcd'</span><span class="s2">[:</span><span class="s1">len</span><span class="s2">(</span><span class="s1">scalar_args</span><span class="s2">)])</span>
        <span class="s1">scalar_func </span><span class="s2">= </span><span class="s1">jit_with_args</span><span class="s2">(</span><span class="s1">qualname</span><span class="s2">, </span><span class="s1">argstring</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s2">(</span><span class="s4">8</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)):</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s1">scalar_args </span><span class="s2">+ (</span><span class="s1">size</span><span class="s2">,)</span>
            <span class="s1">reset</span><span class="s2">()</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">array_func</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">reset</span><span class="s2">()</span>
            <span class="s3"># We're just going to go with whatever type the array version</span>
            <span class="s3"># gives us and hope it's not Boolean or something useless.</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">got</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">flat </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">flat</span>
            <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">flat</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">scalar_func</span><span class="s2">(*</span><span class="s1">scalar_args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>

        <span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">scalar_args </span><span class="s2">+ (</span><span class="s0">None</span><span class="s2">,)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">scalar_func</span><span class="s2">(*</span><span class="s1">scalar_args</span><span class="s2">)</span>
        <span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">array_func</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">, </span><span class="s1">ulps</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_randint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile_array_dist</span><span class="s2">(</span><span class="s5">&quot;randint&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">low</span><span class="s2">, </span><span class="s1">high </span><span class="s2">= </span><span class="s4">1000</span><span class="s2">, </span><span class="s4">10000</span>
        <span class="s1">size </span><span class="s2">= (</span><span class="s4">30</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">low</span><span class="s2">, </span><span class="s1">high</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'int32'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'int64'</span><span class="s2">)))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res </span><span class="s2">&gt;= </span><span class="s1">low</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res </span><span class="s2">&lt; </span><span class="s1">high</span><span class="s2">))</span>
        <span class="s3"># Crude statistical tests</span>
        <span class="s1">mean </span><span class="s2">= (</span><span class="s1">low </span><span class="s2">+ </span><span class="s1">high</span><span class="s2">) / </span><span class="s4">2</span>
        <span class="s1">tol </span><span class="s2">= (</span><span class="s1">high </span><span class="s2">- </span><span class="s1">low</span><span class="s2">) / </span><span class="s4">20</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">mean </span><span class="s2">- </span><span class="s1">tol</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">mean </span><span class="s2">+ </span><span class="s1">tol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_random_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile_array_dist</span><span class="s2">(</span><span class="s5">&quot;random&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">size </span><span class="s2">= (</span><span class="s4">30</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'float64'</span><span class="s2">))</span>
        <span class="s3"># Results are within expected bounds</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res </span><span class="s2">&gt;= </span><span class="s4">0.0</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res </span><span class="s2">&lt; </span><span class="s4">1.0</span><span class="s2">))</span>
        <span class="s3"># Crude statistical tests</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">res </span><span class="s2">&lt;= </span><span class="s4">0.1</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">res </span><span class="s2">&gt;= </span><span class="s4">0.9</span><span class="s2">))</span>
        <span class="s1">mean </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">, </span><span class="s4">0.45</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">mean</span><span class="s2">, </span><span class="s4">0.55</span><span class="s2">)</span>

    <span class="s3"># Sanity-check various distributions.  For convenience, we only check</span>
    <span class="s3"># those distributions that produce the exact same values as Numpy's.</span>

    <span class="s0">def </span><span class="s1">test_numpy_beta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist_self</span><span class="s2">(</span><span class="s5">&quot;beta&quot;</span><span class="s2">, (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_binomial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;binomial&quot;</span><span class="s2">, (</span><span class="s4">20</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_chisquare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist_self</span><span class="s2">(</span><span class="s5">&quot;chisquare&quot;</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_exponential</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;exponential&quot;</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist_self</span><span class="s2">(</span><span class="s5">&quot;f&quot;</span><span class="s2">, (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_gamma</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist_gamma</span><span class="s2">(</span><span class="s5">&quot;gamma&quot;</span><span class="s2">, (</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), ())</span>

    <span class="s0">def </span><span class="s1">test_numpy_geometric</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;geometric&quot;</span><span class="s2">, (</span><span class="s4">1.0</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_gumbel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;gumbel&quot;</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_hypergeometric</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;hypergeometric&quot;</span><span class="s2">, (</span><span class="s4">1000</span><span class="s2">, </span><span class="s4">5000</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_laplace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;laplace&quot;</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_logistic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;logistic&quot;</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_lognormal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;lognormal&quot;</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_logseries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;logseries&quot;</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_normal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;normal&quot;</span><span class="s2">, (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_pareto</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;pareto&quot;</span><span class="s2">, (</span><span class="s4">0.5</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_poisson</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;poisson&quot;</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;power&quot;</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_rand</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_check_rand</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">, </span><span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s4">42</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_randn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_check_randn</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">, </span><span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s4">42</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numpy_rayleigh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;rayleigh&quot;</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_cauchy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;standard_cauchy&quot;</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_exponential</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;standard_exponential&quot;</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_gamma</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist_gamma</span><span class="s2">(</span><span class="s5">&quot;standard_gamma&quot;</span><span class="s2">, (</span><span class="s4">2.0</span><span class="s2">,), (</span><span class="s4">1.0</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_numpy_standard_normal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;standard_normal&quot;</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">test_numpy_triangular</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;triangular&quot;</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_uniform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, (</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_wald</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;wald&quot;</span><span class="s2">, (</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_vonmises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist_self</span><span class="s2">(</span><span class="s5">&quot;vonmises&quot;</span><span class="s2">, (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numpy_zipf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_dist</span><span class="s2">(</span><span class="s5">&quot;zipf&quot;</span><span class="s2">, (</span><span class="s4">2.5</span><span class="s2">,))</span>


<span class="s0">class </span><span class="s1">TestRandomChoice</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test np.random.choice. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">_check_results</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check basic expectations about a batch of samples. 
        &quot;&quot;&quot;</span>
        <span class="s1">spop </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">)</span>
        <span class="s1">sres </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>
        <span class="s3"># All results are in the population</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">sres</span><span class="s2">, </span><span class="s1">spop</span><span class="s2">)</span>
        <span class="s3"># Sorted results are unlikely</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertNotEqual</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">res</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">res</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">replace</span><span class="s2">:</span>
            <span class="s3"># Duplicates are likely</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLess</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sres</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res</span><span class="s2">), </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s3"># No duplicates</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sres</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res</span><span class="s2">), </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">, </span><span class="s1">samples</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check distribution of some samples. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Sanity check that we have enough samples</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">) * </span><span class="s4">100</span><span class="s2">)</span>
        <span class="s3"># Check equidistribution of samples</span>
        <span class="s1">expected_frequency </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">) / </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">Counter</span><span class="s2">(</span><span class="s1">samples</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s1">pop</span><span class="s2">:</span>
            <span class="s1">n </span><span class="s2">= </span><span class="s1">c</span><span class="s2">[</span><span class="s1">value</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">expected_frequency </span><span class="s2">* </span><span class="s4">0.5</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">expected_frequency </span><span class="s2">* </span><span class="s4">2.0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_accumulate_array_results</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">nresults</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Accumulate array results produced by *func* until they reach 
        *nresults* elements. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s2">= []</span>
        <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) &lt; </span><span class="s1">nresults</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">+= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">func</span><span class="s2">().</span><span class="s1">flat</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span><span class="s2">[:</span><span class="s1">nresults</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">_check_choice_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check choice(a) against pop. 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_choice1</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= [</span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_results</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= [</span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n </span><span class="s2">* </span><span class="s4">100</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_choice_scalar_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test choice(int) 
        &quot;&quot;&quot;</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">50</span>
        <span class="s1">pop </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_choice_1</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_choice_array_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test choice(array) 
        &quot;&quot;&quot;</span>
        <span class="s1">pop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">50</span><span class="s2">) * </span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">100</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_choice_1</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_array_results</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check array results produced by *func* and their distribution. 
        &quot;&quot;&quot;</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">func</span><span class="s2">().</span><span class="s1">flat</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_results</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accumulate_array_results</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">n </span><span class="s2">* </span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_dist</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_choice_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check choice(a, size) against pop. 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_choice2</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">)</span>
        <span class="s3"># Final sizes should be large enough, so as to stress</span>
        <span class="s3"># replacement</span>
        <span class="s1">sizes </span><span class="s2">= [</span><span class="s1">n </span><span class="s2">- </span><span class="s4">10</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, (</span><span class="s1">n </span><span class="s2">- </span><span class="s4">1</span><span class="s2">) // </span><span class="s4">3</span><span class="s2">), </span><span class="s1">n </span><span class="s2">* </span><span class="s4">10</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s3"># Check result shape</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">expected_shape </span><span class="s2">= </span><span class="s1">size </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s0">else </span><span class="s2">(</span><span class="s1">size</span><span class="s2">,)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">expected_shape</span><span class="s2">)</span>
            <span class="s3"># Check results and their distribution</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_results</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">), </span><span class="s1">pop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_choice_scalar_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test choice(int, size) 
        &quot;&quot;&quot;</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">50</span>
        <span class="s1">pop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_choice_2</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_choice_array_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test choice(array, size) 
        &quot;&quot;&quot;</span>
        <span class="s1">pop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">50</span><span class="s2">) * </span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">100</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_choice_2</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_choice_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check choice(a, size, replace) against pop. 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_choice3</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">)</span>
        <span class="s3"># Final sizes should be close but slightly &lt;= n, so as to stress</span>
        <span class="s3"># replacement (or not)</span>
        <span class="s1">sizes </span><span class="s2">= [</span><span class="s1">n </span><span class="s2">- </span><span class="s4">10</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, (</span><span class="s1">n </span><span class="s2">- </span><span class="s4">1</span><span class="s2">) // </span><span class="s4">3</span><span class="s2">)]</span>
        <span class="s1">replaces </span><span class="s2">= [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]</span>

        <span class="s3"># Check result shapes</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">replace </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">)</span>
                <span class="s1">expected_shape </span><span class="s2">= </span><span class="s1">size </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s0">else </span><span class="s2">(</span><span class="s1">size</span><span class="s2">,)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">expected_shape</span><span class="s2">)</span>

        <span class="s3"># Check results for replace=True</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_results</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s0">True</span><span class="s2">), </span><span class="s1">pop</span><span class="s2">)</span>
        <span class="s3"># Check results for replace=False</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_array_results</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), </span><span class="s1">pop</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># Can't ask for more samples than population size with replace=False</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s2">[</span><span class="s1">n </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s1">n </span><span class="s2">// </span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)]:</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_choice_scalar_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test choice(int, size, replace) 
        &quot;&quot;&quot;</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">50</span>
        <span class="s1">pop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_choice_3</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_choice_array_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test choice(array, size, replace) 
        &quot;&quot;&quot;</span>
        <span class="s1">pop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">50</span><span class="s2">) * </span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">100</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_choice_3</span><span class="s2">(</span><span class="s1">pop</span><span class="s2">, </span><span class="s1">pop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_choice_follows_seed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># See issue #3888, np.random.choice must acknowledge the seed</span>

        <span class="s2">@</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">numba_rands</span><span class="s2">(</span><span class="s1">n_to_return</span><span class="s2">, </span><span class="s1">choice_array</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1337</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">n_to_return</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_to_return</span><span class="s2">):</span>
                <span class="s1">out</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">choice_array</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">out</span>

        <span class="s1">choice_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s4">300</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tmp_np </span><span class="s2">= </span><span class="s1">choice_array</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">numba_rands</span><span class="s2">.</span><span class="s1">py_func</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">tmp_np</span><span class="s2">)</span>
        <span class="s1">tmp_nb </span><span class="s2">= </span><span class="s1">choice_array</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">numba_rands</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">tmp_nb</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>
        <span class="s3"># check no mutation</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">choice_array</span><span class="s2">, </span><span class="s1">tmp_np</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">choice_array</span><span class="s2">, </span><span class="s1">tmp_nb</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRandomMultinomial</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test np.random.multinomial. 
    &quot;&quot;&quot;</span>
    <span class="s3"># A biased dice</span>
    <span class="s1">pvals </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">pvals </span><span class="s2">/= </span><span class="s1">pvals</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check distribution of some samples. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">pvals</span><span class="s2">),))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'int32'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">'int64'</span><span class="s2">)))</span>
        <span class="s3"># Statistical properties</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(), </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">p</span><span class="s2">, </span><span class="s1">nexp </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">nexp</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">nexp</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">pexp </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">nexp</span><span class="s2">) / </span><span class="s1">n</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">pexp</span><span class="s2">, </span><span class="s1">p </span><span class="s2">* </span><span class="s4">0.5</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">pexp</span><span class="s2">, </span><span class="s1">p </span><span class="s2">* </span><span class="s4">2.0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multinomial_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test multinomial(n, pvals) 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_multinomial2</span><span class="s2">)</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">pvals </span><span class="s2">= </span><span class="s4">1000</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pvals</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s3"># pvals as list</span>
        <span class="s1">pvals </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pvals</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s3"># A case with extreme probabilities</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">1000000</span>
        <span class="s1">pvals </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">n </span><span class="s2">// </span><span class="s4">100</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">pvals </span><span class="s2">/= </span><span class="s1">pvals</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multinomial_3_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test multinomial(n, pvals, size: int) 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_multinomial3</span><span class="s2">)</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">pvals </span><span class="s2">= </span><span class="s4">1000</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pvals</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">sample </span><span class="s0">in </span><span class="s1">res</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multinomial_3_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test multinomial(n, pvals, size: tuple) 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_multinomial3</span><span class="s2">)</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">pvals </span><span class="s2">= </span><span class="s4">1000</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pvals</span>
        <span class="s1">k </span><span class="s2">= (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">sample </span><span class="s0">in </span><span class="s1">res</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">])):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">pvals</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRandomDirichlet</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">):</span>

        <span class="s6">&quot;&quot;&quot;Check output structure&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">size </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">type</span><span class="s2">(</span><span class="s1">size</span><span class="s2">) </span><span class="s0">is </span><span class="s1">int</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">size</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">size </span><span class="s2">+ (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">),))</span>

        <span class="s5">&quot;&quot;&quot;Check statistical properties&quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertLessEqual</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">size </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertAlmostEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(), </span><span class="s4">1</span><span class="s2">, </span><span class="s1">places</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">totals </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertAlmostEqual</span><span class="s2">(</span><span class="s1">totals</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">places</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dirichlet_default</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test dirichlet(alpha, size=None) 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_dirichlet_default</span><span class="s2">)</span>
        <span class="s1">alphas </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">alpha</span><span class="s2">,</span>
            <span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">alpha</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">alpha </span><span class="s0">in </span><span class="s1">alphas</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dirichlet</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test dirichlet(alpha, size=None) 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_dirichlet</span><span class="s2">)</span>
        <span class="s1">sizes </span><span class="s2">= (</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">10</span><span class="s2">,), (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>
        <span class="s1">alphas </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">alpha</span><span class="s2">,</span>
            <span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">alpha</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">)</span>

        <span class="s0">for </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">size </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">alphas</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dirichlet_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_dirichlet</span><span class="s2">)</span>
        <span class="s1">alpha </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">&quot;dirichlet: alpha must be &gt; 0.0&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>
        
        <span class="s1">alpha </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">alpha</span>
        <span class="s1">sizes </span><span class="s2">= (</span><span class="s0">True</span><span class="s2">, </span><span class="s4">3j</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">3j</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">3j</span><span class="s2">, </span><span class="s4">3j</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s4">7</span><span class="s2">)))</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
                <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span>
                <span class="s5">&quot;np.random.dirichlet(): size should be int or &quot;</span>
                <span class="s5">&quot;tuple of ints or None, got&quot;</span><span class="s2">,</span>
                <span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">),</span>
            <span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestRandomNoncentralChiSquare</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">):</span>

        <span class="s3"># Check output structure</span>
        <span class="s0">if </span><span class="s1">size </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
            
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">size</span><span class="s2">,))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
             <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)</span>

        <span class="s3"># Check statistical properties</span>
        <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertGreaterEqual</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_noncentral_chisquare_default</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test noncentral_chisquare(df, nonc, size=None) 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_noncentral_chisquare_default</span><span class="s2">)</span>
        <span class="s1">inputs </span><span class="s2">= (</span>
            <span class="s2">(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s3"># test branch when df &lt; 1</span>
            <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">100000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10000</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc </span><span class="s0">in </span><span class="s1">inputs</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">) </span><span class="s3"># test branch when nonc is nan</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">res</span><span class="s2">))</span>


    <span class="s0">def </span><span class="s1">test_noncentral_chisquare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Test noncentral_chisquare(df, nonc, size) 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_noncentral_chisquare</span><span class="s2">)</span>
        <span class="s1">sizes </span><span class="s2">= (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, (</span><span class="s4">10</span><span class="s2">,), (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>
        <span class="s1">inputs </span><span class="s2">= (</span>
            <span class="s2">(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">100000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10000</span><span class="s2">),</span>
        <span class="s2">)</span>

        <span class="s0">for </span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">), </span><span class="s1">size </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sample</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">size</span><span class="s2">) </span><span class="s3"># test branch when nonc is nan</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">res</span><span class="s2">).</span><span class="s1">all</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_noncentral_chisquare_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">numpy_noncentral_chisquare</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">, </span><span class="s1">nonc </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">&quot;df &lt;= 0&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>
        
        <span class="s1">df</span><span class="s2">, </span><span class="s1">nonc </span><span class="s2">= </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">&quot;nonc &lt; 0&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))        </span>

        <span class="s1">df</span><span class="s2">, </span><span class="s1">nonc </span><span class="s2">= </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span>
        <span class="s1">sizes </span><span class="s2">= (</span><span class="s0">True</span><span class="s2">, </span><span class="s4">3j</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">3j</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">3j</span><span class="s2">, </span><span class="s4">3j</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s4">7</span><span class="s2">)))</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
                <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">nonc</span><span class="s2">, </span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span>
                <span class="s5">&quot;np.random.noncentral_chisquare(): size should be int or &quot;</span>
                <span class="s5">&quot;tuple of ints or None, got&quot;</span><span class="s2">,</span>
                <span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">),</span>
            <span class="s2">)</span>

<span class="s2">@</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">nogil</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">py_extract_randomness</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">out</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">seed </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
        <span class="s1">out</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">random</span><span class="s2">.</span><span class="s1">getrandbits</span><span class="s2">(</span><span class="s4">32</span><span class="s2">)</span>

<span class="s1">_randint_limit </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">&lt;&lt; </span><span class="s4">32</span>

<span class="s2">@</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">nogil</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">np_extract_randomness</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">out</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">seed </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
        <span class="s1">out</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">_randint_limit</span><span class="s2">)</span>



<span class="s0">class </span><span class="s1">ConcurrencyBaseTest</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s3"># Enough iterations for:</span>
    <span class="s3"># 1. Mersenne-Twister state shuffles to occur (once every 624)</span>
    <span class="s3"># 2. Race conditions to be plausible</span>
    <span class="s3"># 3. Nice statistical properties to emerge</span>
    <span class="s1">_extract_iterations </span><span class="s2">= </span><span class="s4">100000</span>

    <span class="s0">def </span><span class="s1">setUp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Warm up, to avoid compiling in the threads</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s4">42</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_output</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">py_extract_randomness</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">np_extract_randomness</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">out</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check statistical properties of output. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Output should follow a uniform distribution in [0, 1&lt;&lt;32)</span>
        <span class="s1">expected_avg </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">&lt;&lt; </span><span class="s4">31</span>
        <span class="s1">expected_std </span><span class="s2">= (</span><span class="s4">1 </span><span class="s2">&lt;&lt; </span><span class="s4">32</span><span class="s2">) / </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">12</span><span class="s2">)</span>
        <span class="s1">rtol </span><span class="s2">= </span><span class="s4">0.05  </span><span class="s3"># given enough iterations</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">expected_avg</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(), </span><span class="s1">expected_std</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_several_outputs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">results</span><span class="s2">, </span><span class="s1">same_expected</span><span class="s2">):</span>
        <span class="s3"># Outputs should have the expected statistical properties</span>
        <span class="s3"># (an uninitialized PRNG or a PRNG whose internal state was</span>
        <span class="s3">#  corrupted by a race condition could produce bogus randomness)</span>
        <span class="s0">for </span><span class="s1">out </span><span class="s0">in </span><span class="s1">results</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">check_output</span><span class="s2">(</span><span class="s1">out</span><span class="s2">)</span>

        <span class="s3"># Check all threads gave either the same sequence or</span>
        <span class="s3"># distinct sequences</span>
        <span class="s0">if </span><span class="s1">same_expected</span><span class="s2">:</span>
            <span class="s1">expected_distinct </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">expected_distinct </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">results</span><span class="s2">)</span>

        <span class="s1">heads </span><span class="s2">= {</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">out</span><span class="s2">[:</span><span class="s4">5</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">out </span><span class="s0">in </span><span class="s1">results</span><span class="s2">}</span>
        <span class="s1">tails </span><span class="s2">= {</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">out</span><span class="s2">[-</span><span class="s4">5</span><span class="s2">:]) </span><span class="s0">for </span><span class="s1">out </span><span class="s0">in </span><span class="s1">results</span><span class="s2">}</span>
        <span class="s1">sums </span><span class="s2">= {</span><span class="s1">out</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() </span><span class="s0">for </span><span class="s1">out </span><span class="s0">in </span><span class="s1">results</span><span class="s2">}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">heads</span><span class="s2">), </span><span class="s1">expected_distinct</span><span class="s2">, </span><span class="s1">heads</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">tails</span><span class="s2">), </span><span class="s1">expected_distinct</span><span class="s2">, </span><span class="s1">tails</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">sums</span><span class="s2">), </span><span class="s1">expected_distinct</span><span class="s2">, </span><span class="s1">sums</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestThreads</span><span class="s2">(</span><span class="s1">ConcurrencyBaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Check the PRNG behaves well with threads. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">extract_in_threads</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nthreads</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Run *nthreads* threads extracting randomness with the given *seed* 
        (no seeding if 0). 
        &quot;&quot;&quot;</span>
        <span class="s1">results </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_extract_iterations</span><span class="s2">)</span>
                   <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nthreads </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)]</span>

        <span class="s0">def </span><span class="s1">target</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
            <span class="s3"># The PRNG will be seeded in thread</span>
            <span class="s1">extract_randomness</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">results</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>

        <span class="s1">threads </span><span class="s2">= [</span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Thread</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">i</span><span class="s2">,))</span>
                   <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nthreads</span><span class="s2">)]</span>

        <span class="s0">for </span><span class="s1">th </span><span class="s0">in </span><span class="s1">threads</span><span class="s2">:</span>
            <span class="s1">th</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
        <span class="s3"># Exercise main thread as well</span>
        <span class="s1">target</span><span class="s2">(</span><span class="s1">nthreads</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">th </span><span class="s0">in </span><span class="s1">threads</span><span class="s2">:</span>
            <span class="s1">th</span><span class="s2">.</span><span class="s1">join</span><span class="s2">()</span>

        <span class="s0">return </span><span class="s1">results</span>

    <span class="s0">def </span><span class="s1">check_thread_safety</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        When initializing the PRNG the same way, each thread 
        should produce the same sequence of random numbers, 
        using independent states, regardless of parallel 
        execution. 
        &quot;&quot;&quot;</span>
        <span class="s3"># Note the seed value doesn't matter, as long as it's</span>
        <span class="s3"># the same for all threads</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extract_in_threads</span><span class="s2">(</span><span class="s4">15</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s4">42</span><span class="s2">)</span>

        <span class="s3"># All threads gave the same sequence</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_several_outputs</span><span class="s2">(</span><span class="s1">results</span><span class="s2">, </span><span class="s1">same_expected</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_implicit_initialization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        The PRNG in new threads should be implicitly initialized with 
        system entropy, if seed() wasn't called. 
        &quot;&quot;&quot;</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extract_in_threads</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

        <span class="s3"># All threads gave a different, valid random sequence</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_several_outputs</span><span class="s2">(</span><span class="s1">results</span><span class="s2">, </span><span class="s1">same_expected</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_py_thread_safety</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_thread_safety</span><span class="s2">(</span><span class="s1">py_extract_randomness</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_np_thread_safety</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_thread_safety</span><span class="s2">(</span><span class="s1">np_extract_randomness</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_py_implicit_initialization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_implicit_initialization</span><span class="s2">(</span><span class="s1">py_extract_randomness</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_np_implicit_initialization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_implicit_initialization</span><span class="s2">(</span><span class="s1">np_extract_randomness</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">skipIf</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s5">'nt'</span><span class="s2">, </span><span class="s5">&quot;Windows is not affected by fork() issues&quot;</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestProcesses</span><span class="s2">(</span><span class="s1">ConcurrencyBaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Check the PRNG behaves well in child processes. 
    &quot;&quot;&quot;</span>

    <span class="s3"># Avoid nested multiprocessing AssertionError</span>
    <span class="s3"># (&quot;daemonic processes are not allowed to have children&quot;)</span>
    <span class="s1">_numba_parallel_test_ </span><span class="s2">= </span><span class="s0">False</span>


    <span class="s0">def </span><span class="s1">extract_in_processes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nprocs</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Run *nprocs* processes extracting randomness 
        without explicit seeding. 
        &quot;&quot;&quot;</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">multiprocessing</span><span class="s2">.</span><span class="s1">Queue</span><span class="s2">()</span>
        <span class="s1">results </span><span class="s2">= []</span>

        <span class="s0">def </span><span class="s1">target_inner</span><span class="s2">():</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_extract_iterations</span><span class="s2">)</span>
            <span class="s1">extract_randomness</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">out</span>

        <span class="s0">def </span><span class="s1">target</span><span class="s2">():</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">out </span><span class="s2">= </span><span class="s1">target_inner</span><span class="s2">()</span>
                <span class="s1">q</span><span class="s2">.</span><span class="s1">put</span><span class="s2">(</span><span class="s1">out</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s3"># Ensure an exception in a child gets reported</span>
                <span class="s3"># in the parent.</span>
                <span class="s1">q</span><span class="s2">.</span><span class="s1">put</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
                <span class="s0">raise</span>

        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">multiprocessing</span><span class="s2">, </span><span class="s5">'get_context'</span><span class="s2">):</span>
            <span class="s3"># The test works only in fork context.</span>
            <span class="s1">mpc </span><span class="s2">= </span><span class="s1">multiprocessing</span><span class="s2">.</span><span class="s1">get_context</span><span class="s2">(</span><span class="s5">'fork'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">mpc </span><span class="s2">= </span><span class="s1">multiprocessing</span>
        <span class="s1">procs </span><span class="s2">= [</span><span class="s1">mpc</span><span class="s2">.</span><span class="s1">Process</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">)</span>
                 <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nprocs</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">procs</span><span class="s2">:</span>
            <span class="s1">p</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
        <span class="s3"># Need to dequeue before joining, otherwise the large size of the</span>
        <span class="s3"># enqueued objects will lead to deadlock.</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nprocs</span><span class="s2">):</span>
            <span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">timeout</span><span class="s2">=</span><span class="s4">5</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">procs</span><span class="s2">:</span>
            <span class="s1">p</span><span class="s2">.</span><span class="s1">join</span><span class="s2">()</span>

        <span class="s3"># Exercise parent process as well; this will detect if the</span>
        <span class="s3"># same state was reused for one of the children.</span>
        <span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">target_inner</span><span class="s2">())</span>
        <span class="s0">for </span><span class="s1">res </span><span class="s0">in </span><span class="s1">results</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">Exception</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s5">&quot;Exception in child: %s&quot; </span><span class="s2">% (</span><span class="s1">res</span><span class="s2">,))</span>

        <span class="s0">return </span><span class="s1">results</span>

    <span class="s0">def </span><span class="s1">check_implicit_initialization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        The PRNG in new processes should be implicitly initialized 
        with system entropy, to avoid reproducing the same sequences. 
        &quot;&quot;&quot;</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extract_in_processes</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">extract_randomness</span><span class="s2">)</span>

        <span class="s3"># All processes gave a different, valid random sequence</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_several_outputs</span><span class="s2">(</span><span class="s1">results</span><span class="s2">, </span><span class="s1">same_expected</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_py_implicit_initialization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_implicit_initialization</span><span class="s2">(</span><span class="s1">py_extract_randomness</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_np_implicit_initialization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_implicit_initialization</span><span class="s2">(</span><span class="s1">np_extract_randomness</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestNumPyRandomAPI</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_call_by_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Checks that the NumPy impls in Numba can be used via call-by-name</span>
        <span class="s3"># args, see issue numba#9053.</span>
        <span class="s3">#</span>
        <span class="s3"># Checking call-by-name has to be done somewhat manually as the NumPy</span>
        <span class="s3"># numpy.random.* functions do not have signatures, see numpy#8734.</span>

        <span class="s3"># Herein, it doesn't matter what the values are, the names and types</span>
        <span class="s3"># just have to make sense.</span>
        <span class="s1">data </span><span class="s2">= {</span><span class="s5">&quot;np.random.beta&quot;</span><span class="s2">: {</span><span class="s5">'a'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.binomial&quot;</span><span class="s2">: {</span><span class="s5">'n'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">'p'</span><span class="s2">: </span><span class="s4">0.3</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.chisquare&quot;</span><span class="s2">: {</span><span class="s5">'df'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.choice&quot;</span><span class="s2">: {</span><span class="s5">'a'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.dirichlet&quot;</span><span class="s2">: {</span><span class="s5">'alpha'</span><span class="s2">: (</span><span class="s4">2</span><span class="s2">,), </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.exponential&quot;</span><span class="s2">: {</span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.f&quot;</span><span class="s2">: {</span><span class="s5">'dfnum'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'dfden'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.gamma&quot;</span><span class="s2">: {</span><span class="s5">'shape'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">2.0</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.geometric&quot;</span><span class="s2">: {</span><span class="s5">'p'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.gumbel&quot;</span><span class="s2">: {</span><span class="s5">'loc'</span><span class="s2">: </span><span class="s4">0.</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.hypergeometric&quot;</span><span class="s2">: {</span><span class="s5">'ngood'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">'nbad'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
                                             <span class="s5">'nsample'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.laplace&quot;</span><span class="s2">: {</span><span class="s5">'loc'</span><span class="s2">: </span><span class="s4">0.</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.logistic&quot;</span><span class="s2">: {</span><span class="s5">'loc'</span><span class="s2">: </span><span class="s4">0.</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.lognormal&quot;</span><span class="s2">: {</span><span class="s5">'mean'</span><span class="s2">: </span><span class="s4">0.</span><span class="s2">, </span><span class="s5">'sigma'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.logseries&quot;</span><span class="s2">: {</span><span class="s5">'p'</span><span class="s2">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.multinomial&quot;</span><span class="s2">: {</span><span class="s5">'n'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">'pvals'</span><span class="s2">: (</span><span class="s4">1</span><span class="s2">,), </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.negative_binomial&quot;</span><span class="s2">: {</span><span class="s5">'n'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">'p'</span><span class="s2">: </span><span class="s4">0.5</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.noncentral_chisquare&quot;</span><span class="s2">: {</span><span class="s5">'df'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'nonc'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">,</span>
                                                   <span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.normal&quot;</span><span class="s2">: {</span><span class="s5">'loc'</span><span class="s2">: </span><span class="s4">0.</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.pareto&quot;</span><span class="s2">: {</span><span class="s5">'a'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s3"># NOTE: The NumPy impl of permutation &quot;takes no keyword</span>
                <span class="s3"># arguments&quot;.</span>
                <span class="s3"># &quot;np.random.permutation&quot;: {'x': (1, 2, 3)},</span>
                <span class="s5">&quot;np.random.poisson&quot;</span><span class="s2">: {</span><span class="s5">'lam'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.power&quot;</span><span class="s2">: {</span><span class="s5">'a'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s3"># NOTE: The NumPy impl of rand essentially takes *args so kwargs</span>
                <span class="s3"># are unsupported.</span>
                <span class="s3"># &quot;np.random.rand&quot;: {'d0': 1, 'd1': 2, ...}}</span>
                <span class="s5">&quot;np.random.randint&quot;</span><span class="s2">: {</span><span class="s5">'low'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">'high'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s3"># NOTE: The NumPy impl of randn essentially takes *args so</span>
                <span class="s3"># kwargs are unsupported.</span>
                <span class="s3"># &quot;np.random.randn&quot;:  {'d0': 1, 'd1': 2, ...}}</span>
                <span class="s5">&quot;np.random.random&quot;</span><span class="s2">: {</span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.random_sample&quot;</span><span class="s2">: {</span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.ranf&quot;</span><span class="s2">: {</span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.rayleigh&quot;</span><span class="s2">: {</span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.sample&quot;</span><span class="s2">: {</span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.seed&quot;</span><span class="s2">: {</span><span class="s5">'seed'</span><span class="s2">: </span><span class="s4">4</span><span class="s2">},</span>
                <span class="s3"># NOTE: The NumPy impl of shuffle &quot;takes no keyword arguments&quot;.</span>
                <span class="s3"># &quot;np.random.shuffle&quot;</span>
                <span class="s5">&quot;np.random.standard_cauchy&quot;</span><span class="s2">: {</span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.standard_exponential&quot;</span><span class="s2">: {</span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.standard_gamma&quot;</span><span class="s2">: {</span><span class="s5">'shape'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.standard_normal&quot;</span><span class="s2">: {</span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.standard_t&quot;</span><span class="s2">: {</span><span class="s5">'df'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.triangular&quot;</span><span class="s2">: {</span><span class="s5">'left'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'mode'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'right'</span><span class="s2">: </span><span class="s4">3.</span><span class="s2">,</span>
                                         <span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.uniform&quot;</span><span class="s2">: {</span><span class="s5">'low'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'high'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.vonmises&quot;</span><span class="s2">: {</span><span class="s5">'mu'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'kappa'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.wald&quot;</span><span class="s2">: {</span><span class="s5">'mean'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'scale'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.weibull&quot;</span><span class="s2">: {</span><span class="s5">'a'</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
                <span class="s5">&quot;np.random.zipf&quot;</span><span class="s2">: {</span><span class="s5">'a'</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">, </span><span class="s5">'size'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},}</span>

        <span class="s0">for </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args </span><span class="s0">in </span><span class="s1">data</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">argstr </span><span class="s2">= </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s5">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">}</span><span class="s5">=</span><span class="s0">{</span><span class="s1">v</span><span class="s0">}</span><span class="s5">' </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">args</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()])</span>
            <span class="s1">template </span><span class="s2">= </span><span class="s1">dedent</span><span class="s2">(</span><span class="s5">f&quot;&quot;&quot;</span>
                <span class="s5">def foo():</span>
                    <span class="s5">return </span><span class="s0">{</span><span class="s1">fn</span><span class="s0">}</span><span class="s5">(</span><span class="s0">{</span><span class="s1">argstr</span><span class="s0">}</span><span class="s5">)</span>
                <span class="s5">&quot;&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">l </span><span class="s2">= {}</span>
            <span class="s1">exec</span><span class="s2">(</span><span class="s1">template</span><span class="s2">, {</span><span class="s5">'np'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">}, </span><span class="s1">l</span><span class="s2">)</span>
            <span class="s3"># The answer doesn't matter, these are tested in the tests above,</span>
            <span class="s3"># the purpose of this test is to ensure that the code compiles with</span>
            <span class="s3"># the args presented via name, i.e. the overloads are defined</span>
            <span class="s3"># correctly with respect to the public API of the function.</span>
            <span class="s1">func </span><span class="s2">= </span><span class="s1">l</span><span class="s2">[</span><span class="s5">'foo'</span><span class="s2">]</span>
            <span class="s1">func</span><span class="s2">()</span>
            <span class="s1">njit</span><span class="s2">(</span><span class="s1">func</span><span class="s2">).</span><span class="s1">compile</span><span class="s2">(())</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s5">&quot;__main__&quot;</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>