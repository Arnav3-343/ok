<html>
<head>
<title>byteflow.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
byteflow.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Implement python 3.8+ bytecode analysis 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">dis</span>
<span class="s2">from </span><span class="s1">pprint </span><span class="s2">import </span><span class="s1">pformat</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">from </span><span class="s1">collections </span><span class="s2">import </span><span class="s1">namedtuple</span><span class="s3">, </span><span class="s1">defaultdict</span><span class="s3">, </span><span class="s1">deque</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">total_ordering</span>

<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">UniqueDict</span><span class="s3">, </span><span class="s1">PYVERSION</span><span class="s3">, </span><span class="s1">ALL_BINOPS_TO_OPERATORS</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">controlflow </span><span class="s2">import </span><span class="s1">NEW_BLOCKERS</span><span class="s3">, </span><span class="s1">CFGraph</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">ir </span><span class="s2">import </span><span class="s1">Loc</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">UnsupportedError</span>


<span class="s1">_logger </span><span class="s3">= </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">getLogger</span><span class="s3">(</span><span class="s1">__name__</span><span class="s3">)</span>

<span class="s1">_EXCEPT_STACK_OFFSET </span><span class="s3">= </span><span class="s4">6</span>
<span class="s1">_FINALLY_POP </span><span class="s3">= </span><span class="s1">_EXCEPT_STACK_OFFSET</span>
<span class="s1">_NO_RAISE_OPS </span><span class="s3">= </span><span class="s1">frozenset</span><span class="s3">({</span>
    <span class="s5">'LOAD_CONST'</span><span class="s3">,</span>
    <span class="s5">'NOP'</span><span class="s3">,</span>
    <span class="s5">'LOAD_DEREF'</span><span class="s3">,</span>
    <span class="s5">'PRECALL'</span><span class="s3">,</span>
<span class="s3">})</span>

<span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
    <span class="s2">from </span><span class="s1">enum </span><span class="s2">import </span><span class="s1">Enum</span>

    <span class="s6"># Operands for CALL_INTRINSIC_1</span>
    <span class="s2">class </span><span class="s1">CALL_INTRINSIC_1_Operand</span><span class="s3">(</span><span class="s1">Enum</span><span class="s3">):</span>
        <span class="s1">INTRINSIC_STOPITERATION_ERROR </span><span class="s3">= </span><span class="s4">3</span>
        <span class="s1">UNARY_POSITIVE </span><span class="s3">= </span><span class="s4">5</span>
        <span class="s1">INTRINSIC_LIST_TO_TUPLE </span><span class="s3">= </span><span class="s4">6</span>
    <span class="s1">ci1op </span><span class="s3">= </span><span class="s1">CALL_INTRINSIC_1_Operand</span>
<span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
    <span class="s2">pass</span>
<span class="s2">else</span><span class="s3">:</span>
    <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">total_ordering</span>
<span class="s2">class </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Kinds of block to make related code safer than just `str`. 
    &quot;&quot;&quot;</span>
    <span class="s1">_members </span><span class="s3">= </span><span class="s1">frozenset</span><span class="s3">({</span>
        <span class="s5">'LOOP'</span><span class="s3">,</span>
        <span class="s5">'TRY'</span><span class="s3">, </span><span class="s5">'EXCEPT'</span><span class="s3">, </span><span class="s5">'FINALLY'</span><span class="s3">,</span>
        <span class="s5">'WITH'</span><span class="s3">, </span><span class="s5">'WITH_FINALLY'</span><span class="s3">,</span>
    <span class="s3">})</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">value </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_members</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_value </span><span class="s3">= </span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">__hash__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">hash</span><span class="s3">((</span><span class="s1">type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_value</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">__lt__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">other</span><span class="s3">, </span><span class="s1">BlockKind</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_value </span><span class="s3">&lt; </span><span class="s1">other</span><span class="s3">.</span><span class="s1">_value</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">'cannot compare to {!r}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">type</span><span class="s3">(</span><span class="s1">other</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">other</span><span class="s3">, </span><span class="s1">BlockKind</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_value </span><span class="s3">== </span><span class="s1">other</span><span class="s3">.</span><span class="s1">_value</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">'cannot compare to {!r}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">type</span><span class="s3">(</span><span class="s1">other</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">&quot;BlockKind({})&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_value</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">_lazy_pformat</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">args </span><span class="s3">= </span><span class="s1">args</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">kwargs </span><span class="s3">= </span><span class="s1">kwargs</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">pformat</span><span class="s3">(*</span><span class="s1">self</span><span class="s3">.</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">self</span><span class="s3">.</span><span class="s1">kwargs</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Flow</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Data+Control Flow analysis. 
 
    Simulate execution to recover dataflow and controlflow information. 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">bytecode</span><span class="s3">):</span>
        <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;bytecode dump:</span><span class="s2">\n</span><span class="s5">%s&quot;</span><span class="s3">, </span><span class="s1">bytecode</span><span class="s3">.</span><span class="s1">dump</span><span class="s3">())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode </span><span class="s3">= </span><span class="s1">bytecode</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">block_infos </span><span class="s3">= </span><span class="s1">UniqueDict</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Run a trace over the bytecode over all reachable path. 
 
        The trace starts at bytecode offset 0 and gathers stack and control- 
        flow information by partially interpreting each bytecode. 
        Each ``State`` instance in the trace corresponds to a basic-block. 
        The State instances forks when a jump instruction is encountered. 
        A newly forked state is then added to the list of pending states. 
        The trace ends when there are no more pending states. 
        &quot;&quot;&quot;</span>
        <span class="s1">firststate </span><span class="s3">= </span><span class="s1">State</span><span class="s3">(</span><span class="s1">bytecode</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span><span class="s3">, </span><span class="s1">pc</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">nstack</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
                           <span class="s1">blockstack</span><span class="s3">=())</span>
        <span class="s1">runner </span><span class="s3">= </span><span class="s1">TraceRunner</span><span class="s3">(</span><span class="s1">debug_filename</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span><span class="s3">.</span><span class="s1">func_id</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s1">runner</span><span class="s3">.</span><span class="s1">pending</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">firststate</span><span class="s3">)</span>

        <span class="s6"># Enforce unique-ness on initial PC to avoid re-entering the PC with</span>
        <span class="s6"># a different stack-depth. We don't know if such a case is ever</span>
        <span class="s6"># possible, but no such case has been encountered in our tests.</span>
        <span class="s1">first_encounter </span><span class="s3">= </span><span class="s1">UniqueDict</span><span class="s3">()</span>
        <span class="s6"># Loop over each pending state at a initial PC.</span>
        <span class="s6"># Each state is tracing a basic block</span>
        <span class="s2">while </span><span class="s1">runner</span><span class="s3">.</span><span class="s1">pending</span><span class="s3">:</span>
            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;pending: %s&quot;</span><span class="s3">, </span><span class="s1">runner</span><span class="s3">.</span><span class="s1">pending</span><span class="s3">)</span>
            <span class="s1">state </span><span class="s3">= </span><span class="s1">runner</span><span class="s3">.</span><span class="s1">pending</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">state </span><span class="s2">not in </span><span class="s1">runner</span><span class="s3">.</span><span class="s1">finished</span><span class="s3">:</span>
                <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;stack: %s&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">)</span>
                <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;state.pc_initial: %s&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">)</span>
                <span class="s1">first_encounter</span><span class="s3">[</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pc_initial</span><span class="s3">] = </span><span class="s1">state</span>
                <span class="s6"># Loop over the state until it is terminated.</span>
                <span class="s2">while True</span><span class="s3">:</span>
                    <span class="s1">runner</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
                    <span class="s6"># Terminated?</span>
                    <span class="s2">if </span><span class="s1">state</span><span class="s3">.</span><span class="s1">has_terminated</span><span class="s3">():</span>
                        <span class="s2">break</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_run_handle_exception</span><span class="s3">(</span><span class="s1">runner</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
                            <span class="s2">break</span>

                        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_implicit_new_block</span><span class="s3">(</span><span class="s1">state</span><span class="s3">):</span>
                            <span class="s6"># check if this is a with...as, abort if so</span>
                            <span class="s1">self</span><span class="s3">.</span><span class="s1">_guard_with_as</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
                            <span class="s6"># else split</span>
                            <span class="s1">state</span><span class="s3">.</span><span class="s1">split_new_block</span><span class="s3">()</span>
                            <span class="s2">break</span>
                <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;end state. edges=%s&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">outgoing_edges</span><span class="s3">)</span>
                <span class="s1">runner</span><span class="s3">.</span><span class="s1">finished</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
                <span class="s1">out_states </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_outgoing_states</span><span class="s3">()</span>
                <span class="s1">runner</span><span class="s3">.</span><span class="s1">pending</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">out_states</span><span class="s3">)</span>

        <span class="s6"># Complete controlflow</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_build_cfg</span><span class="s3">(</span><span class="s1">runner</span><span class="s3">.</span><span class="s1">finished</span><span class="s3">)</span>
        <span class="s6"># Prune redundant PHI-nodes</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_prune_phis</span><span class="s3">(</span><span class="s1">runner</span><span class="s3">)</span>
        <span class="s6"># Post process</span>
        <span class="s2">for </span><span class="s1">state </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">runner</span><span class="s3">.</span><span class="s1">finished</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">pc_initial</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">block_infos</span><span class="s3">[</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pc_initial</span><span class="s3">] = </span><span class="s1">si </span><span class="s3">= </span><span class="s1">adapt_state_infos</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;block_infos %s:</span><span class="s2">\n</span><span class="s5">%s&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">si</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">_run_handle_exception</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">runner</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">state</span><span class="s3">.</span><span class="s1">in_with</span><span class="s3">() </span><span class="s2">and </span><span class="s3">(</span>
                    <span class="s1">state</span><span class="s3">.</span><span class="s1">has_active_try</span><span class="s3">() </span><span class="s2">and</span>
                    <span class="s1">state</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">().</span><span class="s1">opname </span><span class="s2">not in </span><span class="s1">_NO_RAISE_OPS</span><span class="s3">):</span>
                <span class="s6"># Is in a *try* block</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">().</span><span class="s1">next</span><span class="s3">)</span>
                <span class="s1">runner</span><span class="s3">.</span><span class="s1">_adjust_except_stack</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
                <span class="s2">return True</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">advance_pc</span><span class="s3">()</span>

                <span class="s6"># Must the new PC be a new block?</span>
                <span class="s2">if not </span><span class="s1">state</span><span class="s3">.</span><span class="s1">in_with</span><span class="s3">() </span><span class="s2">and </span><span class="s1">state</span><span class="s3">.</span><span class="s1">is_in_exception</span><span class="s3">():</span>
                    <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;3.11 exception %s PC=%s&quot;</span><span class="s3">,</span>
                                  <span class="s1">state</span><span class="s3">.</span><span class="s1">get_exception</span><span class="s3">(), </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">)</span>
                    <span class="s1">eh </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_exception</span><span class="s3">()</span>
                    <span class="s1">eh_top </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s5">'TRY'</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">eh_top </span><span class="s2">and </span><span class="s1">eh_top</span><span class="s3">[</span><span class="s5">'end'</span><span class="s3">] == </span><span class="s1">eh</span><span class="s3">.</span><span class="s1">target</span><span class="s3">:</span>
                        <span class="s6"># Same exception</span>
                        <span class="s1">eh_block </span><span class="s3">= </span><span class="s2">None</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">eh_block </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_block</span><span class="s3">(</span><span class="s5">&quot;TRY&quot;</span><span class="s3">, </span><span class="s1">end</span><span class="s3">=</span><span class="s1">eh</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
                        <span class="s1">eh_block</span><span class="s3">[</span><span class="s5">'end_offset'</span><span class="s3">] = </span><span class="s1">eh</span><span class="s3">.</span><span class="s1">end</span>
                        <span class="s1">eh_block</span><span class="s3">[</span><span class="s5">'stack_depth'</span><span class="s3">] = </span><span class="s1">eh</span><span class="s3">.</span><span class="s1">depth</span>
                        <span class="s1">eh_block</span><span class="s3">[</span><span class="s5">'push_lasti'</span><span class="s3">] = </span><span class="s1">eh</span><span class="s3">.</span><span class="s1">lasti</span>
                        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">, </span><span class="s1">extra_block</span><span class="s3">=</span><span class="s1">eh_block</span><span class="s3">)</span>
                        <span class="s2">return True</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">_run_handle_exception</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">runner</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">has_active_try</span><span class="s3">() </span><span class="s2">and</span>
                    <span class="s1">state</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">().</span><span class="s1">opname </span><span class="s2">not in </span><span class="s1">_NO_RAISE_OPS</span><span class="s3">):</span>
                <span class="s6"># Is in a *try* block</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">().</span><span class="s1">next</span><span class="s3">)</span>
                <span class="s1">tryblk </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s5">'TRY'</span><span class="s3">)</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">pop_block_and_above</span><span class="s3">(</span><span class="s1">tryblk</span><span class="s3">)</span>
                <span class="s1">nstack </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">stack_depth</span>
                <span class="s1">kwargs </span><span class="s3">= {}</span>
                <span class="s2">if </span><span class="s1">nstack </span><span class="s3">&gt; </span><span class="s1">tryblk</span><span class="s3">[</span><span class="s5">'entry_stack'</span><span class="s3">]:</span>
                    <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">'npop'</span><span class="s3">] = </span><span class="s1">nstack </span><span class="s3">- </span><span class="s1">tryblk</span><span class="s3">[</span><span class="s5">'entry_stack'</span><span class="s3">]</span>
                <span class="s1">handler </span><span class="s3">= </span><span class="s1">tryblk</span><span class="s3">[</span><span class="s5">'handler'</span><span class="s3">]</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">'npush'</span><span class="s3">] = {</span>
                    <span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">'EXCEPT'</span><span class="s3">): </span><span class="s1">_EXCEPT_STACK_OFFSET</span><span class="s3">,</span>
                    <span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">'FINALLY'</span><span class="s3">): </span><span class="s1">_FINALLY_POP</span>
                <span class="s3">}[</span><span class="s1">handler</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">]]</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">'extra_block'</span><span class="s3">] = </span><span class="s1">handler</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">tryblk</span><span class="s3">[</span><span class="s5">'end'</span><span class="s3">], **</span><span class="s1">kwargs</span><span class="s3">)</span>
                <span class="s2">return True</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">advance_pc</span><span class="s3">()</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_build_cfg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">all_states</span><span class="s3">):</span>
        <span class="s1">graph </span><span class="s3">= </span><span class="s1">CFGraph</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">state </span><span class="s2">in </span><span class="s1">all_states</span><span class="s3">:</span>
            <span class="s1">b </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pc_initial</span>
            <span class="s1">graph</span><span class="s3">.</span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">state </span><span class="s2">in </span><span class="s1">all_states</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">edge </span><span class="s2">in </span><span class="s1">state</span><span class="s3">.</span><span class="s1">outgoing_edges</span><span class="s3">:</span>
                <span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pc_initial</span><span class="s3">, </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">pc</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">graph</span><span class="s3">.</span><span class="s1">set_entry_point</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">graph</span><span class="s3">.</span><span class="s1">process</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cfgraph </span><span class="s3">= </span><span class="s1">graph</span>

    <span class="s2">def </span><span class="s1">_prune_phis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">runner</span><span class="s3">):</span>
        <span class="s6"># Find phis that are unused in the local block</span>
        <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;Prune PHIs&quot;</span><span class="s3">.</span><span class="s1">center</span><span class="s3">(</span><span class="s4">60</span><span class="s3">, </span><span class="s5">'-'</span><span class="s3">))</span>

        <span class="s6"># Compute dataflow for used phis and propagate</span>

        <span class="s6"># 1. Get used-phis for each block</span>
        <span class="s6"># Map block to used_phis</span>
        <span class="s2">def </span><span class="s1">get_used_phis_per_state</span><span class="s3">():</span>
            <span class="s1">used_phis </span><span class="s3">= </span><span class="s1">defaultdict</span><span class="s3">(</span><span class="s1">set</span><span class="s3">)</span>
            <span class="s1">phi_set </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">state </span><span class="s2">in </span><span class="s1">runner</span><span class="s3">.</span><span class="s1">finished</span><span class="s3">:</span>
                <span class="s1">used </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">_used_regs</span><span class="s3">)</span>
                <span class="s1">phis </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">_phis</span><span class="s3">)</span>
                <span class="s1">used_phis</span><span class="s3">[</span><span class="s1">state</span><span class="s3">] |= </span><span class="s1">phis </span><span class="s3">&amp; </span><span class="s1">used</span>
                <span class="s1">phi_set </span><span class="s3">|= </span><span class="s1">phis</span>
            <span class="s2">return </span><span class="s1">used_phis</span><span class="s3">, </span><span class="s1">phi_set</span>

        <span class="s6"># Find use-defs</span>
        <span class="s2">def </span><span class="s1">find_use_defs</span><span class="s3">():</span>
            <span class="s1">defmap </span><span class="s3">= {}</span>
            <span class="s1">phismap </span><span class="s3">= </span><span class="s1">defaultdict</span><span class="s3">(</span><span class="s1">set</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">state </span><span class="s2">in </span><span class="s1">runner</span><span class="s3">.</span><span class="s1">finished</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">phi</span><span class="s3">, </span><span class="s1">rhs </span><span class="s2">in </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_outgoing_phis</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                    <span class="s2">if </span><span class="s1">rhs </span><span class="s2">not in </span><span class="s1">phi_set</span><span class="s3">:</span>
                        <span class="s6"># Is a definition</span>
                        <span class="s1">defmap</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">] = </span><span class="s1">state</span>
                    <span class="s1">phismap</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">].</span><span class="s1">add</span><span class="s3">((</span><span class="s1">rhs</span><span class="s3">, </span><span class="s1">state</span><span class="s3">))</span>
            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;defmap: %s&quot;</span><span class="s3">, </span><span class="s1">_lazy_pformat</span><span class="s3">(</span><span class="s1">defmap</span><span class="s3">))</span>
            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;phismap: %s&quot;</span><span class="s3">, </span><span class="s1">_lazy_pformat</span><span class="s3">(</span><span class="s1">phismap</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s1">defmap</span><span class="s3">, </span><span class="s1">phismap</span>

        <span class="s2">def </span><span class="s1">propagate_phi_map</span><span class="s3">(</span><span class="s1">phismap</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;An iterative dataflow algorithm to find the definition 
            (the source) of each PHI node. 
            &quot;&quot;&quot;</span>
            <span class="s1">blacklist </span><span class="s3">= </span><span class="s1">defaultdict</span><span class="s3">(</span><span class="s1">set</span><span class="s3">)</span>

            <span class="s2">while True</span><span class="s3">:</span>
                <span class="s1">changing </span><span class="s3">= </span><span class="s2">False</span>
                <span class="s2">for </span><span class="s1">phi</span><span class="s3">, </span><span class="s1">defsites </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">phismap</span><span class="s3">.</span><span class="s1">items</span><span class="s3">())):</span>
                    <span class="s2">for </span><span class="s1">rhs</span><span class="s3">, </span><span class="s1">state </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">defsites</span><span class="s3">)):</span>
                        <span class="s2">if </span><span class="s1">rhs </span><span class="s2">in </span><span class="s1">phi_set</span><span class="s3">:</span>
                            <span class="s1">defsites </span><span class="s3">|= </span><span class="s1">phismap</span><span class="s3">[</span><span class="s1">rhs</span><span class="s3">]</span>
                            <span class="s1">blacklist</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">].</span><span class="s1">add</span><span class="s3">((</span><span class="s1">rhs</span><span class="s3">, </span><span class="s1">state</span><span class="s3">))</span>
                    <span class="s1">to_remove </span><span class="s3">= </span><span class="s1">blacklist</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">]</span>
                    <span class="s2">if </span><span class="s1">to_remove </span><span class="s3">&amp; </span><span class="s1">defsites</span><span class="s3">:</span>
                        <span class="s1">defsites </span><span class="s3">-= </span><span class="s1">to_remove</span>
                        <span class="s1">changing </span><span class="s3">= </span><span class="s2">True</span>

                <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;changing phismap: %s&quot;</span><span class="s3">, </span><span class="s1">_lazy_pformat</span><span class="s3">(</span><span class="s1">phismap</span><span class="s3">))</span>
                <span class="s2">if not </span><span class="s1">changing</span><span class="s3">:</span>
                    <span class="s2">break</span>

        <span class="s2">def </span><span class="s1">apply_changes</span><span class="s3">(</span><span class="s1">used_phis</span><span class="s3">, </span><span class="s1">phismap</span><span class="s3">):</span>
            <span class="s1">keep </span><span class="s3">= {}</span>
            <span class="s2">for </span><span class="s1">state</span><span class="s3">, </span><span class="s1">used_set </span><span class="s2">in </span><span class="s1">used_phis</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s2">for </span><span class="s1">phi </span><span class="s2">in </span><span class="s1">used_set</span><span class="s3">:</span>
                    <span class="s1">keep</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">] = </span><span class="s1">phismap</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">]</span>
            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;keep phismap: %s&quot;</span><span class="s3">, </span><span class="s1">_lazy_pformat</span><span class="s3">(</span><span class="s1">keep</span><span class="s3">))</span>
            <span class="s1">new_out </span><span class="s3">= </span><span class="s1">defaultdict</span><span class="s3">(</span><span class="s1">dict</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">phi </span><span class="s2">in </span><span class="s1">keep</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">rhs</span><span class="s3">, </span><span class="s1">state </span><span class="s2">in </span><span class="s1">keep</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">]:</span>
                    <span class="s1">new_out</span><span class="s3">[</span><span class="s1">state</span><span class="s3">][</span><span class="s1">phi</span><span class="s3">] = </span><span class="s1">rhs</span>

            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;new_out: %s&quot;</span><span class="s3">, </span><span class="s1">_lazy_pformat</span><span class="s3">(</span><span class="s1">new_out</span><span class="s3">))</span>
            <span class="s2">for </span><span class="s1">state </span><span class="s2">in </span><span class="s1">runner</span><span class="s3">.</span><span class="s1">finished</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">_outgoing_phis</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">_outgoing_phis</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">new_out</span><span class="s3">[</span><span class="s1">state</span><span class="s3">])</span>

        <span class="s1">used_phis</span><span class="s3">, </span><span class="s1">phi_set </span><span class="s3">= </span><span class="s1">get_used_phis_per_state</span><span class="s3">()</span>
        <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;Used_phis: %s&quot;</span><span class="s3">, </span><span class="s1">_lazy_pformat</span><span class="s3">(</span><span class="s1">used_phis</span><span class="s3">))</span>
        <span class="s1">defmap</span><span class="s3">, </span><span class="s1">phismap </span><span class="s3">= </span><span class="s1">find_use_defs</span><span class="s3">()</span>
        <span class="s1">propagate_phi_map</span><span class="s3">(</span><span class="s1">phismap</span><span class="s3">)</span>
        <span class="s1">apply_changes</span><span class="s3">(</span><span class="s1">used_phis</span><span class="s3">, </span><span class="s1">phismap</span><span class="s3">)</span>
        <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;DONE Prune PHIs&quot;</span><span class="s3">.</span><span class="s1">center</span><span class="s3">(</span><span class="s4">60</span><span class="s3">, </span><span class="s5">'-'</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_is_implicit_new_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s1">inst </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">offset </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span><span class="s3">.</span><span class="s1">labels</span><span class="s3">:</span>
            <span class="s2">return True</span>
        <span class="s2">elif </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">opname </span><span class="s2">in </span><span class="s1">NEW_BLOCKERS</span><span class="s3">:</span>
            <span class="s2">return True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return False</span>

    <span class="s2">def </span><span class="s1">_guard_with_as</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Checks if the next instruction after a SETUP_WITH is something other 
        than a POP_TOP, if it is something else it'll be some sort of store 
        which is not supported (this corresponds to `with CTXMGR as VAR(S)`).&quot;&quot;&quot;</span>
        <span class="s1">current_inst </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">current_inst</span><span class="s3">.</span><span class="s1">opname </span><span class="s2">in </span><span class="s3">{</span><span class="s5">&quot;SETUP_WITH&quot;</span><span class="s3">, </span><span class="s5">&quot;BEFORE_WITH&quot;</span><span class="s3">}:</span>
            <span class="s1">next_op </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span><span class="s3">[</span><span class="s1">current_inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">].</span><span class="s1">opname</span>
            <span class="s2">if </span><span class="s1">next_op </span><span class="s3">!= </span><span class="s5">&quot;POP_TOP&quot;</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= (</span><span class="s5">&quot;The 'with (context manager) as &quot;</span>
                       <span class="s5">&quot;(variable):' construct is not &quot;</span>
                       <span class="s5">&quot;supported.&quot;</span><span class="s3">)</span>
                <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_is_null_temp_reg</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;$null$&quot;</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TraceRunner</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Trace runner contains the states for the trace and the opcode dispatch. 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">debug_filename</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">debug_filename </span><span class="s3">= </span><span class="s1">debug_filename</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pending </span><span class="s3">= </span><span class="s1">deque</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">finished </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">get_debug_loc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">Loc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">debug_filename</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">dispatch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
            <span class="s2">if </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">: </span><span class="s1">State</span>
                <span class="s2">while </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">:</span>
                    <span class="s1">topblk </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]</span>
                    <span class="s1">blk_end </span><span class="s3">= </span><span class="s1">topblk</span><span class="s3">[</span><span class="s5">'end'</span><span class="s3">]</span>
                    <span class="s2">if </span><span class="s1">blk_end </span><span class="s2">is not None and </span><span class="s1">blk_end </span><span class="s3">&lt;= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pc_initial</span><span class="s3">:</span>
                        <span class="s1">state</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">break</span>
        <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
            <span class="s2">pass</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>
        <span class="s1">inst </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">opname </span><span class="s3">!= </span><span class="s5">&quot;CACHE&quot;</span><span class="s3">:</span>
            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;dispatch pc=%s, inst=%s&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>
            <span class="s1">_logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s5">&quot;stack %s&quot;</span><span class="s3">, </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">)</span>
        <span class="s1">fn </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s5">&quot;op_{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">opname</span><span class="s3">), </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fn </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">fn</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Use of unsupported opcode (%s) found&quot; </span><span class="s3">% </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">opname</span>
            <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_debug_loc</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_adjust_except_stack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Adjust stack when entering an exception handler to match expectation 
        by the bytecode. 
        &quot;&quot;&quot;</span>
        <span class="s1">tryblk </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s5">'TRY'</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">pop_block_and_above</span><span class="s3">(</span><span class="s1">tryblk</span><span class="s3">)</span>
        <span class="s1">nstack </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">stack_depth</span>
        <span class="s1">kwargs </span><span class="s3">= {}</span>
        <span class="s1">expected_depth </span><span class="s3">= </span><span class="s1">tryblk</span><span class="s3">[</span><span class="s5">'stack_depth'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">nstack </span><span class="s3">&gt; </span><span class="s1">expected_depth</span><span class="s3">:</span>
            <span class="s6"># Pop extra item in the stack</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">'npop'</span><span class="s3">] = </span><span class="s1">nstack </span><span class="s3">- </span><span class="s1">expected_depth</span>
        <span class="s6"># Set extra stack itemcount due to the exception values.</span>
        <span class="s1">extra_stack </span><span class="s3">= </span><span class="s4">1</span>
        <span class="s2">if </span><span class="s1">tryblk</span><span class="s3">[</span><span class="s5">'push_lasti'</span><span class="s3">]:</span>
            <span class="s1">extra_stack </span><span class="s3">+= </span><span class="s4">1</span>
        <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">'npush'</span><span class="s3">] = </span><span class="s1">extra_stack</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">tryblk</span><span class="s3">[</span><span class="s5">'end'</span><span class="s3">], **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_NOP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_RESUME</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_CACHE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_PRECALL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_PUSH_NULL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_null</span><span class="s3">())</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_RETURN_GENERATOR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># This impl doesn't follow what CPython does. CPython is hacking</span>
        <span class="s6"># the frame stack in the interpreter. From usage, it always</span>
        <span class="s6"># has a POP_TOP after it so we push a dummy value to the stack.</span>
        <span class="s6">#</span>
        <span class="s6"># Example bytecode:</span>
        <span class="s6"># &gt;          0  NOP(arg=None, lineno=80)</span>
        <span class="s6">#            2  RETURN_GENERATOR(arg=None, lineno=80)</span>
        <span class="s6">#            4  POP_TOP(arg=None, lineno=80)</span>
        <span class="s6">#            6  RESUME(arg=0, lineno=80)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">())</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_FORMAT_VALUE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        FORMAT_VALUE(flags): flags argument specifies format spec which is 
        not supported yet. Currently, we just call str() on the value. 
        Pops a value from stack and pushes results back. 
        Required for supporting f-strings. 
        https://docs.python.org/3/library/dis.html#opcode-FORMAT_VALUE 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">!= </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;format spec in f-strings not supported yet&quot;</span>
            <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_debug_loc</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">))</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">strvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">, </span><span class="s1">strvar</span><span class="s3">=</span><span class="s1">strvar</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_STRING</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        BUILD_STRING(count): Concatenates count strings from the stack and 
        pushes the resulting string onto the stack. 
        Required for supporting f-strings. 
        https://docs.python.org/3/library/dis.html#opcode-BUILD_STRING 
        &quot;&quot;&quot;</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">strings </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)]))</span>
        <span class="s6"># corner case: f&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">count </span><span class="s3">== </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">tmps </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tmps </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count </span><span class="s3">- </span><span class="s4">1</span><span class="s3">)]</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">strings</span><span class="s3">=</span><span class="s1">strings</span><span class="s3">, </span><span class="s1">tmps</span><span class="s3">=</span><span class="s1">tmps</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">tmps</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">op_POP_TOP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_LOAD_GLOBAL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">idx </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&gt;&gt; </span><span class="s4">1</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">idx</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
            <span class="s6"># ignoring the NULL</span>
            <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">1</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_null</span><span class="s3">())</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_LOAD_GLOBAL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_COPY_FREE_VARS</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_MAKE_CELL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LOAD_DEREF</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LOAD_CONST</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;const&quot;</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LOAD_ATTR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
            <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">1</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_null</span><span class="s3">())</span>
        <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
            <span class="s2">pass</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">item</span><span class="s3">=</span><span class="s1">item</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LOAD_FAST</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_varname</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s1">op_LOAD_FAST_CHECK </span><span class="s3">= </span><span class="s1">op_LOAD_FAST</span>
        <span class="s1">op_LOAD_FAST_AND_CLEAR </span><span class="s3">= </span><span class="s1">op_LOAD_FAST</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DELETE_FAST</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DELETE_ATTR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_ATTR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_DEREF</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_FAST</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_SLICE_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        TOS = TOS1[TOS:] 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">start</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_SLICE_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        TOS = TOS1[:TOS] 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">stop</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_SLICE_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        TOS = TOS2[TOS1:TOS] 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos2 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos2</span><span class="s3">,</span>
            <span class="s1">start</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">stop</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_SLICE_0</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        TOS[:] = TOS1 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_SLICE_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        TOS1[TOS:] = TOS2 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">start</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_SLICE_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        TOS1[:TOS] = TOS2 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">stop</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_SLICE_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        TOS2[TOS1:TOS] = TOS3 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos2 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos2</span><span class="s3">,</span>
            <span class="s1">start</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">stop</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DELETE_SLICE_0</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        del TOS[:] 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">, </span><span class="s1">base</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">, </span><span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">, </span><span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DELETE_SLICE_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        del TOS1[TOS:] 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">start</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DELETE_SLICE_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        del TOS1[:TOS] 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">nonevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">base</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">,</span>
            <span class="s1">stop</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">,</span>
            <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span><span class="s3">,</span>
            <span class="s1">nonevar</span><span class="s3">=</span><span class="s1">nonevar</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DELETE_SLICE_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        del TOS2[TOS1:TOS] 
        &quot;&quot;&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos2 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indexvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">, </span><span class="s1">base</span><span class="s3">=</span><span class="s1">tos2</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">, </span><span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s1">indexvar</span><span class="s3">=</span><span class="s1">indexvar</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_SLICE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        slice(TOS1, TOS) or slice(TOS2, TOS1, TOS) 
        &quot;&quot;&quot;</span>
        <span class="s1">argc </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s2">if </span><span class="s1">argc </span><span class="s3">== </span><span class="s4">2</span><span class="s3">:</span>
            <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">start </span><span class="s3">= </span><span class="s1">tos1</span>
            <span class="s1">stop </span><span class="s3">= </span><span class="s1">tos</span>
            <span class="s1">step </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">elif </span><span class="s1">argc </span><span class="s3">== </span><span class="s4">3</span><span class="s3">:</span>
            <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">tos2 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">start </span><span class="s3">= </span><span class="s1">tos2</span>
            <span class="s1">stop </span><span class="s3">= </span><span class="s1">tos1</span>
            <span class="s1">step </span><span class="s3">= </span><span class="s1">tos</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s5">&quot;unreachable&quot;</span><span class="s3">)</span>
        <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">=</span><span class="s1">stop</span><span class="s3">, </span><span class="s1">step</span><span class="s3">=</span><span class="s1">step</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">, </span><span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span>
        <span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s2">def </span><span class="s1">op_BINARY_SLICE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">end </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">start </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">container </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">temp_res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                <span class="s1">inst</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">=</span><span class="s1">end</span><span class="s3">, </span><span class="s1">container</span><span class="s3">=</span><span class="s1">container</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">,</span>
                <span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">, </span><span class="s1">temp_res</span><span class="s3">=</span><span class="s1">temp_res</span>
            <span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s2">def </span><span class="s1">op_STORE_SLICE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">end </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">start </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">container </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

            <span class="s1">slicevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                <span class="s1">inst</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">=</span><span class="s1">end</span><span class="s3">, </span><span class="s1">container</span><span class="s3">=</span><span class="s1">container</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">,</span>
                <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">, </span><span class="s1">slicevar</span><span class="s3">=</span><span class="s1">slicevar</span><span class="s3">,</span>
            <span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">pred </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">pred</span><span class="s3">=</span><span class="s1">pred</span><span class="s3">)</span>

        <span class="s1">target_inst </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">()</span>
        <span class="s1">next_inst </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span>
        <span class="s6"># if the next inst and the jump target are the same location, issue one</span>
        <span class="s6"># fork else issue a fork for the next and the target.</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">next_inst</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">target_inst </span><span class="s3">!= </span><span class="s1">next_inst</span><span class="s3">:</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">target_inst</span><span class="s3">)</span>

    <span class="s1">op_POP_JUMP_IF_TRUE </span><span class="s3">= </span><span class="s1">_op_POP_JUMP_IF</span>
    <span class="s1">op_POP_JUMP_IF_FALSE </span><span class="s3">= </span><span class="s1">_op_POP_JUMP_IF</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s1">op_POP_JUMP_IF_NONE </span><span class="s3">= </span><span class="s1">_op_POP_JUMP_IF</span>
        <span class="s1">op_POP_JUMP_IF_NOT_NONE </span><span class="s3">= </span><span class="s1">_op_POP_JUMP_IF</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_op_JUMP_IF_OR_POP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">pred </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_tos</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">pred</span><span class="s3">=</span><span class="s1">pred</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">, </span><span class="s1">npop</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">())</span>

    <span class="s1">op_JUMP_IF_FALSE_OR_POP </span><span class="s3">= </span><span class="s1">_op_JUMP_IF_OR_POP</span>
    <span class="s1">op_JUMP_IF_TRUE_OR_POP </span><span class="s3">= </span><span class="s1">_op_JUMP_IF_OR_POP</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_NONE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_NOT_NONE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_NONE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_NOT_NONE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_FALSE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_TRUE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_FALSE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_TRUE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_op_POP_JUMP_IF</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_JUMP_FORWARD</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">op_JUMP_BACKWARD</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">op_JUMP_ABSOLUTE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">op_BREAK_LOOP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># NOTE: bytecode removed since py3.8</span>
        <span class="s1">end </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s5">'LOOP'</span><span class="s3">)[</span><span class="s5">'end'</span><span class="s3">]</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">end</span><span class="s3">=</span><span class="s1">end</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">pop_block</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">end</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_RETURN_VALUE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">retval</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(), </span><span class="s1">castval</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">())</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s2">def </span><span class="s1">op_RETURN_CONST</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;const&quot;</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">retval</span><span class="s3">=</span><span class="s1">res</span><span class="s3">, </span><span class="s1">castval</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">())</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_YIELD_VALUE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_RAISE_VARARGS</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">== </span><span class="s4">0</span><span class="s3">:</span>
                <span class="s1">exc </span><span class="s3">= </span><span class="s2">None</span>
                <span class="s6"># No re-raising within a try-except block.</span>
                <span class="s6"># But we allow bare reraise.</span>
                <span class="s2">if </span><span class="s1">state</span><span class="s3">.</span><span class="s1">has_active_try</span><span class="s3">():</span>
                    <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span>
                        <span class="s5">&quot;The re-raising of an exception is not yet supported.&quot;</span><span class="s3">,</span>
                        <span class="s1">loc</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_debug_loc</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">),</span>
                    <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">== </span><span class="s4">1</span><span class="s3">:</span>
                <span class="s1">exc </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;Multiple argument raise is not supported.&quot;</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">=</span><span class="s1">exc</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">state</span><span class="s3">.</span><span class="s1">has_active_try</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_adjust_except_stack</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>

    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_RAISE_VARARGS</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">in_exc_block </span><span class="s3">= </span><span class="s1">any</span><span class="s3">([</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s5">&quot;EXCEPT&quot;</span><span class="s3">) </span><span class="s2">is not None</span><span class="s3">,</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s5">&quot;FINALLY&quot;</span><span class="s3">) </span><span class="s2">is not None</span>
            <span class="s3">])</span>
            <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">== </span><span class="s4">0</span><span class="s3">:</span>
                <span class="s1">exc </span><span class="s3">= </span><span class="s2">None</span>
                <span class="s2">if </span><span class="s1">in_exc_block</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span>
                        <span class="s5">&quot;The re-raising of an exception is not yet supported.&quot;</span><span class="s3">,</span>
                        <span class="s1">loc</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_debug_loc</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">),</span>
                    <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">== </span><span class="s4">1</span><span class="s3">:</span>
                <span class="s1">exc </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;Multiple argument raise is not supported.&quot;</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">=</span><span class="s1">exc</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BEGIN_FINALLY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">temps </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">_EXCEPT_STACK_OFFSET</span><span class="s3">):</span>
            <span class="s1">tmp </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">temps</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">tmp</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">tmp</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">temps</span><span class="s3">=</span><span class="s1">temps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_END_FINALLY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">blk </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop_block</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">reset_stack</span><span class="s3">(</span><span class="s1">blk</span><span class="s3">[</span><span class="s5">'entry_stack'</span><span class="s3">])</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s2">def </span><span class="s1">op_END_FOR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_FINALLY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># we don't emulate the exact stack behavior</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">!= </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= (</span><span class="s5">'Unsupported use of a bytecode related to try..finally'</span>
                   <span class="s5">' or a with-context'</span><span class="s3">)</span>
            <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_debug_loc</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">op_CALL_FINALLY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">op_WITH_EXCEPT_START</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()  </span><span class="s6"># do not support</span>

    <span class="s2">def </span><span class="s1">op_WITH_CLEANUP_START</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># we don't emulate the exact stack behavior</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_WITH_CLEANUP_FINISH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># we don't emulate the exact stack behavior</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_SETUP_LOOP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># NOTE: bytecode removed since py3.8</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push_block</span><span class="s3">(</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">make_block</span><span class="s3">(</span>
                <span class="s1">kind</span><span class="s3">=</span><span class="s5">'LOOP'</span><span class="s3">,</span>
                <span class="s1">end</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">(),</span>
            <span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BEFORE_WITH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># Almost the same as py3.10 SETUP_WITH just lacking the finally block.</span>
        <span class="s1">cm </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()    </span><span class="s6"># the context-manager</span>

        <span class="s1">yielded </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">exitfn </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">=</span><span class="s5">'setup_with_exitfn'</span><span class="s3">)</span>

        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">exitfn</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">yielded</span><span class="s3">)</span>

        <span class="s6"># Gather all exception entries for this WITH. There maybe multiple</span>
        <span class="s6"># entries; esp. for nested WITHs.</span>
        <span class="s1">bc </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_bytecode</span>
        <span class="s1">ehhead </span><span class="s3">= </span><span class="s1">bc</span><span class="s3">.</span><span class="s1">find_exception_entry</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">)</span>
        <span class="s1">ehrelated </span><span class="s3">= [</span><span class="s1">ehhead</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">eh </span><span class="s2">in </span><span class="s1">bc</span><span class="s3">.</span><span class="s1">exception_entries</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">eh</span><span class="s3">.</span><span class="s1">target </span><span class="s3">== </span><span class="s1">ehhead</span><span class="s3">.</span><span class="s1">target</span><span class="s3">:</span>
                <span class="s1">ehrelated</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">eh</span><span class="s3">)</span>
        <span class="s1">end </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">eh</span><span class="s3">.</span><span class="s1">end </span><span class="s2">for </span><span class="s1">eh </span><span class="s2">in </span><span class="s1">ehrelated</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">contextmanager</span><span class="s3">=</span><span class="s1">cm</span><span class="s3">, </span><span class="s1">exitfn</span><span class="s3">=</span><span class="s1">exitfn</span><span class="s3">, </span><span class="s1">end</span><span class="s3">=</span><span class="s1">end</span><span class="s3">)</span>

        <span class="s1">state</span><span class="s3">.</span><span class="s1">push_block</span><span class="s3">(</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">make_block</span><span class="s3">(</span>
                <span class="s1">kind</span><span class="s3">=</span><span class="s5">'WITH'</span><span class="s3">,</span>
                <span class="s1">end</span><span class="s3">=</span><span class="s1">end</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s6"># Forces a new block</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_SETUP_WITH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">cm </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()    </span><span class="s6"># the context-manager</span>

        <span class="s1">yielded </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">exitfn </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">=</span><span class="s5">'setup_with_exitfn'</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">contextmanager</span><span class="s3">=</span><span class="s1">cm</span><span class="s3">, </span><span class="s1">exitfn</span><span class="s3">=</span><span class="s1">exitfn</span><span class="s3">)</span>

        <span class="s6"># py39 doesn't have with-finally</span>
        <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s3">&lt; (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">):</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push_block</span><span class="s3">(</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">make_block</span><span class="s3">(</span>
                    <span class="s1">kind</span><span class="s3">=</span><span class="s5">'WITH_FINALLY'</span><span class="s3">,</span>
                    <span class="s1">end</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">(),</span>
                <span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">exitfn</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">yielded</span><span class="s3">)</span>

        <span class="s1">state</span><span class="s3">.</span><span class="s1">push_block</span><span class="s3">(</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">make_block</span><span class="s3">(</span>
                <span class="s1">kind</span><span class="s3">=</span><span class="s5">'WITH'</span><span class="s3">,</span>
                <span class="s1">end</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">(),</span>
            <span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s6"># Forces a new block</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_setup_try</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">next</span><span class="s3">, </span><span class="s1">end</span><span class="s3">):</span>
        <span class="s6"># Forces a new block</span>
        <span class="s6"># Fork to the body of the finally</span>
        <span class="s1">handler_block </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_block</span><span class="s3">(</span>
            <span class="s1">kind</span><span class="s3">=</span><span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">end</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">reset_stack</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s6"># Forces a new block</span>
        <span class="s6"># Fork to the body of the finally</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span>
            <span class="s1">pc</span><span class="s3">=</span><span class="s1">next</span><span class="s3">,</span>
            <span class="s1">extra_block</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_block</span><span class="s3">(</span>
                <span class="s1">kind</span><span class="s3">=</span><span class="s5">'TRY'</span><span class="s3">,</span>
                <span class="s1">end</span><span class="s3">=</span><span class="s1">end</span><span class="s3">,</span>
                <span class="s1">reset_stack</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s1">handler</span><span class="s3">=</span><span class="s1">handler_block</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_PUSH_EXC_INFO</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;exception&quot;</span><span class="s3">))</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">tos</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_SETUP_FINALLY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_setup_try</span><span class="s3">(</span>
            <span class="s5">'FINALLY'</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">next</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">, </span><span class="s1">end</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">(),</span>
        <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_POP_EXCEPT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_POP_EXCEPT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">blk </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop_block</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">blk</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">] </span><span class="s2">not in </span><span class="s3">{</span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">'EXCEPT'</span><span class="s3">), </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">'FINALLY'</span><span class="s3">)}:</span>
                <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span>
                    <span class="s5">f&quot;POP_EXCEPT got an unexpected block: </span><span class="s2">{</span><span class="s1">blk</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">]</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">,</span>
                    <span class="s1">loc</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_debug_loc</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">),</span>
                <span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s6"># Forces a new block</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_POP_BLOCK</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">blk </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop_block</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">blk</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">] == </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">'TRY'</span><span class="s3">):</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">=</span><span class="s5">'try'</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">blk</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">] == </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">'WITH'</span><span class="s3">):</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">=</span><span class="s5">'with'</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BINARY_SUBSCR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_STORE_SUBSCR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DELETE_SUBSCR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_CALL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">narg </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">args </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">narg</span><span class="s3">)]))</span>
        <span class="s1">callable_or_firstarg </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">null_or_callable </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">_is_null_temp_reg</span><span class="s3">(</span><span class="s1">null_or_callable</span><span class="s3">):</span>
            <span class="s1">callable </span><span class="s3">= </span><span class="s1">callable_or_firstarg</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">callable </span><span class="s3">= </span><span class="s1">null_or_callable</span>
            <span class="s1">args </span><span class="s3">= [</span><span class="s1">callable_or_firstarg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>

        <span class="s1">kw_names </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop_kw_names</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">func</span><span class="s3">=</span><span class="s1">callable</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s1">args</span><span class="s3">, </span><span class="s1">kw_names</span><span class="s3">=</span><span class="s1">kw_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_KW_NAMES</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">set_kw_names</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_CALL_FUNCTION</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">narg </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">args </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">narg</span><span class="s3">)]))</span>
        <span class="s1">func </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">func</span><span class="s3">=</span><span class="s1">func</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s1">args</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_CALL_FUNCTION_KW</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">narg </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">names </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()  </span><span class="s6"># tuple of names</span>
        <span class="s1">args </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">narg</span><span class="s3">)]))</span>
        <span class="s1">func </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">func</span><span class="s3">=</span><span class="s1">func</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s1">args</span><span class="s3">, </span><span class="s1">names</span><span class="s3">=</span><span class="s1">names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_CALL_FUNCTION_EX</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">1 </span><span class="s2">and </span><span class="s1">PYVERSION </span><span class="s3">&lt; (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">):</span>
            <span class="s1">errmsg </span><span class="s3">= </span><span class="s5">&quot;CALL_FUNCTION_EX with **kwargs not supported&quot;</span>
            <span class="s2">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span><span class="s1">errmsg</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s1">varkwarg </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">varkwarg </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">vararg </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">func </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
            <span class="s2">if </span><span class="s1">_is_null_temp_reg</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)):</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s6"># pop NULL, it's not used</span>
        <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
            <span class="s2">pass</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">func</span><span class="s3">=</span><span class="s1">func</span><span class="s3">, </span><span class="s1">vararg</span><span class="s3">=</span><span class="s1">vararg</span><span class="s3">, </span><span class="s1">varkwarg</span><span class="s3">=</span><span class="s1">varkwarg</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_dup_topx</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">, </span><span class="s1">count</span><span class="s3">):</span>
        <span class="s1">orig </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)]</span>
        <span class="s1">orig</span><span class="s3">.</span><span class="s1">reverse</span><span class="s3">()</span>
        <span class="s6"># We need to actually create new temporaries if we want the</span>
        <span class="s6"># IR optimization pass to work correctly (see issue #580)</span>
        <span class="s1">duped </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)]</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">orig</span><span class="s3">=</span><span class="s1">orig</span><span class="s3">, </span><span class="s1">duped</span><span class="s3">=</span><span class="s1">duped</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">val </span><span class="s2">in </span><span class="s1">orig</span><span class="s3">:</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">val </span><span class="s2">in </span><span class="s1">duped</span><span class="s3">:</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s2">def </span><span class="s1">op_CALL_INTRINSIC_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s6"># See https://github.com/python/cpython/blob/v3.12.0rc2/Include/</span>
            <span class="s6"># internal/pycore_intrinsics.h#L3-L17C36</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">operand </span><span class="s3">= </span><span class="s1">CALL_INTRINSIC_1_Operand</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">TypeError</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s5">f&quot;op_CALL_INTRINSIC_1(</span><span class="s2">{</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s2">}</span><span class="s5">)&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">operand </span><span class="s3">== </span><span class="s1">ci1op</span><span class="s3">.</span><span class="s1">INTRINSIC_STOPITERATION_ERROR</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">operand</span><span class="s3">=</span><span class="s1">operand</span><span class="s3">)</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>
                <span class="s2">return</span>
            <span class="s2">elif </span><span class="s1">operand </span><span class="s3">== </span><span class="s1">ci1op</span><span class="s3">.</span><span class="s1">UNARY_POSITIVE</span><span class="s3">:</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">operand</span><span class="s3">=</span><span class="s1">operand</span><span class="s3">,</span>
                             <span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
                <span class="s2">return</span>
            <span class="s2">elif </span><span class="s1">operand </span><span class="s3">== </span><span class="s1">ci1op</span><span class="s3">.</span><span class="s1">INTRINSIC_LIST_TO_TUPLE</span><span class="s3">:</span>
                <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">operand</span><span class="s3">=</span><span class="s1">operand</span><span class="s3">,</span>
                             <span class="s1">const_list</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
                <span class="s2">return</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">operand</span><span class="s3">)</span>

    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DUP_TOPX</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s2">assert </span><span class="s4">1 </span><span class="s3">&lt;= </span><span class="s1">count </span><span class="s3">&lt;= </span><span class="s4">5</span><span class="s3">, </span><span class="s5">&quot;Invalid DUP_TOPX count&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_dup_topx</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">, </span><span class="s1">count</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DUP_TOP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_dup_topx</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">, </span><span class="s1">count</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DUP_TOP_TWO</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_dup_topx</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">, </span><span class="s1">count</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_COPY</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">op_SWAP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">swap</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_ROT_TWO</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">first </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">second </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">first</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">second</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_ROT_THREE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">first </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">second </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">third </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">first</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">third</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">second</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_ROT_FOUR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">first </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">second </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">third </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">forth </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">first</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">forth</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">third</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">second</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_UNPACK_SEQUENCE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">iterable </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">stores </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)]</span>
        <span class="s1">tupleobj </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">iterable</span><span class="s3">=</span><span class="s1">iterable</span><span class="s3">, </span><span class="s1">stores</span><span class="s3">=</span><span class="s1">stores</span><span class="s3">, </span><span class="s1">tupleobj</span><span class="s3">=</span><span class="s1">tupleobj</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">st </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">stores</span><span class="s3">):</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">st</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_TUPLE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">items </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)]))</span>
        <span class="s1">tup </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">items</span><span class="s3">=</span><span class="s1">items</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">tup</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">tup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_build_tuple_unpack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># Builds tuple from other tuples on the stack</span>
        <span class="s1">tuples </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">)]))</span>
        <span class="s1">temps </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">tuples</span><span class="s3">) - </span><span class="s4">1</span><span class="s3">)]</span>

        <span class="s6"># if the unpack is assign-like, e.g. x = (*y,), it needs handling</span>
        <span class="s6"># differently.</span>
        <span class="s1">is_assign </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">tuples</span><span class="s3">) == </span><span class="s4">1</span>
        <span class="s2">if </span><span class="s1">is_assign</span><span class="s3">:</span>
            <span class="s1">temps </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(),]</span>

        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">tuples</span><span class="s3">=</span><span class="s1">tuples</span><span class="s3">, </span><span class="s1">temps</span><span class="s3">=</span><span class="s1">temps</span><span class="s3">, </span><span class="s1">is_assign</span><span class="s3">=</span><span class="s1">is_assign</span><span class="s3">)</span>
        <span class="s6"># The result is in the last temp var</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">temps</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">op_BUILD_TUPLE_UNPACK_WITH_CALL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># just unpack the input tuple, call inst will be handled afterwards</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_build_tuple_unpack</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_TUPLE_UNPACK</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_build_tuple_unpack</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LIST_TO_TUPLE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># &quot;Pops a list from the stack and pushes a tuple containing the same</span>
        <span class="s6">#  values.&quot;</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">() </span><span class="s6"># new tuple var</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">const_list</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_CONST_KEY_MAP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">keys </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">vals </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">)]))</span>
        <span class="s1">keytmps </span><span class="s3">= [</span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">)]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">=</span><span class="s1">keys</span><span class="s3">, </span><span class="s1">keytmps</span><span class="s3">=</span><span class="s1">keytmps</span><span class="s3">, </span><span class="s1">values</span><span class="s3">=</span><span class="s1">vals</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_LIST</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">items </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)]))</span>
        <span class="s1">lst </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">items</span><span class="s3">=</span><span class="s1">items</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">lst</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LIST_APPEND</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">appendvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">, </span><span class="s1">appendvar</span><span class="s3">=</span><span class="s1">appendvar</span><span class="s3">,</span>
                     <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LIST_EXTEND</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">extendvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">, </span><span class="s1">extendvar</span><span class="s3">=</span><span class="s1">extendvar</span><span class="s3">,</span>
                     <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_MAP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">dct </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">items </span><span class="s3">= []</span>
        <span class="s6"># In 3.5+, BUILD_MAP takes &lt;count&gt; pairs from the stack</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">):</span>
            <span class="s1">v</span><span class="s3">, </span><span class="s1">k </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(), </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">items</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">k</span><span class="s3">, </span><span class="s1">v</span><span class="s3">))</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">items</span><span class="s3">=</span><span class="s1">items</span><span class="s3">[::-</span><span class="s4">1</span><span class="s3">], </span><span class="s1">size</span><span class="s3">=</span><span class="s1">count</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">dct</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">dct</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_MAP_ADD</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">TOS </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">TOS1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s3">= (</span><span class="s1">TOS1</span><span class="s3">, </span><span class="s1">TOS</span><span class="s3">)</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">setitemvar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">,</span>
                     <span class="s1">setitemvar</span><span class="s3">=</span><span class="s1">setitemvar</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_BUILD_SET</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">count </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s6"># Note: related python bug http://bugs.python.org/issue26020</span>
        <span class="s1">items </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">([</span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">() </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)]))</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">items</span><span class="s3">=</span><span class="s1">items</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_SET_UPDATE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">updatevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">, </span><span class="s1">updatevar</span><span class="s3">=</span><span class="s1">updatevar</span><span class="s3">,</span>
                     <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_DICT_UPDATE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">updatevar </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s1">target</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">, </span><span class="s1">updatevar</span><span class="s3">=</span><span class="s1">updatevar</span><span class="s3">,</span>
                     <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_GET_ITER</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_FOR_ITER</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">iterator </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_tos</span><span class="s3">()</span>
        <span class="s1">pair </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">indval </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">pred </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">iterator</span><span class="s3">=</span><span class="s1">iterator</span><span class="s3">, </span><span class="s1">pair</span><span class="s3">=</span><span class="s1">pair</span><span class="s3">, </span><span class="s1">indval</span><span class="s3">=</span><span class="s1">indval</span><span class="s3">,</span>
                     <span class="s1">pred</span><span class="s3">=</span><span class="s1">pred</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">indval</span><span class="s3">)</span>
        <span class="s1">end </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
            <span class="s6"># Changed in version 3.12: Up until 3.11 the iterator was</span>
            <span class="s6"># popped when it was exhausted. Now this is handled using END_FOR</span>
            <span class="s6"># op code.</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">end</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">)):</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">end</span><span class="s3">, </span><span class="s1">npop</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_GEN_START</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Pops TOS. If TOS was not None, raises an exception. The kind 
        operand corresponds to the type of generator or coroutine and 
        determines the error message. The legal kinds are 0 for generator, 
        1 for coroutine, and 2 for async generator. 
 
        New in version 3.10. 
        &quot;&quot;&quot;</span>
        <span class="s6"># no-op in Numba</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">op_BINARY_OP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">op </span><span class="s3">= </span><span class="s1">dis</span><span class="s3">.</span><span class="s1">_nb_ops</span><span class="s3">[</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">][</span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">rhs </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">lhs </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">op_name </span><span class="s3">= </span><span class="s1">ALL_BINOPS_TO_OPERATORS</span><span class="s3">[</span><span class="s1">op</span><span class="s3">].</span><span class="s1">__name__</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">=</span><span class="s5">f&quot;binop_</span><span class="s2">{</span><span class="s1">op_name</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">op</span><span class="s3">=</span><span class="s1">op</span><span class="s3">, </span><span class="s1">lhs</span><span class="s3">=</span><span class="s1">lhs</span><span class="s3">, </span><span class="s1">rhs</span><span class="s3">=</span><span class="s1">rhs</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_unaryop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s1">op_UNARY_NEGATIVE </span><span class="s3">= </span><span class="s1">_unaryop</span>
    <span class="s1">op_UNARY_POSITIVE </span><span class="s3">= </span><span class="s1">_unaryop</span>
    <span class="s1">op_UNARY_NOT </span><span class="s3">= </span><span class="s1">_unaryop</span>
    <span class="s1">op_UNARY_INVERT </span><span class="s3">= </span><span class="s1">_unaryop</span>

    <span class="s2">def </span><span class="s1">_binaryop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">rhs </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">lhs </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">lhs</span><span class="s3">=</span><span class="s1">lhs</span><span class="s3">, </span><span class="s1">rhs</span><span class="s3">=</span><span class="s1">rhs</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s1">op_COMPARE_OP </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_IS_OP </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_CONTAINS_OP </span><span class="s3">= </span><span class="s1">_binaryop</span>

    <span class="s1">op_INPLACE_ADD </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_SUBTRACT </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_MULTIPLY </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_DIVIDE </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_TRUE_DIVIDE </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_FLOOR_DIVIDE </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_MODULO </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_POWER </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_MATRIX_MULTIPLY </span><span class="s3">= </span><span class="s1">_binaryop</span>

    <span class="s1">op_INPLACE_LSHIFT </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_RSHIFT </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_AND </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_OR </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_INPLACE_XOR </span><span class="s3">= </span><span class="s1">_binaryop</span>

    <span class="s1">op_BINARY_ADD </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_SUBTRACT </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_MULTIPLY </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_DIVIDE </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_TRUE_DIVIDE </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_FLOOR_DIVIDE </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_MODULO </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_POWER </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_MATRIX_MULTIPLY </span><span class="s3">= </span><span class="s1">_binaryop</span>

    <span class="s1">op_BINARY_LSHIFT </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_RSHIFT </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_AND </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_OR </span><span class="s3">= </span><span class="s1">_binaryop</span>
    <span class="s1">op_BINARY_XOR </span><span class="s3">= </span><span class="s1">_binaryop</span>

    <span class="s2">def </span><span class="s1">op_MAKE_FUNCTION</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">, </span><span class="s1">MAKE_CLOSURE</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
            <span class="s6"># https://github.com/python/cpython/commit/2f180ce</span>
            <span class="s6"># name set via co_qualname</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>
        <span class="s1">code </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">closure </span><span class="s3">= </span><span class="s1">annotations </span><span class="s3">= </span><span class="s1">kwdefaults </span><span class="s3">= </span><span class="s1">defaults </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">0x8</span><span class="s3">:</span>
            <span class="s1">closure </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">0x4</span><span class="s3">:</span>
            <span class="s1">annotations </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">0x2</span><span class="s3">:</span>
            <span class="s1">kwdefaults </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">&amp; </span><span class="s4">0x1</span><span class="s3">:</span>
            <span class="s1">defaults </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">inst</span><span class="s3">,</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">name</span><span class="s3">,</span>
            <span class="s1">code</span><span class="s3">=</span><span class="s1">code</span><span class="s3">,</span>
            <span class="s1">closure</span><span class="s3">=</span><span class="s1">closure</span><span class="s3">,</span>
            <span class="s1">annotations</span><span class="s3">=</span><span class="s1">annotations</span><span class="s3">,</span>
            <span class="s1">kwdefaults</span><span class="s3">=</span><span class="s1">kwdefaults</span><span class="s3">,</span>
            <span class="s1">defaults</span><span class="s3">=</span><span class="s1">defaults</span><span class="s3">,</span>
            <span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_MAKE_CLOSURE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">op_MAKE_FUNCTION</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">, </span><span class="s1">MAKE_CLOSURE</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LOAD_CLOSURE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_LOAD_ASSERTION_ERROR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;assertion_error&quot;</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_CHECK_EXC_MATCH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">pred </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;predicate&quot;</span><span class="s3">)</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_tos</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">pred</span><span class="s3">=</span><span class="s1">pred</span><span class="s3">, </span><span class="s1">tos</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">, </span><span class="s1">tos1</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_JUMP_IF_NOT_EXC_MATCH</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s6"># Tests whether the second value on the stack is an exception matching</span>
        <span class="s6"># TOS, and jumps if it is not. Pops two values from the stack.</span>
        <span class="s1">pred </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;predicate&quot;</span><span class="s3">)</span>
        <span class="s1">tos </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">tos1 </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">pred</span><span class="s3">=</span><span class="s1">pred</span><span class="s3">, </span><span class="s1">tos</span><span class="s3">=</span><span class="s1">tos</span><span class="s3">, </span><span class="s1">tos1</span><span class="s3">=</span><span class="s1">tos1</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span><span class="s3">)</span>
        <span class="s1">state</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">get_jump_target</span><span class="s3">())</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_RERAISE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s6"># This isn't handled, but the state is set up anyway</span>
            <span class="s1">exc </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg </span><span class="s3">!= </span><span class="s4">0</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()     </span><span class="s6"># lasti</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">=</span><span class="s1">exc</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">state</span><span class="s3">.</span><span class="s1">has_active_try</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_adjust_except_stack</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>

    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_RERAISE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s6"># This isn't handled, but the state is set up anyway</span>
            <span class="s1">exc </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">=</span><span class="s1">exc</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s6"># NOTE: Please see notes in `interpreter.py` surrounding the implementation</span>
    <span class="s6"># of LOAD_METHOD and CALL_METHOD.</span>

    <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">), ):</span>
        <span class="s6"># LOAD_METHOD has become a pseudo-instruction in 3.12</span>
        <span class="s2">pass</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), ):</span>
        <span class="s2">def </span><span class="s1">op_LOAD_METHOD</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">item </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">extra </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_null</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">extra</span><span class="s3">)</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">()</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">, </span><span class="s1">item</span><span class="s3">=</span><span class="s1">item</span><span class="s3">, </span><span class="s1">res</span><span class="s3">=</span><span class="s1">res</span><span class="s3">)</span>
            <span class="s1">state</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
        <span class="s2">def </span><span class="s1">op_LOAD_METHOD</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">op_LOAD_ATTR</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">op_CALL_METHOD</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">op_CALL_FUNCTION</span><span class="s3">(</span><span class="s1">state</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">total_ordering</span>
<span class="s2">class </span><span class="s1">_State</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;State of the trace 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">bytecode</span><span class="s3">, </span><span class="s1">pc</span><span class="s3">, </span><span class="s1">nstack</span><span class="s3">, </span><span class="s1">blockstack</span><span class="s3">, </span><span class="s1">nullvals</span><span class="s3">=()):</span>
        <span class="s0">&quot;&quot;&quot; 
        Parameters 
        ---------- 
        bytecode : numba.bytecode.ByteCode 
            function bytecode 
        pc : int 
            program counter 
        nstack : int 
            stackdepth at entry 
        blockstack : Sequence[Dict] 
            A sequence of dictionary denoting entries on the blockstack. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode </span><span class="s3">= </span><span class="s1">bytecode</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_pc_initial </span><span class="s3">= </span><span class="s1">pc</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_pc </span><span class="s3">= </span><span class="s1">pc</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_nstack_initial </span><span class="s3">= </span><span class="s1">nstack</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack_initial </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">blockstack</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">blockstack</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_temp_registers </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_insts </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_outedges </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_terminated </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_phis </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_outgoing_phis </span><span class="s3">= </span><span class="s1">UniqueDict</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_used_regs </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">nstack</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">i </span><span class="s2">in </span><span class="s1">nullvals</span><span class="s3">:</span>
                <span class="s1">phi </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;null$&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">phi </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s5">&quot;phi&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_phis</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">] = </span><span class="s1">i</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">phi</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">&quot;State(pc_initial={} nstack_initial={})&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_pc_initial</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nstack_initial</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_identity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc_initial</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nstack_initial</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__hash__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">hash</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_identity</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">__lt__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_identity</span><span class="s3">() &lt; </span><span class="s1">other</span><span class="s3">.</span><span class="s1">get_identity</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_identity</span><span class="s3">() == </span><span class="s1">other</span><span class="s3">.</span><span class="s1">get_identity</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">pc_initial</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;The starting bytecode offset of this State. 
        The PC given to the constructor. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc_initial</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">instructions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;The list of instructions information as a 2-tuple of 
        ``(pc : int, register_map : Dict)`` 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_insts</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">outgoing_edges</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;The list of outgoing edges. 
 
        Returns 
        ------- 
        edges : List[State] 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_outedges</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">outgoing_phis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;The dictionary of outgoing phi nodes. 
 
        The keys are the name of the PHI nodes. 
        The values are the outgoing states. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_outgoing_phis</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">blockstack_initial</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;A copy of the initial state of the blockstack 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack_initial</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">stack_depth</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;The current size of the stack 
 
        Returns 
        ------- 
        res : int 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">find_initial_try_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Find the initial *try* block. 
        &quot;&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">blk </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack_initial</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">blk</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">] == </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">'TRY'</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">blk</span>

    <span class="s2">def </span><span class="s1">has_terminated</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_terminated</span>

    <span class="s2">def </span><span class="s1">get_inst</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">advance_pc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">inst </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_pc </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">next</span>

    <span class="s2">def </span><span class="s1">make_temp</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">prefix</span><span class="s3">=</span><span class="s5">&quot;&quot;</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">prefix</span><span class="s3">:</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;${prefix}{offset}{opname}.{tempct}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">prefix</span><span class="s3">=</span><span class="s1">prefix</span><span class="s3">,</span>
                <span class="s1">offset</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">,</span>
                <span class="s1">opname</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_inst</span><span class="s3">().</span><span class="s1">opname</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(),</span>
                <span class="s1">tempct</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_temp_registers</span><span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;${prefix}{offset}.{tempct}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">prefix</span><span class="s3">=</span><span class="s1">prefix</span><span class="s3">,</span>
                <span class="s1">offset</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">,</span>
                <span class="s1">tempct</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_temp_registers</span><span class="s3">),</span>
            <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_temp_registers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">name</span>

    <span class="s2">def </span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Append new inst&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_insts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">offset</span><span class="s3">, </span><span class="s1">kwargs</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_used_regs </span><span class="s3">|= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">_flatten_inst_regs</span><span class="s3">(</span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()))</span>

    <span class="s2">def </span><span class="s1">get_tos</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">peek</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">peek</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return the k'th element on the stack 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[-</span><span class="s1">k</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">push</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Push to stack&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Pop the stack&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">swap</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">idx</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Swap stack[idx] with the tos&quot;&quot;&quot;</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span>
        <span class="s1">s</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">], </span><span class="s1">s</span><span class="s3">[-</span><span class="s1">idx</span><span class="s3">] = </span><span class="s1">s</span><span class="s3">[-</span><span class="s1">idx</span><span class="s3">], </span><span class="s1">s</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">push_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">synblk</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Push a block to blockstack 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s5">'stack_depth' </span><span class="s2">in </span><span class="s1">synblk</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">synblk</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">reset_stack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">depth</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Reset the stack to the given stack depth. 
        Returning the popped items. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">, </span><span class="s1">popped </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[:</span><span class="s1">depth</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[</span><span class="s1">depth</span><span class="s3">:]</span>
        <span class="s2">return </span><span class="s1">popped</span>

    <span class="s2">def </span><span class="s1">make_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">end</span><span class="s3">, </span><span class="s1">reset_stack</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">handler</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Make a new block 
        &quot;&quot;&quot;</span>
        <span class="s1">d </span><span class="s3">= {</span>
            <span class="s5">'kind'</span><span class="s3">: </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">),</span>
            <span class="s5">'end'</span><span class="s3">: </span><span class="s1">end</span><span class="s3">,</span>
            <span class="s5">'entry_stack'</span><span class="s3">: </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">),</span>
        <span class="s3">}</span>
        <span class="s2">if </span><span class="s1">reset_stack</span><span class="s3">:</span>
            <span class="s1">d</span><span class="s3">[</span><span class="s5">'stack_depth'</span><span class="s3">] = </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">d</span><span class="s3">[</span><span class="s5">'stack_depth'</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">d</span><span class="s3">[</span><span class="s5">'handler'</span><span class="s3">] = </span><span class="s1">handler</span>
        <span class="s2">return </span><span class="s1">d</span>

    <span class="s2">def </span><span class="s1">pop_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Pop a block and unwind the stack 
        &quot;&quot;&quot;</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">reset_stack</span><span class="s3">(</span><span class="s1">b</span><span class="s3">[</span><span class="s5">'stack_depth'</span><span class="s3">])</span>
        <span class="s2">return </span><span class="s1">b</span>

    <span class="s2">def </span><span class="s1">pop_block_and_above</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">blk</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Find *blk* in the blockstack and remove it and all blocks above it 
        from the stack. 
        &quot;&quot;&quot;</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s1">blk</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s4">0 </span><span class="s3">&lt;= </span><span class="s1">idx </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">[:</span><span class="s1">idx</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Find the first block that matches *kind* 
        &quot;&quot;&quot;</span>
        <span class="s1">kind </span><span class="s3">= </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">bs </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">bs</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">] == </span><span class="s1">kind</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">bs</span>

    <span class="s2">def </span><span class="s1">get_top_block_either</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">kinds</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Find the first block that matches *kind* 
        &quot;&quot;&quot;</span>
        <span class="s1">kinds </span><span class="s3">= {</span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">) </span><span class="s2">for </span><span class="s1">kind </span><span class="s2">in </span><span class="s1">kinds</span><span class="s3">}</span>
        <span class="s2">for </span><span class="s1">bs </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">bs</span><span class="s3">[</span><span class="s5">'kind'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">kinds</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">bs</span>

    <span class="s2">def </span><span class="s1">has_active_try</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Returns a boolean indicating if the top-block is a *try* block 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_top_block</span><span class="s3">(</span><span class="s5">'TRY'</span><span class="s3">) </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">get_varname</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Get referenced variable name from the oparg 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span><span class="s3">.</span><span class="s1">co_varnames</span><span class="s3">[</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">arg</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">terminate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Mark block as terminated 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_terminated </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">fork</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pc</span><span class="s3">, </span><span class="s1">npop</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">npush</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">extra_block</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Fork the state 
        &quot;&quot;&quot;</span>
        <span class="s6"># Handle changes on the stack</span>
        <span class="s1">stack </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">npop</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s4">0 </span><span class="s3">&lt;= </span><span class="s1">npop </span><span class="s3">&lt;= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">)</span>
            <span class="s1">nstack </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">) - </span><span class="s1">npop</span>
            <span class="s1">stack </span><span class="s3">= </span><span class="s1">stack</span><span class="s3">[:</span><span class="s1">nstack</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">npush</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s4">0 </span><span class="s3">&lt;= </span><span class="s1">npush</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">npush</span><span class="s3">):</span>
                <span class="s1">stack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">())</span>
        <span class="s6"># Handle changes on the blockstack</span>
        <span class="s1">blockstack </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)):</span>
            <span class="s6"># pop expired block in destination pc</span>
            <span class="s2">while </span><span class="s1">blockstack</span><span class="s3">:</span>
                <span class="s1">top </span><span class="s3">= </span><span class="s1">blockstack</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]</span>
                <span class="s1">end </span><span class="s3">= </span><span class="s1">top</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'end_offset'</span><span class="s3">) </span><span class="s2">or </span><span class="s1">top</span><span class="s3">[</span><span class="s5">'end'</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">pc </span><span class="s3">&gt;= </span><span class="s1">end</span><span class="s3">:</span>
                    <span class="s1">blockstack</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">break</span>
        <span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s2">in </span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)):</span>
            <span class="s2">pass </span><span class="s6"># intentionally bypass</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">extra_block</span><span class="s3">:</span>
            <span class="s1">blockstack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">extra_block</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_outedges</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">Edge</span><span class="s3">(</span>
            <span class="s1">pc</span><span class="s3">=</span><span class="s1">pc</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">=</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">stack</span><span class="s3">), </span><span class="s1">npush</span><span class="s3">=</span><span class="s1">npush</span><span class="s3">,</span>
            <span class="s1">blockstack</span><span class="s3">=</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">blockstack</span><span class="s3">),</span>
        <span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">terminate</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">split_new_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Split the state 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fork</span><span class="s3">(</span><span class="s1">pc</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_outgoing_states</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Get states for each outgoing edges 
        &quot;&quot;&quot;</span>
        <span class="s6"># Should only call once</span>
        <span class="s2">assert not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_outgoing_phis</span>
        <span class="s1">ret </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">edge </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_outedges</span><span class="s3">:</span>
            <span class="s1">state </span><span class="s3">= </span><span class="s1">State</span><span class="s3">(</span><span class="s1">bytecode</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span><span class="s3">, </span><span class="s1">pc</span><span class="s3">=</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">pc</span><span class="s3">,</span>
                          <span class="s1">nstack</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">), </span><span class="s1">blockstack</span><span class="s3">=</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">blockstack</span><span class="s3">,</span>
                          <span class="s1">nullvals</span><span class="s3">=[</span><span class="s1">i </span><span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">)</span>
                                    <span class="s2">if </span><span class="s1">_is_null_temp_reg</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)])</span>
            <span class="s1">ret</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
            <span class="s6"># Map outgoing_phis</span>
            <span class="s2">for </span><span class="s1">phi</span><span class="s3">, </span><span class="s1">i </span><span class="s2">in </span><span class="s1">state</span><span class="s3">.</span><span class="s1">_phis</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_outgoing_phis</span><span class="s3">[</span><span class="s1">phi</span><span class="s3">] = </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">ret</span>

    <span class="s2">def </span><span class="s1">get_outgoing_edgepushed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Returns 
        ------- 
        Dict[int, int] 
            where keys are the PC 
            values are the edge-pushed stack values 
        &quot;&quot;&quot;</span>

        <span class="s2">return </span><span class="s3">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">pc</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">[-</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">npush</span><span class="s3">:])</span>
                <span class="s2">for </span><span class="s1">edge </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_outedges</span><span class="s3">}</span>


<span class="s2">class </span><span class="s1">StatePy311</span><span class="s3">(</span><span class="s1">_State</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_kw_names </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">pop_kw_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">out </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_kw_names</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_kw_names </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">return </span><span class="s1">out</span>

    <span class="s2">def </span><span class="s1">set_kw_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">val</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_kw_names </span><span class="s2">is None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_kw_names </span><span class="s3">= </span><span class="s1">val</span>

    <span class="s2">def </span><span class="s1">is_in_exception</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">bc </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span>
        <span class="s2">return </span><span class="s1">bc</span><span class="s3">.</span><span class="s1">find_exception_entry</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">) </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">get_exception</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">bc </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bytecode</span>
        <span class="s2">return </span><span class="s1">bc</span><span class="s3">.</span><span class="s1">find_exception_entry</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pc</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">in_with</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">ent </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blockstack_initial</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ent</span><span class="s3">[</span><span class="s5">&quot;kind&quot;</span><span class="s3">] == </span><span class="s1">BlockKind</span><span class="s3">(</span><span class="s5">&quot;WITH&quot;</span><span class="s3">):</span>
                <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">make_null</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">make_temp</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">=</span><span class="s5">&quot;null$&quot;</span><span class="s3">)</span>


<span class="s2">if </span><span class="s1">PYVERSION </span><span class="s3">&gt;= (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">):</span>
    <span class="s1">State </span><span class="s3">= </span><span class="s1">StatePy311</span>
<span class="s2">elif </span><span class="s1">PYVERSION </span><span class="s3">&lt; (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">):</span>
    <span class="s1">State </span><span class="s3">= </span><span class="s1">_State</span>
<span class="s2">else</span><span class="s3">:</span>
    <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">)</span>


<span class="s1">Edge </span><span class="s3">= </span><span class="s1">namedtuple</span><span class="s3">(</span><span class="s5">&quot;Edge&quot;</span><span class="s3">, [</span><span class="s5">&quot;pc&quot;</span><span class="s3">, </span><span class="s5">&quot;stack&quot;</span><span class="s3">, </span><span class="s5">&quot;blockstack&quot;</span><span class="s3">, </span><span class="s5">&quot;npush&quot;</span><span class="s3">])</span>


<span class="s2">class </span><span class="s1">AdaptDFA</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Adapt Flow to the old DFA class expected by Interpreter 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">flow</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_flow </span><span class="s3">= </span><span class="s1">flow</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">infos</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_flow</span><span class="s3">.</span><span class="s1">block_infos</span>


<span class="s1">AdaptBlockInfo </span><span class="s3">= </span><span class="s1">namedtuple</span><span class="s3">(</span>
    <span class="s5">&quot;AdaptBlockInfo&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s5">&quot;insts&quot;</span><span class="s3">, </span><span class="s5">&quot;outgoing_phis&quot;</span><span class="s3">, </span><span class="s5">&quot;blockstack&quot;</span><span class="s3">, </span><span class="s5">&quot;active_try_block&quot;</span><span class="s3">,</span>
     <span class="s5">&quot;outgoing_edgepushed&quot;</span><span class="s3">],</span>
<span class="s3">)</span>


<span class="s2">def </span><span class="s1">adapt_state_infos</span><span class="s3">(</span><span class="s1">state</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">AdaptBlockInfo</span><span class="s3">(</span>
        <span class="s1">insts</span><span class="s3">=</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">state</span><span class="s3">.</span><span class="s1">instructions</span><span class="s3">),</span>
        <span class="s1">outgoing_phis</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">outgoing_phis</span><span class="s3">,</span>
        <span class="s1">blockstack</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">blockstack_initial</span><span class="s3">,</span>
        <span class="s1">active_try_block</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">find_initial_try_block</span><span class="s3">(),</span>
        <span class="s1">outgoing_edgepushed</span><span class="s3">=</span><span class="s1">state</span><span class="s3">.</span><span class="s1">get_outgoing_edgepushed</span><span class="s3">(),</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_flatten_inst_regs</span><span class="s3">(</span><span class="s1">iterable</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Flatten an iterable of registers used in an instruction 
    &quot;&quot;&quot;</span>
    <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">iterable</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">yield </span><span class="s1">item</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, (</span><span class="s1">tuple</span><span class="s3">, </span><span class="s1">list</span><span class="s3">)):</span>
            <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">_flatten_inst_regs</span><span class="s3">(</span><span class="s1">item</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">x</span>


<span class="s2">class </span><span class="s1">AdaptCFA</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Adapt Flow to the old CFA class expected by Interpreter 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">flow</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_flow </span><span class="s3">= </span><span class="s1">flow</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_blocks </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">offset</span><span class="s3">, </span><span class="s1">blockinfo </span><span class="s2">in </span><span class="s1">flow</span><span class="s3">.</span><span class="s1">block_infos</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_blocks</span><span class="s3">[</span><span class="s1">offset</span><span class="s3">] = </span><span class="s1">AdaptCFBlock</span><span class="s3">(</span><span class="s1">blockinfo</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">)</span>
        <span class="s1">backbone </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_flow</span><span class="s3">.</span><span class="s1">cfgraph</span><span class="s3">.</span><span class="s1">backbone</span><span class="s3">()</span>

        <span class="s1">graph </span><span class="s3">= </span><span class="s1">flow</span><span class="s3">.</span><span class="s1">cfgraph</span>
        <span class="s6"># Find backbone</span>
        <span class="s1">backbone </span><span class="s3">= </span><span class="s1">graph</span><span class="s3">.</span><span class="s1">backbone</span><span class="s3">()</span>
        <span class="s6"># Filter out in loop blocks (Assuming no other cyclic control blocks)</span>
        <span class="s6"># This is to unavoid variables defined in loops being considered as</span>
        <span class="s6"># function scope.</span>
        <span class="s1">inloopblocks </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">blocks</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">graph</span><span class="s3">.</span><span class="s1">in_loops</span><span class="s3">(</span><span class="s1">b</span><span class="s3">):</span>
                <span class="s1">inloopblocks</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_backbone </span><span class="s3">= </span><span class="s1">backbone </span><span class="s3">- </span><span class="s1">inloopblocks</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">graph</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_flow</span><span class="s3">.</span><span class="s1">cfgraph</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">backbone</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_backbone</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">blocks</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_blocks</span>

    <span class="s2">def </span><span class="s1">iterliveblocks</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">blocks</span><span class="s3">):</span>
            <span class="s2">yield </span><span class="s1">self</span><span class="s3">.</span><span class="s1">blocks</span><span class="s3">[</span><span class="s1">b</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">dump</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_flow</span><span class="s3">.</span><span class="s1">cfgraph</span><span class="s3">.</span><span class="s1">dump</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">AdaptCFBlock</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">blockinfo</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">offset </span><span class="s3">= </span><span class="s1">offset</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">body </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">i </span><span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">blockinfo</span><span class="s3">.</span><span class="s1">insts</span><span class="s3">)</span>
</pre>
</body>
</html>