<html>
<head>
<title>ddsfile.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ddsfile.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
DDS File library 
================ 
 
This library can be used to parse and save DDS 
(`DirectDraw Surface &lt;https://en.wikipedia.org/wiki/DirectDraw_Surface&gt;`) 
files. 
 
The initial version was written by:: 
 
    Alexey Borzenkov (snaury@gmail.com) 
 
All the initial work credits go to him! Thank you :) 
 
This version uses structs instead of ctypes. 
 
 
DDS Format 
---------- 
 
:: 
 
    [DDS ][SurfaceDesc][Data] 
 
    [SurfaceDesc]:: (everything is uint32) 
        Size 
        Flags 
        Height 
        Width 
        PitchOrLinearSize 
        Depth 
        MipmapCount 
        Reserved1 * 11 
        [PixelFormat]:: 
            Size 
            Flags 
            FourCC 
            RGBBitCount 
            RBitMask 
            GBitMask 
            BBitMask 
            ABitMask 
        [Caps]:: 
            Caps1 
            Caps2 
            Reserved1 * 2 
        Reserverd2 
 
.. warning:: 
 
    This is an external library and Kivy does not provide any support for it. 
    It might change in the future and we advise you don't rely on it in your 
    code. 
 
'''</span>
<span class="s2"># flake8: noqa</span>

<span class="s3">from </span><span class="s1">struct </span><span class="s3">import </span><span class="s1">pack</span><span class="s4">, </span><span class="s1">unpack</span><span class="s4">, </span><span class="s1">calcsize</span>

<span class="s2"># DDSURFACEDESC2 dwFlags</span>
<span class="s1">DDSD_CAPS                  </span><span class="s4">= </span><span class="s5">0x00000001</span>
<span class="s1">DDSD_HEIGHT                </span><span class="s4">= </span><span class="s5">0x00000002</span>
<span class="s1">DDSD_WIDTH                 </span><span class="s4">= </span><span class="s5">0x00000004</span>
<span class="s1">DDSD_PITCH                 </span><span class="s4">= </span><span class="s5">0x00000008</span>
<span class="s1">DDSD_PIXELFORMAT           </span><span class="s4">= </span><span class="s5">0x00001000</span>
<span class="s1">DDSD_MIPMAPCOUNT           </span><span class="s4">= </span><span class="s5">0x00020000</span>
<span class="s1">DDSD_LINEARSIZE            </span><span class="s4">= </span><span class="s5">0x00080000</span>
<span class="s1">DDSD_DEPTH                 </span><span class="s4">= </span><span class="s5">0x00800000</span>

<span class="s2"># DDPIXELFORMAT dwFlags</span>
<span class="s1">DDPF_ALPHAPIXELS           </span><span class="s4">= </span><span class="s5">0x00000001</span>
<span class="s1">DDPF_FOURCC                </span><span class="s4">= </span><span class="s5">0x00000004</span>
<span class="s1">DDPF_RGB                   </span><span class="s4">= </span><span class="s5">0x00000040</span>
<span class="s1">DDPF_LUMINANCE             </span><span class="s4">= </span><span class="s5">0x00020000</span>

<span class="s2"># DDSCAPS2 dwCaps1</span>
<span class="s1">DDSCAPS_COMPLEX            </span><span class="s4">= </span><span class="s5">0x00000008</span>
<span class="s1">DDSCAPS_TEXTURE            </span><span class="s4">= </span><span class="s5">0x00001000</span>
<span class="s1">DDSCAPS_MIPMAP             </span><span class="s4">= </span><span class="s5">0x00400000</span>

<span class="s2"># DDSCAPS2 dwCaps2</span>
<span class="s1">DDSCAPS2_CUBEMAP           </span><span class="s4">= </span><span class="s5">0x00000200</span>
<span class="s1">DDSCAPS2_CUBEMAP_POSITIVEX </span><span class="s4">= </span><span class="s5">0x00000400</span>
<span class="s1">DDSCAPS2_CUBEMAP_NEGATIVEX </span><span class="s4">= </span><span class="s5">0x00000800</span>
<span class="s1">DDSCAPS2_CUBEMAP_POSITIVEY </span><span class="s4">= </span><span class="s5">0x00001000</span>
<span class="s1">DDSCAPS2_CUBEMAP_NEGATIVEY </span><span class="s4">= </span><span class="s5">0x00002000</span>
<span class="s1">DDSCAPS2_CUBEMAP_POSITIVEZ </span><span class="s4">= </span><span class="s5">0x00004000</span>
<span class="s1">DDSCAPS2_CUBEMAP_NEGATIVEZ </span><span class="s4">= </span><span class="s5">0x00008000</span>
<span class="s1">DDSCAPS2_VOLUME            </span><span class="s4">= </span><span class="s5">0x00200000</span>

<span class="s2"># Common FOURCC codes</span>
<span class="s1">DDS_DXTN </span><span class="s4">= </span><span class="s5">0x00545844</span>
<span class="s1">DDS_DXT1 </span><span class="s4">= </span><span class="s5">0x31545844</span>
<span class="s1">DDS_DXT2 </span><span class="s4">= </span><span class="s5">0x32545844</span>
<span class="s1">DDS_DXT3 </span><span class="s4">= </span><span class="s5">0x33545844</span>
<span class="s1">DDS_DXT4 </span><span class="s4">= </span><span class="s5">0x34545844</span>
<span class="s1">DDS_DXT5 </span><span class="s4">= </span><span class="s5">0x35545844</span>

<span class="s3">def </span><span class="s1">dxt_to_str</span><span class="s4">(</span><span class="s1">dxt</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s1">DDS_DXT1</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'s3tc_dxt1'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s1">DDS_DXT2</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'s3tc_dxt2'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s1">DDS_DXT3</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'s3tc_dxt3'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s1">DDS_DXT4</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'s3tc_dxt4'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s1">DDS_DXT5</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'s3tc_dxt5'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'rgba'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'alpha'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s5">2</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'luminance'</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s4">== </span><span class="s5">3</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">'luminance_alpha'</span>

<span class="s3">def </span><span class="s1">str_to_dxt</span><span class="s4">(</span><span class="s1">dxt</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'s3tc_dxt1'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">DDS_DXT1</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'s3tc_dxt2'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">DDS_DXT2</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'s3tc_dxt3'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">DDS_DXT3</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'s3tc_dxt4'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">DDS_DXT4</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'s3tc_dxt5'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">DDS_DXT5</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'rgba'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">0</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'alpha'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">1</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'luminance'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">2</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s6">'luminance_alpha'</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">3</span>

<span class="s3">def </span><span class="s1">align_value</span><span class="s4">(</span><span class="s1">val</span><span class="s4">, </span><span class="s1">b</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s1">val </span><span class="s4">+ (-</span><span class="s1">val </span><span class="s4">% </span><span class="s1">b</span><span class="s4">)</span>

<span class="s3">def </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">val</span><span class="s4">, </span><span class="s1">fl</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">val </span><span class="s4">&amp; </span><span class="s1">fl</span><span class="s4">) == </span><span class="s1">fl</span>

<span class="s3">def </span><span class="s1">dxt_size</span><span class="s4">(</span><span class="s1">w</span><span class="s4">, </span><span class="s1">h</span><span class="s4">, </span><span class="s1">dxt</span><span class="s4">):</span>
    <span class="s1">w </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">w </span><span class="s4">// </span><span class="s5">4</span><span class="s4">)</span>
    <span class="s1">h </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">h </span><span class="s4">// </span><span class="s5">4</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">dxt </span><span class="s4">== </span><span class="s1">DDS_DXT1</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">w </span><span class="s4">* </span><span class="s1">h </span><span class="s4">* </span><span class="s5">8</span>
    <span class="s3">elif </span><span class="s1">dxt </span><span class="s3">in </span><span class="s4">(</span><span class="s1">DDS_DXT2</span><span class="s4">, </span><span class="s1">DDS_DXT3</span><span class="s4">, </span><span class="s1">DDS_DXT4</span><span class="s4">, </span><span class="s1">DDS_DXT5</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">w </span><span class="s4">* </span><span class="s1">h </span><span class="s4">* </span><span class="s5">16</span>
    <span class="s3">return </span><span class="s4">-</span><span class="s5">1</span>

<span class="s3">class </span><span class="s1">QueryDict</span><span class="s4">(</span><span class="s1">dict</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__getattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">):</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">attr</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">super</span><span class="s4">(</span><span class="s1">QueryDict</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">__getattr__</span><span class="s4">(</span><span class="s1">attr</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">KeyError</span><span class="s4">(</span><span class="s1">attr</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__setattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">__setitem__</span><span class="s4">(</span><span class="s1">attr</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
    <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">DDSFile</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s1">fields </span><span class="s4">= (</span>
        <span class="s4">(</span><span class="s6">'size'</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), (</span><span class="s6">'flags'</span><span class="s4">, </span><span class="s5">1</span><span class="s4">), (</span><span class="s6">'height'</span><span class="s4">, </span><span class="s5">2</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">'width'</span><span class="s4">, </span><span class="s5">3</span><span class="s4">), (</span><span class="s6">'pitchOrLinearSize'</span><span class="s4">, </span><span class="s5">4</span><span class="s4">), (</span><span class="s6">'depth'</span><span class="s4">, </span><span class="s5">5</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">'mipmapCount'</span><span class="s4">, </span><span class="s5">6</span><span class="s4">), (</span><span class="s6">'pf_size'</span><span class="s4">, </span><span class="s5">18</span><span class="s4">), (</span><span class="s6">'pf_flags'</span><span class="s4">, </span><span class="s5">19</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">'pf_fourcc'</span><span class="s4">, </span><span class="s5">20</span><span class="s4">), (</span><span class="s6">'pf_rgbBitCount'</span><span class="s4">, </span><span class="s5">21</span><span class="s4">), (</span><span class="s6">'pf_rBitMask'</span><span class="s4">, </span><span class="s5">22</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">'pf_gBitMask'</span><span class="s4">, </span><span class="s5">23</span><span class="s4">), (</span><span class="s6">'pf_bBitMask'</span><span class="s4">, </span><span class="s5">24</span><span class="s4">), (</span><span class="s6">'pf_aBitMask'</span><span class="s4">, </span><span class="s5">25</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">'caps1'</span><span class="s4">, </span><span class="s5">26</span><span class="s4">), (</span><span class="s6">'caps2'</span><span class="s4">, </span><span class="s5">27</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">(</span><span class="s1">DDSFile</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">__init__</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_dxt </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_fmt </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">meta </span><span class="s4">= </span><span class="s1">meta </span><span class="s4">= </span><span class="s1">QueryDict</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">count </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">images </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">images_size </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">field</span><span class="s4">, </span><span class="s1">index </span><span class="s3">in </span><span class="s1">DDSFile</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">:</span>
            <span class="s1">meta</span><span class="s4">[</span><span class="s1">field</span><span class="s4">] = </span><span class="s5">0</span>
        <span class="s3">if </span><span class="s1">filename</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">load</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">load</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">filename </span><span class="s4">= </span><span class="s1">filename</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s6">'rb'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fd</span><span class="s4">:</span>
            <span class="s1">data </span><span class="s4">= </span><span class="s1">fd</span><span class="s4">.</span><span class="s1">read</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s1">data</span><span class="s4">[:</span><span class="s5">4</span><span class="s4">] != </span><span class="s7">b'DDS '</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Invalid magic header {}'</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">data</span><span class="s4">[:</span><span class="s5">4</span><span class="s4">]))</span>

        <span class="s2"># read header</span>
        <span class="s1">fmt </span><span class="s4">= </span><span class="s6">'I' </span><span class="s4">* </span><span class="s5">31</span>
        <span class="s1">fmt_size </span><span class="s4">= </span><span class="s1">calcsize</span><span class="s4">(</span><span class="s1">fmt</span><span class="s4">)</span>
        <span class="s1">pf_size </span><span class="s4">= </span><span class="s1">calcsize</span><span class="s4">(</span><span class="s6">'I' </span><span class="s4">* </span><span class="s5">8</span><span class="s4">)</span>
        <span class="s1">header</span><span class="s4">, </span><span class="s1">data </span><span class="s4">= </span><span class="s1">data</span><span class="s4">[</span><span class="s5">4</span><span class="s4">:</span><span class="s5">4</span><span class="s4">+</span><span class="s1">fmt_size</span><span class="s4">], </span><span class="s1">data</span><span class="s4">[</span><span class="s5">4</span><span class="s4">+</span><span class="s1">fmt_size</span><span class="s4">:]</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">header</span><span class="s4">) != </span><span class="s1">fmt_size</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Truncated header in'</span><span class="s4">)</span>

        <span class="s2"># depack</span>
        <span class="s1">header </span><span class="s4">= </span><span class="s1">unpack</span><span class="s4">(</span><span class="s1">fmt</span><span class="s4">, </span><span class="s1">header</span><span class="s4">)</span>
        <span class="s1">meta </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">meta</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">index </span><span class="s3">in </span><span class="s1">DDSFile</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">:</span>
            <span class="s1">meta</span><span class="s4">[</span><span class="s1">name</span><span class="s4">] = </span><span class="s1">header</span><span class="s4">[</span><span class="s1">index</span><span class="s4">]</span>

        <span class="s2"># check header validity</span>
        <span class="s3">if </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">size </span><span class="s4">!= </span><span class="s1">fmt_size</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Invalid header size (%d instead of %d)' </span><span class="s4">%</span>
                    <span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">size</span><span class="s4">, </span><span class="s1">fmt_size</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_size </span><span class="s4">!= </span><span class="s1">pf_size</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Invalid pixelformat size (%d instead of %d)' </span><span class="s4">%</span>
                    <span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_size</span><span class="s4">, </span><span class="s1">pf_size</span><span class="s4">))</span>
        <span class="s3">if not </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">,</span>
                <span class="s1">DDSD_CAPS </span><span class="s4">| </span><span class="s1">DDSD_PIXELFORMAT </span><span class="s4">| </span><span class="s1">DDSD_WIDTH </span><span class="s4">| </span><span class="s1">DDSD_HEIGHT</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Not enough flags'</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">caps1</span><span class="s4">, </span><span class="s1">DDSCAPS_TEXTURE</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Not a DDS texture'</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">count </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s3">if </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">, </span><span class="s1">DDSD_MIPMAPCOUNT</span><span class="s4">):</span>
            <span class="s3">if not </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">caps1</span><span class="s4">, </span><span class="s1">DDSCAPS_COMPLEX </span><span class="s4">| </span><span class="s1">DDSCAPS_MIPMAP</span><span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Invalid mipmap without flags'</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">count </span><span class="s4">= </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">mipmapCount</span>

        <span class="s1">hasrgb </span><span class="s4">= </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags</span><span class="s4">, </span><span class="s1">DDPF_RGB</span><span class="s4">)</span>
        <span class="s1">hasalpha </span><span class="s4">= </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags</span><span class="s4">, </span><span class="s1">DDPF_ALPHAPIXELS</span><span class="s4">)</span>
        <span class="s1">hasluminance </span><span class="s4">= </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags</span><span class="s4">, </span><span class="s1">DDPF_LUMINANCE</span><span class="s4">)</span>
        <span class="s1">bpp </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">dxt </span><span class="s4">= </span><span class="s1">block </span><span class="s4">= </span><span class="s1">pitch </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s3">if </span><span class="s1">hasrgb </span><span class="s3">or </span><span class="s1">hasalpha </span><span class="s3">or </span><span class="s1">hasluminance</span><span class="s4">:</span>
            <span class="s1">bpp </span><span class="s4">= </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_rgbBitCount</span>

        <span class="s3">if </span><span class="s1">hasrgb </span><span class="s3">and </span><span class="s1">hasluminance</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'File have RGB and Luminance'</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">hasrgb</span><span class="s4">:</span>
            <span class="s1">dxt </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s3">elif </span><span class="s1">hasalpha </span><span class="s3">and not </span><span class="s1">hasluminance</span><span class="s4">:</span>
            <span class="s1">dxt </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">hasluminance </span><span class="s3">and not </span><span class="s1">hasalpha</span><span class="s4">:</span>
            <span class="s1">dxt </span><span class="s4">= </span><span class="s5">2</span>
        <span class="s3">elif </span><span class="s1">hasalpha </span><span class="s3">and </span><span class="s1">hasluminance</span><span class="s4">:</span>
            <span class="s1">dxt </span><span class="s4">= </span><span class="s5">3</span>
        <span class="s3">elif </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags</span><span class="s4">, </span><span class="s1">DDPF_FOURCC</span><span class="s4">):</span>
            <span class="s1">dxt </span><span class="s4">= </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_fourcc</span>
            <span class="s3">if </span><span class="s1">dxt </span><span class="s3">not in </span><span class="s4">(</span><span class="s1">DDS_DXT1</span><span class="s4">, </span><span class="s1">DDS_DXT2</span><span class="s4">, </span><span class="s1">DDS_DXT3</span><span class="s4">, </span><span class="s1">DDS_DXT4</span><span class="s4">, </span><span class="s1">DDS_DXT5</span><span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Unsupported FOURCC'</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Unsupported format specified'</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">bpp</span><span class="s4">:</span>
            <span class="s1">block </span><span class="s4">= </span><span class="s1">align_value</span><span class="s4">(</span><span class="s1">bpp</span><span class="s4">, </span><span class="s5">8</span><span class="s4">) // </span><span class="s5">8</span>
            <span class="s1">pitch </span><span class="s4">= </span><span class="s1">align_value</span><span class="s4">(</span><span class="s1">block </span><span class="s4">* </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">width</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">check_flags</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">, </span><span class="s1">DDSD_LINEARSIZE</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">dxt </span><span class="s3">in </span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">):</span>
                <span class="s1">size </span><span class="s4">= </span><span class="s1">pitch </span><span class="s4">* </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">height</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">size </span><span class="s4">= </span><span class="s1">dxt_size</span><span class="s4">(</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">width</span><span class="s4">, </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">height</span><span class="s4">, </span><span class="s1">dxt</span><span class="s4">)</span>

        <span class="s1">w </span><span class="s4">= </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">width</span>
        <span class="s1">h </span><span class="s4">= </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">height</span>
        <span class="s1">images </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">images</span>
        <span class="s1">images_size </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">images_size</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">count</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">dxt </span><span class="s3">in </span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">):</span>
                <span class="s1">size </span><span class="s4">= </span><span class="s1">align_value</span><span class="s4">(</span><span class="s1">block </span><span class="s4">* </span><span class="s1">w</span><span class="s4">, </span><span class="s5">4</span><span class="s4">) * </span><span class="s1">h</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">size </span><span class="s4">= </span><span class="s1">dxt_size</span><span class="s4">(</span><span class="s1">w</span><span class="s4">, </span><span class="s1">h</span><span class="s4">, </span><span class="s1">dxt</span><span class="s4">)</span>
            <span class="s1">image</span><span class="s4">, </span><span class="s1">data </span><span class="s4">= </span><span class="s1">data</span><span class="s4">[:</span><span class="s1">size</span><span class="s4">], </span><span class="s1">data</span><span class="s4">[</span><span class="s1">size</span><span class="s4">:]</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">image</span><span class="s4">) &lt; </span><span class="s1">size</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Truncated image for mipmap %d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">)</span>
            <span class="s1">images_size</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">w</span><span class="s4">, </span><span class="s1">h</span><span class="s4">))</span>
            <span class="s1">images</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">image</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">w </span><span class="s4">== </span><span class="s5">1 </span><span class="s3">and </span><span class="s1">h </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
                <span class="s3">break</span>
            <span class="s1">w </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">w </span><span class="s4">// </span><span class="s5">2</span><span class="s4">)</span>
            <span class="s1">h </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">h </span><span class="s4">// </span><span class="s5">2</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">images</span><span class="s4">) == </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'No images available'</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">images</span><span class="s4">) &lt; </span><span class="s1">self</span><span class="s4">.</span><span class="s1">count</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'Not enough images'</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_dxt </span><span class="s4">= </span><span class="s1">dxt</span>

    <span class="s3">def </span><span class="s1">save</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">images</span><span class="s4">) == </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">DDSException</span><span class="s4">(</span><span class="s6">'No images to save'</span><span class="s4">)</span>

        <span class="s1">fields </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">DDSFile</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">)</span>
        <span class="s1">fields_keys </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">fields</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">())</span>
        <span class="s1">fields_index </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">fields</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
        <span class="s1">mget </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">get</span>
        <span class="s1">header </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">idx </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">31</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">idx </span><span class="s3">in </span><span class="s1">fields_index</span><span class="s4">:</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s1">mget</span><span class="s4">(</span><span class="s1">fields_keys</span><span class="s4">[</span><span class="s1">fields_index</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">)], </span><span class="s5">0</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s5">0</span>
            <span class="s1">header</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s6">'wb'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fd</span><span class="s4">:</span>
            <span class="s1">fd</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s6">'DDS '</span><span class="s4">)</span>
            <span class="s1">fd</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">'I' </span><span class="s4">* </span><span class="s5">31</span><span class="s4">, *</span><span class="s1">header</span><span class="s4">))</span>
            <span class="s3">for </span><span class="s1">image </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">images</span><span class="s4">:</span>
                <span class="s1">fd</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">image</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">add_image</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">level</span><span class="s4">, </span><span class="s1">bpp</span><span class="s4">, </span><span class="s1">fmt</span><span class="s4">, </span><span class="s1">width</span><span class="s4">, </span><span class="s1">height</span><span class="s4">, </span><span class="s1">data</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">bpp </span><span class="s4">== </span><span class="s5">32</span>
        <span class="s3">assert </span><span class="s1">fmt </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'rgb'</span><span class="s4">, </span><span class="s6">'rgba'</span><span class="s4">, </span><span class="s6">'dxt1'</span><span class="s4">, </span><span class="s6">'dxt2'</span><span class="s4">, </span><span class="s6">'dxt3'</span><span class="s4">, </span><span class="s6">'dxt4'</span><span class="s4">, </span><span class="s6">'dxt5'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">width </span><span class="s4">&gt; </span><span class="s5">0</span>
        <span class="s3">assert </span><span class="s1">height </span><span class="s4">&gt; </span><span class="s5">0</span>
        <span class="s3">assert </span><span class="s1">level </span><span class="s4">&gt;= </span><span class="s5">0</span>

        <span class="s1">meta </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">meta</span>
        <span class="s1">images </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">images</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">images</span><span class="s4">) == </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">level </span><span class="s4">== </span><span class="s5">0</span>

            <span class="s2"># first image, set defaults !</span>
            <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">():</span>
                <span class="s1">meta</span><span class="s4">[</span><span class="s1">k</span><span class="s4">] = </span><span class="s5">0</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">_fmt </span><span class="s4">= </span><span class="s1">fmt</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">size </span><span class="s4">= </span><span class="s1">calcsize</span><span class="s4">(</span><span class="s6">'I' </span><span class="s4">* </span><span class="s5">31</span><span class="s4">)</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_size </span><span class="s4">= </span><span class="s1">calcsize</span><span class="s4">(</span><span class="s6">'I' </span><span class="s4">* </span><span class="s5">8</span><span class="s4">)</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags </span><span class="s4">= </span><span class="s5">0</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">DDSD_CAPS </span><span class="s4">| </span><span class="s1">DDSD_PIXELFORMAT </span><span class="s4">| </span><span class="s1">DDSD_WIDTH </span><span class="s4">| </span><span class="s1">DDSD_HEIGHT</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">width </span><span class="s4">= </span><span class="s1">width</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">height </span><span class="s4">= </span><span class="s1">height</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">caps1 </span><span class="s4">= </span><span class="s1">DDSCAPS_TEXTURE</span>

            <span class="s1">meta</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">DDSD_LINEARSIZE</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pitchOrLinearSize </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>

            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_rgbBitCount </span><span class="s4">= </span><span class="s5">32</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_rBitMask </span><span class="s4">= </span><span class="s5">0x00ff0000</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_gBitMask </span><span class="s4">= </span><span class="s5">0x0000ff00</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_bBitMask </span><span class="s4">= </span><span class="s5">0x000000ff</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_aBitMask </span><span class="s4">= </span><span class="s5">0xff000000</span>

            <span class="s3">if </span><span class="s1">fmt </span><span class="s3">in </span><span class="s4">(</span><span class="s6">'rgb'</span><span class="s4">, </span><span class="s6">'rgba'</span><span class="s4">):</span>
                <span class="s3">assert True</span>
                <span class="s3">assert </span><span class="s1">bpp </span><span class="s4">== </span><span class="s5">32</span>
                <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags </span><span class="s4">|= </span><span class="s1">DDPF_RGB</span>
                <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_rgbBitCount </span><span class="s4">= </span><span class="s5">32</span>
                <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_rBitMask </span><span class="s4">= </span><span class="s5">0x00ff0000</span>
                <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_gBitMask </span><span class="s4">= </span><span class="s5">0x0000ff00</span>
                <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_bBitMask </span><span class="s4">= </span><span class="s5">0x000000ff</span>
                <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_aBitMask </span><span class="s4">= </span><span class="s5">0x00000000</span>
                <span class="s3">if </span><span class="s1">fmt </span><span class="s4">== </span><span class="s6">'rgba'</span><span class="s4">:</span>
                    <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags </span><span class="s4">|= </span><span class="s1">DDPF_ALPHAPIXELS</span>
                    <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_aBitMask </span><span class="s4">= </span><span class="s5">0xff000000</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_flags </span><span class="s4">|= </span><span class="s1">DDPF_FOURCC</span>
                <span class="s3">if </span><span class="s1">fmt </span><span class="s4">== </span><span class="s6">'dxt1'</span><span class="s4">:</span>
                    <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_fourcc </span><span class="s4">= </span><span class="s1">DDS_DXT1</span>
                <span class="s3">elif </span><span class="s1">fmt </span><span class="s4">== </span><span class="s6">'dxt2'</span><span class="s4">:</span>
                    <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_fourcc </span><span class="s4">= </span><span class="s1">DDS_DXT2</span>
                <span class="s3">elif </span><span class="s1">fmt </span><span class="s4">== </span><span class="s6">'dxt3'</span><span class="s4">:</span>
                    <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_fourcc </span><span class="s4">= </span><span class="s1">DDS_DXT3</span>
                <span class="s3">elif </span><span class="s1">fmt </span><span class="s4">== </span><span class="s6">'dxt4'</span><span class="s4">:</span>
                    <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_fourcc </span><span class="s4">= </span><span class="s1">DDS_DXT4</span>
                <span class="s3">elif </span><span class="s1">fmt </span><span class="s4">== </span><span class="s6">'dxt5'</span><span class="s4">:</span>
                    <span class="s1">meta</span><span class="s4">.</span><span class="s1">pf_fourcc </span><span class="s4">= </span><span class="s1">DDS_DXT5</span>

            <span class="s1">images</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">level </span><span class="s4">== </span><span class="s1">len</span><span class="s4">(</span><span class="s1">images</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">fmt </span><span class="s4">== </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fmt</span>

            <span class="s1">images</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>

            <span class="s1">meta</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">DDSD_MIPMAPCOUNT</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">caps1 </span><span class="s4">|= </span><span class="s1">DDSCAPS_COMPLEX </span><span class="s4">| </span><span class="s1">DDSCAPS_MIPMAP</span>
            <span class="s1">meta</span><span class="s4">.</span><span class="s1">mipmapCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">images</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s6">'&lt;DDSFile filename=%r size=%r dxt=%r len(images)=%r&gt;' </span><span class="s4">% (</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">size</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dxt</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">images</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">_get_size</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">meta </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">meta</span>
        <span class="s3">return </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">width</span><span class="s4">, </span><span class="s1">meta</span><span class="s4">.</span><span class="s1">height</span>
    <span class="s3">def </span><span class="s1">_set_size</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">size</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">meta</span><span class="s4">.</span><span class="s1">update</span><span class="s4">({</span><span class="s6">'width'</span><span class="s4">: </span><span class="s1">size</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s6">'height'</span><span class="s4">: </span><span class="s1">size</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]})</span>
    <span class="s1">size </span><span class="s4">= </span><span class="s1">property</span><span class="s4">(</span><span class="s1">_get_size</span><span class="s4">, </span><span class="s1">_set_size</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_get_dxt</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">dxt_to_str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_dxt</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">_set_dxt</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dxt</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_dxt </span><span class="s4">= </span><span class="s1">str_to_dxt</span><span class="s4">(</span><span class="s1">dxt</span><span class="s4">)</span>
    <span class="s1">dxt </span><span class="s4">= </span><span class="s1">property</span><span class="s4">(</span><span class="s1">_get_dxt</span><span class="s4">, </span><span class="s1">_set_dxt</span><span class="s4">)</span>

<span class="s3">if </span><span class="s1">__name__ </span><span class="s4">== </span><span class="s6">'__main__'</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">sys</span>
    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">sys</span><span class="s4">.</span><span class="s1">argv</span><span class="s4">) == </span><span class="s5">1</span><span class="s4">:</span>
        <span class="s1">print</span><span class="s4">(</span><span class="s6">'Usage: python ddsfile.py &lt;file1&gt; &lt;file2&gt; ...'</span><span class="s4">)</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">exit</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">filename </span><span class="s3">in </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">argv</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]:</span>
        <span class="s1">print</span><span class="s4">(</span><span class="s6">'=== Loading'</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">dds </span><span class="s4">= </span><span class="s1">DDSFile</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">=</span><span class="s1">filename</span><span class="s4">)</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s1">dds</span><span class="s4">)</span>
            <span class="s1">dds</span><span class="s4">.</span><span class="s1">save</span><span class="s4">(</span><span class="s6">'bleh.dds'</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">IOError </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s6">'ERR&gt;'</span><span class="s4">, </span><span class="s1">e</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">DDSException </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s6">'DDS&gt;'</span><span class="s4">, </span><span class="s1">e</span><span class="s4">)</span>
</pre>
</body>
</html>