<html>
<head>
<title>pep8.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pep8.py</font>
</center></td></tr></table>
<pre><span class="s0">#!/usr/bin/env python</span>
<span class="s0"># pycodestyle.py - Check Python source code formatting, according to PEP 8</span>
<span class="s0">#</span>
<span class="s0"># Copyright (C) 2006-2009 Johann C. Rocholl &lt;johann@rocholl.net&gt;</span>
<span class="s0"># Copyright (C) 2009-2014 Florent Xicluna &lt;florent.xicluna@gmail.com&gt;</span>
<span class="s0"># Copyright (C) 2014-2016 Ian Lee &lt;ianlee1521@gmail.com&gt;</span>
<span class="s0">#</span>
<span class="s0"># Permission is hereby granted, free of charge, to any person</span>
<span class="s0"># obtaining a copy of this software and associated documentation files</span>
<span class="s0"># (the &quot;Software&quot;), to deal in the Software without restriction,</span>
<span class="s0"># including without limitation the rights to use, copy, modify, merge,</span>
<span class="s0"># publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="s0"># and to permit persons to whom the Software is furnished to do so,</span>
<span class="s0"># subject to the following conditions:</span>
<span class="s0">#</span>
<span class="s0"># The above copyright notice and this permission notice shall be</span>
<span class="s0"># included in all copies or substantial portions of the Software.</span>
<span class="s0">#</span>
<span class="s0"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="s0"># EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="s0"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="s0"># NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="s0"># BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="s0"># ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="s0"># CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="s0"># SOFTWARE.</span>

<span class="s2">r&quot;&quot;&quot; 
Check Python source code formatting, according to PEP 8. 
 
For usage and a list of options, try this: 
$ python pycodestyle.py -h 
 
This program and its regression test suite live here: 
https://github.com/pycqa/pycodestyle 
 
Groups of errors and warnings: 
E errors 
W warnings 
100 indentation 
200 whitespace 
300 blank lines 
400 imports 
500 line length 
600 deprecation 
700 statements 
900 syntax error 
&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">with_statement</span>

<span class="s3">import </span><span class="s1">inspect</span>
<span class="s3">import </span><span class="s1">keyword</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">re</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">import </span><span class="s1">tokenize</span>
<span class="s3">import </span><span class="s1">warnings</span>

<span class="s3">from </span><span class="s1">fnmatch </span><span class="s3">import </span><span class="s1">fnmatch</span>
<span class="s3">from </span><span class="s1">optparse </span><span class="s3">import </span><span class="s1">OptionParser</span>

<span class="s3">try</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s1">configparser </span><span class="s3">import </span><span class="s1">RawConfigParser</span>
    <span class="s3">from </span><span class="s1">io </span><span class="s3">import </span><span class="s1">TextIOWrapper</span>
<span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s1">ConfigParser </span><span class="s3">import </span><span class="s1">RawConfigParser</span>

<span class="s1">__version__ </span><span class="s4">= </span><span class="s5">'2.2.0'</span>

<span class="s1">DEFAULT_EXCLUDE </span><span class="s4">= </span><span class="s5">'.svn,CVS,.bzr,.hg,.git,__pycache__,.tox'</span>
<span class="s1">DEFAULT_IGNORE </span><span class="s4">= </span><span class="s5">'E121,E123,E126,E226,E24,E704,W503'</span>
<span class="s3">try</span><span class="s4">:</span>
    <span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">platform </span><span class="s4">== </span><span class="s5">'win32'</span><span class="s4">:</span>
        <span class="s1">USER_CONFIG </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">expanduser</span><span class="s4">(</span><span class="s5">r'~\.pycodestyle'</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">USER_CONFIG </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
            <span class="s1">os</span><span class="s4">.</span><span class="s1">getenv</span><span class="s4">(</span><span class="s5">'XDG_CONFIG_HOME'</span><span class="s4">) </span><span class="s3">or </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">expanduser</span><span class="s4">(</span><span class="s5">'~/.config'</span><span class="s4">),</span>
            <span class="s5">'pycodestyle'</span>
        <span class="s4">)</span>
<span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
    <span class="s1">USER_CONFIG </span><span class="s4">= </span><span class="s3">None</span>

<span class="s1">PROJECT_CONFIG </span><span class="s4">= (</span><span class="s5">'setup.cfg'</span><span class="s4">, </span><span class="s5">'tox.ini'</span><span class="s4">)</span>
<span class="s1">TESTSUITE_PATH </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">dirname</span><span class="s4">(</span><span class="s1">__file__</span><span class="s4">), </span><span class="s5">'testsuite'</span><span class="s4">)</span>
<span class="s1">MAX_LINE_LENGTH </span><span class="s4">= </span><span class="s6">79</span>
<span class="s1">REPORT_FORMAT </span><span class="s4">= {</span>
    <span class="s5">'default'</span><span class="s4">: </span><span class="s5">'%(path)s:%(row)d:%(col)d: %(code)s %(text)s'</span><span class="s4">,</span>
    <span class="s5">'pylint'</span><span class="s4">: </span><span class="s5">'%(path)s:%(row)d: [%(code)s] %(text)s'</span><span class="s4">,</span>
<span class="s4">}</span>

<span class="s1">PyCF_ONLY_AST </span><span class="s4">= </span><span class="s6">1024</span>
<span class="s1">SINGLETONS </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s4">([</span><span class="s5">'False'</span><span class="s4">, </span><span class="s5">'None'</span><span class="s4">, </span><span class="s5">'True'</span><span class="s4">])</span>
<span class="s1">KEYWORDS </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s4">(</span><span class="s1">keyword</span><span class="s4">.</span><span class="s1">kwlist </span><span class="s4">+ [</span><span class="s5">'print'</span><span class="s4">]) - </span><span class="s1">SINGLETONS</span>
<span class="s1">UNARY_OPERATORS </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s4">([</span><span class="s5">'&gt;&gt;'</span><span class="s4">, </span><span class="s5">'**'</span><span class="s4">, </span><span class="s5">'*'</span><span class="s4">, </span><span class="s5">'+'</span><span class="s4">, </span><span class="s5">'-'</span><span class="s4">])</span>
<span class="s1">ARITHMETIC_OP </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s4">([</span><span class="s5">'**'</span><span class="s4">, </span><span class="s5">'*'</span><span class="s4">, </span><span class="s5">'/'</span><span class="s4">, </span><span class="s5">'//'</span><span class="s4">, </span><span class="s5">'+'</span><span class="s4">, </span><span class="s5">'-'</span><span class="s4">])</span>
<span class="s1">WS_OPTIONAL_OPERATORS </span><span class="s4">= </span><span class="s1">ARITHMETIC_OP</span><span class="s4">.</span><span class="s1">union</span><span class="s4">([</span><span class="s5">'^'</span><span class="s4">, </span><span class="s5">'&amp;'</span><span class="s4">, </span><span class="s5">'|'</span><span class="s4">, </span><span class="s5">'&lt;&lt;'</span><span class="s4">, </span><span class="s5">'&gt;&gt;'</span><span class="s4">, </span><span class="s5">'%'</span><span class="s4">])</span>
<span class="s1">WS_NEEDED_OPERATORS </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s4">([</span>
    <span class="s5">'**='</span><span class="s4">, </span><span class="s5">'*='</span><span class="s4">, </span><span class="s5">'/='</span><span class="s4">, </span><span class="s5">'//='</span><span class="s4">, </span><span class="s5">'+='</span><span class="s4">, </span><span class="s5">'-='</span><span class="s4">, </span><span class="s5">'!='</span><span class="s4">, </span><span class="s5">'&lt;&gt;'</span><span class="s4">, </span><span class="s5">'&lt;'</span><span class="s4">, </span><span class="s5">'&gt;'</span><span class="s4">,</span>
    <span class="s5">'%='</span><span class="s4">, </span><span class="s5">'^='</span><span class="s4">, </span><span class="s5">'&amp;='</span><span class="s4">, </span><span class="s5">'|='</span><span class="s4">, </span><span class="s5">'=='</span><span class="s4">, </span><span class="s5">'&lt;='</span><span class="s4">, </span><span class="s5">'&gt;='</span><span class="s4">, </span><span class="s5">'&lt;&lt;='</span><span class="s4">, </span><span class="s5">'&gt;&gt;='</span><span class="s4">, </span><span class="s5">'='</span><span class="s4">])</span>
<span class="s1">WHITESPACE </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s4">(</span><span class="s5">' </span><span class="s3">\t</span><span class="s5">'</span><span class="s4">)</span>
<span class="s1">NEWLINE </span><span class="s4">= </span><span class="s1">frozenset</span><span class="s4">([</span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">NL</span><span class="s4">, </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">NEWLINE</span><span class="s4">])</span>
<span class="s1">SKIP_TOKENS </span><span class="s4">= </span><span class="s1">NEWLINE</span><span class="s4">.</span><span class="s1">union</span><span class="s4">([</span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">INDENT</span><span class="s4">, </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">DEDENT</span><span class="s4">])</span>
<span class="s0"># ERRORTOKEN is triggered by backticks in Python 3</span>
<span class="s1">SKIP_COMMENTS </span><span class="s4">= </span><span class="s1">SKIP_TOKENS</span><span class="s4">.</span><span class="s1">union</span><span class="s4">([</span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">, </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">ERRORTOKEN</span><span class="s4">])</span>
<span class="s1">BENCHMARK_KEYS </span><span class="s4">= [</span><span class="s5">'directories'</span><span class="s4">, </span><span class="s5">'files'</span><span class="s4">, </span><span class="s5">'logical lines'</span><span class="s4">, </span><span class="s5">'physical lines'</span><span class="s4">]</span>

<span class="s1">INDENT_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'([ \t]*)'</span><span class="s4">)</span>
<span class="s1">RAISE_COMMA_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'raise\s+\w+\s*,'</span><span class="s4">)</span>
<span class="s1">RERAISE_COMMA_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'raise\s+\w+\s*,.*,\s*\w+\s*$'</span><span class="s4">)</span>
<span class="s1">ERRORCODE_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'\b[A-Z]\d{3}\b'</span><span class="s4">)</span>
<span class="s1">DOCSTRING_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'u?r?[&quot;\']'</span><span class="s4">)</span>
<span class="s1">EXTRANEOUS_WHITESPACE_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'[[({] | []}),;:]'</span><span class="s4">)</span>
<span class="s1">WHITESPACE_AFTER_COMMA_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'[,;:]\s*(?:  |\t)'</span><span class="s4">)</span>
<span class="s1">COMPARE_SINGLETON_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'(\bNone|\bFalse|\bTrue)?\s*([=!]=)'</span>
                                     <span class="s5">r'\s*(?(1)|(None|False|True))\b'</span><span class="s4">)</span>
<span class="s1">COMPARE_NEGATIVE_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'\b(not)\s+[^][)(}{ ]+\s+(in|is)\s'</span><span class="s4">)</span>
<span class="s1">COMPARE_TYPE_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'(?:[=!]=|is(?:\s+not)?)\s*type(?:s.\w+Type'</span>
                                <span class="s5">r'|\s*\(\s*([^)]*[^ )])\s*\))'</span><span class="s4">)</span>
<span class="s1">KEYWORD_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'(\s*)\b(?:%s)\b(\s*)' </span><span class="s4">% </span><span class="s5">r'|'</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">KEYWORDS</span><span class="s4">))</span>
<span class="s1">OPERATOR_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'(?:[^,\s])(\s*)(?:[-+*/|!&lt;=&gt;%&amp;^]+)(\s*)'</span><span class="s4">)</span>
<span class="s1">LAMBDA_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'\blambda\b'</span><span class="s4">)</span>
<span class="s1">HUNK_REGEX </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'^@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@.*$'</span><span class="s4">)</span>

<span class="s0"># Work around Python &lt; 2.6 behavior, which does not generate NL after</span>
<span class="s0"># a comment which is on a line by itself.</span>
<span class="s1">COMMENT_WITH_NL </span><span class="s4">= </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">generate_tokens</span><span class="s4">([</span><span class="s5">'#</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">].</span><span class="s1">pop</span><span class="s4">).</span><span class="s1">send</span><span class="s4">(</span><span class="s3">None</span><span class="s4">)[</span><span class="s6">1</span><span class="s4">] == </span><span class="s5">'#</span><span class="s3">\n</span><span class="s5">'</span>


<span class="s0">##############################################################################</span>
<span class="s0"># Plugins (check functions) for physical lines</span>
<span class="s0">##############################################################################</span>


<span class="s3">def </span><span class="s1">tabs_or_spaces</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">, </span><span class="s1">indent_char</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Never mix tabs and spaces. 
 
    The most popular way of indenting Python is with spaces only.  The 
    second-most popular way is with tabs only.  Code indented with a mixture 
    of tabs and spaces should be converted to using spaces exclusively.  When 
    invoking the Python command line interpreter with the -t option, it issues 
    warnings about code that illegally mixes tabs and spaces.  When using -tt 
    these warnings become errors.  These options are highly recommended! 
 
    Okay: if a == 0:\n        a = 1\n        b = 1 
    E101: if a == 0:\n        a = 1\n\tb = 1 
    &quot;&quot;&quot;</span>
    <span class="s1">indent </span><span class="s4">= </span><span class="s1">INDENT_REGEX</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">).</span><span class="s1">group</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">char </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">indent</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">char </span><span class="s4">!= </span><span class="s1">indent_char</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">offset</span><span class="s4">, </span><span class="s5">&quot;E101 indentation contains mixed spaces and tabs&quot;</span>


<span class="s3">def </span><span class="s1">tabs_obsolete</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;For new projects, spaces-only are strongly recommended over tabs. 
 
    Okay: if True:\n    return 
    W191: if True:\n\treturn 
    &quot;&quot;&quot;</span>
    <span class="s1">indent </span><span class="s4">= </span><span class="s1">INDENT_REGEX</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">).</span><span class="s1">group</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">in </span><span class="s1">indent</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">indent</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\t</span><span class="s5">'</span><span class="s4">), </span><span class="s5">&quot;W191 indentation contains tabs&quot;</span>


<span class="s3">def </span><span class="s1">trailing_whitespace</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Trailing whitespace is superfluous. 
 
    The warning returned varies on whether the line itself is blank, for easier 
    filtering for those who want to indent their blank lines. 
 
    Okay: spam(1)\n# 
    W291: spam(1) \n# 
    W293: class Foo(object):\n    \n    bang = 12 
    &quot;&quot;&quot;</span>
    <span class="s1">physical_line </span><span class="s4">= </span><span class="s1">physical_line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)    </span><span class="s0"># chr(10), newline</span>
    <span class="s1">physical_line </span><span class="s4">= </span><span class="s1">physical_line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\r</span><span class="s5">'</span><span class="s4">)    </span><span class="s0"># chr(13), carriage return</span>
    <span class="s1">physical_line </span><span class="s4">= </span><span class="s1">physical_line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\x0c</span><span class="s5">'</span><span class="s4">)  </span><span class="s0"># chr(12), form feed, ^L</span>
    <span class="s1">stripped </span><span class="s4">= </span><span class="s1">physical_line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">' </span><span class="s3">\t\v</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">physical_line </span><span class="s4">!= </span><span class="s1">stripped</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">stripped</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">stripped</span><span class="s4">), </span><span class="s5">&quot;W291 trailing whitespace&quot;</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;W293 blank line contains whitespace&quot;</span>


<span class="s3">def </span><span class="s1">trailing_blank_lines</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">, </span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">total_lines</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Trailing blank lines are superfluous. 
 
    Okay: spam(1) 
    W391: spam(1)\n 
 
    However the last line should end with a new line (warning W292). 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">line_number </span><span class="s4">== </span><span class="s1">total_lines</span><span class="s4">:</span>
        <span class="s1">stripped_last_line </span><span class="s4">= </span><span class="s1">physical_line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">stripped_last_line</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;W391 blank line at end of file&quot;</span>
        <span class="s3">if </span><span class="s1">stripped_last_line </span><span class="s4">== </span><span class="s1">physical_line</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">), </span><span class="s5">&quot;W292 no newline at end of file&quot;</span>


<span class="s3">def </span><span class="s1">maximum_line_length</span><span class="s4">(</span><span class="s1">physical_line</span><span class="s4">, </span><span class="s1">max_line_length</span><span class="s4">, </span><span class="s1">multiline</span><span class="s4">, </span><span class="s1">noqa</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Limit all lines to a maximum of 79 characters. 
 
    There are still many devices around that are limited to 80 character 
    lines; plus, limiting windows to 80 characters makes it possible to have 
    several windows side-by-side.  The default wrapping on such devices looks 
    ugly.  Therefore, please limit all lines to a maximum of 79 characters. 
    For flowing long blocks of text (docstrings or comments), limiting the 
    length to 72 characters is recommended. 
 
    Reports error E501. 
    &quot;&quot;&quot;</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">physical_line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">()</span>
    <span class="s1">length </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">length </span><span class="s4">&gt; </span><span class="s1">max_line_length </span><span class="s3">and not </span><span class="s1">noqa</span><span class="s4">:</span>
        <span class="s0"># Special case for long URLs in multi-line docstrings or comments,</span>
        <span class="s0"># but still report the error when the 72 first chars are whitespaces.</span>
        <span class="s1">chunks </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">split</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s4">((</span><span class="s1">len</span><span class="s4">(</span><span class="s1">chunks</span><span class="s4">) == </span><span class="s6">1 </span><span class="s3">and </span><span class="s1">multiline</span><span class="s4">) </span><span class="s3">or</span>
            <span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">chunks</span><span class="s4">) == </span><span class="s6">2 </span><span class="s3">and </span><span class="s1">chunks</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">'#'</span><span class="s4">)) </span><span class="s3">and </span><span class="s1">\</span>
                <span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) - </span><span class="s1">len</span><span class="s4">(</span><span class="s1">chunks</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]) &lt; </span><span class="s1">max_line_length </span><span class="s4">- </span><span class="s6">7</span><span class="s4">:</span>
            <span class="s3">return</span>
        <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">line</span><span class="s4">, </span><span class="s5">'decode'</span><span class="s4">):   </span><span class="s0"># Python 2</span>
            <span class="s0"># The line could contain multi-byte characters</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">length </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">'utf-8'</span><span class="s4">))</span>
            <span class="s3">except </span><span class="s1">UnicodeError</span><span class="s4">:</span>
                <span class="s3">pass</span>
        <span class="s3">if </span><span class="s1">length </span><span class="s4">&gt; </span><span class="s1">max_line_length</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s1">max_line_length</span><span class="s4">, </span><span class="s5">&quot;E501 line too long &quot;</span>
                    <span class="s5">&quot;(%d &gt; %d characters)&quot; </span><span class="s4">% (</span><span class="s1">length</span><span class="s4">, </span><span class="s1">max_line_length</span><span class="s4">))</span>


<span class="s0">##############################################################################</span>
<span class="s0"># Plugins (check functions) for logical lines</span>
<span class="s0">##############################################################################</span>


<span class="s3">def </span><span class="s1">blank_lines</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">blank_lines</span><span class="s4">, </span><span class="s1">indent_level</span><span class="s4">, </span><span class="s1">line_number</span><span class="s4">,</span>
                <span class="s1">blank_before</span><span class="s4">, </span><span class="s1">previous_logical</span><span class="s4">,</span>
                <span class="s1">previous_unindented_logical_line</span><span class="s4">, </span><span class="s1">previous_indent_level</span><span class="s4">,</span>
                <span class="s1">lines</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Separate top-level function and class definitions with two blank lines. 
 
    Method definitions inside a class are separated by a single blank line. 
 
    Extra blank lines may be used (sparingly) to separate groups of related 
    functions.  Blank lines may be omitted between a bunch of related 
    one-liners (e.g. a set of dummy implementations). 
 
    Use blank lines in functions, sparingly, to indicate logical sections. 
 
    Okay: def a():\n    pass\n\n\ndef b():\n    pass 
    Okay: def a():\n    pass\n\n\nasync def b():\n    pass 
    Okay: def a():\n    pass\n\n\n# Foo\n# Bar\n\ndef b():\n    pass 
    Okay: default = 1\nfoo = 1 
    Okay: classify = 1\nfoo = 1 
 
    E301: class Foo:\n    b = 0\n    def bar():\n        pass 
    E302: def a():\n    pass\n\ndef b(n):\n    pass 
    E302: def a():\n    pass\n\nasync def b(n):\n    pass 
    E303: def a():\n    pass\n\n\n\ndef b(n):\n    pass 
    E303: def a():\n\n\n\n    pass 
    E304: @decorator\n\ndef a():\n    pass 
    E305: def a():\n    pass\na() 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">line_number </span><span class="s4">&lt; </span><span class="s6">3 </span><span class="s3">and not </span><span class="s1">previous_logical</span><span class="s4">:</span>
        <span class="s3">return  </span><span class="s0"># Don't expect blank lines before the first line</span>
    <span class="s3">if </span><span class="s1">previous_logical</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'@'</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">blank_lines</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E304 blank lines found after function decorator&quot;</span>
    <span class="s3">elif </span><span class="s1">blank_lines </span><span class="s4">&gt; </span><span class="s6">2 </span><span class="s3">or </span><span class="s4">(</span><span class="s1">indent_level </span><span class="s3">and </span><span class="s1">blank_lines </span><span class="s4">== </span><span class="s6">2</span><span class="s4">):</span>
        <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E303 too many blank lines (%d)&quot; </span><span class="s4">% </span><span class="s1">blank_lines</span>
    <span class="s3">elif </span><span class="s1">logical_line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">((</span><span class="s5">'def '</span><span class="s4">, </span><span class="s5">'async def'</span><span class="s4">, </span><span class="s5">'class '</span><span class="s4">, </span><span class="s5">'@'</span><span class="s4">)):</span>
        <span class="s3">if </span><span class="s1">indent_level</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s4">(</span><span class="s1">blank_before </span><span class="s3">or </span><span class="s1">previous_indent_level </span><span class="s4">&lt; </span><span class="s1">indent_level </span><span class="s3">or</span>
                    <span class="s1">DOCSTRING_REGEX</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">previous_logical</span><span class="s4">)):</span>
                <span class="s1">ancestor_level </span><span class="s4">= </span><span class="s1">indent_level</span>
                <span class="s1">nested </span><span class="s4">= </span><span class="s3">False</span>
                <span class="s0"># Search backwards for a def ancestor or tree root (top level).</span>
                <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">lines</span><span class="s4">[</span><span class="s1">line_number </span><span class="s4">- </span><span class="s6">2</span><span class="s4">::-</span><span class="s6">1</span><span class="s4">]:</span>
                    <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">() </span><span class="s3">and </span><span class="s1">expand_indent</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) &lt; </span><span class="s1">ancestor_level</span><span class="s4">:</span>
                        <span class="s1">ancestor_level </span><span class="s4">= </span><span class="s1">expand_indent</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>
                        <span class="s1">nested </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">lstrip</span><span class="s4">().</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'def '</span><span class="s4">)</span>
                        <span class="s3">if </span><span class="s1">nested </span><span class="s3">or </span><span class="s1">ancestor_level </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
                            <span class="s3">break</span>
                <span class="s3">if </span><span class="s1">nested</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E306 expected 1 blank line before a &quot; </span><span class="s1">\</span>
                        <span class="s5">&quot;nested definition, found 0&quot;</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E301 expected 1 blank line, found 0&quot;</span>
        <span class="s3">elif </span><span class="s1">blank_before </span><span class="s4">!= </span><span class="s6">2</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E302 expected 2 blank lines, found %d&quot; </span><span class="s4">% </span><span class="s1">blank_before</span>
    <span class="s3">elif </span><span class="s4">(</span><span class="s1">logical_line </span><span class="s3">and not </span><span class="s1">indent_level </span><span class="s3">and </span><span class="s1">blank_before </span><span class="s4">!= </span><span class="s6">2 </span><span class="s3">and</span>
          <span class="s1">previous_unindented_logical_line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">((</span><span class="s5">'def '</span><span class="s4">, </span><span class="s5">'class '</span><span class="s4">))):</span>
        <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E305 expected 2 blank lines after &quot; </span><span class="s1">\</span>
            <span class="s5">&quot;class or function definition, found %d&quot; </span><span class="s4">% </span><span class="s1">blank_before</span>


<span class="s3">def </span><span class="s1">extraneous_whitespace</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Avoid extraneous whitespace. 
 
    Avoid extraneous whitespace in these situations: 
    - Immediately inside parentheses, brackets or braces. 
    - Immediately before a comma, semicolon, or colon. 
 
    Okay: spam(ham[1], {eggs: 2}) 
    E201: spam( ham[1], {eggs: 2}) 
    E201: spam(ham[ 1], {eggs: 2}) 
    E201: spam(ham[1], { eggs: 2}) 
    E202: spam(ham[1], {eggs: 2} ) 
    E202: spam(ham[1 ], {eggs: 2}) 
    E202: spam(ham[1], {eggs: 2 }) 
 
    E203: if x == 4: print(x, y); x, y = y , x 
    E203: if x == 4: print(x, y); x, y = y, x 
    E203: if x == 4 : print(x, y); x, y = y, x 
    &quot;&quot;&quot;</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">logical_line</span>
    <span class="s3">for </span><span class="s1">match </span><span class="s3">in </span><span class="s1">EXTRANEOUS_WHITESPACE_REGEX</span><span class="s4">.</span><span class="s1">finditer</span><span class="s4">(</span><span class="s1">line</span><span class="s4">):</span>
        <span class="s1">text </span><span class="s4">= </span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">()</span>
        <span class="s1">char </span><span class="s4">= </span><span class="s1">text</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()</span>
        <span class="s1">found </span><span class="s4">= </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">text </span><span class="s4">== </span><span class="s1">char </span><span class="s4">+ </span><span class="s5">' '</span><span class="s4">:</span>
            <span class="s0"># assert char in '([{'</span>
            <span class="s3">yield </span><span class="s1">found </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">, </span><span class="s5">&quot;E201 whitespace after '%s'&quot; </span><span class="s4">% </span><span class="s1">char</span>
        <span class="s3">elif </span><span class="s1">line</span><span class="s4">[</span><span class="s1">found </span><span class="s4">- </span><span class="s6">1</span><span class="s4">] != </span><span class="s5">','</span><span class="s4">:</span>
            <span class="s1">code </span><span class="s4">= (</span><span class="s5">'E202' </span><span class="s3">if </span><span class="s1">char </span><span class="s3">in </span><span class="s5">'}])' </span><span class="s3">else </span><span class="s5">'E203'</span><span class="s4">)  </span><span class="s0"># if char in ',;:'</span>
            <span class="s3">yield </span><span class="s1">found</span><span class="s4">, </span><span class="s5">&quot;%s whitespace before '%s'&quot; </span><span class="s4">% (</span><span class="s1">code</span><span class="s4">, </span><span class="s1">char</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">whitespace_around_keywords</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Avoid extraneous whitespace around keywords. 
 
    Okay: True and False 
    E271: True and  False 
    E272: True  and False 
    E273: True and\tFalse 
    E274: True\tand False 
    &quot;&quot;&quot;</span>
    <span class="s3">for </span><span class="s1">match </span><span class="s3">in </span><span class="s1">KEYWORD_REGEX</span><span class="s4">.</span><span class="s1">finditer</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
        <span class="s1">before</span><span class="s4">, </span><span class="s1">after </span><span class="s4">= </span><span class="s1">match</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">in </span><span class="s1">before</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">1</span><span class="s4">), </span><span class="s5">&quot;E274 tab before keyword&quot;</span>
        <span class="s3">elif </span><span class="s1">len</span><span class="s4">(</span><span class="s1">before</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">1</span><span class="s4">), </span><span class="s5">&quot;E272 multiple spaces before keyword&quot;</span>

        <span class="s3">if </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">in </span><span class="s1">after</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">2</span><span class="s4">), </span><span class="s5">&quot;E273 tab after keyword&quot;</span>
        <span class="s3">elif </span><span class="s1">len</span><span class="s4">(</span><span class="s1">after</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">2</span><span class="s4">), </span><span class="s5">&quot;E271 multiple spaces after keyword&quot;</span>


<span class="s3">def </span><span class="s1">missing_whitespace_after_import_keyword</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Multiple imports in form from x import (a, b, c) should have space 
    between import statement and parenthesised name list. 
 
    Okay: from foo import (bar, baz) 
    E275: from foo import(bar, baz) 
    E275: from importable.module import(bar, baz) 
    &quot;&quot;&quot;</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">logical_line</span>
    <span class="s1">indicator </span><span class="s4">= </span><span class="s5">' import('</span>
    <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'from '</span><span class="s4">):</span>
        <span class="s1">found </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s1">indicator</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s4">-</span><span class="s6">1 </span><span class="s4">&lt; </span><span class="s1">found</span><span class="s4">:</span>
            <span class="s1">pos </span><span class="s4">= </span><span class="s1">found </span><span class="s4">+ </span><span class="s1">len</span><span class="s4">(</span><span class="s1">indicator</span><span class="s4">) - </span><span class="s6">1</span>
            <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;E275 missing whitespace after keyword&quot;</span>


<span class="s3">def </span><span class="s1">missing_whitespace</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Each comma, semicolon or colon should be followed by whitespace. 
 
    Okay: [a, b] 
    Okay: (3,) 
    Okay: a[1:4] 
    Okay: a[:4] 
    Okay: a[1:] 
    Okay: a[1:4:2] 
    E231: ['a','b'] 
    E231: foo(bar,baz) 
    E231: [{'a':'b'}] 
    &quot;&quot;&quot;</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">logical_line</span>
    <span class="s3">for </span><span class="s1">index </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) - </span><span class="s6">1</span><span class="s4">):</span>
        <span class="s1">char </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s1">index</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">char </span><span class="s3">in </span><span class="s5">',;:' </span><span class="s3">and </span><span class="s1">line</span><span class="s4">[</span><span class="s1">index </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">] </span><span class="s3">not in </span><span class="s1">WHITESPACE</span><span class="s4">:</span>
            <span class="s1">before </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[:</span><span class="s1">index</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">char </span><span class="s4">== </span><span class="s5">':' </span><span class="s3">and </span><span class="s1">before</span><span class="s4">.</span><span class="s1">count</span><span class="s4">(</span><span class="s5">'['</span><span class="s4">) &gt; </span><span class="s1">before</span><span class="s4">.</span><span class="s1">count</span><span class="s4">(</span><span class="s5">']'</span><span class="s4">) </span><span class="s3">and </span><span class="s1">\</span>
                    <span class="s1">before</span><span class="s4">.</span><span class="s1">rfind</span><span class="s4">(</span><span class="s5">'{'</span><span class="s4">) &lt; </span><span class="s1">before</span><span class="s4">.</span><span class="s1">rfind</span><span class="s4">(</span><span class="s5">'['</span><span class="s4">):</span>
                <span class="s3">continue  </span><span class="s0"># Slice syntax, no space required</span>
            <span class="s3">if </span><span class="s1">char </span><span class="s4">== </span><span class="s5">',' </span><span class="s3">and </span><span class="s1">line</span><span class="s4">[</span><span class="s1">index </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">] == </span><span class="s5">')'</span><span class="s4">:</span>
                <span class="s3">continue  </span><span class="s0"># Allow tuple with only one element: (3,)</span>
            <span class="s3">yield </span><span class="s1">index</span><span class="s4">, </span><span class="s5">&quot;E231 missing whitespace after '%s'&quot; </span><span class="s4">% </span><span class="s1">char</span>


<span class="s3">def </span><span class="s1">indentation</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">previous_logical</span><span class="s4">, </span><span class="s1">indent_char</span><span class="s4">,</span>
                <span class="s1">indent_level</span><span class="s4">, </span><span class="s1">previous_indent_level</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Use 4 spaces per indentation level. 
 
    For really old code that you don't want to mess up, you can continue to 
    use 8-space tabs. 
 
    Okay: a = 1 
    Okay: if a == 0:\n    a = 1 
    E111:   a = 1 
    E114:   # a = 1 
 
    Okay: for item in items:\n    pass 
    E112: for item in items:\npass 
    E115: for item in items:\n# Hi\n    pass 
 
    Okay: a = 1\nb = 2 
    E113: a = 1\n    b = 2 
    E116: a = 1\n    # b = 2 
    &quot;&quot;&quot;</span>
    <span class="s1">c </span><span class="s4">= </span><span class="s6">0 </span><span class="s3">if </span><span class="s1">logical_line </span><span class="s3">else </span><span class="s6">3</span>
    <span class="s1">tmpl </span><span class="s4">= </span><span class="s5">&quot;E11%d %s&quot; </span><span class="s3">if </span><span class="s1">logical_line </span><span class="s3">else </span><span class="s5">&quot;E11%d %s (comment)&quot;</span>
    <span class="s3">if </span><span class="s1">indent_level </span><span class="s4">% </span><span class="s6">4</span><span class="s4">:</span>
        <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s1">tmpl </span><span class="s4">% (</span><span class="s6">1 </span><span class="s4">+ </span><span class="s1">c</span><span class="s4">, </span><span class="s5">&quot;indentation is not a multiple of four&quot;</span><span class="s4">)</span>
    <span class="s1">indent_expect </span><span class="s4">= </span><span class="s1">previous_logical</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s5">':'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">indent_expect </span><span class="s3">and </span><span class="s1">indent_level </span><span class="s4">&lt;= </span><span class="s1">previous_indent_level</span><span class="s4">:</span>
        <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s1">tmpl </span><span class="s4">% (</span><span class="s6">2 </span><span class="s4">+ </span><span class="s1">c</span><span class="s4">, </span><span class="s5">&quot;expected an indented block&quot;</span><span class="s4">)</span>
    <span class="s3">elif not </span><span class="s1">indent_expect </span><span class="s3">and </span><span class="s1">indent_level </span><span class="s4">&gt; </span><span class="s1">previous_indent_level</span><span class="s4">:</span>
        <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s1">tmpl </span><span class="s4">% (</span><span class="s6">3 </span><span class="s4">+ </span><span class="s1">c</span><span class="s4">, </span><span class="s5">&quot;unexpected indentation&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">continued_indentation</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">, </span><span class="s1">indent_level</span><span class="s4">, </span><span class="s1">hang_closing</span><span class="s4">,</span>
                          <span class="s1">indent_char</span><span class="s4">, </span><span class="s1">noqa</span><span class="s4">, </span><span class="s1">verbose</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Continuation lines indentation. 
 
    Continuation lines should align wrapped elements either vertically 
    using Python's implicit line joining inside parentheses, brackets 
    and braces, or using a hanging indent. 
 
    When using a hanging indent these considerations should be applied: 
    - there should be no arguments on the first line, and 
    - further indentation should be used to clearly distinguish itself as a 
      continuation line. 
 
    Okay: a = (\n) 
    E123: a = (\n    ) 
 
    Okay: a = (\n    42) 
    E121: a = (\n   42) 
    E122: a = (\n42) 
    E123: a = (\n    42\n    ) 
    E124: a = (24,\n     42\n) 
    E125: if (\n    b):\n    pass 
    E126: a = (\n        42) 
    E127: a = (24,\n      42) 
    E128: a = (24,\n    42) 
    E129: if (a or\n    b):\n    pass 
    E131: a = (\n    42\n 24) 
    &quot;&quot;&quot;</span>
    <span class="s1">first_row </span><span class="s4">= </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s1">nrows </span><span class="s4">= </span><span class="s6">1 </span><span class="s4">+ </span><span class="s1">tokens</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">][</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] - </span><span class="s1">first_row</span>
    <span class="s3">if </span><span class="s1">noqa </span><span class="s3">or </span><span class="s1">nrows </span><span class="s4">== </span><span class="s6">1</span><span class="s4">:</span>
        <span class="s3">return</span>

    <span class="s0"># indent_next tells us whether the next block is indented; assuming</span>
    <span class="s0"># that it is indented by 4 spaces, then we should not allow 4-space</span>
    <span class="s0"># indents on the final continuation line; in turn, some other</span>
    <span class="s0"># indents are allowed to have an extra 4 spaces.</span>
    <span class="s1">indent_next </span><span class="s4">= </span><span class="s1">logical_line</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s5">':'</span><span class="s4">)</span>

    <span class="s1">row </span><span class="s4">= </span><span class="s1">depth </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">valid_hangs </span><span class="s4">= (</span><span class="s6">4</span><span class="s4">,) </span><span class="s3">if </span><span class="s1">indent_char </span><span class="s4">!= </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">else </span><span class="s4">(</span><span class="s6">4</span><span class="s4">, </span><span class="s6">8</span><span class="s4">)</span>
    <span class="s0"># remember how many brackets were opened on each line</span>
    <span class="s1">parens </span><span class="s4">= [</span><span class="s6">0</span><span class="s4">] * </span><span class="s1">nrows</span>
    <span class="s0"># relative indents of physical lines</span>
    <span class="s1">rel_indent </span><span class="s4">= [</span><span class="s6">0</span><span class="s4">] * </span><span class="s1">nrows</span>
    <span class="s0"># for each depth, collect a list of opening rows</span>
    <span class="s1">open_rows </span><span class="s4">= [[</span><span class="s6">0</span><span class="s4">]]</span>
    <span class="s0"># for each depth, memorize the hanging indentation</span>
    <span class="s1">hangs </span><span class="s4">= [</span><span class="s3">None</span><span class="s4">]</span>
    <span class="s0"># visual indents</span>
    <span class="s1">indent_chances </span><span class="s4">= {}</span>
    <span class="s1">last_indent </span><span class="s4">= </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">2</span><span class="s4">]</span>
    <span class="s1">visual_indent </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">last_token_multiline </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s0"># for each depth, memorize the visual indent column</span>
    <span class="s1">indent </span><span class="s4">= [</span><span class="s1">last_indent</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]]</span>
    <span class="s3">if </span><span class="s1">verbose </span><span class="s4">&gt;= </span><span class="s6">3</span><span class="s4">:</span>
        <span class="s1">print</span><span class="s4">(</span><span class="s5">&quot;&gt;&gt;&gt; &quot; </span><span class="s4">+ </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">4</span><span class="s4">].</span><span class="s1">rstrip</span><span class="s4">())</span>

    <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">:</span>

        <span class="s1">newline </span><span class="s4">= </span><span class="s1">row </span><span class="s4">&lt; </span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] - </span><span class="s1">first_row</span>
        <span class="s3">if </span><span class="s1">newline</span><span class="s4">:</span>
            <span class="s1">row </span><span class="s4">= </span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] - </span><span class="s1">first_row</span>
            <span class="s1">newline </span><span class="s4">= </span><span class="s3">not </span><span class="s1">last_token_multiline </span><span class="s3">and </span><span class="s1">token_type </span><span class="s3">not in </span><span class="s1">NEWLINE</span>

        <span class="s3">if </span><span class="s1">newline</span><span class="s4">:</span>
            <span class="s0"># this is the beginning of a continuation line.</span>
            <span class="s1">last_indent </span><span class="s4">= </span><span class="s1">start</span>
            <span class="s3">if </span><span class="s1">verbose </span><span class="s4">&gt;= </span><span class="s6">3</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">&quot;... &quot; </span><span class="s4">+ </span><span class="s1">line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">())</span>

            <span class="s0"># record the initial indent.</span>
            <span class="s1">rel_indent</span><span class="s4">[</span><span class="s1">row</span><span class="s4">] = </span><span class="s1">expand_indent</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) - </span><span class="s1">indent_level</span>

            <span class="s0"># identify closing bracket</span>
            <span class="s1">close_bracket </span><span class="s4">= (</span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP </span><span class="s3">and </span><span class="s1">text </span><span class="s3">in </span><span class="s5">']})'</span><span class="s4">)</span>

            <span class="s0"># is the indent relative to an opening bracket line?</span>
            <span class="s3">for </span><span class="s1">open_row </span><span class="s3">in </span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">open_rows</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]):</span>
                <span class="s1">hang </span><span class="s4">= </span><span class="s1">rel_indent</span><span class="s4">[</span><span class="s1">row</span><span class="s4">] - </span><span class="s1">rel_indent</span><span class="s4">[</span><span class="s1">open_row</span><span class="s4">]</span>
                <span class="s1">hanging_indent </span><span class="s4">= </span><span class="s1">hang </span><span class="s3">in </span><span class="s1">valid_hangs</span>
                <span class="s3">if </span><span class="s1">hanging_indent</span><span class="s4">:</span>
                    <span class="s3">break</span>
            <span class="s3">if </span><span class="s1">hangs</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]:</span>
                <span class="s1">hanging_indent </span><span class="s4">= (</span><span class="s1">hang </span><span class="s4">== </span><span class="s1">hangs</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">])</span>
            <span class="s0"># is there any chance of visual indent?</span>
            <span class="s1">visual_indent </span><span class="s4">= (</span><span class="s3">not </span><span class="s1">close_bracket </span><span class="s3">and </span><span class="s1">hang </span><span class="s4">&gt; </span><span class="s6">0 </span><span class="s3">and</span>
                             <span class="s1">indent_chances</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]))</span>

            <span class="s3">if </span><span class="s1">close_bracket </span><span class="s3">and </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]:</span>
                <span class="s0"># closing bracket for visual indent</span>
                <span class="s3">if </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] != </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]:</span>
                    <span class="s3">yield </span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E124 closing bracket does not match &quot;</span>
                           <span class="s5">&quot;visual indentation&quot;</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">close_bracket </span><span class="s3">and not </span><span class="s1">hang</span><span class="s4">:</span>
                <span class="s0"># closing bracket matches indentation of opening bracket's line</span>
                <span class="s3">if </span><span class="s1">hang_closing</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E133 closing bracket is missing indentation&quot;</span>
            <span class="s3">elif </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">] </span><span class="s3">and </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] &lt; </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]:</span>
                <span class="s3">if </span><span class="s1">visual_indent </span><span class="s3">is not True</span><span class="s4">:</span>
                    <span class="s0"># visual indent is broken</span>
                    <span class="s3">yield </span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E128 continuation line &quot;</span>
                           <span class="s5">&quot;under-indented for visual indent&quot;</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">hanging_indent </span><span class="s3">or </span><span class="s4">(</span><span class="s1">indent_next </span><span class="s3">and </span><span class="s1">rel_indent</span><span class="s4">[</span><span class="s1">row</span><span class="s4">] == </span><span class="s6">8</span><span class="s4">):</span>
                <span class="s0"># hanging indent is verified</span>
                <span class="s3">if </span><span class="s1">close_bracket </span><span class="s3">and not </span><span class="s1">hang_closing</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E123 closing bracket does not match &quot;</span>
                           <span class="s5">&quot;indentation of opening bracket's line&quot;</span><span class="s4">)</span>
                <span class="s1">hangs</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">] = </span><span class="s1">hang</span>
            <span class="s3">elif </span><span class="s1">visual_indent </span><span class="s3">is True</span><span class="s4">:</span>
                <span class="s0"># visual indent is verified</span>
                <span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">] = </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
            <span class="s3">elif </span><span class="s1">visual_indent </span><span class="s3">in </span><span class="s4">(</span><span class="s1">text</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
                <span class="s0"># ignore token lined up with matching one from a previous line</span>
                <span class="s3">pass</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s0"># indent is broken</span>
                <span class="s3">if </span><span class="s1">hang </span><span class="s4">&lt;= </span><span class="s6">0</span><span class="s4">:</span>
                    <span class="s1">error </span><span class="s4">= </span><span class="s5">&quot;E122&quot;</span><span class="s4">, </span><span class="s5">&quot;missing indentation or outdented&quot;</span>
                <span class="s3">elif </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]:</span>
                    <span class="s1">error </span><span class="s4">= </span><span class="s5">&quot;E127&quot;</span><span class="s4">, </span><span class="s5">&quot;over-indented for visual indent&quot;</span>
                <span class="s3">elif not </span><span class="s1">close_bracket </span><span class="s3">and </span><span class="s1">hangs</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]:</span>
                    <span class="s1">error </span><span class="s4">= </span><span class="s5">&quot;E131&quot;</span><span class="s4">, </span><span class="s5">&quot;unaligned for hanging indent&quot;</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">hangs</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">] = </span><span class="s1">hang</span>
                    <span class="s3">if </span><span class="s1">hang </span><span class="s4">&gt; </span><span class="s6">4</span><span class="s4">:</span>
                        <span class="s1">error </span><span class="s4">= </span><span class="s5">&quot;E126&quot;</span><span class="s4">, </span><span class="s5">&quot;over-indented for hanging indent&quot;</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">error </span><span class="s4">= </span><span class="s5">&quot;E121&quot;</span><span class="s4">, </span><span class="s5">&quot;under-indented for hanging indent&quot;</span>
                <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;%s continuation line %s&quot; </span><span class="s4">% </span><span class="s1">error</span>

        <span class="s0"># look for visual indenting</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s1">parens</span><span class="s4">[</span><span class="s1">row</span><span class="s4">] </span><span class="s3">and</span>
                <span class="s1">token_type </span><span class="s3">not in </span><span class="s4">(</span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">NL</span><span class="s4">, </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">) </span><span class="s3">and</span>
                <span class="s3">not </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]):</span>
            <span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">] = </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
            <span class="s1">indent_chances</span><span class="s4">[</span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]] = </span><span class="s3">True</span>
            <span class="s3">if </span><span class="s1">verbose </span><span class="s4">&gt;= </span><span class="s6">4</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">&quot;bracket depth %s indent to %s&quot; </span><span class="s4">% (</span><span class="s1">depth</span><span class="s4">, </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]))</span>
        <span class="s0"># deal with implicit string concatenation</span>
        <span class="s3">elif </span><span class="s4">(</span><span class="s1">token_type </span><span class="s3">in </span><span class="s4">(</span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">STRING</span><span class="s4">, </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">) </span><span class="s3">or</span>
              <span class="s1">text </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'u'</span><span class="s4">, </span><span class="s5">'ur'</span><span class="s4">, </span><span class="s5">'b'</span><span class="s4">, </span><span class="s5">'br'</span><span class="s4">)):</span>
            <span class="s1">indent_chances</span><span class="s4">[</span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]] = </span><span class="s1">str</span>
        <span class="s0"># special case for the &quot;if&quot; statement because len(&quot;if (&quot;) == 4</span>
        <span class="s3">elif not </span><span class="s1">indent_chances </span><span class="s3">and not </span><span class="s1">row </span><span class="s3">and not </span><span class="s1">depth </span><span class="s3">and </span><span class="s1">text </span><span class="s4">== </span><span class="s5">'if'</span><span class="s4">:</span>
            <span class="s1">indent_chances</span><span class="s4">[</span><span class="s1">end</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] + </span><span class="s6">1</span><span class="s4">] = </span><span class="s3">True</span>
        <span class="s3">elif </span><span class="s1">text </span><span class="s4">== </span><span class="s5">':' </span><span class="s3">and </span><span class="s1">line</span><span class="s4">[</span><span class="s1">end</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]:].</span><span class="s1">isspace</span><span class="s4">():</span>
            <span class="s1">open_rows</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s1">row</span><span class="s4">)</span>

        <span class="s0"># keep track of bracket depth</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s5">'([{'</span><span class="s4">:</span>
                <span class="s1">depth </span><span class="s4">+= </span><span class="s6">1</span>
                <span class="s1">indent</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
                <span class="s1">hangs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s3">None</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">open_rows</span><span class="s4">) == </span><span class="s1">depth</span><span class="s4">:</span>
                    <span class="s1">open_rows</span><span class="s4">.</span><span class="s1">append</span><span class="s4">([])</span>
                <span class="s1">open_rows</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s1">row</span><span class="s4">)</span>
                <span class="s1">parens</span><span class="s4">[</span><span class="s1">row</span><span class="s4">] += </span><span class="s6">1</span>
                <span class="s3">if </span><span class="s1">verbose </span><span class="s4">&gt;= </span><span class="s6">4</span><span class="s4">:</span>
                    <span class="s1">print</span><span class="s4">(</span><span class="s5">&quot;bracket depth %s seen, col %s, visual min = %s&quot; </span><span class="s4">%</span>
                          <span class="s4">(</span><span class="s1">depth</span><span class="s4">, </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]))</span>
            <span class="s3">elif </span><span class="s1">text </span><span class="s3">in </span><span class="s5">')]}' </span><span class="s3">and </span><span class="s1">depth </span><span class="s4">&gt; </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s0"># parent indents should not be more than this one</span>
                <span class="s1">prev_indent </span><span class="s4">= </span><span class="s1">indent</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">() </span><span class="s3">or </span><span class="s1">last_indent</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
                <span class="s1">hangs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">()</span>
                <span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">depth</span><span class="s4">):</span>
                    <span class="s3">if </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">d</span><span class="s4">] &gt; </span><span class="s1">prev_indent</span><span class="s4">:</span>
                        <span class="s1">indent</span><span class="s4">[</span><span class="s1">d</span><span class="s4">] = </span><span class="s6">0</span>
                <span class="s3">for </span><span class="s1">ind </span><span class="s3">in </span><span class="s1">list</span><span class="s4">(</span><span class="s1">indent_chances</span><span class="s4">):</span>
                    <span class="s3">if </span><span class="s1">ind </span><span class="s4">&gt;= </span><span class="s1">prev_indent</span><span class="s4">:</span>
                        <span class="s3">del </span><span class="s1">indent_chances</span><span class="s4">[</span><span class="s1">ind</span><span class="s4">]</span>
                <span class="s3">del </span><span class="s1">open_rows</span><span class="s4">[</span><span class="s1">depth </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">:]</span>
                <span class="s1">depth </span><span class="s4">-= </span><span class="s6">1</span>
                <span class="s3">if </span><span class="s1">depth</span><span class="s4">:</span>
                    <span class="s1">indent_chances</span><span class="s4">[</span><span class="s1">indent</span><span class="s4">[</span><span class="s1">depth</span><span class="s4">]] = </span><span class="s3">True</span>
                <span class="s3">for </span><span class="s1">idx </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">row</span><span class="s4">, -</span><span class="s6">1</span><span class="s4">, -</span><span class="s6">1</span><span class="s4">):</span>
                    <span class="s3">if </span><span class="s1">parens</span><span class="s4">[</span><span class="s1">idx</span><span class="s4">]:</span>
                        <span class="s1">parens</span><span class="s4">[</span><span class="s1">idx</span><span class="s4">] -= </span><span class="s6">1</span>
                        <span class="s3">break</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">indent</span><span class="s4">) == </span><span class="s1">depth </span><span class="s4">+ </span><span class="s6">1</span>
            <span class="s3">if </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] </span><span class="s3">not in </span><span class="s1">indent_chances</span><span class="s4">:</span>
                <span class="s0"># allow lining up tokens</span>
                <span class="s1">indent_chances</span><span class="s4">[</span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]] = </span><span class="s1">text</span>

        <span class="s1">last_token_multiline </span><span class="s4">= (</span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] != </span><span class="s1">end</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
        <span class="s3">if </span><span class="s1">last_token_multiline</span><span class="s4">:</span>
            <span class="s1">rel_indent</span><span class="s4">[</span><span class="s1">end</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] - </span><span class="s1">first_row</span><span class="s4">] = </span><span class="s1">rel_indent</span><span class="s4">[</span><span class="s1">row</span><span class="s4">]</span>

    <span class="s3">if </span><span class="s1">indent_next </span><span class="s3">and </span><span class="s1">expand_indent</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) == </span><span class="s1">indent_level </span><span class="s4">+ </span><span class="s6">4</span><span class="s4">:</span>
        <span class="s1">pos </span><span class="s4">= (</span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">indent</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] + </span><span class="s6">4</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">visual_indent</span><span class="s4">:</span>
            <span class="s1">code </span><span class="s4">= </span><span class="s5">&quot;E129 visually indented line&quot;</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">code </span><span class="s4">= </span><span class="s5">&quot;E125 continuation line&quot;</span>
        <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;%s with same indent as next logical line&quot; </span><span class="s4">% </span><span class="s1">code</span>


<span class="s3">def </span><span class="s1">whitespace_before_parameters</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Avoid extraneous whitespace. 
 
    Avoid extraneous whitespace in the following situations: 
    - before the open parenthesis that starts the argument list of a 
      function call. 
    - before the open parenthesis that starts an indexing or slicing. 
 
    Okay: spam(1) 
    E211: spam (1) 
 
    Okay: dict['key'] = list[index] 
    E211: dict ['key'] = list[index] 
    E211: dict['key'] = list [index] 
    &quot;&quot;&quot;</span>
    <span class="s1">prev_type</span><span class="s4">, </span><span class="s1">prev_text</span><span class="s4">, </span><span class="s1">__</span><span class="s4">, </span><span class="s1">prev_end</span><span class="s4">, </span><span class="s1">__ </span><span class="s4">= </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">index </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s6">1</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">tokens</span><span class="s4">)):</span>
        <span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">__ </span><span class="s4">= </span><span class="s1">tokens</span><span class="s4">[</span><span class="s1">index</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP </span><span class="s3">and</span>
            <span class="s1">text </span><span class="s3">in </span><span class="s5">'([' </span><span class="s3">and</span>
            <span class="s1">start </span><span class="s4">!= </span><span class="s1">prev_end </span><span class="s3">and</span>
            <span class="s4">(</span><span class="s1">prev_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">NAME </span><span class="s3">or </span><span class="s1">prev_text </span><span class="s3">in </span><span class="s5">'}])'</span><span class="s4">) </span><span class="s3">and</span>
            <span class="s0"># Syntax &quot;class A (B):&quot; is allowed, but avoid it</span>
            <span class="s4">(</span><span class="s1">index </span><span class="s4">&lt; </span><span class="s6">2 </span><span class="s3">or </span><span class="s1">tokens</span><span class="s4">[</span><span class="s1">index </span><span class="s4">- </span><span class="s6">2</span><span class="s4">][</span><span class="s6">1</span><span class="s4">] != </span><span class="s5">'class'</span><span class="s4">) </span><span class="s3">and</span>
                <span class="s0"># Allow &quot;return (a.foo for a in range(5))&quot;</span>
                <span class="s3">not </span><span class="s1">keyword</span><span class="s4">.</span><span class="s1">iskeyword</span><span class="s4">(</span><span class="s1">prev_text</span><span class="s4">)):</span>
            <span class="s3">yield </span><span class="s1">prev_end</span><span class="s4">, </span><span class="s5">&quot;E211 whitespace before '%s'&quot; </span><span class="s4">% </span><span class="s1">text</span>
        <span class="s1">prev_type </span><span class="s4">= </span><span class="s1">token_type</span>
        <span class="s1">prev_text </span><span class="s4">= </span><span class="s1">text</span>
        <span class="s1">prev_end </span><span class="s4">= </span><span class="s1">end</span>


<span class="s3">def </span><span class="s1">whitespace_around_operator</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Avoid extraneous whitespace around an operator. 
 
    Okay: a = 12 + 3 
    E221: a = 4  + 5 
    E222: a = 4 +  5 
    E223: a = 4\t+ 5 
    E224: a = 4 +\t5 
    &quot;&quot;&quot;</span>
    <span class="s3">for </span><span class="s1">match </span><span class="s3">in </span><span class="s1">OPERATOR_REGEX</span><span class="s4">.</span><span class="s1">finditer</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
        <span class="s1">before</span><span class="s4">, </span><span class="s1">after </span><span class="s4">= </span><span class="s1">match</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">in </span><span class="s1">before</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">1</span><span class="s4">), </span><span class="s5">&quot;E223 tab before operator&quot;</span>
        <span class="s3">elif </span><span class="s1">len</span><span class="s4">(</span><span class="s1">before</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">1</span><span class="s4">), </span><span class="s5">&quot;E221 multiple spaces before operator&quot;</span>

        <span class="s3">if </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">in </span><span class="s1">after</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">2</span><span class="s4">), </span><span class="s5">&quot;E224 tab after operator&quot;</span>
        <span class="s3">elif </span><span class="s1">len</span><span class="s4">(</span><span class="s1">after</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">2</span><span class="s4">), </span><span class="s5">&quot;E222 multiple spaces after operator&quot;</span>


<span class="s3">def </span><span class="s1">missing_whitespace_around_operator</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Surround operators with a single space on either side. 
 
    - Always surround these binary operators with a single space on 
      either side: assignment (=), augmented assignment (+=, -= etc.), 
      comparisons (==, &lt;, &gt;, !=, &lt;=, &gt;=, in, not in, is, is not), 
      Booleans (and, or, not). 
 
    - If operators with different priorities are used, consider adding 
      whitespace around the operators with the lowest priorities. 
 
    Okay: i = i + 1 
    Okay: submitted += 1 
    Okay: x = x * 2 - 1 
    Okay: hypot2 = x * x + y * y 
    Okay: c = (a + b) * (a - b) 
    Okay: foo(bar, key='word', *args, **kwargs) 
    Okay: alpha[:-i] 
 
    E225: i=i+1 
    E225: submitted +=1 
    E225: x = x /2 - 1 
    E225: z = x **y 
    E226: c = (a+b) * (a-b) 
    E226: hypot2 = x*x + y*y 
    E227: c = a|b 
    E228: msg = fmt%(errno, errmsg) 
    &quot;&quot;&quot;</span>
    <span class="s1">parens </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">need_space </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">prev_type </span><span class="s4">= </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP</span>
    <span class="s1">prev_text </span><span class="s4">= </span><span class="s1">prev_end </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s3">in </span><span class="s1">SKIP_COMMENTS</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'('</span><span class="s4">, </span><span class="s5">'lambda'</span><span class="s4">):</span>
            <span class="s1">parens </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">elif </span><span class="s1">text </span><span class="s4">== </span><span class="s5">')'</span><span class="s4">:</span>
            <span class="s1">parens </span><span class="s4">-= </span><span class="s6">1</span>
        <span class="s3">if </span><span class="s1">need_space</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">start </span><span class="s4">!= </span><span class="s1">prev_end</span><span class="s4">:</span>
                <span class="s0"># Found a (probably) needed space</span>
                <span class="s3">if </span><span class="s1">need_space </span><span class="s3">is not True and not </span><span class="s1">need_space</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]:</span>
                    <span class="s3">yield </span><span class="s4">(</span><span class="s1">need_space</span><span class="s4">[</span><span class="s6">0</span><span class="s4">],</span>
                           <span class="s5">&quot;E225 missing whitespace around operator&quot;</span><span class="s4">)</span>
                <span class="s1">need_space </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s3">elif </span><span class="s1">text </span><span class="s4">== </span><span class="s5">'&gt;' </span><span class="s3">and </span><span class="s1">prev_text </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'&lt;'</span><span class="s4">, </span><span class="s5">'-'</span><span class="s4">):</span>
                <span class="s0"># Tolerate the &quot;&lt;&gt;&quot; operator, even if running Python 3</span>
                <span class="s0"># Deal with Python 3's annotated return value &quot;-&gt;&quot;</span>
                <span class="s3">pass</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">need_space </span><span class="s3">is True or </span><span class="s1">need_space</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]:</span>
                    <span class="s0"># A needed trailing space was not found</span>
                    <span class="s3">yield </span><span class="s1">prev_end</span><span class="s4">, </span><span class="s5">&quot;E225 missing whitespace around operator&quot;</span>
                <span class="s3">elif </span><span class="s1">prev_text </span><span class="s4">!= </span><span class="s5">'**'</span><span class="s4">:</span>
                    <span class="s1">code</span><span class="s4">, </span><span class="s1">optype </span><span class="s4">= </span><span class="s5">'E226'</span><span class="s4">, </span><span class="s5">'arithmetic'</span>
                    <span class="s3">if </span><span class="s1">prev_text </span><span class="s4">== </span><span class="s5">'%'</span><span class="s4">:</span>
                        <span class="s1">code</span><span class="s4">, </span><span class="s1">optype </span><span class="s4">= </span><span class="s5">'E228'</span><span class="s4">, </span><span class="s5">'modulo'</span>
                    <span class="s3">elif </span><span class="s1">prev_text </span><span class="s3">not in </span><span class="s1">ARITHMETIC_OP</span><span class="s4">:</span>
                        <span class="s1">code</span><span class="s4">, </span><span class="s1">optype </span><span class="s4">= </span><span class="s5">'E227'</span><span class="s4">, </span><span class="s5">'bitwise or shift'</span>
                    <span class="s3">yield </span><span class="s4">(</span><span class="s1">need_space</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s5">&quot;%s missing whitespace &quot;</span>
                           <span class="s5">&quot;around %s operator&quot; </span><span class="s4">% (</span><span class="s1">code</span><span class="s4">, </span><span class="s1">optype</span><span class="s4">))</span>
                <span class="s1">need_space </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s3">elif </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP </span><span class="s3">and </span><span class="s1">prev_end </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">text </span><span class="s4">== </span><span class="s5">'=' </span><span class="s3">and </span><span class="s1">parens</span><span class="s4">:</span>
                <span class="s0"># Allow keyword args or defaults: foo(bar=None).</span>
                <span class="s3">pass</span>
            <span class="s3">elif </span><span class="s1">text </span><span class="s3">in </span><span class="s1">WS_NEEDED_OPERATORS</span><span class="s4">:</span>
                <span class="s1">need_space </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s3">elif </span><span class="s1">text </span><span class="s3">in </span><span class="s1">UNARY_OPERATORS</span><span class="s4">:</span>
                <span class="s0"># Check if the operator is being used as a binary operator</span>
                <span class="s0"># Allow unary operators: -123, -x, +1.</span>
                <span class="s0"># Allow argument unpacking: foo(*args, **kwargs).</span>
                <span class="s3">if </span><span class="s4">(</span><span class="s1">prev_text </span><span class="s3">in </span><span class="s5">'}])' </span><span class="s3">if </span><span class="s1">prev_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP</span>
                        <span class="s3">else </span><span class="s1">prev_text </span><span class="s3">not in </span><span class="s1">KEYWORDS</span><span class="s4">):</span>
                    <span class="s1">need_space </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s3">elif </span><span class="s1">text </span><span class="s3">in </span><span class="s1">WS_OPTIONAL_OPERATORS</span><span class="s4">:</span>
                <span class="s1">need_space </span><span class="s4">= </span><span class="s3">None</span>

            <span class="s3">if </span><span class="s1">need_space </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s0"># Surrounding space is optional, but ensure that</span>
                <span class="s0"># trailing space matches opening space</span>
                <span class="s1">need_space </span><span class="s4">= (</span><span class="s1">prev_end</span><span class="s4">, </span><span class="s1">start </span><span class="s4">!= </span><span class="s1">prev_end</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">need_space </span><span class="s3">and </span><span class="s1">start </span><span class="s4">== </span><span class="s1">prev_end</span><span class="s4">:</span>
                <span class="s0"># A needed opening space was not found</span>
                <span class="s3">yield </span><span class="s1">prev_end</span><span class="s4">, </span><span class="s5">&quot;E225 missing whitespace around operator&quot;</span>
                <span class="s1">need_space </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">prev_type </span><span class="s4">= </span><span class="s1">token_type</span>
        <span class="s1">prev_text </span><span class="s4">= </span><span class="s1">text</span>
        <span class="s1">prev_end </span><span class="s4">= </span><span class="s1">end</span>


<span class="s3">def </span><span class="s1">whitespace_around_comma</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Avoid extraneous whitespace after a comma or a colon. 
 
    Note: these checks are disabled by default 
 
    Okay: a = (1, 2) 
    E241: a = (1,  2) 
    E242: a = (1,\t2) 
    &quot;&quot;&quot;</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">logical_line</span>
    <span class="s3">for </span><span class="s1">m </span><span class="s3">in </span><span class="s1">WHITESPACE_AFTER_COMMA_REGEX</span><span class="s4">.</span><span class="s1">finditer</span><span class="s4">(</span><span class="s1">line</span><span class="s4">):</span>
        <span class="s1">found </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">start</span><span class="s4">() + </span><span class="s6">1</span>
        <span class="s3">if </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">in </span><span class="s1">m</span><span class="s4">.</span><span class="s1">group</span><span class="s4">():</span>
            <span class="s3">yield </span><span class="s1">found</span><span class="s4">, </span><span class="s5">&quot;E242 tab after '%s'&quot; </span><span class="s4">% </span><span class="s1">m</span><span class="s4">.</span><span class="s1">group</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">found</span><span class="s4">, </span><span class="s5">&quot;E241 multiple spaces after '%s'&quot; </span><span class="s4">% </span><span class="s1">m</span><span class="s4">.</span><span class="s1">group</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>


<span class="s3">def </span><span class="s1">whitespace_around_named_parameter_equals</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Don't use spaces around the '=' sign in function arguments. 
 
    Don't use spaces around the '=' sign when used to indicate a 
    keyword argument or a default parameter value. 
 
    Okay: def complex(real, imag=0.0): 
    Okay: return magic(r=real, i=imag) 
    Okay: boolean(a == b) 
    Okay: boolean(a != b) 
    Okay: boolean(a &lt;= b) 
    Okay: boolean(a &gt;= b) 
    Okay: def foo(arg: int = 42): 
    Okay: async def foo(arg: int = 42): 
 
    E251: def complex(real, imag = 0.0): 
    E251: return magic(r = real, i = imag) 
    &quot;&quot;&quot;</span>
    <span class="s1">parens </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">no_space </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">prev_end </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">annotated_func_arg </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">in_def </span><span class="s4">= </span><span class="s1">logical_line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">((</span><span class="s5">'def'</span><span class="s4">, </span><span class="s5">'async def'</span><span class="s4">))</span>
    <span class="s1">message </span><span class="s4">= </span><span class="s5">&quot;E251 unexpected spaces around keyword / parameter equals&quot;</span>
    <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">NL</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s1">no_space</span><span class="s4">:</span>
            <span class="s1">no_space </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s3">if </span><span class="s1">start </span><span class="s4">!= </span><span class="s1">prev_end</span><span class="s4">:</span>
                <span class="s3">yield </span><span class="s4">(</span><span class="s1">prev_end</span><span class="s4">, </span><span class="s1">message</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s5">'(['</span><span class="s4">:</span>
                <span class="s1">parens </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">elif </span><span class="s1">text </span><span class="s3">in </span><span class="s5">')]'</span><span class="s4">:</span>
                <span class="s1">parens </span><span class="s4">-= </span><span class="s6">1</span>
            <span class="s3">elif </span><span class="s1">in_def </span><span class="s3">and </span><span class="s1">text </span><span class="s4">== </span><span class="s5">':' </span><span class="s3">and </span><span class="s1">parens </span><span class="s4">== </span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">annotated_func_arg </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s3">elif </span><span class="s1">parens </span><span class="s3">and </span><span class="s1">text </span><span class="s4">== </span><span class="s5">',' </span><span class="s3">and </span><span class="s1">parens </span><span class="s4">== </span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">annotated_func_arg </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s3">elif </span><span class="s1">parens </span><span class="s3">and </span><span class="s1">text </span><span class="s4">== </span><span class="s5">'=' </span><span class="s3">and not </span><span class="s1">annotated_func_arg</span><span class="s4">:</span>
                <span class="s1">no_space </span><span class="s4">= </span><span class="s3">True</span>
                <span class="s3">if </span><span class="s1">start </span><span class="s4">!= </span><span class="s1">prev_end</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s4">(</span><span class="s1">prev_end</span><span class="s4">, </span><span class="s1">message</span><span class="s4">)</span>
            <span class="s3">if not </span><span class="s1">parens</span><span class="s4">:</span>
                <span class="s1">annotated_func_arg </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s1">prev_end </span><span class="s4">= </span><span class="s1">end</span>


<span class="s3">def </span><span class="s1">whitespace_before_comment</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Separate inline comments by at least two spaces. 
 
    An inline comment is a comment on the same line as a statement.  Inline 
    comments should be separated by at least two spaces from the statement. 
    They should start with a # and a single space. 
 
    Each line of a block comment starts with a # and a single space 
    (unless it is indented text inside the comment). 
 
    Okay: x = x + 1  # Increment x 
    Okay: x = x + 1    # Increment x 
    Okay: # Block comment 
    E261: x = x + 1 # Increment x 
    E262: x = x + 1  #Increment x 
    E262: x = x + 1  #  Increment x 
    E265: #Block comment 
    E266: ### Block comment 
    &quot;&quot;&quot;</span>
    <span class="s1">prev_end </span><span class="s4">= (</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">:</span>
            <span class="s1">inline_comment </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[:</span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]].</span><span class="s1">strip</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">inline_comment</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">prev_end</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">and </span><span class="s1">start</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] &lt; </span><span class="s1">prev_end</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] + </span><span class="s6">2</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s4">(</span><span class="s1">prev_end</span><span class="s4">,</span>
                           <span class="s5">&quot;E261 at least two spaces before inline comment&quot;</span><span class="s4">)</span>
            <span class="s1">symbol</span><span class="s4">, </span><span class="s1">sp</span><span class="s4">, </span><span class="s1">comment </span><span class="s4">= </span><span class="s1">text</span><span class="s4">.</span><span class="s1">partition</span><span class="s4">(</span><span class="s5">' '</span><span class="s4">)</span>
            <span class="s1">bad_prefix </span><span class="s4">= </span><span class="s1">symbol </span><span class="s3">not in </span><span class="s5">'#:' </span><span class="s3">and </span><span class="s4">(</span><span class="s1">symbol</span><span class="s4">.</span><span class="s1">lstrip</span><span class="s4">(</span><span class="s5">'#'</span><span class="s4">)[:</span><span class="s6">1</span><span class="s4">] </span><span class="s3">or </span><span class="s5">'#'</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">inline_comment</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">bad_prefix </span><span class="s3">or </span><span class="s1">comment</span><span class="s4">[:</span><span class="s6">1</span><span class="s4">] </span><span class="s3">in </span><span class="s1">WHITESPACE</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E262 inline comment should start with '# '&quot;</span>
            <span class="s3">elif </span><span class="s1">bad_prefix </span><span class="s3">and </span><span class="s4">(</span><span class="s1">bad_prefix </span><span class="s4">!= </span><span class="s5">'!' </span><span class="s3">or </span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] &gt; </span><span class="s6">1</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s1">bad_prefix </span><span class="s4">!= </span><span class="s5">'#'</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E265 block comment should start with '# '&quot;</span>
                <span class="s3">elif </span><span class="s1">comment</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E266 too many leading '#' for block comment&quot;</span>
        <span class="s3">elif </span><span class="s1">token_type </span><span class="s4">!= </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">NL</span><span class="s4">:</span>
            <span class="s1">prev_end </span><span class="s4">= </span><span class="s1">end</span>


<span class="s3">def </span><span class="s1">imports_on_separate_lines</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Place imports on separate lines. 
 
    Okay: import os\nimport sys 
    E401: import sys, os 
 
    Okay: from subprocess import Popen, PIPE 
    Okay: from myclas import MyClass 
    Okay: from foo.bar.yourclass import YourClass 
    Okay: import myclass 
    Okay: import foo.bar.yourclass 
    &quot;&quot;&quot;</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">logical_line</span>
    <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'import '</span><span class="s4">):</span>
        <span class="s1">found </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">','</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s4">-</span><span class="s6">1 </span><span class="s4">&lt; </span><span class="s1">found </span><span class="s3">and </span><span class="s5">';' </span><span class="s3">not in </span><span class="s1">line</span><span class="s4">[:</span><span class="s1">found</span><span class="s4">]:</span>
            <span class="s3">yield </span><span class="s1">found</span><span class="s4">, </span><span class="s5">&quot;E401 multiple imports on one line&quot;</span>


<span class="s3">def </span><span class="s1">module_imports_on_top_of_file</span><span class="s4">(</span>
        <span class="s1">logical_line</span><span class="s4">, </span><span class="s1">indent_level</span><span class="s4">, </span><span class="s1">checker_state</span><span class="s4">, </span><span class="s1">noqa</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Place imports at the top of the file. 
 
    Always put imports at the top of the file, just after any module comments 
    and docstrings, and before module globals and constants. 
 
    Okay: import os 
    Okay: # this is a comment\nimport os 
    Okay: '''this is a module docstring'''\nimport os 
    Okay: r'''this is a module docstring'''\nimport os 
    Okay: try:\n    import x\nexcept:\n    pass\nelse:\n    pass\nimport y 
    Okay: try:\n    import x\nexcept:\n    pass\nfinally:\n    pass\nimport y 
    E402: a=1\nimport os 
    E402: 'One string'\n&quot;Two string&quot;\nimport os 
    E402: a=1\nfrom sys import x 
 
    Okay: if x:\n    import os 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">is_string_literal</span><span class="s4">(</span><span class="s1">line</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">in </span><span class="s5">'uUbB'</span><span class="s4">:</span>
            <span class="s1">line </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]</span>
        <span class="s3">if </span><span class="s1">line </span><span class="s3">and </span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">in </span><span class="s5">'rR'</span><span class="s4">:</span>
            <span class="s1">line </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]</span>
        <span class="s3">return </span><span class="s1">line </span><span class="s3">and </span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">'&quot;' </span><span class="s3">or </span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;'&quot;</span><span class="s4">)</span>

    <span class="s1">allowed_try_keywords </span><span class="s4">= (</span><span class="s5">'try'</span><span class="s4">, </span><span class="s5">'except'</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, </span><span class="s5">'finally'</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">indent_level</span><span class="s4">:  </span><span class="s0"># Allow imports in conditional statements or functions</span>
        <span class="s3">return</span>
    <span class="s3">if not </span><span class="s1">logical_line</span><span class="s4">:  </span><span class="s0"># Allow empty lines or comments</span>
        <span class="s3">return</span>
    <span class="s3">if </span><span class="s1">noqa</span><span class="s4">:</span>
        <span class="s3">return</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">logical_line</span>
    <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'import '</span><span class="s4">) </span><span class="s3">or </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'from '</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">checker_state</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'seen_non_imports'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
            <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E402 module level import not at top of file&quot;</span>
    <span class="s3">elif </span><span class="s1">any</span><span class="s4">(</span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s1">kw</span><span class="s4">) </span><span class="s3">for </span><span class="s1">kw </span><span class="s3">in </span><span class="s1">allowed_try_keywords</span><span class="s4">):</span>
        <span class="s0"># Allow try, except, else, finally keywords intermixed with imports in</span>
        <span class="s0"># order to support conditional importing</span>
        <span class="s3">return</span>
    <span class="s3">elif </span><span class="s1">is_string_literal</span><span class="s4">(</span><span class="s1">line</span><span class="s4">):</span>
        <span class="s0"># The first literal is a docstring, allow it. Otherwise, report error.</span>
        <span class="s3">if </span><span class="s1">checker_state</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'seen_docstring'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
            <span class="s1">checker_state</span><span class="s4">[</span><span class="s5">'seen_non_imports'</span><span class="s4">] = </span><span class="s3">True</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">checker_state</span><span class="s4">[</span><span class="s5">'seen_docstring'</span><span class="s4">] = </span><span class="s3">True</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">checker_state</span><span class="s4">[</span><span class="s5">'seen_non_imports'</span><span class="s4">] = </span><span class="s3">True</span>


<span class="s3">def </span><span class="s1">compound_statements</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Compound statements (on the same line) are generally discouraged. 
 
    While sometimes it's okay to put an if/for/while with a small body 
    on the same line, never do this for multi-clause statements. 
    Also avoid folding such long lines! 
 
    Always use a def statement instead of an assignment statement that 
    binds a lambda expression directly to a name. 
 
    Okay: if foo == 'blah':\n    do_blah_thing() 
    Okay: do_one() 
    Okay: do_two() 
    Okay: do_three() 
 
    E701: if foo == 'blah': do_blah_thing() 
    E701: for x in lst: total += x 
    E701: while t &lt; 10: t = delay() 
    E701: if foo == 'blah': do_blah_thing() 
    E701: else: do_non_blah_thing() 
    E701: try: something() 
    E701: finally: cleanup() 
    E701: if foo == 'blah': one(); two(); three() 
    E702: do_one(); do_two(); do_three() 
    E703: do_four();  # useless semicolon 
    E704: def f(x): return 2*x 
    E731: f = lambda x: 2*x 
    &quot;&quot;&quot;</span>
    <span class="s1">line </span><span class="s4">= </span><span class="s1">logical_line</span>
    <span class="s1">last_char </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) - </span><span class="s6">1</span>
    <span class="s1">found </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">':'</span><span class="s4">)</span>
    <span class="s1">prev_found </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">counts </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">((</span><span class="s1">char</span><span class="s4">, </span><span class="s6">0</span><span class="s4">) </span><span class="s3">for </span><span class="s1">char </span><span class="s3">in </span><span class="s5">'{}[]()'</span><span class="s4">)</span>
    <span class="s3">while </span><span class="s4">-</span><span class="s6">1 </span><span class="s4">&lt; </span><span class="s1">found </span><span class="s4">&lt; </span><span class="s1">last_char</span><span class="s4">:</span>
        <span class="s1">update_counts</span><span class="s4">(</span><span class="s1">line</span><span class="s4">[</span><span class="s1">prev_found</span><span class="s4">:</span><span class="s1">found</span><span class="s4">], </span><span class="s1">counts</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s4">((</span><span class="s1">counts</span><span class="s4">[</span><span class="s5">'{'</span><span class="s4">] &lt;= </span><span class="s1">counts</span><span class="s4">[</span><span class="s5">'}'</span><span class="s4">] </span><span class="s3">and   </span><span class="s0"># {'a': 1} (dict)</span>
             <span class="s1">counts</span><span class="s4">[</span><span class="s5">'['</span><span class="s4">] &lt;= </span><span class="s1">counts</span><span class="s4">[</span><span class="s5">']'</span><span class="s4">] </span><span class="s3">and   </span><span class="s0"># [1:2] (slice)</span>
             <span class="s1">counts</span><span class="s4">[</span><span class="s5">'('</span><span class="s4">] &lt;= </span><span class="s1">counts</span><span class="s4">[</span><span class="s5">')'</span><span class="s4">])):    </span><span class="s0"># (annotation)</span>
            <span class="s1">lambda_kw </span><span class="s4">= </span><span class="s1">LAMBDA_REGEX</span><span class="s4">.</span><span class="s1">search</span><span class="s4">(</span><span class="s1">line</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">found</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">lambda_kw</span><span class="s4">:</span>
                <span class="s1">before </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[:</span><span class="s1">lambda_kw</span><span class="s4">.</span><span class="s1">start</span><span class="s4">()].</span><span class="s1">rstrip</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">before</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">:] == </span><span class="s5">'=' </span><span class="s3">and </span><span class="s1">isidentifier</span><span class="s4">(</span><span class="s1">before</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">].</span><span class="s1">strip</span><span class="s4">()):</span>
                    <span class="s3">yield </span><span class="s6">0</span><span class="s4">, (</span><span class="s5">&quot;E731 do not assign a lambda expression, use a &quot;</span>
                              <span class="s5">&quot;def&quot;</span><span class="s4">)</span>
                <span class="s3">break</span>
            <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">'def '</span><span class="s4">):</span>
                <span class="s3">yield </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;E704 multiple statements on one line (def)&quot;</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">yield </span><span class="s1">found</span><span class="s4">, </span><span class="s5">&quot;E701 multiple statements on one line (colon)&quot;</span>
        <span class="s1">prev_found </span><span class="s4">= </span><span class="s1">found</span>
        <span class="s1">found </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">':'</span><span class="s4">, </span><span class="s1">found </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s1">found </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">';'</span><span class="s4">)</span>
    <span class="s3">while </span><span class="s4">-</span><span class="s6">1 </span><span class="s4">&lt; </span><span class="s1">found</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">found </span><span class="s4">&lt; </span><span class="s1">last_char</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">found</span><span class="s4">, </span><span class="s5">&quot;E702 multiple statements on one line (semicolon)&quot;</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">found</span><span class="s4">, </span><span class="s5">&quot;E703 statement ends with a semicolon&quot;</span>
        <span class="s1">found </span><span class="s4">= </span><span class="s1">line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">';'</span><span class="s4">, </span><span class="s1">found </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">explicit_line_join</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Avoid explicit line join between brackets. 
 
    The preferred way of wrapping long lines is by using Python's implied line 
    continuation inside parentheses, brackets and braces.  Long lines can be 
    broken over multiple lines by wrapping expressions in parentheses.  These 
    should be used in preference to using a backslash for line continuation. 
 
    E502: aaa = [123, \\n       123] 
    E502: aaa = (&quot;bbb &quot; \\n       &quot;ccc&quot;) 
 
    Okay: aaa = [123,\n       123] 
    Okay: aaa = (&quot;bbb &quot;\n       &quot;ccc&quot;) 
    Okay: aaa = &quot;bbb &quot; \\n    &quot;ccc&quot; 
    Okay: aaa = 123  # \\ 
    &quot;&quot;&quot;</span>
    <span class="s1">prev_start </span><span class="s4">= </span><span class="s1">prev_end </span><span class="s4">= </span><span class="s1">parens </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">comment </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">backslash </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">:</span>
            <span class="s1">comment </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">if </span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] != </span><span class="s1">prev_start </span><span class="s3">and </span><span class="s1">parens </span><span class="s3">and </span><span class="s1">backslash </span><span class="s3">and not </span><span class="s1">comment</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">backslash</span><span class="s4">, </span><span class="s5">&quot;E502 the backslash is redundant between brackets&quot;</span>
        <span class="s3">if </span><span class="s1">end</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] != </span><span class="s1">prev_end</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\r\n</span><span class="s5">'</span><span class="s4">).</span><span class="s1">endswith</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\\</span><span class="s5">'</span><span class="s4">):</span>
                <span class="s1">backslash </span><span class="s4">= (</span><span class="s1">end</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">.</span><span class="s1">splitlines</span><span class="s4">()[-</span><span class="s6">1</span><span class="s4">]) - </span><span class="s6">1</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">backslash </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">prev_start </span><span class="s4">= </span><span class="s1">prev_end </span><span class="s4">= </span><span class="s1">end</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">prev_start </span><span class="s4">= </span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s5">'([{'</span><span class="s4">:</span>
                <span class="s1">parens </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">elif </span><span class="s1">text </span><span class="s3">in </span><span class="s5">')]}'</span><span class="s4">:</span>
                <span class="s1">parens </span><span class="s4">-= </span><span class="s6">1</span>


<span class="s3">def </span><span class="s1">break_around_binary_operator</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot; 
    Avoid breaks before binary operators. 
 
    The preferred place to break around a binary operator is after the 
    operator, not before it. 
 
    W503: (width == 0\n + height == 0) 
    W503: (width == 0\n and height == 0) 
 
    Okay: (width == 0 +\n height == 0) 
    Okay: foo(\n    -x) 
    Okay: foo(x\n    []) 
    Okay: x = '''\n''' + '' 
    Okay: foo(x,\n    -y) 
    Okay: foo(x,  # comment\n    -y) 
    Okay: var = (1 &amp;\n       ~2) 
    Okay: var = (1 /\n       -2) 
    Okay: var = (1 +\n       -1 +\n       -2) 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">is_binary_operator</span><span class="s4">(</span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">):</span>
        <span class="s0"># The % character is strictly speaking a binary operator, but the</span>
        <span class="s0"># common usage seems to be to put it next to the format parameters,</span>
        <span class="s0"># after a line break.</span>
        <span class="s3">return </span><span class="s4">((</span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP </span><span class="s3">or </span><span class="s1">text </span><span class="s3">in </span><span class="s4">[</span><span class="s5">'and'</span><span class="s4">, </span><span class="s5">'or'</span><span class="s4">]) </span><span class="s3">and</span>
                <span class="s1">text </span><span class="s3">not in </span><span class="s5">&quot;()[]{},:.;@=%~&quot;</span><span class="s4">)</span>

    <span class="s1">line_break </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">unary_context </span><span class="s4">= </span><span class="s3">True</span>
    <span class="s0"># Previous non-newline token types and text</span>
    <span class="s1">previous_token_type </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">previous_text </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">:</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">' </span><span class="s3">in </span><span class="s1">text </span><span class="s3">or </span><span class="s5">'</span><span class="s3">\r</span><span class="s5">' </span><span class="s3">in </span><span class="s1">text</span><span class="s4">) </span><span class="s3">and </span><span class="s1">token_type </span><span class="s4">!= </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">STRING</span><span class="s4">:</span>
            <span class="s1">line_break </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s1">is_binary_operator</span><span class="s4">(</span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">) </span><span class="s3">and </span><span class="s1">line_break </span><span class="s3">and</span>
                    <span class="s3">not </span><span class="s1">unary_context </span><span class="s3">and</span>
                    <span class="s3">not </span><span class="s1">is_binary_operator</span><span class="s4">(</span><span class="s1">previous_token_type</span><span class="s4">,</span>
                                           <span class="s1">previous_text</span><span class="s4">)):</span>
                <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;W503 line break before binary operator&quot;</span>
            <span class="s1">unary_context </span><span class="s4">= </span><span class="s1">text </span><span class="s3">in </span><span class="s5">'([{,;'</span>
            <span class="s1">line_break </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s1">previous_token_type </span><span class="s4">= </span><span class="s1">token_type</span>
            <span class="s1">previous_text </span><span class="s4">= </span><span class="s1">text</span>


<span class="s3">def </span><span class="s1">comparison_to_singleton</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">noqa</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Comparison to singletons should use &quot;is&quot; or &quot;is not&quot;. 
 
    Comparisons to singletons like None should always be done 
    with &quot;is&quot; or &quot;is not&quot;, never the equality operators. 
 
    Okay: if arg is not None: 
    E711: if arg != None: 
    E711: if None == arg: 
    E712: if arg == True: 
    E712: if False == arg: 
 
    Also, beware of writing if x when you really mean if x is not None -- 
    e.g. when testing whether a variable or argument that defaults to None was 
    set to some other value.  The other value might have a type (such as a 
    container) that could be false in a boolean context! 
    &quot;&quot;&quot;</span>
    <span class="s1">match </span><span class="s4">= </span><span class="s3">not </span><span class="s1">noqa </span><span class="s3">and </span><span class="s1">COMPARE_SINGLETON_REGEX</span><span class="s4">.</span><span class="s1">search</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">match</span><span class="s4">:</span>
        <span class="s1">singleton </span><span class="s4">= </span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">1</span><span class="s4">) </span><span class="s3">or </span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">3</span><span class="s4">)</span>
        <span class="s1">same </span><span class="s4">= (</span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">2</span><span class="s4">) == </span><span class="s5">'=='</span><span class="s4">)</span>

        <span class="s1">msg </span><span class="s4">= </span><span class="s5">&quot;'if cond is %s:'&quot; </span><span class="s4">% ((</span><span class="s5">'' </span><span class="s3">if </span><span class="s1">same </span><span class="s3">else </span><span class="s5">'not '</span><span class="s4">) + </span><span class="s1">singleton</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">singleton </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'None'</span><span class="s4">,):</span>
            <span class="s1">code </span><span class="s4">= </span><span class="s5">'E711'</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">code </span><span class="s4">= </span><span class="s5">'E712'</span>
            <span class="s1">nonzero </span><span class="s4">= ((</span><span class="s1">singleton </span><span class="s4">== </span><span class="s5">'True' </span><span class="s3">and </span><span class="s1">same</span><span class="s4">) </span><span class="s3">or</span>
                       <span class="s4">(</span><span class="s1">singleton </span><span class="s4">== </span><span class="s5">'False' </span><span class="s3">and not </span><span class="s1">same</span><span class="s4">))</span>
            <span class="s1">msg </span><span class="s4">+= </span><span class="s5">&quot; or 'if %scond:'&quot; </span><span class="s4">% (</span><span class="s5">'' </span><span class="s3">if </span><span class="s1">nonzero </span><span class="s3">else </span><span class="s5">'not '</span><span class="s4">)</span>
        <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">2</span><span class="s4">), (</span><span class="s5">&quot;%s comparison to %s should be %s&quot; </span><span class="s4">%</span>
                               <span class="s4">(</span><span class="s1">code</span><span class="s4">, </span><span class="s1">singleton</span><span class="s4">, </span><span class="s1">msg</span><span class="s4">))</span>


<span class="s3">def </span><span class="s1">comparison_negative</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Negative comparison should be done using &quot;not in&quot; and &quot;is not&quot;. 
 
    Okay: if x not in y:\n    pass 
    Okay: assert (X in Y or X is Z) 
    Okay: if not (X in Y):\n    pass 
    Okay: zz = x is not y 
    E713: Z = not X in Y 
    E713: if not X.B in Y:\n    pass 
    E714: if not X is Y:\n    pass 
    E714: Z = not X.B is Y 
    &quot;&quot;&quot;</span>
    <span class="s1">match </span><span class="s4">= </span><span class="s1">COMPARE_NEGATIVE_REGEX</span><span class="s4">.</span><span class="s1">search</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">match</span><span class="s4">:</span>
        <span class="s1">pos </span><span class="s4">= </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">2</span><span class="s4">) == </span><span class="s5">'in'</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;E713 test for membership should be 'not in'&quot;</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;E714 test for object identity should be 'is not'&quot;</span>


<span class="s3">def </span><span class="s1">comparison_type</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">noqa</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Object type comparisons should always use isinstance(). 
 
    Do not compare types directly. 
 
    Okay: if isinstance(obj, int): 
    E721: if type(obj) is type(1): 
 
    When checking if an object is a string, keep in mind that it might be a 
    unicode string too! In Python 2.3, str and unicode have a common base 
    class, basestring, so you can do: 
 
    Okay: if isinstance(obj, basestring): 
    Okay: if type(a1) is type(b1): 
    &quot;&quot;&quot;</span>
    <span class="s1">match </span><span class="s4">= </span><span class="s1">COMPARE_TYPE_REGEX</span><span class="s4">.</span><span class="s1">search</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">match </span><span class="s3">and not </span><span class="s1">noqa</span><span class="s4">:</span>
        <span class="s1">inst </span><span class="s4">= </span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">inst </span><span class="s3">and </span><span class="s1">isidentifier</span><span class="s4">(</span><span class="s1">inst</span><span class="s4">) </span><span class="s3">and </span><span class="s1">inst </span><span class="s3">not in </span><span class="s1">SINGLETONS</span><span class="s4">:</span>
            <span class="s3">return  </span><span class="s0"># Allow comparison for types which are not obvious</span>
        <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">start</span><span class="s4">(), </span><span class="s5">&quot;E721 do not compare types, use 'isinstance()'&quot;</span>


<span class="s3">def </span><span class="s1">ambiguous_identifier</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">tokens</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Never use the characters 'l', 'O', or 'I' as variable names. 
 
    In some fonts, these characters are indistinguishable from the numerals 
    one and zero. When tempted to use 'l', use 'L' instead. 
 
    Okay: L = 0 
    Okay: o = 123 
    Okay: i = 42 
    E741: l = 0 
    E741: O = 123 
    E741: I = 42 
 
    Variables can be bound in several other contexts, including class and 
    function definitions, 'global' and 'nonlocal' statements, exception 
    handlers, and 'with' statements. 
 
    Okay: except AttributeError as o: 
    Okay: with lock as L: 
    E741: except AttributeError as O: 
    E741: with lock as l: 
    E741: global I 
    E741: nonlocal l 
    E742: class I(object): 
    E743: def l(x): 
    &quot;&quot;&quot;</span>
    <span class="s1">idents_to_avoid </span><span class="s4">= (</span><span class="s5">'l'</span><span class="s4">, </span><span class="s5">'O'</span><span class="s4">, </span><span class="s5">'I'</span><span class="s4">)</span>
    <span class="s1">prev_type</span><span class="s4">, </span><span class="s1">prev_text</span><span class="s4">, </span><span class="s1">prev_start</span><span class="s4">, </span><span class="s1">prev_end</span><span class="s4">, </span><span class="s1">__ </span><span class="s4">= </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]:</span>
        <span class="s1">ident </span><span class="s4">= </span><span class="s1">pos </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s0"># identifiers on the lhs of an assignment operator</span>
        <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP </span><span class="s3">and </span><span class="s5">'=' </span><span class="s3">in </span><span class="s1">text</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">prev_text </span><span class="s3">in </span><span class="s1">idents_to_avoid</span><span class="s4">:</span>
                <span class="s1">ident </span><span class="s4">= </span><span class="s1">prev_text</span>
                <span class="s1">pos </span><span class="s4">= </span><span class="s1">prev_start</span>
        <span class="s0"># identifiers bound to a value with 'as', 'global', or 'nonlocal'</span>
        <span class="s3">if </span><span class="s1">prev_text </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'as'</span><span class="s4">, </span><span class="s5">'global'</span><span class="s4">, </span><span class="s5">'nonlocal'</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s1">idents_to_avoid</span><span class="s4">:</span>
                <span class="s1">ident </span><span class="s4">= </span><span class="s1">text</span>
                <span class="s1">pos </span><span class="s4">= </span><span class="s1">start</span>
        <span class="s3">if </span><span class="s1">prev_text </span><span class="s4">== </span><span class="s5">'class'</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s1">idents_to_avoid</span><span class="s4">:</span>
                <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E742 ambiguous class definition '%s'&quot; </span><span class="s4">% </span><span class="s1">text</span>
        <span class="s3">if </span><span class="s1">prev_text </span><span class="s4">== </span><span class="s5">'def'</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s1">idents_to_avoid</span><span class="s4">:</span>
                <span class="s3">yield </span><span class="s1">start</span><span class="s4">, </span><span class="s5">&quot;E743 ambiguous function definition '%s'&quot; </span><span class="s4">% </span><span class="s1">text</span>
        <span class="s3">if </span><span class="s1">ident</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;E741 ambiguous variable name '%s'&quot; </span><span class="s4">% </span><span class="s1">ident</span>
        <span class="s1">prev_text </span><span class="s4">= </span><span class="s1">text</span>
        <span class="s1">prev_start </span><span class="s4">= </span><span class="s1">start</span>


<span class="s3">def </span><span class="s1">python_3000_has_key</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">, </span><span class="s1">noqa</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;The {}.has_key() method is removed in Python 3: use the 'in' operator. 
 
    Okay: if &quot;alph&quot; in d:\n    print(d[&quot;alph&quot;]) 
    W601: assert d.has_key('alph') 
    &quot;&quot;&quot;</span>
    <span class="s1">pos </span><span class="s4">= </span><span class="s1">logical_line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">'.has_key('</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">pos </span><span class="s4">&gt; -</span><span class="s6">1 </span><span class="s3">and not </span><span class="s1">noqa</span><span class="s4">:</span>
        <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;W601 .has_key() is deprecated, use 'in'&quot;</span>


<span class="s3">def </span><span class="s1">python_3000_raise_comma</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;When raising an exception, use &quot;raise ValueError('message')&quot;. 
 
    The older form is removed in Python 3. 
 
    Okay: raise DummyError(&quot;Message&quot;) 
    W602: raise DummyError, &quot;Message&quot; 
    &quot;&quot;&quot;</span>
    <span class="s1">match </span><span class="s4">= </span><span class="s1">RAISE_COMMA_REGEX</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">match </span><span class="s3">and not </span><span class="s1">RERAISE_COMMA_REGEX</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
        <span class="s3">yield </span><span class="s1">match</span><span class="s4">.</span><span class="s1">end</span><span class="s4">() - </span><span class="s6">1</span><span class="s4">, </span><span class="s5">&quot;W602 deprecated form of raising exception&quot;</span>


<span class="s3">def </span><span class="s1">python_3000_not_equal</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;New code should always use != instead of &lt;&gt;. 
 
    The older syntax is removed in Python 3. 
 
    Okay: if a != 'no': 
    W603: if a &lt;&gt; 'no': 
    &quot;&quot;&quot;</span>
    <span class="s1">pos </span><span class="s4">= </span><span class="s1">logical_line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">'&lt;&gt;'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">pos </span><span class="s4">&gt; -</span><span class="s6">1</span><span class="s4">:</span>
        <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;W603 '&lt;&gt;' is deprecated, use '!='&quot;</span>


<span class="s3">def </span><span class="s1">python_3000_backticks</span><span class="s4">(</span><span class="s1">logical_line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Use repr() instead of backticks in Python 3. 
 
    Okay: val = repr(1 + 2) 
    W604: val = `1 + 2` 
    &quot;&quot;&quot;</span>
    <span class="s1">pos </span><span class="s4">= </span><span class="s1">logical_line</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">'`'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">pos </span><span class="s4">&gt; -</span><span class="s6">1</span><span class="s4">:</span>
        <span class="s3">yield </span><span class="s1">pos</span><span class="s4">, </span><span class="s5">&quot;W604 backticks are deprecated, use 'repr()'&quot;</span>


<span class="s0">##############################################################################</span>
<span class="s0"># Helper functions</span>
<span class="s0">##############################################################################</span>


<span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info </span><span class="s4">&lt; (</span><span class="s6">3</span><span class="s4">,):</span>
    <span class="s0"># Python 2: implicit encoding.</span>
    <span class="s3">def </span><span class="s1">readlines</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Read the source code.&quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'rU'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">f</span><span class="s4">.</span><span class="s1">readlines</span><span class="s4">()</span>
    <span class="s1">isidentifier </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'[a-zA-Z_]\w*$'</span><span class="s4">).</span><span class="s1">match</span>
    <span class="s1">stdin_get_value </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">stdin</span><span class="s4">.</span><span class="s1">read</span>
<span class="s3">else</span><span class="s4">:</span>
    <span class="s0"># Python 3</span>
    <span class="s3">def </span><span class="s1">readlines</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Read the source code.&quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'rb'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">coding</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">) = </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">detect_encoding</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">)</span>
                <span class="s1">f </span><span class="s4">= </span><span class="s1">TextIOWrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">coding</span><span class="s4">, </span><span class="s1">line_buffering</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
                <span class="s3">return </span><span class="s4">[</span><span class="s1">line</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s1">coding</span><span class="s4">) </span><span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">lines</span><span class="s4">] + </span><span class="s1">f</span><span class="s4">.</span><span class="s1">readlines</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">LookupError</span><span class="s4">, </span><span class="s1">SyntaxError</span><span class="s4">, </span><span class="s1">UnicodeError</span><span class="s4">):</span>
            <span class="s0"># Fall back if file encoding is improperly declared</span>
            <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'latin-1'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">f</span><span class="s4">.</span><span class="s1">readlines</span><span class="s4">()</span>
    <span class="s1">isidentifier </span><span class="s4">= </span><span class="s1">str</span><span class="s4">.</span><span class="s1">isidentifier</span>

    <span class="s3">def </span><span class="s1">stdin_get_value</span><span class="s4">():</span>
        <span class="s2">&quot;&quot;&quot;Read the value from stdin.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">TextIOWrapper</span><span class="s4">(</span><span class="s1">sys</span><span class="s4">.</span><span class="s1">stdin</span><span class="s4">.</span><span class="s1">buffer</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s5">'ignore'</span><span class="s4">).</span><span class="s1">read</span><span class="s4">()</span>

<span class="s1">noqa </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s5">r'# no(?:qa|pep8)\b'</span><span class="s4">, </span><span class="s1">re</span><span class="s4">.</span><span class="s1">I</span><span class="s4">).</span><span class="s1">search</span>


<span class="s3">def </span><span class="s1">expand_indent</span><span class="s4">(</span><span class="s1">line</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Return the amount of indentation. 
 
    Tabs are expanded to the next multiple of 8. 
 
    &gt;&gt;&gt; expand_indent('    ') 
    4 
    &gt;&gt;&gt; expand_indent('\t') 
    8 
    &gt;&gt;&gt; expand_indent('       \t') 
    8 
    &gt;&gt;&gt; expand_indent('        \t') 
    16 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">' </span><span class="s3">not in </span><span class="s1">line</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">) - </span><span class="s1">len</span><span class="s4">(</span><span class="s1">line</span><span class="s4">.</span><span class="s1">lstrip</span><span class="s4">())</span>
    <span class="s1">result </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s3">for </span><span class="s1">char </span><span class="s3">in </span><span class="s1">line</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">char </span><span class="s4">== </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">'</span><span class="s4">:</span>
            <span class="s1">result </span><span class="s4">= </span><span class="s1">result </span><span class="s4">// </span><span class="s6">8 </span><span class="s4">* </span><span class="s6">8 </span><span class="s4">+ </span><span class="s6">8</span>
        <span class="s3">elif </span><span class="s1">char </span><span class="s4">== </span><span class="s5">' '</span><span class="s4">:</span>
            <span class="s1">result </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">break</span>
    <span class="s3">return </span><span class="s1">result</span>


<span class="s3">def </span><span class="s1">mute_string</span><span class="s4">(</span><span class="s1">text</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Replace contents with 'xxx' to prevent syntax matching. 
 
    &gt;&gt;&gt; mute_string('&quot;abc&quot;') 
    '&quot;xxx&quot;' 
    &gt;&gt;&gt; mute_string(&quot;'''abc'''&quot;) 
    &quot;'''xxx'''&quot; 
    &gt;&gt;&gt; mute_string(&quot;r'abc'&quot;) 
    &quot;r'xxx'&quot; 
    &quot;&quot;&quot;</span>
    <span class="s0"># String modifiers (e.g. u or r)</span>
    <span class="s1">start </span><span class="s4">= </span><span class="s1">text</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s1">text</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]) + </span><span class="s6">1</span>
    <span class="s1">end </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">text</span><span class="s4">) - </span><span class="s6">1</span>
    <span class="s0"># Triple quotes</span>
    <span class="s3">if </span><span class="s1">text</span><span class="s4">[-</span><span class="s6">3</span><span class="s4">:] </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'&quot;&quot;&quot;'</span><span class="s4">, </span><span class="s5">&quot;'''&quot;</span><span class="s4">):</span>
        <span class="s1">start </span><span class="s4">+= </span><span class="s6">2</span>
        <span class="s1">end </span><span class="s4">-= </span><span class="s6">2</span>
    <span class="s3">return </span><span class="s1">text</span><span class="s4">[:</span><span class="s1">start</span><span class="s4">] + </span><span class="s5">'x' </span><span class="s4">* (</span><span class="s1">end </span><span class="s4">- </span><span class="s1">start</span><span class="s4">) + </span><span class="s1">text</span><span class="s4">[</span><span class="s1">end</span><span class="s4">:]</span>


<span class="s3">def </span><span class="s1">parse_udiff</span><span class="s4">(</span><span class="s1">diff</span><span class="s4">, </span><span class="s1">patterns</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">parent</span><span class="s4">=</span><span class="s5">'.'</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Return a dictionary of matching lines.&quot;&quot;&quot;</span>
    <span class="s0"># For each file of the diff, the entry key is the filename,</span>
    <span class="s0"># and the value is a set of row numbers to consider.</span>
    <span class="s1">rv </span><span class="s4">= {}</span>
    <span class="s1">path </span><span class="s4">= </span><span class="s1">nrows </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">diff</span><span class="s4">.</span><span class="s1">splitlines</span><span class="s4">():</span>
        <span class="s3">if </span><span class="s1">nrows</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">line</span><span class="s4">[:</span><span class="s6">1</span><span class="s4">] != </span><span class="s5">'-'</span><span class="s4">:</span>
                <span class="s1">nrows </span><span class="s4">-= </span><span class="s6">1</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s1">line</span><span class="s4">[:</span><span class="s6">3</span><span class="s4">] == </span><span class="s5">'@@ '</span><span class="s4">:</span>
            <span class="s1">hunk_match </span><span class="s4">= </span><span class="s1">HUNK_REGEX</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>
            <span class="s4">(</span><span class="s1">row</span><span class="s4">, </span><span class="s1">nrows</span><span class="s4">) = [</span><span class="s1">int</span><span class="s4">(</span><span class="s1">g </span><span class="s3">or </span><span class="s5">'1'</span><span class="s4">) </span><span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">hunk_match</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">()]</span>
            <span class="s1">rv</span><span class="s4">[</span><span class="s1">path</span><span class="s4">].</span><span class="s1">update</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">row</span><span class="s4">, </span><span class="s1">row </span><span class="s4">+ </span><span class="s1">nrows</span><span class="s4">))</span>
        <span class="s3">elif </span><span class="s1">line</span><span class="s4">[:</span><span class="s6">3</span><span class="s4">] == </span><span class="s5">'+++'</span><span class="s4">:</span>
            <span class="s1">path </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s6">4</span><span class="s4">:].</span><span class="s1">split</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\t</span><span class="s5">'</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">path</span><span class="s4">[:</span><span class="s6">2</span><span class="s4">] == </span><span class="s5">'b/'</span><span class="s4">:</span>
                <span class="s1">path </span><span class="s4">= </span><span class="s1">path</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:]</span>
            <span class="s1">rv</span><span class="s4">[</span><span class="s1">path</span><span class="s4">] = </span><span class="s1">set</span><span class="s4">()</span>
    <span class="s3">return </span><span class="s1">dict</span><span class="s4">([(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">parent</span><span class="s4">, </span><span class="s1">path</span><span class="s4">), </span><span class="s1">rows</span><span class="s4">)</span>
                 <span class="s3">for </span><span class="s4">(</span><span class="s1">path</span><span class="s4">, </span><span class="s1">rows</span><span class="s4">) </span><span class="s3">in </span><span class="s1">rv</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
                 <span class="s3">if </span><span class="s1">rows </span><span class="s3">and </span><span class="s1">filename_match</span><span class="s4">(</span><span class="s1">path</span><span class="s4">, </span><span class="s1">patterns</span><span class="s4">)])</span>


<span class="s3">def </span><span class="s1">normalize_paths</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">parent</span><span class="s4">=</span><span class="s1">os</span><span class="s4">.</span><span class="s1">curdir</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Parse a comma-separated list of paths. 
 
    Return a list of absolute paths. 
    &quot;&quot;&quot;</span>
    <span class="s3">if not </span><span class="s1">value</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">[]</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">list</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">value</span>
    <span class="s1">paths </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">path </span><span class="s3">in </span><span class="s1">value</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">','</span><span class="s4">):</span>
        <span class="s1">path </span><span class="s4">= </span><span class="s1">path</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s5">'/' </span><span class="s3">in </span><span class="s1">path</span><span class="s4">:</span>
            <span class="s1">path </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">abspath</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">parent</span><span class="s4">, </span><span class="s1">path</span><span class="s4">))</span>
        <span class="s1">paths</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">path</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">'/'</span><span class="s4">))</span>
    <span class="s3">return </span><span class="s1">paths</span>


<span class="s3">def </span><span class="s1">filename_match</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">patterns</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Check if patterns contains a pattern that matches filename. 
 
    If patterns is unspecified, this always returns True. 
    &quot;&quot;&quot;</span>
    <span class="s3">if not </span><span class="s1">patterns</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">default</span>
    <span class="s3">return </span><span class="s1">any</span><span class="s4">(</span><span class="s1">fnmatch</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">pattern</span><span class="s4">) </span><span class="s3">for </span><span class="s1">pattern </span><span class="s3">in </span><span class="s1">patterns</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">update_counts</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">counts</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Adds one to the counts of each appearance of characters in s, 
        for characters in counts&quot;&quot;&quot;</span>
    <span class="s3">for </span><span class="s1">char </span><span class="s3">in </span><span class="s1">s</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">char </span><span class="s3">in </span><span class="s1">counts</span><span class="s4">:</span>
            <span class="s1">counts</span><span class="s4">[</span><span class="s1">char</span><span class="s4">] += </span><span class="s6">1</span>


<span class="s3">def </span><span class="s1">_is_eol_token</span><span class="s4">(</span><span class="s1">token</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s1">token</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">in </span><span class="s1">NEWLINE </span><span class="s3">or </span><span class="s1">token</span><span class="s4">[</span><span class="s6">4</span><span class="s4">][</span><span class="s1">token</span><span class="s4">[</span><span class="s6">3</span><span class="s4">][</span><span class="s6">1</span><span class="s4">]:].</span><span class="s1">lstrip</span><span class="s4">() == </span><span class="s5">'</span><span class="s3">\\\n</span><span class="s5">'</span>


<span class="s3">if </span><span class="s1">COMMENT_WITH_NL</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">_is_eol_token</span><span class="s4">(</span><span class="s1">token</span><span class="s4">, </span><span class="s1">_eol_token</span><span class="s4">=</span><span class="s1">_is_eol_token</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">_eol_token</span><span class="s4">(</span><span class="s1">token</span><span class="s4">) </span><span class="s3">or </span><span class="s4">(</span><span class="s1">token</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT </span><span class="s3">and</span>
                                     <span class="s1">token</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] == </span><span class="s1">token</span><span class="s4">[</span><span class="s6">4</span><span class="s4">])</span>

<span class="s0">##############################################################################</span>
<span class="s0"># Framework to run all checks</span>
<span class="s0">##############################################################################</span>


<span class="s1">_checks </span><span class="s4">= {</span><span class="s5">'physical_line'</span><span class="s4">: {}, </span><span class="s5">'logical_line'</span><span class="s4">: {}, </span><span class="s5">'tree'</span><span class="s4">: {}}</span>


<span class="s3">def </span><span class="s1">_get_parameters</span><span class="s4">(</span><span class="s1">function</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info </span><span class="s4">&gt;= (</span><span class="s6">3</span><span class="s4">, </span><span class="s6">3</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">parameter</span><span class="s4">.</span><span class="s1">name</span>
                <span class="s3">for </span><span class="s1">parameter</span>
                <span class="s3">in </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">signature</span><span class="s4">(</span><span class="s1">function</span><span class="s4">).</span><span class="s1">parameters</span><span class="s4">.</span><span class="s1">values</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">parameter</span><span class="s4">.</span><span class="s1">kind </span><span class="s4">== </span><span class="s1">parameter</span><span class="s4">.</span><span class="s1">POSITIONAL_OR_KEYWORD</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">getargspec</span><span class="s4">(</span><span class="s1">function</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>


<span class="s3">def </span><span class="s1">register_check</span><span class="s4">(</span><span class="s1">check</span><span class="s4">, </span><span class="s1">codes</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Register a new check object.&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">_add_check</span><span class="s4">(</span><span class="s1">check</span><span class="s4">, </span><span class="s1">kind</span><span class="s4">, </span><span class="s1">codes</span><span class="s4">, </span><span class="s1">args</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">check </span><span class="s3">in </span><span class="s1">_checks</span><span class="s4">[</span><span class="s1">kind</span><span class="s4">]:</span>
            <span class="s1">_checks</span><span class="s4">[</span><span class="s1">kind</span><span class="s4">][</span><span class="s1">check</span><span class="s4">][</span><span class="s6">0</span><span class="s4">].</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">codes </span><span class="s3">or </span><span class="s4">[])</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">_checks</span><span class="s4">[</span><span class="s1">kind</span><span class="s4">][</span><span class="s1">check</span><span class="s4">] = (</span><span class="s1">codes </span><span class="s3">or </span><span class="s4">[</span><span class="s5">''</span><span class="s4">], </span><span class="s1">args</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">isfunction</span><span class="s4">(</span><span class="s1">check</span><span class="s4">):</span>
        <span class="s1">args </span><span class="s4">= </span><span class="s1">_get_parameters</span><span class="s4">(</span><span class="s1">check</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">args </span><span class="s3">and </span><span class="s1">args</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'physical_line'</span><span class="s4">, </span><span class="s5">'logical_line'</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">codes </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">codes </span><span class="s4">= </span><span class="s1">ERRORCODE_REGEX</span><span class="s4">.</span><span class="s1">findall</span><span class="s4">(</span><span class="s1">check</span><span class="s4">.</span><span class="s1">__doc__ </span><span class="s3">or </span><span class="s5">''</span><span class="s4">)</span>
            <span class="s1">_add_check</span><span class="s4">(</span><span class="s1">check</span><span class="s4">, </span><span class="s1">args</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">codes</span><span class="s4">, </span><span class="s1">args</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">isclass</span><span class="s4">(</span><span class="s1">check</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">_get_parameters</span><span class="s4">(</span><span class="s1">check</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">)[:</span><span class="s6">2</span><span class="s4">] == [</span><span class="s5">'self'</span><span class="s4">, </span><span class="s5">'tree'</span><span class="s4">]:</span>
            <span class="s1">_add_check</span><span class="s4">(</span><span class="s1">check</span><span class="s4">, </span><span class="s5">'tree'</span><span class="s4">, </span><span class="s1">codes</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">init_checks_registry</span><span class="s4">():</span>
    <span class="s2">&quot;&quot;&quot;Register all globally visible functions. 
 
    The first argument name is either 'physical_line' or 'logical_line'. 
    &quot;&quot;&quot;</span>
    <span class="s1">mod </span><span class="s4">= </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">getmodule</span><span class="s4">(</span><span class="s1">register_check</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">function</span><span class="s4">) </span><span class="s3">in </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">getmembers</span><span class="s4">(</span><span class="s1">mod</span><span class="s4">, </span><span class="s1">inspect</span><span class="s4">.</span><span class="s1">isfunction</span><span class="s4">):</span>
        <span class="s1">register_check</span><span class="s4">(</span><span class="s1">function</span><span class="s4">)</span>


<span class="s1">init_checks_registry</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">Checker</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Load a Python source file, tokenize it, check coding style.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
                 <span class="s1">options</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">report</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">options </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">options </span><span class="s4">= </span><span class="s1">StyleGuide</span><span class="s4">(</span><span class="s1">kwargs</span><span class="s4">).</span><span class="s1">options</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert not </span><span class="s1">kwargs</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_io_error </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_physical_checks </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">physical_checks</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_logical_checks </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">logical_checks</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_ast_checks </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">ast_checks</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">max_line_length </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">max_line_length</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">multiline </span><span class="s4">= </span><span class="s3">False  </span><span class="s0"># in a multiline string?</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">hang_closing </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">hang_closing</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">verbose </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">verbose</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">filename </span><span class="s4">= </span><span class="s1">filename</span>
        <span class="s0"># Dictionary where a checker can store its custom state.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_checker_states </span><span class="s4">= {}</span>
        <span class="s3">if </span><span class="s1">filename </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">filename </span><span class="s4">= </span><span class="s5">'stdin'</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">lines </span><span class="s4">= </span><span class="s1">lines </span><span class="s3">or </span><span class="s4">[]</span>
        <span class="s3">elif </span><span class="s1">filename </span><span class="s4">== </span><span class="s5">'-'</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">filename </span><span class="s4">= </span><span class="s5">'stdin'</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">lines </span><span class="s4">= </span><span class="s1">stdin_get_value</span><span class="s4">().</span><span class="s1">splitlines</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">lines </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">lines </span><span class="s4">= </span><span class="s1">readlines</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">IOError</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">exc_type</span><span class="s4">, </span><span class="s1">exc</span><span class="s4">) = </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">exc_info</span><span class="s4">()[:</span><span class="s6">2</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_io_error </span><span class="s4">= </span><span class="s5">'%s: %s' </span><span class="s4">% (</span><span class="s1">exc_type</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">, </span><span class="s1">exc</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">lines </span><span class="s4">= []</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">lines </span><span class="s4">= </span><span class="s1">lines</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">:</span>
            <span class="s1">ord0 </span><span class="s4">= </span><span class="s1">ord</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">0</span><span class="s4">])</span>
            <span class="s3">if </span><span class="s1">ord0 </span><span class="s3">in </span><span class="s4">(</span><span class="s6">0xef</span><span class="s4">, </span><span class="s6">0xfeff</span><span class="s4">):  </span><span class="s0"># Strip the UTF-8 BOM</span>
                <span class="s3">if </span><span class="s1">ord0 </span><span class="s4">== </span><span class="s6">0xfeff</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">1</span><span class="s4">:]</span>
                <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][:</span><span class="s6">3</span><span class="s4">] == </span><span class="s5">'</span><span class="s3">\xef\xbb\xbf</span><span class="s5">'</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">3</span><span class="s4">:]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">report </span><span class="s4">= </span><span class="s1">report </span><span class="s3">or </span><span class="s1">options</span><span class="s4">.</span><span class="s1">report</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">report</span><span class="s4">.</span><span class="s1">error</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">noqa </span><span class="s4">= </span><span class="s3">False</span>

    <span class="s3">def </span><span class="s1">report_invalid_syntax</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Check if the syntax is valid.&quot;&quot;&quot;</span>
        <span class="s4">(</span><span class="s1">exc_type</span><span class="s4">, </span><span class="s1">exc</span><span class="s4">) = </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">exc_info</span><span class="s4">()[:</span><span class="s6">2</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">exc</span><span class="s4">.</span><span class="s1">args</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s1">offset </span><span class="s4">= </span><span class="s1">exc</span><span class="s4">.</span><span class="s1">args</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">offset</span><span class="s4">) &gt; </span><span class="s6">2</span><span class="s4">:</span>
                <span class="s1">offset </span><span class="s4">= </span><span class="s1">offset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:</span><span class="s6">3</span><span class="s4">]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">offset </span><span class="s4">= (</span><span class="s6">1</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">offset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">offset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] </span><span class="s3">or </span><span class="s6">0</span><span class="s4">,</span>
                          <span class="s5">'E901 %s: %s' </span><span class="s4">% (</span><span class="s1">exc_type</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">, </span><span class="s1">exc</span><span class="s4">.</span><span class="s1">args</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]),</span>
                          <span class="s1">self</span><span class="s4">.</span><span class="s1">report_invalid_syntax</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">readline</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Get the next line from the input buffer.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">line_number </span><span class="s4">&gt;= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">total_lines</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s5">''</span>
        <span class="s1">line </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">line_number</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">line_number </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indent_char </span><span class="s3">is None and </span><span class="s1">line</span><span class="s4">[:</span><span class="s6">1</span><span class="s4">] </span><span class="s3">in </span><span class="s1">WHITESPACE</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">indent_char </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">line</span>

    <span class="s3">def </span><span class="s1">run_check</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">check</span><span class="s4">, </span><span class="s1">argument_names</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Run a check plugin.&quot;&quot;&quot;</span>
        <span class="s1">arguments </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">argument_names</span><span class="s4">:</span>
            <span class="s1">arguments</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">check</span><span class="s4">(*</span><span class="s1">arguments</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">init_checker_state</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">argument_names</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Prepare custom state for the specific checker plugin.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s5">'checker_state' </span><span class="s3">in </span><span class="s1">argument_names</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">checker_state </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_checker_states</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, {})</span>

    <span class="s3">def </span><span class="s1">check_physical</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">line</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Run all physical checks on a raw input line.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">physical_line </span><span class="s4">= </span><span class="s1">line</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">check</span><span class="s4">, </span><span class="s1">argument_names </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_physical_checks</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">init_checker_state</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">argument_names</span><span class="s4">)</span>
            <span class="s1">result </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">run_check</span><span class="s4">(</span><span class="s1">check</span><span class="s4">, </span><span class="s1">argument_names</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">result </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">) = </span><span class="s1">result</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">text</span><span class="s4">[:</span><span class="s6">4</span><span class="s4">] == </span><span class="s5">'E101'</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">indent_char </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">build_tokens_line</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Build a logical line from tokens.&quot;&quot;&quot;</span>
        <span class="s1">logical </span><span class="s4">= []</span>
        <span class="s1">comments </span><span class="s4">= []</span>
        <span class="s1">length </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">prev_row </span><span class="s4">= </span><span class="s1">prev_col </span><span class="s4">= </span><span class="s1">mapping </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">for </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">line </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">token_type </span><span class="s3">in </span><span class="s1">SKIP_TOKENS</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">if not </span><span class="s1">mapping</span><span class="s4">:</span>
                <span class="s1">mapping </span><span class="s4">= [(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">start</span><span class="s4">)]</span>
            <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">:</span>
                <span class="s1">comments</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">text</span><span class="s4">)</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">STRING</span><span class="s4">:</span>
                <span class="s1">text </span><span class="s4">= </span><span class="s1">mute_string</span><span class="s4">(</span><span class="s1">text</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">prev_row</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">start_row</span><span class="s4">, </span><span class="s1">start_col</span><span class="s4">) = </span><span class="s1">start</span>
                <span class="s3">if </span><span class="s1">prev_row </span><span class="s4">!= </span><span class="s1">start_row</span><span class="s4">:    </span><span class="s0"># different row</span>
                    <span class="s1">prev_text </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s1">prev_row </span><span class="s4">- </span><span class="s6">1</span><span class="s4">][</span><span class="s1">prev_col </span><span class="s4">- </span><span class="s6">1</span><span class="s4">]</span>
                    <span class="s3">if </span><span class="s1">prev_text </span><span class="s4">== </span><span class="s5">',' </span><span class="s3">or </span><span class="s4">(</span><span class="s1">prev_text </span><span class="s3">not in </span><span class="s5">'{[(' </span><span class="s3">and</span>
                                            <span class="s1">text </span><span class="s3">not in </span><span class="s5">'}])'</span><span class="s4">):</span>
                        <span class="s1">text </span><span class="s4">= </span><span class="s5">' ' </span><span class="s4">+ </span><span class="s1">text</span>
                <span class="s3">elif </span><span class="s1">prev_col </span><span class="s4">!= </span><span class="s1">start_col</span><span class="s4">:  </span><span class="s0"># different column</span>
                    <span class="s1">text </span><span class="s4">= </span><span class="s1">line</span><span class="s4">[</span><span class="s1">prev_col</span><span class="s4">:</span><span class="s1">start_col</span><span class="s4">] + </span><span class="s1">text</span>
            <span class="s1">logical</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">text</span><span class="s4">)</span>
            <span class="s1">length </span><span class="s4">+= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">text</span><span class="s4">)</span>
            <span class="s1">mapping</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">length</span><span class="s4">, </span><span class="s1">end</span><span class="s4">))</span>
            <span class="s4">(</span><span class="s1">prev_row</span><span class="s4">, </span><span class="s1">prev_col</span><span class="s4">) = </span><span class="s1">end</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">logical_line </span><span class="s4">= </span><span class="s5">''</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">logical</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">noqa </span><span class="s4">= </span><span class="s1">comments </span><span class="s3">and </span><span class="s1">noqa</span><span class="s4">(</span><span class="s5">''</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">comments</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">mapping</span>

    <span class="s3">def </span><span class="s1">check_logical</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Build a line from tokens and run all logical checks on it.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">report</span><span class="s4">.</span><span class="s1">increment_logical_line</span><span class="s4">()</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">build_tokens_line</span><span class="s4">()</span>

        <span class="s3">if not </span><span class="s1">mapping</span><span class="s4">:</span>
            <span class="s3">return</span>

        <span class="s4">(</span><span class="s1">start_row</span><span class="s4">, </span><span class="s1">start_col</span><span class="s4">) = </span><span class="s1">mapping</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">1</span><span class="s4">]</span>
        <span class="s1">start_line </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s1">start_row </span><span class="s4">- </span><span class="s6">1</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">indent_level </span><span class="s4">= </span><span class="s1">expand_indent</span><span class="s4">(</span><span class="s1">start_line</span><span class="s4">[:</span><span class="s1">start_col</span><span class="s4">])</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">blank_before </span><span class="s4">&lt; </span><span class="s1">self</span><span class="s4">.</span><span class="s1">blank_lines</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">blank_before </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">blank_lines</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">verbose </span><span class="s4">&gt;= </span><span class="s6">2</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">logical_line</span><span class="s4">[:</span><span class="s6">80</span><span class="s4">].</span><span class="s1">rstrip</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">check</span><span class="s4">, </span><span class="s1">argument_names </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_logical_checks</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">verbose </span><span class="s4">&gt;= </span><span class="s6">4</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">'   ' </span><span class="s4">+ </span><span class="s1">name</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">init_checker_state</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">argument_names</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">run_check</span><span class="s4">(</span><span class="s1">check</span><span class="s4">, </span><span class="s1">argument_names</span><span class="s4">) </span><span class="s3">or </span><span class="s4">():</span>
                <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">offset</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                    <span class="s3">for </span><span class="s1">token_offset</span><span class="s4">, </span><span class="s1">pos </span><span class="s3">in </span><span class="s1">mapping</span><span class="s4">:</span>
                        <span class="s3">if </span><span class="s1">offset </span><span class="s4">&lt;= </span><span class="s1">token_offset</span><span class="s4">:</span>
                            <span class="s3">break</span>
                    <span class="s1">offset </span><span class="s4">= (</span><span class="s1">pos</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">pos</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] + </span><span class="s1">offset </span><span class="s4">- </span><span class="s1">token_offset</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">offset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">offset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">logical_line</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">previous_indent_level </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indent_level</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">previous_logical </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">logical_line</span>
            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indent_level</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">previous_unindented_logical_line </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">logical_line</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">blank_lines </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens </span><span class="s4">= []</span>

    <span class="s3">def </span><span class="s1">check_ast</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Build the file's AST and run all AST checks.&quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">tree </span><span class="s4">= </span><span class="s1">compile</span><span class="s4">(</span><span class="s5">''</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">), </span><span class="s5">''</span><span class="s4">, </span><span class="s5">'exec'</span><span class="s4">, </span><span class="s1">PyCF_ONLY_AST</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">SyntaxError</span><span class="s4">, </span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">report_invalid_syntax</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">cls</span><span class="s4">, </span><span class="s1">__ </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_ast_checks</span><span class="s4">:</span>
            <span class="s1">checker </span><span class="s4">= </span><span class="s1">cls</span><span class="s4">(</span><span class="s1">tree</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">lineno</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check </span><span class="s3">in </span><span class="s1">checker</span><span class="s4">.</span><span class="s1">run</span><span class="s4">():</span>
                <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines </span><span class="s3">or not </span><span class="s1">noqa</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s1">lineno </span><span class="s4">- </span><span class="s6">1</span><span class="s4">]):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">lineno</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">generate_tokens</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Tokenize the file, run physical line checks and yield tokens.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_io_error</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s6">1</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s5">'E902 %s' </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_io_error</span><span class="s4">, </span><span class="s1">readlines</span><span class="s4">)</span>
        <span class="s1">tokengen </span><span class="s4">= </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">generate_tokens</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">readline</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">token </span><span class="s3">in </span><span class="s1">tokengen</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] &gt; </span><span class="s1">self</span><span class="s4">.</span><span class="s1">total_lines</span><span class="s4">:</span>
                    <span class="s3">return</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">noqa </span><span class="s4">= </span><span class="s1">token</span><span class="s4">[</span><span class="s6">4</span><span class="s4">] </span><span class="s3">and </span><span class="s1">noqa</span><span class="s4">(</span><span class="s1">token</span><span class="s4">[</span><span class="s6">4</span><span class="s4">])</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">maybe_check_physical</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
                <span class="s3">yield </span><span class="s1">token</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">SyntaxError</span><span class="s4">, </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">TokenError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">report_invalid_syntax</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">maybe_check_physical</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">token</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;If appropriate (based on token), check current physical line(s).&quot;&quot;&quot;</span>
        <span class="s0"># Called after every token, but act only on end of line.</span>
        <span class="s3">if </span><span class="s1">_is_eol_token</span><span class="s4">(</span><span class="s1">token</span><span class="s4">):</span>
            <span class="s0"># Obviously, a newline token ends a single physical line.</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">check_physical</span><span class="s4">(</span><span class="s1">token</span><span class="s4">[</span><span class="s6">4</span><span class="s4">])</span>
        <span class="s3">elif </span><span class="s1">token</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">STRING </span><span class="s3">and </span><span class="s5">'</span><span class="s3">\n</span><span class="s5">' </span><span class="s3">in </span><span class="s1">token</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]:</span>
            <span class="s0"># Less obviously, a string that contains newlines is a</span>
            <span class="s0"># multiline string, either triple-quoted or with internal</span>
            <span class="s0"># newlines backslash-escaped. Check every physical line in the</span>
            <span class="s0"># string *except* for the last one: its newline is outside of</span>
            <span class="s0"># the multiline string, so we consider it a regular physical</span>
            <span class="s0"># line, and will check it like any other physical line.</span>
            <span class="s0">#</span>
            <span class="s0"># Subtleties:</span>
            <span class="s0"># - we don't *completely* ignore the last line; if it contains</span>
            <span class="s0">#   the magical &quot;# noqa&quot; comment, we disable all physical</span>
            <span class="s0">#   checks for the entire multiline string</span>
            <span class="s0"># - have to wind self.line_number back because initially it</span>
            <span class="s0">#   points to the last line of the string, and we want</span>
            <span class="s0">#   check_physical() to give accurate feedback</span>
            <span class="s3">if </span><span class="s1">noqa</span><span class="s4">(</span><span class="s1">token</span><span class="s4">[</span><span class="s6">4</span><span class="s4">]):</span>
                <span class="s3">return</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">multiline </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">line_number </span><span class="s4">= </span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">token</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)[:-</span><span class="s6">1</span><span class="s4">]:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">check_physical</span><span class="s4">(</span><span class="s1">line </span><span class="s4">+ </span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">line_number </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">multiline </span><span class="s4">= </span><span class="s3">False</span>

    <span class="s3">def </span><span class="s1">check_all</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">line_offset</span><span class="s4">=</span><span class="s6">0</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Run all checks on the input file.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">report</span><span class="s4">.</span><span class="s1">init_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">, </span><span class="s1">line_offset</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">total_lines </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_ast_checks</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">check_ast</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">line_number </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">indent_char </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">indent_level </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">previous_indent_level </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">previous_logical </span><span class="s4">= </span><span class="s5">''</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">previous_unindented_logical_line </span><span class="s4">= </span><span class="s5">''</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">blank_lines </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">blank_before </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">parens </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">for </span><span class="s1">token </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">generate_tokens</span><span class="s4">():</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
            <span class="s1">token_type</span><span class="s4">, </span><span class="s1">text </span><span class="s4">= </span><span class="s1">token</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">2</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">verbose </span><span class="s4">&gt;= </span><span class="s6">3</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] == </span><span class="s1">token</span><span class="s4">[</span><span class="s6">3</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]:</span>
                    <span class="s1">pos </span><span class="s4">= </span><span class="s5">'[%s:%s]' </span><span class="s4">% (</span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">1</span><span class="s4">] </span><span class="s3">or </span><span class="s5">''</span><span class="s4">, </span><span class="s1">token</span><span class="s4">[</span><span class="s6">3</span><span class="s4">][</span><span class="s6">1</span><span class="s4">])</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">pos </span><span class="s4">= </span><span class="s5">'l.%s' </span><span class="s4">% </span><span class="s1">token</span><span class="s4">[</span><span class="s6">3</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">'l.%s</span><span class="s3">\t</span><span class="s5">%s</span><span class="s3">\t</span><span class="s5">%s</span><span class="s3">\t</span><span class="s5">%r' </span><span class="s4">%</span>
                      <span class="s4">(</span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">], </span><span class="s1">pos</span><span class="s4">, </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">tok_name</span><span class="s4">[</span><span class="s1">token</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]], </span><span class="s1">text</span><span class="s4">))</span>
            <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT </span><span class="s3">or </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">STRING</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">sre </span><span class="s3">in </span><span class="s1">re</span><span class="s4">.</span><span class="s1">finditer</span><span class="s4">(</span><span class="s5">r&quot;[:.;,]   ?[A-Za-z]&quot;</span><span class="s4">, </span><span class="s1">text</span><span class="s4">):</span>
                    <span class="s1">pos </span><span class="s4">= </span><span class="s1">sre</span><span class="s4">.</span><span class="s1">span</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>
                    <span class="s1">part </span><span class="s4">= </span><span class="s1">text</span><span class="s4">[:</span><span class="s1">pos</span><span class="s4">]</span>
                    <span class="s1">line </span><span class="s4">= </span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] + </span><span class="s1">part</span><span class="s4">.</span><span class="s1">count</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
                    <span class="s1">offset </span><span class="s4">= </span><span class="s6">0 </span><span class="s3">if </span><span class="s1">part</span><span class="s4">.</span><span class="s1">count</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">) &gt; </span><span class="s6">0 </span><span class="s3">else </span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">1</span><span class="s4">]</span>
                    <span class="s1">col </span><span class="s4">= </span><span class="s1">offset </span><span class="s4">+ </span><span class="s1">pos </span><span class="s4">- </span><span class="s1">part</span><span class="s4">.</span><span class="s1">rfind</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">) + </span><span class="s6">1</span>
                    <span class="s3">if </span><span class="s1">sre</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">'.'</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">line</span><span class="s4">, </span><span class="s1">col</span><span class="s4">,</span>
                           <span class="s5">'E289 Too many spaces after period. Use only one.'</span><span class="s4">,</span>
                           <span class="s1">check</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
                    <span class="s3">elif </span><span class="s1">sre</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">','</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">line</span><span class="s4">, </span><span class="s1">col</span><span class="s4">,</span>
                           <span class="s5">'E288 Too many spaces after comma. Use only one.'</span><span class="s4">,</span>
                           <span class="s1">check</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">line</span><span class="s4">, </span><span class="s1">col</span><span class="s4">,</span>
                           <span class="s5">'E287 Too many spaces after punctuation. '</span>
                           <span class="s5">'Use only one.'</span><span class="s4">,</span>
                           <span class="s1">check</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">OP</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">text </span><span class="s3">in </span><span class="s5">'([{'</span><span class="s4">:</span>
                    <span class="s1">parens </span><span class="s4">+= </span><span class="s6">1</span>
                <span class="s3">elif </span><span class="s1">text </span><span class="s3">in </span><span class="s5">'}])'</span><span class="s4">:</span>
                    <span class="s1">parens </span><span class="s4">-= </span><span class="s6">1</span>
            <span class="s3">elif not </span><span class="s1">parens</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">token_type </span><span class="s3">in </span><span class="s1">NEWLINE</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">NEWLINE</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">check_logical</span><span class="s4">()</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">blank_before </span><span class="s4">= </span><span class="s6">0</span>
                    <span class="s3">elif </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">) == </span><span class="s6">1</span><span class="s4">:</span>
                        <span class="s0"># The physical line contains only this token.</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">blank_lines </span><span class="s4">+= </span><span class="s6">1</span>
                        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">check_logical</span><span class="s4">()</span>
                <span class="s3">elif </span><span class="s1">COMMENT_WITH_NL </span><span class="s3">and </span><span class="s1">token_type </span><span class="s4">== </span><span class="s1">tokenize</span><span class="s4">.</span><span class="s1">COMMENT</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">) == </span><span class="s6">1</span><span class="s4">:</span>
                        <span class="s0"># The comment also ends a physical line</span>
                        <span class="s1">token </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
                        <span class="s1">token</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">text</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">'</span><span class="s3">\r\n</span><span class="s5">'</span><span class="s4">)</span>
                        <span class="s1">token</span><span class="s4">[</span><span class="s6">3</span><span class="s4">] = (</span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">], </span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">1</span><span class="s4">] + </span><span class="s1">len</span><span class="s4">(</span><span class="s1">token</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]))</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens </span><span class="s4">= [</span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)]</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">check_logical</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">check_physical</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">])</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">check_logical</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">blank_lines </span><span class="s4">&gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">report_error</span><span class="s4">(</span><span class="s1">token</span><span class="s4">[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">], </span><span class="s6">0</span><span class="s4">,</span>
                <span class="s5">'E389 File ends in multiple blank lines'</span><span class="s4">,</span>
                <span class="s1">check</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">report</span><span class="s4">.</span><span class="s1">get_file_results</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">BaseReport</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Collect the results of the checks.&quot;&quot;&quot;</span>

    <span class="s1">print_filename </span><span class="s4">= </span><span class="s3">False</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">options</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_benchmark_keys </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">benchmark_keys</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_ignore_code </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">ignore_code</span>
        <span class="s0"># Results</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">elapsed </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">total_errors </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">counters </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">.</span><span class="s1">fromkeys</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_benchmark_keys</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">messages </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">start</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Start the timer.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_start_time </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">stop</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Stop the timer.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">elapsed </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() - </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_start_time</span>

    <span class="s3">def </span><span class="s1">init_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">, </span><span class="s1">line_offset</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Signal a new file.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">filename </span><span class="s4">= </span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">lines </span><span class="s4">= </span><span class="s1">lines</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">expected </span><span class="s4">= </span><span class="s1">expected </span><span class="s3">or </span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">line_offset </span><span class="s4">= </span><span class="s1">line_offset</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">file_errors </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s5">'files'</span><span class="s4">] += </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s5">'physical lines'</span><span class="s4">] += </span><span class="s1">len</span><span class="s4">(</span><span class="s1">lines</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">increment_logical_line</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Signal a new logical line.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s5">'logical lines'</span><span class="s4">] += </span><span class="s6">1</span>

    <span class="s3">def </span><span class="s1">error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Report an error, according to options.&quot;&quot;&quot;</span>
        <span class="s1">code </span><span class="s4">= </span><span class="s1">text</span><span class="s4">[:</span><span class="s6">4</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_ignore_code</span><span class="s4">(</span><span class="s1">code</span><span class="s4">):</span>
            <span class="s3">return</span>
        <span class="s3">if </span><span class="s1">code </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s1">code</span><span class="s4">] += </span><span class="s6">1</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s1">code</span><span class="s4">] = </span><span class="s6">1</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">messages</span><span class="s4">[</span><span class="s1">code</span><span class="s4">] = </span><span class="s1">text</span><span class="s4">[</span><span class="s6">5</span><span class="s4">:]</span>
        <span class="s0"># Don't care about expected errors or warnings</span>
        <span class="s3">if </span><span class="s1">code </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">expected</span><span class="s4">:</span>
            <span class="s3">return</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">print_filename </span><span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">file_errors</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">file_errors </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">total_errors </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">code</span>

    <span class="s3">def </span><span class="s1">get_file_results</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Return the count of errors and warnings for this file.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">file_errors</span>

    <span class="s3">def </span><span class="s1">get_count</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s5">''</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Return the total count of errors and warnings.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">sum</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
                    <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">messages </span><span class="s3">if </span><span class="s1">key</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s1">prefix</span><span class="s4">)])</span>

    <span class="s3">def </span><span class="s1">get_statistics</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s5">''</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Get statistics for message codes that start with the prefix. 
 
        prefix='' matches all errors and warnings 
        prefix='E' matches all errors 
        prefix='W' matches all warnings 
        prefix='E4' matches all errors that have to do with imports 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s5">'%-7s %s %s' </span><span class="s4">% (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s1">key</span><span class="s4">], </span><span class="s1">key</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">messages</span><span class="s4">[</span><span class="s1">key</span><span class="s4">])</span>
                <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">messages</span><span class="s4">) </span><span class="s3">if </span><span class="s1">key</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s1">prefix</span><span class="s4">)]</span>

    <span class="s3">def </span><span class="s1">print_statistics</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s5">''</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Print overall statistics (number of errors and warnings).&quot;&quot;&quot;</span>
        <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_statistics</span><span class="s4">(</span><span class="s1">prefix</span><span class="s4">):</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s1">line</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">print_benchmark</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Print benchmark numbers.&quot;&quot;&quot;</span>
        <span class="s1">print</span><span class="s4">(</span><span class="s5">'%-7.2f %s' </span><span class="s4">% (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">elapsed</span><span class="s4">, </span><span class="s5">'seconds elapsed'</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">elapsed</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_benchmark_keys</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">'%-7d %s per second (%d total)' </span><span class="s4">%</span>
                      <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] / </span><span class="s1">self</span><span class="s4">.</span><span class="s1">elapsed</span><span class="s4">, </span><span class="s1">key</span><span class="s4">,</span>
                       <span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]))</span>


<span class="s3">class </span><span class="s1">FileReport</span><span class="s4">(</span><span class="s1">BaseReport</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Collect the results of the checks and print only the filenames.&quot;&quot;&quot;</span>

    <span class="s1">print_filename </span><span class="s4">= </span><span class="s3">True</span>


<span class="s3">class </span><span class="s1">StandardReport</span><span class="s4">(</span><span class="s1">BaseReport</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Collect and print the results of the checks.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">options</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">(</span><span class="s1">StandardReport</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">options</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_fmt </span><span class="s4">= </span><span class="s1">REPORT_FORMAT</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">format</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">(),</span>
                                      <span class="s1">options</span><span class="s4">.</span><span class="s1">format</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_repeat </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">repeat</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_show_source </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">show_source</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_show_pep8 </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">show_pep8</span>

    <span class="s3">def </span><span class="s1">init_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">, </span><span class="s1">line_offset</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Signal a new file.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_deferred_print </span><span class="s4">= []</span>
        <span class="s3">return </span><span class="s1">super</span><span class="s4">(</span><span class="s1">StandardReport</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">init_file</span><span class="s4">(</span>
            <span class="s1">filename</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">, </span><span class="s1">line_offset</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Report an error, according to options.&quot;&quot;&quot;</span>
        <span class="s1">code </span><span class="s4">= </span><span class="s1">super</span><span class="s4">(</span><span class="s1">StandardReport</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">error</span><span class="s4">(</span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">,</span>
                                                 <span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">code </span><span class="s3">and </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">counters</span><span class="s4">[</span><span class="s1">code</span><span class="s4">] == </span><span class="s6">1 </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_repeat</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_deferred_print</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                <span class="s4">(</span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">code</span><span class="s4">, </span><span class="s1">text</span><span class="s4">[</span><span class="s6">5</span><span class="s4">:], </span><span class="s1">check</span><span class="s4">.</span><span class="s1">__doc__</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">code</span>

    <span class="s3">def </span><span class="s1">get_file_results</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Print the result and return the overall count for this file.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_deferred_print</span><span class="s4">.</span><span class="s1">sort</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">code</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">doc </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_deferred_print</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fmt </span><span class="s4">% {</span>
                <span class="s5">'path'</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">,</span>
                <span class="s5">'row'</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">line_offset </span><span class="s4">+ </span><span class="s1">line_number</span><span class="s4">, </span><span class="s5">'col'</span><span class="s4">: </span><span class="s1">offset </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">,</span>
                <span class="s5">'code'</span><span class="s4">: </span><span class="s1">code</span><span class="s4">, </span><span class="s5">'text'</span><span class="s4">: </span><span class="s1">text</span><span class="s4">,</span>
            <span class="s4">})</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_show_source</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">line_number </span><span class="s4">&gt; </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">):</span>
                    <span class="s1">line </span><span class="s4">= </span><span class="s5">''</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">line </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lines</span><span class="s4">[</span><span class="s1">line_number </span><span class="s4">- </span><span class="s6">1</span><span class="s4">]</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s1">line</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">())</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s1">re</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span><span class="s5">r'\S'</span><span class="s4">, </span><span class="s5">' '</span><span class="s4">, </span><span class="s1">line</span><span class="s4">[:</span><span class="s1">offset</span><span class="s4">]) + </span><span class="s5">'^'</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_show_pep8 </span><span class="s3">and </span><span class="s1">doc</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">'    ' </span><span class="s4">+ </span><span class="s1">doc</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">())</span>

            <span class="s0"># stdout is block buffered when not stdout.isatty().</span>
            <span class="s0"># line can be broken where buffer boundary since other processes</span>
            <span class="s0"># write to same file.</span>
            <span class="s0"># flush() after print() to avoid buffer boundary.</span>
            <span class="s0"># Typical buffer size is 8192. line written safely when</span>
            <span class="s0"># len(line) &lt; 8192.</span>
            <span class="s1">sys</span><span class="s4">.</span><span class="s1">stdout</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">file_errors</span>


<span class="s3">class </span><span class="s1">DiffReport</span><span class="s4">(</span><span class="s1">StandardReport</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Collect and print the results for the changed lines only.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">options</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">(</span><span class="s1">DiffReport</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">options</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_selected </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">selected_lines</span>

    <span class="s3">def </span><span class="s1">error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">line_number </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_selected</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">]:</span>
            <span class="s3">return</span>
        <span class="s3">return </span><span class="s1">super</span><span class="s4">(</span><span class="s1">DiffReport</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">error</span><span class="s4">(</span><span class="s1">line_number</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">text</span><span class="s4">, </span><span class="s1">check</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">StyleGuide</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Initialize a PEP-8 instance with few options.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s0"># build options from the command line</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">checker_class </span><span class="s4">= </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">'checker_class'</span><span class="s4">, </span><span class="s1">Checker</span><span class="s4">)</span>
        <span class="s1">parse_argv </span><span class="s4">= </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">'parse_argv'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">config_file </span><span class="s4">= </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">'config_file'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">parser </span><span class="s4">= </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">'parser'</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s0"># build options from dict</span>
        <span class="s1">options_dict </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s1">arglist </span><span class="s4">= </span><span class="s3">None if </span><span class="s1">parse_argv </span><span class="s3">else </span><span class="s1">options_dict</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'paths'</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">options</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">paths </span><span class="s4">= </span><span class="s1">process_options</span><span class="s4">(</span>
            <span class="s1">arglist</span><span class="s4">, </span><span class="s1">parse_argv</span><span class="s4">, </span><span class="s1">config_file</span><span class="s4">, </span><span class="s1">parser</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">options_dict</span><span class="s4">:</span>
            <span class="s1">options</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">options_dict</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s5">'paths' </span><span class="s3">in </span><span class="s1">options_dict</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">paths </span><span class="s4">= </span><span class="s1">options_dict</span><span class="s4">[</span><span class="s5">'paths'</span><span class="s4">]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">runner </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">input_file</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">options </span><span class="s4">= </span><span class="s1">options</span>

        <span class="s3">if not </span><span class="s1">options</span><span class="s4">.</span><span class="s1">reporter</span><span class="s4">:</span>
            <span class="s1">options</span><span class="s4">.</span><span class="s1">reporter </span><span class="s4">= </span><span class="s1">BaseReport </span><span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">quiet </span><span class="s3">else </span><span class="s1">StandardReport</span>

        <span class="s1">options</span><span class="s4">.</span><span class="s1">select </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">select </span><span class="s3">or </span><span class="s4">())</span>
        <span class="s3">if not </span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">select </span><span class="s3">or </span><span class="s1">options</span><span class="s4">.</span><span class="s1">ignore </span><span class="s3">or</span>
                <span class="s1">options</span><span class="s4">.</span><span class="s1">testsuite </span><span class="s3">or </span><span class="s1">options</span><span class="s4">.</span><span class="s1">doctest</span><span class="s4">) </span><span class="s3">and </span><span class="s1">DEFAULT_IGNORE</span><span class="s4">:</span>
            <span class="s0"># The default choice: ignore controversial checks</span>
            <span class="s1">options</span><span class="s4">.</span><span class="s1">ignore </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">DEFAULT_IGNORE</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">','</span><span class="s4">))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># Ignore all checks which are not explicitly selected</span>
            <span class="s1">options</span><span class="s4">.</span><span class="s1">ignore </span><span class="s4">= (</span><span class="s5">''</span><span class="s4">,) </span><span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">select </span><span class="s3">else </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">ignore</span><span class="s4">)</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">benchmark_keys </span><span class="s4">= </span><span class="s1">BENCHMARK_KEYS</span><span class="s4">[:]</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">ignore_code </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ignore_code</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">physical_checks </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_checks</span><span class="s4">(</span><span class="s5">'physical_line'</span><span class="s4">)</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">logical_checks </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_checks</span><span class="s4">(</span><span class="s5">'logical_line'</span><span class="s4">)</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">ast_checks </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_checks</span><span class="s4">(</span><span class="s5">'tree'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">init_report</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">init_report</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">reporter</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Initialize the report instance.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">report </span><span class="s4">= (</span><span class="s1">reporter </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">reporter</span><span class="s4">)(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">report</span>

    <span class="s3">def </span><span class="s1">check_files</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">paths</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Run all checks on the paths.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">paths </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">paths </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">paths</span>
        <span class="s1">report </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">report</span>
        <span class="s1">runner </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">runner</span>
        <span class="s1">report</span><span class="s4">.</span><span class="s1">start</span><span class="s4">()</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">path </span><span class="s3">in </span><span class="s1">paths</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">isdir</span><span class="s4">(</span><span class="s1">path</span><span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">input_dir</span><span class="s4">(</span><span class="s1">path</span><span class="s4">)</span>
                <span class="s3">elif not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">excluded</span><span class="s4">(</span><span class="s1">path</span><span class="s4">):</span>
                    <span class="s1">runner</span><span class="s4">(</span><span class="s1">path</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">KeyboardInterrupt</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s5">'... stopped'</span><span class="s4">)</span>
        <span class="s1">report</span><span class="s4">.</span><span class="s1">stop</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">report</span>

    <span class="s3">def </span><span class="s1">input_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">line_offset</span><span class="s4">=</span><span class="s6">0</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Run all checks on a Python source file.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">verbose</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s5">'checking %s' </span><span class="s4">% </span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s1">fchecker </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">checker_class</span><span class="s4">(</span>
            <span class="s1">filename</span><span class="s4">, </span><span class="s1">lines</span><span class="s4">=</span><span class="s1">lines</span><span class="s4">, </span><span class="s1">options</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">fchecker</span><span class="s4">.</span><span class="s1">check_all</span><span class="s4">(</span><span class="s1">expected</span><span class="s4">=</span><span class="s1">expected</span><span class="s4">, </span><span class="s1">line_offset</span><span class="s4">=</span><span class="s1">line_offset</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">input_dir</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dirname</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Check all files in this directory and all subdirectories.&quot;&quot;&quot;</span>
        <span class="s1">dirname </span><span class="s4">= </span><span class="s1">dirname</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s5">'/'</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">excluded</span><span class="s4">(</span><span class="s1">dirname</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s6">0</span>
        <span class="s1">counters </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">report</span><span class="s4">.</span><span class="s1">counters</span>
        <span class="s1">verbose </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">verbose</span>
        <span class="s1">filepatterns </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">filename</span>
        <span class="s1">runner </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">runner</span>
        <span class="s3">for </span><span class="s1">root</span><span class="s4">, </span><span class="s1">dirs</span><span class="s4">, </span><span class="s1">files </span><span class="s3">in </span><span class="s1">os</span><span class="s4">.</span><span class="s1">walk</span><span class="s4">(</span><span class="s1">dirname</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">verbose</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">'directory ' </span><span class="s4">+ </span><span class="s1">root</span><span class="s4">)</span>
            <span class="s1">counters</span><span class="s4">[</span><span class="s5">'directories'</span><span class="s4">] += </span><span class="s6">1</span>
            <span class="s3">for </span><span class="s1">subdir </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">dirs</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">excluded</span><span class="s4">(</span><span class="s1">subdir</span><span class="s4">, </span><span class="s1">root</span><span class="s4">):</span>
                    <span class="s1">dirs</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">subdir</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">filename </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">files</span><span class="s4">):</span>
                <span class="s0"># contain a pattern that matches?</span>
                <span class="s3">if </span><span class="s4">((</span><span class="s1">filename_match</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">filepatterns</span><span class="s4">) </span><span class="s3">and</span>
                     <span class="s3">not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">excluded</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">root</span><span class="s4">))):</span>
                    <span class="s1">runner</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">root</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">excluded</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">, </span><span class="s1">parent</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Check if the file should be excluded. 
 
        Check if 'options.exclude' contains a pattern that matches filename. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">exclude</span><span class="s4">:</span>
            <span class="s3">return False</span>
        <span class="s1">basename </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">basename</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">filename_match</span><span class="s4">(</span><span class="s1">basename</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">exclude</span><span class="s4">):</span>
            <span class="s3">return True</span>
        <span class="s3">if </span><span class="s1">parent</span><span class="s4">:</span>
            <span class="s1">filename </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">parent</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s1">filename </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">abspath</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">filename_match</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">exclude</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">ignore_code</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">code</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Check if the error code should be ignored. 
 
        If 'options.select' contains a prefix of the error code, 
        return False.  Else, if 'options.ignore' contains a prefix of 
        the error code, return True. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">code</span><span class="s4">) &lt; </span><span class="s6">4 </span><span class="s3">and </span><span class="s1">any</span><span class="s4">(</span><span class="s1">s</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s1">code</span><span class="s4">)</span>
                                 <span class="s3">for </span><span class="s1">s </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">select</span><span class="s4">):</span>
            <span class="s3">return False</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">code</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">ignore</span><span class="s4">) </span><span class="s3">and</span>
                <span class="s3">not </span><span class="s1">code</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">.</span><span class="s1">select</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">get_checks</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">argument_name</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Get all the checks for this category. 
 
        Find all globally visible functions where the first argument name 
        starts with argument_name and which contain selected tests. 
        &quot;&quot;&quot;</span>
        <span class="s1">checks </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">check</span><span class="s4">, </span><span class="s1">attrs </span><span class="s3">in </span><span class="s1">_checks</span><span class="s4">[</span><span class="s1">argument_name</span><span class="s4">].</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s4">(</span><span class="s1">codes</span><span class="s4">, </span><span class="s1">args</span><span class="s4">) = </span><span class="s1">attrs</span>
            <span class="s3">if </span><span class="s1">any</span><span class="s4">(</span><span class="s3">not </span><span class="s4">(</span><span class="s1">code </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ignore_code</span><span class="s4">(</span><span class="s1">code</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">code </span><span class="s3">in </span><span class="s1">codes</span><span class="s4">):</span>
                <span class="s1">checks</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">check</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">, </span><span class="s1">check</span><span class="s4">, </span><span class="s1">args</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">checks</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">get_parser</span><span class="s4">(</span><span class="s1">prog</span><span class="s4">=</span><span class="s5">'pycodestyle'</span><span class="s4">, </span><span class="s1">version</span><span class="s4">=</span><span class="s1">__version__</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Create the parser for the program.&quot;&quot;&quot;</span>
    <span class="s1">parser </span><span class="s4">= </span><span class="s1">OptionParser</span><span class="s4">(</span><span class="s1">prog</span><span class="s4">=</span><span class="s1">prog</span><span class="s4">, </span><span class="s1">version</span><span class="s4">=</span><span class="s1">version</span><span class="s4">,</span>
                          <span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;%prog [options] input ...&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">config_options </span><span class="s4">= [</span>
        <span class="s5">'exclude'</span><span class="s4">, </span><span class="s5">'filename'</span><span class="s4">, </span><span class="s5">'select'</span><span class="s4">, </span><span class="s5">'ignore'</span><span class="s4">, </span><span class="s5">'max-line-length'</span><span class="s4">,</span>
        <span class="s5">'hang-closing'</span><span class="s4">, </span><span class="s5">'count'</span><span class="s4">, </span><span class="s5">'format'</span><span class="s4">, </span><span class="s5">'quiet'</span><span class="s4">, </span><span class="s5">'show-pep8'</span><span class="s4">,</span>
        <span class="s5">'show-source'</span><span class="s4">, </span><span class="s5">'statistics'</span><span class="s4">, </span><span class="s5">'verbose'</span><span class="s4">]</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'-v'</span><span class="s4">, </span><span class="s5">'--verbose'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'count'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;print status messages, or debug with -vv&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'-q'</span><span class="s4">, </span><span class="s5">'--quiet'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'count'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;report only file names, or nothing with -qq&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'-r'</span><span class="s4">, </span><span class="s5">'--repeat'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;(obsolete) show all occurrences of the same error&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--first'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_false'</span><span class="s4">, </span><span class="s1">dest</span><span class="s4">=</span><span class="s5">'repeat'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;show first occurrence of each error&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--exclude'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'patterns'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">DEFAULT_EXCLUDE</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;exclude files or directories which match these &quot;</span>
                           <span class="s5">&quot;comma separated patterns (default: %default)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--filename'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'patterns'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'*.py'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;when parsing directories, only check filenames &quot;</span>
                           <span class="s5">&quot;matching these comma separated patterns &quot;</span>
                           <span class="s5">&quot;(default: %default)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--select'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'errors'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">''</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;select errors and warnings (e.g. E,W6)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--ignore'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'errors'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">''</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;skip errors and warnings (e.g. E4,W) &quot;</span>
                           <span class="s5">&quot;(default: %s)&quot; </span><span class="s4">% </span><span class="s1">DEFAULT_IGNORE</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--show-source'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;show source code for each error&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--show-pep8'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;show text of PEP 8 for each error &quot;</span>
                           <span class="s5">&quot;(implies --first)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--statistics'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;count errors and warnings&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--count'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;print total number of errors and warnings &quot;</span>
                           <span class="s5">&quot;to standard error and set exit code to 1 if &quot;</span>
                           <span class="s5">&quot;total is not null&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--max-line-length'</span><span class="s4">, </span><span class="s1">type</span><span class="s4">=</span><span class="s5">'int'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'n'</span><span class="s4">,</span>
                      <span class="s1">default</span><span class="s4">=</span><span class="s1">MAX_LINE_LENGTH</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;set maximum allowed line length &quot;</span>
                           <span class="s5">&quot;(default: %default)&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--hang-closing'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;hang closing bracket instead of matching &quot;</span>
                           <span class="s5">&quot;indentation of opening bracket's line&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--format'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'format'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'default'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;set the error format [default|pylint|&lt;custom&gt;]&quot;</span><span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--diff'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                      <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;report changes only within line number ranges in &quot;</span>
                           <span class="s5">&quot;the unified diff received on STDIN&quot;</span><span class="s4">)</span>
    <span class="s1">group </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option_group</span><span class="s4">(</span><span class="s5">&quot;Testing Options&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(</span><span class="s1">TESTSUITE_PATH</span><span class="s4">):</span>
        <span class="s1">group</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--testsuite'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'dir'</span><span class="s4">,</span>
                         <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;run regression tests from dir&quot;</span><span class="s4">)</span>
        <span class="s1">group</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--doctest'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                         <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;run doctest on myself&quot;</span><span class="s4">)</span>
    <span class="s1">group</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--benchmark'</span><span class="s4">, </span><span class="s1">action</span><span class="s4">=</span><span class="s5">'store_true'</span><span class="s4">,</span>
                     <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;measure processing speed&quot;</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">parser</span>


<span class="s3">def </span><span class="s1">read_config</span><span class="s4">(</span><span class="s1">options</span><span class="s4">, </span><span class="s1">args</span><span class="s4">, </span><span class="s1">arglist</span><span class="s4">, </span><span class="s1">parser</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Read and parse configurations. 
 
    If a config file is specified on the command line with the &quot;--config&quot; 
    option, then only it is used for configuration. 
 
    Otherwise, the user configuration (~/.config/pycodestyle) and any local 
    configurations in the current directory or above will be merged together 
    (in that order) using the read method of ConfigParser. 
    &quot;&quot;&quot;</span>
    <span class="s1">config </span><span class="s4">= </span><span class="s1">RawConfigParser</span><span class="s4">()</span>

    <span class="s1">cli_conf </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">config</span>

    <span class="s1">local_dir </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">curdir</span>

    <span class="s3">if </span><span class="s1">USER_CONFIG </span><span class="s3">and </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">isfile</span><span class="s4">(</span><span class="s1">USER_CONFIG</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">verbose</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s5">'user configuration: %s' </span><span class="s4">% </span><span class="s1">USER_CONFIG</span><span class="s4">)</span>
        <span class="s1">config</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">USER_CONFIG</span><span class="s4">)</span>

    <span class="s1">parent </span><span class="s4">= </span><span class="s1">tail </span><span class="s4">= </span><span class="s1">args </span><span class="s3">and </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">abspath</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">commonprefix</span><span class="s4">(</span><span class="s1">args</span><span class="s4">))</span>
    <span class="s3">while </span><span class="s1">tail</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">config</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">parent</span><span class="s4">, </span><span class="s1">fn</span><span class="s4">) </span><span class="s3">for </span><span class="s1">fn </span><span class="s3">in </span><span class="s1">PROJECT_CONFIG</span><span class="s4">):</span>
            <span class="s1">local_dir </span><span class="s4">= </span><span class="s1">parent</span>
            <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">verbose</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">'local configuration: in %s' </span><span class="s4">% </span><span class="s1">parent</span><span class="s4">)</span>
            <span class="s3">break</span>
        <span class="s4">(</span><span class="s1">parent</span><span class="s4">, </span><span class="s1">tail</span><span class="s4">) = </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s1">parent</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">cli_conf </span><span class="s3">and </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">isfile</span><span class="s4">(</span><span class="s1">cli_conf</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">verbose</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s5">'cli configuration: %s' </span><span class="s4">% </span><span class="s1">cli_conf</span><span class="s4">)</span>
        <span class="s1">config</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">cli_conf</span><span class="s4">)</span>

    <span class="s1">pycodestyle_section </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">if </span><span class="s1">config</span><span class="s4">.</span><span class="s1">has_section</span><span class="s4">(</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">prog</span><span class="s4">):</span>
        <span class="s1">pycodestyle_section </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">prog</span>
    <span class="s3">elif </span><span class="s1">config</span><span class="s4">.</span><span class="s1">has_section</span><span class="s4">(</span><span class="s5">'pep8'</span><span class="s4">):</span>
        <span class="s1">pycodestyle_section </span><span class="s4">= </span><span class="s5">'pep8'  </span><span class="s0"># Deprecated</span>
        <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span><span class="s5">'[pep8] section is deprecated. Use [pycodestyle].'</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">pycodestyle_section</span><span class="s4">:</span>
        <span class="s1">option_list </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">([(</span><span class="s1">o</span><span class="s4">.</span><span class="s1">dest</span><span class="s4">, </span><span class="s1">o</span><span class="s4">.</span><span class="s1">type </span><span class="s3">or </span><span class="s1">o</span><span class="s4">.</span><span class="s1">action</span><span class="s4">)</span>
                            <span class="s3">for </span><span class="s1">o </span><span class="s3">in </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">option_list</span><span class="s4">])</span>

        <span class="s0"># First, read the default values</span>
        <span class="s4">(</span><span class="s1">new_options</span><span class="s4">, </span><span class="s1">__</span><span class="s4">) = </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">([])</span>

        <span class="s0"># Second, parse the configuration</span>
        <span class="s3">for </span><span class="s1">opt </span><span class="s3">in </span><span class="s1">config</span><span class="s4">.</span><span class="s1">options</span><span class="s4">(</span><span class="s1">pycodestyle_section</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">'_'</span><span class="s4">, </span><span class="s5">'-'</span><span class="s4">) </span><span class="s3">not in </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">config_options</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">&quot;  unknown option '%s' ignored&quot; </span><span class="s4">% </span><span class="s1">opt</span><span class="s4">)</span>
                <span class="s3">continue</span>
            <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">verbose </span><span class="s4">&gt; </span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">print</span><span class="s4">(</span><span class="s5">&quot;  %s = %s&quot; </span><span class="s4">% (</span><span class="s1">opt</span><span class="s4">,</span>
                                     <span class="s1">config</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">pycodestyle_section</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">)))</span>
            <span class="s1">normalized_opt </span><span class="s4">= </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">'-'</span><span class="s4">, </span><span class="s5">'_'</span><span class="s4">)</span>
            <span class="s1">opt_type </span><span class="s4">= </span><span class="s1">option_list</span><span class="s4">[</span><span class="s1">normalized_opt</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">opt_type </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'int'</span><span class="s4">, </span><span class="s5">'count'</span><span class="s4">):</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s1">config</span><span class="s4">.</span><span class="s1">getint</span><span class="s4">(</span><span class="s1">pycodestyle_section</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">opt_type </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'store_true'</span><span class="s4">, </span><span class="s5">'store_false'</span><span class="s4">):</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s1">config</span><span class="s4">.</span><span class="s1">getboolean</span><span class="s4">(</span><span class="s1">pycodestyle_section</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s1">config</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">pycodestyle_section</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">normalized_opt </span><span class="s4">== </span><span class="s5">'exclude'</span><span class="s4">:</span>
                    <span class="s1">value </span><span class="s4">= </span><span class="s1">normalize_paths</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">local_dir</span><span class="s4">)</span>
            <span class="s1">setattr</span><span class="s4">(</span><span class="s1">new_options</span><span class="s4">, </span><span class="s1">normalized_opt</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>

        <span class="s0"># Third, overwrite with the command-line options</span>
        <span class="s4">(</span><span class="s1">options</span><span class="s4">, </span><span class="s1">__</span><span class="s4">) = </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">(</span><span class="s1">arglist</span><span class="s4">, </span><span class="s1">values</span><span class="s4">=</span><span class="s1">new_options</span><span class="s4">)</span>
    <span class="s1">options</span><span class="s4">.</span><span class="s1">doctest </span><span class="s4">= </span><span class="s1">options</span><span class="s4">.</span><span class="s1">testsuite </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s3">return </span><span class="s1">options</span>


<span class="s3">def </span><span class="s1">process_options</span><span class="s4">(</span><span class="s1">arglist</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">parse_argv</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">config_file</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
                    <span class="s1">parser</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Process options passed either via arglist or via command line args. 
 
    Passing in the ``config_file`` parameter allows other tools, such as flake8 
    to specify their own options to be processed in pycodestyle. 
    &quot;&quot;&quot;</span>
    <span class="s3">if not </span><span class="s1">parser</span><span class="s4">:</span>
        <span class="s1">parser </span><span class="s4">= </span><span class="s1">get_parser</span><span class="s4">()</span>
    <span class="s3">if not </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">has_option</span><span class="s4">(</span><span class="s5">'--config'</span><span class="s4">):</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">add_option_group</span><span class="s4">(</span><span class="s5">&quot;Configuration&quot;</span><span class="s4">, </span><span class="s1">description</span><span class="s4">=(</span>
            <span class="s5">&quot;The project options are read from the [%s] section of the &quot;</span>
            <span class="s5">&quot;tox.ini file or the setup.cfg file located in any parent folder &quot;</span>
            <span class="s5">&quot;of the path(s) being processed.  Allowed options are: %s.&quot; </span><span class="s4">%</span>
            <span class="s4">(</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">prog</span><span class="s4">, </span><span class="s5">', '</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">config_options</span><span class="s4">))))</span>
        <span class="s1">group</span><span class="s4">.</span><span class="s1">add_option</span><span class="s4">(</span><span class="s5">'--config'</span><span class="s4">, </span><span class="s1">metavar</span><span class="s4">=</span><span class="s5">'path'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">config_file</span><span class="s4">,</span>
                         <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;user config file location&quot;</span><span class="s4">)</span>
    <span class="s0"># Don't read the command line if the module is used as a library.</span>
    <span class="s3">if not </span><span class="s1">arglist </span><span class="s3">and not </span><span class="s1">parse_argv</span><span class="s4">:</span>
        <span class="s1">arglist </span><span class="s4">= []</span>
    <span class="s0"># If parse_argv is True and arglist is None, arguments are</span>
    <span class="s0"># parsed from the command line (sys.argv)</span>
    <span class="s4">(</span><span class="s1">options</span><span class="s4">, </span><span class="s1">args</span><span class="s4">) = </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">(</span><span class="s1">arglist</span><span class="s4">)</span>
    <span class="s1">options</span><span class="s4">.</span><span class="s1">reporter </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">ensure_value</span><span class="s4">(</span><span class="s5">'testsuite'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
        <span class="s1">args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">testsuite</span><span class="s4">)</span>
    <span class="s3">elif not </span><span class="s1">options</span><span class="s4">.</span><span class="s1">ensure_value</span><span class="s4">(</span><span class="s5">'doctest'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">parse_argv </span><span class="s3">and not </span><span class="s1">args</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">diff </span><span class="s3">or </span><span class="s1">any</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
                                   <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">PROJECT_CONFIG</span><span class="s4">):</span>
                <span class="s1">args </span><span class="s4">= [</span><span class="s5">'.'</span><span class="s4">]</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">parser</span><span class="s4">.</span><span class="s1">error</span><span class="s4">(</span><span class="s5">'input not specified'</span><span class="s4">)</span>
        <span class="s1">options </span><span class="s4">= </span><span class="s1">read_config</span><span class="s4">(</span><span class="s1">options</span><span class="s4">, </span><span class="s1">args</span><span class="s4">, </span><span class="s1">arglist</span><span class="s4">, </span><span class="s1">parser</span><span class="s4">)</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">reporter </span><span class="s4">= </span><span class="s1">parse_argv </span><span class="s3">and </span><span class="s1">options</span><span class="s4">.</span><span class="s1">quiet </span><span class="s4">== </span><span class="s6">1 </span><span class="s3">and </span><span class="s1">FileReport</span>

    <span class="s1">options</span><span class="s4">.</span><span class="s1">filename </span><span class="s4">= </span><span class="s1">_parse_multi_options</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">)</span>
    <span class="s1">options</span><span class="s4">.</span><span class="s1">exclude </span><span class="s4">= </span><span class="s1">normalize_paths</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">exclude</span><span class="s4">)</span>
    <span class="s1">options</span><span class="s4">.</span><span class="s1">select </span><span class="s4">= </span><span class="s1">_parse_multi_options</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">select</span><span class="s4">)</span>
    <span class="s1">options</span><span class="s4">.</span><span class="s1">ignore </span><span class="s4">= </span><span class="s1">_parse_multi_options</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">ignore</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">diff</span><span class="s4">:</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">reporter </span><span class="s4">= </span><span class="s1">DiffReport</span>
        <span class="s1">stdin </span><span class="s4">= </span><span class="s1">stdin_get_value</span><span class="s4">()</span>
        <span class="s1">options</span><span class="s4">.</span><span class="s1">selected_lines </span><span class="s4">= </span><span class="s1">parse_udiff</span><span class="s4">(</span><span class="s1">stdin</span><span class="s4">, </span><span class="s1">options</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">args</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
        <span class="s1">args </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">selected_lines</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">options</span><span class="s4">, </span><span class="s1">args</span>


<span class="s3">def </span><span class="s1">_parse_multi_options</span><span class="s4">(</span><span class="s1">options</span><span class="s4">, </span><span class="s1">split_token</span><span class="s4">=</span><span class="s5">','</span><span class="s4">):</span>
    <span class="s2">r&quot;&quot;&quot;Split and strip and discard empties. 
 
    Turns the following: 
 
    A, 
    B, 
 
    into [&quot;A&quot;, &quot;B&quot;] 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">options</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">o</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">() </span><span class="s3">for </span><span class="s1">o </span><span class="s3">in </span><span class="s1">options</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s1">split_token</span><span class="s4">) </span><span class="s3">if </span><span class="s1">o</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">options</span>


<span class="s3">def </span><span class="s1">_main</span><span class="s4">():</span>
    <span class="s2">&quot;&quot;&quot;Parse options and run checks on Python source.&quot;&quot;&quot;</span>
    <span class="s3">import </span><span class="s1">signal</span>

    <span class="s0"># Handle &quot;Broken pipe&quot; gracefully</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">signal</span><span class="s4">.</span><span class="s1">signal</span><span class="s4">(</span><span class="s1">signal</span><span class="s4">.</span><span class="s1">SIGPIPE</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">signum</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">: </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">exit</span><span class="s4">(</span><span class="s6">1</span><span class="s4">))</span>
    <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
        <span class="s3">pass    </span><span class="s0"># not supported on Windows</span>

    <span class="s1">style_guide </span><span class="s4">= </span><span class="s1">StyleGuide</span><span class="s4">(</span><span class="s1">parse_argv</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">options </span><span class="s4">= </span><span class="s1">style_guide</span><span class="s4">.</span><span class="s1">options</span>

    <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">doctest </span><span class="s3">or </span><span class="s1">options</span><span class="s4">.</span><span class="s1">testsuite</span><span class="s4">:</span>
        <span class="s3">from </span><span class="s1">testsuite</span><span class="s4">.</span><span class="s1">support </span><span class="s3">import </span><span class="s1">run_tests</span>
        <span class="s1">report </span><span class="s4">= </span><span class="s1">run_tests</span><span class="s4">(</span><span class="s1">style_guide</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">report </span><span class="s4">= </span><span class="s1">style_guide</span><span class="s4">.</span><span class="s1">check_files</span><span class="s4">()</span>

    <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">:</span>
        <span class="s1">report</span><span class="s4">.</span><span class="s1">print_statistics</span><span class="s4">()</span>

    <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">benchmark</span><span class="s4">:</span>
        <span class="s1">report</span><span class="s4">.</span><span class="s1">print_benchmark</span><span class="s4">()</span>

    <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">testsuite </span><span class="s3">and not </span><span class="s1">options</span><span class="s4">.</span><span class="s1">quiet</span><span class="s4">:</span>
        <span class="s1">report</span><span class="s4">.</span><span class="s1">print_results</span><span class="s4">()</span>

    <span class="s3">if </span><span class="s1">report</span><span class="s4">.</span><span class="s1">total_errors</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">count</span><span class="s4">:</span>
            <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">report</span><span class="s4">.</span><span class="s1">total_errors</span><span class="s4">) + </span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">exit</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>


<span class="s3">if </span><span class="s1">__name__ </span><span class="s4">== </span><span class="s5">'__main__'</span><span class="s4">:</span>
    <span class="s1">_main</span><span class="s4">()</span>
</pre>
</body>
</html>