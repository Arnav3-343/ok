<html>
<head>
<title>test_logger.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #7a7e85;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_logger.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Logger tests 
============ 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">pathlib</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">time</span>

<span class="s2">import </span><span class="s1">pytest</span>

<span class="s3"># Used to determine which tests must be skipped</span>
<span class="s1">LOG_MODE </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">environ</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;KIVY_LOG_MODE&quot;</span><span class="s4">, </span><span class="s5">&quot;KIVY&quot;</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">file_handler</span><span class="s4">():</span>
    <span class="s3"># restores handler to original state</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>

    <span class="s1">log_dir </span><span class="s4">= </span><span class="s1">Config</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;kivy&quot;</span><span class="s4">, </span><span class="s5">&quot;log_dir&quot;</span><span class="s4">)</span>
    <span class="s1">log_maxfiles </span><span class="s4">= </span><span class="s1">Config</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;kivy&quot;</span><span class="s4">, </span><span class="s5">&quot;log_maxfiles&quot;</span><span class="s4">)</span>

    <span class="s2">try</span><span class="s4">:</span>
        <span class="s2">yield None</span>
    <span class="s2">finally</span><span class="s4">:</span>
        <span class="s1">Config</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s5">&quot;kivy&quot;</span><span class="s4">, </span><span class="s5">&quot;log_dir&quot;</span><span class="s4">, </span><span class="s1">log_dir</span><span class="s4">)</span>
        <span class="s1">Config</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s5">&quot;kivy&quot;</span><span class="s4">, </span><span class="s5">&quot;log_maxfiles&quot;</span><span class="s4">, </span><span class="s1">log_maxfiles</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s5">&quot;n&quot;</span><span class="s4">, [</span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s6">5</span><span class="s4">])</span>
<span class="s2">def </span><span class="s1">test_purge_logs</span><span class="s4">(</span><span class="s1">tmp_path</span><span class="s4">, </span><span class="s1">file_handler</span><span class="s4">, </span><span class="s1">n</span><span class="s4">):</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">FileHandler</span>

    <span class="s1">Config</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s5">&quot;kivy&quot;</span><span class="s4">, </span><span class="s5">&quot;log_dir&quot;</span><span class="s4">, </span><span class="s1">str</span><span class="s4">(</span><span class="s1">tmp_path</span><span class="s4">))</span>
    <span class="s1">Config</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s5">&quot;kivy&quot;</span><span class="s4">, </span><span class="s5">&quot;log_maxfiles&quot;</span><span class="s4">, </span><span class="s1">n</span><span class="s4">)</span>

    <span class="s3"># create the default file first so it gets deleted so names match</span>
    <span class="s1">handler </span><span class="s4">= </span><span class="s1">FileHandler</span><span class="s4">()</span>
    <span class="s1">handler</span><span class="s4">.</span><span class="s1">_configure</span><span class="s4">()</span>
    <span class="s1">open_file </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">handler</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">).</span><span class="s1">name</span>
    <span class="s3"># wait a little so the timestamps are different for different files</span>
    <span class="s1">time</span><span class="s4">.</span><span class="s1">sleep</span><span class="s4">(</span><span class="s6">0.05</span><span class="s4">)</span>

    <span class="s1">names </span><span class="s4">= [</span><span class="s5">f&quot;log_</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">.txt&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">n </span><span class="s4">+ </span><span class="s6">2</span><span class="s4">)]</span>
    <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">names</span><span class="s4">:</span>
        <span class="s1">p </span><span class="s4">= </span><span class="s1">tmp_path </span><span class="s4">/ </span><span class="s1">name</span>
        <span class="s1">p</span><span class="s4">.</span><span class="s1">write_text</span><span class="s4">(</span><span class="s5">&quot;some data&quot;</span><span class="s4">)</span>
        <span class="s1">time</span><span class="s4">.</span><span class="s1">sleep</span><span class="s4">(</span><span class="s6">0.05</span><span class="s4">)</span>

    <span class="s1">handler</span><span class="s4">.</span><span class="s1">purge_logs</span><span class="s4">()</span>

    <span class="s3"># files that should have remained after purge</span>
    <span class="s1">expected_names </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">names</span><span class="s4">))[:</span><span class="s1">n</span><span class="s4">]</span>
    <span class="s1">files </span><span class="s4">= {</span><span class="s1">f</span><span class="s4">.</span><span class="s1">name </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">tmp_path</span><span class="s4">.</span><span class="s1">iterdir</span><span class="s4">()}</span>
    <span class="s2">if </span><span class="s1">open_file </span><span class="s2">in </span><span class="s1">files</span><span class="s4">:</span>
        <span class="s3"># one of the remaining files is the current open log, remove it</span>
        <span class="s1">files</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">open_file</span><span class="s4">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">expected_names</span><span class="s4">) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">files</span><span class="s4">) + </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3"># the open log may or may not have been counted in the remaining</span>
            <span class="s3"># files, remove one from expected to match removed open file</span>
            <span class="s1">expected_names </span><span class="s4">= </span><span class="s1">expected_names</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">]</span>

    <span class="s2">assert </span><span class="s1">set</span><span class="s4">(</span><span class="s1">expected_names</span><span class="s4">) == </span><span class="s1">files</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">xfail  </span><span class="s3"># Issue #7986 not yet fixed.</span>
<span class="s2">def </span><span class="s1">test_logger_history_size</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">Logger</span><span class="s4">, </span><span class="s1">LoggerHistory</span>

    <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range</span><span class="s4">(</span><span class="s6">200</span><span class="s4">):</span>
        <span class="s1">Logger</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">history</span><span class="s4">) == </span><span class="s6">100</span><span class="s4">, </span><span class="s5">&quot;Wrong size: %s&quot; </span><span class="s4">% </span><span class="s1">len</span><span class="s4">(</span>
        <span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">history</span>
    <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">!= </span><span class="s5">&quot;KIVY&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE==KIVY to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_trace_level</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Kivy logger defines a custom level of Trace.&quot;&quot;&quot;</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">Logger</span><span class="s4">, </span><span class="s1">LOG_LEVELS</span><span class="s4">, </span><span class="s1">LoggerHistory</span>
    <span class="s2">import </span><span class="s1">logging</span>

    <span class="s1">Logger</span><span class="s4">.</span><span class="s1">setLevel</span><span class="s4">(</span><span class="s6">9</span><span class="s4">)</span>

    <span class="s3"># Try different ways to trigger a trace:</span>
    <span class="s1">Logger</span><span class="s4">.</span><span class="s1">trace</span><span class="s4">(</span><span class="s5">&quot;test: This is trace message 1&quot;</span><span class="s4">)</span>
    <span class="s1">logging</span><span class="s4">.</span><span class="s1">log</span><span class="s4">(</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">TRACE</span><span class="s4">, </span><span class="s5">&quot;test: This is trace message 2&quot;</span><span class="s4">)</span>
    <span class="s1">Logger</span><span class="s4">.</span><span class="s1">log</span><span class="s4">(</span><span class="s1">LOG_LEVELS</span><span class="s4">[</span><span class="s5">&quot;trace&quot;</span><span class="s4">], </span><span class="s5">&quot;test: This is trace message 3&quot;</span><span class="s4">)</span>
    <span class="s3"># Not supported:</span>
    <span class="s3"># logging.trace('test: This is trace message 4')</span>

    <span class="s1">last_log_records </span><span class="s4">= </span><span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">history</span><span class="s4">[:</span><span class="s6">3</span><span class="s4">]</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s4">(</span><span class="s1">log_record</span><span class="s4">.</span><span class="s1">levelno </span><span class="s4">== </span><span class="s6">9 </span><span class="s2">for </span><span class="s1">log_record </span><span class="s2">in </span><span class="s1">last_log_records</span><span class="s4">), [</span>
        <span class="s1">log_record</span><span class="s4">.</span><span class="s1">levelno </span><span class="s2">for </span><span class="s1">log_record </span><span class="s2">in </span><span class="s1">last_log_records</span>
    <span class="s4">]</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">== </span><span class="s5">&quot;PYTHON&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE!=PYTHON to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_trace_level_has_level_name</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">Logger</span><span class="s4">, </span><span class="s1">LoggerHistory</span>

    <span class="s1">Logger</span><span class="s4">.</span><span class="s1">setLevel</span><span class="s4">(</span><span class="s6">9</span><span class="s4">)</span>
    <span class="s1">Logger</span><span class="s4">.</span><span class="s1">trace</span><span class="s4">(</span><span class="s5">&quot;test: This is trace message 1&quot;</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">history</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">levelname </span><span class="s4">== </span><span class="s5">&quot;TRACE&quot;</span>


<span class="s2">def </span><span class="s1">test_logging_does_not_deep_copy</span><span class="s4">():</span>
    <span class="s3"># If the Logger does a deep copy of an uncopyable</span>
    <span class="s3"># data structure, it will fail. See issues #7585 and #7528.</span>

    <span class="s2">import </span><span class="s1">threading</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">Logger</span>

    <span class="s2">class </span><span class="s1">UncopyableDatastructure</span><span class="s4">:</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_lock </span><span class="s4">= </span><span class="s1">threading</span><span class="s4">.</span><span class="s1">Lock</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_name </span><span class="s4">= </span><span class="s1">name</span>

        <span class="s2">def </span><span class="s1">__str__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
            <span class="s2">return </span><span class="s5">&quot;UncopyableDatastructure(name=%r)&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_name</span>

    <span class="s1">s </span><span class="s4">= </span><span class="s1">UncopyableDatastructure</span><span class="s4">(</span><span class="s5">&quot;Uncopyable&quot;</span><span class="s4">)</span>
    <span class="s1">Logger</span><span class="s4">.</span><span class="s1">error</span><span class="s4">(</span><span class="s5">&quot;The value of s is %s&quot;</span><span class="s4">, </span><span class="s1">s</span><span class="s4">)</span>


<span class="s2">def </span><span class="s1">configured_string_logging</span><span class="s4">(</span><span class="s1">unique_code</span><span class="s4">, </span><span class="s1">formatter</span><span class="s4">=</span><span class="s2">None</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Helper function provides logger configured to write to log_output. 
    &quot;&quot;&quot;</span>
    <span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">StringIO</span>

    <span class="s1">log_output </span><span class="s4">= </span><span class="s1">StringIO</span><span class="s4">()</span>

    <span class="s1">handler </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">StreamHandler</span><span class="s4">(</span><span class="s1">stream</span><span class="s4">=</span><span class="s1">log_output</span><span class="s4">)</span>
    <span class="s2">if </span><span class="s1">formatter</span><span class="s4">:</span>
        <span class="s1">handler</span><span class="s4">.</span><span class="s1">setFormatter</span><span class="s4">(</span><span class="s1">formatter</span><span class="s4">)</span>

    <span class="s1">logger </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">getLogger</span><span class="s4">(</span><span class="s5">&quot;tests.%s&quot; </span><span class="s4">% </span><span class="s1">unique_code</span><span class="s4">)</span>

    <span class="s3"># Do not escalate to root/Kivy loggers.</span>
    <span class="s1">logger</span><span class="s4">.</span><span class="s1">setLevel</span><span class="s4">(</span><span class="s6">9</span><span class="s4">)  </span><span class="s3"># Catch everything</span>
    <span class="s1">logger</span><span class="s4">.</span><span class="s1">propagate </span><span class="s4">= </span><span class="s2">False</span>
    <span class="s2">assert not </span><span class="s1">logger</span><span class="s4">.</span><span class="s1">hasHandlers</span><span class="s4">(), </span><span class="s5">&quot;Must use unique code between tests.&quot;</span>

    <span class="s1">logger</span><span class="s4">.</span><span class="s1">addHandler</span><span class="s4">(</span><span class="s1">handler</span><span class="s4">)</span>

    <span class="s2">return </span><span class="s1">logger</span><span class="s4">, </span><span class="s1">log_output</span>


<span class="s2">def </span><span class="s1">test_colonsplittinglogrecord_with_colon</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">ColonSplittingLogRecord</span>

    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s5">&quot;Part1: Part2: Part 3&quot;</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=(</span><span class="s5">&quot;args&quot;</span><span class="s4">,),</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3"># Just making sure we know what it looks like before.</span>
    <span class="s2">assert </span><span class="s4">(</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
        <span class="s4">== </span><span class="s5">'&lt;LogRecord: kivy.test, 10, test.py, 1, &quot;Part1: Part2: Part 3&quot;&gt;'</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">ColonSplittingLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s4">(</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">) == </span><span class="s5">&quot;&lt;LogRecord: kivy.test, 10, test.py, 1, &quot;</span>
        <span class="s5">'&quot;[Part1       ] Part2: Part 3&quot;&gt;'</span>
    <span class="s4">)</span>


<span class="s2">def </span><span class="s1">test_colonsplittinglogrecord_without_colon</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">ColonSplittingLogRecord</span>

    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s5">&quot;Part1 Part2 Part 3&quot;</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=(</span><span class="s5">&quot;args&quot;</span><span class="s4">,),</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">ColonSplittingLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s3"># No colons means no change.</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">)</span>

    <span class="s3"># Try a non-string (Issue #7984)</span>
    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">ColonSplittingLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s3"># No colons means no change.</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">)</span>


<span class="s2">def </span><span class="s1">test_uncoloredlogrecord_without_markup</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">UncoloredLogRecord</span>

    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s5">&quot;Part1: Part2 Part 3&quot;</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=(</span><span class="s5">&quot;args&quot;</span><span class="s4">,),</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">UncoloredLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s3"># No markup means no change.</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">)</span>

    <span class="s3"># Try a non-string (Issue #7984)</span>
    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">UncoloredLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">)</span>


<span class="s2">def </span><span class="s1">test_uncoloredlogrecord_with_markup</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">UncoloredLogRecord</span>

    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s5">&quot;Part1: $BOLDPart2$RESET Part 3&quot;</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=(</span><span class="s5">&quot;args&quot;</span><span class="s4">,),</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">UncoloredLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s3"># No markup means no change.</span>
    <span class="s2">assert </span><span class="s4">(</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">)</span>
        <span class="s4">== </span><span class="s5">'&lt;LogRecord: kivy.test, 10, test.py, 1, &quot;Part1: Part2 Part 3&quot;&gt;'</span>
    <span class="s4">)</span>


<span class="s2">def </span><span class="s1">test_coloredlogrecord_without_markup</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">ColoredLogRecord</span>

    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s5">&quot;Part1: Part2 Part 3&quot;</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=(</span><span class="s5">&quot;args&quot;</span><span class="s4">,),</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">ColoredLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s3"># The str() looks the same, because it doesn't include levelname.</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">)</span>
    <span class="s3"># But there is a change in the levelname</span>
    <span class="s2">assert </span><span class="s1">originallogrecord</span><span class="s4">.</span><span class="s1">levelname </span><span class="s4">!= </span><span class="s1">shimmedlogrecord</span><span class="s4">.</span><span class="s1">levelname</span>
    <span class="s2">assert </span><span class="s1">shimmedlogrecord</span><span class="s4">.</span><span class="s1">levelname </span><span class="s4">== </span><span class="s5">&quot;</span><span class="s2">\x1b</span><span class="s5">[1;36mDEBUG</span><span class="s2">\x1b</span><span class="s5">[0m&quot;</span>

    <span class="s3"># Try a non-string (Issue #7984)</span>
    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">DEBUG</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">ColoredLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">)</span>


<span class="s2">def </span><span class="s1">test_coloredlogrecord_with_markup</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">ColoredLogRecord</span>

    <span class="s1">originallogrecord </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">LogRecord</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">=</span><span class="s5">&quot;kivy.test&quot;</span><span class="s4">,</span>
        <span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">INFO</span><span class="s4">,</span>
        <span class="s1">pathname</span><span class="s4">=</span><span class="s5">&quot;test.py&quot;</span><span class="s4">,</span>
        <span class="s1">lineno</span><span class="s4">=</span><span class="s6">1</span><span class="s4">,</span>
        <span class="s1">msg</span><span class="s4">=</span><span class="s5">&quot;Part1: $BOLDPart2$RESET Part 3&quot;</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">=(</span><span class="s5">&quot;args&quot;</span><span class="s4">,),</span>
        <span class="s1">exc_info</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
        <span class="s1">func</span><span class="s4">=</span><span class="s5">&quot;test_colon_splitting&quot;</span><span class="s4">,</span>
        <span class="s1">sinfo</span><span class="s4">=</span><span class="s2">None</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">shimmedlogrecord </span><span class="s4">= </span><span class="s1">ColoredLogRecord</span><span class="s4">(</span><span class="s1">originallogrecord</span><span class="s4">)</span>
    <span class="s3"># Bolding has been added to message.</span>
    <span class="s2">assert </span><span class="s4">(</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">shimmedlogrecord</span><span class="s4">) == </span><span class="s5">&quot;&lt;LogRecord: kivy.test, 20, test.py, 1, &quot;</span>
        <span class="s5">'&quot;Part1: </span><span class="s2">\x1b</span><span class="s5">[1mPart2</span><span class="s2">\x1b</span><span class="s5">[0m Part 3&quot;&gt;'</span>
    <span class="s4">)</span>
    <span class="s3"># And there is a change in the levelname</span>
    <span class="s2">assert </span><span class="s1">originallogrecord</span><span class="s4">.</span><span class="s1">levelname </span><span class="s4">!= </span><span class="s1">shimmedlogrecord</span><span class="s4">.</span><span class="s1">levelname</span>
    <span class="s2">assert </span><span class="s1">shimmedlogrecord</span><span class="s4">.</span><span class="s1">levelname </span><span class="s4">== </span><span class="s5">&quot;</span><span class="s2">\x1b</span><span class="s5">[1;32mINFO</span><span class="s2">\x1b</span><span class="s5">[0m&quot;</span>


<span class="s2">def </span><span class="s1">test_kivyformatter_colon_no_color</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">KivyFormatter</span>

    <span class="s1">formatter </span><span class="s4">= </span><span class="s1">KivyFormatter</span><span class="s4">(</span><span class="s5">&quot;[%(levelname)-7s] %(message)s&quot;</span><span class="s4">, </span><span class="s1">use_color</span><span class="s4">=</span><span class="s2">False</span><span class="s4">)</span>
    <span class="s1">logger</span><span class="s4">, </span><span class="s1">log_output </span><span class="s4">= </span><span class="s1">configured_string_logging</span><span class="s4">(</span><span class="s5">&quot;1&quot;</span><span class="s4">, </span><span class="s1">formatter</span><span class="s4">)</span>
    <span class="s1">logger</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s5">&quot;Fancy: $BOLDmess$RESETage&quot;</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s1">log_output</span><span class="s4">.</span><span class="s1">getvalue</span><span class="s4">() == </span><span class="s5">&quot;[INFO   ] [Fancy       ] message</span><span class="s2">\n</span><span class="s5">&quot;</span>


<span class="s2">def </span><span class="s1">test_kivyformatter_colon_color</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">KivyFormatter</span>

    <span class="s1">formatter </span><span class="s4">= </span><span class="s1">KivyFormatter</span><span class="s4">(</span><span class="s5">&quot;[%(levelname)-18s] %(message)s&quot;</span><span class="s4">, </span><span class="s1">use_color</span><span class="s4">=</span><span class="s2">True</span><span class="s4">)</span>

    <span class="s1">logger</span><span class="s4">, </span><span class="s1">log_output </span><span class="s4">= </span><span class="s1">configured_string_logging</span><span class="s4">(</span><span class="s5">&quot;2&quot;</span><span class="s4">, </span><span class="s1">formatter</span><span class="s4">)</span>
    <span class="s1">logger</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s5">&quot;Fancy: $BOLDmess$RESETage&quot;</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s4">(</span>
        <span class="s1">log_output</span><span class="s4">.</span><span class="s1">getvalue</span><span class="s4">()</span>
        <span class="s4">== </span><span class="s5">&quot;[</span><span class="s2">\x1b</span><span class="s5">[1;32mINFO</span><span class="s2">\x1b</span><span class="s5">[0m   ] [Fancy       ] </span><span class="s2">\x1b</span><span class="s5">[1mmess</span><span class="s2">\x1b</span><span class="s5">[0mage</span><span class="s2">\n</span><span class="s5">&quot;</span>
    <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">logmodepython</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">logmodemixed</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">== </span><span class="s5">&quot;KIVY&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE!=KIVY to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_kivy_log_mode_marker_on</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot; 
    This is a test of the pytest markers. 
    This should only be invoked if the environment variable is appropriately set 
    (before pytest is run). 
 
    Also, tests that kivy.logger paid attention to the environment variable 
    &quot;&quot;&quot;</span>
    <span class="s2">assert </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">root</span><span class="s4">.</span><span class="s1">level </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;Root logger was modified&quot;</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">!= </span><span class="s5">&quot;KIVY&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE==KIVY to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_kivy_log_mode_marker_off</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot; 
    This is a test of the pytest markers. 
    This should only be invoked if the environment variable is properly set 
    (before pytest is run). 
 
    Also, tests that kivy.logger paid attention to the environment variable 
    &quot;&quot;&quot;</span>
    <span class="s2">assert </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">root</span><span class="s4">.</span><span class="s1">level </span><span class="s4">== </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;Root logger was not modified&quot;</span>


<span class="s3"># These tests are an overly-dramatic simulation of a third-party library's</span>
<span class="s3"># logging infrastructure.</span>
<span class="s3">#</span>
<span class="s3"># A handler is attached to the root-logger, which takes action when a</span>
<span class="s3"># critical message is logged.</span>


<span class="s2">class </span><span class="s1">NuclearReactorMonitoringHandler</span><span class="s4">(</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">Handler</span><span class="s4">):</span>
    <span class="s1">NUCLEAR_REACTOR_STATUS </span><span class="s4">= </span><span class="s5">&quot;Nominal&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">level</span><span class="s4">=</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">CRITICAL</span><span class="s4">)</span>

    <span class="s2">def </span><span class="s1">emit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">log_record</span><span class="s4">):</span>
        <span class="s3"># The fact that this was called means a critical log record</span>
        <span class="s3"># was created.</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">&quot;Please proceed immediately to the nearest exit.</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NUCLEAR_REACTOR_STATUS </span><span class="s4">= </span><span class="s5">&quot;Evacuated&quot;</span>


<span class="s2">def </span><span class="s1">simulate_evacuation</span><span class="s4">():</span>
    <span class="s1">logging</span><span class="s4">.</span><span class="s1">getLogger</span><span class="s4">().</span><span class="s1">addHandler</span><span class="s4">(</span><span class="s1">logging</span><span class="s4">.</span><span class="s1">StreamHandler</span><span class="s4">())</span>

    <span class="s1">handler </span><span class="s4">= </span><span class="s1">NuclearReactorMonitoringHandler</span><span class="s4">()</span>
    <span class="s1">logging</span><span class="s4">.</span><span class="s1">getLogger</span><span class="s4">().</span><span class="s1">addHandler</span><span class="s4">(</span><span class="s1">handler</span><span class="s4">)</span>

    <span class="s1">nuclear_core_logger </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">getLogger</span><span class="s4">(</span><span class="s5">&quot;powerstation.core&quot;</span><span class="s4">)</span>
    <span class="s1">nuclear_core_logger</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s5">&quot;Core temperature nominal&quot;</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s1">handler</span><span class="s4">.</span><span class="s1">NUCLEAR_REACTOR_STATUS </span><span class="s4">== </span><span class="s5">&quot;Nominal&quot;</span>
    <span class="s1">nuclear_core_logger</span><span class="s4">.</span><span class="s1">critical</span><span class="s4">(</span><span class="s5">&quot;Radioactive gas leak&quot;</span><span class="s4">)</span>
    <span class="s2">assert </span><span class="s1">handler</span><span class="s4">.</span><span class="s1">NUCLEAR_REACTOR_STATUS </span><span class="s4">== </span><span class="s5">&quot;Evacuated&quot;</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">logmodepython</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">logmodemixed</span>
<span class="s2">def </span><span class="s1">test_third_party_handlers_work</span><span class="s4">():</span>
    <span class="s3"># This should work under any mode.</span>
    <span class="s1">simulate_evacuation</span><span class="s4">()</span>


<span class="s2">def </span><span class="s1">are_regular_logs_handled</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">LoggerHistory</span>

    <span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">clear_history</span><span class="s4">()</span>
    <span class="s1">logging</span><span class="s4">.</span><span class="s1">getLogger</span><span class="s4">(</span><span class="s5">&quot;test&quot;</span><span class="s4">).</span><span class="s1">info</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
    <span class="s2">return </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">history</span><span class="s4">)</span>


<span class="s2">def </span><span class="s1">are_kivy_logger_logs_handled</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">LoggerHistory</span><span class="s4">, </span><span class="s1">Logger</span>

    <span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">clear_history</span><span class="s4">()</span>
    <span class="s1">Logger</span><span class="s4">.</span><span class="s1">info</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
    <span class="s2">return </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">history</span><span class="s4">)</span>


<span class="s2">def </span><span class="s1">is_stderr_output_handled</span><span class="s4">():</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">LoggerHistory</span>

    <span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">clear_history</span><span class="s4">()</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">&quot;Test output to stderr</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()</span>
    <span class="s2">return </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">LoggerHistory</span><span class="s4">.</span><span class="s1">history</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">!= </span><span class="s5">&quot;KIVY&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE==KIVY to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_kivy_mode_handlers</span><span class="s4">():</span>
    <span class="s2">assert </span><span class="s1">are_regular_logs_handled</span><span class="s4">()</span>
    <span class="s2">assert </span><span class="s1">are_kivy_logger_logs_handled</span><span class="s4">()</span>
    <span class="s3"># This line doesn't work because of pytest's handling of stderr.</span>
    <span class="s3"># Runs fine as stand-alone code.</span>
    <span class="s3"># assert is_stderr_output_handled()</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">logmodepython</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">!= </span><span class="s5">&quot;PYTHON&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE==PYTHON to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_python_mode_handlers</span><span class="s4">():</span>
    <span class="s2">assert not </span><span class="s1">are_regular_logs_handled</span><span class="s4">()</span>
    <span class="s2">assert not </span><span class="s1">are_kivy_logger_logs_handled</span><span class="s4">()</span>
    <span class="s2">assert not </span><span class="s1">is_stderr_output_handled</span><span class="s4">()</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">logmodemixed</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">!= </span><span class="s5">&quot;MIXED&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE==MIXED to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_mixed_mode_handlers</span><span class="s4">():</span>
    <span class="s2">assert not </span><span class="s1">are_regular_logs_handled</span><span class="s4">()</span>
    <span class="s2">assert </span><span class="s1">are_kivy_logger_logs_handled</span><span class="s4">()</span>
    <span class="s2">assert not </span><span class="s1">is_stderr_output_handled</span><span class="s4">()</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">logmodepython</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">LOG_MODE </span><span class="s4">!= </span><span class="s5">&quot;PYTHON&quot;</span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires KIVY_LOG_MODE==PYTHON to run.&quot;</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s2">def </span><span class="s1">test_logger_fix_8345</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot; 
    The test checks that the ConsoleHandler is not in the Logger 
    handlers list if stderr is None.  Test sets stderr to None, 
    if the Console handler is found, the test fails. 
    Pythonw and Pyinstaller 5.7+ (with console set to false) set stderr 
    to None. 
    &quot;&quot;&quot;</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s4">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">Logger</span><span class="s4">, </span><span class="s1">add_kivy_handlers</span><span class="s4">, </span><span class="s1">ConsoleHandler</span>
    <span class="s1">original_sys_stderr </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr </span><span class="s4">= </span><span class="s2">None</span>
    <span class="s1">add_kivy_handlers</span><span class="s4">(</span><span class="s1">Logger</span><span class="s4">)</span>
    <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr </span><span class="s4">= </span><span class="s1">original_sys_stderr  </span><span class="s3"># restore sys.stderr</span>
    <span class="s1">console_handler_found </span><span class="s4">= </span><span class="s1">any</span><span class="s4">(</span>
        <span class="s1">isinstance</span><span class="s4">(</span><span class="s1">handler</span><span class="s4">, </span><span class="s1">ConsoleHandler</span><span class="s4">) </span><span class="s2">for </span><span class="s1">handler </span><span class="s2">in </span><span class="s1">Logger</span><span class="s4">.</span><span class="s1">handlers</span>
    <span class="s4">)</span>
    <span class="s2">assert </span><span class="s4">(</span>
        <span class="s2">not </span><span class="s1">console_handler_found</span>
    <span class="s4">), </span><span class="s5">&quot;Console handler added, despite sys.stderr being None&quot;</span>
</pre>
</body>
</html>