<html>
<head>
<title>videoplayer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
videoplayer.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
Video player 
============ 
 
.. versionadded:: 1.2.0 
 
The video player widget can be used to play video and let the user control the 
play/pausing, volume and position. The widget cannot be customized much because 
of the complex assembly of numerous base widgets. 
 
.. image:: images/videoplayer.jpg 
    :align: center 
 
Annotations 
----------- 
 
If you want to display text at a specific time and for a certain duration, 
consider annotations. An annotation file has a &quot;.jsa&quot; extension. The player 
will automatically load the associated annotation file if it exists. 
 
An annotation file is JSON-based, providing a list of label dictionary items. 
The key and value must match one of the :class:`VideoPlayerAnnotation` items. 
For example, here is a short version of a jsa file that you can find in 
`examples/widgets/cityCC0.jsa`:: 
 
 
    [ 
        {&quot;start&quot;: 0, &quot;duration&quot;: 2, 
        &quot;text&quot;: &quot;This is an example of annotation&quot;}, 
        {&quot;start&quot;: 2, &quot;duration&quot;: 2, 
        &quot;bgcolor&quot;: [0.5, 0.2, 0.4, 0.5], 
        &quot;text&quot;: &quot;You can change the background color&quot;} 
    ] 
 
For our cityCC0.mpg example, the result will be: 
 
.. image:: images/videoplayer-annotation.jpg 
    :align: center 
 
If you want to experiment with annotation files, test with:: 
 
    python -m kivy.uix.videoplayer examples/widgets/cityCC0.mpg 
 
Fullscreen 
---------- 
 
The video player can play the video in fullscreen, if 
:attr:`VideoPlayer.allow_fullscreen` is activated by a double-tap on 
the video. By default, if the video is smaller than the Window, it will be not 
stretched. 
 
You can allow stretching by passing custom options to a 
:class:`VideoPlayer` instance:: 
 
    player = VideoPlayer(source='myvideo.avi', state='play', 
        options={'fit_mode': 'contain'}) 
 
End-of-stream behavior 
---------------------- 
 
You can specify what happens when the video has finished playing by passing an 
`eos` (end of stream) directive to the underlying 
:class:`~kivy.core.video.VideoBase` class. `eos` can be one of 'stop', 'pause' 
or 'loop' and defaults to 'stop'. For example, in order to loop the video:: 
 
    player = VideoPlayer(source='myvideo.avi', state='play', 
        options={'eos': 'loop'}) 
 
.. note:: 
 
    The `eos` property of the VideoBase class is a string specifying the 
    end-of-stream behavior. This property differs from the `eos` 
    properties of the :class:`VideoPlayer` and 
    :class:`~kivy.uix.video.Video` classes, whose `eos` 
    property is simply a boolean indicating that the end of the file has 
    been reached. 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'VideoPlayer'</span><span class="s2">, </span><span class="s3">'VideoPlayerAnnotation'</span><span class="s2">)</span>

<span class="s4">from </span><span class="s1">json </span><span class="s4">import </span><span class="s1">load</span>
<span class="s4">from </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path </span><span class="s4">import </span><span class="s1">exists</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">ObjectProperty</span><span class="s2">, </span><span class="s1">StringProperty</span><span class="s2">, </span><span class="s1">BooleanProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">DictProperty</span><span class="s2">, </span><span class="s1">OptionProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">animation </span><span class="s4">import </span><span class="s1">Animation</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">gridlayout </span><span class="s4">import </span><span class="s1">GridLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">floatlayout </span><span class="s4">import </span><span class="s1">FloatLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">progressbar </span><span class="s4">import </span><span class="s1">ProgressBar</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">label </span><span class="s4">import </span><span class="s1">Label</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">video </span><span class="s4">import </span><span class="s1">Video</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">video </span><span class="s4">import </span><span class="s1">Image</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">factory </span><span class="s4">import </span><span class="s1">Factory</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">logger </span><span class="s4">import </span><span class="s1">Logger</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">clock </span><span class="s4">import </span><span class="s1">Clock</span>


<span class="s4">class </span><span class="s1">VideoPlayerVolume</span><span class="s2">(</span><span class="s1">Image</span><span class="s2">):</span>
    <span class="s1">video </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s4">return False</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s5"># save the current volume and delta to it</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid</span><span class="s2">] = [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">volume</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s5"># calculate delta</span>
        <span class="s1">dy </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">oy</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">dy </span><span class="s2">&gt; </span><span class="s6">10</span><span class="s2">:</span>
            <span class="s1">dy </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">dy </span><span class="s2">- </span><span class="s6">10</span><span class="s2">, </span><span class="s6">100</span><span class="s2">)</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid</span><span class="s2">][</span><span class="s6">1</span><span class="s2">] = </span><span class="s1">dy</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">volume </span><span class="s2">= </span><span class="s1">dy </span><span class="s2">/ </span><span class="s6">100.</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ungrab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">dy </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">oy</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">dy </span><span class="s2">&lt; </span><span class="s6">10</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">volume </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">volume </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">volume </span><span class="s2">= </span><span class="s6">1.</span>


<span class="s4">class </span><span class="s1">VideoPlayerPlayPause</span><span class="s2">(</span><span class="s1">Image</span><span class="s2">):</span>
    <span class="s1">video </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s0">'''.. versionchanged:: 1.4.0'''</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">state </span><span class="s2">== </span><span class="s3">'play'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'pause'</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'play'</span>
            <span class="s4">return True</span>


<span class="s4">class </span><span class="s1">VideoPlayerStop</span><span class="s2">(</span><span class="s1">Image</span><span class="s2">):</span>
    <span class="s1">video </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'stop'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">position </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s4">return True</span>


<span class="s4">class </span><span class="s1">VideoPlayerProgressBar</span><span class="s2">(</span><span class="s1">ProgressBar</span><span class="s2">):</span>
    <span class="s1">video </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">seek </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">1.</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">VideoPlayerProgressBar</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble </span><span class="s2">= </span><span class="s1">Factory</span><span class="s2">.</span><span class="s1">Bubble</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s6">50</span><span class="s2">, </span><span class="s6">44</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble_label </span><span class="s2">= </span><span class="s1">Factory</span><span class="s2">.</span><span class="s1">Label</span><span class="s2">(</span><span class="s1">text</span><span class="s2">=</span><span class="s3">'0:00'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bubble_label</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bubble</span><span class="s2">)</span>

        <span class="s1">update </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_bubble</span>
        <span class="s1">fbind </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'pos'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'seek'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_video</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">position</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_bubble</span><span class="s2">,</span>
                        <span class="s1">state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_showhide_bubble</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_show_bubble</span><span class="s2">()</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_seek</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_seek</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ungrab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">seek </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_hide_bubble</span><span class="s2">()</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">_update_seek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">min</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">right</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)) - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">seek </span><span class="s2">= </span><span class="s1">x </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_show_bubble</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">alpha </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">Animation</span><span class="s2">.</span><span class="s1">stop_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'alpha'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_hide_bubble</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">alpha </span><span class="s2">= </span><span class="s6">1.</span>
        <span class="s1">Animation</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">d</span><span class="s2">=</span><span class="s6">4</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s3">'in_out_expo'</span><span class="s2">).</span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_alpha</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble</span><span class="s2">.</span><span class="s1">background_color </span><span class="s2">= (</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble_label</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= (</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_update_bubble</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s1">seek </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">seek</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">seek </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">duration </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">seek </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">seek </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">position </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">duration</span>
        <span class="s5"># convert to minutes:seconds</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">duration </span><span class="s2">* </span><span class="s1">seek</span>
        <span class="s1">minutes </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">d </span><span class="s2">/ </span><span class="s6">60</span><span class="s2">)</span>
        <span class="s1">seconds </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">d </span><span class="s2">- (</span><span class="s1">minutes </span><span class="s2">* </span><span class="s6">60</span><span class="s2">))</span>
        <span class="s5"># fix bubble label &amp; position</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble_label</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s3">'%d:%02d' </span><span class="s2">% (</span><span class="s1">minutes</span><span class="s2">, </span><span class="s1">seconds</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble</span><span class="s2">.</span><span class="s1">center_x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">seek </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bubble</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">top</span>

    <span class="s4">def </span><span class="s1">_showhide_bubble</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">value </span><span class="s2">== </span><span class="s3">'play'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_hide_bubble</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_show_bubble</span><span class="s2">()</span>


<span class="s4">class </span><span class="s1">VideoPlayerPreview</span><span class="s2">(</span><span class="s1">FloatLayout</span><span class="s2">):</span>
    <span class="s1">source </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">video </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">click_done </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">) </span><span class="s4">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">click_done</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">click_done </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">video</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'play'</span>
        <span class="s4">return True</span>


<span class="s4">class </span><span class="s1">VideoPlayerAnnotation</span><span class="s2">(</span><span class="s1">Label</span><span class="s2">):</span>
    <span class="s0">'''Annotation class used for creating annotation labels. 
 
    Additional keys are available: 
 
    * bgcolor: [r, g, b, a] - background color of the text box 
    * bgsource: 'filename' - background image used for the background text box 
    * border: (n, e, s, w) - border used for the background image 
 
    '''</span>
    <span class="s1">start </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Start time of the annotation. 
 
    :attr:`start` is a :class:`~kivy.properties.NumericProperty` and defaults 
    to 0. 
    '''</span>

    <span class="s1">duration </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
    <span class="s3">'''Duration of the annotation. 
 
    :attr:`duration` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 1. 
    '''</span>

    <span class="s1">annotation </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>

    <span class="s4">def </span><span class="s1">on_annotation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">ann</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">ann</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">VideoPlayer</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s0">'''VideoPlayer class. See module documentation for more information. 
    '''</span>

    <span class="s1">source </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
    <span class="s3">'''Source of the video to read. 
 
    :attr:`source` is a :class:`~kivy.properties.StringProperty` and 
    defaults to ''. 
 
    .. versionchanged:: 1.4.0 
    '''</span>

    <span class="s1">thumbnail </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
    <span class="s3">'''Thumbnail of the video to show. If None, VideoPlayer will try to find 
    the thumbnail from the :attr:`source` + '.png'. 
 
    :attr:`thumbnail` a :class:`~kivy.properties.StringProperty` and defaults 
    to ''. 
 
    .. versionchanged:: 1.4.0 
    '''</span>

    <span class="s1">duration </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">)</span>
    <span class="s3">'''Duration of the video. The duration defaults to -1 and is set to the 
    real duration when the video is loaded. 
 
    :attr:`duration` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to -1. 
    '''</span>

    <span class="s1">position </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Position of the video between 0 and :attr:`duration`. The position 
    defaults to -1 and is set to the real position when the video is loaded. 
 
    :attr:`position` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to -1. 
    '''</span>

    <span class="s1">volume </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">1.0</span><span class="s2">)</span>
    <span class="s3">'''Volume of the video in the range 0-1. 1 means full volume and 0 means 
    mute. 
 
    :attr:`volume` is a :class:`~kivy.properties.NumericProperty` and defaults 
    to 1. 
    '''</span>

    <span class="s1">state </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span><span class="s3">'stop'</span><span class="s2">, </span><span class="s1">options</span><span class="s2">=(</span><span class="s3">'play'</span><span class="s2">, </span><span class="s3">'pause'</span><span class="s2">, </span><span class="s3">'stop'</span><span class="s2">))</span>
    <span class="s3">'''String, indicates whether to play, pause, or stop the video:: 
 
        # start playing the video at creation 
        video = VideoPlayer(source='movie.mkv', state='play') 
 
        # create the video, and start later 
        video = VideoPlayer(source='movie.mkv') 
        # and later 
        video.state = 'play' 
 
    :attr:`state` is an :class:`~kivy.properties.OptionProperty` and defaults 
    to 'stop'. 
    '''</span>

    <span class="s1">play </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">, </span><span class="s1">deprecated</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">''' 
    .. deprecated:: 1.4.0 
        Use :attr:`state` instead. 
 
    Boolean, indicates whether the video is playing or not. You can start/stop 
    the video by setting this property:: 
 
        # start playing the video at creation 
        video = VideoPlayer(source='movie.mkv', play=True) 
 
        # create the video, and start later 
        video = VideoPlayer(source='movie.mkv') 
        # and later 
        video.play = True 
 
    :attr:`play` is a :class:`~kivy.properties.BooleanProperty` and defaults 
    to False. 
    '''</span>

    <span class="s1">image_overlay_play </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/player-play-overlay'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used to show a &quot;play&quot; overlay when the video has not yet 
    started. 
 
    :attr:`image_overlay_play` is a 
    :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/player-play-overlay'. 
 
    '''</span>

    <span class="s1">image_loading </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">'data/images/image-loading.zip'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used when the video is loading. 
 
    :attr:`image_loading` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'data/images/image-loading.zip'. 
    '''</span>

    <span class="s1">image_play </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/media-playback-start'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used for the &quot;Play&quot; button. 
 
    :attr:`image_play` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/media-playback-start'. 
    '''</span>

    <span class="s1">image_stop </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/media-playback-stop'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used for the &quot;Stop&quot; button. 
 
    :attr:`image_stop` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/media-playback-stop'. 
    '''</span>

    <span class="s1">image_pause </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/media-playback-pause'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used for the &quot;Pause&quot; button. 
 
    :attr:`image_pause` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/media-playback-pause'. 
    '''</span>

    <span class="s1">image_volumehigh </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/audio-volume-high'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used for the volume icon when the volume is high. 
 
    :attr:`image_volumehigh` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/audio-volume-high'. 
    '''</span>

    <span class="s1">image_volumemedium </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/audio-volume-medium'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used for the volume icon when the volume is medium. 
 
    :attr:`image_volumemedium` is a :class:`~kivy.properties.StringProperty` 
    and defaults to 'atlas://data/images/defaulttheme/audio-volume-medium'. 
    '''</span>

    <span class="s1">image_volumelow </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/audio-volume-low'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used for the volume icon when the volume is low. 
 
    :attr:`image_volumelow` is a :class:`~kivy.properties.StringProperty` 
    and defaults to 'atlas://data/images/defaulttheme/audio-volume-low'. 
    '''</span>

    <span class="s1">image_volumemuted </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/audio-volume-muted'</span><span class="s2">)</span>
    <span class="s3">'''Image filename used for the volume icon when the volume is muted. 
 
    :attr:`image_volumemuted` is a :class:`~kivy.properties.StringProperty` 
    and defaults to 'atlas://data/images/defaulttheme/audio-volume-muted'. 
    '''</span>

    <span class="s1">annotations </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
    <span class="s3">'''If set, it will be used for reading annotations box. 
 
    :attr:`annotations` is a :class:`~kivy.properties.StringProperty` 
    and defaults to ''. 
    '''</span>

    <span class="s1">fullscreen </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">'''Switch to fullscreen view. This should be used with care. When 
    activated, the widget will remove itself from its parent, remove all 
    children from the window and will add itself to it. When fullscreen is 
    unset, all the previous children are restored and the widget is restored to 
    its previous parent. 
 
    .. warning:: 
 
        The re-add operation doesn't care about the index position of its 
        children within the parent. 
 
    :attr:`fullscreen` is a :class:`~kivy.properties.BooleanProperty` 
    and defaults to False. 
    '''</span>

    <span class="s1">allow_fullscreen </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''By default, you can double-tap on the video to make it fullscreen. Set 
    this property to False to prevent this behavior. 
 
    :attr:`allow_fullscreen` is a :class:`~kivy.properties.BooleanProperty` 
    defaults to True. 
    '''</span>

    <span class="s1">options </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s3">'''Optional parameters can be passed to a :class:`~kivy.uix.video.Video` 
    instance with this property. 
 
    :attr:`options` a :class:`~kivy.properties.DictProperty` and 
    defaults to {}. 
    '''</span>

    <span class="s5"># internals</span>
    <span class="s1">container </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>

    <span class="s1">_video_load_ev </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_video </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_image </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations_labels </span><span class="s2">= []</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">VideoPlayer</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">update_thumbnail </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_thumbnail</span>
        <span class="s1">update_annotations </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_annotations</span>
        <span class="s1">fbind </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'thumbnail'</span><span class="s2">, </span><span class="s1">update_thumbnail</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'annotations'</span><span class="s2">, </span><span class="s1">update_annotations</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_video_load</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_trigger_video_load</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_video_load_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_video_load_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_do_video_load</span><span class="s2">,</span>
                                                           <span class="s2">-</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">ev</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_try_load_default_thumbnail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">thumbnail</span><span class="s2">:</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">thumbnail </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] + </span><span class="s3">'.png'</span>
            <span class="s4">if </span><span class="s1">exists</span><span class="s2">(</span><span class="s1">thumbnail</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_thumbnail</span><span class="s2">(</span><span class="s1">thumbnail</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_try_load_default_annotations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">annotations</span><span class="s2">:</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">annotations </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] + </span><span class="s3">'.jsa'</span>
            <span class="s4">if </span><span class="s1">exists</span><span class="s2">(</span><span class="s1">annotations</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_annotations</span><span class="s2">(</span><span class="s1">annotations</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_source</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s5"># By default, VideoPlayer should look for thumbnail and annotations</span>
        <span class="s5"># with the same filename (except extension) of the source (video) file.</span>
        <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_try_load_default_thumbnail</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_try_load_default_annotations</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_video </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">.</span><span class="s1">unload</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_video </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_video_load</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_update_thumbnail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_thumbnail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">thumbnail</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_update_annotations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_annotations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">annotations</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_image_overlay_play</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_image</span><span class="s2">.</span><span class="s1">image_overlay_play </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">on_image_loading</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_image</span><span class="s2">.</span><span class="s1">image_loading </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">_load_thumbnail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">thumbnail</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">.</span><span class="s1">clear_widgets</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">thumbnail</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_image </span><span class="s2">= </span><span class="s1">VideoPlayerPreview</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">thumbnail</span><span class="s2">, </span><span class="s1">video</span><span class="s2">=</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_image</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_load_annotations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">annotations</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations_labels </span><span class="s2">= []</span>
        <span class="s4">if </span><span class="s1">annotations</span><span class="s2">:</span>
            <span class="s4">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">annotations</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">) </span><span class="s4">as </span><span class="s1">fd</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations </span><span class="s2">= </span><span class="s1">load</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations</span><span class="s2">:</span>
                <span class="s4">for </span><span class="s1">ann </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations_labels</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                        <span class="s1">VideoPlayerAnnotation</span><span class="s2">(</span><span class="s1">annotation</span><span class="s2">=</span><span class="s1">ann</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">on_state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_video </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">_set_state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">_do_video_load</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_video </span><span class="s2">= </span><span class="s1">Video</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">, </span><span class="s1">state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">,</span>
                            <span class="s1">volume</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">volume</span><span class="s2">, </span><span class="s1">pos_hint</span><span class="s2">={</span><span class="s3">'x'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">},</span>
                            <span class="s2">**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">options</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">texture</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_play_started</span><span class="s2">,</span>
                         <span class="s1">duration</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'duration'</span><span class="s2">),</span>
                         <span class="s1">position</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'position'</span><span class="s2">),</span>
                         <span class="s1">volume</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'volume'</span><span class="s2">),</span>
                         <span class="s1">state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_set_state</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_play</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s3">'play' </span><span class="s4">if </span><span class="s1">value </span><span class="s4">else </span><span class="s3">'stop'</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_state</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_volume</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">.</span><span class="s1">volume </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">on_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">labels </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_annotations_labels</span>
        <span class="s4">if not </span><span class="s1">labels</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">for </span><span class="s1">label </span><span class="s4">in </span><span class="s1">labels</span><span class="s2">:</span>
            <span class="s1">start </span><span class="s2">= </span><span class="s1">label</span><span class="s2">.</span><span class="s1">start</span>
            <span class="s1">duration </span><span class="s2">= </span><span class="s1">label</span><span class="s2">.</span><span class="s1">duration</span>
            <span class="s4">if </span><span class="s1">start </span><span class="s2">&gt; </span><span class="s1">value </span><span class="s4">or </span><span class="s2">(</span><span class="s1">start </span><span class="s2">+ </span><span class="s1">duration</span><span class="s2">) &lt; </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">label</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">:</span>
                    <span class="s1">label</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">label</span><span class="s2">.</span><span class="s1">parent </span><span class="s4">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">seek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">percent</span><span class="s2">, </span><span class="s1">precise</span><span class="s2">=</span><span class="s4">True</span><span class="s2">):</span>
        <span class="s0">'''Change the position to a percentage (strictly, a proportion) 
           of duration. 
 
        :Parameters: 
            `percent`: float or int 
                Position to seek as a proportion of total duration, must 
                be between 0-1. 
            `precise`: bool, defaults to True 
                Precise seeking is slower, but seeks to exact requested 
                percent. 
 
        .. warning:: 
            Calling seek() before the video is loaded has no effect. 
 
        .. versionadded:: 1.2.0 
 
        .. versionchanged:: 1.10.1 
            The `precise` keyword argument has been added. 
        '''</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">percent</span><span class="s2">, </span><span class="s1">precise</span><span class="s2">=</span><span class="s1">precise</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_play_started</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">.</span><span class="s1">clear_widgets</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">container</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_video</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s4">return False</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">is_double_tap </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">allow_fullscreen</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fullscreen </span><span class="s2">= </span><span class="s4">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fullscreen</span>
            <span class="s4">return True</span>
        <span class="s4">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">VideoPlayer</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_fullscreen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">window </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_parent_window</span><span class="s2">()</span>
        <span class="s4">if not </span><span class="s1">window</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'VideoPlayer: Cannot switch to fullscreen, '</span>
                           <span class="s3">'window not found.'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fullscreen </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">return</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'VideoPlayer: Cannot switch to fullscreen, '</span>
                           <span class="s3">'no parent.'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fullscreen </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">return</span>

        <span class="s4">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_fullscreen_state </span><span class="s2">= </span><span class="s1">state </span><span class="s2">= {</span>
                <span class="s3">'parent'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">,</span>
                <span class="s3">'pos'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">,</span>
                <span class="s3">'size'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">,</span>
                <span class="s3">'pos_hint'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pos_hint</span><span class="s2">,</span>
                <span class="s3">'size_hint'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size_hint</span><span class="s2">,</span>
                <span class="s3">'window_children'</span><span class="s2">: </span><span class="s1">window</span><span class="s2">.</span><span class="s1">children</span><span class="s2">[:]}</span>

            <span class="s5"># remove all window children</span>
            <span class="s4">for </span><span class="s1">child </span><span class="s4">in </span><span class="s1">window</span><span class="s2">.</span><span class="s1">children</span><span class="s2">[:]:</span>
                <span class="s1">window</span><span class="s2">.</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">child</span><span class="s2">)</span>

            <span class="s5"># put the video in fullscreen</span>
            <span class="s4">if </span><span class="s1">state</span><span class="s2">[</span><span class="s3">'parent'</span><span class="s2">] </span><span class="s4">is not </span><span class="s1">window</span><span class="s2">:</span>
                <span class="s1">state</span><span class="s2">[</span><span class="s3">'parent'</span><span class="s2">].</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">window</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

            <span class="s5"># ensure the video widget is in 0, 0, and the size will be</span>
            <span class="s5"># readjusted</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= (</span><span class="s6">100</span><span class="s2">, </span><span class="s6">100</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pos_hint </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">size_hint </span><span class="s2">= (</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fullscreen_state</span>
            <span class="s1">window</span><span class="s2">.</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">child </span><span class="s4">in </span><span class="s1">state</span><span class="s2">[</span><span class="s3">'window_children'</span><span class="s2">]:</span>
                <span class="s1">window</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">child</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pos_hint </span><span class="s2">= </span><span class="s1">state</span><span class="s2">[</span><span class="s3">'pos_hint'</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">size_hint </span><span class="s2">= </span><span class="s1">state</span><span class="s2">[</span><span class="s3">'size_hint'</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= </span><span class="s1">state</span><span class="s2">[</span><span class="s3">'pos'</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">state</span><span class="s2">[</span><span class="s3">'size'</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">state</span><span class="s2">[</span><span class="s3">'parent'</span><span class="s2">] </span><span class="s4">is not </span><span class="s1">window</span><span class="s2">:</span>
                <span class="s1">state</span><span class="s2">[</span><span class="s3">'parent'</span><span class="s2">].</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s4">import </span><span class="s1">sys</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">base </span><span class="s4">import </span><span class="s1">runTouchApp</span>
    <span class="s1">player </span><span class="s2">= </span><span class="s1">VideoPlayer</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>
    <span class="s1">runTouchApp</span><span class="s2">(</span><span class="s1">player</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">player</span><span class="s2">:</span>
        <span class="s1">player</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s3">'stop'</span>
</pre>
</body>
</html>