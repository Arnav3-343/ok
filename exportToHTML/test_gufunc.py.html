<html>
<head>
<title>test_gufunc.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_gufunc.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">namedtuple</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">void</span><span class="s2">, </span><span class="s1">int32</span><span class="s2">, </span><span class="s1">float32</span><span class="s2">, </span><span class="s1">float64</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">guvectorize</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">cuda</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">skip_on_cudasim</span><span class="s2">, </span><span class="s1">CUDATestCase</span>
<span class="s0">import </span><span class="s1">unittest</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">NumbaPerformanceWarning</span><span class="s2">, </span><span class="s1">TypingError</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">support </span><span class="s0">import </span><span class="s1">override_config</span>


<span class="s0">def </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float32</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">[:, :], </span><span class="s1">dtype</span><span class="s2">[:, :], </span><span class="s1">dtype</span><span class="s2">[:, :])],</span>
                 <span class="s3">'(m,n),(n,p)-&gt;(m,p)'</span><span class="s2">,</span>
                 <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">matmulcore</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">):</span>
        <span class="s1">m</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">B</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">m</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">p</span><span class="s2">):</span>
                <span class="s1">C</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">] = </span><span class="s4">0</span>
                <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
                    <span class="s1">C</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">] += </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">k</span><span class="s2">] * </span><span class="s1">B</span><span class="s2">[</span><span class="s1">k</span><span class="s2">, </span><span class="s1">j</span><span class="s2">]</span>

    <span class="s0">return </span><span class="s1">matmulcore</span>


<span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s3">'ufunc API unsupported in the simulator'</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestCUDAGufunc</span><span class="s2">(</span><span class="s1">CUDATestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_gufunc_small</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">gufunc </span><span class="s2">= </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">()</span>

        <span class="s1">matrix_ct </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">2 </span><span class="s2">* </span><span class="s4">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">2</span><span class="s2">,</span>
                                                                   <span class="s4">4</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">4 </span><span class="s2">* </span><span class="s4">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">4</span><span class="s2">,</span>
                                                                   <span class="s4">5</span><span class="s2">)</span>

        <span class="s1">C </span><span class="s2">= </span><span class="s1">gufunc</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">Gold </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">C</span><span class="s2">, </span><span class="s1">Gold</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_gufunc_auto_transfer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">gufunc </span><span class="s2">= </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">()</span>

        <span class="s1">matrix_ct </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">2 </span><span class="s2">* </span><span class="s4">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">2</span><span class="s2">,</span>
                                                                   <span class="s4">4</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">4 </span><span class="s2">* </span><span class="s4">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">4</span><span class="s2">,</span>
                                                                   <span class="s4">5</span><span class="s2">)</span>

        <span class="s1">dB </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">B</span><span class="s2">)</span>

        <span class="s1">C </span><span class="s2">= </span><span class="s1">gufunc</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">dB</span><span class="s2">).</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">Gold </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">C</span><span class="s2">, </span><span class="s1">Gold</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_gufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">gufunc </span><span class="s2">= </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">()</span>

        <span class="s1">matrix_ct </span><span class="s2">= </span><span class="s4">1001 </span><span class="s5"># an odd number to test thread/block division in CUDA</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">2 </span><span class="s2">* </span><span class="s4">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">2</span><span class="s2">,</span>
                                                                   <span class="s4">4</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">4 </span><span class="s2">* </span><span class="s4">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">4</span><span class="s2">,</span>
                                                                   <span class="s4">5</span><span class="s2">)</span>

        <span class="s1">C </span><span class="s2">= </span><span class="s1">gufunc</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">Gold </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">C</span><span class="s2">, </span><span class="s1">Gold</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_gufunc_hidim</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">gufunc </span><span class="s2">= </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">()</span>

        <span class="s1">matrix_ct </span><span class="s2">= </span><span class="s4">100 </span><span class="s5"># an odd number to test thread/block division in CUDA</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">2 </span><span class="s2">* </span><span class="s4">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">4 </span><span class="s2">* </span><span class="s4">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>

        <span class="s1">C </span><span class="s2">= </span><span class="s1">gufunc</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">Gold </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">C</span><span class="s2">, </span><span class="s1">Gold</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_gufunc_new_axis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">gufunc </span><span class="s2">= </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float64</span><span class="s2">)</span>

        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">gold </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">gufunc</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">gold</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">)</span>

        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">gufunc</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)))</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">gold</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gufunc_stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">gufunc </span><span class="s2">= </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">()</span>

        <span class="s5">#cuda.driver.flush_pending_free()</span>
        <span class="s1">matrix_ct </span><span class="s2">= </span><span class="s4">1001 </span><span class="s5"># an odd number to test thread/block division in CUDA</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">2 </span><span class="s2">* </span><span class="s4">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">2</span><span class="s2">,</span>
                                                                   <span class="s4">4</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">matrix_ct </span><span class="s2">* </span><span class="s4">4 </span><span class="s2">* </span><span class="s4">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">matrix_ct</span><span class="s2">, </span><span class="s4">4</span><span class="s2">,</span>
                                                                   <span class="s4">5</span><span class="s2">)</span>

        <span class="s1">stream </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">dA </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">)</span>
        <span class="s1">dB </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">B</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">)</span>

        <span class="s1">dC </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s4">1001</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">A</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">stream</span><span class="s2">)</span>
        <span class="s1">dC </span><span class="s2">= </span><span class="s1">gufunc</span><span class="s2">(</span><span class="s1">dA</span><span class="s2">, </span><span class="s1">dB</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">dC</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">stream</span><span class="s2">)</span>
        <span class="s1">C </span><span class="s2">= </span><span class="s1">dC</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">=</span><span class="s1">stream</span><span class="s2">)</span>
        <span class="s1">stream</span><span class="s2">.</span><span class="s1">synchronize</span><span class="s2">()</span>

        <span class="s1">Gold </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">C</span><span class="s2">, </span><span class="s1">Gold</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])],</span>
                     <span class="s3">'(x)-&gt;(x)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">B</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_copy_unspecified_return</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Ensure that behaviour is correct when the return type is not</span>
        <span class="s5"># specified in the signature.</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])],</span>
                     <span class="s3">'(x)-&gt;(x)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">B</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_copy_odd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])],</span>
                     <span class="s3">'(x)-&gt;(x)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">B</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">11</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_copy2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:, :], </span><span class="s1">float32</span><span class="s2">[:, :])],</span>
                     <span class="s3">'(x, y)-&gt;(x, y)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy2d</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]):</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]):</span>
                    <span class="s1">B</span><span class="s2">[</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">30</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">copy2d</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_not_supported_call_from_jit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># not supported</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:])],</span>
                     <span class="s3">'(n)-&gt;(n)'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">gufunc_copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]):</span>
                <span class="s1">b</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">cuda_jit</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">gufunc_copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">1024 </span><span class="s2">* </span><span class="s4">32</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'int32'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Untyped global name 'gufunc_copy'.*&quot;</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaisesRegex</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">cuda_jit</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">](</span><span class="s1">A</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s5"># Test inefficient use of the GPU where the inputs are all mapped onto a</span>
    <span class="s5"># single thread in a single block.</span>
    <span class="s0">def </span><span class="s1">test_inefficient_launch_configuration</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s3">'void(float32[:], float32[:], float32[:])'</span><span class="s2">],</span>
                     <span class="s3">'(n),(n)-&gt;(n)'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">numba_dist_cuda</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">):</span>
            <span class="s1">len </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">):</span>
                <span class="s1">dist</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s1">b</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">1024 </span><span class="s2">* </span><span class="s4">32</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'float32'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">1024 </span><span class="s2">* </span><span class="s4">32</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'float32'</span><span class="s2">)</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'float32'</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">override_config</span><span class="s2">(</span><span class="s3">'CUDA_LOW_OCCUPANCY_WARNINGS'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">w</span><span class="s2">:</span>
                <span class="s1">numba_dist_cuda</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">category</span><span class="s2">, </span><span class="s1">NumbaPerformanceWarning</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'Grid size'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'low occupancy'</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_efficient_launch_configuration</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s3">'void(float32[:], float32[:], float32[:])'</span><span class="s2">],</span>
                     <span class="s3">'(n),(n)-&gt;(n)'</span><span class="s2">, </span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">numba_dist_cuda2</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">):</span>
            <span class="s1">len </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">):</span>
                <span class="s1">dist</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s1">b</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">524288 </span><span class="s2">* </span><span class="s4">2</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'float32'</span><span class="s2">).</span><span class="s1">\</span>
            <span class="s1">reshape</span><span class="s2">((</span><span class="s4">524288</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">524288 </span><span class="s2">* </span><span class="s4">2</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'float32'</span><span class="s2">).</span><span class="s1">\</span>
            <span class="s1">reshape</span><span class="s2">((</span><span class="s4">524288</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">override_config</span><span class="s2">(</span><span class="s3">'CUDA_LOW_OCCUPANCY_WARNINGS'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">w</span><span class="s2">:</span>
                <span class="s1">numba_dist_cuda2</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nopython_flag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s5"># nopython = True is fine</span>
        <span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])], </span><span class="s3">'(x)-&gt;(x)'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">,</span>
                    <span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">foo</span><span class="s2">)</span>

        <span class="s5"># nopython = False is bad</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])], </span><span class="s3">'(x)-&gt;(x)'</span><span class="s2">,</span>
                        <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">, </span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)(</span><span class="s1">foo</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s3">&quot;nopython flag must be True&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_invalid_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check invalid flags</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])], </span><span class="s3">'(x)-&gt;(x)'</span><span class="s2">,</span>
                        <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">, </span><span class="s1">what1</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">ever2</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)(</span><span class="s1">foo</span><span class="s2">)</span>
        <span class="s1">head </span><span class="s2">= </span><span class="s3">&quot;The following target options are not supported:&quot;</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">[:</span><span class="s1">len</span><span class="s2">(</span><span class="s1">head</span><span class="s2">)], </span><span class="s1">head</span><span class="s2">)</span>
        <span class="s1">items </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">head</span><span class="s2">):].</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">)</span>
        <span class="s1">items </span><span class="s2">= [</span><span class="s1">i</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">&quot;'</span><span class="s0">\&quot; </span><span class="s3">&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">items</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s3">'what1'</span><span class="s2">, </span><span class="s3">'ever2'</span><span class="s2">]), </span><span class="s1">set</span><span class="s2">(</span><span class="s1">items</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_duplicated_output</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])], </span><span class="s3">'(x)-&gt;(x)'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">):</span>
            <span class="s0">pass  </span><span class="s5"># intentionally empty; never executed</span>

        <span class="s1">inp </span><span class="s2">= </span><span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">foo</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;cannot specify argument 'out' as both positional and keyword&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">), </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_tuple_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([(</span><span class="s1">float64</span><span class="s2">[:], </span><span class="s1">float64</span><span class="s2">[:], </span><span class="s1">float64</span><span class="s2">[:])], </span><span class="s3">'(n),(n)-&gt;()'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">gu_reduce</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">r</span><span class="s2">):</span>
            <span class="s1">s </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)):</span>
                <span class="s1">s </span><span class="s2">+= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s1">y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">r</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">s</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">gu_reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">b</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tuple_of_tuple_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= ((</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= ((</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">5.5</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_tuple_arg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tuple_of_namedtuple_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">Point </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'Point'</span><span class="s2">, (</span><span class="s3">'x'</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">, </span><span class="s3">'z'</span><span class="s2">))</span>
        <span class="s1">a </span><span class="s2">= (</span><span class="s1">Point</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s4">2.0</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">3.0</span><span class="s2">),</span>
             <span class="s1">Point</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s4">4.0</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s4">5.0</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">6.0</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= (</span><span class="s1">Point</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s4">2.5</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">3.5</span><span class="s2">),</span>
             <span class="s1">Point</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s4">4.5</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s4">5.5</span><span class="s2">, </span><span class="s1">z</span><span class="s2">=</span><span class="s4">6.5</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_tuple_arg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tuple_of_array_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">((</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">)),</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">((</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">)))</span>
        <span class="s1">b </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">((</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">)),</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">((</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">5.5</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">)))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_tuple_arg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gufunc_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">gufunc </span><span class="s2">= </span><span class="s1">_get_matmulcore_gufunc</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">gufunc</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s3">'matmulcore'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_return_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">te</span><span class="s2">:</span>
            <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">int32</span><span class="s2">(</span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:])], </span><span class="s3">'(m)-&gt;(m)'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
            <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
                <span class="s0">pass</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">te</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'guvectorized functions cannot return values'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'specifies int32 return type'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_incorrect_number_of_pos_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([(</span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:])],</span>
                     <span class="s3">'(m),(m)-&gt;(m)'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>

        <span class="s5"># Inputs only, too few</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">te</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">te</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'gufunc accepts 2 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'or 3 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'Got 1 positional argument.'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s5"># Inputs and outputs, too many</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">te</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">te</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'gufunc accepts 2 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'or 3 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'Got 4 positional arguments.'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s3">'ufunc API unsupported in the simulator'</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestMultipleOutputs</span><span class="s2">(</span><span class="s1">CUDATestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_multiple_outputs_same_type_passed_in</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])],</span>
                     <span class="s3">'(x)-&gt;(x),(x)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">B</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">C</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">C </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">copy</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">C</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiple_outputs_distinct_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])],</span>
                     <span class="s3">'(x)-&gt;(x),(x)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy_and_double</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">B</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">C</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s4">2</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">C </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">copy_and_double</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A </span><span class="s2">* </span><span class="s4">2</span><span class="s2">, </span><span class="s1">C</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiple_output_allocation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:], </span><span class="s1">float32</span><span class="s2">[:])],</span>
                     <span class="s3">'(x)-&gt;(x),(x)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy_and_double</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">B</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">C</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s4">2</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B</span><span class="s2">, </span><span class="s1">C </span><span class="s2">= </span><span class="s1">copy_and_double</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A </span><span class="s2">* </span><span class="s4">2</span><span class="s2">, </span><span class="s1">C</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiple_output_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s1">void</span><span class="s2">(</span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">float64</span><span class="s2">[:])],</span>
                     <span class="s3">'(x)-&gt;(x),(x)'</span><span class="s2">,</span>
                     <span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">copy_and_multiply</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">B</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">B</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">C</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s4">1.5</span>

        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">C </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">copy_and_multiply</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">C</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">), </span><span class="s1">C</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_incorrect_number_of_pos_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([(</span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:], </span><span class="s1">int32</span><span class="s2">[:])],</span>
                     <span class="s3">'(m),(m)-&gt;(m),(m)'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">w</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>

        <span class="s5"># Inputs only, too few</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">te</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">te</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'gufunc accepts 2 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'or 4 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'Got 1 positional argument.'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s5"># Inputs and outputs, too many</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">te</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">te</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'gufunc accepts 2 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'or 4 positional arguments'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s3">'Got 5 positional arguments.'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>