<html>
<head>
<title>interpreter.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
interpreter.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">builtins</span>
<span class="s0">import </span><span class="s1">collections</span>
<span class="s0">import </span><span class="s1">dis</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">logging</span>
<span class="s0">import </span><span class="s1">textwrap</span>

<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">errors</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">, </span><span class="s1">config</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">NotDefinedError</span><span class="s2">, </span><span class="s1">UnsupportedError</span><span class="s2">, </span><span class="s1">error_extras</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">ir_utils </span><span class="s0">import </span><span class="s1">get_definition</span><span class="s2">, </span><span class="s1">guard</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">, </span><span class="s1">BINOPS_TO_OPERATORS</span><span class="s2">,</span>
                              <span class="s1">INPLACE_BINOPS_TO_OPERATORS</span><span class="s2">,)</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">byteflow </span><span class="s0">import </span><span class="s1">Flow</span><span class="s2">, </span><span class="s1">AdaptDFA</span><span class="s2">, </span><span class="s1">AdaptCFA</span><span class="s2">, </span><span class="s1">BlockKind</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">unsafe </span><span class="s0">import </span><span class="s1">eh</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cpython</span><span class="s2">.</span><span class="s1">unsafe</span><span class="s2">.</span><span class="s1">tuple </span><span class="s0">import </span><span class="s1">unpack_single_tuple</span>


<span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
    <span class="s4"># Operands for CALL_INTRINSIC_1</span>
    <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">byteflow </span><span class="s0">import </span><span class="s1">CALL_INTRINSIC_1_Operand </span><span class="s0">as </span><span class="s1">ci1op</span>
<span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
    <span class="s0">pass</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_UNKNOWN_VALUE</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Represents an unknown value, this is for ease of debugging purposes only. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">varname</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_varname </span><span class="s2">= </span><span class="s1">varname</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s6">&quot;_UNKNOWN_VALUE({})&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_varname</span><span class="s2">)</span>


<span class="s1">_logger </span><span class="s2">= </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s1">__name__</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Assigner</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    This object keeps track of potential assignment simplifications 
    inside a code block. 
    For example `$O.1 = x` followed by `y = $0.1` can be simplified 
    into `y = x`, but it's not possible anymore if we have `x = z` 
    in-between those two instructions. 
 
    NOTE: this is not only an optimization, but is actually necessary 
    due to certain limitations of Numba - such as only accepting the 
    returning of an array passed as function argument. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># { destination variable name -&gt; source Var object }</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dest_to_src </span><span class="s2">= {}</span>
        <span class="s4"># Basically a reverse mapping of dest_to_src:</span>
        <span class="s4"># { source variable name -&gt; all destination names in dest_to_src }</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">src_invalidate </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">list</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unused_dests </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">assign</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">srcvar</span><span class="s2">, </span><span class="s1">destvar</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Assign *srcvar* to *destvar*. Return either *srcvar* or a possible 
        simplified assignment source (earlier assigned to *srcvar*). 
        &quot;&quot;&quot;</span>
        <span class="s1">srcname </span><span class="s2">= </span><span class="s1">srcvar</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">destname </span><span class="s2">= </span><span class="s1">destvar</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s0">if </span><span class="s1">destname </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_invalidate</span><span class="s2">:</span>
            <span class="s4"># destvar will change, invalidate all previously known</span>
            <span class="s4"># simplifications</span>
            <span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_invalidate</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">destname</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">dest_to_src</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">srcname </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dest_to_src</span><span class="s2">:</span>
            <span class="s1">srcvar </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dest_to_src</span><span class="s2">[</span><span class="s1">srcname</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">destvar</span><span class="s2">.</span><span class="s1">is_temp</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dest_to_src</span><span class="s2">[</span><span class="s1">destname</span><span class="s2">] = </span><span class="s1">srcvar</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">src_invalidate</span><span class="s2">[</span><span class="s1">srcname</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">destname</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">unused_dests</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">destname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">srcvar</span>

    <span class="s0">def </span><span class="s1">get_assignment_source</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">destname</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get a possible assignment source (a ir.Var instance) to replace 
        *destname*, otherwise None. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">destname </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dest_to_src</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dest_to_src</span><span class="s2">[</span><span class="s1">destname</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unused_dests</span><span class="s2">.</span><span class="s1">discard</span><span class="s2">(</span><span class="s1">destname</span><span class="s2">)</span>
        <span class="s0">return None</span>


<span class="s0">def </span><span class="s1">_remove_assignment_definition</span><span class="s2">(</span><span class="s1">old_body</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Deletes the definition defined for old_body at index idx 
    from func_ir. We assume this stmt will be deleted from 
    new_body. 
 
    In some optimizations we may update the same variable multiple times. 
    In this situation, we only need to delete a particular definition once, 
    this is tracked in already_deleted_def, which is a map from 
    assignment name to the set of values that have already been 
    deleted. 
    &quot;&quot;&quot;</span>
    <span class="s1">lhs </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">].</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span>
    <span class="s1">rhs </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">].</span><span class="s1">value</span>
    <span class="s0">if </span><span class="s1">rhs </span><span class="s0">in </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">lhs</span><span class="s2">]:</span>
        <span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">lhs</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span>
        <span class="s1">already_deleted_defs</span><span class="s2">[</span><span class="s1">lhs</span><span class="s2">].</span><span class="s1">add</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">rhs </span><span class="s0">not in </span><span class="s1">already_deleted_defs</span><span class="s2">[</span><span class="s1">lhs</span><span class="s2">]:</span>
        <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span>
            <span class="s6">&quot;Inconsistency found in the definitions while executing&quot;</span>
            <span class="s6">&quot; a peephole optimization. This suggests an internal&quot;</span>
            <span class="s6">&quot; error or inconsistency elsewhere in the compiler.&quot;</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_call_function_ex_replace_kws_small</span><span class="s2">(</span>
    <span class="s1">old_body</span><span class="s2">,</span>
    <span class="s1">keyword_expr</span><span class="s2">,</span>
    <span class="s1">new_body</span><span class="s2">,</span>
    <span class="s1">buildmap_idx</span><span class="s2">,</span>
    <span class="s1">func_ir</span><span class="s2">,</span>
    <span class="s1">already_deleted_defs</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Extracts the kws args passed as varkwarg 
    for CALL_FUNCTION_EX. This pass is taken when 
    n_kws &lt;= 15 and the bytecode looks like: 
 
        # Start for each argument 
        LOAD_FAST  # Load each argument. 
        # End for each argument 
        ... 
        BUILD_CONST_KEY_MAP # Build a map 
 
    In the generated IR, the varkwarg refers 
    to a single build_map that contains all of the 
    kws. In addition to returning the kws, this 
    function updates new_body to remove all usage 
    of the map. 
    &quot;&quot;&quot;</span>
    <span class="s1">kws </span><span class="s2">= </span><span class="s1">keyword_expr</span><span class="s2">.</span><span class="s1">items</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s4"># kws are required to have constant keys.</span>
    <span class="s4"># We update these with the value_indexes</span>
    <span class="s1">value_indexes </span><span class="s2">= </span><span class="s1">keyword_expr</span><span class="s2">.</span><span class="s1">value_indexes</span>
    <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">index </span><span class="s0">in </span><span class="s1">value_indexes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s1">kws</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">[</span><span class="s1">index</span><span class="s2">][</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s4"># Remove the build_map by setting the list</span>
    <span class="s4"># index to None. Nones will be removed later.</span>
    <span class="s1">new_body</span><span class="s2">[</span><span class="s1">buildmap_idx</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s4"># Remove the definition.</span>
    <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
        <span class="s1">old_body</span><span class="s2">, </span><span class="s1">buildmap_idx</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">kws</span>


<span class="s0">def </span><span class="s1">_call_function_ex_replace_kws_large</span><span class="s2">(</span>
    <span class="s1">old_body</span><span class="s2">,</span>
    <span class="s1">buildmap_name</span><span class="s2">,</span>
    <span class="s1">buildmap_idx</span><span class="s2">,</span>
    <span class="s1">search_end</span><span class="s2">,</span>
    <span class="s1">new_body</span><span class="s2">,</span>
    <span class="s1">func_ir</span><span class="s2">,</span>
    <span class="s1">errmsg</span><span class="s2">,</span>
    <span class="s1">already_deleted_defs</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Extracts the kws args passed as varkwarg 
    for CALL_FUNCTION_EX. This pass is taken when 
    n_kws &gt; 15 and the bytecode looks like: 
 
        BUILD_MAP # Construct the map 
        # Start for each argument 
        LOAD_CONST # Load a constant for the name of the argument 
        LOAD_FAST  # Load each argument. 
        MAP_ADD # Append the (key, value) pair to the map 
        # End for each argument 
 
    In the IR generated, the initial build map is empty and a series 
    of setitems are applied afterwards. THE IR looks like: 
 
        $build_map_var = build_map(items=[]) 
        $constvar = const(str, ...) # create the const key 
        # CREATE THE ARGUMENT, This may take multiple lines. 
        $created_arg = ... 
        $var = getattr( 
            value=$build_map_var, 
            attr=__setitem__, 
        ) 
        $unused_var = call $var($constvar, $created_arg) 
 
    We iterate through the IR, deleting all usages of the buildmap 
    from the new_body, and adds the kws to a new kws list. 
    &quot;&quot;&quot;</span>
    <span class="s4"># Remove the build_map from the body.</span>
    <span class="s1">new_body</span><span class="s2">[</span><span class="s1">buildmap_idx</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s4"># Remove the definition.</span>
    <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
        <span class="s1">old_body</span><span class="s2">, </span><span class="s1">buildmap_idx</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
    <span class="s2">)</span>
    <span class="s1">kws </span><span class="s2">= []</span>
    <span class="s1">search_start </span><span class="s2">= </span><span class="s1">buildmap_idx </span><span class="s2">+ </span><span class="s3">1</span>
    <span class="s0">while </span><span class="s1">search_start </span><span class="s2">&lt;= </span><span class="s1">search_end</span><span class="s2">:</span>
        <span class="s4"># The first value must be a constant.</span>
        <span class="s1">const_stmt </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">search_start</span><span class="s2">]</span>
        <span class="s0">if not </span><span class="s2">(</span>
            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">const_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">const_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s4"># We cannot handle this format so raise the</span>
            <span class="s4"># original error message.</span>
            <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
        <span class="s1">key_var_name </span><span class="s2">= </span><span class="s1">const_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">key_val </span><span class="s2">= </span><span class="s1">const_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span>
        <span class="s1">search_start </span><span class="s2">+= </span><span class="s3">1</span>
        <span class="s4"># Now we need to search for a getattr with setitem</span>
        <span class="s1">found_getattr </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">while </span><span class="s2">(</span>
            <span class="s1">search_start </span><span class="s2">&lt;= </span><span class="s1">search_end</span>
            <span class="s0">and not </span><span class="s1">found_getattr</span>
        <span class="s2">):</span>
            <span class="s1">getattr_stmt </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">search_start</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s2">(</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">getattr_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;getattr&quot;</span>
                <span class="s0">and </span><span class="s2">(</span>
                    <span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span>
                    <span class="s2">== </span><span class="s1">buildmap_name</span>
                <span class="s2">)</span>
                <span class="s0">and </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">attr </span><span class="s2">== </span><span class="s6">&quot;__setitem__&quot;</span>
            <span class="s2">):</span>
                <span class="s1">found_getattr </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># If the argument is &quot;created&quot; in JIT, then there</span>
                <span class="s4"># will be intermediate operations in between setitems.</span>
                <span class="s4"># For example we have arg5=pow(arg5, 2),</span>
                <span class="s4"># then the IR would look like:</span>
                <span class="s4">#</span>
                <span class="s4">#   # Creation of the constant key.</span>
                <span class="s4">#   $const44.26 = const(str, arg5)</span>
                <span class="s4">#</span>
                <span class="s4">#   # Argument creation. This is the section we are skipping</span>
                <span class="s4">#   $46load_global.27 = global(pow: &lt;built-in function pow&gt;)</span>
                <span class="s4">#   $const50.29 = const(int, 2)</span>
                <span class="s4">#   $call.30 = call $46load_global.27(arg5, $const50.29)</span>
                <span class="s4">#</span>
                <span class="s4">#   # Setitem with arg5</span>
                <span class="s4">#   $54map_add.31 = getattr(value=$map.2, attr=__setitem__)</span>
                <span class="s4">#   $54map_add.32 = call $54map_add.31($const44.26, $call.30)</span>
                <span class="s1">search_start </span><span class="s2">+= </span><span class="s3">1</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s0">not </span><span class="s1">found_getattr</span>
            <span class="s0">or </span><span class="s1">search_start </span><span class="s2">== </span><span class="s1">search_end</span>
        <span class="s2">):</span>
            <span class="s4"># We cannot handle this format so raise the</span>
            <span class="s4"># original error message.</span>
            <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
        <span class="s1">setitem_stmt </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">search_start </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">if not </span><span class="s2">(</span>
            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">setitem_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">setitem_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">setitem_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;call&quot;</span>
            <span class="s0">and </span><span class="s2">(</span>
                <span class="s1">setitem_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">name</span>
                <span class="s2">== </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s2">)</span>
            <span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">setitem_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">2</span>
            <span class="s0">and </span><span class="s2">(</span>
                <span class="s1">setitem_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">name</span>
                <span class="s2">== </span><span class="s1">key_var_name</span>
            <span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s4"># A call statement should always immediately follow the</span>
            <span class="s4"># getattr. If for some reason this doesn't match the code</span>
            <span class="s4"># format, we raise the original error message. This check</span>
            <span class="s4"># is meant as a precaution.</span>
            <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
        <span class="s1">arg_var </span><span class="s2">= </span><span class="s1">setitem_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s4"># Append the (key, value) pair.</span>
        <span class="s1">kws</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">key_val</span><span class="s2">, </span><span class="s1">arg_var</span><span class="s2">))</span>
        <span class="s4"># Remove the __setitem__ getattr and call</span>
        <span class="s1">new_body</span><span class="s2">[</span><span class="s1">search_start</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s1">new_body</span><span class="s2">[</span><span class="s1">search_start </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s4"># Remove the definitions.</span>
        <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
            <span class="s1">old_body</span><span class="s2">, </span><span class="s1">search_start</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
        <span class="s2">)</span>
        <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
            <span class="s1">old_body</span><span class="s2">, </span><span class="s1">search_start </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
        <span class="s2">)</span>
        <span class="s1">search_start </span><span class="s2">+= </span><span class="s3">2</span>
    <span class="s0">return </span><span class="s1">kws</span>


<span class="s0">def </span><span class="s1">_call_function_ex_replace_args_small</span><span class="s2">(</span>
    <span class="s1">old_body</span><span class="s2">,</span>
    <span class="s1">tuple_expr</span><span class="s2">,</span>
    <span class="s1">new_body</span><span class="s2">,</span>
    <span class="s1">buildtuple_idx</span><span class="s2">,</span>
    <span class="s1">func_ir</span><span class="s2">,</span>
    <span class="s1">already_deleted_defs</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Extracts the args passed as vararg 
    for CALL_FUNCTION_EX. This pass is taken when 
    n_args &lt;= 30 and the bytecode looks like: 
 
        # Start for each argument 
        LOAD_FAST  # Load each argument. 
        # End for each argument 
        ... 
        BUILD_TUPLE # Create a tuple of the arguments 
 
    In the IR generated, the vararg refer 
    to a single build_tuple that contains all of the 
    args. In addition to returning the args, this 
    function updates new_body to remove all usage 
    of the tuple. 
    &quot;&quot;&quot;</span>
    <span class="s4"># Delete the build tuple</span>
    <span class="s1">new_body</span><span class="s2">[</span><span class="s1">buildtuple_idx</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s4"># Remove the definition.</span>
    <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
        <span class="s1">old_body</span><span class="s2">, </span><span class="s1">buildtuple_idx</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
    <span class="s2">)</span>
    <span class="s4"># Return the args.</span>
    <span class="s0">return </span><span class="s1">tuple_expr</span><span class="s2">.</span><span class="s1">items</span>


<span class="s0">def </span><span class="s1">_call_function_ex_replace_args_large</span><span class="s2">(</span>
    <span class="s1">old_body</span><span class="s2">,</span>
    <span class="s1">vararg_stmt</span><span class="s2">,</span>
    <span class="s1">new_body</span><span class="s2">,</span>
    <span class="s1">search_end</span><span class="s2">,</span>
    <span class="s1">func_ir</span><span class="s2">,</span>
    <span class="s1">errmsg</span><span class="s2">,</span>
    <span class="s1">already_deleted_defs</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Extracts the args passed as vararg 
    for CALL_FUNCTION_EX. This pass is taken when 
    n_args &gt; 30 and the bytecode looks like: 
 
        BUILD_TUPLE # Create a list to append to 
        # Start for each argument 
        LOAD_FAST  # Load each argument. 
        LIST_APPEND # Add the argument to the list 
        # End for each argument 
        ... 
        LIST_TO_TUPLE # Convert the args to a tuple. 
 
    In the IR generated, the tuple is created by concatenating 
    together several 1 element tuples to an initial empty tuple. 
    We traverse backwards in the IR, collecting args, until we 
    find the original empty tuple. For example, the IR might 
    look like: 
 
        $orig_tuple = build_tuple(items=[]) 
        $first_var = build_tuple(items=[Var(arg0, test.py:6)]) 
        $next_tuple = $orig_tuple + $first_var 
        ... 
        $final_var = build_tuple(items=[Var(argn, test.py:6)]) 
        $final_tuple = $prev_tuple + $final_var 
        $varargs_var = $final_tuple 
    &quot;&quot;&quot;</span>
    <span class="s4"># We traverse to the front of the block to look for the original</span>
    <span class="s4"># tuple.</span>
    <span class="s1">search_start </span><span class="s2">= </span><span class="s3">0</span>
    <span class="s1">total_args </span><span class="s2">= []</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">vararg_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
        <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">vararg_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">target_name </span><span class="s2">= </span><span class="s1">vararg_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s4"># If there is an initial assignment, delete it</span>
        <span class="s1">new_body</span><span class="s2">[</span><span class="s1">search_end</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s4"># Remove the definition.</span>
        <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
            <span class="s1">old_body</span><span class="s2">, </span><span class="s1">search_end</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
        <span class="s2">)</span>
        <span class="s1">search_end </span><span class="s2">-= </span><span class="s3">1</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s4"># There must always be an initial assignment</span>
        <span class="s4"># https://github.com/numba/numba/blob/59fa2e335be68148b3bd72a29de3ff011430038d/numba/core/interpreter.py#L259-L260</span>
        <span class="s4"># If this changes we may need to support this branch.</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s6">&quot;unreachable&quot;</span><span class="s2">)</span>
    <span class="s4"># Traverse backwards to find all concatenations</span>
    <span class="s4"># until eventually reaching the original empty tuple.</span>
    <span class="s0">while </span><span class="s1">search_end </span><span class="s2">&gt;= </span><span class="s1">search_start</span><span class="s2">:</span>
        <span class="s1">concat_stmt </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">search_end</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">concat_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">target_name</span>
            <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;build_tuple&quot;</span>
            <span class="s0">and not </span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span>
        <span class="s2">):</span>
            <span class="s1">new_body</span><span class="s2">[</span><span class="s1">search_end</span><span class="s2">] = </span><span class="s0">None</span>
            <span class="s4"># Remove the definition.</span>
            <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
                <span class="s1">old_body</span><span class="s2">, </span><span class="s1">search_end</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
            <span class="s2">)</span>
            <span class="s4"># If we have reached the build_tuple we exit.</span>
            <span class="s0">break</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># We expect to find another arg to append.</span>
            <span class="s4"># The first stmt must be a binop &quot;add&quot;</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">search_end </span><span class="s2">== </span><span class="s1">search_start</span><span class="s2">) </span><span class="s0">or not </span><span class="s2">(</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">concat_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s2">(</span>
                    <span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span>
                    <span class="s2">== </span><span class="s1">target_name</span>
                <span class="s2">)</span>
                <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span>
                    <span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span>
                <span class="s2">)</span>
                <span class="s0">and </span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;binop&quot;</span>
                <span class="s0">and </span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">fn </span><span class="s2">== </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">add</span>
            <span class="s2">):</span>
                <span class="s4"># We cannot handle this format.</span>
                <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
            <span class="s1">lhs_name </span><span class="s2">= </span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s1">rhs_name </span><span class="s2">= </span><span class="s1">concat_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s4"># The previous statement should be a</span>
            <span class="s4"># build_tuple containing the arg.</span>
            <span class="s1">arg_tuple_stmt </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">search_end </span><span class="s2">- </span><span class="s3">1</span><span class="s2">]</span>
            <span class="s0">if not </span><span class="s2">(</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg_tuple_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span>
                    <span class="s1">arg_tuple_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span>
                <span class="s2">)</span>
                <span class="s0">and </span><span class="s2">(</span>
                    <span class="s1">arg_tuple_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op</span>
                    <span class="s2">== </span><span class="s6">&quot;build_tuple&quot;</span>
                <span class="s2">)</span>
                <span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">arg_tuple_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">) == </span><span class="s3">1</span>
            <span class="s2">):</span>
                <span class="s4"># We cannot handle this format.</span>
                <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">arg_tuple_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">lhs_name</span><span class="s2">:</span>
                <span class="s4"># The tuple should always be generated on the RHS.</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s6">&quot;unreachable&quot;</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">arg_tuple_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">rhs_name</span><span class="s2">:</span>
                <span class="s1">target_name </span><span class="s2">= </span><span class="s1">lhs_name</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># We cannot handle this format.</span>
                <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
            <span class="s1">total_args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s1">arg_tuple_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s2">)</span>
            <span class="s1">new_body</span><span class="s2">[</span><span class="s1">search_end</span><span class="s2">] = </span><span class="s0">None</span>
            <span class="s1">new_body</span><span class="s2">[</span><span class="s1">search_end </span><span class="s2">- </span><span class="s3">1</span><span class="s2">] = </span><span class="s0">None</span>
            <span class="s4"># Remove the definitions.</span>
            <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
                <span class="s1">old_body</span><span class="s2">, </span><span class="s1">search_end</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
            <span class="s2">)</span>
            <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
                <span class="s1">old_body</span><span class="s2">, </span><span class="s1">search_end </span><span class="s2">- </span><span class="s3">1</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
            <span class="s2">)</span>
            <span class="s1">search_end </span><span class="s2">-= </span><span class="s3">2</span>
            <span class="s4"># Avoid any space between appends</span>
            <span class="s1">keep_looking </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">while </span><span class="s1">search_end </span><span class="s2">&gt;= </span><span class="s1">search_start </span><span class="s0">and </span><span class="s1">keep_looking</span><span class="s2">:</span>
                <span class="s1">next_stmt </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">search_end</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">next_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                    <span class="s0">and </span><span class="s2">(</span>
                        <span class="s1">next_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span>
                        <span class="s2">== </span><span class="s1">target_name</span>
                    <span class="s2">)</span>
                <span class="s2">):</span>
                    <span class="s1">keep_looking </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s4"># If the argument is &quot;created&quot; in JIT, then there</span>
                    <span class="s4"># will be intermediate operations in between appends.</span>
                    <span class="s4"># For example if the next arg after arg4 is pow(arg5, 2),</span>
                    <span class="s4"># then the IR would look like:</span>
                    <span class="s4">#</span>
                    <span class="s4">#   # Appending arg4</span>
                    <span class="s4">#   $arg4_tup = build_tuple(items=[arg4])</span>
                    <span class="s4">#   $append_var.5 = $append_var.4 + $arg4_tup</span>
                    <span class="s4">#</span>
                    <span class="s4">#   # Creation of arg5.</span>
                    <span class="s4">#   # This is the section that we are skipping.</span>
                    <span class="s4">#   $32load_global.20 = global(pow: &lt;built-in function pow&gt;)</span>
                    <span class="s4">#   $const36.22 = const(int, 2)</span>
                    <span class="s4">#   $call.23 = call $32load_global.20(arg5, $const36.22)</span>
                    <span class="s4">#</span>
                    <span class="s4">#   # Appending arg5</span>
                    <span class="s4">#   $arg5_tup = build_tuple(items=[$call.23])</span>
                    <span class="s4">#   $append_var.6 = $append_var.5 + $arg5_tup</span>
                    <span class="s1">search_end </span><span class="s2">-= </span><span class="s3">1</span>
    <span class="s0">if </span><span class="s1">search_end </span><span class="s2">== </span><span class="s1">search_start</span><span class="s2">:</span>
        <span class="s4"># If we reached the start we never found the build_tuple.</span>
        <span class="s4"># We cannot handle this format so raise the</span>
        <span class="s4"># original error message.</span>
        <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
    <span class="s4"># Reverse the arguments so we get the correct order.</span>
    <span class="s0">return </span><span class="s1">total_args</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">peep_hole_call_function_ex_to_call_function_kw</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    This peephole rewrites a bytecode sequence unique to Python 3.10 
    where CALL_FUNCTION_EX is used instead of CALL_FUNCTION_KW because of 
    stack limitations set by CPython. This limitation is imposed whenever 
    a function call has too many arguments or keyword arguments. 
 
    https://github.com/python/cpython/blob/a58ebcc701dd6c43630df941481475ff0f615a81/Python/compile.c#L55 
    https://github.com/python/cpython/blob/a58ebcc701dd6c43630df941481475ff0f615a81/Python/compile.c#L4442 
 
    In particular, this change is imposed whenever (n_args / 2) + n_kws &gt; 15. 
 
    Different bytecode is generated for args depending on if n_args &gt; 30 
    or n_args &lt;= 30 and similarly if n_kws &gt; 15 or n_kws &lt;= 15. 
 
    This function unwraps the *args and **kwargs in the function call 
    and places these values directly into the args and kwargs of the call. 
    &quot;&quot;&quot;</span>
    <span class="s4"># All changes are local to the a single block</span>
    <span class="s4"># so it can be traversed in any order.</span>
    <span class="s1">errmsg </span><span class="s2">= </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s6">&quot;&quot;&quot; 
        CALL_FUNCTION_EX with **kwargs not supported. 
        If you are not using **kwargs this may indicate that 
        you have a large number of kwargs and are using inlined control 
        flow. You can resolve this issue by moving the control flow out of 
        the function call. For example, if you have 
 
            f(a=1 if flag else 0, ...) 
 
        Replace that with: 
 
            a_val = 1 if flag else 0 
            f(a=a_val, ...)&quot;&quot;&quot;</span><span class="s2">)</span>

    <span class="s4"># Track which definitions have already been deleted</span>
    <span class="s1">already_deleted_defs </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">set</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
        <span class="s1">blk_changed </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">new_body </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">stmt </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s2">(</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;call&quot;</span>
                <span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">varkwarg </span><span class="s0">is not None</span>
            <span class="s2">):</span>
                <span class="s1">blk_changed </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s1">call </span><span class="s2">= </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span>
                <span class="s1">args </span><span class="s2">= </span><span class="s1">call</span><span class="s2">.</span><span class="s1">args</span>
                <span class="s1">kws </span><span class="s2">= </span><span class="s1">call</span><span class="s2">.</span><span class="s1">kws</span>
                <span class="s4"># We need to check the call expression contents if</span>
                <span class="s4"># it contains either vararg or varkwarg. If it contains</span>
                <span class="s4"># varkwarg we need to update the IR. If it just contains</span>
                <span class="s4"># vararg we don't need to update the IR, but we need to</span>
                <span class="s4"># check if peep_hole_list_to_tuple failed to replace the</span>
                <span class="s4"># vararg list with a tuple. If so, we output an error</span>
                <span class="s4"># message with suggested code changes.</span>
                <span class="s1">vararg </span><span class="s2">= </span><span class="s1">call</span><span class="s2">.</span><span class="s1">vararg</span>
                <span class="s1">varkwarg </span><span class="s2">= </span><span class="s1">call</span><span class="s2">.</span><span class="s1">varkwarg</span>
                <span class="s1">start_search </span><span class="s2">= </span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span>
                <span class="s4"># varkwarg should be defined second so we start there.</span>
                <span class="s1">varkwarg_loc </span><span class="s2">= </span><span class="s1">start_search</span>
                <span class="s1">keyword_def </span><span class="s2">= </span><span class="s0">None</span>
                <span class="s1">found </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s0">while </span><span class="s1">varkwarg_loc </span><span class="s2">&gt;= </span><span class="s3">0 </span><span class="s0">and not </span><span class="s1">found</span><span class="s2">:</span>
                    <span class="s1">keyword_def </span><span class="s2">= </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">varkwarg_loc</span><span class="s2">]</span>
                    <span class="s0">if </span><span class="s2">(</span>
                        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">keyword_def</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">keyword_def</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">varkwarg</span><span class="s2">.</span><span class="s1">name</span>
                    <span class="s2">):</span>
                        <span class="s1">found </span><span class="s2">= </span><span class="s0">True</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">varkwarg_loc </span><span class="s2">-= </span><span class="s3">1</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">kws</span>
                    <span class="s0">or not </span><span class="s1">found</span>
                    <span class="s0">or not </span><span class="s2">(</span>
                        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">keyword_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">keyword_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;build_map&quot;</span>
                    <span class="s2">)</span>
                <span class="s2">):</span>
                    <span class="s4"># If we couldn't find where the kwargs are created</span>
                    <span class="s4"># then it should be a normal **kwargs call</span>
                    <span class="s4"># so we produce an unsupported message.</span>
                    <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
                <span class="s4"># Determine the kws</span>
                <span class="s0">if </span><span class="s1">keyword_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">:</span>
                    <span class="s4"># n_kws &lt;= 15 case.</span>
                    <span class="s4"># Here the IR looks like a series of</span>
                    <span class="s4"># constants, then the arguments and finally</span>
                    <span class="s4"># a build_map that contains all of the pairs.</span>
                    <span class="s4"># For Example:</span>
                    <span class="s4">#</span>
                    <span class="s4">#   $const_n = const(&quot;arg_name&quot;)</span>
                    <span class="s4">#   $arg_n = ...</span>
                    <span class="s4">#   $kwargs_var = build_map(items=[</span>
                    <span class="s4">#              ($const_0, $arg_0),</span>
                    <span class="s4">#              ...,</span>
                    <span class="s4">#              ($const_n, $arg_n),])</span>
                    <span class="s1">kws </span><span class="s2">= </span><span class="s1">_call_function_ex_replace_kws_small</span><span class="s2">(</span>
                        <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">,</span>
                        <span class="s1">keyword_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
                        <span class="s1">new_body</span><span class="s2">,</span>
                        <span class="s1">varkwarg_loc</span><span class="s2">,</span>
                        <span class="s1">func_ir</span><span class="s2">,</span>
                        <span class="s1">already_deleted_defs</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s4"># n_kws &gt; 15 case.</span>
                    <span class="s4"># Here the IR is an initial empty build_map</span>
                    <span class="s4"># followed by a series of setitems with a constant</span>
                    <span class="s4"># key and then the argument.</span>
                    <span class="s4"># For example:</span>
                    <span class="s4">#</span>
                    <span class="s4">#   $kwargs_var = build_map(items=[])</span>
                    <span class="s4">#   $const_0 = const(&quot;arg_name&quot;)</span>
                    <span class="s4">#   $arg_0 = ...</span>
                    <span class="s4">#   $my_attr = getattr(const_0, attr=__setitem__)</span>
                    <span class="s4">#   $unused_var = call $my_attr($const_0, $arg_0)</span>
                    <span class="s4">#   ...</span>
                    <span class="s1">kws </span><span class="s2">= </span><span class="s1">_call_function_ex_replace_kws_large</span><span class="s2">(</span>
                        <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">,</span>
                        <span class="s1">varkwarg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
                        <span class="s1">varkwarg_loc</span><span class="s2">,</span>
                        <span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">,</span>
                        <span class="s1">new_body</span><span class="s2">,</span>
                        <span class="s1">func_ir</span><span class="s2">,</span>
                        <span class="s1">errmsg</span><span class="s2">,</span>
                        <span class="s1">already_deleted_defs</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s1">start_search </span><span class="s2">= </span><span class="s1">varkwarg_loc</span>
                <span class="s4"># Vararg isn't required to be provided.</span>
                <span class="s0">if </span><span class="s1">vararg </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">args</span><span class="s2">:</span>
                        <span class="s4"># If we have vararg then args is expected to</span>
                        <span class="s4"># be an empty list.</span>
                        <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
                    <span class="s1">vararg_loc </span><span class="s2">= </span><span class="s1">start_search</span>
                    <span class="s1">args_def </span><span class="s2">= </span><span class="s0">None</span>
                    <span class="s1">found </span><span class="s2">= </span><span class="s0">False</span>
                    <span class="s0">while </span><span class="s1">vararg_loc </span><span class="s2">&gt;= </span><span class="s3">0 </span><span class="s0">and not </span><span class="s1">found</span><span class="s2">:</span>
                        <span class="s1">args_def </span><span class="s2">= </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">vararg_loc</span><span class="s2">]</span>
                        <span class="s0">if </span><span class="s2">(</span>
                            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args_def</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                            <span class="s0">and </span><span class="s1">args_def</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">vararg</span><span class="s2">.</span><span class="s1">name</span>
                        <span class="s2">):</span>
                            <span class="s1">found </span><span class="s2">= </span><span class="s0">True</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">vararg_loc </span><span class="s2">-= </span><span class="s3">1</span>
                    <span class="s0">if not </span><span class="s1">found</span><span class="s2">:</span>
                        <span class="s4"># If we couldn't find where the args are created</span>
                        <span class="s4"># then we can't handle this format.</span>
                        <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s2">(</span>
                        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">args_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;build_tuple&quot;</span>
                    <span class="s2">):</span>
                        <span class="s4"># n_args &lt;= 30 case.</span>
                        <span class="s4"># Here the IR is a simple build_tuple containing</span>
                        <span class="s4"># all of the args.</span>
                        <span class="s4"># For example:</span>
                        <span class="s4">#</span>
                        <span class="s4">#  $arg_n = ...</span>
                        <span class="s4">#  $varargs = build_tuple(</span>
                        <span class="s4">#   items=[$arg_0, ..., $arg_n]</span>
                        <span class="s4">#  )</span>
                        <span class="s1">args </span><span class="s2">= </span><span class="s1">_call_function_ex_replace_args_small</span><span class="s2">(</span>
                            <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">,</span>
                            <span class="s1">args_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
                            <span class="s1">new_body</span><span class="s2">,</span>
                            <span class="s1">vararg_loc</span><span class="s2">,</span>
                            <span class="s1">func_ir</span><span class="s2">,</span>
                            <span class="s1">already_deleted_defs</span><span class="s2">,</span>
                        <span class="s2">)</span>
                    <span class="s0">elif </span><span class="s2">(</span>
                        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">args_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;list_to_tuple&quot;</span>
                    <span class="s2">):</span>
                        <span class="s4"># If there is a call with vararg we need to check</span>
                        <span class="s4"># if the list -&gt; tuple conversion failed and if so</span>
                        <span class="s4"># throw an error.</span>
                        <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s4"># Here the IR is an initial empty build_tuple.</span>
                        <span class="s4"># Then for each arg, a new tuple with a single</span>
                        <span class="s4"># element is created and one by one these are</span>
                        <span class="s4"># added to a growing tuple.</span>
                        <span class="s4"># For example:</span>
                        <span class="s4">#</span>
                        <span class="s4">#  $combo_tup_0 = build_tuple(items=[])</span>
                        <span class="s4">#  $arg0 = ...</span>
                        <span class="s4">#  $arg0_tup = build_tuple(items=[$arg0])</span>
                        <span class="s4">#  $combo_tup_1 = $combo_tup_0 + $arg0_tup</span>
                        <span class="s4">#  $arg1 = ...</span>
                        <span class="s4">#  $arg1_tup = build_tuple(items=[$arg1])</span>
                        <span class="s4">#  $combo_tup_2 = $combo_tup_1 + $arg1_tup</span>
                        <span class="s4">#  ...</span>
                        <span class="s4">#  $combo_tup_n = $combo_tup_{n-1} + $argn_tup</span>
                        <span class="s4">#</span>
                        <span class="s4"># In addition, the IR contains a final</span>
                        <span class="s4"># assignment for the varargs that looks like:</span>
                        <span class="s4">#</span>
                        <span class="s4">#  $varargs_var = $combo_tup_n</span>
                        <span class="s4">#</span>
                        <span class="s4"># Here args_def is expected to be a simple assignment.</span>
                        <span class="s1">args </span><span class="s2">= </span><span class="s1">_call_function_ex_replace_args_large</span><span class="s2">(</span>
                            <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">,</span>
                            <span class="s1">args_def</span><span class="s2">,</span>
                            <span class="s1">new_body</span><span class="s2">,</span>
                            <span class="s1">vararg_loc</span><span class="s2">,</span>
                            <span class="s1">func_ir</span><span class="s2">,</span>
                            <span class="s1">errmsg</span><span class="s2">,</span>
                            <span class="s1">already_deleted_defs</span><span class="s2">,</span>
                        <span class="s2">)</span>
                <span class="s4"># Create a new call updating the args and kws</span>
                <span class="s1">new_call </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
                    <span class="s1">call</span><span class="s2">.</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">, </span><span class="s1">call</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s1">call</span><span class="s2">.</span><span class="s1">target</span>
                <span class="s2">)</span>
                <span class="s4"># Drop the existing definition for this stmt.</span>
                <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
                    <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
                <span class="s2">)</span>
                <span class="s4"># Update the statement</span>
                <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">new_call</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s4"># Update the definition</span>
                <span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">new_call</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s2">(</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;call&quot;</span>
                <span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">vararg </span><span class="s0">is not None</span>
            <span class="s2">):</span>
                <span class="s4"># If there is a call with vararg we need to check</span>
                <span class="s4"># if the list -&gt; tuple conversion failed and if so</span>
                <span class="s4"># throw an error.</span>
                <span class="s1">call </span><span class="s2">= </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span>
                <span class="s1">vararg_name </span><span class="s2">= </span><span class="s1">call</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">.</span><span class="s1">name</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">vararg_name </span><span class="s0">in </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span>
                    <span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">vararg_name</span><span class="s2">]) == </span><span class="s3">1</span>
                <span class="s2">):</span>
                    <span class="s4"># If this value is still a list to tuple raise the</span>
                    <span class="s4"># exception.</span>
                    <span class="s1">expr </span><span class="s2">= </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">vararg_name</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;list_to_tuple&quot;</span><span class="s2">:</span>
                        <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>

            <span class="s1">new_body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
        <span class="s4"># Replace the block body if we changed the IR</span>
        <span class="s0">if </span><span class="s1">blk_changed</span><span class="s2">:</span>
            <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
            <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">new_body </span><span class="s0">if </span><span class="s1">x </span><span class="s0">is not None</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">func_ir</span>


<span class="s0">def </span><span class="s1">peep_hole_list_to_tuple</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    This peephole rewrites a bytecode sequence new to Python 3.9 that looks 
    like e.g.: 
 
    def foo(a): 
        return (*a,) 
 
    41          0 BUILD_LIST               0 
                2 LOAD_FAST                0 (a) 
                4 LIST_EXTEND              1 
                6 LIST_TO_TUPLE 
                8 RETURN_VAL 
 
    essentially, the unpacking of tuples is written as a list which is appended 
    to/extended and then &quot;magicked&quot; into a tuple by the new LIST_TO_TUPLE 
    opcode. 
 
    This peephole repeatedly analyses the bytecode in a block looking for a 
    window between a `LIST_TO_TUPLE` and `BUILD_LIST` and... 
 
    1. Turns the BUILD_LIST into a BUILD_TUPLE 
    2. Sets an accumulator's initial value as the target of the BUILD_TUPLE 
    3. Searches for 'extend' on the original list and turns these into binary 
       additions on the accumulator. 
    4. Searches for 'append' on the original list and turns these into a 
       `BUILD_TUPLE` which is then appended via binary addition to the 
       accumulator. 
    5. Assigns the accumulator to the variable that exits the peephole and the 
       rest of the block/code refers to as the result of the unpack operation. 
    6. Patches up 
    &quot;&quot;&quot;</span>
    <span class="s1">_DEBUG </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s4"># For all blocks</span>
    <span class="s0">for </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s4"># keep doing the peephole rewrite until nothing is left that matches</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s4"># first try and find a matching region</span>
            <span class="s4"># i.e. BUILD_LIST...&lt;stuff&gt;...LIST_TO_TUPLE</span>
            <span class="s0">def </span><span class="s1">find_postive_region</span><span class="s2">():</span>
                <span class="s1">found </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">))):</span>
                    <span class="s1">stmt </span><span class="s2">= </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
                        <span class="s1">value </span><span class="s2">= </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span>
                        <span class="s0">if </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">) </span><span class="s0">and</span>
                                <span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">'list_to_tuple'</span><span class="s2">):</span>
                            <span class="s1">target_list </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">info</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
                            <span class="s1">found </span><span class="s2">= </span><span class="s0">True</span>
                            <span class="s1">bt </span><span class="s2">= (</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">found</span><span class="s2">:</span>
                        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
                            <span class="s0">if </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">target_list</span><span class="s2">:</span>
                                <span class="s1">region </span><span class="s2">= (</span><span class="s1">bt</span><span class="s2">, (</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">))</span>
                                <span class="s0">return </span><span class="s1">region</span>

            <span class="s1">region </span><span class="s2">= </span><span class="s1">find_postive_region</span><span class="s2">()</span>
            <span class="s4"># if there's a peep hole region then do something with it</span>
            <span class="s0">if </span><span class="s1">region </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">peep_hole </span><span class="s2">= </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">region</span><span class="s2">[</span><span class="s3">1</span><span class="s2">][</span><span class="s3">0</span><span class="s2">] : </span><span class="s1">region</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]]</span>
                <span class="s0">if </span><span class="s1">_DEBUG</span><span class="s2">:</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s6">&quot;</span><span class="s0">\n</span><span class="s6">WINDOW:&quot;</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">peep_hole</span><span class="s2">:</span>
                        <span class="s1">print</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s6">&quot;&quot;</span><span class="s2">)</span>

                <span class="s1">appends </span><span class="s2">= []</span>
                <span class="s1">extends </span><span class="s2">= []</span>
                <span class="s1">init </span><span class="s2">= </span><span class="s1">region</span><span class="s2">[</span><span class="s3">1</span><span class="s2">][</span><span class="s3">1</span><span class="s2">]</span>
                <span class="s1">const_list </span><span class="s2">= </span><span class="s1">init</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span>
                <span class="s4"># Walk through the peep_hole and find things that are being</span>
                <span class="s4"># &quot;extend&quot;ed and &quot;append&quot;ed to the BUILD_LIST</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">peep_hole</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
                        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">):</span>
                            <span class="s1">expr </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">value</span>
                            <span class="s0">if </span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">'getattr' </span><span class="s0">and</span>
                                    <span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">const_list</span><span class="s2">):</span>
                                <span class="s4"># it's not strictly necessary to split out</span>
                                <span class="s4"># extends and appends, but it helps with</span>
                                <span class="s4"># debugging to do so!</span>
                                <span class="s0">if </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">attr </span><span class="s2">== </span><span class="s6">'extend'</span><span class="s2">:</span>
                                    <span class="s1">extends</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                                <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">attr </span><span class="s2">== </span><span class="s6">'append'</span><span class="s2">:</span>
                                    <span class="s1">appends</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                                <span class="s0">else</span><span class="s2">:</span>
                                    <span class="s0">assert </span><span class="s3">0</span>
                <span class="s4"># go back through the peep hole build new IR based on it.</span>
                <span class="s1">new_hole </span><span class="s2">= []</span>

                <span class="s0">def </span><span class="s1">append_and_fix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
                    <span class="s5">&quot;&quot;&quot; Adds to the new_hole and fixes up definitions&quot;&quot;&quot;</span>
                    <span class="s1">new_hole</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">:</span>
                        <span class="s4"># if there's already a definition, drop it, should only</span>
                        <span class="s4"># be 1 as the way cpython emits the sequence for</span>
                        <span class="s4"># `list_to_tuple` should ensure this.</span>
                        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]) == </span><span class="s3">1</span>
                        <span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">clear</span><span class="s2">()</span>
                    <span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

                <span class="s1">the_build_list </span><span class="s2">= </span><span class="s1">init</span><span class="s2">.</span><span class="s1">target</span>

                <span class="s4"># Do the transform on the peep hole</span>
                <span class="s0">if </span><span class="s1">_DEBUG</span><span class="s2">:</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s6">&quot;</span><span class="s0">\n</span><span class="s6">BLOCK:&quot;</span><span class="s2">)</span>
                    <span class="s1">blk</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">()</span>

                <span class="s4"># This section basically accumulates list appends and extends</span>
                <span class="s4"># as binop(+) on tuples, it drops all the getattr() for extend</span>
                <span class="s4"># and append as they are now dead and replaced with binop(+).</span>
                <span class="s4"># It also switches out the build_list for a build_tuple and then</span>
                <span class="s4"># ensures everything is wired up and defined ok.</span>
                <span class="s1">t2l_agn </span><span class="s2">= </span><span class="s1">region</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s3">1</span><span class="s2">]</span>
                <span class="s1">acc </span><span class="s2">= </span><span class="s1">the_build_list</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">peep_hole</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
                        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">):</span>
                            <span class="s1">expr </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">value</span>
                            <span class="s0">if </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">'getattr'</span><span class="s2">:</span>
                                <span class="s0">if </span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">extends </span><span class="s0">or</span>
                                        <span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">appends</span><span class="s2">):</span>
                                    <span class="s4"># drop definition, it's being wholesale</span>
                                    <span class="s4"># replaced.</span>
                                    <span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                                    <span class="s0">continue</span>
                                <span class="s0">else</span><span class="s2">:</span>
                                    <span class="s4"># a getattr on something we're not</span>
                                    <span class="s4"># interested in</span>
                                    <span class="s1">new_hole</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                            <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">'call'</span><span class="s2">:</span>
                                <span class="s1">fname </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">name</span>
                                <span class="s0">if </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">extends </span><span class="s0">or </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">appends</span><span class="s2">:</span>
                                    <span class="s1">arg </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
                                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">):</span>
                                        <span class="s1">tmp_name </span><span class="s2">= </span><span class="s6">&quot;%s_var_%s&quot; </span><span class="s2">% (</span><span class="s1">fname</span><span class="s2">,</span>
                                                                  <span class="s1">arg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                                        <span class="s0">if </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">appends</span><span class="s2">:</span>
                                            <span class="s1">bt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_tuple</span><span class="s2">([</span><span class="s1">arg</span><span class="s2">,],</span>
                                                                     <span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                                        <span class="s0">else</span><span class="s2">:</span>
                                            <span class="s4"># Extend as tuple</span>
                                            <span class="s1">gv_tuple </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span>
                                                <span class="s1">name</span><span class="s2">=</span><span class="s6">&quot;tuple&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">tuple</span><span class="s2">,</span>
                                                <span class="s1">loc</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                                            <span class="s2">)</span>
                                            <span class="s1">tuple_var </span><span class="s2">= </span><span class="s1">arg</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">redefine</span><span class="s2">(</span>
                                                <span class="s6">&quot;$_list_extend_gv_tuple&quot;</span><span class="s2">,</span>
                                                <span class="s1">loc</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                                            <span class="s2">)</span>
                                            <span class="s1">new_hole</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                                                <span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span>
                                                    <span class="s1">target</span><span class="s2">=</span><span class="s1">tuple_var</span><span class="s2">,</span>
                                                    <span class="s1">value</span><span class="s2">=</span><span class="s1">gv_tuple</span><span class="s2">,</span>
                                                    <span class="s1">loc</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                                                <span class="s2">),</span>
                                            <span class="s2">)</span>
                                            <span class="s1">bt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
                                                <span class="s1">tuple_var</span><span class="s2">, (</span><span class="s1">arg</span><span class="s2">,), (),</span>
                                                <span class="s1">loc</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                                            <span class="s2">)</span>
                                        <span class="s1">var </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">tmp_name</span><span class="s2">,</span>
                                                     <span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                                        <span class="s1">asgn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">bt</span><span class="s2">, </span><span class="s1">var</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                                        <span class="s1">append_and_fix</span><span class="s2">(</span><span class="s1">asgn</span><span class="s2">)</span>
                                        <span class="s1">arg </span><span class="s2">= </span><span class="s1">var</span>

                                    <span class="s4"># this needs to be a binary add</span>
                                    <span class="s1">new </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">binop</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">=</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">add</span><span class="s2">,</span>
                                                        <span class="s1">lhs</span><span class="s2">=</span><span class="s1">acc</span><span class="s2">,</span>
                                                        <span class="s1">rhs</span><span class="s2">=</span><span class="s1">arg</span><span class="s2">,</span>
                                                        <span class="s1">loc</span><span class="s2">=</span><span class="s1">x</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                                    <span class="s1">asgn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">new</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                                    <span class="s1">append_and_fix</span><span class="s2">(</span><span class="s1">asgn</span><span class="s2">)</span>
                                    <span class="s1">acc </span><span class="s2">= </span><span class="s1">asgn</span><span class="s2">.</span><span class="s1">target</span>
                                <span class="s0">else</span><span class="s2">:</span>
                                    <span class="s4"># there could be a call in the unpack, like</span>
                                    <span class="s4"># *(a, x.append(y))</span>
                                    <span class="s1">new_hole</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                            <span class="s0">elif </span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">'build_list' </span><span class="s0">and</span>
                                    <span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">const_list</span><span class="s2">):</span>
                                <span class="s1">new </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_tuple</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">items</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                                <span class="s1">asgn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">new</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                                <span class="s4"># Not a temporary any more</span>
                                <span class="s1">append_and_fix</span><span class="s2">(</span><span class="s1">asgn</span><span class="s2">)</span>
                            <span class="s0">else</span><span class="s2">:</span>
                                <span class="s1">new_hole</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">new_hole</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s4"># stick everything else in as-is</span>
                        <span class="s1">new_hole</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                <span class="s4"># Finally write the result back into the original build list as</span>
                <span class="s4"># everything refers to it.</span>
                <span class="s1">append_and_fix</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">acc</span><span class="s2">, </span><span class="s1">t2l_agn</span><span class="s2">.</span><span class="s1">target</span><span class="s2">,</span>
                                         <span class="s1">the_build_list</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">_DEBUG</span><span class="s2">:</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s6">&quot;</span><span class="s0">\n</span><span class="s6">NEW HOLE:&quot;</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">new_hole</span><span class="s2">:</span>
                        <span class="s1">print</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

                <span class="s4"># and then update the block body with the modified region</span>
                <span class="s1">cpy </span><span class="s2">= </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[:]</span>
                <span class="s1">head </span><span class="s2">= </span><span class="s1">cpy</span><span class="s2">[:</span><span class="s1">region</span><span class="s2">[</span><span class="s3">1</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]]</span>
                <span class="s1">tail </span><span class="s2">= </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">region</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s3">0</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">:]</span>
                <span class="s1">tmp </span><span class="s2">= </span><span class="s1">head </span><span class="s2">+ </span><span class="s1">new_hole </span><span class="s2">+ </span><span class="s1">tail</span>
                <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
                <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">)</span>

                <span class="s0">if </span><span class="s1">_DEBUG</span><span class="s2">:</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s6">&quot;</span><span class="s0">\n</span><span class="s6">DUMP post hole:&quot;</span><span class="s2">)</span>
                    <span class="s1">blk</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">()</span>

            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># else escape</span>
                <span class="s0">break</span>

    <span class="s0">return </span><span class="s1">func_ir</span>


<span class="s0">def </span><span class="s1">peep_hole_delete_with_exit</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    This rewrite removes variables used to store the `__exit__` function 
    loaded by SETUP_WITH. 
    &quot;&quot;&quot;</span>
    <span class="s1">dead_vars </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">for </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
        <span class="s0">for </span><span class="s1">stmt </span><span class="s0">in </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s4"># Any statement that uses a variable with the '$setup_with_exitfn'</span>
            <span class="s4"># prefix is considered dead.</span>
            <span class="s1">used </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">list_vars</span><span class="s2">())</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">used</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s6">'$setup_with_exitfn'</span><span class="s2">):</span>
                    <span class="s1">dead_vars</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
            <span class="s4"># Any assignment that uses any of the dead variable is considered</span>
            <span class="s4"># dead.</span>
            <span class="s0">if </span><span class="s1">used </span><span class="s2">&amp; </span><span class="s1">dead_vars</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
                    <span class="s1">dead_vars</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>

        <span class="s1">new_body </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">stmt </span><span class="s0">in </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s4"># Skip any statements that uses anyone of the dead variable.</span>
            <span class="s0">if not </span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">list_vars</span><span class="s2">()) &amp; </span><span class="s1">dead_vars</span><span class="s2">):</span>
                <span class="s1">new_body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
        <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">new_body</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">func_ir</span>


<span class="s0">def </span><span class="s1">peep_hole_fuse_dict_add_updates</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    This rewrite removes d1._update_from_bytecode(d2) 
    calls that are between two dictionaries, d1 and d2, 
    in the same basic block. This pattern can appear as a 
    result of Python 3.10 bytecode emission changes, which 
    prevent large constant literal dictionaries 
    (&gt; 15 elements) from being constant. If both dictionaries 
    are constant dictionaries defined in the same block and 
    neither is used between the update call, then we replace d1 
    with a new definition that combines the two dictionaries. At 
    the bytecode translation stage we convert DICT_UPDATE into 
    _update_from_bytecode, so we know that _update_from_bytecode 
    always comes from the bytecode change and not user code. 
 
    Python 3.10 may also rewrite the individual dictionaries 
    as an empty build_map + many map_add. Here we again look 
    for an _update_from_bytecode, and if so we replace these 
    with a single constant dictionary. 
 
    When running this algorithm we can always safely remove d2. 
 
    This is the relevant section of the CPython 3.10 that causes 
    this bytecode change: 
    https://github.com/python/cpython/blob/3.10/Python/compile.c#L4048 
    &quot;&quot;&quot;</span>

    <span class="s4"># This algorithm fuses build_map expressions into the largest</span>
    <span class="s4"># possible build map before use. For example, if we have an</span>
    <span class="s4"># IR that looks like this:</span>
    <span class="s4">#</span>
    <span class="s4">#   $d1 = build_map([])</span>
    <span class="s4">#   $key = const(&quot;a&quot;)</span>
    <span class="s4">#   $value = const(2)</span>
    <span class="s4">#   $setitem_func = getattr($d1, &quot;__setitem__&quot;)</span>
    <span class="s4">#   $unused1 = call (setitem_func, ($key, $value))</span>
    <span class="s4">#   $key2 = const(&quot;b&quot;)</span>
    <span class="s4">#   $value2 = const(3)</span>
    <span class="s4">#   $d2 = build_map([($key2, $value2)])</span>
    <span class="s4">#   $update_func = getattr($d1, &quot;_update_from_bytecode&quot;)</span>
    <span class="s4">#   $unused2 = call ($update_func, ($d2,))</span>
    <span class="s4">#   $othervar = None</span>
    <span class="s4">#   $retvar = cast($othervar)</span>
    <span class="s4">#   return $retvar</span>
    <span class="s4">#</span>
    <span class="s4"># Then the IR is rewritten such that any __setitem__ and</span>
    <span class="s4"># _update_from_bytecode operations are fused into the original buildmap.</span>
    <span class="s4"># The new buildmap is then added to the</span>
    <span class="s4"># last location where it had previously had encountered a __setitem__,</span>
    <span class="s4"># _update_from_bytecode, or build_map before any other uses.</span>
    <span class="s4"># The new IR would look like:</span>
    <span class="s4">#</span>
    <span class="s4">#   $key = const(&quot;a&quot;)</span>
    <span class="s4">#   $value = const(2)</span>
    <span class="s4">#   $key2 = const(&quot;b&quot;)</span>
    <span class="s4">#   $value2 = const(3)</span>
    <span class="s4">#   $d1 = build_map([($key, $value), ($key2, $value2)])</span>
    <span class="s4">#   $othervar = None</span>
    <span class="s4">#   $retvar = cast($othervar)</span>
    <span class="s4">#   return $retvar</span>
    <span class="s4">#</span>
    <span class="s4"># Note that we don't push $d1 to the bottom of the block. This is because</span>
    <span class="s4"># some values may be found below this block (e.g pop_block) that are pattern</span>
    <span class="s4"># matched in other locations, such as objmode handling. It should be safe to</span>
    <span class="s4"># move a map to the last location at which there was _update_from_bytecode.</span>

    <span class="s1">errmsg </span><span class="s2">= </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s6">&quot;&quot;&quot; 
        A DICT_UPDATE op-code was encountered that could not be replaced. 
        If you have created a large constant dictionary, this may 
        be an an indication that you are using inlined control 
        flow. You can resolve this issue by moving the control flow out of 
        the dicitonary constructor. For example, if you have 
 
            d = {a: 1 if flag else 0, ...) 
 
        Replace that with: 
 
            a_val = 1 if flag else 0 
            d = {a: a_val, ...)&quot;&quot;&quot;</span><span class="s2">)</span>

    <span class="s1">already_deleted_defs </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">set</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
        <span class="s1">new_body </span><span class="s2">= []</span>
        <span class="s4"># literal map var name -&gt; block idx of the original build_map</span>
        <span class="s1">lit_map_def_idx </span><span class="s2">= {}</span>
        <span class="s4"># literal map var name -&gt; list(map_uses)</span>
        <span class="s4"># This is the index of every build_map or __setitem__</span>
        <span class="s4"># in the IR that will need to be removed if the map</span>
        <span class="s4"># is updated.</span>
        <span class="s1">lit_map_use_idx </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">list</span><span class="s2">)</span>
        <span class="s4"># literal map var name -&gt; list of key/value items for build map</span>
        <span class="s1">map_updates </span><span class="s2">= {}</span>
        <span class="s1">blk_changed </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">stmt </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">):</span>
            <span class="s4"># What instruction should we append</span>
            <span class="s1">new_inst </span><span class="s2">= </span><span class="s1">stmt</span>
            <span class="s4"># Name that should be skipped when tracking used</span>
            <span class="s4"># vars in statement. This is always the lhs with</span>
            <span class="s4"># a build_map.</span>
            <span class="s1">stmt_build_map_out </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">) </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;build_map&quot;</span><span class="s2">:</span>
                    <span class="s4"># Skip the output build_map when looking for used vars.</span>
                    <span class="s1">stmt_build_map_out </span><span class="s2">= </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span>
                    <span class="s4"># If we encounter a build map add it to the</span>
                    <span class="s4"># tracked maps.</span>
                    <span class="s1">lit_map_def_idx</span><span class="s2">[</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">i</span>
                    <span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
                    <span class="s1">map_updates</span><span class="s2">[</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s0">elif </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;call&quot; </span><span class="s0">and </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s4"># If we encounter a call we may need to replace</span>
                    <span class="s4"># the body</span>
                    <span class="s1">func_name </span><span class="s2">= </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">name</span>
                    <span class="s4"># If we have an update or a setitem</span>
                    <span class="s4"># it will be the previous expression.</span>
                    <span class="s1">getattr_stmt </span><span class="s2">= </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">]</span>
                    <span class="s1">args </span><span class="s2">= </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">args</span>
                    <span class="s0">if </span><span class="s2">(</span>
                        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">getattr_stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">func_name</span>
                        <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;getattr&quot;</span>
                        <span class="s0">and </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">attr </span><span class="s0">in </span><span class="s2">(</span>
                            <span class="s6">&quot;__setitem__&quot;</span><span class="s2">, </span><span class="s6">&quot;_update_from_bytecode&quot;</span>
                        <span class="s2">)</span>
                    <span class="s2">):</span>
                        <span class="s1">update_map_name </span><span class="s2">= </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span>
                        <span class="s1">attr </span><span class="s2">= </span><span class="s1">getattr_stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">attr</span>
                        <span class="s0">if </span><span class="s2">(</span><span class="s1">attr </span><span class="s2">== </span><span class="s6">&quot;__setitem__&quot;</span>
                           <span class="s0">and </span><span class="s1">update_map_name </span><span class="s0">in </span><span class="s1">lit_map_use_idx</span><span class="s2">):</span>
                            <span class="s4"># If we have a setitem, update the lists</span>
                            <span class="s1">map_updates</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
                            <span class="s4"># Update the list of instructions that would</span>
                            <span class="s4"># need to be removed to include the setitem</span>
                            <span class="s4"># and the the getattr</span>
                            <span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">].</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">])</span>
                        <span class="s0">elif </span><span class="s1">attr </span><span class="s2">== </span><span class="s6">&quot;_update_from_bytecode&quot;</span><span class="s2">:</span>
                            <span class="s1">d2_map_name </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">name</span>
                            <span class="s0">if </span><span class="s2">(</span><span class="s1">update_map_name </span><span class="s0">in </span><span class="s1">lit_map_use_idx</span>
                               <span class="s0">and </span><span class="s1">d2_map_name </span><span class="s0">in </span><span class="s1">lit_map_use_idx</span><span class="s2">):</span>
                                <span class="s4"># If we have an update and the arg is also</span>
                                <span class="s4"># a literal dictionary, fuse the lists.</span>
                                <span class="s1">map_updates</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">].</span><span class="s1">extend</span><span class="s2">(</span>
                                    <span class="s1">map_updates</span><span class="s2">[</span><span class="s1">d2_map_name</span><span class="s2">]</span>
                                <span class="s2">)</span>
                                <span class="s4"># Delete the old IR for d1 and d2</span>
                                <span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">].</span><span class="s1">extend</span><span class="s2">(</span>
                                    <span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">d2_map_name</span><span class="s2">]</span>
                                <span class="s2">)</span>
                                <span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
                                <span class="s0">for </span><span class="s1">linenum </span><span class="s0">in </span><span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">]:</span>
                                    <span class="s4"># Drop the existing definition.</span>
                                    <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
                                        <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">,</span>
                                        <span class="s1">linenum</span><span class="s2">,</span>
                                        <span class="s1">func_ir</span><span class="s2">,</span>
                                        <span class="s1">already_deleted_defs</span><span class="s2">,</span>
                                    <span class="s2">)</span>
                                    <span class="s4"># Delete it from the new block</span>
                                    <span class="s1">new_body</span><span class="s2">[</span><span class="s1">linenum</span><span class="s2">] = </span><span class="s0">None</span>
                                <span class="s4"># Delete the maps from dicts</span>
                                <span class="s0">del </span><span class="s1">lit_map_def_idx</span><span class="s2">[</span><span class="s1">d2_map_name</span><span class="s2">]</span>
                                <span class="s0">del </span><span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">d2_map_name</span><span class="s2">]</span>
                                <span class="s0">del </span><span class="s1">map_updates</span><span class="s2">[</span><span class="s1">d2_map_name</span><span class="s2">]</span>
                                <span class="s4"># Add d1 as the new instruction, removing the</span>
                                <span class="s4"># old definition.</span>
                                <span class="s1">_remove_assignment_definition</span><span class="s2">(</span>
                                    <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">already_deleted_defs</span>
                                <span class="s2">)</span>
                                <span class="s1">new_inst </span><span class="s2">= </span><span class="s1">_build_new_build_map</span><span class="s2">(</span>
                                    <span class="s1">func_ir</span><span class="s2">,</span>
                                    <span class="s1">update_map_name</span><span class="s2">,</span>
                                    <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">,</span>
                                    <span class="s1">lit_map_def_idx</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">],</span>
                                    <span class="s1">map_updates</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">],</span>
                                <span class="s2">)</span>
                                <span class="s4"># Update d1 in lit_map_use_idx to just the new</span>
                                <span class="s4"># definition and clear the previous list.</span>
                                <span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">].</span><span class="s1">clear</span><span class="s2">()</span>
                                <span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">update_map_name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
                                <span class="s4"># Mark that this block has been modified</span>
                                <span class="s1">blk_changed </span><span class="s2">= </span><span class="s0">True</span>
                            <span class="s0">else</span><span class="s2">:</span>
                                <span class="s4"># If we cannot remove _update_from_bytecode</span>
                                <span class="s4"># Then raise an error for the user.</span>
                                <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">errmsg</span><span class="s2">)</span>

            <span class="s4"># Check if we need to drop any maps from being tracked.</span>
            <span class="s4"># Skip the setitem/_update_from_bytecode getattr that</span>
            <span class="s4"># will be removed when handling their call in the next</span>
            <span class="s4"># iteration.</span>
            <span class="s0">if not </span><span class="s2">(</span>
                <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;getattr&quot;</span>
                <span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">lit_map_use_idx</span>
                <span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">attr </span><span class="s0">in </span><span class="s2">(</span><span class="s6">&quot;__setitem__&quot;</span><span class="s2">, </span><span class="s6">&quot;_update_from_bytecode&quot;</span><span class="s2">)</span>
            <span class="s2">):</span>
                <span class="s0">for </span><span class="s1">var </span><span class="s0">in </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">list_vars</span><span class="s2">():</span>
                    <span class="s4"># If a map is used it cannot be fused later in</span>
                    <span class="s4"># the block. As a result we delete it from</span>
                    <span class="s4"># the dicitonaries</span>
                    <span class="s0">if </span><span class="s2">(</span>
                        <span class="s1">var</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">lit_map_use_idx</span>
                        <span class="s0">and </span><span class="s1">var</span><span class="s2">.</span><span class="s1">name </span><span class="s2">!= </span><span class="s1">stmt_build_map_out</span>
                    <span class="s2">):</span>
                        <span class="s0">del </span><span class="s1">lit_map_def_idx</span><span class="s2">[</span><span class="s1">var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                        <span class="s0">del </span><span class="s1">lit_map_use_idx</span><span class="s2">[</span><span class="s1">var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                        <span class="s0">del </span><span class="s1">map_updates</span><span class="s2">[</span><span class="s1">var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>

            <span class="s4"># Append the instruction to the new block</span>
            <span class="s1">new_body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">new_inst</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">blk_changed</span><span class="s2">:</span>
            <span class="s4"># If the block is changed replace the block body.</span>
            <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
            <span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">new_body </span><span class="s0">if </span><span class="s1">x </span><span class="s0">is not None</span><span class="s2">])</span>

    <span class="s0">return </span><span class="s1">func_ir</span>


<span class="s0">def </span><span class="s1">peep_hole_split_at_pop_block</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Split blocks that contain ir.PopBlock. 
 
    This rewrite restores the IR structure to pre 3.11 so that withlifting 
    can work correctly. 
    &quot;&quot;&quot;</span>
    <span class="s1">new_block_map </span><span class="s2">= {}</span>
    <span class="s1">sorted_blocks </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
    <span class="s0">for </span><span class="s1">blk_idx</span><span class="s2">, (</span><span class="s1">label</span><span class="s2">, </span><span class="s1">blk</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">sorted_blocks</span><span class="s2">):</span>
        <span class="s4"># Gather locations of PopBlock</span>
        <span class="s1">pop_block_locs </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PopBlock</span><span class="s2">):</span>
                <span class="s1">pop_block_locs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
        <span class="s4"># Rewrite block with PopBlock</span>
        <span class="s0">if </span><span class="s1">pop_block_locs</span><span class="s2">:</span>
            <span class="s1">new_blocks </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">pop_block_locs</span><span class="s2">:</span>
                <span class="s1">before_blk </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Block</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">before_blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[:</span><span class="s1">i</span><span class="s2">])</span>
                <span class="s1">new_blocks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">before_blk</span><span class="s2">)</span>

                <span class="s1">popblk_blk </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Block</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">popblk_blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
                <span class="s1">new_blocks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">popblk_blk</span><span class="s2">)</span>
            <span class="s4"># Add jump instructions</span>
            <span class="s1">prev_label </span><span class="s2">= </span><span class="s1">label</span>
            <span class="s0">for </span><span class="s1">newblk </span><span class="s0">in </span><span class="s1">new_blocks</span><span class="s2">:</span>
                <span class="s1">new_block_map</span><span class="s2">[</span><span class="s1">prev_label</span><span class="s2">] = </span><span class="s1">newblk</span>
                <span class="s1">next_label </span><span class="s2">= </span><span class="s1">prev_label </span><span class="s2">+ </span><span class="s3">1</span>
                <span class="s1">newblk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">next_label</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>
                <span class="s1">prev_label </span><span class="s2">= </span><span class="s1">next_label</span>
            <span class="s4"># Check prev_label does not exceed current new block label</span>
            <span class="s0">if </span><span class="s1">blk_idx </span><span class="s2">+ </span><span class="s3">1 </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sorted_blocks</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">prev_label </span><span class="s2">&gt;= </span><span class="s1">sorted_blocks</span><span class="s2">[</span><span class="s1">blk_idx </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]:</span>
                    <span class="s4"># Panic! Due to heuristic in with-lifting, block labels</span>
                    <span class="s4"># must be monotonically increasing. We cannot continue if we</span>
                    <span class="s4"># run out of usable label between the two blocks.</span>
                    <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">InternalError</span><span class="s2">(</span><span class="s6">&quot;POP_BLOCK peephole failed&quot;</span><span class="s2">)</span>
            <span class="s4"># Add tail block, which will get the original terminator</span>
            <span class="s1">tail_blk </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Block</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">tail_blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">pop_block_locs</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] + </span><span class="s3">1</span><span class="s2">:])</span>
            <span class="s1">new_block_map</span><span class="s2">[</span><span class="s1">prev_label</span><span class="s2">] = </span><span class="s1">tail_blk</span>

    <span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">new_block_map</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">func_ir</span>


<span class="s0">def </span><span class="s1">_build_new_build_map</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">old_body</span><span class="s2">, </span><span class="s1">old_lineno</span><span class="s2">, </span><span class="s1">new_items</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Create a new build_map with a new set of key/value items 
    but all the other info the same. 
    &quot;&quot;&quot;</span>
    <span class="s1">old_assign </span><span class="s2">= </span><span class="s1">old_body</span><span class="s2">[</span><span class="s1">old_lineno</span><span class="s2">]</span>
    <span class="s1">old_target </span><span class="s2">= </span><span class="s1">old_assign</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">old_bm </span><span class="s2">= </span><span class="s1">old_assign</span><span class="s2">.</span><span class="s1">value</span>
    <span class="s4"># Build the literals</span>
    <span class="s1">literal_keys </span><span class="s2">= []</span>
    <span class="s4"># Track the constant key/values to set the literal_value</span>
    <span class="s4"># field of build_map properly</span>
    <span class="s1">values </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">pair </span><span class="s0">in </span><span class="s1">new_items</span><span class="s2">:</span>
        <span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">pair</span>
        <span class="s1">key_def </span><span class="s2">= </span><span class="s1">guard</span><span class="s2">(</span><span class="s1">get_definition</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key_def</span><span class="s2">, (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FreeVar</span><span class="s2">)):</span>
            <span class="s1">literal_keys</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">key_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">value_def </span><span class="s2">= </span><span class="s1">guard</span><span class="s2">(</span><span class="s1">get_definition</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value_def</span><span class="s2">, (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FreeVar</span><span class="s2">)):</span>
            <span class="s1">values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value_def</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># Append unknown value if not a literal.</span>
            <span class="s1">values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">_UNKNOWN_VALUE</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>

    <span class="s1">value_indexes </span><span class="s2">= {}</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">new_items</span><span class="s2">):</span>
        <span class="s4"># All keys must be literals to have any literal values.</span>
        <span class="s1">literal_value </span><span class="s2">= {</span><span class="s1">x</span><span class="s2">: </span><span class="s1">y </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">, </span><span class="s1">values</span><span class="s2">)}</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">k </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">):</span>
            <span class="s1">value_indexes</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">i</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">literal_value </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s4"># Construct a new build map.</span>
    <span class="s1">new_bm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_map</span><span class="s2">(</span>
        <span class="s1">items</span><span class="s2">=</span><span class="s1">new_items</span><span class="s2">,</span>
        <span class="s1">size</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">new_items</span><span class="s2">),</span>
        <span class="s1">literal_value</span><span class="s2">=</span><span class="s1">literal_value</span><span class="s2">,</span>
        <span class="s1">value_indexes</span><span class="s2">=</span><span class="s1">value_indexes</span><span class="s2">,</span>
        <span class="s1">loc</span><span class="s2">=</span><span class="s1">old_bm</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s4"># The previous definition has already been removed</span>
    <span class="s4"># when updating the IR in peep_hole_fuse_dict_add_updates</span>
    <span class="s1">func_ir</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">new_bm</span><span class="s2">)</span>

    <span class="s4"># Return a new assign.</span>
    <span class="s0">return </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span>
        <span class="s1">new_bm</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">(</span><span class="s1">old_target</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">old_target</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">), </span><span class="s1">new_bm</span><span class="s2">.</span><span class="s1">loc</span>
    <span class="s2">)</span>


<span class="s0">class </span><span class="s1">Interpreter</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;A bytecode interpreter that builds up the IR. 
    &quot;&quot;&quot;</span>

    <span class="s1">_DEBUG_PRINT </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func_id</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">func_id </span><span class="s2">= </span><span class="s1">func_id</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_DEBUG_PRINT</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arg_count </span><span class="s2">= </span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">arg_count</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arg_names </span><span class="s2">= </span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">arg_names</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">first_loc </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Loc</span><span class="s2">.</span><span class="s1">from_function_id</span><span class="s2">(</span><span class="s1">func_id</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_generator </span><span class="s2">= </span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">is_generator</span>

        <span class="s4"># { inst offset : ir.Block }</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">= {}</span>
        <span class="s4"># { name: [definitions] } of local variables</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">definitions </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">list</span><span class="s2">)</span>
        <span class="s4"># A set to keep track of all exception variables.</span>
        <span class="s4"># To be used in _legalize_exception_vars()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_exception_vars </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">interpret</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bytecode</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Generate IR for this bytecode. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode </span><span class="s2">= </span><span class="s1">bytecode</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">scopes </span><span class="s2">= []</span>
        <span class="s1">global_scope </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Scope</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scopes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">global_scope</span><span class="s2">)</span>

        <span class="s1">flow </span><span class="s2">= </span><span class="s1">Flow</span><span class="s2">(</span><span class="s1">bytecode</span><span class="s2">)</span>
        <span class="s1">flow</span><span class="s2">.</span><span class="s1">run</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dfa </span><span class="s2">= </span><span class="s1">AdaptDFA</span><span class="s2">(</span><span class="s1">flow</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cfa </span><span class="s2">= </span><span class="s1">AdaptCFA</span><span class="s2">(</span><span class="s1">flow</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">DUMP_CFG</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cfa</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">()</span>

        <span class="s4"># Temp states during interpretation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block_offset </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">last_active_offset </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">inst_blocks </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cfa</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">inst_blocks</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
                <span class="s1">last_active_offset </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">last_active_offset</span><span class="s2">,</span>
                                         <span class="s1">max</span><span class="s2">(</span><span class="s1">inst_blocks</span><span class="s2">.</span><span class="s1">body</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">last_active_offset </span><span class="s2">= </span><span class="s1">last_active_offset</span>

        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">active_exception_entries </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">entry </span><span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">.</span><span class="s1">exception_entries</span>
                 <span class="s0">if </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">start </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">last_active_offset</span><span class="s2">])</span>
        <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
            <span class="s0">pass</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">scopes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Scope</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scope</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>

        <span class="s4"># Interpret loop</span>
        <span class="s0">for </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">kws </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_iter_inst</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_dispatch</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
            <span class="s4"># Insert end of try markers</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_end_try_blocks</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)):</span>
            <span class="s0">pass</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_legalize_exception_vars</span><span class="s2">()</span>
        <span class="s4"># Prepare FunctionIR</span>
        <span class="s1">func_ir </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionIR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_generator</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">,</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">first_loc</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">,</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">arg_count</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arg_names</span><span class="s2">)</span>
        <span class="s1">_logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">dump_to_string</span><span class="s2">())</span>

        <span class="s4"># post process the IR to rewrite opcodes/byte sequences that are too</span>
        <span class="s4"># involved to risk handling as part of direct interpretation</span>
        <span class="s1">peepholes </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
            <span class="s1">peepholes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">peep_hole_split_at_pop_block</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
            <span class="s1">peepholes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">peep_hole_list_to_tuple</span><span class="s2">)</span>
        <span class="s1">peepholes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">peep_hole_delete_with_exit</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
            <span class="s4"># peep_hole_call_function_ex_to_call_function_kw</span>
            <span class="s4"># depends on peep_hole_list_to_tuple converting</span>
            <span class="s4"># any large number of arguments from a list to a</span>
            <span class="s4"># tuple.</span>
            <span class="s1">peepholes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">peep_hole_call_function_ex_to_call_function_kw</span><span class="s2">)</span>
            <span class="s1">peepholes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">peep_hole_fuse_dict_add_updates</span><span class="s2">)</span>

        <span class="s1">post_processed_ir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">post_process</span><span class="s2">(</span><span class="s1">peepholes</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">post_processed_ir</span>

    <span class="s0">def </span><span class="s1">post_process</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">peepholes</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">peep </span><span class="s0">in </span><span class="s1">peepholes</span><span class="s2">:</span>
            <span class="s1">func_ir </span><span class="s2">= </span><span class="s1">peep</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">func_ir</span>

    <span class="s0">def </span><span class="s1">_end_try_blocks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Closes all try blocks by inserting the required marker at the 
        exception handler 
 
        This is only needed for py3.11 because of the changes in exception 
        handling. This merely maps the new py3.11 semantics back to the old way. 
 
        What the code does: 
 
        - For each block, compute the difference of blockstack to its incoming 
          blocks' blockstack. 
        - If the incoming blockstack has an extra TRY, the current block must 
          be the EXCEPT block and we need to insert a marker. 
 
        See also: _insert_try_block_end 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">))</span>
        <span class="s1">graph </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cfa</span><span class="s2">.</span><span class="s1">graph</span>
        <span class="s0">for </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s4"># Get current blockstack</span>
            <span class="s1">cur_bs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfa</span><span class="s2">.</span><span class="s1">infos</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">].</span><span class="s1">blockstack</span>
            <span class="s4"># Check blockstack of the incoming blocks</span>
            <span class="s0">for </span><span class="s1">inc</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">graph</span><span class="s2">.</span><span class="s1">predecessors</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">):</span>
                <span class="s1">inc_bs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfa</span><span class="s2">.</span><span class="s1">infos</span><span class="s2">[</span><span class="s1">inc</span><span class="s2">].</span><span class="s1">blockstack</span>

                <span class="s4"># find first diff in the blockstack</span>
                <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">cur_bs</span><span class="s2">, </span><span class="s1">inc_bs</span><span class="s2">)):</span>
                    <span class="s0">if </span><span class="s1">x </span><span class="s2">!= </span><span class="s1">y</span><span class="s2">:</span>
                        <span class="s0">break</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">i </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">cur_bs</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">inc_bs</span><span class="s2">))</span>

                <span class="s0">def </span><span class="s1">do_change</span><span class="s2">(</span><span class="s1">remain</span><span class="s2">):</span>
                    <span class="s0">while </span><span class="s1">remain</span><span class="s2">:</span>
                        <span class="s1">ent </span><span class="s2">= </span><span class="s1">remain</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                        <span class="s0">if </span><span class="s1">ent</span><span class="s2">[</span><span class="s6">'kind'</span><span class="s2">] == </span><span class="s1">BlockKind</span><span class="s2">(</span><span class="s6">'TRY'</span><span class="s2">):</span>
                            <span class="s4"># Extend block with marker for end of try</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block </span><span class="s2">= </span><span class="s1">block</span>
                            <span class="s1">oldbody </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">)</span>
                            <span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_try_block_end</span><span class="s2">()</span>
                            <span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">oldbody</span><span class="s2">)</span>
                            <span class="s0">return True</span>

                <span class="s0">if </span><span class="s1">do_change</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">inc_bs</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:])):</span>
                    <span class="s0">break</span>

    <span class="s0">def </span><span class="s1">_legalize_exception_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Search for unsupported use of exception variables. 
        Note, they cannot be stored into user variable. 
        &quot;&quot;&quot;</span>
        <span class="s4"># Build a set of exception variables</span>
        <span class="s1">excvars </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_exception_vars</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s4"># Propagate the exception variables to LHS of assignment</span>
        <span class="s0">for </span><span class="s1">varname</span><span class="s2">, </span><span class="s1">defnvars </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">defnvars</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">):</span>
                    <span class="s1">k </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span>
                    <span class="s0">if </span><span class="s1">k </span><span class="s0">in </span><span class="s1">excvars</span><span class="s2">:</span>
                        <span class="s1">excvars</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">varname</span><span class="s2">)</span>
        <span class="s4"># Filter out the user variables.</span>
        <span class="s1">uservar </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">filter</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s0">not </span><span class="s1">x</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s6">'$'</span><span class="s2">), </span><span class="s1">excvars</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">uservar</span><span class="s2">:</span>
            <span class="s4"># Complain about the first user-variable storing an exception</span>
            <span class="s1">first </span><span class="s2">= </span><span class="s1">uservar</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">first</span><span class="s2">).</span><span class="s1">loc</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s6">&quot;Exception object cannot be stored into variable ({}).&quot;</span>
            <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">first</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">init_first_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Define variables receiving the function arguments</span>
        <span class="s0">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">name </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arg_names</span><span class="s2">):</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Arg</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_iter_inst</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">blkct</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cfa</span><span class="s2">.</span><span class="s1">iterliveblocks</span><span class="s2">()):</span>
            <span class="s1">firstinst </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">[</span><span class="s1">block</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">]</span>
            <span class="s4"># If its an END_FOR instruction, the start location of block</span>
            <span class="s4"># is set to start of the FOR loop, so take the location of</span>
            <span class="s4"># next instruction. This only affects the source location</span>
            <span class="s4"># marking and has no impact to semantic.</span>
            <span class="s0">if </span><span class="s1">firstinst</span><span class="s2">.</span><span class="s1">opname </span><span class="s2">== </span><span class="s6">'END_FOR'</span><span class="s2">:</span>
                <span class="s1">firstinst </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">[</span><span class="s1">firstinst</span><span class="s2">.</span><span class="s1">next</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">with_lineno</span><span class="s2">(</span><span class="s1">firstinst</span><span class="s2">.</span><span class="s1">lineno</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_new_block</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">blkct </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s4"># Is first block</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">init_first_block</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">kws </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">insts</span><span class="s2">:</span>
                <span class="s1">inst </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">with_lineno</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">lineno</span><span class="s2">)</span>
                <span class="s0">yield </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">kws</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_end_current_block</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_start_new_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">):</span>
        <span class="s1">oldblock </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">insert_block</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>

        <span class="s1">tryblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">active_try_block </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo </span><span class="s0">else None</span>
        <span class="s4"># Ensure the last block is terminated</span>
        <span class="s0">if </span><span class="s1">oldblock </span><span class="s0">is not None and not </span><span class="s1">oldblock</span><span class="s2">.</span><span class="s1">is_terminated</span><span class="s2">:</span>
            <span class="s4"># Handle ending try block.</span>
            <span class="s4"># If there's an active try-block and the handler block is live.</span>
            <span class="s0">if </span><span class="s1">tryblk </span><span class="s0">is not None and </span><span class="s1">tryblk</span><span class="s2">[</span><span class="s6">'end'</span><span class="s2">] </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cfa</span><span class="s2">.</span><span class="s1">graph</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">():</span>
                <span class="s4"># We are in a try-block, insert a branch to except-block.</span>
                <span class="s4"># This logic cannot be in self._end_current_block()</span>
                <span class="s4"># because we don't know the non-raising next block-offset.</span>
                <span class="s1">branch </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Branch</span><span class="s2">(</span>
                    <span class="s1">cond</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s6">'$exception_check'</span><span class="s2">),</span>
                    <span class="s1">truebr</span><span class="s2">=</span><span class="s1">tryblk</span><span class="s2">[</span><span class="s6">'end'</span><span class="s2">],</span>
                    <span class="s1">falsebr</span><span class="s2">=</span><span class="s1">offset</span><span class="s2">,</span>
                    <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">oldblock</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">branch</span><span class="s2">)</span>
            <span class="s4"># Handle normal case</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">jmp </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">oldblock</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">jmp</span><span class="s2">)</span>

        <span class="s4"># Get DFA block info</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfa</span><span class="s2">.</span><span class="s1">infos</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block_offset</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assigner </span><span class="s2">= </span><span class="s1">Assigner</span><span class="s2">()</span>
        <span class="s4"># Check out-of-scope syntactic-block</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
            <span class="s4"># This is recreating pre-3.11 code structure</span>
            <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">offset </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">].</span><span class="s1">exit</span><span class="s2">:</span>
                    <span class="s1">synblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">synblk</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">With</span><span class="s2">):</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PopBlock</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">break</span>
            <span class="s4"># inject try block:</span>
            <span class="s1">newtryblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">active_try_block</span>
            <span class="s0">if </span><span class="s1">newtryblk </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">newtryblk </span><span class="s0">is not </span><span class="s1">tryblk</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_try_block_begin</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)):</span>
            <span class="s0">while </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">offset </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">].</span><span class="s1">exit</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">break</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_end_current_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Handle try block</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">is_terminated</span><span class="s2">:</span>
            <span class="s1">tryblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">active_try_block</span>
            <span class="s0">if </span><span class="s1">tryblk </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_exception_check</span><span class="s2">()</span>
        <span class="s4"># Handle normal block cleanup</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_remove_unused_temporaries</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_outgoing_phis</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_inject_call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">gv_name</span><span class="s2">, </span><span class="s1">res_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;A helper function to inject a call to *func* which is a python 
        function. 
        Parameters 
        ---------- 
        func : callable 
            The function object to be called. 
        gv_name : str 
            The variable name to be used to store the function object. 
        res_name : str; optional 
            The variable name to be used to store the call result. 
            If ``None``, a name is created automatically. 
        &quot;&quot;&quot;</span>
        <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s1">gv_name</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">gv_name</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">callres </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">gv_name</span><span class="s2">), (), (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">res_name </span><span class="s2">= </span><span class="s1">res_name </span><span class="s0">or </span><span class="s6">'$callres_{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">gv_name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">callres</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res_name</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_insert_try_block_begin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Insert IR-nodes to mark the start of a `try` block. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inject_call</span><span class="s2">(</span><span class="s1">eh</span><span class="s2">.</span><span class="s1">mark_try_block</span><span class="s2">, </span><span class="s6">'mark_try_block'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_insert_try_block_end</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Insert IR-nodes to mark the end of a `try` block. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inject_call</span><span class="s2">(</span><span class="s1">eh</span><span class="s2">.</span><span class="s1">end_try_block</span><span class="s2">, </span><span class="s6">'end_try_block'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_insert_exception_variables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Insert IR-nodes to initialize the exception variables. 
        &quot;&quot;&quot;</span>
        <span class="s1">tryblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">active_try_block</span>
        <span class="s4"># Get exception variables</span>
        <span class="s1">endblk </span><span class="s2">= </span><span class="s1">tryblk</span><span class="s2">[</span><span class="s6">'end'</span><span class="s2">]</span>
        <span class="s1">edgepushed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">outgoing_edgepushed</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">endblk</span><span class="s2">)</span>
        <span class="s4"># Note: the last value on the stack is the exception value</span>
        <span class="s4"># Note: due to the current limitation, all exception variables are None</span>
        <span class="s0">if </span><span class="s1">edgepushed</span><span class="s2">:</span>
            <span class="s1">const_none </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s4"># For each variable going to the handler block.</span>
            <span class="s0">for </span><span class="s1">var </span><span class="s0">in </span><span class="s1">edgepushed</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">var </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                        <span class="s6">&quot;exception variable CANNOT be defined by other code&quot;</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">const_none</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">var</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_exception_vars</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">var</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_insert_exception_check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Called before the end of a block to inject checks if raised. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_exception_variables</span><span class="s2">()</span>
        <span class="s4"># Do exception check</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inject_call</span><span class="s2">(</span><span class="s1">eh</span><span class="s2">.</span><span class="s1">exception_check</span><span class="s2">, </span><span class="s6">'exception_check'</span><span class="s2">,</span>
                          <span class="s6">'$exception_check'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_remove_unused_temporaries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Remove assignments to unused temporary variables from the 
        current block. 
        &quot;&quot;&quot;</span>
        <span class="s1">new_body </span><span class="s2">= []</span>
        <span class="s1">replaced_var </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s4"># the same temporary is assigned to multiple variables in cases</span>
            <span class="s4"># like a = b[i] = 1, so need to handle replaced temporaries in</span>
            <span class="s4"># later setitem/setattr nodes</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetAttr</span><span class="s2">))</span>
                    <span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">replaced_var</span><span class="s2">):</span>
                <span class="s1">inst</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">replaced_var</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">is_temp</span>
                        <span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assigner</span><span class="s2">.</span><span class="s1">unused_dests</span><span class="s2">):</span>
                    <span class="s0">continue</span>
                <span class="s4"># the same temporary is assigned to multiple variables in cases</span>
                <span class="s4"># like a = b = 1, so need to handle replaced temporaries in</span>
                <span class="s4"># later assignments</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">replaced_var</span><span class="s2">):</span>
                    <span class="s1">inst</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">replaced_var</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                    <span class="s1">new_body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>
                    <span class="s0">continue</span>
                <span class="s4"># chained unpack cases may reuse temporary</span>
                <span class="s4"># e.g. a = (b, c) = (x, y)</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                        <span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;exhaust_iter&quot;</span>
                        <span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">replaced_var</span><span class="s2">):</span>
                    <span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">replaced_var</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                    <span class="s1">new_body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>
                    <span class="s0">continue</span>
                <span class="s4"># eliminate temporary variables that are assigned to user</span>
                <span class="s4"># variables right after creation. E.g.:</span>
                <span class="s4"># $1 = f(); a = $1 -&gt; a = f()</span>
                <span class="s4"># the temporary variable is not reused elsewhere since CPython</span>
                <span class="s4"># bytecode is stack-based and this pattern corresponds to a pop</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">) </span><span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">is_temp</span>
                        <span class="s0">and </span><span class="s1">new_body </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_body</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)):</span>
                    <span class="s1">prev_assign </span><span class="s2">= </span><span class="s1">new_body</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>
                    <span class="s4"># _var_used_in_binop check makes sure we don't create a new</span>
                    <span class="s4"># inplace binop operation which can fail</span>
                    <span class="s4"># (see TestFunctionType.test_in_iter_func_call)</span>
                    <span class="s0">if </span><span class="s2">(</span><span class="s1">prev_assign</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span>
                            <span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_var_used_in_binop</span><span class="s2">(</span>
                                <span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">prev_assign</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)):</span>
                        <span class="s1">replaced_var</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span>
                        <span class="s1">prev_assign</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span>
                        <span class="s4"># replace temp var definition in target with proper defs</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">extend</span><span class="s2">(</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                        <span class="s2">)</span>
                        <span class="s0">continue</span>

            <span class="s1">new_body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body </span><span class="s2">= </span><span class="s1">new_body</span>

    <span class="s0">def </span><span class="s1">_var_used_in_binop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">varname</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;return True if 'expr' is a binary expression and 'varname' is used 
        in it as an argument 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s0">in </span><span class="s2">(</span><span class="s6">&quot;binop&quot;</span><span class="s2">, </span><span class="s6">&quot;inplace_binop&quot;</span><span class="s2">)</span>
                <span class="s0">and </span><span class="s2">(</span><span class="s1">varname </span><span class="s2">== </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">name </span><span class="s0">or </span><span class="s1">varname </span><span class="s2">== </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_insert_outgoing_phis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Add assignments to forward requested outgoing values 
        to subsequent blocks. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">phiname</span><span class="s2">, </span><span class="s1">varname </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">outgoing_phis</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scope</span><span class="s2">.</span><span class="s1">get_or_define</span><span class="s2">(</span><span class="s1">phiname</span><span class="s2">,</span>
                                                      <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">varname</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">NotDefinedError</span><span class="s2">:</span>
                <span class="s4"># Hack to make sure exception variables are defined</span>
                <span class="s0">assert </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)), </span><span class="s1">\</span>
                       <span class="s6">&quot;unexpected missing definition&quot;</span>
                <span class="s1">val </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">val</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">,</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">is_terminated</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">insert_before_terminator</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_global_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get a global value from the func_global (first) or 
        as a builtins (second).  If both failed, return a ir.UNDEFINED. 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">__globals__</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">UNDEFINED</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_closure_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get a value from the cell contained in this function's closure. 
        If not set, return a ir.UNDEFINED. 
        &quot;&quot;&quot;</span>
        <span class="s1">cell </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">__closure__</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cell</span><span class="s2">.</span><span class="s1">cell_contents</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">UNDEFINED</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">current_scope</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scopes</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">code_consts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">.</span><span class="s1">co_consts</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">code_locals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">.</span><span class="s1">co_varnames</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">code_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">.</span><span class="s1">co_names</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">code_cellvars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">.</span><span class="s1">co_cellvars</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">code_freevars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bytecode</span><span class="s2">.</span><span class="s1">co_freevars</span>

    <span class="s0">def </span><span class="s1">_dispatch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_DEBUG_PRINT</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block </span><span class="s0">is not None</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">:</span>
                <span class="s1">top </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">With</span><span class="s2">) :</span>
                    <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset </span><span class="s2">&gt;= </span><span class="s1">top</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PopBlock</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)):</span>
            <span class="s0">pass</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

        <span class="s1">fname </span><span class="s2">= </span><span class="s6">&quot;op_%s&quot; </span><span class="s2">% </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">opname</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">'+'</span><span class="s2">, </span><span class="s6">'_'</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">NotDefinedError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">e</span><span class="s2">.</span><span class="s1">loc </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">loc </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">loc</span>

                <span class="s1">err </span><span class="s2">= </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">NotDefinedError</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s0">if not </span><span class="s1">config</span><span class="s2">.</span><span class="s1">FULL_TRACEBACKS</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">err </span><span class="s0">from None</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">err</span>

    <span class="s4"># --- Scope operations ---</span>

    <span class="s0">def </span><span class="s1">store</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Store *value* (a Expr or Var instance) into the variable named *name* 
        (a str object). Returns the target variable. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">redefine </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block_offset </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cfa</span><span class="s2">.</span><span class="s1">backbone</span><span class="s2">:</span>
            <span class="s1">rename </span><span class="s2">= </span><span class="s0">not </span><span class="s2">(</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">)</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scope</span><span class="s2">.</span><span class="s1">redefine</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                                                 <span class="s1">rename</span><span class="s2">=</span><span class="s1">rename</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scope</span><span class="s2">.</span><span class="s1">get_or_define</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assigner</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">target</span>

    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Get the variable (a Var instance) with the given *name*. 
        &quot;&quot;&quot;</span>
        <span class="s4"># Implicit argument for comprehension starts with '.'</span>
        <span class="s4"># See Parameter class in inspect.py (from Python source)</span>
        <span class="s0">if </span><span class="s1">name</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s6">'.' </span><span class="s0">and </span><span class="s1">name</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:].</span><span class="s1">isdigit</span><span class="s2">():</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s6">'implicit{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:])</span>

        <span class="s4"># Try to simplify the variable lookup by returning an earlier</span>
        <span class="s4"># variable assigned to *name*.</span>
        <span class="s1">var </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assigner</span><span class="s2">.</span><span class="s1">get_assignment_source</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">var </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">var </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">var</span>

    <span class="s4"># --- Block operations ---</span>

    <span class="s0">def </span><span class="s1">insert_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">scope </span><span class="s2">= </span><span class="s1">scope </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_scope</span>
        <span class="s1">loc </span><span class="s2">= </span><span class="s1">loc </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span>
        <span class="s1">blk </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Block</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">] = </span><span class="s1">blk</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block </span><span class="s2">= </span><span class="s1">blk</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block_offset </span><span class="s2">= </span><span class="s1">offset</span>
        <span class="s0">return </span><span class="s1">blk</span>

    <span class="s4"># --- Bytecode handlers ---</span>

    <span class="s0">def </span><span class="s1">op_NOP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">op_RESUME</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">op_CACHE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">op_PRECALL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">op_PUSH_NULL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">op_RETURN_GENERATOR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">op_PRINT_ITEM</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">printvar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
        <span class="s1">printgv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;print&quot;</span><span class="s2">, </span><span class="s1">print</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">printgv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">printvar</span><span class="s2">)</span>
        <span class="s1">call </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">printvar</span><span class="s2">), (</span><span class="s1">item</span><span class="s2">,), (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">call</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_PRINT_NEWLINE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">printvar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">printgv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;print&quot;</span><span class="s2">, </span><span class="s1">print</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">printgv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">printvar</span><span class="s2">)</span>
        <span class="s1">call </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">printvar</span><span class="s2">), (), (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">call</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_UNPACK_SEQUENCE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">iterable</span><span class="s2">, </span><span class="s1">stores</span><span class="s2">, </span><span class="s1">tupleobj</span><span class="s2">):</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">stores</span><span class="s2">)</span>
        <span class="s4"># Exhaust the iterable into a tuple-like object</span>
        <span class="s1">tup </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">exhaust_iter</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">iterable</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                                   <span class="s1">count</span><span class="s2">=</span><span class="s1">count</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">tupleobj</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">tup</span><span class="s2">)</span>

        <span class="s4"># then index the tuple-like object to extract the values</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">st </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">stores</span><span class="s2">):</span>
            <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">static_getitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tupleobj</span><span class="s2">),</span>
                                          <span class="s1">index</span><span class="s2">=</span><span class="s1">i</span><span class="s2">, </span><span class="s1">index_var</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                                          <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">st</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_FORMAT_VALUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">strvar</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        FORMAT_VALUE(flags): flags argument specifies format spec which is not 
        supported yet. Currently, str() is simply called on the value. 
        https://docs.python.org/3/library/dis.html#opcode-FORMAT_VALUE 
        &quot;&quot;&quot;</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">strgv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;str&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">strgv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">strvar</span><span class="s2">)</span>
        <span class="s1">call </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">strvar</span><span class="s2">), (</span><span class="s1">value</span><span class="s2">,), (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">call</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_STRING</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">strings</span><span class="s2">, </span><span class="s1">tmps</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        BUILD_STRING(count): Concatenates count strings. 
        Required for supporting f-strings. 
        https://docs.python.org/3/library/dis.html#opcode-BUILD_STRING 
        &quot;&quot;&quot;</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span>
        <span class="s4"># corner case: f&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">count </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">const </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s6">&quot;&quot;</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">const</span><span class="s2">, </span><span class="s1">tmps</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s0">return</span>

        <span class="s1">prev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">other</span><span class="s2">, </span><span class="s1">tmp </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s1">tmps</span><span class="s2">):</span>
            <span class="s1">other </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>
            <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">binop</span><span class="s2">(</span>
                <span class="s1">operator</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">=</span><span class="s1">prev</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">=</span><span class="s1">other</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">tmp</span><span class="s2">)</span>
            <span class="s1">prev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_SLICE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">step</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">):</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">step </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">sliceinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">), (),</span>
                                     <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">step </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">step</span><span class="s2">)</span>
            <span class="s1">sliceinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">step</span><span class="s2">),</span>
                                     <span class="s2">(), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">sliceinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
        <span class="s0">def </span><span class="s1">op_BINARY_SLICE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s1">container</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">,</span>
                            <span class="s1">temp_res</span><span class="s2">):</span>
            <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
            <span class="s1">end </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">end</span><span class="s2">)</span>
            <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>
            <span class="s1">sliceinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">), (),</span>
                                     <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">sliceinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">temp_res</span><span class="s2">)</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">temp_res</span><span class="s2">)</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">container</span><span class="s2">)</span>
            <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getitem</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
        <span class="s0">pass</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
        <span class="s0">def </span><span class="s1">op_STORE_SLICE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s1">container</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">,</span>
                           <span class="s1">slicevar</span><span class="s2">):</span>
            <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
            <span class="s1">end </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">end</span><span class="s2">)</span>
            <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>
            <span class="s1">sliceinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">), (),</span>
                                     <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">sliceinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">container</span><span class="s2">)</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">,</span>
                              <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
        <span class="s0">pass</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SLICE_0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">none</span><span class="s2">, </span><span class="s1">none</span><span class="s2">), (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getitem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SLICE_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">none</span><span class="s2">), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getitem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SLICE_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">none</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">,), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getitem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SLICE_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getitem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_STORE_SLICE_0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">none</span><span class="s2">, </span><span class="s1">none</span><span class="s2">), (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">),</span>
                          <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_STORE_SLICE_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">,</span>
                         <span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">none</span><span class="s2">), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">),</span>
                          <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_STORE_SLICE_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">,</span>
                         <span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">none</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">,), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">),</span>
                          <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_STORE_SLICE_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">,</span>
                         <span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">),</span>
                          <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DELETE_SLICE_0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">none</span><span class="s2">, </span><span class="s1">none</span><span class="s2">), (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DelItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DELETE_SLICE_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">none</span><span class="s2">), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DelItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DELETE_SLICE_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">nonevar</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>

        <span class="s1">nonegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">nonegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nonevar</span><span class="s2">)</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">nonevar</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">none</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">,), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DelItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DELETE_SLICE_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">base</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">slicevar</span><span class="s2">, </span><span class="s1">indexvar</span><span class="s2">):</span>
        <span class="s1">base </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>

        <span class="s1">slicegv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">slicegv</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">slicevar</span><span class="s2">)</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">slicevar</span><span class="s2">), (</span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">), (),</span>
                             <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">indexvar</span><span class="s2">)</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DelItem</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">indexvar</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_LOAD_FAST</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">srcname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_locals</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">srcname</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
        <span class="s1">op_LOAD_FAST_CHECK </span><span class="s2">= </span><span class="s1">op_LOAD_FAST</span>

        <span class="s0">def </span><span class="s1">op_LOAD_FAST_AND_CLEAR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s4"># try the regular LOAD_FAST logic</span>
                <span class="s1">srcname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_locals</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">srcname</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">NotDefinedError</span><span class="s2">:</span>
                <span class="s4"># If the variable is not in the scope, set it to `undef`</span>
                <span class="s1">undef </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">undef</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">undef</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
        <span class="s0">pass</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_STORE_FAST</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">dstname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_locals</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">dstname</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DELETE_FAST</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s1">dstname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_locals</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Del</span><span class="s2">(</span><span class="s1">dstname</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">op_DUP_TOPX</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">orig</span><span class="s2">, </span><span class="s1">duped</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">src</span><span class="s2">, </span><span class="s1">dst </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">, </span><span class="s1">duped</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">src</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s1">dst</span><span class="s2">)</span>

    <span class="s1">op_DUP_TOP </span><span class="s2">= </span><span class="s1">op_DUP_TOPX</span>
    <span class="s1">op_DUP_TOP_TWO </span><span class="s2">= </span><span class="s1">op_DUP_TOPX</span>

    <span class="s0">def </span><span class="s1">op_STORE_ATTR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">attr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_names</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s1">sa </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetAttr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">), </span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">),</span>
                        <span class="s1">attr</span><span class="s2">=</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DELETE_ATTR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">):</span>
        <span class="s1">attr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_names</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s1">sa </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DelAttr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">), </span><span class="s1">attr</span><span class="s2">=</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_LOAD_ATTR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_names</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">&gt;&gt; </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_names</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>
        <span class="s1">getattr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_LOAD_CONST</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_consts</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">st </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s1">nm </span><span class="s2">= </span><span class="s6">'$const_%s' </span><span class="s2">% </span><span class="s1">str</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">val_const </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">val_const</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nm</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
            <span class="s1">const </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_tuple</span><span class="s2">(</span><span class="s1">st</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">frozenset</span><span class="s2">):</span>
            <span class="s1">st </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s1">nm </span><span class="s2">= </span><span class="s6">'$const_%s' </span><span class="s2">% </span><span class="s1">str</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">val_const </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">val_const</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">nm</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
            <span class="s1">const </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_set</span><span class="s2">(</span><span class="s1">st</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">const </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">const</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_LOAD_GLOBAL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_names</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_global_value</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">gl </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">gl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_LOAD_GLOBAL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_names</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_global_value</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">gl </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">gl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_COPY_FREE_VARS</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_LOAD_DEREF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">__code__</span><span class="s2">.</span><span class="s1">_varname_from_oparg</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">:</span>
                <span class="s1">gl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_freevars</span><span class="s2">:</span>
                <span class="s1">idx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_freevars</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_closure_value</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
                <span class="s1">gl </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FreeVar</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">gl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_LOAD_DEREF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">n_cellvars </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">&lt; </span><span class="s1">n_cellvars</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
                <span class="s1">gl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">idx </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">- </span><span class="s1">n_cellvars</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_freevars</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_closure_value</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
                <span class="s1">gl </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FreeVar</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">gl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_MAKE_CELL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
            <span class="s0">pass  </span><span class="s4"># ignored bytecode</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_STORE_DEREF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">__code__</span><span class="s2">.</span><span class="s1">_varname_from_oparg</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">)</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_STORE_DEREF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s1">n_cellvars </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">&lt; </span><span class="s1">n_cellvars</span><span class="s2">:</span>
                <span class="s1">dstname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">dstname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_freevars</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">- </span><span class="s1">n_cellvars</span><span class="s2">]</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">dstname</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SETUP_LOOP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">] </span><span class="s0">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span>
        <span class="s1">loop </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Loop</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">exit</span><span class="s2">=(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">next </span><span class="s2">+ </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">loop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SETUP_WITH</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">contextmanager</span><span class="s2">, </span><span class="s1">exitfn</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">] </span><span class="s0">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span>
        <span class="s4"># Handle with</span>
        <span class="s1">exitpt </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">next </span><span class="s2">+ </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span>

        <span class="s1">wth </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">With</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">exit</span><span class="s2">=</span><span class="s1">exitpt</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">wth</span><span class="s2">)</span>
        <span class="s1">ctxmgr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">contextmanager</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">EnterWith</span><span class="s2">(</span><span class="s1">contextmanager</span><span class="s2">=</span><span class="s1">ctxmgr</span><span class="s2">,</span>
                                               <span class="s1">begin</span><span class="s2">=</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">,</span>
                                               <span class="s1">end</span><span class="s2">=</span><span class="s1">exitpt</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,))</span>

        <span class="s4"># Store exit fn</span>
        <span class="s1">exit_fn_obj </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">exit_fn_obj</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">exitfn</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BEFORE_WITH</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">contextmanager</span><span class="s2">, </span><span class="s1">exitfn</span><span class="s2">, </span><span class="s1">end</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">] </span><span class="s0">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
            <span class="s4"># Python 3.12 hack for handling nested with blocks</span>
            <span class="s0">if </span><span class="s1">end </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">last_active_offset</span><span class="s2">:</span>
                <span class="s4"># Use exception entries to figure out end of syntax block</span>
                <span class="s1">end </span><span class="s2">= </span><span class="s1">max</span><span class="s2">([</span><span class="s1">ex</span><span class="s2">.</span><span class="s1">end </span><span class="s0">for </span><span class="s1">ex </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">active_exception_entries</span>
                           <span class="s0">if </span><span class="s1">ex</span><span class="s2">.</span><span class="s1">target </span><span class="s2">== </span><span class="s1">end</span><span class="s2">])</span>
        <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
            <span class="s0">pass</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>
        <span class="s4"># Handle with</span>
        <span class="s1">wth </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">With</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">exit</span><span class="s2">=</span><span class="s1">end</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">wth</span><span class="s2">)</span>
        <span class="s1">ctxmgr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">contextmanager</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">EnterWith</span><span class="s2">(</span><span class="s1">contextmanager</span><span class="s2">=</span><span class="s1">ctxmgr</span><span class="s2">,</span>
                                               <span class="s1">begin</span><span class="s2">=</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">,</span>
                                               <span class="s1">end</span><span class="s2">=</span><span class="s1">end</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,))</span>

        <span class="s4"># Store exit function</span>
        <span class="s1">exit_fn_obj </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">exit_fn_obj</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">exitfn</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SETUP_FINALLY</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s4"># Removed since python3.11</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_try_block_begin</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">op_WITH_CLEANUP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s5">&quot;no-op&quot;</span>

    <span class="s0">def </span><span class="s1">op_WITH_CLEANUP_START</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s5">&quot;no-op&quot;</span>

    <span class="s0">def </span><span class="s1">op_WITH_CLEANUP_FINISH</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s5">&quot;no-op&quot;</span>

    <span class="s0">def </span><span class="s1">op_END_FINALLY</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s5">&quot;no-op&quot;</span>

    <span class="s0">def </span><span class="s1">op_BEGIN_FINALLY</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">temps</span><span class="s2">):</span>
        <span class="s4"># The *temps* are the exception variables</span>
        <span class="s1">const_none </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">tmp </span><span class="s0">in </span><span class="s1">temps</span><span class="s2">:</span>
            <span class="s4"># Set to None for now</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">const_none</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">tmp</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_exception_vars</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_CALL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kw_names</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">args</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">kw_names </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">names </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_consts</span><span class="s2">[</span><span class="s1">kw_names</span><span class="s2">]</span>
            <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">names</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">names</span><span class="s2">):]))</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[:-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">names</span><span class="s2">)]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">kwargs </span><span class="s2">= ()</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_CALL_FUNCTION</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">args</span><span class="s2">]</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, (), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_CALL_FUNCTION_KW</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">names</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">args</span><span class="s2">]</span>
        <span class="s4"># Find names const</span>
        <span class="s1">names </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">names</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">) </span><span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target </span><span class="s0">is </span><span class="s1">names</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>
                <span class="s4"># scan up the block looking for the values, remove them</span>
                <span class="s4"># and find their name strings</span>
                <span class="s1">named_items </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]:</span>
                        <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s1">y</span><span class="s2">.</span><span class="s1">target</span><span class="s2">:</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
                            <span class="s1">named_items</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
                            <span class="s0">break</span>
                <span class="s1">keys </span><span class="s2">= </span><span class="s1">named_items</span>
                <span class="s0">break</span>

        <span class="s1">nkeys </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">)</span>
        <span class="s1">posvals </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[:-</span><span class="s1">nkeys</span><span class="s2">]</span>
        <span class="s1">kwvals </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[-</span><span class="s1">nkeys</span><span class="s2">:]</span>
        <span class="s1">keyvalues </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">kwvals</span><span class="s2">))</span>

        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">posvals</span><span class="s2">, </span><span class="s1">keyvalues</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_CALL_FUNCTION_EX</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">varkwarg</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
        <span class="s1">vararg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">vararg</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">varkwarg </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">varkwarg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">varkwarg</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
            <span class="s1">func</span><span class="s2">, [], [], </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">vararg</span><span class="s2">=</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">varkwarg</span><span class="s2">=</span><span class="s1">varkwarg</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_build_tuple_unpack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">tuples</span><span class="s2">, </span><span class="s1">temps</span><span class="s2">, </span><span class="s1">is_assign</span><span class="s2">):</span>
        <span class="s1">first </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tuples</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">is_assign</span><span class="s2">:</span>
            <span class="s4"># it's assign-like, defer handling to an intrinsic that will have</span>
            <span class="s4"># type information.</span>
            <span class="s4"># Can deal with tuples only, i.e. y = (*x,). where x = &lt;tuple&gt;</span>
            <span class="s1">gv_name </span><span class="s2">= </span><span class="s6">&quot;unpack_single_tuple&quot;</span>
            <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s1">gv_name</span><span class="s2">, </span><span class="s1">unpack_single_tuple</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">gv_name</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">exc </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">gv_name</span><span class="s2">), </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">first</span><span class="s2">,), </span><span class="s1">kws</span><span class="s2">=(),</span>
                               <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">temps</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span>
            <span class="s0">for </span><span class="s1">other</span><span class="s2">, </span><span class="s1">tmp </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">, </span><span class="s1">tuples</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:]), </span><span class="s1">temps</span><span class="s2">):</span>
                <span class="s4"># Emit as `first + tuple(other)`</span>
                <span class="s1">gv_tuple </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s6">&quot;tuple&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">tuple</span><span class="s2">,</span>
                    <span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">tuple_var </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span>
                    <span class="s1">gv_tuple</span><span class="s2">, </span><span class="s6">&quot;$_list_extend_gv_tuple&quot;</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">tuplify_val </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
                    <span class="s1">tuple_var</span><span class="s2">, (</span><span class="s1">other</span><span class="s2">,), (),</span>
                    <span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">tuplify_var </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">tuplify_val</span><span class="s2">, </span><span class="s6">&quot;$_tuplify&quot;</span><span class="s2">,</span>
                                         <span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">out </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">binop</span><span class="s2">(</span>
                    <span class="s1">fn</span><span class="s2">=</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">=</span><span class="s1">first</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tuplify_var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                    <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">tmp</span><span class="s2">)</span>
                <span class="s1">first </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_TUPLE_UNPACK_WITH_CALL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">tuples</span><span class="s2">, </span><span class="s1">temps</span><span class="s2">, </span><span class="s1">is_assign</span><span class="s2">):</span>
        <span class="s4"># just unpack the input tuple, call inst will be handled afterwards</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_build_tuple_unpack</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">tuples</span><span class="s2">, </span><span class="s1">temps</span><span class="s2">, </span><span class="s1">is_assign</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_TUPLE_UNPACK</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">tuples</span><span class="s2">, </span><span class="s1">temps</span><span class="s2">, </span><span class="s1">is_assign</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_build_tuple_unpack</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">tuples</span><span class="s2">, </span><span class="s1">temps</span><span class="s2">, </span><span class="s1">is_assign</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_LIST_TO_TUPLE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">const_list</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">(</span><span class="s6">'list_to_tuple'</span><span class="s2">, (</span><span class="s1">const_list</span><span class="s2">,), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_CONST_KEY_MAP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">, </span><span class="s1">keytmps</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s4"># Unpack the constant key-tuple and reused build_map which takes</span>
        <span class="s4"># a sequence of (key, value) pair.</span>
        <span class="s1">keyvar </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">)</span>
        <span class="s4"># TODO: refactor this pattern. occurred several times.</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">) </span><span class="s0">and </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target </span><span class="s0">is </span><span class="s1">keyvar</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>
                <span class="s4"># scan up the block looking for the values, remove them</span>
                <span class="s4"># and find their name strings</span>
                <span class="s1">named_items </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]:</span>
                        <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s1">y</span><span class="s2">.</span><span class="s1">target</span><span class="s2">:</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
                            <span class="s1">named_items</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
                            <span class="s0">break</span>
                <span class="s1">keytup </span><span class="s2">= </span><span class="s1">named_items</span>
                <span class="s0">break</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">keytup</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>
        <span class="s1">keyconsts </span><span class="s2">= [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">keytup</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">kval</span><span class="s2">, </span><span class="s1">tmp </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keyconsts</span><span class="s2">, </span><span class="s1">keytmps</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">kval</span><span class="s2">, </span><span class="s1">tmp</span><span class="s2">)</span>
        <span class="s1">items </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">, </span><span class="s1">keytmps</span><span class="s2">), </span><span class="s1">map</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">, </span><span class="s1">values</span><span class="s2">)))</span>

        <span class="s4"># sort out literal values</span>
        <span class="s1">literal_items </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">values</span><span class="s2">:</span>
            <span class="s1">defns </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">v</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">defns</span><span class="s2">) != </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s0">break</span>
            <span class="s1">defn </span><span class="s2">= </span><span class="s1">defns</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">defn</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">):</span>
                <span class="s0">break</span>
            <span class="s1">literal_items</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">defn</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">resolve_const</span><span class="s2">(</span><span class="s1">v</span><span class="s2">):</span>
            <span class="s1">defns </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">v</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">defns</span><span class="s2">) != </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">_UNKNOWN_VALUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">v</span><span class="s2">).</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">defn </span><span class="s2">= </span><span class="s1">defns</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">defn</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">_UNKNOWN_VALUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">v</span><span class="s2">).</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">defn</span><span class="s2">.</span><span class="s1">value</span>

        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">literal_items</span><span class="s2">) != </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">):</span>
            <span class="s1">literal_dict </span><span class="s2">= {</span><span class="s1">x</span><span class="s2">: </span><span class="s1">resolve_const</span><span class="s2">(</span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in</span>
                            <span class="s1">zip</span><span class="s2">(</span><span class="s1">keytup</span><span class="s2">, </span><span class="s1">values</span><span class="s2">)}</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">literal_dict </span><span class="s2">= {</span><span class="s1">x</span><span class="s2">:</span><span class="s1">y </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keytup</span><span class="s2">, </span><span class="s1">literal_items</span><span class="s2">)}</span>

        <span class="s4"># to deal with things like {'a': 1, 'a': 'cat', 'b': 2, 'a': 2j}</span>
        <span class="s4"># store the index of the actual used value for a given key, this is</span>
        <span class="s4"># used when lowering to pull the right value out into the tuple repr</span>
        <span class="s4"># of a mixed value type dictionary.</span>
        <span class="s1">value_indexes </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">k </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">keytup</span><span class="s2">):</span>
            <span class="s1">value_indexes</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">i</span>

        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_map</span><span class="s2">(</span><span class="s1">items</span><span class="s2">=</span><span class="s1">items</span><span class="s2">,</span>
                                 <span class="s1">size</span><span class="s2">=</span><span class="s3">2</span><span class="s2">,</span>
                                 <span class="s1">literal_value</span><span class="s2">=</span><span class="s1">literal_dict</span><span class="s2">,</span>
                                 <span class="s1">value_indexes</span><span class="s2">=</span><span class="s1">value_indexes</span><span class="s2">,</span>
                                 <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_GET_ITER</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getiter</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_FOR_ITER</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">iterator</span><span class="s2">, </span><span class="s1">pair</span><span class="s2">, </span><span class="s1">indval</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Assign new block other this instruction. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">, </span><span class="s6">&quot;FOR_ITER must be block head&quot;</span>

        <span class="s4"># Emit code</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">iterator</span><span class="s2">)</span>

        <span class="s1">pairval </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">val</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">pairval</span><span class="s2">, </span><span class="s1">pair</span><span class="s2">)</span>

        <span class="s1">iternext </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">pair_first</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">pair</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">iternext</span><span class="s2">, </span><span class="s1">indval</span><span class="s2">)</span>

        <span class="s1">isvalid </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">pair_second</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">pair</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">isvalid</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">)</span>

        <span class="s4"># Conditional jump</span>
        <span class="s1">br </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Branch</span><span class="s2">(</span><span class="s1">cond</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">), </span><span class="s1">truebr</span><span class="s2">=</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">next</span><span class="s2">,</span>
                       <span class="s1">falsebr</span><span class="s2">=</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">get_jump_target</span><span class="s2">(),</span>
                       <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">br</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_SUBSCR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getitem</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_STORE_SUBSCR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">,</span>
                          <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DELETE_SUBSCR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DelItem</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_TUPLE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_tuple</span><span class="s2">(</span><span class="s1">items</span><span class="s2">=[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">items</span><span class="s2">],</span>
                                   <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_LIST</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_list</span><span class="s2">(</span><span class="s1">items</span><span class="s2">=[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">items</span><span class="s2">],</span>
                                  <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_SET</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_set</span><span class="s2">(</span><span class="s1">items</span><span class="s2">=[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">items</span><span class="s2">],</span>
                                 <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_SET_UPDATE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">updatevar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">updateattr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s6">'update'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">updateattr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">updatevar</span><span class="s2">)</span>
        <span class="s1">updateinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">updatevar</span><span class="s2">), (</span><span class="s1">value</span><span class="s2">,), (),</span>
                                  <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">updateinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_DICT_UPDATE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">updatevar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4"># We generate _update_from_bytecode instead of update so we can</span>
        <span class="s4"># differentiate between user .update() calls and those from the</span>
        <span class="s4"># bytecode. This is then used to recombine dictionaries in peephole</span>
        <span class="s4"># optimizations. See the dicussion in this PR about why:</span>
        <span class="s4"># https://github.com/numba/numba/pull/7964/files#r868229306</span>
        <span class="s1">updateattr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getattr</span><span class="s2">(</span>
            <span class="s1">target</span><span class="s2">, </span><span class="s6">'_update_from_bytecode'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">updateattr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">updatevar</span><span class="s2">)</span>
        <span class="s1">updateinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">updatevar</span><span class="s2">), (</span><span class="s1">value</span><span class="s2">,), (),</span>
                                  <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">updateinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BUILD_MAP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">got_items </span><span class="s2">= [(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">k</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">items</span><span class="s2">]</span>

        <span class="s4"># sort out literal values, this is a bit contrived but is to handle</span>
        <span class="s4"># situations like `{1: 10, 1: 10}` where the size of the literal dict</span>
        <span class="s4"># is smaller than the definition</span>
        <span class="s0">def </span><span class="s1">get_literals</span><span class="s2">(</span><span class="s1">target</span><span class="s2">):</span>
            <span class="s1">literal_items </span><span class="s2">= []</span>
            <span class="s1">values </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">target</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">values</span><span class="s2">:</span>
                <span class="s1">defns </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">defns</span><span class="s2">) != </span><span class="s3">1</span><span class="s2">:</span>
                    <span class="s0">break</span>
                <span class="s1">defn </span><span class="s2">= </span><span class="s1">defns</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">defn</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">):</span>
                    <span class="s0">break</span>
                <span class="s1">literal_items</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">defn</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">literal_items</span>

        <span class="s1">literal_keys </span><span class="s2">= </span><span class="s1">get_literals</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">got_items</span><span class="s2">)</span>
        <span class="s1">literal_values </span><span class="s2">= </span><span class="s1">get_literals</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">got_items</span><span class="s2">)</span>

        <span class="s1">has_literal_keys </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">got_items</span><span class="s2">)</span>
        <span class="s1">has_literal_values </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">literal_values</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">got_items</span><span class="s2">)</span>

        <span class="s1">value_indexes </span><span class="s2">= {}</span>
        <span class="s0">if not </span><span class="s1">has_literal_keys </span><span class="s0">and not </span><span class="s1">has_literal_values</span><span class="s2">:</span>
            <span class="s1">literal_dict </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">elif </span><span class="s1">has_literal_keys </span><span class="s0">and not </span><span class="s1">has_literal_values</span><span class="s2">:</span>
            <span class="s1">literal_dict </span><span class="s2">= {</span><span class="s1">x</span><span class="s2">: </span><span class="s1">_UNKNOWN_VALUE</span><span class="s2">(</span><span class="s1">y</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in</span>
                            <span class="s1">zip</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">, </span><span class="s1">got_items</span><span class="s2">)}</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">k </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">):</span>
                <span class="s1">value_indexes</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">i</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">literal_dict </span><span class="s2">= {</span><span class="s1">x</span><span class="s2">: </span><span class="s1">y </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">, </span><span class="s1">literal_values</span><span class="s2">)}</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">k </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">literal_keys</span><span class="s2">):</span>
                <span class="s1">value_indexes</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">i</span>

        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">build_map</span><span class="s2">(</span><span class="s1">items</span><span class="s2">=</span><span class="s1">got_items</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">,</span>
                                 <span class="s1">literal_value</span><span class="s2">=</span><span class="s1">literal_dict</span><span class="s2">,</span>
                                 <span class="s1">value_indexes</span><span class="s2">=</span><span class="s1">value_indexes</span><span class="s2">,</span>
                                 <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_STORE_MAP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">dct</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">StoreMap</span><span class="s2">(</span><span class="s1">dct</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">dct</span><span class="s2">), </span><span class="s1">key</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">),</span>
                           <span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_UNARY_NEGATIVE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">unary</span><span class="s2">(</span><span class="s6">'-'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_UNARY_POSITIVE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">unary</span><span class="s2">(</span><span class="s6">'+'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_UNARY_INVERT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">unary</span><span class="s2">(</span><span class="s6">'~'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_UNARY_NOT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">unary</span><span class="s2">(</span><span class="s6">'not'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_binop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">BINOPS_TO_OPERATORS</span><span class="s2">[</span><span class="s1">op</span><span class="s2">]</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">)</span>
        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">binop</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">=</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">=</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">immuop </span><span class="s2">= </span><span class="s1">BINOPS_TO_OPERATORS</span><span class="s2">[</span><span class="s1">op</span><span class="s2">]</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">INPLACE_BINOPS_TO_OPERATORS</span><span class="s2">[</span><span class="s1">op </span><span class="s2">+ </span><span class="s6">'='</span><span class="s2">]</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">)</span>
        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">inplace_binop</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">immuop</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">=</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">=</span><span class="s1">rhs</span><span class="s2">,</span>
                                     <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_OP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s6">&quot;=&quot; </span><span class="s0">in </span><span class="s1">op</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s1">op</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_ADD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'+'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_SUBTRACT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'-'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_MULTIPLY</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'*'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_DIVIDE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'/?'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_TRUE_DIVIDE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'/'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_FLOOR_DIVIDE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'//'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_MODULO</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'%'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_POWER</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'**'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_MATRIX_MULTIPLY</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'@'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_LSHIFT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'&lt;&lt;'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_RSHIFT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'&gt;&gt;'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_AND</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'&amp;'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_OR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'|'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BINARY_XOR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'^'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_ADD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'+'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_SUBTRACT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'-'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_MULTIPLY</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'*'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_DIVIDE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'/?'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_TRUE_DIVIDE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'/'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_FLOOR_DIVIDE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'//'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_MODULO</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'%'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_POWER</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'**'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_MATRIX_MULTIPLY</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'@'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_LSHIFT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'&lt;&lt;'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_RSHIFT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'&gt;&gt;'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_AND</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'&amp;'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_OR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'|'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_INPLACE_XOR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inplace_binop</span><span class="s2">(</span><span class="s6">'^'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_ABSOLUTE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s1">jmp </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">get_jump_target</span><span class="s2">(), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">jmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_FORWARD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s1">jmp </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">get_jump_target</span><span class="s2">(), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">jmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_BACKWARD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s1">jmp </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">get_jump_target</span><span class="s2">(), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">jmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_BLOCK</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">kind </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">kind </span><span class="s2">== </span><span class="s6">'with'</span><span class="s2">:</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PopBlock</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">kind </span><span class="s2">== </span><span class="s6">'try'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_try_block_end</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">op_RETURN_VALUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">retval</span><span class="s2">, </span><span class="s1">castval</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">retval</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">), </span><span class="s1">castval</span><span class="s2">)</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Return</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">castval</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
        <span class="s0">def </span><span class="s1">op_RETURN_CONST</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">retval</span><span class="s2">, </span><span class="s1">castval</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_consts</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
            <span class="s1">const </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">const</span><span class="s2">, </span><span class="s1">retval</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">retval</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">), </span><span class="s1">castval</span><span class="s2">)</span>
            <span class="s1">ret </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Return</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">castval</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
        <span class="s0">pass</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_COMPARE_OP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">dis</span><span class="s2">.</span><span class="s1">cmp_op</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">&gt;&gt; </span><span class="s3">4</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">dis</span><span class="s2">.</span><span class="s1">cmp_op</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">op </span><span class="s2">== </span><span class="s6">'in' </span><span class="s0">or </span><span class="s1">op </span><span class="s2">== </span><span class="s6">'not in'</span><span class="s2">:</span>
            <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">lhs</span>

        <span class="s0">if </span><span class="s1">op </span><span class="s2">== </span><span class="s6">'not in'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'in'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">unary</span><span class="s2">(</span><span class="s6">'not'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">tmp</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">op </span><span class="s2">== </span><span class="s6">'exception match'</span><span class="s2">:</span>
            <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span>
                <span class="s6">&quot;exception_match&quot;</span><span class="s2">, </span><span class="s1">eh</span><span class="s2">.</span><span class="s1">exception_match</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">exc_match_name </span><span class="s2">= </span><span class="s6">'$exc_match'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">exc_match_name</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">)</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span>
            <span class="s1">exc </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">exc_match_name</span><span class="s2">), </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">), </span><span class="s1">kws</span><span class="s2">=(), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_IS_OP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s4"># invert if op case is 1</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s6">'is not' </span><span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">== </span><span class="s3">1 </span><span class="s0">else </span><span class="s6">'is'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_CONTAINS_OP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">lhs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_binop</span><span class="s2">(</span><span class="s6">'in'</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
        <span class="s4"># invert if op case is 1</span>
        <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">unary</span><span class="s2">(</span><span class="s6">'not'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">tmp</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_BREAK_LOOP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">end</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">end </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">loop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">syntax_blocks</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loop</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Loop</span><span class="s2">)</span>
            <span class="s1">end </span><span class="s2">= </span><span class="s1">loop</span><span class="s2">.</span><span class="s1">exit</span>
        <span class="s1">jmp </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">end</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">jmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">):</span>
        <span class="s1">brs </span><span class="s2">= {</span>
            <span class="s0">True</span><span class="s2">: </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">get_jump_target</span><span class="s2">(),</span>
            <span class="s0">False</span><span class="s2">: </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">next</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s1">truebr </span><span class="s2">= </span><span class="s1">brs</span><span class="s2">[</span><span class="s1">iftrue</span><span class="s2">]</span>
        <span class="s1">falsebr </span><span class="s2">= </span><span class="s1">brs</span><span class="s2">[</span><span class="s0">not </span><span class="s1">iftrue</span><span class="s2">]</span>

        <span class="s1">name </span><span class="s2">= </span><span class="s6">&quot;bool%s&quot; </span><span class="s2">% (</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;bool&quot;</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s1">callres </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">), (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">),), (),</span>
                               <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

        <span class="s1">pname </span><span class="s2">= </span><span class="s6">&quot;$%spred&quot; </span><span class="s2">% (</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s1">predicate </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">callres</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">pname</span><span class="s2">)</span>
        <span class="s1">bra </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Branch</span><span class="s2">(</span><span class="s1">cond</span><span class="s2">=</span><span class="s1">predicate</span><span class="s2">, </span><span class="s1">truebr</span><span class="s2">=</span><span class="s1">truebr</span><span class="s2">, </span><span class="s1">falsebr</span><span class="s2">=</span><span class="s1">falsebr</span><span class="s2">,</span>
                        <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bra</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_IF_FALSE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_IF_TRUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_jump_if_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">):</span>
        <span class="s4"># branch pruning assumes true falls through and false is jump</span>
        <span class="s1">truebr </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">next</span>
        <span class="s1">falsebr </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">get_jump_target</span><span class="s2">()</span>

        <span class="s4"># this seems strange</span>
        <span class="s0">if not </span><span class="s1">iftrue</span><span class="s2">:</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">BINOPS_TO_OPERATORS</span><span class="s2">[</span><span class="s6">&quot;is&quot;</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">BINOPS_TO_OPERATORS</span><span class="s2">[</span><span class="s6">&quot;is not&quot;</span><span class="s2">]</span>

        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">),</span>
                         <span class="s1">name</span><span class="s2">=</span><span class="s6">f&quot;$constNone</span><span class="s0">{</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s0">}</span><span class="s6">&quot;</span><span class="s2">)</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">)</span>
        <span class="s1">isnone </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">binop</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">=</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">=</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

        <span class="s1">maybeNone </span><span class="s2">= </span><span class="s6">f&quot;$maybeNone</span><span class="s0">{</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s0">}</span><span class="s6">&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">isnone</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">maybeNone</span><span class="s2">)</span>

        <span class="s1">name </span><span class="s2">= </span><span class="s6">f&quot;$bool</span><span class="s0">{</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s0">}</span><span class="s6">&quot;</span>
        <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;bool&quot;</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s1">callres </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">), (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">maybeNone</span><span class="s2">),), (),</span>
                               <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

        <span class="s1">pname </span><span class="s2">= </span><span class="s6">f&quot;$pred</span><span class="s0">{</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">offset</span><span class="s0">}</span><span class="s6">&quot;</span>
        <span class="s1">predicate </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">callres</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">pname</span><span class="s2">)</span>
        <span class="s1">branch </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Branch</span><span class="s2">(</span><span class="s1">cond</span><span class="s2">=</span><span class="s1">predicate</span><span class="s2">,</span>
                           <span class="s1">truebr</span><span class="s2">=</span><span class="s1">truebr</span><span class="s2">,</span>
                           <span class="s1">falsebr</span><span class="s2">=</span><span class="s1">falsebr</span><span class="s2">,</span>
                           <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">branch</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_NONE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_jump_if_none</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_NOT_NONE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_jump_if_none</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
        <span class="s0">def </span><span class="s1">op_POP_JUMP_IF_NONE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_jump_if_none</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">op_POP_JUMP_IF_NOT_NONE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_jump_if_none</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
        <span class="s0">pass</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_NONE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_jump_if_none</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_NOT_NONE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_jump_if_none</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_FALSE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_FORWARD_IF_TRUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_FALSE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_BACKWARD_IF_TRUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_IF_FALSE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_POP_JUMP_IF_TRUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_IF_FALSE_OR_POP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_IF_TRUE_OR_POP</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_op_JUMP_IF</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">=</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">iftrue</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_CHECK_EXC_MATCH</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s1">tos</span><span class="s2">, </span><span class="s1">tos1</span><span class="s2">):</span>
        <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span>
            <span class="s6">&quot;exception_match&quot;</span><span class="s2">, </span><span class="s1">eh</span><span class="s2">.</span><span class="s1">exception_match</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">exc_match_name </span><span class="s2">= </span><span class="s6">'$exc_match'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">exc_match_name</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tos1</span><span class="s2">)</span>
        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tos</span><span class="s2">)</span>
        <span class="s1">exc </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">exc_match_name</span><span class="s2">), </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">), </span><span class="s1">kws</span><span class="s2">=(), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_JUMP_IF_NOT_EXC_MATCH</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s1">tos</span><span class="s2">, </span><span class="s1">tos1</span><span class="s2">):</span>
        <span class="s1">truebr </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">next</span>
        <span class="s1">falsebr </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">get_jump_target</span><span class="s2">()</span>
        <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span>
            <span class="s6">&quot;exception_match&quot;</span><span class="s2">, </span><span class="s1">eh</span><span class="s2">.</span><span class="s1">exception_match</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">exc_match_name </span><span class="s2">= </span><span class="s6">'$exc_match'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">exc_match_name</span><span class="s2">, </span><span class="s1">redefine</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tos1</span><span class="s2">)</span>
        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tos</span><span class="s2">)</span>
        <span class="s1">exc </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">exc_match_name</span><span class="s2">), </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">), </span><span class="s1">kws</span><span class="s2">=(), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">predicate </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">)</span>
        <span class="s1">bra </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Branch</span><span class="s2">(</span><span class="s1">cond</span><span class="s2">=</span><span class="s1">predicate</span><span class="s2">, </span><span class="s1">truebr</span><span class="s2">=</span><span class="s1">truebr</span><span class="s2">, </span><span class="s1">falsebr</span><span class="s2">=</span><span class="s1">falsebr</span><span class="s2">,</span>
                        <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bra</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_RERAISE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s1">tryblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">active_try_block</span>
        <span class="s0">if </span><span class="s1">tryblk </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">TryRaise</span><span class="s2">(</span><span class="s1">exception</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_try_block_end</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">tryblk</span><span class="s2">[</span><span class="s6">'end'</span><span class="s2">], </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># Numba can't handle this case and it's caught else where, this is a</span>
            <span class="s4"># runtime guard in case this is reached by unknown means.</span>
            <span class="s1">msg </span><span class="s2">= (</span><span class="s6">f&quot;Unreachable condition reached (op code RERAISE executed)&quot;</span>
                   <span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">error_extras</span><span class="s2">[</span><span class="s6">'reportable'</span><span class="s2">]</span><span class="s0">}</span><span class="s6">&quot;</span><span class="s2">)</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">StaticRaise</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, (</span><span class="s1">msg</span><span class="s2">,), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_RAISE_VARARGS</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">exc </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">exc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">)</span>
        <span class="s1">tryblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dfainfo</span><span class="s2">.</span><span class="s1">active_try_block</span>
        <span class="s0">if </span><span class="s1">tryblk </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s4"># In a try block</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">TryRaise</span><span class="s2">(</span><span class="s1">exception</span><span class="s2">=</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_try_block_end</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">tryblk</span><span class="s2">[</span><span class="s6">'end'</span><span class="s2">], </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># Not in a try block</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Raise</span><span class="s2">(</span><span class="s1">exception</span><span class="s2">=</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_YIELD_VALUE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s4"># initialize index to None.  it's being set later in post-processing</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">inst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Yield</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_MAKE_FUNCTION</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">closure</span><span class="s2">, </span><span class="s1">annotations</span><span class="s2">,</span>
                         <span class="s1">kwdefaults</span><span class="s2">, </span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s4"># annotations are ignored by numba but useful for static analysis</span>
        <span class="s4"># re. https://github.com/numba/numba/issues/7269</span>
        <span class="s0">if </span><span class="s1">kwdefaults </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s6">&quot;op_MAKE_FUNCTION with kwdefaults is not implemented&quot;</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">defaults</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s1">defaults </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">([</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">defaults</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">defaults </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">defaults</span><span class="s2">)</span>

        <span class="s1">assume_code_const </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">definitions</span><span class="s2">[</span><span class="s1">code</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">assume_code_const</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">):</span>
            <span class="s1">msg </span><span class="s2">= (</span>
                <span class="s6">&quot;Unsupported use of closure. &quot;</span>
                <span class="s6">&quot;Probably caused by complex control-flow constructs; &quot;</span>
                <span class="s6">&quot;e.g. try-except&quot;</span>
            <span class="s2">)</span>
            <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">fcode </span><span class="s2">= </span><span class="s1">assume_code_const</span><span class="s2">.</span><span class="s1">value</span>
        <span class="s0">if </span><span class="s1">name</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">closure</span><span class="s2">:</span>
            <span class="s1">closure </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">closure</span><span class="s2">)</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">make_function</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">fcode</span><span class="s2">, </span><span class="s1">closure</span><span class="s2">, </span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_MAKE_CLOSURE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">closure</span><span class="s2">, </span><span class="s1">annotations</span><span class="s2">,</span>
                        <span class="s1">kwdefaults</span><span class="s2">, </span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">op_MAKE_FUNCTION</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">closure</span><span class="s2">, </span><span class="s1">annotations</span><span class="s2">,</span>
                              <span class="s1">kwdefaults</span><span class="s2">, </span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_LOAD_CLOSURE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">__code__</span><span class="s2">.</span><span class="s1">_varname_from_oparg</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">gl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">NotDefinedError</span><span class="s2">:</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s6">&quot;Unsupported use of op_LOAD_CLOSURE encountered&quot;</span>
                    <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_freevars</span><span class="s2">:</span>
                <span class="s1">idx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_freevars</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_closure_value</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
                <span class="s1">gl </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FreeVar</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s3">0</span><span class="s2">, </span><span class="s6">&quot;unreachable&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">gl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)):</span>
        <span class="s0">def </span><span class="s1">op_LOAD_CLOSURE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">n_cellvars </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">&lt; </span><span class="s1">n_cellvars</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_cellvars</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg</span><span class="s2">]</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">gl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">NotDefinedError</span><span class="s2">:</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s6">&quot;Unsupported use of op_LOAD_CLOSURE encountered&quot;</span>
                    <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">idx </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">arg </span><span class="s2">- </span><span class="s1">n_cellvars</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code_freevars</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_closure_value</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
                <span class="s1">gl </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FreeVar</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">gl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_LIST_APPEND</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">appendvar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">appendattr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s6">'append'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">appendattr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">appendvar</span><span class="s2">)</span>
        <span class="s1">appendinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">appendvar</span><span class="s2">), (</span><span class="s1">value</span><span class="s2">,), (),</span>
                                  <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">appendinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_LIST_EXTEND</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">extendvar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s4"># If the statements between the current instruction and the target</span>
        <span class="s4"># are N * consts followed by build_tuple AND the target has no items,</span>
        <span class="s4"># it's a situation where a list is being statically initialised, rewrite</span>
        <span class="s4"># the build_tuple as a build_list, drop the extend, and wire up the</span>
        <span class="s4"># target as the result from the build_tuple that's been rewritten.</span>

        <span class="s4"># See if this is the first statement in a block, if so its probably from</span>
        <span class="s4"># control flow in a tuple unpack like:</span>
        <span class="s4"># `(*(1, (2,) if predicate else (3,)))`</span>
        <span class="s4"># this cannot be handled as present so raise</span>
        <span class="s1">msg </span><span class="s2">= (</span><span class="s6">&quot;An unsupported bytecode sequence has been encountered: &quot;</span>
               <span class="s6">&quot;op_LIST_EXTEND at the start of a block.</span><span class="s0">\n\n</span><span class="s6">This could be &quot;</span>
               <span class="s6">&quot;due to the use of a branch in a tuple unpacking statement.&quot;</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s4"># is last emitted statement a build_tuple?</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">ok </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s6">&quot;build_tuple&quot;</span>
        <span class="s4"># check statements from self.current_block.body[-1] through to target,</span>
        <span class="s4"># make sure they are consts</span>
        <span class="s1">build_empty_list </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">ok</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">stmt </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">]):</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
                    <span class="s1">ok </span><span class="s2">= </span><span class="s0">False</span>
                    <span class="s0">break</span>
                <span class="s4"># if its not a const, it needs to be the `build_list` for the</span>
                <span class="s4"># target, else it's something else we don't know about so just</span>
                <span class="s4"># bail</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">):</span>
                    <span class="s0">continue</span>

                <span class="s4"># it's not a const, check for target</span>
                <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target </span><span class="s2">== </span><span class="s1">target</span><span class="s2">:</span>
                    <span class="s1">build_empty_list </span><span class="s2">= </span><span class="s1">stmt</span>
                    <span class="s4"># it's only ok to do this if the target has no initializer</span>
                    <span class="s4"># already</span>
                    <span class="s1">ok </span><span class="s2">= </span><span class="s0">not </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span>
                    <span class="s0">break</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">ok </span><span class="s2">= </span><span class="s0">False</span>
                    <span class="s0">break</span>
        <span class="s0">if </span><span class="s1">ok </span><span class="s0">and </span><span class="s1">build_empty_list </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ok</span><span class="s2">:</span>
            <span class="s1">stmts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span>
            <span class="s1">build_tuple_asgn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s4"># move build list to last issued statement</span>
            <span class="s1">stmts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmts</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">stmts</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">build_empty_list</span><span class="s2">)))</span>
            <span class="s4"># fix the build list</span>
            <span class="s1">build_tuple </span><span class="s2">= </span><span class="s1">build_tuple_asgn</span><span class="s2">.</span><span class="s1">value</span>
            <span class="s1">build_list </span><span class="s2">= </span><span class="s1">build_empty_list</span><span class="s2">.</span><span class="s1">value</span>
            <span class="s1">build_list</span><span class="s2">.</span><span class="s1">items </span><span class="s2">= </span><span class="s1">build_tuple</span><span class="s2">.</span><span class="s1">items</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># it's just a list extend with no static init, let it be</span>
            <span class="s1">extendattr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s6">'extend'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">extendattr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">extendvar</span><span class="s2">)</span>
            <span class="s1">extendinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">extendvar</span><span class="s2">), (</span><span class="s1">value</span><span class="s2">,), (),</span>
                                      <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">extendinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_MAP_ADD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">setitemvar</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">setitemattr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s6">'__setitem__'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">setitemattr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">setitemvar</span><span class="s2">)</span>
        <span class="s1">appendinst </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">setitemvar</span><span class="s2">), (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">,), (),</span>
                                  <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">appendinst</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_LOAD_ASSERTION_ERROR</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">res</span><span class="s2">):</span>
        <span class="s1">gv_fn </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">(</span><span class="s6">&quot;AssertionError&quot;</span><span class="s2">, </span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">gv_fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s4"># NOTE: The LOAD_METHOD opcode is implemented as a LOAD_ATTR for ease,</span>
    <span class="s4"># however this means a new object (the bound-method instance) could be</span>
    <span class="s4"># created. Conversely, using a pure LOAD_METHOD no intermediary is present</span>
    <span class="s4"># and it is essentially like a pointer grab and forward to CALL_METHOD. The</span>
    <span class="s4"># net outcome is that the implementation in Numba produces the same result,</span>
    <span class="s4"># but in object mode it may be that it runs more slowly than it would if</span>
    <span class="s4"># run in CPython.</span>

    <span class="s0">def </span><span class="s1">op_LOAD_METHOD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">op_LOAD_ATTR</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">op_CALL_METHOD</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">op_CALL_FUNCTION</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
        <span class="s0">def </span><span class="s1">op_CALL_INTRINSIC_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">operand</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">operand </span><span class="s2">== </span><span class="s1">ci1op</span><span class="s2">.</span><span class="s1">INTRINSIC_STOPITERATION_ERROR</span><span class="s2">:</span>
                <span class="s1">stmt </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">StaticRaise</span><span class="s2">(</span><span class="s1">INTRINSIC_STOPITERATION_ERROR</span><span class="s2">, (),</span>
                                      <span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current_block</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
                <span class="s0">return</span>
            <span class="s0">elif </span><span class="s1">operand </span><span class="s2">== </span><span class="s1">ci1op</span><span class="s2">.</span><span class="s1">UNARY_POSITIVE</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">op_UNARY_POSITIVE</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
                <span class="s0">return</span>
            <span class="s0">elif </span><span class="s1">operand </span><span class="s2">== </span><span class="s1">ci1op</span><span class="s2">.</span><span class="s1">INTRINSIC_LIST_TO_TUPLE</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">op_LIST_TO_TUPLE</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
                <span class="s0">return</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">operand</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
        <span class="s0">pass</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>


<span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), ):</span>
    <span class="s0">class </span><span class="s1">INTRINSIC_STOPITERATION_ERROR</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s0">pass</span>
<span class="s0">elif </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
    <span class="s0">pass</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">PYVERSION</span><span class="s2">)</span>
</pre>
</body>
</html>