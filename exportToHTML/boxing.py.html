<html>
<head>
<title>boxing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
boxing.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Boxing and unboxing of native Numba values to / from CPython objects. 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">llvmlite </span><span class="s2">import </span><span class="s1">ir</span>

<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">types</span><span class="s3">, </span><span class="s1">cgutils</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">pythonapi </span><span class="s2">import </span><span class="s1">box</span><span class="s3">, </span><span class="s1">unbox</span><span class="s3">, </span><span class="s1">reflect</span><span class="s3">, </span><span class="s1">NativeValue</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">NumbaNotImplementedError</span><span class="s3">, </span><span class="s1">TypingError</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">typing</span><span class="s3">.</span><span class="s1">typeof </span><span class="s2">import </span><span class="s1">typeof</span><span class="s3">, </span><span class="s1">Purpose</span>

<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">cpython </span><span class="s2">import </span><span class="s1">setobj</span><span class="s3">, </span><span class="s1">listobj</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">np </span><span class="s2">import </span><span class="s1">numpy_support</span>
<span class="s2">from </span><span class="s1">contextlib </span><span class="s2">import </span><span class="s1">contextmanager</span><span class="s3">, </span><span class="s1">ExitStack</span>


<span class="s4">#</span>
<span class="s4"># Scalar types</span>
<span class="s4">#</span>

<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Boolean</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_bool</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">bool_from_bool</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Boolean</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_boolean</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">istrue </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_istrue</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s1">zero </span><span class="s3">= </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">istrue</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">val </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">istrue</span><span class="s3">, </span><span class="s1">zero</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">c_api_error</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">IntegerLiteral</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">BooleanLiteral</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_literal_integer</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">val </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">literal_type</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">literal_type</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_integer</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">signed</span><span class="s3">:</span>
        <span class="s1">ival </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">sext</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">longlong</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">long_from_longlong</span><span class="s3">(</span><span class="s1">ival</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ullval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">zext</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">ulonglong</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">long_from_ulonglong</span><span class="s3">(</span><span class="s1">ullval</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_integer</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">ll_type </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_argument_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">val </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ll_type</span><span class="s3">)</span>
    <span class="s1">longobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">number_long</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">if_object_ok</span><span class="s3">(</span><span class="s1">longobj</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">signed</span><span class="s3">:</span>
            <span class="s1">llval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">long_as_longlong</span><span class="s3">(</span><span class="s1">longobj</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">llval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">long_as_ulonglong</span><span class="s3">(</span><span class="s1">longobj</span><span class="s3">)</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">longobj</span><span class="s3">)</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">trunc</span><span class="s3">(</span><span class="s1">llval</span><span class="s3">, </span><span class="s1">ll_type</span><span class="s3">), </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">val</span><span class="s3">),</span>
                       <span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">c_api_error</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Float</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_float</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">:</span>
        <span class="s1">dbval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fpext</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">double</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span>
        <span class="s1">dbval </span><span class="s3">= </span><span class="s1">val</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">float_from_double</span><span class="s3">(</span><span class="s1">dbval</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Float</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_float</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">fobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">number_float</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s1">dbval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">float_as_double</span><span class="s3">(</span><span class="s1">fobj</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">fobj</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">:</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fptrunc</span><span class="s3">(</span><span class="s1">dbval</span><span class="s3">,</span>
                                <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_argument_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">dbval</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">c_api_error</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Complex</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_complex</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">cval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">:</span>
        <span class="s1">freal </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fpext</span><span class="s3">(</span><span class="s1">cval</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">double</span><span class="s3">)</span>
        <span class="s1">fimag </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fpext</span><span class="s3">(</span><span class="s1">cval</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">double</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">complex128</span>
        <span class="s1">freal</span><span class="s3">, </span><span class="s1">fimag </span><span class="s3">= </span><span class="s1">cval</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">cval</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">complex_from_doubles</span><span class="s3">(</span><span class="s1">freal</span><span class="s3">, </span><span class="s1">fimag</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Complex</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_complex</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s4"># First unbox to complex128, since that's what CPython gives us</span>
    <span class="s1">c128 </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">)</span>
    <span class="s1">ok </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">complex_adaptor</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c128</span><span class="s3">.</span><span class="s1">_getpointer</span><span class="s3">())</span>
    <span class="s1">failed </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_false</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ok</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_unlikely</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">failed</span><span class="s3">):</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">err_set_string</span><span class="s3">(</span><span class="s6">&quot;PyExc_TypeError&quot;</span><span class="s3">,</span>
                               <span class="s6">&quot;conversion to %s failed&quot; </span><span class="s3">% (</span><span class="s1">typ</span><span class="s3">,))</span>

    <span class="s2">if </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">:</span>
        <span class="s4"># Downcast to complex64 if necessary</span>
        <span class="s1">cplx </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">)</span>
        <span class="s1">cplx</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">c128</span><span class="s3">.</span><span class="s1">real</span><span class="s3">,</span>
                                   <span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">cplx</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">c128</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">,</span>
                                   <span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">typ </span><span class="s3">== </span><span class="s1">types</span><span class="s3">.</span><span class="s1">complex128</span>
        <span class="s1">cplx </span><span class="s3">= </span><span class="s1">c128</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">cplx</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">(), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">failed</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NoneType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_none</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">make_none</span><span class="s3">()</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NoneType</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">EllipsisType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_none</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_dummy_value</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NPDatetime</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_npdatetime</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">create_np_datetime</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">unit_code</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NPDatetime</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_npdatetime</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">val </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">extract_np_datetime</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">c_api_error</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NPTimedelta</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_nptimedelta</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">create_np_timedelta</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">unit_code</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NPTimedelta</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_nptimedelta</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">val </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">extract_np_timedelta</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">c_api_error</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">RawPointer</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_raw_pointer</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert a raw pointer to a Python int. 
    &quot;&quot;&quot;</span>
    <span class="s1">ll_intp </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">uintp</span><span class="s3">)</span>
    <span class="s1">addr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">ptrtoint</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">ll_intp</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">uintp</span><span class="s3">, </span><span class="s1">addr</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">EnumMember</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_enum</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Fetch an enum member given its native value. 
    &quot;&quot;&quot;</span>
    <span class="s1">valobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s4"># Call the enum class with the value object</span>
    <span class="s1">cls_obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">instance_class</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">call_function_objargs</span><span class="s3">(</span><span class="s1">cls_obj</span><span class="s3">, (</span><span class="s1">valobj</span><span class="s3">,))</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">EnumMember</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_enum</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert an enum member's value to its native value. 
    &quot;&quot;&quot;</span>
    <span class="s1">valobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_getattr_string</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s6">&quot;value&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">valobj</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">UndefVar</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_undefvar</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;This type cannot be boxed, there's no Python equivalent&quot;&quot;&quot;</span>
    <span class="s1">msg </span><span class="s3">= (</span><span class="s6">&quot;UndefVar type cannot be boxed, there is no Python equivalent of &quot;</span>
           <span class="s6">&quot;this type.&quot;</span><span class="s3">)</span>
    <span class="s2">raise </span><span class="s1">TypingError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

<span class="s4">#</span>
<span class="s4"># Composite types</span>
<span class="s4">#</span>

<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Record</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_record</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s4"># Note we will create a copy of the record</span>
    <span class="s4"># This is the only safe way.</span>
    <span class="s1">size </span><span class="s3">= </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">IntType</span><span class="s3">(</span><span class="s5">32</span><span class="s3">), </span><span class="s1">val</span><span class="s3">.</span><span class="s1">type</span><span class="s3">.</span><span class="s1">pointee</span><span class="s3">.</span><span class="s1">count</span><span class="s3">)</span>
    <span class="s1">ptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">PointerType</span><span class="s3">(</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">IntType</span><span class="s3">(</span><span class="s5">8</span><span class="s3">)))</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">recreate_record</span><span class="s3">(</span><span class="s1">ptr</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">env_manager</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Record</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_record</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">buf </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">alloca_buffer</span><span class="s3">()</span>
    <span class="s1">ptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">extract_record_data</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">buf</span><span class="s3">)</span>
    <span class="s1">is_error </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)</span>

    <span class="s1">ltyp </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">val </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">ptr</span><span class="s3">, </span><span class="s1">ltyp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cleanup</span><span class="s3">():</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">release_buffer</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">cleanup</span><span class="s3">=</span><span class="s1">cleanup</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">is_error</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">UnicodeCharSeq</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_unicodecharseq</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s4"># XXX could kind be determined from strptr?</span>
    <span class="s1">unicode_kind </span><span class="s3">= {</span>
        <span class="s5">1</span><span class="s3">: </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">py_unicode_1byte_kind</span><span class="s3">,</span>
        <span class="s5">2</span><span class="s3">: </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">py_unicode_2byte_kind</span><span class="s3">,</span>
        <span class="s5">4</span><span class="s3">: </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">py_unicode_4byte_kind</span><span class="s3">}[</span><span class="s1">numpy_support</span><span class="s3">.</span><span class="s1">sizeof_unicode_char</span><span class="s3">]</span>
    <span class="s1">kind </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">, </span><span class="s1">unicode_kind</span><span class="s3">)</span>
    <span class="s1">rawptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">strptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">rawptr</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">cstring</span><span class="s3">)</span>

    <span class="s1">fullsize </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">count</span><span class="s3">)</span>
    <span class="s1">zero </span><span class="s3">= </span><span class="s1">fullsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">one </span><span class="s3">= </span><span class="s1">fullsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">step </span><span class="s3">= </span><span class="s1">fullsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">(</span><span class="s1">numpy_support</span><span class="s3">.</span><span class="s1">sizeof_unicode_char</span><span class="s3">)</span>
    <span class="s1">count </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">zero</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">loop_nest</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, [</span><span class="s1">fullsize</span><span class="s3">], </span><span class="s1">fullsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">) </span><span class="s2">as </span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]:</span>
        <span class="s4"># Get char at idx</span>
        <span class="s1">ch </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">gep</span><span class="s3">(</span><span class="s1">strptr</span><span class="s3">, [</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">mul</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">, </span><span class="s1">step</span><span class="s3">)]))</span>
        <span class="s4"># If the char is a non-null-byte, store the next index as count</span>
        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ch</span><span class="s3">)):</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">, </span><span class="s1">one</span><span class="s3">), </span><span class="s1">count</span><span class="s3">)</span>
    <span class="s1">strlen </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">string_from_kind_and_data</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">strptr</span><span class="s3">, </span><span class="s1">strlen</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">UnicodeCharSeq</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_unicodecharseq</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">lty </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>

    <span class="s1">ok</span><span class="s3">, </span><span class="s1">buffer</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">is_ascii</span><span class="s3">, </span><span class="s1">hashv </span><span class="s3">= </span><span class="s1">\</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">string_as_string_size_and_kind</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s4"># If conversion is ok, copy the buffer to the output storage.</span>
    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_likely</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ok</span><span class="s3">):</span>
        <span class="s4"># Check if the returned string size fits in the charseq</span>
        <span class="s1">storage_size </span><span class="s3">= </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">size</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">count</span><span class="s3">)</span>
        <span class="s1">size_fits </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">&quot;&lt;=&quot;</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">storage_size</span><span class="s3">)</span>

        <span class="s4"># Allow truncation of string</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">size_fits</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">storage_size</span><span class="s3">)</span>

        <span class="s4"># Initialize output to zero bytes</span>
        <span class="s1">null_string </span><span class="s3">= </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">lty</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">outspace  </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">null_string</span><span class="s3">)</span>

        <span class="s4"># We don't need to set the NULL-terminator because the storage</span>
        <span class="s4"># is already zero-filled.</span>
        <span class="s1">cgutils</span><span class="s3">.</span><span class="s1">memcpy</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                        <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">outspace</span><span class="s3">, </span><span class="s1">buffer</span><span class="s3">.</span><span class="s1">type</span><span class="s3">),</span>
                        <span class="s1">buffer</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>

    <span class="s1">ret </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">outspace</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Bytes</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_bytes</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_helper</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">ret </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">bytes_from_string_and_size</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">nitems</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">ret</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">CharSeq</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_charseq</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">rawptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">strptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">rawptr</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">cstring</span><span class="s3">)</span>
    <span class="s1">fullsize </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">count</span><span class="s3">)</span>
    <span class="s1">zero </span><span class="s3">= </span><span class="s1">fullsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">one </span><span class="s3">= </span><span class="s1">fullsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">count </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">zero</span><span class="s3">)</span>

    <span class="s4"># Find the length of the string, mimicking Numpy's behaviour:</span>
    <span class="s4"># search for the last non-null byte in the underlying storage</span>
    <span class="s4"># (e.g. b'A\0\0B\0\0\0' will return the logical string b'A\0\0B')</span>
    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">loop_nest</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, [</span><span class="s1">fullsize</span><span class="s3">], </span><span class="s1">fullsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">) </span><span class="s2">as </span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]:</span>
        <span class="s4"># Get char at idx</span>
        <span class="s1">ch </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">gep</span><span class="s3">(</span><span class="s1">strptr</span><span class="s3">, [</span><span class="s1">idx</span><span class="s3">]))</span>
        <span class="s4"># If the char is a non-null-byte, store the next index as count</span>
        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ch</span><span class="s3">)):</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">, </span><span class="s1">one</span><span class="s3">), </span><span class="s1">count</span><span class="s3">)</span>

    <span class="s1">strlen </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">count</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">bytes_from_string_and_size</span><span class="s3">(</span><span class="s1">strptr</span><span class="s3">, </span><span class="s1">strlen</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">CharSeq</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_charseq</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">lty </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">ok</span><span class="s3">, </span><span class="s1">buffer</span><span class="s3">, </span><span class="s1">size </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">string_as_string_and_size</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s4"># If conversion is ok, copy the buffer to the output storage.</span>
    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_likely</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ok</span><span class="s3">):</span>
        <span class="s4"># Check if the returned string size fits in the charseq</span>
        <span class="s1">storage_size </span><span class="s3">= </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">size</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">count</span><span class="s3">)</span>
        <span class="s1">size_fits </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">&quot;&lt;=&quot;</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">storage_size</span><span class="s3">)</span>

        <span class="s4"># Allow truncation of string</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">size_fits</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">storage_size</span><span class="s3">)</span>

        <span class="s4"># Initialize output to zero bytes</span>
        <span class="s1">null_string </span><span class="s3">= </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">lty</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">outspace  </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">null_string</span><span class="s3">)</span>

        <span class="s4"># We don't need to set the NULL-terminator because the storage</span>
        <span class="s4"># is already zero-filled.</span>
        <span class="s1">cgutils</span><span class="s3">.</span><span class="s1">memcpy</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                       <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">outspace</span><span class="s3">, </span><span class="s1">buffer</span><span class="s3">.</span><span class="s1">type</span><span class="s3">),</span>
                       <span class="s1">buffer</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>

    <span class="s1">ret </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">outspace</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Optional</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_optional</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">optval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_helper</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">ret </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">borrow_none</span><span class="s3">())</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">optval</span><span class="s3">.</span><span class="s1">valid</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">then</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">then</span><span class="s3">:</span>
            <span class="s1">validres </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">optval</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">validres</span><span class="s3">, </span><span class="s1">ret</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">make_none</span><span class="s3">(), </span><span class="s1">ret</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Optional</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_optional</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert object *obj* to a native optional structure. 
    &quot;&quot;&quot;</span>
    <span class="s1">noneval </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_optional_none</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">type</span><span class="s3">)</span>
    <span class="s1">is_not_none </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">borrow_none</span><span class="s3">())</span>

    <span class="s1">retptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">noneval</span><span class="s3">.</span><span class="s1">type</span><span class="s3">)</span>
    <span class="s1">errptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">is_not_none</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">then</span><span class="s3">, </span><span class="s1">orelse</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">then</span><span class="s3">:</span>
            <span class="s1">native </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">)</span>
            <span class="s1">just </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_optional_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                                                 <span class="s1">typ</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">native</span><span class="s3">.</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">just</span><span class="s3">, </span><span class="s1">retptr</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">native</span><span class="s3">.</span><span class="s1">is_error</span><span class="s3">, </span><span class="s1">errptr</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">orelse</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">noneval</span><span class="s3">, </span><span class="s1">retptr</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">native</span><span class="s3">.</span><span class="s1">cleanup </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">cleanup</span><span class="s3">():</span>
            <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">is_not_none</span><span class="s3">):</span>
                <span class="s1">native</span><span class="s3">.</span><span class="s1">cleanup</span><span class="s3">()</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">cleanup </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">ret </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">retptr</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">errptr</span><span class="s3">),</span>
                       <span class="s1">cleanup</span><span class="s3">=</span><span class="s1">cleanup</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">SliceType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_slice</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert object *obj* to a native slice structure. 
    &quot;&quot;&quot;</span>
    <span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">cpython </span><span class="s2">import </span><span class="s1">slicing</span>
    <span class="s1">ok</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">slice_as_ints</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s1">sli </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_helper</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">sli</span><span class="s3">.</span><span class="s1">start </span><span class="s3">= </span><span class="s1">start</span>
    <span class="s1">sli</span><span class="s3">.</span><span class="s1">stop </span><span class="s3">= </span><span class="s1">stop</span>
    <span class="s1">sli</span><span class="s3">.</span><span class="s1">step </span><span class="s3">= </span><span class="s1">step</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">sli</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">(), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">))</span>

<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">SliceLiteral</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_slice_literal</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s4"># Check for integer overflows at compile time.</span>
    <span class="s1">slice_lit </span><span class="s3">= </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">literal_value</span>
    <span class="s2">for </span><span class="s1">field_name </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;start&quot;</span><span class="s3">, </span><span class="s6">&quot;stop&quot;</span><span class="s3">, </span><span class="s6">&quot;step&quot;</span><span class="s3">):</span>
        <span class="s1">field_obj </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">slice_lit</span><span class="s3">, </span><span class="s1">field_name</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">field_obj</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">typeof</span><span class="s3">(</span><span class="s1">field_obj</span><span class="s3">, </span><span class="s1">Purpose</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">((</span>
                    <span class="s6">f&quot;Unable to create literal slice. &quot;</span>
                    <span class="s6">f&quot;Error encountered with </span><span class="s2">{</span><span class="s1">field_name</span><span class="s2">} </span><span class="s6">&quot;</span>
                    <span class="s6">f&quot;attribute. </span><span class="s2">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s2">}</span><span class="s6">&quot;</span><span class="s3">)</span>
                <span class="s3">)</span>

    <span class="s1">py_ctor</span><span class="s3">, </span><span class="s1">py_args </span><span class="s3">= </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">literal_value</span><span class="s3">.</span><span class="s1">__reduce__</span><span class="s3">()</span>
    <span class="s1">serialized_ctor </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">py_ctor</span><span class="s3">)</span>
    <span class="s1">serialized_args </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">py_args</span><span class="s3">)</span>
    <span class="s1">ctor </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">serialized_ctor</span><span class="s3">)</span>
    <span class="s1">args </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">serialized_args</span><span class="s3">)</span>
    <span class="s1">obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">ctor</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">ctor</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">args</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">obj</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">StringLiteral</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_string_literal</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s4"># A string literal is a dummy value</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_dummy_value</span><span class="s3">())</span>

<span class="s4">#</span>
<span class="s4"># Collections</span>
<span class="s4">#</span>

<span class="s4"># NOTE: boxing functions are supposed to steal any NRT references in</span>
<span class="s4"># the given native value.</span>

<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Array</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_array</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">nativearycls </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_array</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">nativeary </span><span class="s3">= </span><span class="s1">nativearycls</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">enable_nrt</span><span class="s3">:</span>
        <span class="s1">np_dtype </span><span class="s3">= </span><span class="s1">numpy_support</span><span class="s3">.</span><span class="s1">as_dtype</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">dtypeptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">env_manager</span><span class="s3">.</span><span class="s1">read_const</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">env_manager</span><span class="s3">.</span><span class="s1">add_const</span><span class="s3">(</span><span class="s1">np_dtype</span><span class="s3">))</span>
        <span class="s1">newary </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">nrt_adapt_ndarray_to_python</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">dtypeptr</span><span class="s3">)</span>
        <span class="s4"># Steals NRT ref</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">newary</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">parent </span><span class="s3">= </span><span class="s1">nativeary</span><span class="s3">.</span><span class="s1">parent</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">incref</span><span class="s3">(</span><span class="s1">parent</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">parent</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Buffer</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_buffer</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert a Py_buffer-providing object to a native array structure. 
    &quot;&quot;&quot;</span>
    <span class="s1">buf </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">alloca_buffer</span><span class="s3">()</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">get_buffer</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">buf</span><span class="s3">)</span>
    <span class="s1">is_error </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s1">nativearycls </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_array</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">nativeary </span><span class="s3">= </span><span class="s1">nativearycls</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">)</span>
    <span class="s1">aryptr </span><span class="s3">= </span><span class="s1">nativeary</span><span class="s3">.</span><span class="s1">_getpointer</span><span class="s3">()</span>

    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_likely</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">is_error</span><span class="s3">)):</span>
        <span class="s1">ptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">aryptr</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">voidptr</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">enable_nrt</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">nrt_adapt_buffer_from_python</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">numba_buffer_adaptor</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cleanup</span><span class="s3">():</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">release_buffer</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">aryptr</span><span class="s3">), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">is_error</span><span class="s3">,</span>
                       <span class="s1">cleanup</span><span class="s3">=</span><span class="s1">cleanup</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Array</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_array</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert a Numpy array object to a native array structure. 
    &quot;&quot;&quot;</span>
    <span class="s4"># This is necessary because unbox_buffer() does not work on some</span>
    <span class="s4"># dtypes, e.g. datetime64 and timedelta64.</span>
    <span class="s4"># TODO check matching dtype.</span>
    <span class="s4">#      currently, mismatching dtype will still work and causes</span>
    <span class="s4">#      potential memory corruption</span>
    <span class="s1">nativearycls </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_array</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">nativeary </span><span class="s3">= </span><span class="s1">nativearycls</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">)</span>
    <span class="s1">aryptr </span><span class="s3">= </span><span class="s1">nativeary</span><span class="s3">.</span><span class="s1">_getpointer</span><span class="s3">()</span>

    <span class="s1">ptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">aryptr</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">voidptr</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">enable_nrt</span><span class="s3">:</span>
        <span class="s1">errcode </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">nrt_adapt_ndarray_from_python</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">errcode </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">numba_array_adaptor</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)</span>

    <span class="s4"># TODO: here we have minimal typechecking by the itemsize.</span>
    <span class="s4">#       need to do better</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">expected_itemsize </span><span class="s3">= </span><span class="s1">numpy_support</span><span class="s3">.</span><span class="s1">as_dtype</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">).</span><span class="s1">itemsize</span>
    <span class="s2">except </span><span class="s1">NumbaNotImplementedError</span><span class="s3">:</span>
        <span class="s4"># Don't check types that can't be `as_dtype()`-ed</span>
        <span class="s1">itemsize_mismatch </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">expected_itemsize </span><span class="s3">= </span><span class="s1">nativeary</span><span class="s3">.</span><span class="s1">itemsize</span><span class="s3">.</span><span class="s1">type</span><span class="s3">(</span><span class="s1">expected_itemsize</span><span class="s3">)</span>
        <span class="s1">itemsize_mismatch </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span>
            <span class="s6">'!='</span><span class="s3">,</span>
            <span class="s1">nativeary</span><span class="s3">.</span><span class="s1">itemsize</span><span class="s3">,</span>
            <span class="s1">expected_itemsize</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s1">failed </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span>
        <span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">errcode</span><span class="s3">),</span>
        <span class="s1">itemsize_mismatch</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s4"># Handle error</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">failed</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">err_set_string</span><span class="s3">(</span><span class="s6">&quot;PyExc_TypeError&quot;</span><span class="s3">,</span>
                               <span class="s6">&quot;can't unbox array from PyObject into &quot;</span>
                               <span class="s6">&quot;native value.  The object maybe of a &quot;</span>
                               <span class="s6">&quot;different type&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">aryptr</span><span class="s3">), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">failed</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Tuple</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">UniTuple</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_tuple</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert native array or structure *val* to a tuple object. 
    &quot;&quot;&quot;</span>
    <span class="s1">tuple_val </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">tuple_new</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">count</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">):</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">extract_value</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">tuple_setitem</span><span class="s3">(</span><span class="s1">tuple_val</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">tuple_val</span>

<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NamedTuple</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NamedUniTuple</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_namedtuple</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert native array or structure *val* to a namedtuple object. 
    &quot;&quot;&quot;</span>
    <span class="s1">cls_obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">instance_class</span><span class="s3">))</span>
    <span class="s1">tuple_obj </span><span class="s3">= </span><span class="s1">box_tuple</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">)</span>
    <span class="s1">obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">cls_obj</span><span class="s3">, </span><span class="s1">tuple_obj</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">cls_obj</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">tuple_obj</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">obj</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">BaseTuple</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_tuple</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert tuple *obj* to a native array (if homogeneous) or structure. 
    &quot;&quot;&quot;</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">values </span><span class="s3">= []</span>
    <span class="s1">cleanups </span><span class="s3">= []</span>
    <span class="s1">lty </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>

    <span class="s1">is_error_ptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span><span class="s3">)</span>
    <span class="s1">value_ptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">lty</span><span class="s3">)</span>

    <span class="s4"># Issue #1638: need to check the tuple size</span>
    <span class="s1">actual_size </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">tuple_size</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s1">size_matches </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">actual_size</span><span class="s3">,</span>
                                            <span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">actual_size</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">size_matches</span><span class="s3">), </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">err_format</span><span class="s3">(</span>
            <span class="s6">&quot;PyExc_ValueError&quot;</span><span class="s3">,</span>
            <span class="s6">&quot;size mismatch for tuple, expected %d element(s) but got %%zd&quot; </span><span class="s3">% (</span><span class="s1">n</span><span class="s3">,),</span>
            <span class="s1">actual_size</span><span class="s3">)</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">is_error_ptr</span><span class="s3">)</span>

    <span class="s4"># We unbox the items even if not `size_matches`, to avoid issues with</span>
    <span class="s4"># the generated IR (instruction doesn't dominate all uses)</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">eltype </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">):</span>
        <span class="s1">elem </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">tuple_getitem</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>
        <span class="s1">native </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">eltype</span><span class="s3">, </span><span class="s1">elem</span><span class="s3">)</span>
        <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">native</span><span class="s3">.</span><span class="s1">value</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">native</span><span class="s3">.</span><span class="s1">is_error</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">is_error_ptr</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">native</span><span class="s3">.</span><span class="s1">cleanup </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">cleanups</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">native</span><span class="s3">.</span><span class="s1">cleanup</span><span class="s3">)</span>

    <span class="s1">value </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_tuple</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">values</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">value_ptr</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">cleanups</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">size_matches</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s2">def </span><span class="s1">cleanup</span><span class="s3">():</span>
                <span class="s2">for </span><span class="s1">func </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">cleanups</span><span class="s3">):</span>
                    <span class="s1">func</span><span class="s3">()</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">cleanup </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">value_ptr</span><span class="s3">), </span><span class="s1">cleanup</span><span class="s3">=</span><span class="s1">cleanup</span><span class="s3">,</span>
                       <span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">is_error_ptr</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">List</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_list</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert native list *val* to a list object. 
    &quot;&quot;&quot;</span>
    <span class="s1">list </span><span class="s3">= </span><span class="s1">listobj</span><span class="s3">.</span><span class="s1">ListInstance</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">obj </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">parent</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">)) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">has_parent</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">has_parent</span><span class="s3">:</span>
            <span class="s4"># List is actually reflected =&gt; return the original object</span>
            <span class="s4"># (note not all list instances whose *type* is reflected are</span>
            <span class="s4">#  actually reflected; see numba.tests.test_lists for an example)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">incref</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s4"># Build a new Python list</span>
            <span class="s1">nitems </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">size</span>
            <span class="s1">obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_new</span><span class="s3">(</span><span class="s1">nitems</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">),</span>
                                   <span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
                <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">for_range</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">nitems</span><span class="s3">) </span><span class="s2">as </span><span class="s1">loop</span><span class="s3">:</span>
                    <span class="s1">item </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">getitem</span><span class="s3">(</span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>
                    <span class="s1">list</span><span class="s3">.</span><span class="s1">incref_value</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">itemobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_setitem</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">)</span>

            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s4"># Steal NRT ref</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">_NumbaTypeHelper</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;A helper for acquiring `numba.typeof` for type checking. 
 
    Usage 
    ----- 
 
        # `c` is the boxing context. 
        with _NumbaTypeHelper(c) as nth: 
            # This contextmanager maintains the lifetime of the `numba.typeof` 
            # function. 
            the_numba_type = nth.typeof(some_object) 
            # Do work on the type object 
            do_checks(the_numba_type) 
            # Cleanup 
            c.pyapi.decref(the_numba_type) 
        # At this point *nth* should not be used. 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">c </span><span class="s3">= </span><span class="s1">c</span>

    <span class="s2">def </span><span class="s1">__enter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">c</span>
        <span class="s1">numba_name </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">insert_const_string</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">module</span><span class="s3">, </span><span class="s6">'numba'</span><span class="s3">)</span>
        <span class="s1">numba_mod </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">import_module_noblock</span><span class="s3">(</span><span class="s1">numba_name</span><span class="s3">)</span>
        <span class="s1">typeof_fn </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_getattr_string</span><span class="s3">(</span><span class="s1">numba_mod</span><span class="s3">, </span><span class="s6">'typeof'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">typeof_fn </span><span class="s3">= </span><span class="s1">typeof_fn</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">numba_mod</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">__exit__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">c</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">typeof_fn</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">typeof</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">call_function_objargs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">typeof_fn</span><span class="s3">, [</span><span class="s1">obj</span><span class="s3">])</span>
        <span class="s2">return </span><span class="s1">res</span>


<span class="s2">def </span><span class="s1">_python_list_to_native</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">listptr</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Construct a new native list from a Python list. 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">check_element_type</span><span class="s3">(</span><span class="s1">nth</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">, </span><span class="s1">expected_typobj</span><span class="s3">):</span>
        <span class="s1">typobj </span><span class="s3">= </span><span class="s1">nth</span><span class="s3">.</span><span class="s1">typeof</span><span class="s3">(</span><span class="s1">itemobj</span><span class="s3">)</span>
        <span class="s4"># Check if *typobj* is NULL</span>
        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span>
                <span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typobj</span><span class="s3">),</span>
                <span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s3">):</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>
            <span class="s1">loop</span><span class="s3">.</span><span class="s1">do_break</span><span class="s3">()</span>
        <span class="s4"># Mandate that objects all have the same exact type</span>
        <span class="s1">type_mismatch </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">typobj</span><span class="s3">, </span><span class="s1">expected_typobj</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">type_mismatch</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">err_format</span><span class="s3">(</span>
                <span class="s6">&quot;PyExc_TypeError&quot;</span><span class="s3">,</span>
                <span class="s6">&quot;can't unbox heterogeneous list: %S != %S&quot;</span><span class="s3">,</span>
                <span class="s1">expected_typobj</span><span class="s3">, </span><span class="s1">typobj</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">typobj</span><span class="s3">)</span>
            <span class="s1">loop</span><span class="s3">.</span><span class="s1">do_break</span><span class="s3">()</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">typobj</span><span class="s3">)</span>

    <span class="s4"># Allocate a new native list</span>
    <span class="s1">ok</span><span class="s3">, </span><span class="s1">list </span><span class="s3">= </span><span class="s1">listobj</span><span class="s3">.</span><span class="s1">ListInstance</span><span class="s3">.</span><span class="s1">allocate_ex</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">if_ok</span><span class="s3">, </span><span class="s1">if_not_ok</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">if_ok</span><span class="s3">:</span>
            <span class="s1">list</span><span class="s3">.</span><span class="s1">size </span><span class="s3">= </span><span class="s1">size</span>
            <span class="s1">zero </span><span class="s3">= </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">size</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">zero</span><span class="s3">),</span>
                                   <span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
                <span class="s4"># Traverse Python list and unbox objects into native list</span>
                <span class="s2">with </span><span class="s1">_NumbaTypeHelper</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) </span><span class="s2">as </span><span class="s1">nth</span><span class="s3">:</span>
                    <span class="s4"># Note: *expected_typobj* can't be NULL</span>
                    <span class="s1">expected_typobj </span><span class="s3">= </span><span class="s1">nth</span><span class="s3">.</span><span class="s1">typeof</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_getitem</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">zero</span><span class="s3">))</span>
                    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">for_range</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">size</span><span class="s3">) </span><span class="s2">as </span><span class="s1">loop</span><span class="s3">:</span>
                        <span class="s1">itemobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_getitem</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>
                        <span class="s1">check_element_type</span><span class="s3">(</span><span class="s1">nth</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">, </span><span class="s1">expected_typobj</span><span class="s3">)</span>
                        <span class="s4"># XXX we don't call native cleanup for each</span>
                        <span class="s4"># list element, since that would require keeping</span>
                        <span class="s4"># of which unboxings have been successful.</span>
                        <span class="s1">native </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">)</span>
                        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">native</span><span class="s3">.</span><span class="s1">is_error</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
                            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>
                            <span class="s1">loop</span><span class="s3">.</span><span class="s1">do_break</span><span class="s3">()</span>
                        <span class="s4"># The reference is borrowed so incref=False</span>
                        <span class="s1">list</span><span class="s3">.</span><span class="s1">setitem</span><span class="s3">(</span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">native</span><span class="s3">.</span><span class="s1">value</span><span class="s3">, </span><span class="s1">incref</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">expected_typobj</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">reflected</span><span class="s3">:</span>
                <span class="s1">list</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">= </span><span class="s1">obj</span>
            <span class="s4"># Stuff meminfo pointer into the Python object for</span>
            <span class="s4"># later reuse.</span>
            <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">errorptr</span><span class="s3">)),</span>
                                                  <span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
                <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_set_private_data</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">list</span><span class="s3">.</span><span class="s1">meminfo</span><span class="s3">)</span>
            <span class="s1">list</span><span class="s3">.</span><span class="s1">set_dirty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">list</span><span class="s3">.</span><span class="s1">value</span><span class="s3">, </span><span class="s1">listptr</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">if_not_ok</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>

    <span class="s4"># If an error occurred, drop the whole native list</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">errorptr</span><span class="s3">)):</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">list</span><span class="s3">.</span><span class="s1">value</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">List</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_list</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert list *obj* to a native list. 
 
    If list was previously unboxed, we reuse the existing native list 
    to ensure consistency. 
    &quot;&quot;&quot;</span>
    <span class="s1">size </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_size</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s1">errorptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span><span class="s3">)</span>
    <span class="s1">listptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">))</span>

    <span class="s4"># See if the list was previously unboxed, if so, re-use the meminfo.</span>
    <span class="s1">ptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_get_private_data</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)) </span><span class="s1">\</span>
        <span class="s2">as </span><span class="s3">(</span><span class="s1">has_meminfo</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>

        <span class="s2">with </span><span class="s1">has_meminfo</span><span class="s3">:</span>
            <span class="s4"># List was previously unboxed =&gt; reuse meminfo</span>
            <span class="s1">list </span><span class="s3">= </span><span class="s1">listobj</span><span class="s3">.</span><span class="s1">ListInstance</span><span class="s3">.</span><span class="s1">from_meminfo</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)</span>
            <span class="s1">list</span><span class="s3">.</span><span class="s1">size </span><span class="s3">= </span><span class="s1">size</span>
            <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">reflected</span><span class="s3">:</span>
                <span class="s1">list</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">= </span><span class="s1">obj</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">list</span><span class="s3">.</span><span class="s1">value</span><span class="s3">, </span><span class="s1">listptr</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s1">_python_list_to_native</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">listptr</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cleanup</span><span class="s3">():</span>
        <span class="s4"># Clean up the associated pointer, as the meminfo is now invalid.</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_reset_private_data</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">listptr</span><span class="s3">),</span>
                       <span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">errorptr</span><span class="s3">),</span>
                       <span class="s1">cleanup</span><span class="s3">=</span><span class="s1">cleanup</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">List</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">reflect_list</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Reflect the native list's contents into the Python object. 
    &quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">reflected</span><span class="s3">:</span>
        <span class="s2">return</span>
    <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">reflected</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;cannot reflect element of reflected container: {}</span><span class="s2">\n</span><span class="s6">&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s1">list </span><span class="s3">= </span><span class="s1">listobj</span><span class="s3">.</span><span class="s1">ListInstance</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">list</span><span class="s3">.</span><span class="s1">dirty</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">parent</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_size</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
        <span class="s1">new_size </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">size</span>
        <span class="s1">diff </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">(</span><span class="s1">new_size</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>
        <span class="s1">diff_gt_0 </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">diff</span><span class="s3">,</span>
                                          <span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">diff</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s5">0</span><span class="s3">))</span>
        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">diff_gt_0</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">if_grow</span><span class="s3">, </span><span class="s1">if_shrink</span><span class="s3">):</span>
            <span class="s4"># XXX no error checking below</span>
            <span class="s2">with </span><span class="s1">if_grow</span><span class="s3">:</span>
                <span class="s4"># First overwrite existing items</span>
                <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">for_range</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">size</span><span class="s3">) </span><span class="s2">as </span><span class="s1">loop</span><span class="s3">:</span>
                    <span class="s1">item </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">getitem</span><span class="s3">(</span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>
                    <span class="s1">list</span><span class="s3">.</span><span class="s1">incref_value</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">itemobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_setitem</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">)</span>
                <span class="s4"># Then add missing items</span>
                <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">for_range</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">diff</span><span class="s3">) </span><span class="s2">as </span><span class="s1">loop</span><span class="s3">:</span>
                    <span class="s1">idx </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">size</span><span class="s3">, </span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>
                    <span class="s1">item </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">getitem</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)</span>
                    <span class="s1">list</span><span class="s3">.</span><span class="s1">incref_value</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">itemobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_append</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">)</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">itemobj</span><span class="s3">)</span>

            <span class="s2">with </span><span class="s1">if_shrink</span><span class="s3">:</span>
                <span class="s4"># First delete list tail</span>
                <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_setslice</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">new_size</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
                <span class="s4"># Then overwrite remaining items</span>
                <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">for_range</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">new_size</span><span class="s3">) </span><span class="s2">as </span><span class="s1">loop</span><span class="s3">:</span>
                    <span class="s1">item </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">getitem</span><span class="s3">(</span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>
                    <span class="s1">list</span><span class="s3">.</span><span class="s1">incref_value</span><span class="s3">(</span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">itemobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_setitem</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">loop</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">)</span>

        <span class="s4"># Mark the list clean, in case it is reflected twice</span>
        <span class="s1">list</span><span class="s3">.</span><span class="s1">set_dirty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_python_set_to_native</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">setptr</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Construct a new native set from a Python set. 
    &quot;&quot;&quot;</span>
    <span class="s4"># Allocate a new native set</span>
    <span class="s1">ok</span><span class="s3">, </span><span class="s1">inst </span><span class="s3">= </span><span class="s1">setobj</span><span class="s3">.</span><span class="s1">SetInstance</span><span class="s3">.</span><span class="s1">allocate_ex</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">if_ok</span><span class="s3">, </span><span class="s1">if_not_ok</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">if_ok</span><span class="s3">:</span>
            <span class="s4"># Traverse Python set and unbox objects into native set</span>
            <span class="s1">typobjptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                                                  <span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">pyobj</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

            <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">set_iterate</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">) </span><span class="s2">as </span><span class="s1">loop</span><span class="s3">:</span>
                <span class="s1">itemobj </span><span class="s3">= </span><span class="s1">loop</span><span class="s3">.</span><span class="s1">value</span>
                <span class="s4"># Mandate that objects all have the same exact type</span>
                <span class="s1">typobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">get_type</span><span class="s3">(</span><span class="s1">itemobj</span><span class="s3">)</span>
                <span class="s1">expected_typobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">typobjptr</span><span class="s3">)</span>

                <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span>
                    <span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">expected_typobj</span><span class="s3">),</span>
                    <span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">if_first</span><span class="s3">, </span><span class="s1">if_not_first</span><span class="s3">):</span>
                    <span class="s2">with </span><span class="s1">if_first</span><span class="s3">:</span>
                        <span class="s4"># First iteration =&gt; store item type</span>
                        <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">typobj</span><span class="s3">, </span><span class="s1">typobjptr</span><span class="s3">)</span>
                    <span class="s2">with </span><span class="s1">if_not_first</span><span class="s3">:</span>
                        <span class="s4"># Otherwise, check item type</span>
                        <span class="s1">type_mismatch </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">typobj</span><span class="s3">,</span>
                                                              <span class="s1">expected_typobj</span><span class="s3">)</span>
                        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">type_mismatch</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
                            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>
                            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">err_set_string</span><span class="s3">(</span><span class="s6">&quot;PyExc_TypeError&quot;</span><span class="s3">,</span>
                                                   <span class="s6">&quot;can't unbox heterogeneous set&quot;</span><span class="s3">)</span>
                            <span class="s1">loop</span><span class="s3">.</span><span class="s1">do_break</span><span class="s3">()</span>

                <span class="s4"># XXX we don't call native cleanup for each set element,</span>
                <span class="s4"># since that would require keeping track</span>
                <span class="s4"># of which unboxings have been successful.</span>
                <span class="s1">native </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">)</span>
                <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">native</span><span class="s3">.</span><span class="s1">is_error</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>
                <span class="s1">inst</span><span class="s3">.</span><span class="s1">add_pyapi</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">, </span><span class="s1">native</span><span class="s3">.</span><span class="s1">value</span><span class="s3">, </span><span class="s1">do_resize</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">reflected</span><span class="s3">:</span>
                <span class="s1">inst</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">= </span><span class="s1">obj</span>
            <span class="s4"># Associate meminfo pointer with the Python object for later reuse.</span>
            <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">errorptr</span><span class="s3">)),</span>
                                   <span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
                <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_set_private_data</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">meminfo</span><span class="s3">)</span>
            <span class="s1">inst</span><span class="s3">.</span><span class="s1">set_dirty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">value</span><span class="s3">, </span><span class="s1">setptr</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">if_not_ok</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>

    <span class="s4"># If an error occurred, drop the whole native set</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">errorptr</span><span class="s3">)):</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">value</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Set</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_set</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert set *obj* to a native set. 
 
    If set was previously unboxed, we reuse the existing native set 
    to ensure consistency. 
    &quot;&quot;&quot;</span>
    <span class="s1">size </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">set_size</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s1">errorptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span><span class="s3">)</span>
    <span class="s1">setptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">))</span>

    <span class="s4"># See if the set was previously unboxed, if so, re-use the meminfo.</span>
    <span class="s1">ptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_get_private_data</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)) </span><span class="s1">\</span>
        <span class="s2">as </span><span class="s3">(</span><span class="s1">has_meminfo</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>

        <span class="s2">with </span><span class="s1">has_meminfo</span><span class="s3">:</span>
            <span class="s4"># Set was previously unboxed =&gt; reuse meminfo</span>
            <span class="s1">inst </span><span class="s3">= </span><span class="s1">setobj</span><span class="s3">.</span><span class="s1">SetInstance</span><span class="s3">.</span><span class="s1">from_meminfo</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">ptr</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">reflected</span><span class="s3">:</span>
                <span class="s1">inst</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">= </span><span class="s1">obj</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">inst</span><span class="s3">.</span><span class="s1">value</span><span class="s3">, </span><span class="s1">setptr</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s1">_python_set_to_native</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">setptr</span><span class="s3">, </span><span class="s1">errorptr</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cleanup</span><span class="s3">():</span>
        <span class="s4"># Clean up the associated pointer, as the meminfo is now invalid.</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_reset_private_data</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">setptr</span><span class="s3">),</span>
                       <span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">errorptr</span><span class="s3">),</span>
                       <span class="s1">cleanup</span><span class="s3">=</span><span class="s1">cleanup</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_native_set_to_python_list</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">payload</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Create a Python list from a native set's items. 
    &quot;&quot;&quot;</span>
    <span class="s1">nitems </span><span class="s3">= </span><span class="s1">payload</span><span class="s3">.</span><span class="s1">used</span>
    <span class="s1">listobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_new</span><span class="s3">(</span><span class="s1">nitems</span><span class="s3">)</span>
    <span class="s1">ok </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">listobj</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                                          <span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">nitems</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s5">0</span><span class="s3">))</span>
        <span class="s2">with </span><span class="s1">payload</span><span class="s3">.</span><span class="s1">_iterate</span><span class="s3">() </span><span class="s2">as </span><span class="s1">loop</span><span class="s3">:</span>
            <span class="s1">i </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">index</span><span class="s3">)</span>
            <span class="s1">item </span><span class="s3">= </span><span class="s1">loop</span><span class="s3">.</span><span class="s1">entry</span><span class="s3">.</span><span class="s1">key</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">incref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
            <span class="s1">itemobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">box</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">item</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">list_setitem</span><span class="s3">(</span><span class="s1">listobj</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">itemobj</span><span class="s3">)</span>
            <span class="s1">i </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">i</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">index</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">ok</span><span class="s3">, </span><span class="s1">listobj</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Set</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_set</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert native set *val* to a set object. 
    &quot;&quot;&quot;</span>
    <span class="s1">inst </span><span class="s3">= </span><span class="s1">setobj</span><span class="s3">.</span><span class="s1">SetInstance</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">obj </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">parent</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">)) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">has_parent</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">has_parent</span><span class="s3">:</span>
            <span class="s4"># Set is actually reflected =&gt; return the original object</span>
            <span class="s4"># (note not all set instances whose *type* is reflected are</span>
            <span class="s4">#  actually reflected; see numba.tests.test_sets for an example)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">incref</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s4"># Build a new Python list and then create a set from that</span>
            <span class="s1">payload </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">payload</span>
            <span class="s1">ok</span><span class="s3">, </span><span class="s1">listobj </span><span class="s3">= </span><span class="s1">_native_set_to_python_list</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">payload</span><span class="s3">, </span><span class="s1">c</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
                <span class="s1">obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">set_new</span><span class="s3">(</span><span class="s1">listobj</span><span class="s3">)</span>
                <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">listobj</span><span class="s3">)</span>
                <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>

    <span class="s4"># Steal NRT ref</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Set</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">reflect_set</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Reflect the native set's contents into the Python object. 
    &quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">reflected</span><span class="s3">:</span>
        <span class="s2">return</span>
    <span class="s1">inst </span><span class="s3">= </span><span class="s1">setobj</span><span class="s3">.</span><span class="s1">SetInstance</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">payload </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">payload</span>

    <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">payload</span><span class="s3">.</span><span class="s1">dirty</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">parent</span>
        <span class="s4"># XXX errors are not dealt with below</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">set_clear</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>

        <span class="s4"># Build a new Python list and then update the set with that</span>
        <span class="s1">ok</span><span class="s3">, </span><span class="s1">listobj </span><span class="s3">= </span><span class="s1">_native_set_to_python_list</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">payload</span><span class="s3">, </span><span class="s1">c</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_then</span><span class="s3">(</span><span class="s1">ok</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">set_update</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">listobj</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">listobj</span><span class="s3">)</span>

        <span class="s4"># Mark the set clean, in case it is reflected twice</span>
        <span class="s1">inst</span><span class="s3">.</span><span class="s1">set_dirty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>


<span class="s4">#</span>
<span class="s4"># Other types</span>
<span class="s4">#</span>

<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Generator</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_generator</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">from_native_generator</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">env_manager</span><span class="s3">.</span><span class="s1">env_ptr</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Generator</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_generator</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">to_native_generator</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">DType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_dtype</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">np_dtype </span><span class="s3">= </span><span class="s1">numpy_support</span><span class="s3">.</span><span class="s1">as_dtype</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">np_dtype</span><span class="s3">))</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">DType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_dtype</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_dummy_value</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NumberClass</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_number_class</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">np_dtype </span><span class="s3">= </span><span class="s1">numpy_support</span><span class="s3">.</span><span class="s1">as_dtype</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">np_dtype</span><span class="s3">))</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NumberClass</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_number_class</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_dummy_value</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">PyObject</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Object</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_pyobject</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">val</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">PyObject</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Object</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_pyobject</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">ExternalFunctionPointer</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_funcptr</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">get_pointer </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>

    <span class="s4"># Call get_pointer() on the object to get the raw pointer value</span>
    <span class="s1">ptrty </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_function_pointer_type</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s1">ret </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                                    <span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">ptrty</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                                    <span class="s1">name</span><span class="s3">=</span><span class="s6">'fnptr'</span><span class="s3">)</span>
    <span class="s1">ser </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">get_pointer</span><span class="s3">)</span>
    <span class="s1">get_pointer </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">ser</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_likely</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                           <span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">get_pointer</span><span class="s3">)):</span>
        <span class="s1">intobj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">call_function_objargs</span><span class="s3">(</span><span class="s1">get_pointer</span><span class="s3">, (</span><span class="s1">obj</span><span class="s3">,))</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">get_pointer</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_likely</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">,</span>
                               <span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_not_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">intobj</span><span class="s3">)):</span>
            <span class="s1">ptr </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">long_as_voidptr</span><span class="s3">(</span><span class="s1">intobj</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">intobj</span><span class="s3">)</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">ptr</span><span class="s3">, </span><span class="s1">ptrty</span><span class="s3">), </span><span class="s1">ret</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">c_api_error</span><span class="s3">())</span>

<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">DeferredType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_deferred</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">from_native_value</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(),</span>
                                    <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">extract_value</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">]),</span>
                                    <span class="s1">env_manager</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">env_manager</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">out</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">DeferredType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_deferred</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">native_value </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">to_native_value</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(), </span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s1">model </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">data_model_manager</span><span class="s3">[</span><span class="s1">typ</span><span class="s3">]</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">model</span><span class="s3">.</span><span class="s1">make_uninitialized</span><span class="s3">(), </span><span class="s1">native_value</span><span class="s3">.</span><span class="s1">value</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">native_value</span><span class="s3">.</span><span class="s1">is_error</span><span class="s3">,</span>
                       <span class="s1">cleanup</span><span class="s3">=</span><span class="s1">native_value</span><span class="s3">.</span><span class="s1">cleanup</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Dispatcher</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_dispatcher</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s4"># In native code, Dispatcher types can be casted to FunctionType.</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Dispatcher</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_pyobject</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">incref</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">val</span>


<span class="s2">def </span><span class="s1">unbox_unsupported</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">err_set_string</span><span class="s3">(</span><span class="s6">&quot;PyExc_TypeError&quot;</span><span class="s3">,</span>
                           <span class="s6">&quot;can't unbox {!r} type&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">))</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant_null</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">box_unsupported</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;cannot convert native %s to Python object&quot; </span><span class="s3">% (</span><span class="s1">typ</span><span class="s3">,)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">err_set_string</span><span class="s3">(</span><span class="s6">&quot;PyExc_TypeError&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">get_null_object</span><span class="s3">()</span>
    <span class="s2">return </span><span class="s1">res</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Literal</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_literal</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s4"># Const type contains the python object of the constant value,</span>
    <span class="s4"># which we can directly return.</span>
    <span class="s1">retval </span><span class="s3">= </span><span class="s1">typ</span><span class="s3">.</span><span class="s1">literal_value</span>
    <span class="s4"># Serialize the value into the IR</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">unserialize</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">serialize_object</span><span class="s3">(</span><span class="s1">retval</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">MemInfoPointer</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_meminfo_pointer</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">nrt_meminfo_as_pyobject</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">MemInfoPointer</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_meminfo_pointer</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">nrt_meminfo_from_pyobject</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s1">errored </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">errored</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">TypeRef</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_typeref</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_dummy_value</span><span class="s3">(), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">LiteralStrKeyDict</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_LiteralStrKeyDict</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">box_unsupported</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">)</span>


<span class="s4"># Original implementation at: https://github.com/numba/numba/issues/4499#issuecomment-1063138477</span>
<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NumPyRandomBitGeneratorType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_numpy_random_bitgenerator</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    The bit_generator instance has a `.ctypes` attr which is a namedtuple 
    with the following members (types): 
    * state_address (Python int) 
    * state (ctypes.c_void_p) 
    * next_uint64 (ctypes.CFunctionType instance) 
    * next_uint32 (ctypes.CFunctionType instance) 
    * next_double (ctypes.CFunctionType instance) 
    * bit_generator (ctypes.c_void_p) 
    &quot;&quot;&quot;</span>

    <span class="s1">is_error_ptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span><span class="s3">)</span>
    <span class="s1">extra_refs </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">clear_extra_refs</span><span class="s3">():</span>
        <span class="s2">for </span><span class="s1">_ref </span><span class="s2">in </span><span class="s1">extra_refs</span><span class="s3">:</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">_ref</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">handle_failure</span><span class="s3">():</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">is_error_ptr</span><span class="s3">)</span>
        <span class="s1">clear_extra_refs</span><span class="s3">()</span>

    <span class="s2">with </span><span class="s1">ExitStack</span><span class="s3">() </span><span class="s2">as </span><span class="s1">stack</span><span class="s3">:</span>

        <span class="s2">def </span><span class="s1">object_getattr_safely</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">):</span>
            <span class="s1">attr_obj </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_getattr_string</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">)</span>
            <span class="s1">extra_refs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">attr_obj</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">attr_obj</span>

        <span class="s1">struct_ptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">create_struct_proxy</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">)</span>
        <span class="s1">struct_ptr</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">= </span><span class="s1">obj</span>

        <span class="s4"># Get the .ctypes attr</span>
        <span class="s1">ctypes_binding </span><span class="s3">= </span><span class="s1">object_getattr_safely</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s6">'ctypes'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">ctypes_binding</span><span class="s3">):</span>
            <span class="s1">handle_failure</span><span class="s3">()</span>

        <span class="s4"># Look up the &quot;state_address&quot; member and wire it into the struct</span>
        <span class="s1">interface_state_address </span><span class="s3">= </span><span class="s1">object_getattr_safely</span><span class="s3">(</span>
            <span class="s1">ctypes_binding</span><span class="s3">, </span><span class="s6">'state_address'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">interface_state_address</span><span class="s3">):</span>
            <span class="s1">handle_failure</span><span class="s3">()</span>

        <span class="s1">setattr</span><span class="s3">(</span><span class="s1">struct_ptr</span><span class="s3">, </span><span class="s6">'state_address'</span><span class="s3">,</span>
                <span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">uintp</span><span class="s3">, </span><span class="s1">interface_state_address</span><span class="s3">).</span><span class="s1">value</span><span class="s3">)</span>

        <span class="s4"># Look up the &quot;state&quot; member and wire it into the struct</span>
        <span class="s1">interface_state </span><span class="s3">= </span><span class="s1">object_getattr_safely</span><span class="s3">(</span><span class="s1">ctypes_binding</span><span class="s3">, </span><span class="s6">'state'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">interface_state</span><span class="s3">):</span>
            <span class="s1">handle_failure</span><span class="s3">()</span>
    
        <span class="s1">interface_state_value </span><span class="s3">= </span><span class="s1">object_getattr_safely</span><span class="s3">(</span>
            <span class="s1">interface_state</span><span class="s3">, </span><span class="s6">'value'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">interface_state_value</span><span class="s3">):</span>
            <span class="s1">handle_failure</span><span class="s3">()</span>
        <span class="s1">setattr</span><span class="s3">(</span>
            <span class="s1">struct_ptr</span><span class="s3">,</span>
            <span class="s6">'state'</span><span class="s3">,</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span>
                <span class="s1">types</span><span class="s3">.</span><span class="s1">uintp</span><span class="s3">,</span>
                <span class="s1">interface_state_value</span><span class="s3">).</span><span class="s1">value</span><span class="s3">)</span>

        <span class="s4"># Want to store callable function pointers to these CFunctionTypes, so</span>
        <span class="s4"># import ctypes and use it to cast the CFunctionTypes to c_void_p and</span>
        <span class="s4"># store the results.</span>
        <span class="s4"># First find ctypes.cast, and ctypes.c_void_p</span>
        <span class="s1">ctypes_name </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">insert_const_string</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">module</span><span class="s3">, </span><span class="s6">'ctypes'</span><span class="s3">)</span>
        <span class="s1">ctypes_module </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">import_module_noblock</span><span class="s3">(</span><span class="s1">ctypes_name</span><span class="s3">)</span>
        <span class="s1">extra_refs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ctypes_module</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">ctypes_module</span><span class="s3">):</span>
            <span class="s1">handle_failure</span><span class="s3">()</span>

        <span class="s1">ct_cast </span><span class="s3">= </span><span class="s1">object_getattr_safely</span><span class="s3">(</span><span class="s1">ctypes_module</span><span class="s3">, </span><span class="s6">'cast'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">ct_cast</span><span class="s3">):</span>
            <span class="s1">handle_failure</span><span class="s3">()</span>

        <span class="s1">ct_voidptr_ty </span><span class="s3">= </span><span class="s1">object_getattr_safely</span><span class="s3">(</span><span class="s1">ctypes_module</span><span class="s3">, </span><span class="s6">'c_void_p'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">ct_voidptr_ty</span><span class="s3">):</span>
            <span class="s1">handle_failure</span><span class="s3">()</span>

        <span class="s4"># This wires in the fnptrs referred to by name</span>
        <span class="s2">def </span><span class="s1">wire_in_fnptrs</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
            <span class="s4"># Find the CFunctionType function</span>
            <span class="s1">interface_next_fn </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_getattr_string</span><span class="s3">(</span>
                <span class="s1">ctypes_binding</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>

            <span class="s1">extra_refs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">interface_next_fn</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">interface_next_fn</span><span class="s3">):</span>
                <span class="s1">handle_failure</span><span class="s3">()</span>

            <span class="s4"># Want to do ctypes.cast(CFunctionType, ctypes.c_void_p), create an</span>
            <span class="s4"># args tuple for that.</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">tuple_pack</span><span class="s3">([</span><span class="s1">interface_next_fn</span><span class="s3">, </span><span class="s1">ct_voidptr_ty</span><span class="s3">])</span>
            <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
                <span class="s1">handle_failure</span><span class="s3">()</span>

            <span class="s4"># Call ctypes.cast()</span>
            <span class="s1">interface_next_fn_casted </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">ct_cast</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

            <span class="s4"># Fetch the .value attr on the resulting ctypes.c_void_p for storage</span>
            <span class="s4"># in the function pointer slot.</span>
            <span class="s1">interface_next_fn_casted_value </span><span class="s3">= </span><span class="s1">object_getattr_safely</span><span class="s3">(</span>
                <span class="s1">interface_next_fn_casted</span><span class="s3">, </span><span class="s6">'value'</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">interface_next_fn_casted_value</span><span class="s3">):</span>
                <span class="s1">handle_failure</span><span class="s3">()</span>

            <span class="s4"># Wire up</span>
            <span class="s1">setattr</span><span class="s3">(</span><span class="s1">struct_ptr</span><span class="s3">, </span><span class="s6">f'fnptr_</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s6">'</span><span class="s3">,</span>
                    <span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">uintp</span><span class="s3">, </span><span class="s1">interface_next_fn_casted_value</span><span class="s3">).</span><span class="s1">value</span><span class="s3">)</span>


        <span class="s1">wire_in_fnptrs</span><span class="s3">(</span><span class="s6">'next_double'</span><span class="s3">)</span>
        <span class="s1">wire_in_fnptrs</span><span class="s3">(</span><span class="s6">'next_uint64'</span><span class="s3">)</span>
        <span class="s1">wire_in_fnptrs</span><span class="s3">(</span><span class="s6">'next_uint32'</span><span class="s3">)</span>

        <span class="s1">clear_extra_refs</span><span class="s3">()</span>

    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">struct_ptr</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">(), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">is_error_ptr</span><span class="s3">))</span>

<span class="s1">_bit_gen_type </span><span class="s3">= </span><span class="s1">types</span><span class="s3">.</span><span class="s1">NumPyRandomBitGeneratorType</span><span class="s3">(</span><span class="s6">'bit_generator'</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NumPyRandomGeneratorType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">unbox_numpy_random_generator</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Here we're creating a NumPyRandomGeneratorType StructModel with following fields: 
    * ('bit_generator', _bit_gen_type): The unboxed BitGenerator associated with 
                                        this Generator object instance. 
    * ('parent', types.pyobject): Pointer to the original Generator PyObject. 
    * ('meminfo', types.MemInfoPointer(types.voidptr)): The information about the memory 
        stored at the pointer (to the original Generator PyObject). This is useful for 
        keeping track of reference counts within the Python runtime. Helps prevent cases 
        where deletion happens in Python runtime without NRT being awareness of it.  
    &quot;&quot;&quot;</span>
    <span class="s1">is_error_ptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">ExitStack</span><span class="s3">() </span><span class="s2">as </span><span class="s1">stack</span><span class="s3">:</span>
        <span class="s1">struct_ptr </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">create_struct_proxy</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">)(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">, </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">)</span>
        <span class="s1">bit_gen_inst </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">object_getattr_string</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s6">'bit_generator'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">early_exit_if_null</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">stack</span><span class="s3">, </span><span class="s1">bit_gen_inst</span><span class="s3">):</span>
            <span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">store</span><span class="s3">(</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span><span class="s3">, </span><span class="s1">is_error_ptr</span><span class="s3">)</span>
        <span class="s1">unboxed </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">unbox</span><span class="s3">(</span><span class="s1">_bit_gen_type</span><span class="s3">, </span><span class="s1">bit_gen_inst</span><span class="s3">).</span><span class="s1">value</span>
        <span class="s1">struct_ptr</span><span class="s3">.</span><span class="s1">bit_generator </span><span class="s3">= </span><span class="s1">unboxed</span>
        <span class="s1">struct_ptr</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">= </span><span class="s1">obj</span>
        <span class="s1">NULL </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">voidptr_t</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">struct_ptr</span><span class="s3">.</span><span class="s1">meminfo </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">nrt_meminfo_new_from_pyobject</span><span class="s3">(</span>
            <span class="s1">NULL</span><span class="s3">,  </span><span class="s4"># there's no data</span>
            <span class="s1">obj</span><span class="s3">,   </span><span class="s4"># the python object, the call to nrt_meminfo_new_from_pyobject</span>
                <span class="s4"># will py_incref</span>
        <span class="s3">)</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">bit_gen_inst</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">NativeValue</span><span class="s3">(</span><span class="s1">struct_ptr</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">(), </span><span class="s1">is_error</span><span class="s3">=</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">is_error_ptr</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">box</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">NumPyRandomGeneratorType</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">box_numpy_random_generator</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
    <span class="s1">inst </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_helper</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">obj </span><span class="s3">= </span><span class="s1">inst</span><span class="s3">.</span><span class="s1">parent</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">pyapi</span><span class="s3">.</span><span class="s1">incref</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
    <span class="s4"># Steal NRT ref</span>
    <span class="s1">c</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">nrt</span><span class="s3">.</span><span class="s1">decref</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">typ</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
</pre>
</body>
</html>