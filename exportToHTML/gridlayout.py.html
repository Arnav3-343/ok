<html>
<head>
<title>gridlayout.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
gridlayout.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
Grid Layout 
=========== 
 
.. only:: html 
 
    .. image:: images/gridlayout.gif 
        :align: right 
 
.. only:: latex 
 
    .. image:: images/gridlayout.png 
        :align: right 
 
.. versionadded:: 1.0.4 
 
The :class:`GridLayout` arranges children in a matrix. It takes the available 
space and divides it into columns and rows, then adds widgets to the resulting 
&quot;cells&quot;. 
 
.. versionchanged:: 1.0.7 
    The implementation has changed to use the widget size_hint for calculating 
    column/row sizes. `uniform_width` and `uniform_height` have been removed 
    and other properties have added to give you more control. 
 
Background 
---------- 
 
Unlike many other toolkits, you cannot explicitly place a widget in a specific 
column/row. Each child is automatically assigned a position determined by the 
layout configuration and the child's index in the children list. 
 
A GridLayout must always have at least one input constraint: 
:attr:`GridLayout.cols` or :attr:`GridLayout.rows`. If you do not specify cols 
or rows, the Layout will throw an exception. 
 
Column Width and Row Height 
--------------------------- 
 
The column width/row height are determined in 3 steps: 
 
    - The initial size is given by the :attr:`col_default_width` and 
      :attr:`row_default_height` properties. To customize the size of a single 
      column or row, use :attr:`cols_minimum` or :attr:`rows_minimum`. 
    - The `size_hint_x`/`size_hint_y` of the children are taken into account. 
      If no widgets have a size hint, the maximum size is used for all 
      children. 
    - You can force the default size by setting the :attr:`col_force_default` 
      or :attr:`row_force_default` property. This will force the layout to 
      ignore the `width` and `size_hint` properties of children and use the 
      default size. 
 
Using a GridLayout 
------------------ 
 
In the example below, all widgets will have an equal size. By default, the 
`size_hint` is (1, 1), so a Widget will take the full size of the parent:: 
 
    layout = GridLayout(cols=2) 
    layout.add_widget(Button(text='Hello 1')) 
    layout.add_widget(Button(text='World 1')) 
    layout.add_widget(Button(text='Hello 2')) 
    layout.add_widget(Button(text='World 2')) 
 
.. image:: images/gridlayout_1.jpg 
 
Now, let's fix the size of Hello buttons to 100px instead of using 
size_hint_x=1:: 
 
    layout = GridLayout(cols=2) 
    layout.add_widget(Button(text='Hello 1', size_hint_x=None, width=100)) 
    layout.add_widget(Button(text='World 1')) 
    layout.add_widget(Button(text='Hello 2', size_hint_x=None, width=100)) 
    layout.add_widget(Button(text='World 2')) 
 
.. image:: images/gridlayout_2.jpg 
 
Next, let's fix the row height to a specific size:: 
 
    layout = GridLayout(cols=2, row_force_default=True, row_default_height=40) 
    layout.add_widget(Button(text='Hello 1', size_hint_x=None, width=100)) 
    layout.add_widget(Button(text='World 1')) 
    layout.add_widget(Button(text='Hello 2', size_hint_x=None, width=100)) 
    layout.add_widget(Button(text='World 2')) 
 
.. image:: images/gridlayout_3.jpg 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'GridLayout'</span><span class="s2">, </span><span class="s3">'GridLayoutException'</span><span class="s2">)</span>

<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">logger </span><span class="s4">import </span><span class="s1">Logger</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">layout </span><span class="s4">import </span><span class="s1">Layout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">BooleanProperty</span><span class="s2">, </span><span class="s1">DictProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">BoundedNumericProperty</span><span class="s2">, </span><span class="s1">ReferenceListProperty</span><span class="s2">, </span><span class="s1">VariableListProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">ObjectProperty</span><span class="s2">, </span><span class="s1">StringProperty</span><span class="s2">, </span><span class="s1">OptionProperty</span>
<span class="s4">from </span><span class="s1">math </span><span class="s4">import </span><span class="s1">ceil</span>
<span class="s4">from </span><span class="s1">itertools </span><span class="s4">import </span><span class="s1">accumulate</span><span class="s2">, </span><span class="s1">product</span><span class="s2">, </span><span class="s1">chain</span><span class="s2">, </span><span class="s1">islice</span>
<span class="s4">from </span><span class="s1">operator </span><span class="s4">import </span><span class="s1">sub</span>


<span class="s4">def </span><span class="s1">nmax</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">):</span>
    <span class="s5"># merge into one list</span>
    <span class="s1">args </span><span class="s2">= [</span><span class="s1">x </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">args </span><span class="s4">if </span><span class="s1">x </span><span class="s4">is not None</span><span class="s2">]</span>
    <span class="s4">return </span><span class="s1">max</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>


<span class="s4">def </span><span class="s1">nmin</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">):</span>
    <span class="s5"># merge into one list</span>
    <span class="s1">args </span><span class="s2">= [</span><span class="s1">x </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">args </span><span class="s4">if </span><span class="s1">x </span><span class="s4">is not None</span><span class="s2">]</span>
    <span class="s4">return </span><span class="s1">min</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">GridLayoutException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s0">'''Exception for errors if the grid layout manipulation fails. 
    '''</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">GridLayout</span><span class="s2">(</span><span class="s1">Layout</span><span class="s2">):</span>
    <span class="s0">'''Grid layout class. See module documentation for more information. 
    '''</span>

    <span class="s1">spacing </span><span class="s2">= </span><span class="s1">VariableListProperty</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">length</span><span class="s2">=</span><span class="s6">2</span><span class="s2">)</span>
    <span class="s3">'''Spacing between children: [spacing_horizontal, spacing_vertical]. 
 
    spacing also accepts a one argument form [spacing]. 
 
    :attr:`spacing` is a 
    :class:`~kivy.properties.VariableListProperty` and defaults to [0, 0]. 
    '''</span>

    <span class="s1">padding </span><span class="s2">= </span><span class="s1">VariableListProperty</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s3">'''Padding between the layout box and its children: [padding_left, 
    padding_top, padding_right, padding_bottom]. 
 
    padding also accepts a two argument form [padding_horizontal, 
    padding_vertical] and a one argument form [padding]. 
 
    .. versionchanged:: 1.7.0 
        Replaced NumericProperty with VariableListProperty. 
 
    :attr:`padding` is a :class:`~kivy.properties.VariableListProperty` and 
    defaults to [0, 0, 0, 0]. 
    '''</span>

    <span class="s1">cols </span><span class="s2">= </span><span class="s1">BoundedNumericProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Number of columns in the grid. 
 
    .. versionchanged:: 1.0.8 
        Changed from a NumericProperty to BoundedNumericProperty. You can no 
        longer set this to a negative value. 
 
    :attr:`cols` is a :class:`~kivy.properties.NumericProperty` and defaults to 
    None. 
    '''</span>

    <span class="s1">rows </span><span class="s2">= </span><span class="s1">BoundedNumericProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Number of rows in the grid. 
 
    .. versionchanged:: 1.0.8 
        Changed from a NumericProperty to a BoundedNumericProperty. You can no 
        longer set this to a negative value. 
 
    :attr:`rows` is a :class:`~kivy.properties.NumericProperty` and defaults to 
    None. 
    '''</span>

    <span class="s1">col_default_width </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Default minimum size to use for a column. 
 
    .. versionadded:: 1.0.7 
 
    :attr:`col_default_width` is a :class:`~kivy.properties.NumericProperty` 
    and defaults to 0. 
    '''</span>

    <span class="s1">row_default_height </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Default minimum size to use for row. 
 
    .. versionadded:: 1.0.7 
 
    :attr:`row_default_height` is a :class:`~kivy.properties.NumericProperty` 
    and defaults to 0. 
    '''</span>

    <span class="s1">col_force_default </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">'''If True, ignore the width and size_hint_x of the child and use the 
    default column width. 
 
    .. versionadded:: 1.0.7 
 
    :attr:`col_force_default` is a :class:`~kivy.properties.BooleanProperty` 
    and defaults to False. 
    '''</span>

    <span class="s1">row_force_default </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">'''If True, ignore the height and size_hint_y of the child and use the 
    default row height. 
 
    .. versionadded:: 1.0.7 
 
    :attr:`row_force_default` is a :class:`~kivy.properties.BooleanProperty` 
    and defaults to False. 
    '''</span>

    <span class="s1">cols_minimum </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s3">'''Dict of minimum width for each column. The dictionary keys are the 
    column numbers, e.g. 0, 1, 2... 
 
    .. versionadded:: 1.0.7 
 
    :attr:`cols_minimum` is a :class:`~kivy.properties.DictProperty` and 
    defaults to {}. 
    '''</span>

    <span class="s1">rows_minimum </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s3">'''Dict of minimum height for each row. The dictionary keys are the 
    row numbers, e.g. 0, 1, 2... 
 
    .. versionadded:: 1.0.7 
 
    :attr:`rows_minimum` is a :class:`~kivy.properties.DictProperty` and 
    defaults to {}. 
    '''</span>

    <span class="s1">minimum_width </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Automatically computed minimum width needed to contain all children. 
 
    .. versionadded:: 1.0.8 
 
    :attr:`minimum_width` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 0. It is read only. 
    '''</span>

    <span class="s1">minimum_height </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Automatically computed minimum height needed to contain all children. 
 
    .. versionadded:: 1.0.8 
 
    :attr:`minimum_height` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 0. It is read only. 
    '''</span>

    <span class="s1">minimum_size </span><span class="s2">= </span><span class="s1">ReferenceListProperty</span><span class="s2">(</span><span class="s1">minimum_width</span><span class="s2">, </span><span class="s1">minimum_height</span><span class="s2">)</span>
    <span class="s3">'''Automatically computed minimum size needed to contain all children. 
 
    .. versionadded:: 1.0.8 
 
    :attr:`minimum_size` is a 
    :class:`~kivy.properties.ReferenceListProperty` of 
    (:attr:`minimum_width`, :attr:`minimum_height`) properties. It is read 
    only. 
    '''</span>

    <span class="s1">orientation </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span><span class="s3">'lr-tb'</span><span class="s2">, </span><span class="s1">options</span><span class="s2">=(</span>
        <span class="s3">'lr-tb'</span><span class="s2">, </span><span class="s3">'tb-lr'</span><span class="s2">, </span><span class="s3">'rl-tb'</span><span class="s2">, </span><span class="s3">'tb-rl'</span><span class="s2">, </span><span class="s3">'lr-bt'</span><span class="s2">, </span><span class="s3">'bt-lr'</span><span class="s2">, </span><span class="s3">'rl-bt'</span><span class="s2">,</span>
        <span class="s3">'bt-rl'</span><span class="s2">))</span>
    <span class="s3">'''Orientation of the layout. 
 
    :attr:`orientation` is an :class:`~kivy.properties.OptionProperty` and 
    defaults to 'lr-tb'. 
 
    Valid orientations are 'lr-tb', 'tb-lr', 'rl-tb', 'tb-rl', 'lr-bt', 
    'bt-lr', 'rl-bt' and 'bt-rl'. 
 
    .. versionadded:: 2.0.0 
 
    .. note:: 
 
        'lr' means Left to Right. 
        'rl' means Right to Left. 
        'tb' means Top to Bottom. 
        'bt' means Bottom to Top. 
    '''</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">fbind </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span>
        <span class="s1">update </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_layout</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'col_default_width'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'row_default_height'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'col_force_default'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'row_force_default'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'cols'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'rows'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'parent'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'spacing'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'padding'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'children'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'pos'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'orientation'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">get_max_widgets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cols </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rows</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rows </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cols</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">return None</span>

    <span class="s4">def </span><span class="s1">on_children</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s5"># if that makes impossible to construct things with deferred method,</span>
        <span class="s5"># migrate this test in do_layout, and/or issue a warning.</span>
        <span class="s1">smax </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_max_widgets</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">smax </span><span class="s4">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) &gt; </span><span class="s1">smax</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">GridLayoutException</span><span class="s2">(</span>
                <span class="s3">'Too many children in GridLayout. Increase rows/cols!'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s4">def </span><span class="s1">_fills_row_first</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">orientation</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] </span><span class="s4">in </span><span class="s3">'lr'</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s4">def </span><span class="s1">_fills_from_left_to_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">'lr' </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">orientation</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s4">def </span><span class="s1">_fills_from_top_to_bottom</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">'tb' </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">orientation</span>

    <span class="s4">def </span><span class="s1">_init_rows_cols_sizes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s5"># the goal here is to calculate the minimum size of every cols/rows</span>
        <span class="s5"># and determine if they have stretch or not</span>
        <span class="s1">current_cols </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cols</span>
        <span class="s1">current_rows </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rows</span>

        <span class="s5"># if no cols or rows are set, we can't calculate minimum size.</span>
        <span class="s5"># the grid must be constrained at least on one side</span>
        <span class="s4">if not </span><span class="s1">current_cols </span><span class="s4">and not </span><span class="s1">current_rows</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'%r have no cols or rows set, '</span>
                           <span class="s3">'layout is not triggered.' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">)</span>
            <span class="s4">return</span>

        <span class="s4">if </span><span class="s1">current_cols </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">current_cols </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">count </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">current_rows</span><span class="s2">)))</span>
        <span class="s4">elif </span><span class="s1">current_rows </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">current_rows </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">count </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">current_cols</span><span class="s2">)))</span>

        <span class="s1">current_cols </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">current_cols</span><span class="s2">)</span>
        <span class="s1">current_rows </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">current_rows</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_x </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_y </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_min_size_none </span><span class="s2">= </span><span class="s6">0.  </span><span class="s5"># min size from all the None hint</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_min_size_none </span><span class="s2">= </span><span class="s6">0.  </span><span class="s5"># min size from all the None hint</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols </span><span class="s2">= </span><span class="s1">cols </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">col_default_width</span><span class="s2">] * </span><span class="s1">current_cols</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh </span><span class="s2">= [</span><span class="s4">None</span><span class="s2">] * </span><span class="s1">current_cols</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_min </span><span class="s2">= [</span><span class="s4">None</span><span class="s2">] * </span><span class="s1">current_cols</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_max </span><span class="s2">= [</span><span class="s4">None</span><span class="s2">] * </span><span class="s1">current_cols</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rows </span><span class="s2">= </span><span class="s1">rows </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">row_default_height</span><span class="s2">] * </span><span class="s1">current_rows</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh </span><span class="s2">= [</span><span class="s4">None</span><span class="s2">] * </span><span class="s1">current_rows</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_min </span><span class="s2">= [</span><span class="s4">None</span><span class="s2">] * </span><span class="s1">current_rows</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_max </span><span class="s2">= [</span><span class="s4">None</span><span class="s2">] * </span><span class="s1">current_rows</span>

        <span class="s5"># update minimum size from the dicts</span>
        <span class="s1">items </span><span class="s2">= (</span><span class="s1">i </span><span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cols_minimum</span><span class="s2">.</span><span class="s1">items</span><span class="s2">() </span><span class="s4">if </span><span class="s1">i</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] &lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">))</span>
        <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">items</span><span class="s2">:</span>
            <span class="s1">cols</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">max</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">[</span><span class="s1">index</span><span class="s2">])</span>

        <span class="s1">items </span><span class="s2">= (</span><span class="s1">i </span><span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rows_minimum</span><span class="s2">.</span><span class="s1">items</span><span class="s2">() </span><span class="s4">if </span><span class="s1">i</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] &lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">))</span>
        <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">items</span><span class="s2">:</span>
            <span class="s1">rows</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">max</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">[</span><span class="s1">index</span><span class="s2">])</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">_fill_rows_cols_sizes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cols</span><span class="s2">, </span><span class="s1">rows </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows</span>
        <span class="s1">cols_sh</span><span class="s2">, </span><span class="s1">rows_sh </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh</span>
        <span class="s1">cols_sh_min</span><span class="s2">, </span><span class="s1">rows_sh_min </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_min</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_min</span>
        <span class="s1">cols_sh_max</span><span class="s2">, </span><span class="s1">rows_sh_max </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_max</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_max</span>

        <span class="s5"># calculate minimum size for each columns and rows</span>
        <span class="s1">has_bound_y </span><span class="s2">= </span><span class="s1">has_bound_x </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">idx_iter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_idx_iter</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">))</span>
        <span class="s4">for </span><span class="s1">child</span><span class="s2">, (</span><span class="s1">col</span><span class="s2">, </span><span class="s1">row</span><span class="s2">) </span><span class="s4">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">), </span><span class="s1">idx_iter</span><span class="s2">):</span>
            <span class="s2">(</span><span class="s1">shw</span><span class="s2">, </span><span class="s1">shh</span><span class="s2">), (</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">) = </span><span class="s1">child</span><span class="s2">.</span><span class="s1">size_hint</span><span class="s2">, </span><span class="s1">child</span><span class="s2">.</span><span class="s1">size</span>
            <span class="s1">shw_min</span><span class="s2">, </span><span class="s1">shh_min </span><span class="s2">= </span><span class="s1">child</span><span class="s2">.</span><span class="s1">size_hint_min</span>
            <span class="s1">shw_max</span><span class="s2">, </span><span class="s1">shh_max </span><span class="s2">= </span><span class="s1">child</span><span class="s2">.</span><span class="s1">size_hint_max</span>

            <span class="s5"># compute minimum size / maximum stretch needed</span>
            <span class="s4">if </span><span class="s1">shw </span><span class="s4">is None</span><span class="s2">:</span>
                <span class="s1">cols</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">nmax</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">[</span><span class="s1">col</span><span class="s2">], </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">cols_sh</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">nmax</span><span class="s2">(</span><span class="s1">cols_sh</span><span class="s2">[</span><span class="s1">col</span><span class="s2">], </span><span class="s1">shw</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">shw_min </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">has_bound_x </span><span class="s2">= </span><span class="s4">True</span>
                    <span class="s1">cols_sh_min</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">nmax</span><span class="s2">(</span><span class="s1">cols_sh_min</span><span class="s2">[</span><span class="s1">col</span><span class="s2">], </span><span class="s1">shw_min</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">shw_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">has_bound_x </span><span class="s2">= </span><span class="s4">True</span>
                    <span class="s1">cols_sh_max</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">nmin</span><span class="s2">(</span><span class="s1">cols_sh_max</span><span class="s2">[</span><span class="s1">col</span><span class="s2">], </span><span class="s1">shw_max</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">shh </span><span class="s4">is None</span><span class="s2">:</span>
                <span class="s1">rows</span><span class="s2">[</span><span class="s1">row</span><span class="s2">] = </span><span class="s1">nmax</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">[</span><span class="s1">row</span><span class="s2">], </span><span class="s1">h</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">rows_sh</span><span class="s2">[</span><span class="s1">row</span><span class="s2">] = </span><span class="s1">nmax</span><span class="s2">(</span><span class="s1">rows_sh</span><span class="s2">[</span><span class="s1">row</span><span class="s2">], </span><span class="s1">shh</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">shh_min </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">has_bound_y </span><span class="s2">= </span><span class="s4">True</span>
                    <span class="s1">rows_sh_min</span><span class="s2">[</span><span class="s1">row</span><span class="s2">] = </span><span class="s1">nmax</span><span class="s2">(</span><span class="s1">rows_sh_min</span><span class="s2">[</span><span class="s1">row</span><span class="s2">], </span><span class="s1">shh_min</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">shh_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">has_bound_y </span><span class="s2">= </span><span class="s4">True</span>
                    <span class="s1">rows_sh_max</span><span class="s2">[</span><span class="s1">row</span><span class="s2">] = </span><span class="s1">nmin</span><span class="s2">(</span><span class="s1">rows_sh_max</span><span class="s2">[</span><span class="s1">row</span><span class="s2">], </span><span class="s1">shh_max</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_x </span><span class="s2">= </span><span class="s1">has_bound_x</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_y </span><span class="s2">= </span><span class="s1">has_bound_y</span>

    <span class="s4">def </span><span class="s1">_update_minimum_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># calculate minimum width/height needed, starting from padding +</span>
        <span class="s5"># spacing</span>
        <span class="s1">l</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">padding</span>
        <span class="s1">spacing_x</span><span class="s2">, </span><span class="s1">spacing_y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">spacing</span>
        <span class="s1">cols</span><span class="s2">, </span><span class="s1">rows </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows</span>

        <span class="s1">width </span><span class="s2">= </span><span class="s1">l </span><span class="s2">+ </span><span class="s1">r </span><span class="s2">+ </span><span class="s1">spacing_x </span><span class="s2">* (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">) - </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_min_size_none </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">) + </span><span class="s1">width</span>
        <span class="s5"># we need to subtract for the sh_max/min the already guaranteed size</span>
        <span class="s5"># due to having a None in the col. So sh_min gets smaller by that size</span>
        <span class="s5"># since it's already covered. Similarly for sh_max, because if we</span>
        <span class="s5"># already exceeded the max, the subtracted max will be zero, so</span>
        <span class="s5"># it won't get larger</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_x</span><span class="s2">:</span>
            <span class="s1">cols_sh_min </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_min</span>
            <span class="s1">cols_sh_max </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_max</span>

            <span class="s4">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">c</span><span class="s2">, </span><span class="s1">sh_min</span><span class="s2">, </span><span class="s1">sh_max</span><span class="s2">) </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span>
                    <span class="s1">zip</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">, </span><span class="s1">cols_sh_min</span><span class="s2">, </span><span class="s1">cols_sh_max</span><span class="s2">)):</span>
                <span class="s4">if </span><span class="s1">sh_min </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">width </span><span class="s2">+= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">sh_min</span><span class="s2">)</span>
                    <span class="s1">cols_sh_min</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.</span><span class="s2">, </span><span class="s1">sh_min </span><span class="s2">- </span><span class="s1">c</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">width </span><span class="s2">+= </span><span class="s1">c</span>

                <span class="s4">if </span><span class="s1">sh_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">cols_sh_max</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.</span><span class="s2">, </span><span class="s1">sh_max </span><span class="s2">- </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_min_size_none</span>

        <span class="s1">height </span><span class="s2">= </span><span class="s1">t </span><span class="s2">+ </span><span class="s1">b </span><span class="s2">+ </span><span class="s1">spacing_y </span><span class="s2">* (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">) - </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_min_size_none </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">) + </span><span class="s1">height</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_y</span><span class="s2">:</span>
            <span class="s1">rows_sh_min </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_min</span>
            <span class="s1">rows_sh_max </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_max</span>

            <span class="s4">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">r</span><span class="s2">, </span><span class="s1">sh_min</span><span class="s2">, </span><span class="s1">sh_max</span><span class="s2">) </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span>
                    <span class="s1">zip</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">, </span><span class="s1">rows_sh_min</span><span class="s2">, </span><span class="s1">rows_sh_max</span><span class="s2">)):</span>
                <span class="s4">if </span><span class="s1">sh_min </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">height </span><span class="s2">+= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">sh_min</span><span class="s2">)</span>
                    <span class="s1">rows_sh_min</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.</span><span class="s2">, </span><span class="s1">sh_min </span><span class="s2">- </span><span class="s1">r</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">height </span><span class="s2">+= </span><span class="s1">r</span>

                <span class="s4">if </span><span class="s1">sh_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">rows_sh_max</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.</span><span class="s2">, </span><span class="s1">sh_max </span><span class="s2">- </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_min_size_none</span>

        <span class="s5"># finally, set the minimum size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">minimum_size </span><span class="s2">= (</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_finalize_rows_cols_sizes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">selfw </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s1">selfh </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>

        <span class="s5"># resolve size for each column</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">col_force_default</span><span class="s2">:</span>
            <span class="s1">cols </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">col_default_width</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cols_minimum</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">cols</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cols </span><span class="s2">= </span><span class="s1">cols</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">cols </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols</span>
            <span class="s1">cols_sh </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh</span>
            <span class="s1">cols_sh_min </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_min</span>
            <span class="s1">cols_weight </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">x </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">cols_sh </span><span class="s4">if </span><span class="s1">x </span><span class="s4">is not None</span><span class="s2">)))</span>
            <span class="s1">stretch_w </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.</span><span class="s2">, </span><span class="s1">selfw </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_min_size_none</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">stretch_w </span><span class="s2">&gt; </span><span class="s6">1e-9</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_x</span><span class="s2">:</span>
                    <span class="s5"># fix the hints to be within bounds</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">layout_hint_with_bounds</span><span class="s2">(</span>
                        <span class="s1">cols_weight</span><span class="s2">, </span><span class="s1">stretch_w</span><span class="s2">,</span>
                        <span class="s1">sum</span><span class="s2">((</span><span class="s1">c </span><span class="s4">for </span><span class="s1">c </span><span class="s4">in </span><span class="s1">cols_sh_min </span><span class="s4">if </span><span class="s1">c </span><span class="s4">is not None</span><span class="s2">)),</span>
                        <span class="s1">cols_sh_min</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols_sh_max</span><span class="s2">, </span><span class="s1">cols_sh</span><span class="s2">)</span>

                <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">col_stretch </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">cols_sh</span><span class="s2">):</span>
                    <span class="s5"># if the col don't have stretch information, nothing to do</span>
                    <span class="s4">if not </span><span class="s1">col_stretch</span><span class="s2">:</span>
                        <span class="s4">continue</span>
                    <span class="s5"># add to the min width whatever remains from size_hint</span>
                    <span class="s1">cols</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] += </span><span class="s1">stretch_w </span><span class="s2">* </span><span class="s1">col_stretch </span><span class="s2">/ </span><span class="s1">cols_weight</span>

        <span class="s5"># same algo for rows</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">row_force_default</span><span class="s2">:</span>
            <span class="s1">rows </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">row_default_height</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rows_minimum</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">rows</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_rows </span><span class="s2">= </span><span class="s1">rows</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">rows </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows</span>
            <span class="s1">rows_sh </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh</span>
            <span class="s1">rows_sh_min </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_min</span>
            <span class="s1">rows_weight </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">x </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">rows_sh </span><span class="s4">if </span><span class="s1">x </span><span class="s4">is not None</span><span class="s2">)))</span>
            <span class="s1">stretch_h </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.</span><span class="s2">, </span><span class="s1">selfh </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_min_size_none</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">stretch_h </span><span class="s2">&gt; </span><span class="s6">1e-9</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_has_hint_bound_y</span><span class="s2">:</span>
                    <span class="s5"># fix the hints to be within bounds</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">layout_hint_with_bounds</span><span class="s2">(</span>
                        <span class="s1">rows_weight</span><span class="s2">, </span><span class="s1">stretch_h</span><span class="s2">,</span>
                        <span class="s1">sum</span><span class="s2">((</span><span class="s1">r </span><span class="s4">for </span><span class="s1">r </span><span class="s4">in </span><span class="s1">rows_sh_min </span><span class="s4">if </span><span class="s1">r </span><span class="s4">is not None</span><span class="s2">)),</span>
                        <span class="s1">rows_sh_min</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows_sh_max</span><span class="s2">, </span><span class="s1">rows_sh</span><span class="s2">)</span>

                <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">row_stretch </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">rows_sh</span><span class="s2">):</span>
                    <span class="s5"># if the row don't have stretch information, nothing to do</span>
                    <span class="s4">if not </span><span class="s1">row_stretch</span><span class="s2">:</span>
                        <span class="s4">continue</span>
                    <span class="s5"># add to the min height whatever remains from size_hint</span>
                    <span class="s1">rows</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] += </span><span class="s1">stretch_h </span><span class="s2">* </span><span class="s1">row_stretch </span><span class="s2">/ </span><span class="s1">rows_weight</span>

    <span class="s4">def </span><span class="s1">_iterate_layout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s1">orientation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">orientation</span>
        <span class="s1">padding </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">padding</span>
        <span class="s1">spacing_x</span><span class="s2">, </span><span class="s1">spacing_y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">spacing</span>

        <span class="s1">cols </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cols</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fills_from_left_to_right</span><span class="s2">:</span>
            <span class="s1">x_iter </span><span class="s2">= </span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">(</span>
                <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">padding</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], ),</span>
                <span class="s2">(</span>
                    <span class="s1">col_width </span><span class="s2">+ </span><span class="s1">spacing_x</span>
                    <span class="s4">for </span><span class="s1">col_width </span><span class="s4">in </span><span class="s1">islice</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">) - </span><span class="s6">1</span><span class="s2">)</span>
                <span class="s2">),</span>
            <span class="s2">))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">x_iter </span><span class="s2">= </span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">(</span>
                <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">right </span><span class="s2">- </span><span class="s1">padding</span><span class="s2">[</span><span class="s6">2</span><span class="s2">] - </span><span class="s1">cols</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">], ),</span>
                <span class="s2">(</span>
                    <span class="s1">col_width </span><span class="s2">+ </span><span class="s1">spacing_x</span>
                    <span class="s4">for </span><span class="s1">col_width </span><span class="s4">in </span><span class="s1">islice</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">), </span><span class="s6">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
                <span class="s2">),</span>
            <span class="s2">), </span><span class="s1">sub</span><span class="s2">)</span>
            <span class="s1">cols </span><span class="s2">= </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">)</span>

        <span class="s1">rows </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rows</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fills_from_top_to_bottom</span><span class="s2">:</span>
            <span class="s1">y_iter </span><span class="s2">= </span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">(</span>
                <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">top </span><span class="s2">- </span><span class="s1">padding</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] - </span><span class="s1">rows</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], ),</span>
                <span class="s2">(</span>
                    <span class="s1">row_height </span><span class="s2">+ </span><span class="s1">spacing_y</span>
                    <span class="s4">for </span><span class="s1">row_height </span><span class="s4">in </span><span class="s1">islice</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
                <span class="s2">),</span>
            <span class="s2">), </span><span class="s1">sub</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">y_iter </span><span class="s2">= </span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">chain</span><span class="s2">(</span>
                <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+ </span><span class="s1">padding</span><span class="s2">[</span><span class="s6">3</span><span class="s2">], ),</span>
                <span class="s2">(</span>
                    <span class="s1">row_height </span><span class="s2">+ </span><span class="s1">spacing_y</span>
                    <span class="s4">for </span><span class="s1">row_height </span><span class="s4">in </span><span class="s1">islice</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">) - </span><span class="s6">1</span><span class="s2">)</span>
                <span class="s2">),</span>
            <span class="s2">))</span>
            <span class="s1">rows </span><span class="s2">= </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fills_row_first</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), (</span><span class="s1">row_height</span><span class="s2">, </span><span class="s1">col_width</span><span class="s2">) </span><span class="s4">in </span><span class="s1">zip</span><span class="s2">(</span>
                    <span class="s1">reversed</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)),</span>
                    <span class="s1">product</span><span class="s2">(</span><span class="s1">y_iter</span><span class="s2">, </span><span class="s1">x_iter</span><span class="s2">),</span>
                    <span class="s1">product</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">)):</span>
                <span class="s4">yield </span><span class="s1">i</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">col_width</span><span class="s2">, </span><span class="s1">row_height</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), (</span><span class="s1">col_width</span><span class="s2">, </span><span class="s1">row_height</span><span class="s2">) </span><span class="s4">in </span><span class="s1">zip</span><span class="s2">(</span>
                    <span class="s1">reversed</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)),</span>
                    <span class="s1">product</span><span class="s2">(</span><span class="s1">x_iter</span><span class="s2">, </span><span class="s1">y_iter</span><span class="s2">),</span>
                    <span class="s1">product</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">)):</span>
                <span class="s4">yield </span><span class="s1">i</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">col_width</span><span class="s2">, </span><span class="s1">row_height</span>

    <span class="s4">def </span><span class="s1">do_layout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">children </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span>
        <span class="s4">if not </span><span class="s1">children </span><span class="s4">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_init_rows_cols_sizes</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">children</span><span class="s2">)):</span>
            <span class="s1">l</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">padding</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">minimum_size </span><span class="s2">= </span><span class="s1">l </span><span class="s2">+ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">t </span><span class="s2">+ </span><span class="s1">b</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_fill_rows_cols_sizes</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_minimum_size</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_finalize_rows_cols_sizes</span><span class="s2">()</span>

        <span class="s4">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_iterate_layout</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">children</span><span class="s2">)):</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">children</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span>
            <span class="s1">shw</span><span class="s2">, </span><span class="s1">shh </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">size_hint</span>
            <span class="s1">shw_min</span><span class="s2">, </span><span class="s1">shh_min </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">size_hint_min</span>
            <span class="s1">shw_max</span><span class="s2">, </span><span class="s1">shh_max </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">size_hint_max</span>

            <span class="s4">if </span><span class="s1">shw_min </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">shw_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">w </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">min</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">shw_max</span><span class="s2">), </span><span class="s1">shw_min</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">w </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">shw_min</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">shw_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">w </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">shw_max</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">shh_min </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">shh_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">h </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">min</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">shh_max</span><span class="s2">), </span><span class="s1">shh_min</span><span class="s2">)</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">h </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">shh_min</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">shh_max </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">h </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">shh_max</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">shw </span><span class="s4">is None</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">shh </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">c</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">h</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">shh </span><span class="s4">is None</span><span class="s2">:</span>
                    <span class="s1">c</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">w</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">c</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= (</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_create_idx_iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n_cols</span><span class="s2">, </span><span class="s1">n_rows</span><span class="s2">):</span>
        <span class="s1">col_indices </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_cols</span><span class="s2">) </span><span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fills_from_left_to_right \</span>
            <span class="s4">else </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_cols </span><span class="s2">- </span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">row_indices </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_rows</span><span class="s2">) </span><span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fills_from_top_to_bottom \</span>
            <span class="s4">else </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_rows </span><span class="s2">- </span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fills_row_first</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s2">(</span>
                <span class="s2">(</span><span class="s1">col_index</span><span class="s2">, </span><span class="s1">row_index</span><span class="s2">)</span>
                <span class="s4">for </span><span class="s1">row_index</span><span class="s2">, </span><span class="s1">col_index </span><span class="s4">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">row_indices</span><span class="s2">, </span><span class="s1">col_indices</span><span class="s2">))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">product</span><span class="s2">(</span><span class="s1">col_indices</span><span class="s2">, </span><span class="s1">row_indices</span><span class="s2">)</span>
</pre>
</body>
</html>