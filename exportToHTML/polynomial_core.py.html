<html>
<head>
<title>polynomial_core.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
polynomial_core.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">extending </span><span class="s0">import </span><span class="s2">(</span><span class="s1">models</span><span class="s2">, </span><span class="s1">register_model</span><span class="s2">, </span><span class="s1">type_callable</span><span class="s2">,</span>
                             <span class="s1">unbox</span><span class="s2">, </span><span class="s1">NativeValue</span><span class="s2">, </span><span class="s1">make_attribute_wrapper</span><span class="s2">, </span><span class="s1">box</span><span class="s2">,</span>
                             <span class="s1">lower_builtin</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">types</span><span class="s2">, </span><span class="s1">cgutils</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">NumbaExperimentalFeatureWarning</span><span class="s2">, </span><span class="s1">NumbaValueError</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">polynomial</span><span class="s2">.</span><span class="s1">polynomial </span><span class="s0">import </span><span class="s1">Polynomial</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">ExitStack</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">llvmlite </span><span class="s0">import </span><span class="s1">ir</span>


<span class="s2">@</span><span class="s1">register_model</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">PolynomialModel</span><span class="s2">(</span><span class="s1">models</span><span class="s2">.</span><span class="s1">StructModel</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dmm</span><span class="s2">, </span><span class="s1">fe_type</span><span class="s2">):</span>
        <span class="s1">members </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s3">'coef'</span><span class="s2">, </span><span class="s1">fe_type</span><span class="s2">.</span><span class="s1">coef</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'domain'</span><span class="s2">, </span><span class="s1">fe_type</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'window'</span><span class="s2">, </span><span class="s1">fe_type</span><span class="s2">.</span><span class="s1">window</span><span class="s2">)</span>
            <span class="s4"># Introduced in NumPy 1.24, maybe leave it out for now</span>
            <span class="s4"># ('symbol', types.string)</span>
        <span class="s2">]</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">PolynomialModel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">dmm</span><span class="s2">, </span><span class="s1">fe_type</span><span class="s2">, </span><span class="s1">members</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">type_callable</span><span class="s2">(</span><span class="s1">Polynomial</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">type_polynomial</span><span class="s2">(</span><span class="s1">context</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">typer</span><span class="s2">(</span><span class="s1">coef</span><span class="s2">, </span><span class="s1">domain</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">default_domain </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">double_domain </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">default_window </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">double_window </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">double_coef </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">)</span>

        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">&quot;Polynomial class is experimental&quot;</span><span class="s2">,</span>
                      <span class="s1">category</span><span class="s2">=</span><span class="s1">NumbaExperimentalFeatureWarning</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">coef</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">) </span><span class="s0">and </span><span class="s1">\</span>
                <span class="s1">all</span><span class="s2">([</span><span class="s1">a </span><span class="s0">is None for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">(</span><span class="s1">domain</span><span class="s2">, </span><span class="s1">window</span><span class="s2">)]):</span>
            <span class="s0">if </span><span class="s1">coef</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s4"># If Polynomial(coef) is called, coef is cast to double dtype,</span>
                <span class="s4"># and domain and window are set to equal [-1, 1], i.e. have</span>
                <span class="s4"># integer dtype</span>
                <span class="s0">return </span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">(</span><span class="s1">double_coef</span><span class="s2">,</span>
                                            <span class="s1">default_domain</span><span class="s2">,</span>
                                            <span class="s1">default_window</span><span class="s2">,</span>
                                            <span class="s5">1</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s3">'Coefficient array is not 1-d'</span>
                <span class="s0">raise </span><span class="s1">NumbaValueError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">all</span><span class="s2">([</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">(</span><span class="s1">coef</span><span class="s2">, </span><span class="s1">domain</span><span class="s2">, </span><span class="s1">window</span><span class="s2">)]):</span>
            <span class="s0">if </span><span class="s1">coef</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">all</span><span class="s2">([</span><span class="s1">a</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s5">1 </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">(</span><span class="s1">domain</span><span class="s2">, </span><span class="s1">window</span><span class="s2">)]):</span>
                    <span class="s4"># If Polynomial(coef, domain, window) is called, then coef,</span>
                    <span class="s4"># domain and window are cast to double dtype</span>
                    <span class="s0">return </span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">(</span><span class="s1">double_coef</span><span class="s2">,</span>
                                                <span class="s1">double_domain</span><span class="s2">,</span>
                                                <span class="s1">double_window</span><span class="s2">,</span>
                                                <span class="s5">3</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s3">'Coefficient array is not 1-d'</span>
                <span class="s0">raise </span><span class="s1">NumbaValueError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">typer</span>


<span class="s1">make_attribute_wrapper</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">, </span><span class="s3">'coef'</span><span class="s2">, </span><span class="s3">'coef'</span><span class="s2">)</span>
<span class="s1">make_attribute_wrapper</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">, </span><span class="s3">'domain'</span><span class="s2">, </span><span class="s3">'domain'</span><span class="s2">)</span>
<span class="s1">make_attribute_wrapper</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">, </span><span class="s3">'window'</span><span class="s2">, </span><span class="s3">'window'</span><span class="s2">)</span>
<span class="s4"># Introduced in NumPy 1.24, maybe leave it out for now</span>
<span class="s4"># make_attribute_wrapper(types.PolynomialType, 'symbol', 'symbol')</span>


<span class="s2">@</span><span class="s1">lower_builtin</span><span class="s2">(</span><span class="s1">Polynomial</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">impl_polynomial1</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">to_double</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">const_impl</span><span class="s2">():</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s1">typ </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span>
    <span class="s1">polynomial </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">create_struct_proxy</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">)(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">)</span>
    <span class="s1">sig_coef </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">)(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">coef_cast </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">to_double</span><span class="s2">, </span><span class="s1">sig_coef</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>
    <span class="s1">sig_domain </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)()</span>
    <span class="s1">sig_window </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)()</span>
    <span class="s1">domain_cast </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">const_impl</span><span class="s2">, </span><span class="s1">sig_domain</span><span class="s2">, ())</span>
    <span class="s1">window_cast </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">const_impl</span><span class="s2">, </span><span class="s1">sig_window</span><span class="s2">, ())</span>
    <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">coef </span><span class="s2">= </span><span class="s1">coef_cast</span>
    <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">= </span><span class="s1">domain_cast</span>
    <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">window </span><span class="s2">= </span><span class="s1">window_cast</span>

    <span class="s0">return </span><span class="s1">polynomial</span><span class="s2">.</span><span class="s1">_getvalue</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">lower_builtin</span><span class="s2">(</span><span class="s1">Polynomial</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">impl_polynomial3</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">to_double</span><span class="s2">(</span><span class="s1">coef</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">coef</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">)</span>

    <span class="s1">typ </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span>
    <span class="s1">polynomial </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">create_struct_proxy</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">)(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">)</span>

    <span class="s1">coef_sig </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">)(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">domain_sig </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">)(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">window_sig </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">)(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">coef_cast </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">,</span>
                                         <span class="s1">to_double</span><span class="s2">, </span><span class="s1">coef_sig</span><span class="s2">,</span>
                                         <span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],))</span>
    <span class="s1">domain_cast </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">,</span>
                                           <span class="s1">to_double</span><span class="s2">, </span><span class="s1">domain_sig</span><span class="s2">,</span>
                                           <span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s5">1</span><span class="s2">],))</span>
    <span class="s1">window_cast </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">,</span>
                                           <span class="s1">to_double</span><span class="s2">, </span><span class="s1">window_sig</span><span class="s2">,</span>
                                           <span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s5">2</span><span class="s2">],))</span>

    <span class="s1">domain_helper </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">make_helper</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">,</span>
                                        <span class="s1">domain_sig</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">,</span>
                                        <span class="s1">value</span><span class="s2">=</span><span class="s1">domain_cast</span><span class="s2">)</span>
    <span class="s1">window_helper </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">make_helper</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">,</span>
                                        <span class="s1">window_sig</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">,</span>
                                        <span class="s1">value</span><span class="s2">=</span><span class="s1">window_cast</span><span class="s2">)</span>

    <span class="s1">i64 </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s5">64</span><span class="s2">)</span>
    <span class="s1">two </span><span class="s2">= </span><span class="s1">i64</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">domain_helper</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">window_helper</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">pred1 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_signed</span><span class="s2">(</span><span class="s3">'!='</span><span class="s2">, </span><span class="s1">s1</span><span class="s2">, </span><span class="s1">two</span><span class="s2">)</span>
    <span class="s1">pred2 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_signed</span><span class="s2">(</span><span class="s3">'!='</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">, </span><span class="s1">two</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">if_unlikely</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">pred1</span><span class="s2">):</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_user_exc</span><span class="s2">(</span>
            <span class="s1">builder</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s2">(</span><span class="s3">&quot;Domain has wrong number of elements.&quot;</span><span class="s2">,))</span>

    <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">if_unlikely</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">pred2</span><span class="s2">):</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_user_exc</span><span class="s2">(</span>
            <span class="s1">builder</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s2">(</span><span class="s3">&quot;Window has wrong number of elements.&quot;</span><span class="s2">,))</span>

    <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">coef </span><span class="s2">= </span><span class="s1">coef_cast</span>
    <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">= </span><span class="s1">domain_helper</span><span class="s2">.</span><span class="s1">_getvalue</span><span class="s2">()</span>
    <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">window </span><span class="s2">= </span><span class="s1">window_helper</span><span class="s2">.</span><span class="s1">_getvalue</span><span class="s2">()</span>

    <span class="s0">return </span><span class="s1">polynomial</span><span class="s2">.</span><span class="s1">_getvalue</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">unbox</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">unbox_polynomial</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Convert a Polynomial object to a native polynomial structure. 
    &quot;&quot;&quot;</span>
    <span class="s1">is_error_ptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once_value</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">false_bit</span><span class="s2">)</span>
    <span class="s1">polynomial </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">create_struct_proxy</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">)(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">ExitStack</span><span class="s2">() </span><span class="s0">as </span><span class="s1">stack</span><span class="s2">:</span>
        <span class="s1">natives </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s3">&quot;coef&quot;</span><span class="s2">, </span><span class="s3">&quot;domain&quot;</span><span class="s2">, </span><span class="s3">&quot;window&quot;</span><span class="s2">):</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">object_getattr_string</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">early_exit_if_null</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
                <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">true_bit</span><span class="s2">, </span><span class="s1">is_error_ptr</span><span class="s2">)</span>
            <span class="s1">t </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">native </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">unbox</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">early_exit_if</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">, </span><span class="s1">native</span><span class="s2">.</span><span class="s1">is_error</span><span class="s2">):</span>
                <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">true_bit</span><span class="s2">, </span><span class="s1">is_error_ptr</span><span class="s2">)</span>
            <span class="s1">natives</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">native</span><span class="s2">)</span>

        <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">coef </span><span class="s2">= </span><span class="s1">natives</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">domain </span><span class="s2">= </span><span class="s1">natives</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">polynomial</span><span class="s2">.</span><span class="s1">window </span><span class="s2">= </span><span class="s1">natives</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]</span>

    <span class="s0">return </span><span class="s1">NativeValue</span><span class="s2">(</span><span class="s1">polynomial</span><span class="s2">.</span><span class="s1">_getvalue</span><span class="s2">(),</span>
                       <span class="s1">is_error</span><span class="s2">=</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">is_error_ptr</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">box</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">PolynomialType</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">box_polynomial</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Convert a native polynomial structure to a Polynomial object. 
    &quot;&quot;&quot;</span>
    <span class="s1">ret_ptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">)</span>
    <span class="s1">fail_obj </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">ExitStack</span><span class="s2">() </span><span class="s0">as </span><span class="s1">stack</span><span class="s2">:</span>
        <span class="s1">polynomial </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">create_struct_proxy</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">)(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                                      <span class="s1">value</span><span class="s2">=</span><span class="s1">val</span><span class="s2">)</span>
        <span class="s1">coef_obj </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">box</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">.</span><span class="s1">coef</span><span class="s2">, </span><span class="s1">polynomial</span><span class="s2">.</span><span class="s1">coef</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">early_exit_if_null</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">, </span><span class="s1">coef_obj</span><span class="s2">):</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">fail_obj</span><span class="s2">, </span><span class="s1">ret_ptr</span><span class="s2">)</span>

        <span class="s1">domain_obj </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">box</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">, </span><span class="s1">polynomial</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">early_exit_if_null</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">, </span><span class="s1">domain_obj</span><span class="s2">):</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">fail_obj</span><span class="s2">, </span><span class="s1">ret_ptr</span><span class="s2">)</span>

        <span class="s1">window_obj </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">box</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">.</span><span class="s1">window</span><span class="s2">, </span><span class="s1">polynomial</span><span class="s2">.</span><span class="s1">window</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">early_exit_if_null</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">, </span><span class="s1">window_obj</span><span class="s2">):</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">fail_obj</span><span class="s2">, </span><span class="s1">ret_ptr</span><span class="s2">)</span>

        <span class="s1">class_obj </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">unserialize</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">serialize_object</span><span class="s2">(</span><span class="s1">Polynomial</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">early_exit_if_null</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">, </span><span class="s1">class_obj</span><span class="s2">):</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">coef_obj</span><span class="s2">)</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">domain_obj</span><span class="s2">)</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">window_obj</span><span class="s2">)</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">fail_obj</span><span class="s2">, </span><span class="s1">ret_ptr</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">typ</span><span class="s2">.</span><span class="s1">n_args </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">res1 </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">call_function_objargs</span><span class="s2">(</span><span class="s1">class_obj</span><span class="s2">, (</span><span class="s1">coef_obj</span><span class="s2">,))</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">ret_ptr</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">res3 </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">call_function_objargs</span><span class="s2">(</span><span class="s1">class_obj</span><span class="s2">, (</span><span class="s1">coef_obj</span><span class="s2">,</span>
                                                             <span class="s1">domain_obj</span><span class="s2">,</span>
                                                             <span class="s1">window_obj</span><span class="s2">))</span>
            <span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">res3</span><span class="s2">, </span><span class="s1">ret_ptr</span><span class="s2">)</span>

        <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">coef_obj</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">domain_obj</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">window_obj</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">class_obj</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">c</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">ret_ptr</span><span class="s2">)</span>
</pre>
</body>
</html>