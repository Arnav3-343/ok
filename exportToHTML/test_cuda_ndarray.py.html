<html>
<head>
<title>test_cuda_ndarray.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_cuda_ndarray.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv </span><span class="s0">import </span><span class="s1">devicearray</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">cuda</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">unittest</span><span class="s2">, </span><span class="s1">CUDATestCase</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">skip_on_cudasim</span>


<span class="s0">class </span><span class="s1">TestCudaNDArray</span><span class="s2">(</span><span class="s1">CUDATestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_device_array_interface</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=</span><span class="s3">100</span><span class="s2">)</span>
        <span class="s1">devicearray</span><span class="s2">.</span><span class="s1">verify_cuda_ndarray_interface</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">)</span>

        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s3">100</span><span class="s2">)</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">devicearray</span><span class="s2">.</span><span class="s1">verify_cuda_ndarray_interface</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">)</span>

        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1.234</span><span class="s2">)</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">devicearray</span><span class="s2">.</span><span class="s1">verify_cuda_ndarray_interface</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_from_readonly</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s4"># Make the array readonly</span>
        <span class="s1">ary</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertFalse</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable</span><span class="s2">)</span>
        <span class="s4"># Ensure that we can copy the readonly array</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">retr </span><span class="s2">= </span><span class="s1">dary</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">retr</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">100</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;f4&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">&quot;f4&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_no_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">* </span><span class="s3">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dary</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s1">dary</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:])</span>

    <span class="s0">def </span><span class="s1">test_devicearray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">array</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">gpumem </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">array</span><span class="s2">)</span>
        <span class="s1">array</span><span class="s2">[:] = </span><span class="s3">0</span>
        <span class="s1">gpumem</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(</span><span class="s1">array</span><span class="s2">)</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">original</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_stream_bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">stream </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">stream</span><span class="s2">.</span><span class="s1">auto_synchronize</span><span class="s2">():</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span>
                <span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">),</span>
                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
                <span class="s1">stream</span><span class="s2">=</span><span class="s1">stream</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">).</span><span class="s1">stream</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_len_1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,))</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_len_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">))</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_len_3d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">))</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_partition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s3">100</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">array</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">gpumem </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">array</span><span class="s2">)</span>
        <span class="s1">left</span><span class="s2">, </span><span class="s1">right </span><span class="s2">= </span><span class="s1">gpumem</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">N </span><span class="s2">// </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s1">array</span><span class="s2">[:] = </span><span class="s3">0</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">array </span><span class="s2">== </span><span class="s3">0</span><span class="s2">))</span>

        <span class="s1">right</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(</span><span class="s1">array</span><span class="s2">[</span><span class="s1">N </span><span class="s2">// </span><span class="s3">2</span><span class="s2">:])</span>
        <span class="s1">left</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(</span><span class="s1">array</span><span class="s2">[:</span><span class="s1">N </span><span class="s2">// </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">array </span><span class="s2">== </span><span class="s1">original</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_replace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s3">100</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">array</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">gpumem </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">array</span><span class="s2">)</span>
        <span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">array </span><span class="s2">* </span><span class="s3">2</span><span class="s2">, </span><span class="s1">to</span><span class="s2">=</span><span class="s1">gpumem</span><span class="s2">)</span>
        <span class="s1">gpumem</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(</span><span class="s1">array</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">original </span><span class="s2">* </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'This works in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_transpose_wrongdim</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">gpumem </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">gpumem</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s5">&quot;transposing a non-2D DeviceNDArray isn't supported&quot;</span><span class="s2">,</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_transpose_identity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># any-shape identities should work</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">24</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">),</span>
                             <span class="s1">axes</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)).</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">array </span><span class="s2">== </span><span class="s1">original</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_transpose_duplicatedaxis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">gpumem </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">gpumem</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">),</span>
            <span class="s1">container</span><span class="s2">=[</span>
                <span class="s5">'invalid axes list (0, 0)'</span><span class="s2">,  </span><span class="s4"># GPU</span>
                <span class="s5">'repeated axis in transpose'</span><span class="s2">,  </span><span class="s4"># sim</span>
            <span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_devicearray_transpose_wrongaxis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">gpumem </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">gpumem</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">),</span>
            <span class="s1">container</span><span class="s2">=[</span>
                <span class="s5">'invalid axes list (0, 2)'</span><span class="s2">,  </span><span class="s4"># GPU</span>
                <span class="s5">'invalid axis for this array'</span><span class="s2">,</span>
                <span class="s5">'axis 2 is out of bounds for array of dimension 2'</span><span class="s2">,  </span><span class="s4"># sim</span>
            <span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_devicearray_view_ok</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;i2&quot;</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s5">&quot;i4&quot;</span><span class="s2">, </span><span class="s5">&quot;u4&quot;</span><span class="s2">, </span><span class="s5">&quot;i8&quot;</span><span class="s2">, </span><span class="s5">&quot;f8&quot;</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">):</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
                    <span class="s1">array</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">copy_to_host</span><span class="s2">(),</span>
                    <span class="s1">original</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
                <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_view_ok_not_c_contig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;i2&quot;</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)[:, ::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">original</span><span class="s2">[:, ::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">array</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s5">&quot;u2&quot;</span><span class="s2">).</span><span class="s1">copy_to_host</span><span class="s2">(),</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s5">&quot;u2&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_view_bad_not_c_contig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;i2&quot;</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)[:, ::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">array</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s5">&quot;i4&quot;</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">'To change to a dtype of a different size,'</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s1">contiguous_pre_np123 </span><span class="s2">= </span><span class="s5">'the array must be C-contiguous' </span><span class="s0">in </span><span class="s1">msg</span>
        <span class="s1">contiguous_post_np123 </span><span class="s2">= </span><span class="s5">'the last axis must be contiguous' </span><span class="s0">in </span><span class="s1">msg</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">contiguous_pre_np123 </span><span class="s0">or </span><span class="s1">contiguous_post_np123</span><span class="s2">,</span>
                        <span class="s5">'Expected message to mention contiguity'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_view_bad_itemsize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;i2&quot;</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">array</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s5">&quot;i4&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s5">&quot;When changing to a larger dtype,&quot;</span>
            <span class="s5">&quot; its size must be a divisor of the total size in bytes&quot;</span>
            <span class="s5">&quot; of the last axis of the array.&quot;</span><span class="s2">,</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_transpose_ok</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)).</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">array </span><span class="s2">== </span><span class="s1">original</span><span class="s2">.</span><span class="s1">T</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_transpose_T</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">)).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">).</span><span class="s1">T</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">array </span><span class="s2">== </span><span class="s1">original</span><span class="s2">.</span><span class="s1">T</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_contiguous_slice</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># memcpys are dumb ranges of bytes, so trying to</span>
        <span class="s4"># copy to a non-contiguous range shouldn't work!</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">25</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">fill_value</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">,))</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">s</span>

        <span class="s4"># d is in F-order (not C-order), so d[2] is not contiguous</span>
        <span class="s4"># (40-byte strides). This means we can't memcpy to it!</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">d</span><span class="s2">[</span><span class="s3">2</span><span class="s2">].</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s1">devicearray</span><span class="s2">.</span><span class="s1">errmsg_contiguous_buffer</span><span class="s2">,</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

        <span class="s4"># if d[2].copy_to_device(s), then this would pass:</span>
        <span class="s4"># self.assertTrue((a == d.copy_to_host()).all())</span>

    <span class="s0">def </span><span class="s1">_test_devicearray_contiguous_host_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">a_f</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Checks host-&gt;device memcpys 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">a_f</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">original</span><span class="s2">, </span><span class="s1">copy </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s1">a_f</span><span class="s2">, </span><span class="s1">a_f</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">a_f</span><span class="s2">, </span><span class="s1">a_c</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">a_f</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">a_c</span><span class="s2">),</span>
        <span class="s2">]:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s5">'%s =&gt; %s' </span><span class="s2">% (</span>
                <span class="s5">'C' </span><span class="s0">if </span><span class="s1">original</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous </span><span class="s0">else </span><span class="s5">'F'</span><span class="s2">,</span>
                <span class="s5">'C' </span><span class="s0">if </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous </span><span class="s0">else </span><span class="s5">'F'</span><span class="s2">,</span>
            <span class="s2">)</span>

            <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)</span>
            <span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">() == </span><span class="s1">a_c</span><span class="s2">), </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">() == </span><span class="s1">a_f</span><span class="s2">), </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_contiguous_copy_host_3d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a_c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5 </span><span class="s2">* </span><span class="s3">5 </span><span class="s2">* </span><span class="s3">5</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">a_f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_devicearray_contiguous_host_copy</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">a_f</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_contiguous_copy_host_1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a_c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">a_f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_devicearray_contiguous_host_copy</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">a_f</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_contiguous_copy_device</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a_c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5 </span><span class="s2">* </span><span class="s3">5 </span><span class="s2">* </span><span class="s3">5</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">a_f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">a_f</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">)</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a_f</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s5">&quot;incompatible strides: {} vs. {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">, </span><span class="s1">a_f</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">),</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

        <span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">() == </span><span class="s1">a_c</span><span class="s2">))</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a_f</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s5">&quot;incompatible strides: {} vs. {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">a_f</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">, </span><span class="s1">a_c</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">),</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

        <span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a_f</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">() == </span><span class="s1">a_f</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_devicearray_broadcast_host_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">broadsize </span><span class="s2">= </span><span class="s3">4</span>
        <span class="s1">coreshape </span><span class="s2">= (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">coresize </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">coreshape</span><span class="s2">)</span>
        <span class="s1">core_c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">coresize</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">coreshape</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">core_f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">coresize</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">coreshape</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dim </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">coreshape</span><span class="s2">)):</span>
            <span class="s1">newindex </span><span class="s2">= (</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">),) * </span><span class="s1">dim </span><span class="s2">+ (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">,)</span>
            <span class="s1">broadshape </span><span class="s2">= </span><span class="s1">coreshape</span><span class="s2">[:</span><span class="s1">dim</span><span class="s2">] + (</span><span class="s1">broadsize</span><span class="s2">,) + </span><span class="s1">coreshape</span><span class="s2">[</span><span class="s1">dim</span><span class="s2">:]</span>
            <span class="s1">broad_c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">core_c</span><span class="s2">[</span><span class="s1">newindex</span><span class="s2">], </span><span class="s1">broadshape</span><span class="s2">)</span>
            <span class="s1">broad_f </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">core_f</span><span class="s2">[</span><span class="s1">newindex</span><span class="s2">], </span><span class="s1">broadshape</span><span class="s2">)</span>
            <span class="s1">dbroad_c </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">broad_c</span><span class="s2">)</span>
            <span class="s1">dbroad_f </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">broad_f</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dbroad_c</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">broad_c</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dbroad_f</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">broad_f</span><span class="s2">)</span>
            <span class="s4"># Also test copying across different core orderings</span>
            <span class="s1">dbroad_c</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">broad_f</span><span class="s2">)</span>
            <span class="s1">dbroad_f</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">broad_c</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dbroad_c</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">broad_f</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dbroad_f</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">broad_c</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_contiguous_host_strided</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a_c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a_c</span><span class="s2">)</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">20</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">arr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_devicearray_contiguous_device_strided</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">20</span><span class="s2">))</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">20</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">d</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s1">devicearray</span><span class="s2">.</span><span class="s1">errmsg_contiguous_buffer</span><span class="s2">,</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'DeviceNDArray class not present in simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_relaxed_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># From the reproducer in Issue #6824.</span>

        <span class="s4"># Construct a device array that is contiguous even though</span>
        <span class="s4"># the strides for the first axis (800) are not equal to</span>
        <span class="s4"># the strides * size (10 * 8 = 80) for the previous axis,</span>
        <span class="s4"># because the first axis size is 1.</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">devicearray</span><span class="s2">.</span><span class="s1">DeviceNDArray</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">800</span><span class="s2">, </span><span class="s3">8</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

        <span class="s4"># Ensure we still believe the array to be contiguous because</span>
        <span class="s4"># strides checking is relaxed.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s5">'C_CONTIGUOUS'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s5">'F_CONTIGUOUS'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_c_f_contiguity_matches_numpy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># From the reproducer in Issue #4943.</span>

        <span class="s1">shapes </span><span class="s2">= ((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
        <span class="s1">orders </span><span class="s2">= (</span><span class="s5">'C'</span><span class="s2">, </span><span class="s5">'F'</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">order </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">shapes</span><span class="s2">, </span><span class="s1">orders</span><span class="s2">):</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s1">order</span><span class="s2">)</span>
            <span class="s1">d_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s5">'C_CONTIGUOUS'</span><span class="s2">],</span>
                             <span class="s1">d_arr</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s5">'C_CONTIGUOUS'</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s5">'F_CONTIGUOUS'</span><span class="s2">],</span>
                             <span class="s1">d_arr</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s5">'F_CONTIGUOUS'</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_simple_c</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># C-order 1D array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_simple_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># F-order array that is also C layout.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_2d_c</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># C-order 2D array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_2d_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># F-order array that can only be F layout</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'F'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_noncontig_slice_c</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Non-contiguous slice of C-order array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)[:,</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_noncontig_slice_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Non-contiguous slice of F-order array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)[</span><span class="s3">2</span><span class="s2">,:]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_contig_slice_c</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Contiguous slice of C-order array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)[</span><span class="s3">2</span><span class="s2">,:]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_contig_slice_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Contiguous slice of F-order array - is both C- and F-contiguous, so</span>
        <span class="s4"># types as 'C' layout</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)[:,</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'C'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Typing not done in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_devicearray_typing_order_broadcasted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Broadcasted array, similar to that used for passing scalars to ufuncs</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">]), (</span><span class="s3">10</span><span class="s2">,))</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">_numba_type_</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">, </span><span class="s5">'A'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bug6697</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">dary </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">dary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dary</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'DeviceNDArray class not present in simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_issue_8477</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Ensure that we can copy a zero-length device array to a zero-length</span>
        <span class="s4"># host array when the strides of the device and host arrays differ -</span>
        <span class="s4"># this should be possible because the strides are irrelevant when the</span>
        <span class="s4"># length is zero. For more info see</span>
        <span class="s4"># https://github.com/numba/numba/issues/8477.</span>

        <span class="s4"># Create a device array with shape (0,) and strides (8,)</span>
        <span class="s1">dev_array </span><span class="s2">= </span><span class="s1">devicearray</span><span class="s2">.</span><span class="s1">DeviceNDArray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">,), </span><span class="s1">strides</span><span class="s2">=(</span><span class="s3">8</span><span class="s2">,),</span>
                                              <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>

        <span class="s4"># Create a host array with shape (0,) and strides (0,)</span>
        <span class="s1">host_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">,), </span><span class="s1">strides</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>

        <span class="s4"># Sanity check for this test - ensure our destination has the strides</span>
        <span class="s4"># we expect, because strides can be ignored in some cases by the</span>
        <span class="s4"># ndarray constructor - checking here ensures that we haven't failed to</span>
        <span class="s4"># account for unexpected behaviour across different versions of NumPy</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">host_array</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">, (</span><span class="s3">0</span><span class="s2">,))</span>

        <span class="s4"># Ensure that the copy succeeds in both directions</span>
        <span class="s1">dev_array</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(</span><span class="s1">host_array</span><span class="s2">)</span>
        <span class="s1">dev_array</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">host_array</span><span class="s2">)</span>

        <span class="s4"># Ensure that a device-to-device copy also succeeds when the strides</span>
        <span class="s4"># differ - one way of doing this is to copy the host array across and</span>
        <span class="s4"># use that for copies in both directions.</span>
        <span class="s1">dev_array_from_host </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">host_array</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">dev_array_from_host</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">0</span><span class="s2">,))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">dev_array_from_host</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">, (</span><span class="s3">0</span><span class="s2">,))</span>

        <span class="s1">dev_array</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">dev_array_from_host</span><span class="s2">)</span>
        <span class="s1">dev_array_from_host</span><span class="s2">.</span><span class="s1">copy_to_device</span><span class="s2">(</span><span class="s1">dev_array</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRecarray</span><span class="s2">(</span><span class="s1">CUDATestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_recarray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># From issue #4111</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">((</span><span class="s3">16</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=[</span>
            <span class="s2">(</span><span class="s5">&quot;value1&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;value2&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">])</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">value1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">value2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">) / </span><span class="s3">100</span>

        <span class="s1">expect1 </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">value1</span>
        <span class="s1">expect2 </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">value2</span>

        <span class="s0">def </span><span class="s1">test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">out1</span><span class="s2">, </span><span class="s1">out2</span><span class="s2">):</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">x</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
                <span class="s1">out1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">x</span><span class="s2">.</span><span class="s1">value1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">out2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">x</span><span class="s2">.</span><span class="s1">value2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s1">got1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">expect1</span><span class="s2">)</span>
        <span class="s1">got2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">expect2</span><span class="s2">)</span>
        <span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">test</span><span class="s2">)[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">](</span><span class="s1">a</span><span class="s2">, </span><span class="s1">got1</span><span class="s2">, </span><span class="s1">got2</span><span class="s2">)</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expect1</span><span class="s2">, </span><span class="s1">got1</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expect2</span><span class="s2">, </span><span class="s1">got2</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestCoreContiguous</span><span class="s2">(</span><span class="s1">CUDATestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">view</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s1">devicearray</span><span class="s2">.</span><span class="s1">is_contiguous</span><span class="s2">(</span><span class="s1">view</span><span class="s2">),</span>
            <span class="s1">devicearray</span><span class="s2">.</span><span class="s1">array_core</span><span class="s2">(</span><span class="s1">view</span><span class="s2">).</span><span class="s1">flags</span><span class="s2">[</span><span class="s5">'C_CONTIGUOUS'</span><span class="s2">]</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_2d_transpose</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_3d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">14</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'C'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_1d_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_2d_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_2d_f_transpose</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_device_array_like_3d_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">d_a </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">14</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">d_a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1d_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">shape </span><span class="s2">= </span><span class="s3">10</span>
        <span class="s1">view </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">view</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_1d_view_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">shape </span><span class="s2">= </span><span class="s3">10</span>
        <span class="s1">view </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">view</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">shape </span><span class="s2">= (</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">view </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">, ::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">view</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2d_view_f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">shape </span><span class="s2">= (</span><span class="s3">10</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">view </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s5">'F'</span><span class="s2">)[::</span><span class="s3">2</span><span class="s2">, ::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_against_array_core</span><span class="s2">(</span><span class="s1">view</span><span class="s2">)</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s5">'__main__'</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>