<html>
<head>
<title>test_ufuncs.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_ufuncs.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">operator</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">import </span><span class="s1">unittest</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">guvectorize</span><span class="s2">, </span><span class="s1">njit</span><span class="s2">, </span><span class="s1">typeof</span><span class="s2">, </span><span class="s1">vectorize</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">types</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">np</span><span class="s2">.</span><span class="s1">numpy_support </span><span class="s0">import </span><span class="s1">from_dtype</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">LoweringError</span><span class="s2">, </span><span class="s1">TypingError</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">support </span><span class="s0">import </span><span class="s1">TestCase</span><span class="s2">, </span><span class="s1">MemoryLeakMixin</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">npydecl </span><span class="s0">import </span><span class="s1">supported_ufuncs</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">np </span><span class="s0">import </span><span class="s1">numpy_support</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">registry </span><span class="s0">import </span><span class="s1">cpu_target</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">BaseContext</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">np </span><span class="s0">import </span><span class="s1">ufunc_db</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">support </span><span class="s0">import </span><span class="s1">expected_failure_np2</span>

<span class="s1">is32bits </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">.</span><span class="s1">__itemsize__ </span><span class="s2">== </span><span class="s3">4</span>
<span class="s1">iswindows </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'win32'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_unimplemented</span><span class="s2">(</span><span class="s1">func</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;An 'expectedFailure' like decorator that only expects compilation errors 
    caused by unimplemented functions that fail in no-python mode&quot;&quot;&quot;</span>
    <span class="s2">@</span><span class="s1">functools</span><span class="s2">.</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">func</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">TypingError</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">_ExpectedFailure</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">exc_info</span><span class="s2">())</span>
        <span class="s0">raise </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">_UnexpectedSuccess</span>


<span class="s0">def </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">):</span>
    <span class="s1">ldict </span><span class="s2">= {}</span>
    <span class="s1">arg_str </span><span class="s2">= </span><span class="s4">','</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s4">'a{0}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nargs</span><span class="s2">)])</span>
    <span class="s1">func_str </span><span class="s2">= </span><span class="s4">'def fn({0}):</span><span class="s0">\n    </span><span class="s4">np.{1}({0})'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">arg_str</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
    <span class="s1">exec</span><span class="s2">(</span><span class="s1">func_str</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">(), </span><span class="s1">ldict</span><span class="s2">)</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">ldict</span><span class="s2">[</span><span class="s4">'fn'</span><span class="s2">]</span>
    <span class="s1">fn</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">= </span><span class="s4">'{0}_usecase'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s0">def </span><span class="s1">_make_unary_ufunc_op_usecase</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">):</span>
    <span class="s1">ldict </span><span class="s2">= {}</span>
    <span class="s1">exec</span><span class="s2">(</span><span class="s4">&quot;def fn(x):</span><span class="s0">\n    </span><span class="s4">return {0}(x)&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">), </span><span class="s1">globals</span><span class="s2">(), </span><span class="s1">ldict</span><span class="s2">)</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">ldict</span><span class="s2">[</span><span class="s4">&quot;fn&quot;</span><span class="s2">]</span>
    <span class="s1">fn</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">= </span><span class="s4">&quot;usecase_{0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s0">def </span><span class="s1">_make_binary_ufunc_op_usecase</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">):</span>
    <span class="s1">ldict </span><span class="s2">= {}</span>
    <span class="s1">exec</span><span class="s2">(</span><span class="s4">&quot;def fn(x,y):</span><span class="s0">\n    </span><span class="s4">return x{0}y&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">), </span><span class="s1">globals</span><span class="s2">(), </span><span class="s1">ldict</span><span class="s2">)</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">ldict</span><span class="s2">[</span><span class="s4">&quot;fn&quot;</span><span class="s2">]</span>
    <span class="s1">fn</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">= </span><span class="s4">&quot;usecase_{0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s0">def </span><span class="s1">_make_inplace_ufunc_op_usecase</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Generates a function to be compiled that performs an inplace operation 
 
    ufunc_op can be a string like '+=' or a function like operator.iadd 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s1">ldict </span><span class="s2">= {}</span>
        <span class="s1">exec</span><span class="s2">(</span><span class="s4">&quot;def fn(x,y):</span><span class="s0">\n    </span><span class="s4">x{0}y&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">), </span><span class="s1">globals</span><span class="s2">(), </span><span class="s1">ldict</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">ldict</span><span class="s2">[</span><span class="s4">&quot;fn&quot;</span><span class="s2">]</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">= </span><span class="s4">&quot;usecase_{0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">ufunc_op</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">inplace_op</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">ufunc_op</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">inplace_op</span>
    <span class="s0">return </span><span class="s1">fn</span>


<span class="s0">def </span><span class="s1">_as_dtype_value</span><span class="s2">(</span><span class="s1">tyargs</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Convert python values into numpy scalar objects. 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">)).</span><span class="s1">type</span><span class="s2">(</span><span class="s1">val</span><span class="s2">) </span><span class="s0">for </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">tyargs</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)]</span>


<span class="s0">class </span><span class="s1">BaseUFuncTest</span><span class="s2">(</span><span class="s1">MemoryLeakMixin</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">setUp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BaseUFuncTest</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">setUp</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inputs </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(-</span><span class="s3">0.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(-</span><span class="s3">0.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u4'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i4'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f4'</span><span class="s2">),</span>
             <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">),</span>
             <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">),</span>
             <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
        <span class="s2">]</span>

    <span class="s2">@</span><span class="s1">functools</span><span class="s2">.</span><span class="s1">lru_cache</span><span class="s2">(</span><span class="s1">maxsize</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">nrt</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s6"># NOTE: to test the implementation of Numpy ufuncs, we disable</span>
        <span class="s6"># rewriting of array expressions.</span>
        <span class="s0">return </span><span class="s1">njit</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s1">_nrt</span><span class="s2">=</span><span class="s1">nrt</span><span class="s2">, </span><span class="s1">no_rewrites</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_determine_output_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">input_type</span><span class="s2">, </span><span class="s1">int_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                               <span class="s1">float_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">input_type</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">):</span>
            <span class="s1">ndim </span><span class="s2">= </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">ndim</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ndim </span><span class="s2">= </span><span class="s3">1</span>

        <span class="s0">if </span><span class="s1">ty </span><span class="s0">in </span><span class="s1">types</span><span class="s2">.</span><span class="s1">signed_domain</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">int_output_type</span><span class="s2">:</span>
                <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">int_output_type</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">ty </span><span class="s0">in </span><span class="s1">types</span><span class="s2">.</span><span class="s1">unsigned_domain</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">int_output_type</span><span class="s2">:</span>
                <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">int_output_type</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">float_output_type</span><span class="s2">:</span>
                <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">float_output_type</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">output_type</span>


<span class="s0">class </span><span class="s1">BasicUFuncTest</span><span class="s2">(</span><span class="s1">BaseUFuncTest</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">skip_inputs</span><span class="s2">=[], </span><span class="s1">additional_inputs</span><span class="s2">=[],</span>
                         <span class="s1">int_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">float_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                         <span class="s1">kinds</span><span class="s2">=</span><span class="s4">'ifc'</span><span class="s2">, </span><span class="s1">positive_only</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>

        <span class="s6"># Necessary to avoid some Numpy warnings being silenced, despite</span>
        <span class="s6"># the simplefilter() call below.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reset_module_warnings</span><span class="s2">(</span><span class="s1">__name__</span><span class="s2">)</span>

        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>

        <span class="s1">inputs </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">inputs</span><span class="s2">) + </span><span class="s1">additional_inputs</span>

        <span class="s0">for </span><span class="s1">input_tuple </span><span class="s0">in </span><span class="s1">inputs</span><span class="s2">:</span>
            <span class="s1">input_operand </span><span class="s2">= </span><span class="s1">input_tuple</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s1">input_type </span><span class="s2">= </span><span class="s1">input_tuple</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>

            <span class="s1">is_tuple </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input_operand</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">is_tuple</span><span class="s2">:</span>
                <span class="s1">args </span><span class="s2">= </span><span class="s1">input_operand</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">args </span><span class="s2">= (</span><span class="s1">input_operand</span><span class="s2">,) * </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nin</span>

            <span class="s0">if </span><span class="s1">input_type </span><span class="s0">in </span><span class="s1">skip_inputs</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s0">if </span><span class="s1">positive_only </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] &lt; </span><span class="s3">0</span><span class="s2">):</span>
                <span class="s0">continue</span>

            <span class="s6"># Some ufuncs don't allow all kinds of arguments</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s0">not in </span><span class="s1">kinds</span><span class="s2">):</span>
                <span class="s0">continue</span>

            <span class="s1">output_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_determine_output_type</span><span class="s2">(</span>
                <span class="s1">input_type</span><span class="s2">, </span><span class="s1">int_output_type</span><span class="s2">, </span><span class="s1">float_output_type</span><span class="s2">)</span>

            <span class="s1">input_types </span><span class="s2">= (</span><span class="s1">input_type</span><span class="s2">,) * </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nin</span>
            <span class="s1">output_types </span><span class="s2">= (</span><span class="s1">output_type</span><span class="s2">,) * </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nout</span>
            <span class="s1">argtys </span><span class="s2">= </span><span class="s1">input_types </span><span class="s2">+ </span><span class="s1">output_types</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">argtys</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
                <span class="s1">results </span><span class="s2">= [</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">,</span>
                             <span class="s1">dtype</span><span class="s2">=</span><span class="s1">out_ty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">out_ty </span><span class="s0">in </span><span class="s1">output_types</span>
                <span class="s2">]</span>
                <span class="s1">expected </span><span class="s2">= [</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">out_ty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">out_ty </span><span class="s0">in </span><span class="s1">output_types</span>
                <span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">results </span><span class="s2">= [</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">out_ty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">out_ty </span><span class="s0">in </span><span class="s1">output_types</span>
                <span class="s2">]</span>
                <span class="s1">expected </span><span class="s2">= [</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">out_ty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">out_ty </span><span class="s0">in </span><span class="s1">output_types</span>
                <span class="s2">]</span>

            <span class="s1">invalid_flag </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">warnlist</span><span class="s2">:</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s4">'always'</span><span class="s2">)</span>
                <span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, *</span><span class="s1">expected</span><span class="s2">)</span>

                <span class="s1">warnmsg </span><span class="s2">= </span><span class="s4">&quot;invalid value encountered&quot;</span>
                <span class="s0">for </span><span class="s1">thiswarn </span><span class="s0">in </span><span class="s1">warnlist</span><span class="s2">:</span>

                    <span class="s0">if </span><span class="s2">(</span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">thiswarn</span><span class="s2">.</span><span class="s1">category</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
                            <span class="s0">and </span><span class="s1">str</span><span class="s2">(</span><span class="s1">thiswarn</span><span class="s2">.</span><span class="s1">message</span><span class="s2">).</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">warnmsg</span><span class="s2">)):</span>
                        <span class="s1">invalid_flag </span><span class="s2">= </span><span class="s0">True</span>

            <span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, *</span><span class="s1">results</span><span class="s2">)</span>

            <span class="s0">for </span><span class="s1">expected_i</span><span class="s2">, </span><span class="s1">result_i </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">results</span><span class="s2">):</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s4">&quot;ufunc '{0}' failed&quot;</span><span class="s2">,</span>
                                 <span class="s4">&quot;inputs ({1}):&quot;</span><span class="s2">, </span><span class="s4">&quot;{2}&quot;</span><span class="s2">,</span>
                                 <span class="s4">&quot;got({3})&quot;</span><span class="s2">, </span><span class="s4">&quot;{4}&quot;</span><span class="s2">,</span>
                                 <span class="s4">&quot;expected ({5}):&quot;</span><span class="s2">, </span><span class="s4">&quot;{6}&quot;</span>
                                 <span class="s2">]).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                           <span class="s1">input_type</span><span class="s2">, </span><span class="s1">input_operand</span><span class="s2">,</span>
                                           <span class="s1">output_type</span><span class="s2">, </span><span class="s1">result_i</span><span class="s2">,</span>
                                           <span class="s1">expected_i</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">expected_i</span><span class="s2">)</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
                        <span class="s1">expected_i</span><span class="s2">, </span><span class="s1">result_i</span><span class="s2">,</span>
                        <span class="s1">decimal</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
                        <span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">AssertionError</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">invalid_flag</span><span class="s2">:</span>
                        <span class="s6"># Allow output to mismatch for invalid input</span>
                        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;Output mismatch for invalid input&quot;</span><span class="s2">,</span>
                              <span class="s1">input_tuple</span><span class="s2">, </span><span class="s1">result_i</span><span class="s2">, </span><span class="s1">expected_i</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s0">raise</span>

    <span class="s0">def </span><span class="s1">signed_unsigned_cmp_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">comparison_ufunc</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">comparison_ufunc</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">numpy_support</span><span class="s2">.</span><span class="s1">numpy_version </span><span class="s2">&lt; (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">25</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s6"># Test additional implementations that specifically handle signed /</span>
        <span class="s6"># unsigned comparisons added in NumPy 1.25:</span>
        <span class="s6"># https://github.com/numpy/numpy/pull/23713</span>
        <span class="s1">additional_inputs </span><span class="s2">= (</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">)),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">))</span>
        <span class="s2">)</span>

        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">comparison_ufunc</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">additional_inputs</span><span class="s2">:</span>
            <span class="s1">input_types </span><span class="s2">= (</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
            <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">argtys </span><span class="s2">= </span><span class="s1">input_types </span><span class="s2">+ (</span><span class="s1">output_type</span><span class="s2">,)</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">argtys</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">result</span><span class="s2">)</span>

            <span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestUFuncs</span><span class="s2">(</span><span class="s1">BasicUFuncTest</span><span class="s2">, </span><span class="s1">TestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">basic_int_ufunc_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">skip_inputs </span><span class="s2">= [</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">,</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">),</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">skip_inputs</span><span class="s2">=</span><span class="s1">skip_inputs</span><span class="s2">)</span>

    <span class="s6">############################################################################</span>
    <span class="s6"># Math operations</span>

    <span class="s0">def </span><span class="s1">test_add_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subtract_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">subtract</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiply_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_divide_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Bear in mind that in python3 divide IS true_divide</span>
        <span class="s6"># so the out type for int types will be a double</span>
        <span class="s1">int_out_type </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">int_out_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">divide</span><span class="s2">,</span>
                              <span class="s1">int_output_type</span><span class="s2">=</span><span class="s1">int_out_type</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logaddexp_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logaddexp2_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_true_divide_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">true_divide</span><span class="s2">,</span>
                              <span class="s1">int_output_type</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_floor_divide_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_negative_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># NumPy ufunc has bug with uint32 as input and int64 as output,</span>
        <span class="s6"># so skip uint32 input.</span>
        <span class="s1">skip_inputs </span><span class="s2">= [</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">, </span><span class="s1">int_output_type</span><span class="s2">=</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">,</span>
                              <span class="s1">skip_inputs</span><span class="s2">=</span><span class="s1">skip_inputs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_positive_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">positive</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_power_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">positive_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_power_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float_power</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">&quot;fc&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gcd_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">&quot;iu&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lcm_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">&quot;iu&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_remainder_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mod_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">additional_inputs </span><span class="s2">= [</span>
            <span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">).</span><span class="s1">max</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">16</span><span class="s2">)), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">)</span>
        <span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mod</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'ifcu'</span><span class="s2">,</span>
                              <span class="s1">additional_inputs</span><span class="s2">=</span><span class="s1">additional_inputs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fmod_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_abs_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">):</span>
        <span class="s1">additional_inputs </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">).</span><span class="s1">max</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">).</span><span class="s1">max</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">min</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">min</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">,</span>
                              <span class="s1">additional_inputs</span><span class="s2">=</span><span class="s1">additional_inputs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_absolute_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">test_abs_ufunc</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fabs_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fabs</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rint_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rint</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sign_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_conj_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_exp_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_exp2_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp2</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_log_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_log2_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_log10_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_expm1_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_log1p_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sqrt_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_square_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">square</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cbrt_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reciprocal_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># reciprocal for integers doesn't make much sense and is problematic</span>
        <span class="s6"># in the case of division by zero, as an inf will overflow float to</span>
        <span class="s6"># int conversions, which is undefined behavior.</span>
        <span class="s1">to_skip </span><span class="s2">= [</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">,</span>
                   <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">,</span>
                   <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">,</span>
                   <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">reciprocal</span><span class="s2">, </span><span class="s1">skip_inputs</span><span class="s2">=</span><span class="s1">to_skip</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_conjugate_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">conjugate</span><span class="s2">)</span>

    <span class="s6">############################################################################</span>
    <span class="s6"># Trigonometric Functions</span>

    <span class="s0">def </span><span class="s1">test_sin_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cos_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tan_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tan</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arcsin_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arccos_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arctan_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arctan2_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_hypot_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sinh_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sinh</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cosh_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cosh</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tanh_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tanh</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arcsinh_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arccosh_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arctanh_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># arctanh is only valid is only finite in the range ]-1, 1[</span>
        <span class="s6"># This means that for any of the integer types it will produce</span>
        <span class="s6"># conversion from infinity/-infinity to integer. That's undefined</span>
        <span class="s6"># behavior in C, so the results may vary from implementation to</span>
        <span class="s6"># implementation. This means that the result from the compiler</span>
        <span class="s6"># used to compile NumPy may differ from the result generated by</span>
        <span class="s6"># llvm. Skipping the integer types in this test avoids failed</span>
        <span class="s6"># tests because of this.</span>
        <span class="s1">to_skip </span><span class="s2">= [</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">,</span>
                   <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">,</span>
                   <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">,</span>
                   <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">, </span><span class="s1">skip_inputs</span><span class="s2">=</span><span class="s1">to_skip</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'cf'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_deg2rad_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">deg2rad</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rad2deg_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rad2deg</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_degrees_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">degrees</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_radians_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">radians</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s6">############################################################################</span>
    <span class="s6"># Bit-twiddling Functions</span>

    <span class="s0">def </span><span class="s1">test_bitwise_and_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_int_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bitwise_or_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_int_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bitwise_xor_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_int_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invert_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_int_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">invert</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bitwise_not_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_int_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_not</span><span class="s2">)</span>

    <span class="s6"># Note: there is no entry for left_shift and right_shift as this harness</span>
    <span class="s6">#       is not valid for them. This is so because left_shift and right</span>
    <span class="s6">#       shift implementation in NumPy has undefined behavior (in C-parlance)</span>
    <span class="s6">#       when the second argument is a negative (or bigger than the number</span>
    <span class="s6">#       of bits) value.</span>
    <span class="s6">#       Also, right_shift for negative first arguments also relies on</span>
    <span class="s6">#       implementation defined behavior, although numba warantees &quot;sane&quot;</span>
    <span class="s6">#       behavior (arithmetic shifts on signed integers, logic shifts on</span>
    <span class="s6">#       unsigned integers).</span>

    <span class="s6">############################################################################</span>
    <span class="s6"># Comparison functions</span>
    <span class="s0">def </span><span class="s1">test_greater_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signed_unsigned_cmp_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_greater_equal_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signed_unsigned_cmp_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater_equal</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_less_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signed_unsigned_cmp_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">less</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_less_equal_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signed_unsigned_cmp_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">less_equal</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_equal_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signed_unsigned_cmp_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equal_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signed_unsigned_cmp_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logical_and_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_and</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logical_or_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_or</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logical_xor_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_xor</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logical_not_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_not</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_maximum_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_minimum_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fmax_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fmin_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">)</span>

    <span class="s6">############################################################################</span>
    <span class="s6"># Floating functions</span>

    <span class="s0">def </span><span class="s1">bool_additional_inputs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">),</span>
             <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
        <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_isfinite_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'ifcb'</span><span class="s2">,</span>
            <span class="s1">additional_inputs</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bool_additional_inputs</span><span class="s2">(),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_isinf_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'ifcb'</span><span class="s2">,</span>
            <span class="s1">additional_inputs</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bool_additional_inputs</span><span class="s2">(),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_isnan_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'ifcb'</span><span class="s2">,</span>
            <span class="s1">additional_inputs</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bool_additional_inputs</span><span class="s2">(),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_signbit_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_copysign_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">copysign</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nextafter_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">_unimplemented</span>
    <span class="s0">def </span><span class="s1">test_modf_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s6"># Note: there is no entry for ldexp as this harness isn't valid for this</span>
    <span class="s6">#       ufunc. this is so because ldexp requires heterogeneous inputs.</span>
    <span class="s6">#       However, this ufunc is tested by the TestLoopTypes test classes.</span>

    <span class="s2">@</span><span class="s1">_unimplemented</span>
    <span class="s0">def </span><span class="s1">test_frexp_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_floor_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ceil_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_trunc_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_spacing_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># additional input to check inf behaviour as Numba uses a different alg</span>
        <span class="s6"># to NumPy</span>
        <span class="s1">additional </span><span class="s2">= [(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                       <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">basic_ufunc_test</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">, </span><span class="s1">kinds</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">,</span>
                              <span class="s1">additional_inputs</span><span class="s2">=</span><span class="s1">additional</span><span class="s2">)</span>

    <span class="s6">############################################################################</span>
    <span class="s6"># Other tests</span>

    <span class="s0">def </span><span class="s1">binary_ufunc_mixed_types_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">):</span>
        <span class="s1">ufunc_name </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
        <span class="s1">inputs1 </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
            <span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">),</span>
             <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">))]</span>

        <span class="s1">inputs2 </span><span class="s2">= </span><span class="s1">inputs1</span>

        <span class="s1">output_types </span><span class="s2">= [</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">),</span>
                        <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)]</span>

        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">ufunc</span>

        <span class="s0">for </span><span class="s1">vals </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">inputs1</span><span class="s2">, </span><span class="s1">inputs2</span><span class="s2">, </span><span class="s1">output_types</span><span class="s2">):</span>
            <span class="s1">input1</span><span class="s2">, </span><span class="s1">input2</span><span class="s2">, </span><span class="s1">output_type </span><span class="s2">= </span><span class="s1">vals</span>

            <span class="s1">input1_operand </span><span class="s2">= </span><span class="s1">input1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s1">input1_type </span><span class="s2">= </span><span class="s1">input1</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>

            <span class="s1">input2_operand </span><span class="s2">= </span><span class="s1">input2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s1">input2_type </span><span class="s2">= </span><span class="s1">input2</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>

            <span class="s6"># Skip division by unsigned int because of NumPy bugs</span>
            <span class="s0">if </span><span class="s1">ufunc_name </span><span class="s2">== </span><span class="s4">'divide' </span><span class="s0">and </span><span class="s2">(</span>
                    <span class="s1">input2_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s1">input2_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)):</span>
                <span class="s0">continue</span>

            <span class="s6"># Skip some subtraction tests because of NumPy bugs</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">ufunc_name </span><span class="s2">== </span><span class="s4">'subtract'</span>
                    <span class="s0">and </span><span class="s1">input1_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
                    <span class="s0">and </span><span class="s1">input2_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span>
                    <span class="s0">and </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)):</span>
                <span class="s0">continue</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">ufunc_name </span><span class="s2">== </span><span class="s4">'subtract'</span>
                    <span class="s0">and </span><span class="s1">input1_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
                    <span class="s0">and </span><span class="s1">input2_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span>
                    <span class="s0">and </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)):</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s2">((</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input1_type</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input2_type</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">)) </span><span class="s0">and</span>
                    <span class="s0">not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">output_type</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">)):</span>
                <span class="s0">continue</span>

            <span class="s1">args </span><span class="s2">= (</span><span class="s1">input1_type</span><span class="s2">, </span><span class="s1">input2_type</span><span class="s2">, </span><span class="s1">output_type</span><span class="s2">)</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input1_operand</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">input1_operand</span><span class="s2">.</span><span class="s1">size</span><span class="s2">,</span>
                                  <span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">input1_operand</span><span class="s2">.</span><span class="s1">size</span><span class="s2">,</span>
                                    <span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input2_operand</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">input2_operand</span><span class="s2">.</span><span class="s1">size</span><span class="s2">,</span>
                                  <span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">input2_operand</span><span class="s2">.</span><span class="s1">size</span><span class="s2">,</span>
                                    <span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">input1_operand</span><span class="s2">, </span><span class="s1">input2_operand</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
            <span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">input1_operand</span><span class="s2">, </span><span class="s1">input2_operand</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

            <span class="s1">scalar_type </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">output_type</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">, </span><span class="s1">output_type</span><span class="s2">)</span>
            <span class="s1">prec </span><span class="s2">= (</span><span class="s4">'single'</span>
                    <span class="s0">if </span><span class="s1">scalar_type </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
                    <span class="s0">else </span><span class="s4">'double'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s1">prec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_broadcasting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s6"># Test unary ufunc</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">)</span>

        <span class="s1">input_operands </span><span class="s2">= [</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">)]</span>

        <span class="s1">output_operands </span><span class="s2">= [</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">)]</span>

        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">result </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">input_operands</span><span class="s2">, </span><span class="s1">output_operands</span><span class="s2">):</span>

            <span class="s1">input_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">result</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">args </span><span class="s2">= (</span><span class="s1">input_type</span><span class="s2">, </span><span class="s1">output_type</span><span class="s2">)</span>

            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">result</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s6"># Test binary ufunc</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">)</span>

        <span class="s1">input1_operands </span><span class="s2">= [</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">)]</span>

        <span class="s1">input2_operands </span><span class="s2">= </span><span class="s1">input1_operands</span>

        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">input1_operands</span><span class="s2">, </span><span class="s1">input2_operands</span><span class="s2">):</span>

            <span class="s1">input1_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">input2_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">output_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">), </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">args </span><span class="s2">= (</span><span class="s1">input1_type</span><span class="s2">, </span><span class="s1">input2_type</span><span class="s2">, </span><span class="s1">output_type</span><span class="s2">)</span>

            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">)</span>

            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_implicit_output_npm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Test for Issue #1078 (https://github.com/numba/numba/issues/1078) -</span>
        <span class="s6"># ensures that the output of a ufunc is an array.</span>
        <span class="s1">arr_ty </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">sig </span><span class="s2">= (</span><span class="s1">arr_ty</span><span class="s2">, </span><span class="s1">arr_ty</span><span class="s2">)</span>

        <span class="s2">@</span><span class="s1">njit</span><span class="s2">((</span><span class="s1">arr_ty</span><span class="s2">, </span><span class="s1">arr_ty</span><span class="s2">))</span>
        <span class="s0">def </span><span class="s1">myadd</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">myadd</span><span class="s2">.</span><span class="s1">overloads</span><span class="s2">[</span><span class="s1">sig</span><span class="s2">].</span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">, </span><span class="s1">arr_ty</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_broadcast_implicit_output_npm_nrt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">)</span>

        <span class="s1">input1_operands </span><span class="s2">= [</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">3</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">3</span><span class="s2">)]</span>

        <span class="s1">input2_operands </span><span class="s2">= </span><span class="s1">input1_operands</span>

        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">input1_operands</span><span class="s2">, </span><span class="s1">input2_operands</span><span class="s2">):</span>

            <span class="s1">input1_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">input2_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
            <span class="s1">args </span><span class="s2">= (</span><span class="s1">input1_type</span><span class="s2">, </span><span class="s1">input2_type</span><span class="s2">)</span>

            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">nrt</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_implicit_output_layout_binary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">)</span>

        <span class="s6"># C layout</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s6"># F layout</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s6"># A layout</span>
        <span class="s1">Z </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">).</span><span class="s1">T</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>

        <span class="s1">Xty </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">X</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous </span><span class="s0">and </span><span class="s1">Xty</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">== </span><span class="s4">'C'</span>
        <span class="s1">Yty </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous </span><span class="s0">and </span><span class="s1">Yty</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">== </span><span class="s4">'F'</span>
        <span class="s1">Zty </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Zty</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">== </span><span class="s4">'A'</span>
        <span class="s0">assert not </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s0">assert not </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span>

        <span class="s1">testcases </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">permutations</span><span class="s2">([</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">], </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">testcases </span><span class="s2">+= [(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)]</span>
        <span class="s1">testcases </span><span class="s2">+= [(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)]</span>
        <span class="s1">testcases </span><span class="s2">+= [(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">)]</span>

        <span class="s0">for </span><span class="s1">arg0</span><span class="s2">, </span><span class="s1">arg1 </span><span class="s0">in </span><span class="s1">testcases</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= (</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">arg0</span><span class="s2">), </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">))</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">nrt</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">arg0</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">)</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">arg0</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">,</span>
                             <span class="s1">result</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">,</span>
                             <span class="s1">result</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_implicit_output_layout_unary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">)</span>

        <span class="s6"># C layout</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s6"># F layout</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
        <span class="s6"># A layout</span>
        <span class="s1">Z </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">).</span><span class="s1">T</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>

        <span class="s1">Xty </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">X</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous </span><span class="s0">and </span><span class="s1">Xty</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">== </span><span class="s4">'C'</span>
        <span class="s1">Yty </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous </span><span class="s0">and </span><span class="s1">Yty</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">== </span><span class="s4">'F'</span>
        <span class="s1">Zty </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">Zty</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">== </span><span class="s4">'A'</span>
        <span class="s0">assert not </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s0">assert not </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span>

        <span class="s0">for </span><span class="s1">arg0 </span><span class="s0">in </span><span class="s2">[</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">]:</span>
            <span class="s1">args </span><span class="s2">= (</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">arg0</span><span class="s2">),)</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">nrt</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">arg0</span><span class="s2">)</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">arg0</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">,</span>
                             <span class="s1">result</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">,</span>
                             <span class="s1">result</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestArrayOperators</span><span class="s2">(</span><span class="s1">BaseUFuncTest</span><span class="s2">, </span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">_check_results</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind</span><span class="s2">, </span><span class="s1">got</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">unary_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">, </span><span class="s1">nrt</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                      <span class="s1">skip_inputs</span><span class="s2">=[], </span><span class="s1">additional_inputs</span><span class="s2">=[],</span>
                      <span class="s1">int_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">float_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">operator_func </span><span class="s2">= </span><span class="s1">_make_unary_ufunc_op_usecase</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">)</span>
        <span class="s1">inputs </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">inputs</span><span class="s2">)</span>
        <span class="s1">inputs</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">additional_inputs</span><span class="s2">)</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">operator_func</span>
        <span class="s0">for </span><span class="s1">input_tuple </span><span class="s0">in </span><span class="s1">inputs</span><span class="s2">:</span>
            <span class="s1">input_operand</span><span class="s2">, </span><span class="s1">input_type </span><span class="s2">= </span><span class="s1">input_tuple</span>

            <span class="s0">if </span><span class="s2">((</span><span class="s1">input_type </span><span class="s0">in </span><span class="s1">skip_inputs</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s2">(</span><span class="s0">not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input_type</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">))):</span>
                <span class="s0">continue</span>

            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, (</span><span class="s1">input_type</span><span class="s2">,), </span><span class="s1">nrt</span><span class="s2">=</span><span class="s1">nrt</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">input_operand</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">input_operand</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_results</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">, </span><span class="s1">nrt</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                       <span class="s1">skip_inputs</span><span class="s2">=[], </span><span class="s1">additional_inputs</span><span class="s2">=[],</span>
                       <span class="s1">int_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">float_output_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                       <span class="s1">positive_rhs</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">operator_func </span><span class="s2">= </span><span class="s1">_make_binary_ufunc_op_usecase</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">)</span>
        <span class="s1">inputs </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">inputs</span><span class="s2">)</span>
        <span class="s1">inputs</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">additional_inputs</span><span class="s2">)</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">operator_func</span>
        <span class="s6"># when generating arbitrary sequences, we use a fixed seed</span>
        <span class="s6"># for deterministic testing</span>
        <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">input_tuple </span><span class="s0">in </span><span class="s1">inputs</span><span class="s2">:</span>
            <span class="s1">input_operand1</span><span class="s2">, </span><span class="s1">input_type </span><span class="s2">= </span><span class="s1">input_tuple</span>
            <span class="s1">input_dtype </span><span class="s2">= </span><span class="s1">numpy_support</span><span class="s2">.</span><span class="s1">as_dtype</span><span class="s2">(</span>
                <span class="s1">getattr</span><span class="s2">(</span><span class="s1">input_type</span><span class="s2">, </span><span class="s4">&quot;dtype&quot;</span><span class="s2">, </span><span class="s1">input_type</span><span class="s2">))</span>
            <span class="s1">input_type1 </span><span class="s2">= </span><span class="s1">input_type</span>

            <span class="s0">if </span><span class="s1">input_type </span><span class="s0">in </span><span class="s1">skip_inputs</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">positive_rhs</span><span class="s2">:</span>
                <span class="s1">zero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">input_dtype</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s6"># If we only use two scalars, the code generator will not</span>
            <span class="s6"># select the ufunctionalized operator, so we mix it up.</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input_type</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">):</span>
                <span class="s1">input_operand0 </span><span class="s2">= </span><span class="s1">input_operand1</span>
                <span class="s1">input_type0 </span><span class="s2">= </span><span class="s1">input_type</span>
                <span class="s0">if </span><span class="s1">positive_rhs </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">input_operand1 </span><span class="s2">&lt; </span><span class="s1">zero</span><span class="s2">):</span>
                    <span class="s0">continue</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">input_operand0 </span><span class="s2">= (</span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span>
                    <span class="s1">input_dtype</span><span class="s2">)</span>
                <span class="s1">input_type0 </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">input_operand0</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">positive_rhs </span><span class="s0">and </span><span class="s1">input_operand1 </span><span class="s2">&lt; </span><span class="s1">zero</span><span class="s2">:</span>
                    <span class="s0">continue</span>

            <span class="s1">args </span><span class="s2">= (</span><span class="s1">input_type0</span><span class="s2">, </span><span class="s1">input_type1</span><span class="s2">)</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">nrt</span><span class="s2">=</span><span class="s1">nrt</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">input_operand0</span><span class="s2">, </span><span class="s1">input_operand1</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">input_operand0</span><span class="s2">, </span><span class="s1">input_operand1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_results</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bitwise_additional_inputs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># For bitwise operators, we want to check the results for boolean</span>
        <span class="s6"># arrays (see #1813).</span>
        <span class="s0">return </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">boolean</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s0">False</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">boolean</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">boolean</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
        <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">binary_int_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s1">skip_inputs </span><span class="s2">= </span><span class="s1">kws</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s4">'skip_inputs'</span><span class="s2">, [])</span>
        <span class="s1">skip_inputs </span><span class="s2">+= [</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">),</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">binary_bitwise_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s1">additional_inputs </span><span class="s2">= </span><span class="s1">kws</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s4">'additional_inputs'</span><span class="s2">, [])</span>
        <span class="s1">additional_inputs </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bitwise_additional_inputs</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">binary_int_op_test</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">inplace_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">,</span>
                        <span class="s1">lhs_dtypes</span><span class="s2">, </span><span class="s1">rhs_dtypes</span><span class="s2">, </span><span class="s1">precise</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">operator_func </span><span class="s2">= </span><span class="s1">_make_inplace_ufunc_op_usecase</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">)</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">operator_func</span>

        <span class="s0">if </span><span class="s1">precise</span><span class="s2">:</span>
            <span class="s1">assertion </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assertion </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span>

        <span class="s6"># The left operand can only be an array, while the right operand</span>
        <span class="s6"># can be either an array or a scalar</span>
        <span class="s1">lhs_inputs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
                      <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">lhs_dtypes</span><span class="s2">]</span>

        <span class="s1">rhs_arrays </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">rhs_values</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
                      <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">rhs_dtypes</span><span class="s2">]</span>
        <span class="s1">rhs_scalars </span><span class="s2">= [</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">rhs_values </span><span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">rhs_dtypes</span><span class="s2">]</span>
        <span class="s1">rhs_inputs </span><span class="s2">= </span><span class="s1">rhs_arrays </span><span class="s2">+ </span><span class="s1">rhs_scalars</span>

        <span class="s0">for </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">lhs_inputs</span><span class="s2">, </span><span class="s1">rhs_inputs</span><span class="s2">):</span>
            <span class="s1">lhs_type </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">)</span>
            <span class="s1">rhs_type </span><span class="s2">= </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span>
            <span class="s1">args </span><span class="s2">= (</span><span class="s1">lhs_type</span><span class="s2">, </span><span class="s1">rhs_type</span><span class="s2">)</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compile</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
            <span class="s1">assertion</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">,</span>
                              <span class="s1">precise</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s6"># Also accept integer inputs for the right operand (they should</span>
        <span class="s6"># be converted to float).</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">,</span>
                                    <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                                    <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
                                    <span class="s1">precise</span><span class="s2">=</span><span class="s1">precise</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">inplace_int_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">,</span>
                             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">inplace_bitwise_op_test</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_int_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">, </span><span class="s1">lhs_values</span><span class="s2">, </span><span class="s1">rhs_values</span><span class="s2">,</span>
                             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">,), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">))</span>

    <span class="s6"># ____________________________________________________________</span>
    <span class="s6"># Unary operators</span>

    <span class="s0">def </span><span class="s1">test_unary_positive_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unary_op_test</span><span class="s2">(</span><span class="s4">'+'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unary_negative_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unary_op_test</span><span class="s2">(</span><span class="s4">'-'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unary_invert_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unary_op_test</span><span class="s2">(</span><span class="s4">'~'</span><span class="s2">,</span>
                           <span class="s1">skip_inputs</span><span class="s2">=[</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
                                        <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">),</span>
                                        <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)],</span>
                           <span class="s1">additional_inputs</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bitwise_additional_inputs</span><span class="s2">())</span>

    <span class="s6"># ____________________________________________________________</span>
    <span class="s6"># Inplace operators</span>

    <span class="s0">def </span><span class="s1">test_inplace_add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s4">'+='</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">iadd</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_sub</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s4">'-='</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">isub</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_mul</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s4">'*='</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">imul</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_floordiv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s4">'//='</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ifloordiv</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                                   <span class="s2">[-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_div</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s4">'/='</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">itruediv</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                                   <span class="s2">[-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_remainder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s4">'%='</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">imod</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_pow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s4">'**='</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">],</span>
                                   <span class="s1">precise</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_float_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ipow</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">],</span>
                                   <span class="s1">precise</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inplace_and</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_bitwise_op_test</span><span class="s2">(</span><span class="s4">'&amp;='</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">51</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">255</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_bitwise_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">iand</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">51</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">255</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_or</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_bitwise_op_test</span><span class="s2">(</span><span class="s4">'|='</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">51</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">255</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_bitwise_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ior</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">51</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">255</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_xor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_bitwise_op_test</span><span class="s2">(</span><span class="s4">'^='</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">51</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">255</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_bitwise_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ixor</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">51</span><span class="s2">],</span>
                                     <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">255</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_lshift</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_int_op_test</span><span class="s2">(</span><span class="s4">'&lt;&lt;='</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, -</span><span class="s3">51</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">14</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_int_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ilshift</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, -</span><span class="s3">51</span><span class="s2">],</span>
                                 <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">14</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inplace_rshift</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_int_op_test</span><span class="s2">(</span><span class="s4">'&gt;&gt;='</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, -</span><span class="s3">51</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">14</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inplace_int_op_test</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">irshift</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, -</span><span class="s3">51</span><span class="s2">],</span>
                                 <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">14</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_unary_positive_array_op_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">''' 
        Verify that the unary positive operator copies values, and doesn't 
        just alias to the input array (mirrors normal Numpy/Python 
        interaction behavior). 
        '''</span>
        <span class="s6"># Test originally from @gmarkall</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">):</span>
            <span class="s1">a2 </span><span class="s2">= +</span><span class="s1">a1</span>
            <span class="s1">a1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s3">3</span>
            <span class="s1">a2</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = </span><span class="s3">4</span>
            <span class="s0">return </span><span class="s1">a2</span>

        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">a2 </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] != </span><span class="s1">a2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">and </span><span class="s1">a1</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] != </span><span class="s1">a2</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">a3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">a4 </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)(</span><span class="s1">a3</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">a3</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] != </span><span class="s1">a4</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">and </span><span class="s1">a3</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] != </span><span class="s1">a4</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">, </span><span class="s1">a3</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">, </span><span class="s1">a4</span><span class="s2">)</span>

    <span class="s6"># ____________________________________________________________</span>
    <span class="s6"># Binary operators</span>

    <span class="s0">def </span><span class="s1">test_add_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'+'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_subtract_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'-'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiply_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'*'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_divide_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">int_out_type </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">int_out_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'/'</span><span class="s2">, </span><span class="s1">int_output_type</span><span class="s2">=</span><span class="s1">int_out_type</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_floor_divide_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Avoid floating-point zeros as x // 0.0 can have varying results</span>
        <span class="s6"># depending on the algorithm (which changed across Numpy versions)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">inputs </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">4</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(-</span><span class="s3">5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(-</span><span class="s3">0.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">1.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(-</span><span class="s3">2.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s3">3.5</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>

            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u4'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'u8'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i4'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">6</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i8'</span><span class="s2">), </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f4'</span><span class="s2">),</span>
             <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">),</span>
             <span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)),</span>
        <span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'//'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_remainder_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'%'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_power_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'**'</span><span class="s2">, </span><span class="s1">positive_rhs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_left_shift_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_int_op_test</span><span class="s2">(</span><span class="s4">'&lt;&lt;'</span><span class="s2">, </span><span class="s1">positive_rhs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_right_shift_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_int_op_test</span><span class="s2">(</span><span class="s4">'&gt;&gt;'</span><span class="s2">, </span><span class="s1">positive_rhs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bitwise_and_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_bitwise_op_test</span><span class="s2">(</span><span class="s4">'&amp;'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bitwise_or_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_bitwise_op_test</span><span class="s2">(</span><span class="s4">'|'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bitwise_xor_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_bitwise_op_test</span><span class="s2">(</span><span class="s4">'^'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equal_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'=='</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_greater_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'&gt;'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_greater_equal_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'&gt;='</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_less_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'&lt;'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_less_equal_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'&lt;='</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_equal_array_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">binary_op_test</span><span class="s2">(</span><span class="s4">'!='</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestScalarUFuncs</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;check the machinery of ufuncs works when the result is an scalar. 
    These are not exhaustive because: 
    - the machinery to support this case is the same for all the functions of a 
      given arity. 
    - the result of the inner function itself is already tested in TestUFuncs 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">run_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">, </span><span class="s1">arg_types</span><span class="s2">, </span><span class="s1">arg_values</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">tyargs</span><span class="s2">, </span><span class="s1">args </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">arg_types</span><span class="s2">, </span><span class="s1">arg_values</span><span class="s2">):</span>
            <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">(</span><span class="s1">tyargs</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">_as_dtype_value</span><span class="s2">(</span><span class="s1">tyargs</span><span class="s2">, </span><span class="s1">args</span><span class="s2">))</span>

            <span class="s1">msg </span><span class="s2">= </span><span class="s4">'for args {0} typed {1}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s1">tyargs</span><span class="s2">)</span>

            <span class="s6"># note: due to semantics of ufuncs, thing like adding a int32 to a</span>
            <span class="s6"># uint64 results in doubles (as neither int32 can be cast safely</span>
            <span class="s6"># to uint64 nor vice-versa, falling back to using the float version.</span>
            <span class="s6"># Modify in those cases the expected value (the numpy version does</span>
            <span class="s6"># not use typed integers as inputs so its result is an integer)</span>
            <span class="s1">special </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span>
                <span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
            <span class="s2">])</span>
            <span class="s0">if </span><span class="s1">tyargs </span><span class="s0">in </span><span class="s1">special</span><span class="s2">:</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s6"># The numba version of scalar ufuncs return an actual value that</span>
                <span class="s6"># gets converted to a Python type, instead of using NumPy</span>
                <span class="s6"># scalars.  although in python 2 NumPy scalars are considered</span>
                <span class="s6"># and instance of the appropriate python type, in python 3 that</span>
                <span class="s6"># is no longer the case.  This is why the expected result is</span>
                <span class="s6"># casted to the appropriate Python type (which is actually the</span>
                <span class="s6"># expected behavior of the ufunc translation)</span>
                <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inexact</span><span class="s2">):</span>
                    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">):</span>
                    <span class="s1">expected </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">):</span>
                    <span class="s1">expected </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>

            <span class="s1">alltypes </span><span class="s2">= </span><span class="s1">tyargs </span><span class="s2">+ (</span><span class="s1">cfunc</span><span class="s2">.</span><span class="s1">overloads</span><span class="s2">[</span><span class="s1">tyargs</span><span class="s2">].</span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">,)</span>

            <span class="s6"># select the appropriate precision for comparison: note that an</span>
            <span class="s6"># argument typed at a lower precision can introduce precision</span>
            <span class="s6"># problems. For this reason the argument types must be taken into</span>
            <span class="s6"># account.</span>
            <span class="s0">if </span><span class="s1">any</span><span class="s2">([</span><span class="s1">t </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32 </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">alltypes</span><span class="s2">]):</span>
                <span class="s1">prec </span><span class="s2">= </span><span class="s4">'single'</span>
            <span class="s0">elif </span><span class="s1">any</span><span class="s2">([</span><span class="s1">t </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64 </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">alltypes</span><span class="s2">]):</span>
                <span class="s1">prec </span><span class="s2">= </span><span class="s4">'double'</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">prec </span><span class="s2">= </span><span class="s4">'exact'</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s1">prec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_scalar_unary_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">vals </span><span class="s2">= [(</span><span class="s3">2</span><span class="s2">,), (</span><span class="s3">2</span><span class="s2">,), (</span><span class="s3">1</span><span class="s2">,), (</span><span class="s3">2</span><span class="s2">,), (</span><span class="s3">.1</span><span class="s2">,), (</span><span class="s3">.2</span><span class="s2">,)]</span>
        <span class="s1">tys </span><span class="s2">= [(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">,), (</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">,),</span>
               <span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">,), (</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">,),</span>
               <span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">,), (</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">run_ufunc</span><span class="s2">(</span><span class="s1">_func</span><span class="s2">, </span><span class="s1">tys</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_scalar_binary_uniform_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">,</span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">,</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">vals </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">.1</span><span class="s2">, </span><span class="s3">.2</span><span class="s2">]</span>
        <span class="s1">tys </span><span class="s2">= [</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">,</span>
               <span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">run_ufunc</span><span class="s2">(</span><span class="s1">_func</span><span class="s2">, </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">tys</span><span class="s2">, </span><span class="s1">tys</span><span class="s2">), </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_scalar_binary_mixed_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">_func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">,</span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">,</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">vals </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">.1</span><span class="s2">, </span><span class="s3">.2</span><span class="s2">]</span>
        <span class="s1">tys </span><span class="s2">= [</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">,</span>
               <span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">,</span>
               <span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">run_ufunc</span><span class="s2">(</span><span class="s1">_func</span><span class="s2">, </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">tys</span><span class="s2">, </span><span class="s1">tys</span><span class="s2">),</span>
                       <span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestUfuncIssues</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_issue_651</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Exercise the code path to make sure this does not fail</span>
        <span class="s2">@</span><span class="s1">vectorize</span><span class="s2">([</span><span class="s4">&quot;(float64,float64)&quot;</span><span class="s2">])</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), (</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span><span class="s2">) + (</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_issue_2006</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        &lt;float32 ** int&gt; should return float32, not float64. 
        &quot;&quot;&quot;</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">foo</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
            <span class="s6"># Check the power operation conserved the input's dtype</span>
            <span class="s6"># (this is different from Numpy, whose behaviour depends on</span>
            <span class="s6">#  the *values* of the arguments -- see PyArray_CanCastArrayTo).</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">xs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">([</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">- </span><span class="s3">3j</span><span class="s2">])]</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">xs</span><span class="s2">:</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s3">3</span><span class="s2">))</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]))</span>


<span class="s0">class </span><span class="s1">_LoopTypesTester</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Test code generation for the different loop types defined by ufunc. 
 
    This test relies on class variables to configure the test. Subclasses 
    of this class can just override some of these variables to check other 
    ufuncs in a different compilation context. The variables supported are: 
 
    _funcs: the ufuncs to test 
    _skip_types: letter types that force skipping the loop when testing 
                 if present in the NumPy ufunc signature. 
    _supported_types: only test loops where all the types in the loop 
                      signature are in this collection. If unset, all. 
 
    Note that both, _skip_types and _supported_types must be met for a loop 
    to be tested. 
 
    The NumPy ufunc signature has a form like 'ff-&gt;f' (for a binary ufunc 
    loop taking 2 floats and resulting in a float). In a NumPy ufunc object 
    you can get a list of supported signatures by accessing the attribute 
    'types'. 
    &quot;&quot;&quot;</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'OegG'</span>

    <span class="s6"># Allowed deviation between Numpy and Numba results</span>
    <span class="s1">_ulps </span><span class="s2">= {(</span><span class="s4">'arccos'</span><span class="s2">, </span><span class="s4">'F'</span><span class="s2">): </span><span class="s3">2</span><span class="s2">,</span>
             <span class="s2">(</span><span class="s4">'arcsin'</span><span class="s2">, </span><span class="s4">'D'</span><span class="s2">): </span><span class="s3">4</span><span class="s2">,</span>
             <span class="s2">(</span><span class="s4">'arcsin'</span><span class="s2">, </span><span class="s4">'F'</span><span class="s2">): </span><span class="s3">4</span><span class="s2">,</span>
             <span class="s2">(</span><span class="s4">'log10'</span><span class="s2">, </span><span class="s4">'D'</span><span class="s2">): </span><span class="s3">5</span><span class="s2">,</span>
             <span class="s2">(</span><span class="s4">'tanh'</span><span class="s2">, </span><span class="s4">'F'</span><span class="s2">): </span><span class="s3">2</span><span class="s2">,</span>
             <span class="s2">(</span><span class="s4">'cbrt'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">): </span><span class="s3">2</span><span class="s2">,</span>
             <span class="s2">(</span><span class="s4">'logaddexp2'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">): </span><span class="s3">2</span><span class="s2">,</span>
             <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a_letter_type</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;return a suitable array argument for testing the letter type&quot;&quot;&quot;</span>
        <span class="s6"># Note all possible arrays must have the same size, since they</span>
        <span class="s6"># may be used as inputs to the same func.</span>
        <span class="s0">if </span><span class="s1">a_letter_type </span><span class="s0">in </span><span class="s4">'bhilq'</span><span class="s2">:</span>
            <span class="s6"># an integral</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_letter_type</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">a_letter_type </span><span class="s0">in </span><span class="s4">'BHILQ'</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_letter_type</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">a_letter_type </span><span class="s0">in </span><span class="s4">'?'</span><span class="s2">:</span>
            <span class="s6"># a boolean</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_letter_type</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">a_letter_type</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s4">'m'</span><span class="s2">:</span>
            <span class="s6"># timedelta64</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">a_letter_type</span><span class="s2">) == </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">a_letter_type </span><span class="s2">= </span><span class="s4">'m8[D]'</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, </span><span class="s4">'NaT'</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_letter_type</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">a_letter_type</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s4">'M'</span><span class="s2">:</span>
            <span class="s6"># datetime64</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">a_letter_type</span><span class="s2">) == </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">a_letter_type </span><span class="s2">= </span><span class="s4">'M8[D]'</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'Nat'</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">25</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_letter_type</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">a_letter_type </span><span class="s0">in </span><span class="s4">'fd'</span><span class="s2">:</span>
            <span class="s6"># floating point</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.5</span><span class="s2">, -</span><span class="s3">3.5</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s4">'nan'</span><span class="s2">)],</span>
                            <span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_letter_type</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">a_letter_type </span><span class="s0">in </span><span class="s4">'FD'</span><span class="s2">:</span>
            <span class="s6"># complex</span>
            <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s4">'win32'</span><span class="s2">:</span>
                <span class="s6"># Other platforms have better handling of negative zeros,</span>
                <span class="s6"># test them</span>
                <span class="s1">negzero </span><span class="s2">= -(</span><span class="s3">0.0 </span><span class="s2">+ </span><span class="s3">1.0j</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">negzero </span><span class="s2">= </span><span class="s3">0.0 </span><span class="s2">- </span><span class="s3">1.0j</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">negzero</span><span class="s2">, </span><span class="s3">1.5 </span><span class="s2">+ </span><span class="s3">1.5j</span><span class="s2">, </span><span class="s3">1j </span><span class="s2">* </span><span class="s1">float</span><span class="s2">(</span><span class="s4">'nan'</span><span class="s2">), </span><span class="s3">0j</span><span class="s2">],</span>
                            <span class="s1">dtype</span><span class="s2">=</span><span class="s1">a_letter_type</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;type %r not understood&quot; </span><span class="s2">% (</span><span class="s1">a_letter_type</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">_check_loop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">loop</span><span class="s2">):</span>
        <span class="s6"># the letter types for the args</span>
        <span class="s1">letter_types </span><span class="s2">= </span><span class="s1">loop</span><span class="s2">[:</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nin</span><span class="s2">] + </span><span class="s1">loop</span><span class="s2">[-</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nout</span><span class="s2">:]</span>

        <span class="s6"># ignore the loops containing an object argument. They will always</span>
        <span class="s6"># fail in no python mode. Usually the last loop in ufuncs is an all</span>
        <span class="s6"># object fallback</span>
        <span class="s1">supported_types </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'_supported_types'</span><span class="s2">, [])</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">supported_types </span><span class="s0">and</span>
                <span class="s1">any</span><span class="s2">(</span><span class="s1">l </span><span class="s0">not in </span><span class="s1">supported_types </span><span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">letter_types</span><span class="s2">)):</span>
            <span class="s0">return</span>
        <span class="s1">skip_types </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'_skip_types'</span><span class="s2">, [])</span>
        <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">l </span><span class="s0">in </span><span class="s1">skip_types </span><span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">letter_types</span><span class="s2">):</span>
            <span class="s0">return</span>
        <span class="s6"># if the test case requires some types to be present, skip loops</span>
        <span class="s6"># not involving any of those types.</span>
        <span class="s1">required_types </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'_required_types'</span><span class="s2">, [])</span>
        <span class="s0">if </span><span class="s1">required_types </span><span class="s0">and not </span><span class="s1">any</span><span class="s2">(</span><span class="s1">l </span><span class="s0">in </span><span class="s1">letter_types</span>
                                      <span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">required_types</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">letter_types</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">dtypes</span><span class="s2">):</span>
        <span class="s6"># Arrays created with datetime and timedelta types (e.g. with np.array)</span>
        <span class="s6"># will have units, so in order to ensure that the dtypes of arguments</span>
        <span class="s6"># match the dtypes in the signature, we add units to unitless datetime</span>
        <span class="s6"># and timedelta types. This corresponds with the addition of units in</span>
        <span class="s6"># _arg_for_type() above.</span>
        <span class="s1">dtypes_with_units </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">t </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'m'</span><span class="s2">, </span><span class="s4">'M'</span><span class="s2">):</span>
                <span class="s1">t </span><span class="s2">= </span><span class="s1">t </span><span class="s2">+ </span><span class="s4">'8[D]'</span>
            <span class="s1">dtypes_with_units</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

        <span class="s1">arg_dty </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">dtypes_with_units</span><span class="s2">]</span>
        <span class="s1">arg_nbty </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">([</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">from_dtype</span><span class="s2">(</span><span class="s1">t</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">arg_dty</span><span class="s2">])</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">(</span><span class="s1">arg_nbty</span><span class="s2">)(</span><span class="s1">fn</span><span class="s2">)</span>

        <span class="s6"># Ensure a good mix of input values</span>
        <span class="s1">c_args </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">).</span><span class="s1">repeat</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
                  <span class="s0">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">t </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">dtypes</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">c_args</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">py_args </span><span class="s2">= [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">c_args</span><span class="s2">]</span>

        <span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">c_args</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">(*</span><span class="s1">py_args</span><span class="s2">)</span>

        <span class="s6"># Check each array (including inputs, to ensure they weren't</span>
        <span class="s6"># mutated).</span>
        <span class="s0">for </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">arg_dty</span><span class="s2">, </span><span class="s1">py_args</span><span class="s2">, </span><span class="s1">c_args</span><span class="s2">):</span>
            <span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_fixup_results</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg</span><span class="s2">)</span>
            <span class="s1">typechar </span><span class="s2">= </span><span class="s1">c_arg</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span>
            <span class="s1">ulps </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ulps</span><span class="s2">.</span><span class="s1">get</span><span class="s2">((</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">typechar</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">prec </span><span class="s2">= </span><span class="s4">'single' </span><span class="s0">if </span><span class="s1">typechar </span><span class="s0">in </span><span class="s4">'fF' </span><span class="s0">else </span><span class="s4">'exact'</span>
            <span class="s1">prec </span><span class="s2">= </span><span class="s4">'double' </span><span class="s0">if </span><span class="s1">typechar </span><span class="s0">in </span><span class="s4">'dD' </span><span class="s0">else </span><span class="s1">prec</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">'</span><span class="s0">\n</span><span class="s4">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s4">&quot;ufunc '{0}' arrays differ ({1}):&quot;</span><span class="s2">,</span>
                             <span class="s4">&quot;args: {2}&quot;</span><span class="s2">, </span><span class="s4">&quot;expected {3}&quot;</span><span class="s2">, </span><span class="s4">&quot;got {4}&quot;</span><span class="s2">])</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">msg</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">c_args</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">, </span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg</span><span class="s2">, </span><span class="s1">prec</span><span class="s2">=</span><span class="s1">prec</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">,</span>
                                    <span class="s1">ulps</span><span class="s2">=</span><span class="s1">ulps</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_fixup_results</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">_check_ufunc_loops</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">loop </span><span class="s0">in </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">types</span><span class="s2">:</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_inject_test</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">loop</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">_inject_test</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">loop</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">test_template</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_loop</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">loop</span><span class="s2">)</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s4">&quot;test_{0}_{1}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                           <span class="s1">loop</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">'-&gt;'</span><span class="s2">, </span><span class="s4">'_'</span><span class="s2">)),</span>
                <span class="s1">test_template</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">autogenerate</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_ufuncs</span><span class="s2">:</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_check_ufunc_loops</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLoopTypesInt</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= </span><span class="s1">supported_ufuncs</span><span class="s2">[:]</span>
    <span class="s6"># reciprocal and power need a special test due to issue #757</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">)</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">reciprocal</span><span class="s2">)</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">left_shift</span><span class="s2">) </span><span class="s6"># has its own test class</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">right_shift</span><span class="s2">) </span><span class="s6"># has its own test class</span>
    <span class="s6"># special test for bool subtract/negative</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">subtract</span><span class="s2">)</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">)</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'?bBhHiIlLqQ'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'fdFDmMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>


<span class="s1">TestLoopTypesInt</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesSubtractAndNegative</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">subtract</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">]</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'?bBhHiIlLqQfdFD'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'mMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types </span><span class="s2">+ </span><span class="s4">'?'</span>


<span class="s1">TestLoopTypesSubtractAndNegative</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesReciprocal</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">reciprocal</span><span class="s2">] </span><span class="s6"># issue #757</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'bBhHiIlLqQfdFD'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'mMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>

    <span class="s0">def </span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a_letter_type</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">a_letter_type</span><span class="s2">,</span>
                                                        <span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">a_letter_type </span><span class="s0">in </span><span class="s4">'bBhHiIlLqQ'</span><span class="s2">:</span>
            <span class="s6"># For integer reciprocal, avoid 0 as argument, as it triggers</span>
            <span class="s6"># undefined behavior that may differ in results from Numba</span>
            <span class="s6"># to the compiler used to compile NumPy.</span>
            <span class="s1">res</span><span class="s2">[</span><span class="s1">res </span><span class="s2">== </span><span class="s3">0</span><span class="s2">] = </span><span class="s3">42</span>
        <span class="s0">return </span><span class="s1">res</span>


<span class="s1">TestLoopTypesReciprocal</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesPower</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">] </span><span class="s6"># issue #757</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'bBhHiIlLqQfdFD'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'mMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>

    <span class="s0">def </span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a_letter_type</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">a_letter_type</span><span class="s2">,</span>
                                                        <span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">a_letter_type </span><span class="s0">in </span><span class="s4">'bBhHiIlLqQ' </span><span class="s0">and </span><span class="s1">index </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s6"># For integer power, avoid a negative exponent, as it triggers</span>
            <span class="s6"># undefined behavior that may differ in results from Numba</span>
            <span class="s6"># to the compiler used to compile NumPy</span>
            <span class="s1">res</span><span class="s2">[</span><span class="s1">res </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">] = </span><span class="s3">3</span>
        <span class="s0">return </span><span class="s1">res</span>


<span class="s1">TestLoopTypesPower</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesIntLeftShift</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">left_shift</span><span class="s2">]</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'bBhHiIlLqQ'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'fdFDmMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>

    <span class="s0">def </span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a_letter_type</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">a_letter_type</span><span class="s2">,</span>
                                                        <span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s6"># Shifting by a negative amount (argument with index 1) is undefined</span>
        <span class="s6"># behavior in C. It is also undefined behavior in numba. In the same</span>
        <span class="s6"># sense, it is also undefined behavior when the shift amount is larger</span>
        <span class="s6"># than the number of bits in the shifted integer.</span>
        <span class="s6"># To avoid problems in the test, the values are clamped (clipped) so</span>
        <span class="s6"># that 0 &lt;= shift_amount &lt; bitcount(shifted_integer)</span>
        <span class="s0">if </span><span class="s1">index </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">bit_count </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize </span><span class="s2">* </span><span class="s3">8</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clip</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">bit_count </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span>


<span class="s1">TestLoopTypesIntLeftShift</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesIntRightShift</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">right_shift</span><span class="s2">]</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'bBhHiIlLqQ'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'fdFDmMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>

    <span class="s0">def </span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a_letter_type</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">_arg_for_type</span><span class="s2">(</span><span class="s1">a_letter_type</span><span class="s2">,</span>
                                                        <span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s6"># Shifting by a negative amount (argument with index 1) is undefined</span>
        <span class="s6"># behavior in C. It is also undefined behavior in numba. In the same</span>
        <span class="s6"># sense, it is also undefined behavior when the shift amount is larger</span>
        <span class="s6"># than the number of bits in the shifted integer.</span>
        <span class="s6"># To avoid problems in the test, the values are clamped (clipped) so</span>
        <span class="s6"># that 0 &lt;= shift_amount &lt; bitcount(shifted_integer)</span>
        <span class="s0">if </span><span class="s1">index </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">bit_count </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize </span><span class="s2">* </span><span class="s3">8</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clip</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">bit_count </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s6"># Right shift has &quot;implementation defined behavior&quot; when the number</span>
        <span class="s6"># shifted is negative (in C). In numba, right shift for signed integers</span>
        <span class="s6"># is &quot;arithmetic&quot; while for unsigned integers is &quot;logical&quot;.</span>
        <span class="s6"># This test compares against the NumPy implementation, that relies</span>
        <span class="s6"># on &quot;implementation defined behavior&quot;, so the test could be a false</span>
        <span class="s6"># failure if the compiler used to compile NumPy doesn't follow the same</span>
        <span class="s6"># policy.</span>
        <span class="s6"># Hint: do not rely on right shifting negative numbers in NumPy.</span>
        <span class="s0">if </span><span class="s1">index </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span>


<span class="s1">TestLoopTypesIntRightShift</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesFloorDivide</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">]</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'bBhHiIlLqQfdFD'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'mMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>

    <span class="s0">def </span><span class="s1">_fixup_results</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s4">'f'</span><span class="s2">:</span>
            <span class="s6"># Discrepancies on floating-point floor division and remainder:</span>
            <span class="s6"># Numpy may return nan where Numba returns inf, e.g. 1. // 0.</span>
            <span class="s1">pred </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">c_arg</span><span class="s2">) &amp; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">py_arg</span><span class="s2">))</span>
            <span class="s6"># Numpy and Numba may differ in signed zeros, e.g. -0. // -1.</span>
            <span class="s1">pred </span><span class="s2">|= (</span><span class="s1">py_arg </span><span class="s2">== </span><span class="s3">0.0</span><span class="s2">) &amp; (</span><span class="s1">c_arg </span><span class="s2">== </span><span class="s3">0.0</span><span class="s2">)</span>
            <span class="s1">c_arg</span><span class="s2">[</span><span class="s1">pred</span><span class="s2">] = </span><span class="s1">py_arg</span><span class="s2">[</span><span class="s1">pred</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">py_arg</span><span class="s2">, </span><span class="s1">c_arg</span>


<span class="s1">TestLoopTypesFloorDivide</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesFloat</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= </span><span class="s1">supported_ufuncs</span><span class="s2">[:]</span>
    <span class="s0">if </span><span class="s1">iswindows</span><span class="s2">:</span>
        <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">) </span><span class="s6"># TODO: fix issue #758</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">) </span><span class="s6"># has its own test class</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">) </span><span class="s6"># has its own test class</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">) </span><span class="s6"># has its own test class</span>
    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mod</span><span class="s2">) </span><span class="s6"># same as np.remainder</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'fd'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'FDmMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>


<span class="s1">TestLoopTypesFloat</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestLoopTypesComplex</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= </span><span class="s1">supported_ufuncs</span><span class="s2">[:]</span>

    <span class="s6"># Test complex types</span>
    <span class="s6"># Every loop containing a complex argument must be tested</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'FD'</span>
    <span class="s1">_skip_types </span><span class="s2">= </span><span class="s4">'mMO' </span><span class="s2">+ </span><span class="s1">_LoopTypesTester</span><span class="s2">.</span><span class="s1">_skip_types</span>


<span class="s1">TestLoopTypesComplex</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>
<span class="s1">expected_failure_np2</span><span class="s2">(</span><span class="s1">TestLoopTypesComplex</span><span class="s2">.</span><span class="s1">test_sign_F_F</span><span class="s2">)</span>
<span class="s1">expected_failure_np2</span><span class="s2">(</span><span class="s1">TestLoopTypesComplex</span><span class="s2">.</span><span class="s1">test_sign_D_D</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLoopTypesDatetime</span><span class="s2">(</span><span class="s1">_LoopTypesTester</span><span class="s2">):</span>
    <span class="s1">_ufuncs </span><span class="s2">= </span><span class="s1">supported_ufuncs</span><span class="s2">[:]</span>

    <span class="s1">_ufuncs</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">)  </span><span class="s6"># not implemented yet</span>

    <span class="s6"># NOTE: the full list of ufuncs supporting datetime64 and timedelta64</span>
    <span class="s6"># types in Numpy is:</span>
    <span class="s6"># ['absolute', 'add', 'divide', 'equal', 'floor_divide', 'fmax', 'fmin',</span>
    <span class="s6">#  'greater', 'greater_equal', 'less', 'less_equal', 'maximum',</span>
    <span class="s6">#  'minimum', 'multiply', 'negative', 'not_equal', 'sign', 'subtract',</span>
    <span class="s6">#  'true_divide']</span>

    <span class="s6"># Test datetime64 and timedelta64 types.</span>
    <span class="s1">_required_types </span><span class="s2">= </span><span class="s4">'mM'</span>

    <span class="s6"># Test various units combinations (TestLoopTypes is only able to test</span>
    <span class="s6"># homogeneous units).</span>

    <span class="s0">def </span><span class="s1">test_add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
        <span class="s6"># heterogeneous inputs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s6"># heterogeneous inputs, scaled output</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'m8[ms]'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[ms]'</span><span class="s2">])</span>
        <span class="s6"># Cannot upscale result (Numpy would accept this)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">LoweringError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">,</span>
                                          <span class="s2">[</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_subtract</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">subtract</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
        <span class="s6"># heterogeneous inputs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'M8[s]'</span><span class="s2">, </span><span class="s4">'M8[m]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'M8[m]'</span><span class="s2">, </span><span class="s4">'M8[s]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s6"># heterogeneous inputs, scaled output</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'M8[s]'</span><span class="s2">, </span><span class="s4">'M8[m]'</span><span class="s2">, </span><span class="s4">'m8[ms]'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'M8[m]'</span><span class="s2">, </span><span class="s4">'M8[s]'</span><span class="s2">, </span><span class="s4">'m8[ms]'</span><span class="s2">])</span>
        <span class="s6"># Cannot upscale result (Numpy would accept this)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">LoweringError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">,</span>
                                          <span class="s2">[</span><span class="s4">'M8[m]'</span><span class="s2">, </span><span class="s4">'M8[s]'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_multiply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
        <span class="s6"># scaled output</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'q'</span><span class="s2">, </span><span class="s4">'m8[us]'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'q'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[us]'</span><span class="s2">])</span>
        <span class="s6"># Cannot upscale result (Numpy would accept this)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">LoweringError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'q'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_true_divide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">true_divide</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
        <span class="s6"># heterogeneous inputs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">])</span>
        <span class="s6"># scaled output</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'q'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s6"># Cannot upscale result (Numpy would accept this)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">LoweringError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'q'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_floor_divide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
        <span class="s6"># scaled output</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'q'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">])</span>
        <span class="s6"># Cannot upscale result (Numpy would accept this)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">LoweringError</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'q'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">_check_comparison</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">):</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">_make_ufunc_usecase</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>
        <span class="s6"># timedelta</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'?'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'m8[s]'</span><span class="s2">, </span><span class="s4">'m8[m]'</span><span class="s2">, </span><span class="s4">'?'</span><span class="s2">])</span>
        <span class="s6"># datetime</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'M8[m]'</span><span class="s2">, </span><span class="s4">'M8[s]'</span><span class="s2">, </span><span class="s4">'?'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ufunc_with_dtypes</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, [</span><span class="s4">'M8[s]'</span><span class="s2">, </span><span class="s4">'M8[m]'</span><span class="s2">, </span><span class="s4">'?'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_comparisons</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less_equal</span><span class="s2">,</span>
                      <span class="s1">np</span><span class="s2">.</span><span class="s1">greater</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater_equal</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_comparison</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">)</span>


<span class="s1">TestLoopTypesDatetime</span><span class="s2">.</span><span class="s1">autogenerate</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">TestUFuncBadArgs</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_missing_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s5">&quot;&quot;&quot;error: np.add requires two args&quot;&quot;&quot;</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">result</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">):</span>
            <span class="s1">njit</span><span class="s2">([</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)])(</span><span class="s1">func</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_too_many_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">, </span><span class="s1">out2</span><span class="s2">):</span>
            <span class="s5">&quot;&quot;&quot;error: too many args&quot;&quot;&quot;</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">, </span><span class="s1">out2</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">result</span>

        <span class="s1">array_type </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">)</span>
        <span class="s1">sig </span><span class="s2">= </span><span class="s1">array_type</span><span class="s2">(</span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">):</span>
            <span class="s1">njit</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">)(</span><span class="s1">func</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_no_scalar_result_by_reference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s5">&quot;&quot;&quot;error: scalar as a return value is not supported&quot;&quot;&quot;</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">):</span>
            <span class="s1">njit</span><span class="s2">([</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)])(</span><span class="s1">func</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestUFuncCompilationThreadSafety</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_lock</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; 
        Test that (lazy) compiling from several threads at once doesn't 
        produce errors (see issue #2403). 
        &quot;&quot;&quot;</span>
        <span class="s1">errors </span><span class="s2">= []</span>

        <span class="s2">@</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">x </span><span class="s2">+ </span><span class="s3">1</span>

        <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">():</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">10</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">10</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">) + </span><span class="s3">1.</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s1">errors</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>

        <span class="s1">threads </span><span class="s2">= [</span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Thread</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">wrapper</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">16</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">threads</span><span class="s2">:</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">threads</span><span class="s2">:</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">join</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertFalse</span><span class="s2">(</span><span class="s1">errors</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestUfuncOnContext</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_cpu_get_ufunc_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># The CPU context defines get_ufunc_info that is the same as</span>
        <span class="s6"># ufunc_db.get_ufunc_info.</span>
        <span class="s1">targetctx </span><span class="s2">= </span><span class="s1">cpu_target</span><span class="s2">.</span><span class="s1">target_context</span>
        <span class="s6"># Check: get_ufunc_info returns a dict</span>
        <span class="s1">add_info </span><span class="s2">= </span><span class="s1">targetctx</span><span class="s2">.</span><span class="s1">get_ufunc_info</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">add_info</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">)</span>
        <span class="s6"># Check: it is the same as ufunc_db.get_ufunc_info</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">ufunc_db</span><span class="s2">.</span><span class="s1">get_ufunc_info</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">add_info</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
        <span class="s6"># Check: KeyError raised on bad key</span>
        <span class="s1">badkey </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">ufunc_db</span><span class="s2">.</span><span class="s1">get_ufunc_info</span><span class="s2">(</span><span class="s1">badkey</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, (</span><span class="s1">badkey</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_base_get_ufunc_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># The BaseContext always raises NotImplementedError</span>
        <span class="s1">targetctx </span><span class="s2">= </span><span class="s1">BaseContext</span><span class="s2">(</span><span class="s1">cpu_target</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">, </span><span class="s4">'cpu'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">targetctx</span><span class="s2">.</span><span class="s1">get_ufunc_info</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRegex</span><span class="s2">(</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">),</span>
            <span class="s4">r&quot;&lt;numba\..*\.BaseContext object at .*&gt; does not support ufunc&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestUfuncWriteInput</span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_write_input_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s4">&quot;void(float64[:], uint8[:])&quot;</span><span class="s2">], </span><span class="s4">&quot;(n)-&gt;(n)&quot;</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">):</span>

            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                <span class="s6"># set every fourth element to 1</span>
                <span class="s0">if </span><span class="s1">i </span><span class="s2">% </span><span class="s3">4 </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">out</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s3">1</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>

        <span class="s1">func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">),</span>
            <span class="s1">out</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s4">'__main__'</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>