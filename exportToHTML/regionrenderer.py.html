<html>
<head>
<title>regionrenderer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
regionrenderer.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Graph rendering code is hard to test. Error messages from graphviz is not very 
useful in debugging. This file defines ``GraphBacking`` class to isolate graph 
building for visualization vs actual rendering the graph using graphviz. 
In ``GraphBacking``, we can easily verify the graph structure and produce 
better errors. 
 
The ``RVSDGRenderer`` class contains logic to convert a RVSDG into 
``GraphBacking``. To produce a graphviz output, use ``to_graphviz`` on the 
``GraphBacking``. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">abc</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span>
<span class="s2">from </span><span class="s1">dataclasses </span><span class="s2">import </span><span class="s1">dataclass</span><span class="s3">, </span><span class="s1">replace</span><span class="s3">, </span><span class="s1">field</span>
<span class="s2">from </span><span class="s1">contextlib </span><span class="s2">import </span><span class="s1">contextmanager</span>
<span class="s2">from </span><span class="s1">collections </span><span class="s2">import </span><span class="s1">defaultdict</span>

<span class="s2">from </span><span class="s1">numba_rvsdg</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">datastructures</span><span class="s3">.</span><span class="s1">basic_block </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">BasicBlock</span><span class="s3">,</span>
    <span class="s1">RegionBlock</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">numba_rvsdg</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">datastructures</span><span class="s3">.</span><span class="s1">scfg </span><span class="s2">import </span><span class="s1">SCFG</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">regionpasses </span><span class="s2">import </span><span class="s1">RegionVisitor</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">bc2rvsdg </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">DDGBlock</span><span class="s3">,</span>
    <span class="s1">DDGControlVariable</span><span class="s3">,</span>
    <span class="s1">DDGBranch</span><span class="s3">,</span>
    <span class="s1">DDGProtocol</span><span class="s3">,</span>
<span class="s3">)</span>


<span class="s3">@</span><span class="s1">dataclass</span><span class="s3">(</span><span class="s1">frozen</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">GraphNode</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;A node in GraphBacking 
    &quot;&quot;&quot;</span>
    <span class="s1">kind</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">parent_regions</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, ...] = ()</span>
    <span class="s1">ports</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, ...] = ()</span>
    <span class="s1">data</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">] = </span><span class="s1">field</span><span class="s3">(</span><span class="s1">default_factory</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">dataclass</span><span class="s3">(</span><span class="s1">frozen</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">GraphEdge</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;An edge in GraphBacking 
    &quot;&quot;&quot;</span>
    <span class="s1">src</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">dst</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">src_port</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">dst_port</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">headlabel</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">taillabel</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">kind</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>


<span class="s3">@</span><span class="s1">dataclass</span><span class="s3">(</span><span class="s1">frozen</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">GraphGroup</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;A group in GraphBacking. 
 
    Note: this is called a &quot;group&quot; to avoid name collison with &quot;regions&quot; in 
    RVSDG and that the word &quot;group&quot; has less meaning as this is does not 
    imply any property. 
    &quot;&quot;&quot;</span>

    <span class="s1">subgroups</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s4">&quot;GraphGroup&quot;</span><span class="s3">]</span>
    <span class="s1">nodes</span><span class="s3">: </span><span class="s1">set</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">make</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">subgroups</span><span class="s3">=</span><span class="s1">defaultdict</span><span class="s3">(</span><span class="s1">GraphGroup</span><span class="s3">.</span><span class="s1">make</span><span class="s3">), </span><span class="s1">nodes</span><span class="s3">=</span><span class="s1">set</span><span class="s3">())</span>


<span class="s2">class </span><span class="s1">GraphBacking</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;An ADT for a graph with hierarchical grouping so it is suited for 
    representing regionalized flow graphs in SCFG. 
    &quot;&quot;&quot;</span>
    <span class="s1">_nodes</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">GraphNode</span><span class="s3">]</span>
    <span class="s1">_groups</span><span class="s3">: </span><span class="s1">GraphGroup</span>
    <span class="s1">_edges</span><span class="s3">: </span><span class="s1">set</span><span class="s3">[</span><span class="s1">GraphEdge</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_groups </span><span class="s3">= </span><span class="s1">GraphGroup</span><span class="s3">.</span><span class="s1">make</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_edges </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">node</span><span class="s3">: </span><span class="s1">GraphNode</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Add a graph node 
        &quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">name </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">node</span>

        <span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_groups</span>
        <span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">node</span><span class="s3">.</span><span class="s1">parent_regions</span><span class="s3">:</span>
            <span class="s1">group </span><span class="s3">= </span><span class="s1">group</span><span class="s3">.</span><span class="s1">subgroups</span><span class="s3">[</span><span class="s1">p</span><span class="s3">]</span>
        <span class="s1">group</span><span class="s3">.</span><span class="s1">nodes</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">add_edge</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">src</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Add a graph edge 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_edges</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">GraphEdge</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">verify</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Check graph structure. 
 
        * check for missing nodes 
        * check for missing ports 
        &quot;&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">edge </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_edges</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;missing node </span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src</span><span class="s2">!r}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;missing node </span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst</span><span class="s2">!r}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src_port </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes</span><span class="s3">[</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src_port </span><span class="s2">not in </span><span class="s1">node</span><span class="s3">.</span><span class="s1">ports</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                        <span class="s4">f&quot;missing port </span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src_port</span><span class="s2">!r} </span><span class="s4">in node </span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src</span><span class="s2">!r}</span><span class="s4">&quot;</span>
                    <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst_port </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes</span><span class="s3">[</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst_port </span><span class="s2">not in </span><span class="s1">node</span><span class="s3">.</span><span class="s1">ports</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                        <span class="s4">f&quot;missing port </span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst_port</span><span class="s2">!r} </span><span class="s4">in node </span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst</span><span class="s2">!r}</span><span class="s4">&quot;</span>
                    <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">render</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">renderer</span><span class="s3">: </span><span class="s4">&quot;AbstractRendererBackend&quot;</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Render this graph using the given backend. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_render_group</span><span class="s3">(</span><span class="s1">renderer</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_groups</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">edge </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_edges</span><span class="s3">:</span>
            <span class="s1">renderer</span><span class="s3">.</span><span class="s1">render_edge</span><span class="s3">(</span><span class="s1">edge</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_render_group</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">renderer</span><span class="s3">, </span><span class="s1">group</span><span class="s3">: </span><span class="s1">GraphGroup</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Recursively rendering the hierarchical groups 
        &quot;&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">subgroup </span><span class="s2">in </span><span class="s1">group</span><span class="s3">.</span><span class="s1">subgroups</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">with </span><span class="s1">renderer</span><span class="s3">.</span><span class="s1">render_cluster</span><span class="s3">(</span><span class="s1">k</span><span class="s3">) </span><span class="s2">as </span><span class="s1">subrenderer</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_render_group</span><span class="s3">(</span><span class="s1">subrenderer</span><span class="s3">, </span><span class="s1">subgroup</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">group</span><span class="s3">.</span><span class="s1">nodes</span><span class="s3">:</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_nodes</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
            <span class="s1">renderer</span><span class="s3">.</span><span class="s1">render_node</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">node</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">dataclass</span><span class="s3">(</span><span class="s1">frozen</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">GraphNodeMaker</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Helper for making GraphNode and keep tracks of the hierarchical 
    grouping. 
    &quot;&quot;&quot;</span>
    <span class="s1">parent_path</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, ...]</span>
    <span class="s4">&quot;&quot;&quot;The parent group path. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">subgroup</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Start a subgroup with the given name. 
        &quot;&quot;&quot;</span>
        <span class="s1">cls </span><span class="s3">= </span><span class="s1">type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">parent_path</span><span class="s3">=(*</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent_path</span><span class="s3">, </span><span class="s1">name</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">make_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s1">-&gt; GraphNode</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Make a new node 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">GraphNode</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">parent_regions</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent_path</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">dataclass</span><span class="s3">(</span><span class="s1">frozen</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">GraphBuilder</span><span class="s3">:</span>
    <span class="s1">graph</span><span class="s3">: </span><span class="s1">GraphBacking</span>
    <span class="s1">node_maker</span><span class="s3">: </span><span class="s1">GraphNodeMaker</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">make</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;GraphBuilder&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">GraphBacking</span><span class="s3">(), </span><span class="s1">GraphNodeMaker</span><span class="s3">(()))</span>


<span class="s2">class </span><span class="s1">AbstractRendererBackend</span><span class="s3">(</span><span class="s1">abc</span><span class="s3">.</span><span class="s1">ABC</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Base class for all renderer backend. 
    &quot;&quot;&quot;</span>
    <span class="s3">@</span><span class="s1">abc</span><span class="s3">.</span><span class="s1">abstractmethod</span>
    <span class="s2">def </span><span class="s1">render_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">node</span><span class="s3">: </span><span class="s1">GraphNode</span><span class="s3">):</span>
        <span class="s3">...</span>

    <span class="s3">@</span><span class="s1">abc</span><span class="s3">.</span><span class="s1">abstractmethod</span>
    <span class="s2">def </span><span class="s1">render_edge</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">edge</span><span class="s3">: </span><span class="s1">GraphEdge</span><span class="s3">):</span>
        <span class="s3">...</span>

    <span class="s3">@</span><span class="s1">contextmanager</span>
    <span class="s3">@</span><span class="s1">abc</span><span class="s3">.</span><span class="s1">abstractmethod</span>
    <span class="s2">def </span><span class="s1">render_cluster</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s3">...</span>


<span class="s2">class </span><span class="s1">GraphvizRendererBackend</span><span class="s3">(</span><span class="s1">AbstractRendererBackend</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;The backend for using graphviz to render a GraphBacking. 
    &quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">g</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">graphviz </span><span class="s2">import </span><span class="s1">Digraph</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph </span><span class="s3">= </span><span class="s1">Digraph</span><span class="s3">() </span><span class="s2">if </span><span class="s1">g </span><span class="s2">is None else </span><span class="s1">g</span>

    <span class="s2">def </span><span class="s1">render_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">node</span><span class="s3">: </span><span class="s1">GraphNode</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">node</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;valuestate&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">node</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">label</span><span class="s3">=</span><span class="s1">node</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s4">&quot;body&quot;</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=</span><span class="s4">&quot;rect&quot;</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">node</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;op&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">node</span><span class="s3">(</span>
                <span class="s1">k</span><span class="s3">, </span><span class="s1">label</span><span class="s3">=</span><span class="s1">node</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s4">&quot;body&quot;</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=</span><span class="s4">&quot;box&quot;</span><span class="s3">, </span><span class="s1">style</span><span class="s3">=</span><span class="s4">&quot;rounded&quot;</span>
            <span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">node</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;effect&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">node</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">label</span><span class="s3">=</span><span class="s1">node</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s4">&quot;body&quot;</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=</span><span class="s4">&quot;circle&quot;</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">node</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;meta&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">node</span><span class="s3">(</span>
                <span class="s1">k</span><span class="s3">, </span><span class="s1">label</span><span class="s3">=</span><span class="s1">node</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s4">&quot;body&quot;</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=</span><span class="s4">&quot;plain&quot;</span><span class="s3">, </span><span class="s1">fontcolor</span><span class="s3">=</span><span class="s4">&quot;grey&quot;</span>
            <span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">node</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;ports&quot;</span><span class="s3">:</span>
            <span class="s1">ports </span><span class="s3">= [</span><span class="s4">f&quot;&lt;</span><span class="s2">{</span><span class="s1">x</span><span class="s2">}</span><span class="s4">&gt; </span><span class="s2">{</span><span class="s1">x</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">node</span><span class="s3">.</span><span class="s1">ports</span><span class="s3">]</span>
            <span class="s1">label </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">node</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s4">'body'</span><span class="s3">]</span><span class="s2">} </span><span class="s4">| </span><span class="s2">{</span><span class="s4">'|'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">ports</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">node</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">label</span><span class="s3">=</span><span class="s1">label</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=</span><span class="s4">&quot;record&quot;</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">node</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;cfg&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">node</span><span class="s3">(</span>
                <span class="s1">k</span><span class="s3">, </span><span class="s1">label</span><span class="s3">=</span><span class="s1">node</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s4">&quot;body&quot;</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=</span><span class="s4">&quot;plain&quot;</span><span class="s3">, </span><span class="s1">fontcolor</span><span class="s3">=</span><span class="s4">&quot;blue&quot;</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">node</span><span class="s3">(</span>
                <span class="s1">k</span><span class="s3">,</span>
                <span class="s1">label</span><span class="s3">=</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">k</span><span class="s2">}\n{</span><span class="s1">node</span><span class="s3">.</span><span class="s1">kind</span><span class="s2">}\n{</span><span class="s1">node</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'body'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s1">shape</span><span class="s3">=</span><span class="s4">&quot;rect&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">render_edge</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">edge</span><span class="s3">: </span><span class="s1">GraphEdge</span><span class="s3">):</span>
        <span class="s1">attrs </span><span class="s3">= {}</span>
        <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">headlabel </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;headlabel&quot;</span><span class="s3">] = </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">headlabel</span>
        <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">taillabel </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;taillabel&quot;</span><span class="s3">] = </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">taillabel</span>

        <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">kind </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;effect&quot;</span><span class="s3">:</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;style&quot;</span><span class="s3">] = </span><span class="s4">&quot;dotted&quot;</span>
            <span class="s2">elif </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;meta&quot;</span><span class="s3">:</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;style&quot;</span><span class="s3">] = </span><span class="s4">&quot;invis&quot;</span>
            <span class="s2">elif </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;cfg&quot;</span><span class="s3">:</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;style&quot;</span><span class="s3">] = </span><span class="s4">&quot;solid&quot;</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;color&quot;</span><span class="s3">] = </span><span class="s4">&quot;blue&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">kind</span><span class="s3">)</span>

        <span class="s1">src </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src</span><span class="s3">)</span>
        <span class="s1">dst </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src_port</span><span class="s3">:</span>
            <span class="s1">src </span><span class="s3">+= </span><span class="s4">f&quot;:</span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">src_port</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s2">if </span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst_port</span><span class="s3">:</span>
            <span class="s1">dst </span><span class="s3">+= </span><span class="s4">f&quot;:</span><span class="s2">{</span><span class="s1">edge</span><span class="s3">.</span><span class="s1">dst_port</span><span class="s2">}</span><span class="s4">&quot;</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">edge</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">, **</span><span class="s1">attrs</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">contextmanager</span>
    <span class="s2">def </span><span class="s1">render_cluster</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">digraph</span><span class="s3">.</span><span class="s1">subgraph</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s4">f&quot;cluster_</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">subg</span><span class="s3">:</span>
            <span class="s1">attrs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">color</span><span class="s3">=</span><span class="s4">&quot;black&quot;</span><span class="s3">, </span><span class="s1">bgcolor</span><span class="s3">=</span><span class="s4">&quot;white&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;regionouter&quot;</span><span class="s3">):</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;bgcolor&quot;</span><span class="s3">] = </span><span class="s4">&quot;grey&quot;</span>
            <span class="s2">elif </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;loop_&quot;</span><span class="s3">):</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;color&quot;</span><span class="s3">] = </span><span class="s4">&quot;blue&quot;</span>
            <span class="s2">elif </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;switch_&quot;</span><span class="s3">):</span>
                <span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;color&quot;</span><span class="s3">] = </span><span class="s4">&quot;green&quot;</span>

            <span class="s1">subg</span><span class="s3">.</span><span class="s1">attr</span><span class="s3">(**</span><span class="s1">attrs</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s1">type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)(</span><span class="s1">subg</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">RVSDGRenderer</span><span class="s3">(</span><span class="s1">RegionVisitor</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Convert a RVSDG into a GraphBacking 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">visit_block</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">block</span><span class="s3">: </span><span class="s1">BasicBlock</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">: </span><span class="s1">GraphBuilder</span><span class="s3">):</span>
        <span class="s1">nodename </span><span class="s3">= </span><span class="s1">block</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">node_maker </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">subgroup</span><span class="s3">(</span><span class="s4">f&quot;metaregion_</span><span class="s2">{</span><span class="s1">nodename</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">block</span><span class="s3">, </span><span class="s1">DDGBlock</span><span class="s3">):</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">make_node</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;cfg&quot;</span><span class="s3">, </span><span class="s1">data</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">body</span><span class="s3">=</span><span class="s1">nodename</span><span class="s3">))</span>
            <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">nodename</span><span class="s3">, </span><span class="s1">node</span><span class="s3">)</span>
            <span class="s1">block</span><span class="s3">.</span><span class="s1">render_graph</span><span class="s3">(</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">node_maker</span><span class="s3">=</span><span class="s1">node_maker</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">body </span><span class="s3">= </span><span class="s4">&quot;(tbd)&quot;</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">block</span><span class="s3">, </span><span class="s1">DDGBranch</span><span class="s3">):</span>
                <span class="s1">body </span><span class="s3">= </span><span class="s4">f&quot;branch_value_table:</span><span class="s2">\n{</span><span class="s1">block</span><span class="s3">.</span><span class="s1">branch_value_table</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">block</span><span class="s3">, </span><span class="s1">DDGControlVariable</span><span class="s3">):</span>
                <span class="s1">body </span><span class="s3">= </span><span class="s4">f&quot;variable_assignment:</span><span class="s2">\n{</span><span class="s1">block</span><span class="s3">.</span><span class="s1">variable_assignment</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s1">node </span><span class="s3">= </span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">make_node</span><span class="s3">(</span>
                <span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;cfg&quot;</span><span class="s3">,</span>
                <span class="s1">data</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">body</span><span class="s3">=</span><span class="s1">body</span><span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">nodename</span><span class="s3">, </span><span class="s1">node</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">block</span><span class="s3">, </span><span class="s1">DDGProtocol</span><span class="s3">):</span>
                <span class="s5"># Insert incoming and outgoing</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_inout_ports</span><span class="s3">(</span>
                    <span class="s1">block</span><span class="s3">,</span>
                    <span class="s1">block</span><span class="s3">,</span>
                    <span class="s1">replace</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">node_maker</span><span class="s3">=</span><span class="s1">node_maker</span><span class="s3">),</span>
                <span class="s3">)</span>

        <span class="s2">for </span><span class="s1">dstnode </span><span class="s2">in </span><span class="s1">block</span><span class="s3">.</span><span class="s1">jump_targets</span><span class="s3">:</span>
            <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span><span class="s1">nodename</span><span class="s3">, </span><span class="s1">dstnode</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;cfg&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">builder</span>

    <span class="s2">def </span><span class="s1">_add_inout_ports</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">before_block</span><span class="s3">, </span><span class="s1">after_block</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">):</span>
        <span class="s5"># Make outgoing node</span>
        <span class="s1">outgoing_nodename </span><span class="s3">= </span><span class="s4">f&quot;outgoing_</span><span class="s2">{</span><span class="s1">before_block</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s1">outgoing_node </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">make_node</span><span class="s3">(</span>
            <span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;ports&quot;</span><span class="s3">,</span>
            <span class="s1">ports</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s1">before_block</span><span class="s3">.</span><span class="s1">outgoing_states</span><span class="s3">),</span>
            <span class="s1">data</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">body</span><span class="s3">=</span><span class="s4">&quot;outgoing&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">outgoing_nodename</span><span class="s3">, </span><span class="s1">outgoing_node</span><span class="s3">)</span>

        <span class="s5"># Make incoming node</span>
        <span class="s1">incoming_nodename </span><span class="s3">= </span><span class="s4">f&quot;incoming_</span><span class="s2">{</span><span class="s1">after_block</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s1">incoming_node </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">make_node</span><span class="s3">(</span>
            <span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;ports&quot;</span><span class="s3">,</span>
            <span class="s1">ports</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s1">after_block</span><span class="s3">.</span><span class="s1">incoming_states</span><span class="s3">),</span>
            <span class="s1">data</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">body</span><span class="s3">=</span><span class="s4">&quot;incoming&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">incoming_nodename</span><span class="s3">, </span><span class="s1">incoming_node</span><span class="s3">)</span>

        <span class="s5"># Add meta edge for implicit flow</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span>
            <span class="s1">incoming_nodename</span><span class="s3">, </span><span class="s1">outgoing_nodename</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;meta&quot;</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">visit_linear</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">region</span><span class="s3">: </span><span class="s1">RegionBlock</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">: </span><span class="s1">GraphBuilder</span><span class="s3">):</span>
        <span class="s1">nodename </span><span class="s3">= </span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">node_maker </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">subgroup</span><span class="s3">(</span><span class="s4">f&quot;regionouter_</span><span class="s2">{</span><span class="s1">nodename</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">DDGProtocol</span><span class="s3">):</span>
            <span class="s5"># Insert incoming and outgoing</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_inout_ports</span><span class="s3">(</span>
                <span class="s1">region</span><span class="s3">,</span>
                <span class="s1">region</span><span class="s3">,</span>
                <span class="s1">replace</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">node_maker</span><span class="s3">=</span><span class="s1">node_maker</span><span class="s3">),</span>
            <span class="s3">)</span>

        <span class="s1">subbuilder </span><span class="s3">= </span><span class="s1">replace</span><span class="s3">(</span>
            <span class="s1">builder</span><span class="s3">,</span>
            <span class="s1">node_maker</span><span class="s3">=</span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">subgroup</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">region</span><span class="s3">.</span><span class="s1">kind</span><span class="s2">}</span><span class="s4">_</span><span class="s2">{</span><span class="s1">nodename</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">node </span><span class="s3">= </span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">make_node</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;cfg&quot;</span><span class="s3">, </span><span class="s1">data</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">body</span><span class="s3">=</span><span class="s1">nodename</span><span class="s3">))</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">node</span><span class="s3">)</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">visit_linear</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">subbuilder</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_connect_internal</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">)</span>
        <span class="s5"># connect cfg edge</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">region</span><span class="s3">.</span><span class="s1">header</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;cfg&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">builder</span>

    <span class="s2">def </span><span class="s1">_connect_internal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">region</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">):</span>
        <span class="s1">header </span><span class="s3">= </span><span class="s1">region</span><span class="s3">.</span><span class="s1">subregion</span><span class="s3">[</span><span class="s1">region</span><span class="s3">.</span><span class="s1">header</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">DDGProtocol</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">header</span><span class="s3">, </span><span class="s1">DDGProtocol</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">region</span><span class="s3">.</span><span class="s1">incoming_states</span><span class="s3">:</span>
                <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span>
                    <span class="s4">f&quot;incoming_</span><span class="s2">{</span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s4">f&quot;incoming_</span><span class="s2">{</span><span class="s1">header</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s1">src_port</span><span class="s3">=</span><span class="s1">k</span><span class="s3">,</span>
                    <span class="s1">dst_port</span><span class="s3">=</span><span class="s1">k</span><span class="s3">,</span>
                <span class="s3">)</span>

        <span class="s1">exiting </span><span class="s3">= </span><span class="s1">region</span><span class="s3">.</span><span class="s1">subregion</span><span class="s3">[</span><span class="s1">region</span><span class="s3">.</span><span class="s1">exiting</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">DDGProtocol</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span>
            <span class="s1">exiting</span><span class="s3">, </span><span class="s1">DDGProtocol</span>
        <span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">RegionBlock</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">region</span><span class="s3">.</span><span class="s1">outgoing_states </span><span class="s3">&amp; </span><span class="s1">exiting</span><span class="s3">.</span><span class="s1">outgoing_states</span><span class="s3">:</span>
                <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span>
                    <span class="s4">f&quot;outgoing_</span><span class="s2">{</span><span class="s1">exiting</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s4">f&quot;outgoing_</span><span class="s2">{</span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s1">src_port</span><span class="s3">=</span><span class="s1">k</span><span class="s3">,</span>
                    <span class="s1">dst_port</span><span class="s3">=</span><span class="s1">k</span><span class="s3">,</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">visit_graph</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">scfg</span><span class="s3">: </span><span class="s1">SCFG</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Overriding&quot;&quot;&quot;</span>
        <span class="s1">toposorted </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_toposort_graph</span><span class="s3">(</span><span class="s1">scfg</span><span class="s3">)</span>
        <span class="s1">label</span><span class="s3">: </span><span class="s1">str</span>
        <span class="s1">last_label</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">lvl </span><span class="s2">in </span><span class="s1">toposorted</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">label </span><span class="s2">in </span><span class="s1">lvl</span><span class="s3">:</span>
                <span class="s1">builder </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">visit</span><span class="s3">(</span><span class="s1">scfg</span><span class="s3">[</span><span class="s1">label</span><span class="s3">], </span><span class="s1">builder</span><span class="s3">)</span>
                <span class="s5"># Connect outgoing to incoming</span>
                <span class="s2">if </span><span class="s1">last_label </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">last_node </span><span class="s3">= </span><span class="s1">scfg</span><span class="s3">[</span><span class="s1">last_label</span><span class="s3">]</span>
                    <span class="s1">node </span><span class="s3">= </span><span class="s1">scfg</span><span class="s3">[</span><span class="s1">label</span><span class="s3">]</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_connect_inout_ports</span><span class="s3">(</span><span class="s1">last_node</span><span class="s3">, </span><span class="s1">node</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">)</span>
                <span class="s1">last_label </span><span class="s3">= </span><span class="s1">label</span>
        <span class="s2">return </span><span class="s1">builder</span>

    <span class="s2">def </span><span class="s1">_connect_inout_ports</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">last_node</span><span class="s3">, </span><span class="s1">node</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">last_node</span><span class="s3">, </span><span class="s1">DDGProtocol</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span>
            <span class="s1">node</span><span class="s3">, </span><span class="s1">DDGProtocol</span>
        <span class="s3">):</span>
            <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">last_node</span><span class="s3">.</span><span class="s1">outgoing_states</span><span class="s3">:</span>
                <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span>
                    <span class="s4">f&quot;outgoing_</span><span class="s2">{</span><span class="s1">last_node</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s4">f&quot;incoming_</span><span class="s2">{</span><span class="s1">node</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s1">src_port</span><span class="s3">=</span><span class="s1">k</span><span class="s3">,</span>
                    <span class="s1">dst_port</span><span class="s3">=</span><span class="s1">k</span><span class="s3">,</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">visit_loop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">region</span><span class="s3">: </span><span class="s1">RegionBlock</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">: </span><span class="s1">GraphBuilder</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">visit_linear</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">visit_switch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">region</span><span class="s3">: </span><span class="s1">RegionBlock</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">: </span><span class="s1">GraphBuilder</span><span class="s3">):</span>
        <span class="s1">nodename </span><span class="s3">= </span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">node_maker </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">subgroup</span><span class="s3">(</span><span class="s4">f&quot;regionouter_</span><span class="s2">{</span><span class="s1">nodename</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">DDGProtocol</span><span class="s3">):</span>
            <span class="s5"># Insert incoming and outgoing</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_inout_ports</span><span class="s3">(</span>
                <span class="s1">region</span><span class="s3">,</span>
                <span class="s1">region</span><span class="s3">,</span>
                <span class="s1">replace</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">node_maker</span><span class="s3">=</span><span class="s1">node_maker</span><span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s1">subbuilder </span><span class="s3">= </span><span class="s1">replace</span><span class="s3">(</span>
            <span class="s1">builder</span><span class="s3">,</span>
            <span class="s1">node_maker</span><span class="s3">=</span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">subgroup</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">region</span><span class="s3">.</span><span class="s1">kind</span><span class="s2">}</span><span class="s4">_</span><span class="s2">{</span><span class="s1">nodename</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>

        <span class="s1">node </span><span class="s3">= </span><span class="s1">node_maker</span><span class="s3">.</span><span class="s1">make_node</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">=</span><span class="s4">&quot;cfg&quot;</span><span class="s3">, </span><span class="s1">data</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">body</span><span class="s3">=</span><span class="s1">nodename</span><span class="s3">))</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_node</span><span class="s3">(</span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">node</span><span class="s3">)</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">add_edge</span><span class="s3">(</span><span class="s1">region</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">region</span><span class="s3">.</span><span class="s1">header</span><span class="s3">)</span>

        <span class="s1">head </span><span class="s3">= </span><span class="s1">region</span><span class="s3">.</span><span class="s1">subregion</span><span class="s3">[</span><span class="s1">region</span><span class="s3">.</span><span class="s1">header</span><span class="s3">]</span>
        <span class="s1">tail </span><span class="s3">= </span><span class="s1">region</span><span class="s3">.</span><span class="s1">subregion</span><span class="s3">[</span><span class="s1">region</span><span class="s3">.</span><span class="s1">exiting</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">visit_linear</span><span class="s3">(</span><span class="s1">head</span><span class="s3">, </span><span class="s1">subbuilder</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">blk </span><span class="s2">in </span><span class="s1">region</span><span class="s3">.</span><span class="s1">subregion</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">blk</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;branch&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_connect_inout_ports</span><span class="s3">(</span><span class="s1">head</span><span class="s3">, </span><span class="s1">blk</span><span class="s3">, </span><span class="s1">subbuilder</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">visit_linear</span><span class="s3">(</span><span class="s1">blk</span><span class="s3">, </span><span class="s1">subbuilder</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_connect_inout_ports</span><span class="s3">(</span><span class="s1">blk</span><span class="s3">, </span><span class="s1">tail</span><span class="s3">, </span><span class="s1">subbuilder</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">visit_linear</span><span class="s3">(</span><span class="s1">tail</span><span class="s3">, </span><span class="s1">subbuilder</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_connect_internal</span><span class="s3">(</span><span class="s1">region</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">builder</span>

    <span class="s2">def </span><span class="s1">render</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rvsdg</span><span class="s3">: </span><span class="s1">SCFG</span><span class="s3">) </span><span class="s1">-&gt; GraphBacking</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Render a RVSDG into a GraphBacking 
        &quot;&quot;&quot;</span>
        <span class="s1">builder </span><span class="s3">= </span><span class="s1">GraphBuilder</span><span class="s3">.</span><span class="s1">make</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">visit_graph</span><span class="s3">(</span><span class="s1">rvsdg</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">)</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span><span class="s3">.</span><span class="s1">verify</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">graph</span>


<span class="s2">def </span><span class="s1">to_graphviz</span><span class="s3">(</span><span class="s1">graph</span><span class="s3">: </span><span class="s1">GraphBacking</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Render a GraphBacking using graphviz 
    &quot;&quot;&quot;</span>
    <span class="s1">rgr </span><span class="s3">= </span><span class="s1">GraphvizRendererBackend</span><span class="s3">()</span>
    <span class="s1">graph</span><span class="s3">.</span><span class="s1">render</span><span class="s3">(</span><span class="s1">rgr</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">rgr</span><span class="s3">.</span><span class="s1">digraph</span>
</pre>
</body>
</html>