<html>
<head>
<title>test_cuda_array_interface.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_cuda_array_interface.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">vectorize</span><span class="s2">, </span><span class="s1">guvectorize</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">cuda</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv </span><span class="s0">import </span><span class="s1">driver</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">unittest</span><span class="s2">, </span><span class="s1">ContextResettingTestCase</span><span class="s2">, </span><span class="s1">ForeignArray</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">skip_on_cudasim</span><span class="s2">, </span><span class="s1">skip_if_external_memmgr</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">support </span><span class="s0">import </span><span class="s1">linux_only</span><span class="s2">, </span><span class="s1">override_config</span>
<span class="s0">from </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">mock </span><span class="s0">import </span><span class="s1">call</span><span class="s2">, </span><span class="s1">patch</span>


<span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s3">'CUDA Array Interface is not supported in the simulator'</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestCudaArrayInterface</span><span class="s2">(</span><span class="s1">ContextResettingTestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">assertPointersEqual</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">driver</span><span class="s2">.</span><span class="s1">USE_NV_BINDING</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">device_ctypes_pointer</span><span class="s2">),</span>
                             <span class="s1">int</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">device_ctypes_pointer</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_as_cuda_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertFalse</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">is_cuda_array</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">))</span>
        <span class="s1">d_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">is_cuda_array</span><span class="s2">(</span><span class="s1">d_arr</span><span class="s2">))</span>
        <span class="s1">my_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">d_arr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">is_cuda_array</span><span class="s2">(</span><span class="s1">my_arr</span><span class="s2">))</span>
        <span class="s1">wrapped </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">my_arr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">is_cuda_array</span><span class="s2">(</span><span class="s1">wrapped</span><span class="s2">))</span>
        <span class="s5"># Their values must equal the original array</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">wrapped</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">d_arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s5"># d_arr and wrapped must be the same buffer</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPointersEqual</span><span class="s2">(</span><span class="s1">wrapped</span><span class="s2">, </span><span class="s1">d_arr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_stream_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">driver</span><span class="s2">.</span><span class="s1">USE_NV_BINDING</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">stream</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">.</span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">skip_if_external_memmgr</span><span class="s2">(</span><span class="s3">'Ownership not relevant with external memmgr'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_ownership</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Get the deallocation queue</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">current_context</span><span class="s2">()</span>
        <span class="s1">deallocs </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">memory_manager</span><span class="s2">.</span><span class="s1">deallocations</span>
        <span class="s5"># Flush all deallocations</span>
        <span class="s1">deallocs</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">deallocs</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s5"># Make new device array</span>
        <span class="s1">d_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">100</span><span class="s2">))</span>
        <span class="s5"># Convert it</span>
        <span class="s1">cvted </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">d_arr</span><span class="s2">)</span>
        <span class="s5"># Drop reference to the original object such that</span>
        <span class="s5"># only `cvted` has a reference to it.</span>
        <span class="s0">del </span><span class="s1">d_arr</span>
        <span class="s5"># There shouldn't be any new deallocations</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">deallocs</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s5"># Try to access the memory and verify its content</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">cvted</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">100</span><span class="s2">))</span>
        <span class="s5"># Drop last reference to the memory</span>
        <span class="s0">del </span><span class="s1">cvted</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">deallocs</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s5"># Flush</span>
        <span class="s1">deallocs</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_kernel_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">d_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s1">my_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">d_arr</span><span class="s2">)</span>
        <span class="s1">wrapped </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">my_arr</span><span class="s2">)</span>

        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">mutate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
                <span class="s0">return</span>
            <span class="s1">arr</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] += </span><span class="s1">val</span>

        <span class="s1">val </span><span class="s2">= </span><span class="s4">7</span>
        <span class="s1">mutate</span><span class="s2">.</span><span class="s1">forall</span><span class="s2">(</span><span class="s1">wrapped</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)(</span><span class="s1">wrapped</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">wrapped</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr </span><span class="s2">+ </span><span class="s1">val</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">d_arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr </span><span class="s2">+ </span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">vectorize</span><span class="s2">([</span><span class="s3">'f8(f8, f8)'</span><span class="s2">], </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">vadd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>

        <span class="s5"># Case 1: use custom array as argument</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">))</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s4">6</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">vadd</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr </span><span class="s2">+ </span><span class="s1">val</span><span class="s2">)</span>

        <span class="s5"># Case 2: use custom array as return</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s1">returned </span><span class="s2">= </span><span class="s1">vadd</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">returned</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr </span><span class="s2">+ </span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gufunc_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">guvectorize</span><span class="s2">([</span><span class="s3">'(f8, f8, f8[:])'</span><span class="s2">], </span><span class="s3">'(),()-&gt;()'</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">'cuda'</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">vadd</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">out</span><span class="s2">):</span>
            <span class="s1">out</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">inp </span><span class="s2">+ </span><span class="s1">val</span>

        <span class="s5"># Case 1: use custom array as argument</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">))</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s4">7</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">vadd</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr </span><span class="s2">+ </span><span class="s1">val</span><span class="s2">)</span>

        <span class="s5"># Case 2: use custom array as return</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s1">returned </span><span class="s2">= </span><span class="s1">vadd</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">returned</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr </span><span class="s2">+ </span><span class="s1">val</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPointersEqual</span><span class="s2">(</span><span class="s1">returned</span><span class="s2">, </span><span class="s1">out</span><span class="s2">.</span><span class="s1">_arr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Views created via array interface support: 
            - Strided slices 
            - Strided slices 
        &quot;&quot;&quot;</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">)</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">)</span>

        <span class="s5"># __getitem__ interface accesses expected data</span>

        <span class="s5"># Direct views</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[:].</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">)</span>

        <span class="s5"># Slicing</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[:</span><span class="s4">5</span><span class="s2">].</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">[:</span><span class="s4">5</span><span class="s2">])</span>

        <span class="s5"># Strided view</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">])</span>

        <span class="s5"># View of strided array</span>
        <span class="s1">arr_strided </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr_strided</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">])</span>

        <span class="s5"># A strided-view-of-array and view-of-strided-array have the same</span>
        <span class="s5"># shape, strides, itemsize, and alloc_size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">arr_strided</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, </span><span class="s1">arr_strided</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">, </span><span class="s1">arr_strided</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">alloc_size</span><span class="s2">, </span><span class="s1">arr_strided</span><span class="s2">.</span><span class="s1">alloc_size</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">nbytes</span><span class="s2">,</span>
                         <span class="s1">arr_strided</span><span class="s2">.</span><span class="s1">size </span><span class="s2">* </span><span class="s1">arr_strided</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">)</span>

        <span class="s5"># __setitem__ interface propagates into external array</span>

        <span class="s5"># Writes to a slice</span>
        <span class="s1">arr</span><span class="s2">[:</span><span class="s4">5</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">c_arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">), </span><span class="s1">h_arr</span><span class="s2">[</span><span class="s4">5</span><span class="s2">:]))</span>
        <span class="s2">)</span>

        <span class="s5"># Writes to a slice from a view</span>
        <span class="s1">arr</span><span class="s2">[:</span><span class="s4">5</span><span class="s2">] = </span><span class="s1">arr</span><span class="s2">[</span><span class="s4">5</span><span class="s2">:]</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">c_arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">h_arr</span><span class="s2">[</span><span class="s4">5</span><span class="s2">:], </span><span class="s1">h_arr</span><span class="s2">[</span><span class="s4">5</span><span class="s2">:]))</span>
        <span class="s2">)</span>

        <span class="s5"># Writes through a view</span>
        <span class="s1">arr</span><span class="s2">[:] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">(), </span><span class="s1">h_arr</span><span class="s2">)</span>

        <span class="s5"># Writes to a strided slice</span>
        <span class="s1">arr</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">c_arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">()[::</span><span class="s4">2</span><span class="s2">],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">c_arr</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">::</span><span class="s4">2</span><span class="s2">],</span>
            <span class="s1">h_arr</span><span class="s2">[</span><span class="s4">1</span><span class="s2">::</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_negative_strided_issue</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># issue #3705</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">base_offset</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">, </span><span class="s1">sliced</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">sliced</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">][</span><span class="s4">0</span><span class="s2">] - </span><span class="s1">orig</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]</span>

        <span class="s1">h_ai </span><span class="s2">= </span><span class="s1">h_arr</span><span class="s2">.</span><span class="s1">__array_interface__</span>
        <span class="s1">c_ai </span><span class="s2">= </span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span>

        <span class="s1">h_ai_sliced </span><span class="s2">= </span><span class="s1">h_arr</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">__array_interface__</span>
        <span class="s1">c_ai_sliced </span><span class="s2">= </span><span class="s1">c_arr</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">].</span><span class="s1">__cuda_array_interface__</span>

        <span class="s5"># Check data offset is correct</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span>
            <span class="s1">base_offset</span><span class="s2">(</span><span class="s1">h_ai</span><span class="s2">, </span><span class="s1">h_ai_sliced</span><span class="s2">),</span>
            <span class="s1">base_offset</span><span class="s2">(</span><span class="s1">c_ai</span><span class="s2">, </span><span class="s1">c_ai_sliced</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s5"># Check shape and strides are correct</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">h_ai_sliced</span><span class="s2">[</span><span class="s3">'shape'</span><span class="s2">], </span><span class="s1">c_ai_sliced</span><span class="s2">[</span><span class="s3">'shape'</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">h_ai_sliced</span><span class="s2">[</span><span class="s3">'strides'</span><span class="s2">], </span><span class="s1">c_ai_sliced</span><span class="s2">[</span><span class="s3">'strides'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_negative_strided_copy_to_host</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># issue #3705</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s1">sliced </span><span class="s2">= </span><span class="s1">c_arr</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">sliced</span><span class="s2">.</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">expected_msg </span><span class="s2">= </span><span class="s3">'D-&gt;H copy not implemented for negative strides'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s1">expected_msg</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_masked_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">h_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">h_mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'bool'</span><span class="s2">)</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_arr</span><span class="s2">)</span>
        <span class="s1">c_mask </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">h_mask</span><span class="s2">)</span>

        <span class="s5"># Manually create a masked CUDA Array Interface dictionary</span>
        <span class="s1">masked_cuda_array_interface </span><span class="s2">= </span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">masked_cuda_array_interface</span><span class="s2">[</span><span class="s3">'mask'</span><span class="s2">] = </span><span class="s1">c_mask</span>

        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">cuda</span><span class="s2">.</span><span class="s1">from_cuda_array_interface</span><span class="s2">(</span><span class="s1">masked_cuda_array_interface</span><span class="s2">)</span>
        <span class="s1">expected_msg </span><span class="s2">= </span><span class="s3">'Masked arrays are not supported'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s1">expected_msg</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_zero_size_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># for #4175</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">][</span><span class="s4">0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">)</span>

        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">add_one</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">N </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">N</span><span class="s2">:</span>
                <span class="s1">arr</span><span class="s2">[</span><span class="s1">x</span><span class="s2">] += </span><span class="s4">1</span>

        <span class="s1">d_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">)</span>
        <span class="s1">add_one</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">](</span><span class="s1">d_arr</span><span class="s2">)  </span><span class="s5"># this should pass</span>

    <span class="s0">def </span><span class="s1">test_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># for #4175</span>
        <span class="s5"># First, test C-contiguous array</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'strides'</span><span class="s2">], </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s5"># Second, test non C-contiguous array</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">c_arr</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">, :]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertNotEqual</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'strides'</span><span class="s2">], </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_consuming_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">hostarray </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">devarray </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">to_device</span><span class="s2">(</span><span class="s1">hostarray</span><span class="s2">)</span>
        <span class="s1">face </span><span class="s2">= </span><span class="s1">devarray</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsNone</span><span class="s2">(</span><span class="s1">face</span><span class="s2">[</span><span class="s3">'strides'</span><span class="s2">])</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">from_cuda_array_interface</span><span class="s2">(</span><span class="s1">face</span><span class="s2">).</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">hostarray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s3">'C_CONTIGUOUS'</span><span class="s2">])</span>
        <span class="s5"># Try non-NULL strides</span>
        <span class="s1">face</span><span class="s2">[</span><span class="s3">'strides'</span><span class="s2">] = </span><span class="s1">hostarray</span><span class="s2">.</span><span class="s1">strides</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsNotNone</span><span class="s2">(</span><span class="s1">face</span><span class="s2">[</span><span class="s3">'strides'</span><span class="s2">])</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">from_cuda_array_interface</span><span class="s2">(</span><span class="s1">face</span><span class="s2">).</span><span class="s1">copy_to_host</span><span class="s2">()</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">hostarray</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">[</span><span class="s3">'C_CONTIGUOUS'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_produce_no_stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsNone</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'stream'</span><span class="s2">])</span>

        <span class="s1">mapped_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">mapped_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsNone</span><span class="s2">(</span><span class="s1">mapped_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'stream'</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">linux_only</span>
    <span class="s0">def </span><span class="s1">test_produce_managed_no_stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">managed_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">managed_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsNone</span><span class="s2">(</span><span class="s1">managed_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'stream'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_produce_stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">cai_stream </span><span class="s2">= </span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'stream'</span><span class="s2">]</span>
        <span class="s1">stream_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_stream_value</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">stream_value</span><span class="s2">, </span><span class="s1">cai_stream</span><span class="s2">)</span>

        <span class="s1">s </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">mapped_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">mapped_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">cai_stream </span><span class="s2">= </span><span class="s1">mapped_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'stream'</span><span class="s2">]</span>
        <span class="s1">stream_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_stream_value</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">stream_value</span><span class="s2">, </span><span class="s1">cai_stream</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">linux_only</span>
    <span class="s0">def </span><span class="s1">test_produce_managed_stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">managed_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">managed_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">cai_stream </span><span class="s2">= </span><span class="s1">managed_arr</span><span class="s2">.</span><span class="s1">__cuda_array_interface__</span><span class="s2">[</span><span class="s3">'stream'</span><span class="s2">]</span>
        <span class="s1">stream_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_stream_value</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">stream_value</span><span class="s2">, </span><span class="s1">cai_stream</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_consume_no_stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create a foreign array with no stream</span>
        <span class="s1">f_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">))</span>

        <span class="s5"># Ensure that the imported array has no default stream</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">f_arr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_consume_stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create a foreign array with a stream</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">f_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s</span><span class="s2">))</span>

        <span class="s5"># Ensure that an imported array has the stream as its default stream</span>
        <span class="s1">c_arr </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">f_arr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">.</span><span class="s1">external</span><span class="s2">)</span>
        <span class="s1">stream_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_stream_value</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">imported_stream_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_stream_value</span><span class="s2">(</span><span class="s1">c_arr</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">stream_value</span><span class="s2">, </span><span class="s1">imported_stream_value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_consume_no_sync</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create a foreign array with no stream</span>
        <span class="s1">f_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv</span><span class="s2">.</span><span class="s1">driver</span><span class="s2">.</span><span class="s1">Stream</span><span class="s2">, </span><span class="s3">'synchronize'</span><span class="s2">,</span>
                          <span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sync</span><span class="s2">:</span>
            <span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">f_arr</span><span class="s2">)</span>

        <span class="s5"># Ensure the synchronize method of a stream was not called</span>
        <span class="s1">mock_sync</span><span class="s2">.</span><span class="s1">assert_not_called</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_consume_sync</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create a foreign array with a stream</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">f_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv</span><span class="s2">.</span><span class="s1">driver</span><span class="s2">.</span><span class="s1">Stream</span><span class="s2">, </span><span class="s3">'synchronize'</span><span class="s2">,</span>
                          <span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sync</span><span class="s2">:</span>
            <span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">f_arr</span><span class="s2">)</span>

        <span class="s5"># Ensure the synchronize method of a stream was called</span>
        <span class="s1">mock_sync</span><span class="s2">.</span><span class="s1">assert_called_once_with</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_consume_sync_disabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create a foreign array with a stream</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">f_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s</span><span class="s2">))</span>

        <span class="s5"># Set sync to false before testing. The test suite should generally be</span>
        <span class="s5"># run with sync enabled, but stash the old value just in case it is</span>
        <span class="s5"># not.</span>
        <span class="s0">with </span><span class="s1">override_config</span><span class="s2">(</span><span class="s3">'CUDA_ARRAY_INTERFACE_SYNC'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv</span><span class="s2">.</span><span class="s1">driver</span><span class="s2">.</span><span class="s1">Stream</span><span class="s2">, </span><span class="s3">'synchronize'</span><span class="s2">,</span>
                              <span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sync</span><span class="s2">:</span>
                <span class="s1">cuda</span><span class="s2">.</span><span class="s1">as_cuda_array</span><span class="s2">(</span><span class="s1">f_arr</span><span class="s2">)</span>

            <span class="s5"># Ensure the synchronize method of a stream was not called</span>
            <span class="s1">mock_sync</span><span class="s2">.</span><span class="s1">assert_not_called</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_launch_no_sync</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create a foreign array with no stream</span>
        <span class="s1">f_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">))</span>

        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv</span><span class="s2">.</span><span class="s1">driver</span><span class="s2">.</span><span class="s1">Stream</span><span class="s2">, </span><span class="s3">'synchronize'</span><span class="s2">,</span>
                          <span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sync</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">](</span><span class="s1">f_arr</span><span class="s2">)</span>

        <span class="s5"># Ensure the synchronize method of a stream was not called</span>
        <span class="s1">mock_sync</span><span class="s2">.</span><span class="s1">assert_not_called</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_launch_sync</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create a foreign array with a stream</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">f_arr </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s</span><span class="s2">))</span>

        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv</span><span class="s2">.</span><span class="s1">driver</span><span class="s2">.</span><span class="s1">Stream</span><span class="s2">, </span><span class="s3">'synchronize'</span><span class="s2">,</span>
                          <span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sync</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">](</span><span class="s1">f_arr</span><span class="s2">)</span>

        <span class="s5"># Ensure the synchronize method of a stream was called</span>
        <span class="s1">mock_sync</span><span class="s2">.</span><span class="s1">assert_called_once_with</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">test_launch_sync_two_streams</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create two foreign arrays with streams</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">f_arr1 </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s1</span><span class="s2">))</span>
        <span class="s1">f_arr2 </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s2</span><span class="s2">))</span>

        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv</span><span class="s2">.</span><span class="s1">driver</span><span class="s2">.</span><span class="s1">Stream</span><span class="s2">, </span><span class="s3">'synchronize'</span><span class="s2">,</span>
                          <span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sync</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">](</span><span class="s1">f_arr1</span><span class="s2">, </span><span class="s1">f_arr2</span><span class="s2">)</span>

        <span class="s5"># Ensure that synchronize was called twice</span>
        <span class="s1">mock_sync</span><span class="s2">.</span><span class="s1">assert_has_calls</span><span class="s2">([</span><span class="s1">call</span><span class="s2">(), </span><span class="s1">call</span><span class="s2">()])</span>

    <span class="s0">def </span><span class="s1">test_launch_sync_disabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Create two foreign arrays with streams</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">()</span>
        <span class="s1">f_arr1 </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s1</span><span class="s2">))</span>
        <span class="s1">f_arr2 </span><span class="s2">= </span><span class="s1">ForeignArray</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">device_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">stream</span><span class="s2">=</span><span class="s1">s2</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">override_config</span><span class="s2">(</span><span class="s3">'CUDA_ARRAY_INTERFACE_SYNC'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
            <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
                <span class="s0">pass</span>

            <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadrv</span><span class="s2">.</span><span class="s1">driver</span><span class="s2">.</span><span class="s1">Stream</span><span class="s2">, </span><span class="s3">'synchronize'</span><span class="s2">,</span>
                              <span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sync</span><span class="s2">:</span>
                <span class="s1">f</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">](</span><span class="s1">f_arr1</span><span class="s2">, </span><span class="s1">f_arr2</span><span class="s2">)</span>

            <span class="s5"># Ensure that synchronize was not called</span>
            <span class="s1">mock_sync</span><span class="s2">.</span><span class="s1">assert_not_called</span><span class="s2">()</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">&quot;__main__&quot;</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>