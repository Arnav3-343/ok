<html>
<head>
<title>async_common.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
async_common.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
.. warning:: 
 
    The classes in this file are internal and may well be removed to an 
    external kivy-pytest package or similar in the future. Use at your own 
    risk. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">random</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">math</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">collections </span><span class="s2">import </span><span class="s1">deque</span>

<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">tests </span><span class="s2">import </span><span class="s1">UnitTestTouch</span>

<span class="s1">__all__ </span><span class="s3">= (</span><span class="s4">'UnitKivyApp'</span><span class="s3">, )</span>


<span class="s2">class </span><span class="s1">AsyncUnitTestTouch</span><span class="s3">(</span><span class="s1">UnitTestTouch</span><span class="s3">):</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">grab_exclusive_class </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">is_touch </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">super</span><span class="s3">(</span><span class="s1">AsyncUnitTestTouch</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">largs</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">touch_down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">eventloop</span><span class="s3">.</span><span class="s1">_dispatch_input</span><span class="s3">(</span><span class="s4">&quot;begin&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">touch_move</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">win </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">eventloop</span><span class="s3">.</span><span class="s1">window</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">move</span><span class="s3">({</span>
            <span class="s4">&quot;x&quot;</span><span class="s3">: </span><span class="s1">x </span><span class="s3">/ (</span><span class="s1">win</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s5">1.0</span><span class="s3">),</span>
            <span class="s4">&quot;y&quot;</span><span class="s3">: </span><span class="s1">y </span><span class="s3">/ (</span><span class="s1">win</span><span class="s3">.</span><span class="s1">height </span><span class="s3">- </span><span class="s5">1.0</span><span class="s3">)</span>
        <span class="s3">})</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">eventloop</span><span class="s3">.</span><span class="s1">_dispatch_input</span><span class="s3">(</span><span class="s4">&quot;update&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">touch_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">eventloop</span><span class="s3">.</span><span class="s1">_dispatch_input</span><span class="s3">(</span><span class="s4">&quot;end&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>


<span class="s1">_unique_value </span><span class="s3">= </span><span class="s1">object</span>


<span class="s2">class </span><span class="s1">WidgetResolver</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;It assumes that the widget tree strictly forms a DAG. 
    &quot;&quot;&quot;</span>

    <span class="s1">base_widget </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">matched_widget </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">_kwargs_filter </span><span class="s3">= {}</span>

    <span class="s1">_funcs_filter </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">base_widget</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">base_widget </span><span class="s3">= </span><span class="s1">base_widget</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_kwargs_filter </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_funcs_filter </span><span class="s3">= []</span>
        <span class="s1">super</span><span class="s3">(</span><span class="s1">WidgetResolver</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">__init__</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">matched_widget </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">matched_widget</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_kwargs_filter </span><span class="s2">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_funcs_filter</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_widget</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">match</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs_filter</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_kwargs_filter</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">kwargs_filter</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">match_funcs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">funcs_filter</span><span class="s3">=()):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_funcs_filter</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">funcs_filter</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">widget</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">all</span><span class="s3">(</span><span class="s1">func</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">) </span><span class="s2">for </span><span class="s1">func </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_funcs_filter</span><span class="s3">):</span>
            <span class="s2">return False</span>

        <span class="s2">for </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_kwargs_filter</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">_unique_value</span><span class="s3">) != </span><span class="s1">val</span><span class="s3">:</span>
                <span class="s2">return False</span>

        <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">not_found</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">op</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">'Cannot find widget matching &lt;{}, {}&gt; starting from base '</span>
            <span class="s4">'widget &quot;{}&quot; doing &quot;{}&quot; traversal'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_kwargs_filter</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_funcs_filter</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_widget</span><span class="s3">, </span><span class="s1">op</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs_filter</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(**</span><span class="s1">kwargs_filter</span><span class="s3">)</span>
        <span class="s1">check </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_widget</span>

        <span class="s1">fifo </span><span class="s3">= </span><span class="s1">deque</span><span class="s3">([</span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_widget</span><span class="s3">])</span>
        <span class="s2">while </span><span class="s1">fifo</span><span class="s3">:</span>
            <span class="s1">widget </span><span class="s3">= </span><span class="s1">fifo</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">check</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">WidgetResolver</span><span class="s3">(</span><span class="s1">base_widget</span><span class="s3">=</span><span class="s1">widget</span><span class="s3">)</span>

            <span class="s1">fifo</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">children</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">not_found</span><span class="s3">(</span><span class="s4">'down'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs_filter</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(**</span><span class="s1">kwargs_filter</span><span class="s3">)</span>
        <span class="s1">check </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_widget</span>

        <span class="s1">parent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_widget</span>
        <span class="s2">while </span><span class="s1">parent </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">check</span><span class="s3">(</span><span class="s1">parent</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">WidgetResolver</span><span class="s3">(</span><span class="s1">base_widget</span><span class="s3">=</span><span class="s1">parent</span><span class="s3">)</span>

            <span class="s1">new_parent </span><span class="s3">= </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">parent</span>
            <span class="s6"># Window is its own parent oO</span>
            <span class="s2">if </span><span class="s1">new_parent </span><span class="s2">is </span><span class="s1">parent</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s1">parent </span><span class="s3">= </span><span class="s1">new_parent</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">not_found</span><span class="s3">(</span><span class="s4">'up'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">family_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs_filter</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(**</span><span class="s1">kwargs_filter</span><span class="s3">)</span>
        <span class="s1">check </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_widget</span>

        <span class="s1">base_widget </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_widget</span>
        <span class="s1">already_checked_base </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">while </span><span class="s1">base_widget </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">fifo </span><span class="s3">= </span><span class="s1">deque</span><span class="s3">([</span><span class="s1">base_widget</span><span class="s3">])</span>
            <span class="s2">while </span><span class="s1">fifo</span><span class="s3">:</span>
                <span class="s1">widget </span><span class="s3">= </span><span class="s1">fifo</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">()</span>
                <span class="s6"># don't check the child we checked before moving up</span>
                <span class="s2">if </span><span class="s1">widget </span><span class="s2">is </span><span class="s1">already_checked_base</span><span class="s3">:</span>
                    <span class="s2">continue</span>

                <span class="s2">if </span><span class="s1">check</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">):</span>
                    <span class="s2">return </span><span class="s1">WidgetResolver</span><span class="s3">(</span><span class="s1">base_widget</span><span class="s3">=</span><span class="s1">widget</span><span class="s3">)</span>

                <span class="s1">fifo</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">children</span><span class="s3">)</span>

            <span class="s1">already_checked_base </span><span class="s3">= </span><span class="s1">base_widget</span>
            <span class="s1">new_base_widget </span><span class="s3">= </span><span class="s1">base_widget</span><span class="s3">.</span><span class="s1">parent</span>
            <span class="s6"># Window is its own parent oO</span>
            <span class="s2">if </span><span class="s1">new_base_widget </span><span class="s2">is </span><span class="s1">base_widget</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s1">base_widget </span><span class="s3">= </span><span class="s1">new_base_widget</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">not_found</span><span class="s3">(</span><span class="s4">'family_up'</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">UnitKivyApp</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Base class to use with async test apps. 
 
    .. warning:: 
 
        The classes in this file are internal and may well be removed to an 
        external kivy-pytest package or similar in the future. Use at your own 
        risk. 
    &quot;&quot;&quot;</span>

    <span class="s1">app_has_started </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s1">app_has_stopped </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s1">async_sleep </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">started_app</span><span class="s3">(*</span><span class="s1">largs</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">app_has_started </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fbind</span><span class="s3">(</span><span class="s4">'on_start'</span><span class="s3">, </span><span class="s1">started_app</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">stopped_app</span><span class="s3">(*</span><span class="s1">largs</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">app_has_stopped </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fbind</span><span class="s3">(</span><span class="s4">'on_stop'</span><span class="s3">, </span><span class="s1">stopped_app</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">set_async_lib</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">async_lib</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">clock </span><span class="s2">import </span><span class="s1">Clock</span>
        <span class="s2">if </span><span class="s1">async_lib </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">Clock</span><span class="s3">.</span><span class="s1">init_async_lib</span><span class="s3">(</span><span class="s1">async_lib</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">_async_lib</span><span class="s3">.</span><span class="s1">sleep</span>

    <span class="s2">async def </span><span class="s1">async_run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">async_lib</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">set_async_lib</span><span class="s3">(</span><span class="s1">async_lib</span><span class="s3">)</span>
        <span class="s2">return await </span><span class="s1">super</span><span class="s3">(</span><span class="s1">UnitKivyApp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">async_run</span><span class="s3">(</span><span class="s1">async_lib</span><span class="s3">=</span><span class="s1">async_lib</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">resolve_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">base_widget</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">base_widget </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">window </span><span class="s2">import </span><span class="s1">Window</span>
            <span class="s1">base_widget </span><span class="s3">= </span><span class="s1">Window</span>
        <span class="s2">return </span><span class="s1">WidgetResolver</span><span class="s3">(</span><span class="s1">base_widget</span><span class="s3">=</span><span class="s1">base_widget</span><span class="s3">)</span>

    <span class="s2">async def </span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">sleep_time</span><span class="s3">=</span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">60.</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">clock </span><span class="s2">import </span><span class="s1">Clock</span>
        <span class="s1">frames_start </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">frames</span>
        <span class="s2">while </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">frames </span><span class="s3">&lt; </span><span class="s1">frames_start </span><span class="s3">+ </span><span class="s1">n</span><span class="s3">:</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">sleep_time</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_widget_pos_pixel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">widget</span><span class="s3">, </span><span class="s1">positions</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">graphics </span><span class="s2">import </span><span class="s1">Fbo</span><span class="s3">, </span><span class="s1">ClearColor</span><span class="s3">, </span><span class="s1">ClearBuffers</span>

        <span class="s1">canvas_parent_index </span><span class="s3">= -</span><span class="s5">2</span>
        <span class="s2">if </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">parent </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">canvas_parent_index </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">indexof</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">canvas_parent_index </span><span class="s3">&gt; -</span><span class="s5">1</span><span class="s3">:</span>
                <span class="s1">widget</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">)</span>

        <span class="s1">w</span><span class="s3">, </span><span class="s1">h </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">width</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">height</span><span class="s3">)</span>
        <span class="s1">fbo </span><span class="s3">= </span><span class="s1">Fbo</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">h</span><span class="s3">), </span><span class="s1">with_stencilbuffer</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">fbo</span><span class="s3">:</span>
            <span class="s1">ClearColor</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">ClearBuffers</span><span class="s3">()</span>

        <span class="s1">fbo</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">)</span>
        <span class="s1">fbo</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">()</span>
        <span class="s1">pixels </span><span class="s3">= </span><span class="s1">fbo</span><span class="s3">.</span><span class="s1">pixels</span>
        <span class="s1">fbo</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">parent </span><span class="s2">is not None and </span><span class="s1">canvas_parent_index </span><span class="s3">&gt; -</span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">widget</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">canvas_parent_index</span><span class="s3">, </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">)</span>

        <span class="s1">values </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">positions</span><span class="s3">:</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">i </span><span class="s3">= </span><span class="s1">y </span><span class="s3">* </span><span class="s1">w </span><span class="s3">* </span><span class="s5">4 </span><span class="s3">+ </span><span class="s1">x </span><span class="s3">* </span><span class="s5">4</span>
            <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">pixels</span><span class="s3">[</span><span class="s1">i</span><span class="s3">:</span><span class="s1">i </span><span class="s3">+ </span><span class="s5">4</span><span class="s3">]))</span>

        <span class="s2">return </span><span class="s1">values</span>

    <span class="s2">async def </span><span class="s1">do_touch_down_up</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">widget</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">duration</span><span class="s3">=</span><span class="s5">.2</span><span class="s3">, </span><span class="s1">pos_jitter</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">widget_jitter</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">jitter_dt</span><span class="s3">=</span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">15.</span><span class="s3">, </span><span class="s1">end_on_pos</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">widget </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">pos</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">pos </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(*</span><span class="s1">widget</span><span class="s3">.</span><span class="s1">center</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(*</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">touch </span><span class="s3">= </span><span class="s1">AsyncUnitTestTouch</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

        <span class="s1">ts </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">()</span>
        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_down</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'down'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s2">if not </span><span class="s1">pos_jitter </span><span class="s2">and not </span><span class="s1">widget_jitter</span><span class="s3">:</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">duration</span><span class="s3">)</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_up</span><span class="s3">()</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'up'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

            <span class="s2">return</span>

        <span class="s1">moved </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">if </span><span class="s1">pos_jitter</span><span class="s3">:</span>
            <span class="s1">dx</span><span class="s3">, </span><span class="s1">dy </span><span class="s3">= </span><span class="s1">pos_jitter</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">dx </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">width </span><span class="s3">/ </span><span class="s5">2.</span>
            <span class="s1">dy </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">height </span><span class="s3">/ </span><span class="s5">2.</span>

        <span class="s2">while </span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">() - </span><span class="s1">ts </span><span class="s3">&lt; </span><span class="s1">duration</span><span class="s3">:</span>
            <span class="s1">moved </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">jitter_dt</span><span class="s3">)</span>

            <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_move</span><span class="s3">(</span>
                <span class="s1">x </span><span class="s3">+ (</span><span class="s1">random</span><span class="s3">.</span><span class="s1">random</span><span class="s3">() * </span><span class="s5">2 </span><span class="s3">- </span><span class="s5">1</span><span class="s3">) * </span><span class="s1">dx</span><span class="s3">,</span>
                <span class="s1">y </span><span class="s3">+ (</span><span class="s1">random</span><span class="s3">.</span><span class="s1">random</span><span class="s3">() * </span><span class="s5">2 </span><span class="s3">- </span><span class="s5">1</span><span class="s3">) * </span><span class="s1">dy</span>
            <span class="s3">)</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'move'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s2">if </span><span class="s1">end_on_pos </span><span class="s2">and </span><span class="s1">moved</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_move</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'move'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_up</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'up'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

    <span class="s2">async def </span><span class="s1">do_touch_drag</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">widget</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">widget_loc</span><span class="s3">=(</span><span class="s4">'center_x'</span><span class="s3">, </span><span class="s4">'center_y'</span><span class="s3">), </span><span class="s1">dx</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">dy</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
            <span class="s1">target_pos</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">target_widget</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">target_widget_offset</span><span class="s3">=(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
            <span class="s1">target_widget_loc</span><span class="s3">=(</span><span class="s4">'center_x'</span><span class="s3">, </span><span class="s4">'center_y'</span><span class="s3">), </span><span class="s1">long_press</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
            <span class="s1">duration</span><span class="s3">=</span><span class="s5">.2</span><span class="s3">, </span><span class="s1">drag_n</span><span class="s3">=</span><span class="s5">5</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Initiates a touch down, followed by some dragging to a target 
        location, ending with a touch up. 
 
        `origin`: These parameters specify where the drag starts. 
        - If ``widget`` is None, it starts at ``pos`` (in window coordinates). 
          If ``dx``/``dy`` is used, it is in the window coordinate system also. 
        - If ``pos`` is None, it starts on the ``widget`` as specified by 
          ``widget_loc``. If ``dx``/``dy`` is used, it is in the ``widget`` 
          coordinate system. 
        - If neither is None, it starts at ``pos``, but in the ``widget``'s 
          coordinate system (:meth:`~kivy.uix.widget.Widget.to_window` is used 
          on it). If ``dx``/``dy`` is used, it is in the ``widget`` 
          coordinate system. 
 
        `target`: These parameters specify where the drag ends. 
        - If ``target_pos`` and ``target_widget`` is None, then ``dx`` and 
          ``dy`` is used relative to the position where the drag started. 
        - If ``target_widget`` is None, it ends at ``target_pos`` 
          (in window coordinates). 
        - If ``target_pos`` is None, it ends on the ``target_widget`` as 
          specified by ``target_widget_loc``. ``target_widget_offset``, is an 
          additional ``(x, y)`` offset relative to ``target_widget_loc``. 
        - If neither is None, it starts at ``target_pos``, but in the 
          ``target_widget``'s coordinate system 
          (:meth:`~kivy.uix.widget.Widget.to_window` is used on it). 
 
        When ``widget`` and/or ``target_widget`` are specified, ``widget_loc`` 
        and ``target_widget_loc``, respectively, indicate where on the widget 
        the drag starts/ends. It is a a tuple with property names of the widget 
        to loop up to get the value. The default is 
        ``('center_x', 'center_y')`` so the drag would start/end in the 
        widget's center. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">widget </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">pos</span>
            <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">dx</span><span class="s3">, </span><span class="s1">y </span><span class="s3">+ </span><span class="s1">dy</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">pos </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">w_x </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">, </span><span class="s1">widget_loc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
                <span class="s1">w_y </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">, </span><span class="s1">widget_loc</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
                <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span><span class="s1">w_x</span><span class="s3">, </span><span class="s1">w_y</span><span class="s3">)</span>
                <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span><span class="s1">w_x </span><span class="s3">+ </span><span class="s1">dx</span><span class="s3">, </span><span class="s1">w_y </span><span class="s3">+ </span><span class="s1">dy</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(*</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
                <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span>
                    <span class="s1">pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s1">dx</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s1">dy</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">target_pos </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">target_widget </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">target_pos</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">target_pos </span><span class="s3">= </span><span class="s1">target_widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span>
                    <span class="s3">*</span><span class="s1">target_pos</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">target_widget </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">x_off</span><span class="s3">, </span><span class="s1">y_off </span><span class="s3">= </span><span class="s1">target_widget_offset</span>
            <span class="s1">w_x </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">target_widget</span><span class="s3">, </span><span class="s1">target_widget_loc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]) + </span><span class="s1">x_off</span>
            <span class="s1">w_y </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">target_widget</span><span class="s3">, </span><span class="s1">target_widget_loc</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]) + </span><span class="s1">y_off</span>
            <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">target_pos </span><span class="s3">= </span><span class="s1">target_widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span><span class="s1">w_x</span><span class="s3">, </span><span class="s1">w_y</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">target_pos </span><span class="s3">= </span><span class="s1">tx</span><span class="s3">, </span><span class="s1">ty</span>

        <span class="s1">touch </span><span class="s3">= </span><span class="s1">AsyncUnitTestTouch</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_down</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">long_press</span><span class="s3">:</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">long_press</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'down'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s1">dx </span><span class="s3">= (</span><span class="s1">tx </span><span class="s3">- </span><span class="s1">x</span><span class="s3">) / </span><span class="s1">drag_n</span>
        <span class="s1">dy </span><span class="s3">= (</span><span class="s1">ty </span><span class="s3">- </span><span class="s1">y</span><span class="s3">) / </span><span class="s1">drag_n</span>

        <span class="s1">ts0 </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">drag_n</span><span class="s3">):</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span>
                <span class="s1">max</span><span class="s3">(</span><span class="s5">0.</span><span class="s3">, </span><span class="s1">duration </span><span class="s3">- (</span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">() - </span><span class="s1">ts0</span><span class="s3">)) / (</span><span class="s1">drag_n </span><span class="s3">- </span><span class="s1">i</span><span class="s3">))</span>

            <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_move</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ (</span><span class="s1">i </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">) * </span><span class="s1">dx</span><span class="s3">, </span><span class="s1">y </span><span class="s3">+ (</span><span class="s1">i </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">) * </span><span class="s1">dy</span><span class="s3">)</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'move'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s2">if </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos </span><span class="s3">!= </span><span class="s1">target_pos</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_move</span><span class="s3">(*</span><span class="s1">target_pos</span><span class="s3">)</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'move'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_up</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'up'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

    <span class="s2">async def </span><span class="s1">do_touch_drag_follow</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">widget</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">widget_loc</span><span class="s3">=(</span><span class="s4">'center_x'</span><span class="s3">, </span><span class="s4">'center_y'</span><span class="s3">),</span>
            <span class="s1">target_pos</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">target_widget</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">target_widget_offset</span><span class="s3">=(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
            <span class="s1">target_widget_loc</span><span class="s3">=(</span><span class="s4">'center_x'</span><span class="s3">, </span><span class="s4">'center_y'</span><span class="s3">), </span><span class="s1">long_press</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
            <span class="s1">duration</span><span class="s3">=</span><span class="s5">.2</span><span class="s3">, </span><span class="s1">drag_n</span><span class="s3">=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">max_n</span><span class="s3">=</span><span class="s5">25</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Very similar to :meth:`do_touch_drag`, except it follows the target 
        widget, even if the target widget moves as a result of the drag, the 
        drag will follow it until it's on the target widget. 
 
        `origin`: These parameters specify where the drag starts. 
        - If ``widget`` is None, it starts at ``pos`` (in window coordinates). 
        - If ``pos`` is None, it starts on the ``widget`` as specified by 
          ``widget_loc``. 
        - If neither is None, it starts at ``pos``, but in the ``widget``'s 
          coordinate system (:meth:`~kivy.uix.widget.Widget.to_window` is used 
          on it). 
 
        `target`: These parameters specify where the drag ends. 
        - If ``target_pos`` is None, it ends on the ``target_widget`` as 
          specified by ``target_widget_loc``. ``target_widget_offset``, is an 
          additional ``(x, y)`` offset relative to ``target_widget_loc``. 
        - If ``target_pos`` is not None, it starts at ``target_pos``, but in 
          the ``target_widget``'s coordinate system 
          (:meth:`~kivy.uix.widget.Widget.to_window` is used on it). 
 
        When ``widget`` and/or ``target_widget`` are specified, ``widget_loc`` 
        and ``target_widget_loc``, respectively, indicate where on the widget 
        the drag starts/ends. It is a a tuple with property names of the widget 
        to loop up to get the value. The default is 
        ``('center_x', 'center_y')`` so the drag would start/end in the 
        widget's center. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">widget </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">pos</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">pos </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">w_x </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">, </span><span class="s1">widget_loc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
                <span class="s1">w_y </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">, </span><span class="s1">widget_loc</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
                <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span><span class="s1">w_x</span><span class="s3">, </span><span class="s1">w_y</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(*</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">target_widget </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">'target_widget must be specified'</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">get_target</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">target_pos </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">target_widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(*</span><span class="s1">target_pos</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">x_off</span><span class="s3">, </span><span class="s1">y_off </span><span class="s3">= </span><span class="s1">target_widget_offset</span>
                <span class="s1">wt_x </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">target_widget</span><span class="s3">, </span><span class="s1">target_widget_loc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]) + </span><span class="s1">x_off</span>
                <span class="s1">wt_y </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">target_widget</span><span class="s3">, </span><span class="s1">target_widget_loc</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]) + </span><span class="s1">y_off</span>
                <span class="s2">return </span><span class="s1">target_widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span><span class="s1">wt_x</span><span class="s3">, </span><span class="s1">wt_y</span><span class="s3">)</span>

        <span class="s1">touch </span><span class="s3">= </span><span class="s1">AsyncUnitTestTouch</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_down</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">long_press</span><span class="s3">:</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">long_press</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'down'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s1">ts0 </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">()</span>
        <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">get_target</span><span class="s3">()</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s2">while not </span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">isclose</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">tx</span><span class="s3">) </span><span class="s2">and </span><span class="s1">math</span><span class="s3">.</span><span class="s1">isclose</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">y</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)):</span>
            <span class="s2">if </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s1">max_n</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span>
                    <span class="s4">'Exceeded the maximum number of iterations, '</span>
                    <span class="s4">'but {} != {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">, (</span><span class="s1">tx</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)))</span>

            <span class="s1">rem_i </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">drag_n </span><span class="s3">- </span><span class="s1">i</span><span class="s3">)</span>
            <span class="s1">rem_t </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0.</span><span class="s3">, </span><span class="s1">duration </span><span class="s3">- (</span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">() - </span><span class="s1">ts0</span><span class="s3">)) / </span><span class="s1">rem_i</span>
            <span class="s1">i </span><span class="s3">+= </span><span class="s5">1</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">rem_t</span><span class="s3">)</span>

            <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_move</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ (</span><span class="s1">tx </span><span class="s3">- </span><span class="s1">x</span><span class="s3">) / </span><span class="s1">rem_i</span><span class="s3">, </span><span class="s1">y </span><span class="s3">+ (</span><span class="s1">ty </span><span class="s3">- </span><span class="s1">y</span><span class="s3">) / </span><span class="s1">rem_i</span><span class="s3">)</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'move'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>
            <span class="s1">tx</span><span class="s3">, </span><span class="s1">ty </span><span class="s3">= </span><span class="s1">get_target</span><span class="s3">()</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_up</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'up'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

    <span class="s2">async def </span><span class="s1">do_touch_drag_path</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">axis_widget</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">long_press</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">duration</span><span class="s3">=</span><span class="s5">.2</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Drags the touch along the specified path. 
 
        :parameters: 
 
            `path`: list 
                A list of position tuples the touch will follow. The first 
                item is used for the touch down and the rest for the move. 
            `axis_widget`: a Widget 
                If None, the path coordinates is in window coordinates, 
                otherwise, we will first transform the path coordinates 
                to window coordinates using 
                :meth:`~kivy.uix.widget.Widget.to_window` of the specified 
                widget. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">axis_widget </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">= [</span><span class="s1">axis_widget</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(*</span><span class="s1">p</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">path</span><span class="s3">]</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">path</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">path</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:]</span>

        <span class="s1">touch </span><span class="s3">= </span><span class="s1">AsyncUnitTestTouch</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_down</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">long_press</span><span class="s3">:</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">long_press</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'down'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s1">ts0 </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">()</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, (</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span>
                <span class="s1">max</span><span class="s3">(</span><span class="s5">0.</span><span class="s3">, </span><span class="s1">duration </span><span class="s3">- (</span><span class="s1">time</span><span class="s3">.</span><span class="s1">perf_counter</span><span class="s3">() - </span><span class="s1">ts0</span><span class="s3">)) / (</span><span class="s1">n </span><span class="s3">- </span><span class="s1">i</span><span class="s3">))</span>

            <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_move</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'move'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">touch_up</span><span class="s3">()</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'up'</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>

    <span class="s2">async def </span><span class="s1">do_keyboard_key</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">modifiers</span><span class="s3">=(), </span><span class="s1">duration</span><span class="s3">=</span><span class="s5">.05</span><span class="s3">, </span><span class="s1">num_press</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">window </span><span class="s2">import </span><span class="s1">Window</span>
        <span class="s2">if </span><span class="s1">key </span><span class="s3">== </span><span class="s4">' '</span><span class="s3">:</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s4">'spacebar'</span>
        <span class="s1">key_lower </span><span class="s3">= </span><span class="s1">key</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
        <span class="s1">key_code </span><span class="s3">= </span><span class="s1">Window</span><span class="s3">.</span><span class="s1">_system_keyboard</span><span class="s3">.</span><span class="s1">string_to_keycode</span><span class="s3">(</span><span class="s1">key_lower</span><span class="s3">)</span>

        <span class="s1">known_modifiers </span><span class="s3">= {</span><span class="s4">'shift'</span><span class="s3">, </span><span class="s4">'alt'</span><span class="s3">, </span><span class="s4">'ctrl'</span><span class="s3">, </span><span class="s4">'meta'</span><span class="s3">}</span>
        <span class="s2">if </span><span class="s1">set</span><span class="s3">(</span><span class="s1">modifiers</span><span class="s3">) - </span><span class="s1">known_modifiers</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">'Unknown modifiers &quot;{}&quot;'</span><span class="s3">.</span>
                             <span class="s1">format</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">modifiers</span><span class="s3">) - </span><span class="s1">known_modifiers</span><span class="s3">))</span>

        <span class="s1">special_keys </span><span class="s3">= {</span>
            <span class="s5">27</span><span class="s3">: </span><span class="s4">'escape'</span><span class="s3">,</span>
            <span class="s5">9</span><span class="s3">: </span><span class="s4">'tab'</span><span class="s3">,</span>
            <span class="s5">8</span><span class="s3">: </span><span class="s4">'backspace'</span><span class="s3">,</span>
            <span class="s5">13</span><span class="s3">: </span><span class="s4">'enter'</span><span class="s3">,</span>
            <span class="s5">127</span><span class="s3">: </span><span class="s4">'del'</span><span class="s3">,</span>
            <span class="s5">271</span><span class="s3">: </span><span class="s4">'enter'</span><span class="s3">,</span>
            <span class="s5">273</span><span class="s3">: </span><span class="s4">'up'</span><span class="s3">,</span>
            <span class="s5">274</span><span class="s3">: </span><span class="s4">'down'</span><span class="s3">,</span>
            <span class="s5">275</span><span class="s3">: </span><span class="s4">'right'</span><span class="s3">,</span>
            <span class="s5">276</span><span class="s3">: </span><span class="s4">'left'</span><span class="s3">,</span>
            <span class="s5">278</span><span class="s3">: </span><span class="s4">'home'</span><span class="s3">,</span>
            <span class="s5">279</span><span class="s3">: </span><span class="s4">'end'</span><span class="s3">,</span>
            <span class="s5">280</span><span class="s3">: </span><span class="s4">'pgup'</span><span class="s3">,</span>
            <span class="s5">281</span><span class="s3">: </span><span class="s4">'pgdown'</span><span class="s3">,</span>
            <span class="s5">300</span><span class="s3">: </span><span class="s4">'numlock'</span><span class="s3">,</span>
            <span class="s5">301</span><span class="s3">: </span><span class="s4">'capslock'</span><span class="s3">,</span>
            <span class="s5">145</span><span class="s3">: </span><span class="s4">'screenlock'</span><span class="s3">,</span>
        <span class="s3">}</span>

        <span class="s1">text </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">chr</span><span class="s3">(</span><span class="s1">key_code</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">key_lower </span><span class="s3">!= </span><span class="s1">key</span><span class="s3">:</span>
                <span class="s1">text </span><span class="s3">= </span><span class="s1">key</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">pass</span>

        <span class="s1">dt </span><span class="s3">= </span><span class="s1">duration </span><span class="s3">/ </span><span class="s1">num_press</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_press</span><span class="s3">):</span>
            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">async_sleep</span><span class="s3">(</span><span class="s1">dt</span><span class="s3">)</span>

            <span class="s1">Window</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_key_down'</span><span class="s3">, </span><span class="s1">key_code</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">modifiers</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">key </span><span class="s2">not in </span><span class="s1">known_modifiers </span><span class="s2">and</span>
                    <span class="s1">key_code </span><span class="s2">not in </span><span class="s1">special_keys </span><span class="s2">and</span>
                    <span class="s2">not </span><span class="s3">(</span><span class="s1">known_modifiers </span><span class="s3">&amp; </span><span class="s1">set</span><span class="s3">(</span><span class="s1">modifiers</span><span class="s3">))):</span>
                <span class="s1">Window</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_textinput'</span><span class="s3">, </span><span class="s1">text</span><span class="s3">)</span>

            <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s4">'down'</span><span class="s3">, (</span><span class="s1">key</span><span class="s3">, </span><span class="s1">key_code</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">modifiers</span><span class="s3">)</span>

        <span class="s1">Window</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_key_up'</span><span class="s3">, </span><span class="s1">key_code</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s2">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">wait_clock_frames</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s4">'up'</span><span class="s3">, (</span><span class="s1">key</span><span class="s3">, </span><span class="s1">key_code</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">modifiers</span><span class="s3">)</span>
</pre>
</body>
</html>