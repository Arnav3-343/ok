<html>
<head>
<title>logger.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
logger.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Kivy Logging 
============ 
 
By default, Kivy provides a logging system based on the standard Python 
`logging &lt;https://docs.python.org/3/library/logging.html&gt;`_ module with 
several additional features designed to be more convenient. These features 
include: 
 
 * simplied usage (single instance, simple configuration, works by default) 
 * color-coded output on supported terminals 
 * output to ``stderr`` by default 
 * message categorization via colon separation 
 * access to log history even if logging is disabled 
 * built-in handling of various cross-platform considerations 
 * any stray output written to ``sys.stderr`` is captured, and stored in the log 
   file as a warning. 
 
These features are configurable via the Config file or environment variables - 
including falling back to only using the standard Python system. 
 
Logger object 
============= 
 
The Kivy ``Logger`` class provides a singleton logging.logger instance. 
 
As well as the standard logging levels (``debug``, ``info``, 
``warning``, ``error`` and ``critical``), an additional ``trace`` level is 
available. 
 
Example Usage 
------------- 
 
Use the ``Logger`` as you would a standard Python logger. :: 
 
    from kivy.logger import Logger 
 
    Logger.info('title: This is a info message.') 
    Logger.debug('title: This is a debug message.') 
 
    try: 
        raise Exception('bleh') 
    except Exception: 
        Logger.exception('Something happened!') 
 
The message passed to the logger is split into two parts separated by a colon 
(:). The first part is used as a title and the second part is used as the 
message. This way, you can &quot;categorize&quot; your messages easily. :: 
 
    Logger.info('Application: This is a test') 
 
    # will appear as 
 
    [INFO   ] [Application ] This is a test 
 
You can change the logging level at any time using the ``setLevel`` method. :: 
 
    from kivy.logger import Logger, LOG_LEVELS 
 
    Logger.setLevel(LOG_LEVELS[&quot;debug&quot;]) 
 
.. versionchanged:: 2.2.0 
 
Interaction with other logging 
------------------------------ 
 
The Kivy logging system will, by default, present all log messages sent from 
any logger - e.g. from third-party libraries. 
 
Additional handlers may be added. 
 
.. warning:: Handlers that output to ``sys.stderr`` may cause loops, as stderr 
   output is reported as a warning log message. 
 
Logger Configuration 
==================== 
 
Kivy Log Mode 
------------- 
 
At the highest level, Kivy's logging system is controlled by an environment 
variable ``KIVY_LOG_MODE``. It may be given any of three values: 
``KIVY``, ``PYTHON``, ``MIXED`` 
 
.. versionadded: 2.2.0 
 
KIVY Mode (default) 
^^^^^^^^^^^^^^^^^^^ 
 
In ``KIVY`` mode, all Kivy handlers are attached to the root logger, so all log 
messages in the system are output to the Kivy log files and to the console. Any 
stray output to ``sys.stderr`` is logged as a warning. 
 
If you are writing an entire Kivy app from scratch, this is the most convenient 
mode. 
 
PYTHON Mode 
^^^^^^^^^^^ 
 
In ``PYTHON`` mode, no handlers are added, and ``sys.stderr`` output is not 
captured. It is left to the client to add appropriate handlers. (If none are 
added, the ``logging`` module will output them to ``stderr``.) 
 
Messages logged with ``Logger`` will be propagated to the root logger, from a 
logger named ``kivy``. 
 
If the Kivy app is part of a much larger project which has its own logging 
regimen, this is the mode that gives most control. 
 
The ``kivy.logger`` file contains a number of ``logging.handler``, 
``logging.formatter``, and other helper classes to allow 
users to adopt the features of Kivy logging that they like, including the 
stderr redirection. 
 
MIXED Mode 
^^^^^^^^^^ 
 
In ``MIXED`` mode, handlers are added to the Kivy's ``Logger`` object directly, 
and propagation is turned off. ``sys.stderr`` is not redirected. 
 
Messages logged with Kivy's ``Logger`` will appear in the Kivy log file and 
output to the Console. 
 
However, messages logged with other Python loggers will not be handled by Kivy 
handlers. The client will need to add their own. 
 
If you like the features of Kivy ``Logger``, but are writing a Kivy app that 
relies on third-party libraries that don't use colon-separation of categorise 
or depend on the display of the logger name, this mode provides a compromise. 
 
Again, the ``kivy.logger`` file contains re-usable logging features that can be 
used to get the best of both systems. 
 
Config Files 
------------ 
 
In ``KIVY`` and ``MIXED`` modes, the logger handlers can be controlled via the 
Kivy configuration file:: 
 
    [kivy] 
    log_level = info 
    log_enable = 1 
    log_dir = logs 
    log_name = kivy_%y-%m-%d_%_.txt 
    log_maxfiles = 100 
 
More information about the allowed values are described in the 
:mod:`kivy.config` module. 
 
In addition, the environment variables ``KIVY_NO_FILELOG`` and 
``KIVY_NO_CONSOLELOG`` can be used to turn off the installation of the 
corresponding handlers. 
 
 
Logger History 
-------------- 
 
Even if the logger is not enabled, you still have access to the last 100 
LogRecords:: 
 
    from kivy.logger import LoggerHistory 
 
    print(LoggerHistory.history) 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">partial</span>
<span class="s2">import </span><span class="s1">pathlib</span>

<span class="s2">import </span><span class="s1">kivy</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">platform</span>


<span class="s1">__all__ </span><span class="s3">= (</span>
    <span class="s4">&quot;add_kivy_handlers&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;ColonSplittingLogRecord&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;ColoredLogRecord&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;COLORS&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;ConsoleHandler&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;file_log_handler&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;FileHandler&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;is_color_terminal&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;KivyFormatter&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;LOG_LEVELS&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;Logger&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;LoggerHistory&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;ProcessingStream&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;UncoloredLogRecord&quot;</span><span class="s3">,</span>
<span class="s3">)</span>


<span class="s1">Logger </span><span class="s3">= </span><span class="s2">None</span>


<span class="s1">logging</span><span class="s3">.</span><span class="s1">addLevelName</span><span class="s3">(</span><span class="s5">9</span><span class="s3">, </span><span class="s4">'TRACE'</span><span class="s3">)</span>
<span class="s1">logging</span><span class="s3">.</span><span class="s1">TRACE </span><span class="s3">= </span><span class="s5">9</span>
<span class="s1">LOG_LEVELS </span><span class="s3">= {</span>
    <span class="s4">'trace'</span><span class="s3">: </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">TRACE</span><span class="s3">,</span>
    <span class="s4">'debug'</span><span class="s3">: </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">DEBUG</span><span class="s3">,</span>
    <span class="s4">'info'</span><span class="s3">: </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">INFO</span><span class="s3">,</span>
    <span class="s4">'warning'</span><span class="s3">: </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">WARNING</span><span class="s3">,</span>
    <span class="s4">'error'</span><span class="s3">: </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">ERROR</span><span class="s3">,</span>
    <span class="s4">'critical'</span><span class="s3">: </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">CRITICAL</span><span class="s3">}</span>


<span class="s2">class </span><span class="s1">FileHandler</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">Handler</span><span class="s3">):</span>
    <span class="s1">history </span><span class="s3">= []</span>
    <span class="s1">filename </span><span class="s3">= </span><span class="s4">'log.txt'</span>
    <span class="s1">fd </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">log_dir </span><span class="s3">= </span><span class="s4">''</span>
    <span class="s1">encoding </span><span class="s3">= </span><span class="s4">'utf-8'</span>

    <span class="s2">def </span><span class="s1">purge_logs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Purge logs which exceed the maximum amount of log files, 
        starting with the oldest creation timestamp (or edit-timestamp on Linux) 
        &quot;&quot;&quot;</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">log_dir</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>
        <span class="s1">maxfiles </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">getint</span><span class="s3">(</span><span class="s4">&quot;kivy&quot;</span><span class="s3">, </span><span class="s4">&quot;log_maxfiles&quot;</span><span class="s3">)</span>

        <span class="s6"># Get path to log directory</span>
        <span class="s1">log_dir </span><span class="s3">= </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">log_dir</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">maxfiles </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">:  </span><span class="s6"># No log file limit set</span>
            <span class="s2">return</span>

        <span class="s1">Logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Logger: Purge log fired. Processing...&quot;</span><span class="s3">)</span>

        <span class="s6"># Get all files from log directory and corresponding creation timestamps</span>
        <span class="s1">files </span><span class="s3">= [(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">().</span><span class="s1">st_ctime</span><span class="s3">)</span>
                 <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">log_dir</span><span class="s3">.</span><span class="s1">iterdir</span><span class="s3">() </span><span class="s2">if </span><span class="s1">item</span><span class="s3">.</span><span class="s1">is_file</span><span class="s3">()]</span>
        <span class="s6"># Sort files by ascending timestamp</span>
        <span class="s1">files</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>

        <span class="s2">for </span><span class="s1">file</span><span class="s3">, </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">files</span><span class="s3">[:(-</span><span class="s1">maxfiles </span><span class="s2">or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">files</span><span class="s3">))]:</span>
            <span class="s6"># More log files than allowed maximum,</span>
            <span class="s6"># delete files, starting with oldest creation timestamp</span>
            <span class="s6"># (or edit-timestamp on Linux)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">file</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">()</span>
            <span class="s2">except </span><span class="s3">(</span><span class="s1">PermissionError</span><span class="s3">, </span><span class="s1">FileNotFoundError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">Logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">f&quot;Logger: Skipped file </span><span class="s2">{</span><span class="s1">file</span><span class="s2">}</span><span class="s4">, </span><span class="s2">{</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">Logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Logger: Purge finished!&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_configure</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">time </span><span class="s2">import </span><span class="s1">strftime</span>
        <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>
        <span class="s1">log_dir </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'kivy'</span><span class="s3">, </span><span class="s4">'log_dir'</span><span class="s3">)</span>
        <span class="s1">log_name </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'kivy'</span><span class="s3">, </span><span class="s4">'log_name'</span><span class="s3">)</span>

        <span class="s1">_dir </span><span class="s3">= </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">kivy_home_dir</span>
        <span class="s2">if </span><span class="s1">log_dir </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isabs</span><span class="s3">(</span><span class="s1">log_dir</span><span class="s3">):</span>
            <span class="s1">_dir </span><span class="s3">= </span><span class="s1">log_dir</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">_dir</span><span class="s3">, </span><span class="s1">log_dir</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">_dir</span><span class="s3">):</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">_dir</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">log_dir </span><span class="s3">= </span><span class="s1">_dir</span>

        <span class="s1">pattern </span><span class="s3">= </span><span class="s1">log_name</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'%_'</span><span class="s3">, </span><span class="s4">'@@NUMBER@@'</span><span class="s3">)</span>
        <span class="s1">pattern </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">_dir</span><span class="s3">, </span><span class="s1">strftime</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">))</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">filename </span><span class="s3">= </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'@@NUMBER@@'</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">n</span><span class="s3">))</span>
            <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">):</span>
                <span class="s2">break</span>
            <span class="s1">n </span><span class="s3">+= </span><span class="s5">1</span>
            <span class="s2">if </span><span class="s1">n </span><span class="s3">&gt; </span><span class="s5">10000</span><span class="s3">:  </span><span class="s6"># prevent maybe flooding ?</span>
                <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s4">'Too many logfile, remove them'</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">== </span><span class="s1">filename </span><span class="s2">and </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">= </span><span class="s1">filename</span>
        <span class="s2">if </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd </span><span class="s2">not in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
            <span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'w'</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">encoding</span><span class="s3">)</span>
        <span class="s1">Logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">'Logger: Record log in %s' </span><span class="s3">% </span><span class="s1">filename</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_write_message</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">record</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd </span><span class="s2">in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
            <span class="s2">return</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">record</span><span class="s3">)</span>
        <span class="s1">stream </span><span class="s3">= </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd</span>
        <span class="s1">fs </span><span class="s3">= </span><span class="s4">&quot;%s</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">'[%-7s] ' </span><span class="s3">% </span><span class="s1">record</span><span class="s3">.</span><span class="s1">levelname</span><span class="s3">)</span>
        <span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">fs </span><span class="s3">% </span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">stream</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">emit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">message</span><span class="s3">):</span>
        <span class="s6"># during the startup, store the message in the history</span>
        <span class="s2">if </span><span class="s1">Logger</span><span class="s3">.</span><span class="s1">logfile_activated </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">history </span><span class="s3">+= [</span><span class="s1">message</span><span class="s3">]</span>
            <span class="s2">return</span>

        <span class="s6"># startup done, if the logfile is not activated, avoid history.</span>
        <span class="s2">if </span><span class="s1">Logger</span><span class="s3">.</span><span class="s1">logfile_activated </span><span class="s2">is False</span><span class="s3">:</span>
            <span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">history </span><span class="s3">= []</span>
            <span class="s2">return</span>

        <span class="s2">if </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_configure</span><span class="s3">()</span>
                <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>
                <span class="s1">Config</span><span class="s3">.</span><span class="s1">add_callback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_configure</span><span class="s3">, </span><span class="s4">'kivy'</span><span class="s3">, </span><span class="s4">'log_dir'</span><span class="s3">)</span>
                <span class="s1">Config</span><span class="s3">.</span><span class="s1">add_callback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_configure</span><span class="s3">, </span><span class="s4">'kivy'</span><span class="s3">, </span><span class="s4">'log_name'</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
                <span class="s6"># deactivate filehandler...</span>
                <span class="s2">if </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd </span><span class="s2">not in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
                    <span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
                <span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">fd </span><span class="s3">= </span><span class="s2">False</span>
                <span class="s1">Logger</span><span class="s3">.</span><span class="s1">exception</span><span class="s3">(</span><span class="s4">'Error while activating FileHandler logger'</span><span class="s3">)</span>
                <span class="s2">return</span>
            <span class="s2">while </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">history</span><span class="s3">:</span>
                <span class="s1">_message </span><span class="s3">= </span><span class="s1">FileHandler</span><span class="s3">.</span><span class="s1">history</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_message</span><span class="s3">(</span><span class="s1">_message</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_message</span><span class="s3">(</span><span class="s1">message</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">LoggerHistory</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">Handler</span><span class="s3">):</span>

    <span class="s1">history </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">emit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">message</span><span class="s3">):</span>
        <span class="s1">LoggerHistory</span><span class="s3">.</span><span class="s1">history </span><span class="s3">= [</span><span class="s1">message</span><span class="s3">] + </span><span class="s1">LoggerHistory</span><span class="s3">.</span><span class="s1">history</span><span class="s3">[:</span><span class="s5">100</span><span class="s3">]</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">clear_history</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">del </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">history</span><span class="s3">[:]</span>

    <span class="s2">def </span><span class="s1">flush</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">(</span><span class="s1">LoggerHistory</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">flush</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">clear_history</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">ConsoleHandler</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">StreamHandler</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
        Emits records to a stream (by default, stderr). 
 
        However, if the msg starts with &quot;stderr:&quot; it is not formatted, but 
        written straight to the stream. 
 
        .. versionadded:: 2.2.0 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">filter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">record</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s1">record</span><span class="s3">.</span><span class="s1">msg</span>
            <span class="s1">k </span><span class="s3">= </span><span class="s1">msg</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">':'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">k</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">'stderr' </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">k</span><span class="s3">) == </span><span class="s5">2</span><span class="s3">:</span>
                <span class="s6"># This message was scraped from stderr.</span>
                <span class="s6"># Emit it without formatting.</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">k</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
                <span class="s6"># Don't pass it to the formatted emitter.</span>
                <span class="s2">return False</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s2">return True</span>


<span class="s2">class </span><span class="s1">ProcessingStream</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
        Stream-like object that takes each completed line written to it, 
        adds a given prefix, and applies the given function to it. 
 
        .. versionadded:: 2.2.0 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">channel</span><span class="s3">, </span><span class="s1">func</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">buffer </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">func </span><span class="s3">= </span><span class="s1">func</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">channel </span><span class="s3">= </span><span class="s1">channel</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">errors </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">s</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">buffer </span><span class="s3">+ </span><span class="s1">s</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">func</span>
        <span class="s1">channel </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">channel</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">lines</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]:</span>
            <span class="s1">f</span><span class="s3">(</span><span class="s4">'%s: %s' </span><span class="s3">% (</span><span class="s1">channel</span><span class="s3">, </span><span class="s1">line</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">buffer </span><span class="s3">= </span><span class="s1">lines</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">flush</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return</span>

    <span class="s2">def </span><span class="s1">isatty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return False</span>


<span class="s2">def </span><span class="s1">logger_config_update</span><span class="s3">(</span><span class="s1">section</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">KIVY_LOG_MODE </span><span class="s3">!= </span><span class="s4">&quot;PYTHON&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">LOG_LEVELS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">value</span><span class="s3">) </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">AttributeError</span><span class="s3">(</span><span class="s4">'Loglevel {0!r} doesn</span><span class="s2">\'</span><span class="s4">t exists'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span>
        <span class="s1">Logger</span><span class="s3">.</span><span class="s1">setLevel</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s1">LOG_LEVELS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">ColonSplittingLogRecord</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">LogRecord</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Clones an existing logRecord, but reformats the message field 
    if it contains a colon. 
 
    .. versionadded:: 2.2.0 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">logrecord</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">parts </span><span class="s3">= </span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;:&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">) == </span><span class="s5">2</span><span class="s3">:</span>
                <span class="s1">new_msg </span><span class="s3">= </span><span class="s4">&quot;[%-12s]%s&quot; </span><span class="s3">% (</span><span class="s1">parts</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">parts</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">new_msg </span><span class="s3">= </span><span class="s1">parts</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s1">new_msg </span><span class="s3">= </span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">msg</span>

        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
            <span class="s1">level</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">levelno</span><span class="s3">,</span>
            <span class="s1">pathname</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">pathname</span><span class="s3">,</span>
            <span class="s1">lineno</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">,</span>
            <span class="s1">msg</span><span class="s3">=</span><span class="s1">new_msg</span><span class="s3">,</span>
            <span class="s1">args</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">args</span><span class="s3">,</span>
            <span class="s1">exc_info</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">exc_info</span><span class="s3">,</span>
            <span class="s1">func</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">funcName</span><span class="s3">,</span>
            <span class="s1">sinfo</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">stack_info</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">class </span><span class="s1">ColoredLogRecord</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">LogRecord</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Clones an existing logRecord, but reformats the levelname to add 
    color, and the message to add bolding (where indicated by $BOLD 
    and $RESET in the message). 
 
    .. versionadded:: 2.2.0&quot;&quot;&quot;</span>

    <span class="s1">BLACK </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s1">RED </span><span class="s3">= </span><span class="s5">1</span>
    <span class="s1">GREEN </span><span class="s3">= </span><span class="s5">2</span>
    <span class="s1">YELLOW </span><span class="s3">= </span><span class="s5">3</span>
    <span class="s1">BLUE </span><span class="s3">= </span><span class="s5">4</span>
    <span class="s1">MAGENTA </span><span class="s3">= </span><span class="s5">5</span>
    <span class="s1">CYAN </span><span class="s3">= </span><span class="s5">6</span>
    <span class="s1">WHITE </span><span class="s3">= </span><span class="s5">7</span>
    <span class="s1">RESET_SEQ </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\033</span><span class="s4">[0m&quot;</span>
    <span class="s1">COLOR_SEQ </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\033</span><span class="s4">[1;%dm&quot;</span>
    <span class="s1">BOLD_SEQ </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\033</span><span class="s4">[1m&quot;</span>

    <span class="s1">LEVEL_COLORS </span><span class="s3">= {</span>
        <span class="s4">&quot;TRACE&quot;</span><span class="s3">: </span><span class="s1">MAGENTA</span><span class="s3">,</span>
        <span class="s4">&quot;WARNING&quot;</span><span class="s3">: </span><span class="s1">YELLOW</span><span class="s3">,</span>
        <span class="s4">&quot;INFO&quot;</span><span class="s3">: </span><span class="s1">GREEN</span><span class="s3">,</span>
        <span class="s4">&quot;DEBUG&quot;</span><span class="s3">: </span><span class="s1">CYAN</span><span class="s3">,</span>
        <span class="s4">&quot;CRITICAL&quot;</span><span class="s3">: </span><span class="s1">RED</span><span class="s3">,</span>
        <span class="s4">&quot;ERROR&quot;</span><span class="s3">: </span><span class="s1">RED</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">_format_message</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">message</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">message</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span>
            <span class="s4">&quot;$RESET&quot;</span><span class="s3">, </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">RESET_SEQ</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;$BOLD&quot;</span><span class="s3">, </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">BOLD_SEQ</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">_format_levelname</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">levelname</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">levelname </span><span class="s2">in </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">LEVEL_COLORS</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">(</span>
                <span class="s1">cls</span><span class="s3">.</span><span class="s1">COLOR_SEQ </span><span class="s3">% (</span><span class="s5">30 </span><span class="s3">+ </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">LEVEL_COLORS</span><span class="s3">[</span><span class="s1">levelname</span><span class="s3">])</span>
                <span class="s3">+ </span><span class="s1">levelname</span>
                <span class="s3">+ </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">RESET_SEQ</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">levelname</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">logrecord</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
            <span class="s1">level</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">levelno</span><span class="s3">,</span>
            <span class="s1">pathname</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">pathname</span><span class="s3">,</span>
            <span class="s1">lineno</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">,</span>
            <span class="s1">msg</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">,</span>
            <span class="s1">args</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">args</span><span class="s3">,</span>
            <span class="s1">exc_info</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">exc_info</span><span class="s3">,</span>
            <span class="s1">func</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">funcName</span><span class="s3">,</span>
            <span class="s1">sinfo</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">stack_info</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">levelname </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_levelname</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">levelname</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_message</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s6"># Included for backward compatibility only.</span>
<span class="s6"># Could be used to override colors.</span>
<span class="s1">COLORS </span><span class="s3">= </span><span class="s1">ColoredLogRecord</span><span class="s3">.</span><span class="s1">LEVEL_COLORS</span>


<span class="s2">class </span><span class="s1">UncoloredLogRecord</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">LogRecord</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Clones an existing logRecord, but reformats the message 
    to remove $BOLD/$RESET markup. 
 
    .. versionadded:: 2.2.0&quot;&quot;&quot;</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">_format_message</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">message</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">message</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;$RESET&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;$BOLD&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">logrecord</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
            <span class="s1">level</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">levelno</span><span class="s3">,</span>
            <span class="s1">pathname</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">pathname</span><span class="s3">,</span>
            <span class="s1">lineno</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">,</span>
            <span class="s1">msg</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">,</span>
            <span class="s1">args</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">args</span><span class="s3">,</span>
            <span class="s1">exc_info</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">exc_info</span><span class="s3">,</span>
            <span class="s1">func</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">funcName</span><span class="s3">,</span>
            <span class="s1">sinfo</span><span class="s3">=</span><span class="s1">logrecord</span><span class="s3">.</span><span class="s1">stack_info</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_message</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">KivyFormatter</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">Formatter</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Split out first field in message marked with a colon, 
    and either apply terminal color codes to the record, or strip 
    out color markup if colored logging is not available. 
 
    .. versionadded:: 2.2.0&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, </span><span class="s1">use_color</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_coloring_cls </span><span class="s3">= (</span>
            <span class="s1">ColoredLogRecord </span><span class="s2">if </span><span class="s1">use_color </span><span class="s2">else </span><span class="s1">UncoloredLogRecord</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">record</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">format</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_coloring_cls</span><span class="s3">(</span><span class="s1">ColonSplittingLogRecord</span><span class="s3">(</span><span class="s1">record</span><span class="s3">)))</span>


<span class="s2">def </span><span class="s1">is_color_terminal</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot; Detect whether the environment supports color codes in output. 
 
    .. versionadded:: 2.2.0 
    &quot;&quot;&quot;</span>

    <span class="s2">return </span><span class="s3">(</span>
            <span class="s3">(</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;WT_SESSION&quot;</span><span class="s3">) </span><span class="s2">or</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;COLORTERM&quot;</span><span class="s3">) == </span><span class="s4">'truecolor' </span><span class="s2">or</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'PYCHARM_HOSTED'</span><span class="s3">) == </span><span class="s4">'1' </span><span class="s2">or</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'TERM'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">(</span>
                        <span class="s4">'rxvt'</span><span class="s3">,</span>
                        <span class="s4">'rxvt-256color'</span><span class="s3">,</span>
                        <span class="s4">'rxvt-unicode'</span><span class="s3">,</span>
                        <span class="s4">'rxvt-unicode-256color'</span><span class="s3">,</span>
                        <span class="s4">'xterm'</span><span class="s3">,</span>
                        <span class="s4">'xterm-256color'</span><span class="s3">,</span>
                    <span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s2">and </span><span class="s1">platform </span><span class="s2">not in </span><span class="s3">(</span><span class="s4">'android'</span><span class="s3">, </span><span class="s4">'ios'</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s6">#: Kivy default logger instance</span>
<span class="s6"># .. versionchanged:: 2.2.0</span>
<span class="s1">Logger </span><span class="s3">= </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">getLogger</span><span class="s3">(</span><span class="s4">'kivy'</span><span class="s3">)</span>
<span class="s1">Logger</span><span class="s3">.</span><span class="s1">logfile_activated </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">Logger</span><span class="s3">.</span><span class="s1">trace </span><span class="s3">= </span><span class="s1">partial</span><span class="s3">(</span><span class="s1">Logger</span><span class="s3">.</span><span class="s1">log</span><span class="s3">, </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">TRACE</span><span class="s3">)</span>

<span class="s1">file_log_handler </span><span class="s3">= (</span>
    <span class="s1">FileHandler</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s4">'KIVY_NO_FILELOG' </span><span class="s2">not in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span>
    <span class="s2">else None</span>
<span class="s3">)</span>


<span class="s6"># Issue #7891 describes an undocumented feature that was since removed</span>
<span class="s6"># Detect if a client was depending on it.</span>
<span class="s6"># .. versionchanged:: 2.2.0</span>
<span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">, </span><span class="s4">'_kivy_logging_handler'</span><span class="s3">), </span><span class="s1">\</span>
    <span class="s4">&quot;Not supported. Try logging.root.addHandler()&quot;</span>


<span class="s2">def </span><span class="s1">add_kivy_handlers</span><span class="s3">(</span><span class="s1">logger</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; Add Kivy-specific handlers to a logger. 
 
    .. versionadded:: 2.2.0 
    &quot;&quot;&quot;</span>
    <span class="s6"># add default kivy logger</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">addHandler</span><span class="s3">(</span><span class="s1">LoggerHistory</span><span class="s3">())</span>
    <span class="s2">if </span><span class="s1">file_log_handler</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">addHandler</span><span class="s3">(</span><span class="s1">file_log_handler</span><span class="s3">)</span>

    <span class="s6"># Use the custom handler instead of streaming one.</span>
    <span class="s6"># Don't output to stderr if it is set to None</span>
    <span class="s6"># stderr is set to None by pythonw and pyinstaller 5.7+</span>
    <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">stderr </span><span class="s2">and </span><span class="s4">'KIVY_NO_CONSOLELOG' </span><span class="s2">not in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">:</span>
        <span class="s1">use_color </span><span class="s3">= </span><span class="s1">is_color_terminal</span><span class="s3">()</span>
        <span class="s2">if not </span><span class="s1">use_color</span><span class="s3">:</span>
            <span class="s6"># No additional control characters will be inserted inside the</span>
            <span class="s6"># levelname field, 7 chars will fit &quot;WARNING&quot;</span>
            <span class="s1">fmt </span><span class="s3">= </span><span class="s4">&quot;[%(levelname)-7s] %(message)s&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s6"># levelname field width need to take into account the length of</span>
            <span class="s6"># the color control codes (7+4 chars for bold+color, and reset)</span>
            <span class="s1">fmt </span><span class="s3">= </span><span class="s4">&quot;[%(levelname)-18s] %(message)s&quot;</span>
        <span class="s1">formatter </span><span class="s3">= </span><span class="s1">KivyFormatter</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">, </span><span class="s1">use_color</span><span class="s3">=</span><span class="s1">use_color</span><span class="s3">)</span>
        <span class="s1">console </span><span class="s3">= </span><span class="s1">ConsoleHandler</span><span class="s3">()</span>
        <span class="s1">console</span><span class="s3">.</span><span class="s1">setFormatter</span><span class="s3">(</span><span class="s1">formatter</span><span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">addHandler</span><span class="s3">(</span><span class="s1">console</span><span class="s3">)</span>


<span class="s1">KIVY_LOG_MODE </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;KIVY_LOG_MODE&quot;</span><span class="s3">, </span><span class="s4">&quot;KIVY&quot;</span><span class="s3">)</span>
<span class="s2">assert </span><span class="s1">KIVY_LOG_MODE </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;KIVY&quot;</span><span class="s3">, </span><span class="s4">&quot;PYTHON&quot;</span><span class="s3">, </span><span class="s4">&quot;MIXED&quot;</span><span class="s3">), </span><span class="s4">&quot;Unknown log mode&quot;</span>

<span class="s2">if </span><span class="s1">KIVY_LOG_MODE </span><span class="s3">== </span><span class="s4">&quot;KIVY&quot;</span><span class="s3">:</span>
    <span class="s6"># Add the Kivy handlers to the root logger, so they will be used</span>
    <span class="s6"># for all propagated log messages.</span>
    <span class="s1">add_kivy_handlers</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">root</span><span class="s3">)</span>

    <span class="s6"># Root logger defaults to warning. Let Logger be the limiting factor.</span>
    <span class="s1">logging</span><span class="s3">.</span><span class="s1">root</span><span class="s3">.</span><span class="s1">setLevel</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">NOTSET</span><span class="s3">)</span>

    <span class="s6"># install stderr handlers</span>

    <span class="s6"># Caution: If any logging handlers output to sys.stderr they should be</span>
    <span class="s6"># configured BEFORE this reconfiguration is done to avoid loops.</span>
    <span class="s1">sys</span><span class="s3">.</span><span class="s1">stderr </span><span class="s3">= </span><span class="s1">ProcessingStream</span><span class="s3">(</span><span class="s4">&quot;stderr&quot;</span><span class="s3">, </span><span class="s1">Logger</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">)</span>
    <span class="s6"># Sends all messages written to stderr to the Logger, after prefixing it</span>
    <span class="s6"># with &quot;stderr:&quot;</span>
<span class="s2">elif </span><span class="s1">KIVY_LOG_MODE </span><span class="s3">== </span><span class="s4">&quot;MIXED&quot;</span><span class="s3">:</span>
    <span class="s6"># Add the Kivy handlers to the Kivy logger, so they will be used</span>
    <span class="s6"># for all messages sent through Logger, only.</span>
    <span class="s1">add_kivy_handlers</span><span class="s3">(</span><span class="s1">Logger</span><span class="s3">)</span>

    <span class="s6"># Don't spread Kivy-related log messages to the root logger.</span>
    <span class="s1">Logger</span><span class="s3">.</span><span class="s1">propagate </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s6"># Don't set stderr redirection: it is too likely to cause loops with other</span>
    <span class="s6"># handlers. Client can manually add it, if desired.</span>
<span class="s2">else</span><span class="s3">:  </span><span class="s6"># KIVY_LOG_MODE == &quot;PYTHON&quot;</span>
    <span class="s6"># Don't add handlers or redirect stderr. Client can manually add if desired.</span>
    <span class="s2">pass</span>
</pre>
</body>
</html>