<html>
<head>
<title>urlrequest.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
urlrequest.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
UrlRequest 
========== 
 
.. versionadded:: 1.0.8 
 
You can use the :class:`UrlRequest` to make asynchronous requests on the 
web and get the result when the request is completed. The spirit is the 
same as the XHR object in Javascript. 
 
The content is also decoded if the Content-Type is 
application/json and the result automatically passed through json.loads. 
 
 
The syntax to create a request:: 
 
    from kivy.network.urlrequest import UrlRequest 
    req = UrlRequest(url, on_success, on_redirect, on_failure, on_error, 
                     on_progress, req_body, req_headers, chunk_size, 
                     timeout, method, decode, debug, file_path, ca_file, 
                     verify) 
 
 
Only the first argument is mandatory: the rest are optional. 
By default, a &quot;GET&quot; request will be sent. If the :attr:`UrlRequest.req_body` is 
not None, a &quot;POST&quot; request will be sent. It's up to you to adjust 
:attr:`UrlRequest.req_headers` to suit your requirements and the response 
to the request will be accessible as the parameter called &quot;result&quot; on 
the callback function of the on_success event. 
 
 
Example of fetching JSON:: 
 
    def got_json(req, result): 
        for key, value in req.resp_headers.items(): 
            print('{}: {}'.format(key, value)) 
 
    req = UrlRequest('https://httpbin.org/headers', got_json) 
 
Example of Posting data (adapted from httplib example):: 
 
    import urllib 
 
    def bug_posted(req, result): 
        print('Our bug is posted!') 
        print(result) 
 
    params = urllib.urlencode({'@number': 12524, '@type': 'issue', 
        '@action': 'show'}) 
    headers = {'Content-type': 'application/x-www-form-urlencoded', 
              'Accept': 'text/plain'} 
    req = UrlRequest('bugs.python.org', on_success=bug_posted, req_body=params, 
            req_headers=headers) 
 
If you want a synchronous request, you can call the wait() method. 
 
'''</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">base64 </span><span class="s2">import </span><span class="s1">b64encode</span>
<span class="s2">from </span><span class="s1">collections </span><span class="s2">import </span><span class="s1">deque</span>
<span class="s2">from </span><span class="s1">http</span><span class="s3">.</span><span class="s1">client </span><span class="s2">import </span><span class="s1">HTTPConnection</span>
<span class="s2">from </span><span class="s1">json </span><span class="s2">import </span><span class="s1">loads</span>
<span class="s2">from </span><span class="s1">threading </span><span class="s2">import </span><span class="s1">Event</span><span class="s3">, </span><span class="s1">Thread</span>
<span class="s2">from </span><span class="s1">time </span><span class="s2">import </span><span class="s1">sleep</span>
<span class="s2">from </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse </span><span class="s2">import </span><span class="s1">urlparse</span><span class="s3">, </span><span class="s1">urlunparse</span>

<span class="s2">import </span><span class="s1">requests</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">clock </span><span class="s2">import </span><span class="s1">Clock</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">Logger</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">platform</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">weakmethod </span><span class="s2">import </span><span class="s1">WeakMethod</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">ssl</span>

    <span class="s1">HTTPSConnection </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">from </span><span class="s1">http</span><span class="s3">.</span><span class="s1">client </span><span class="s2">import </span><span class="s1">HTTPSConnection</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s4"># depending the platform, if openssl support wasn't compiled before python,</span>
    <span class="s4"># this class is not available.</span>
    <span class="s2">pass</span>


<span class="s4"># list to save UrlRequest and prevent GC on un-referenced objects</span>
<span class="s1">g_requests </span><span class="s3">= []</span>


<span class="s2">class </span><span class="s1">UrlRequestBase</span><span class="s3">(</span><span class="s1">Thread</span><span class="s3">):</span>
    <span class="s0">'''A UrlRequest. See module documentation for usage. 
 
    .. versionchanged:: 1.5.1 
        Add `debug` parameter 
 
    .. versionchanged:: 1.0.10 
        Add `method` parameter 
 
    .. versionchanged:: 1.8.0 
 
        Parameter `decode` added. 
        Parameter `file_path` added. 
        Parameter `on_redirect` added. 
        Parameter `on_failure` added. 
 
    .. versionchanged:: 1.9.1 
 
        Parameter `ca_file` added. 
        Parameter `verify` added. 
 
    .. versionchanged:: 1.10.0 
 
        Parameters `proxy_host`, `proxy_port` and `proxy_headers` added. 
 
    .. versionchanged:: 1.11.0 
 
        Parameters `on_cancel` added. 
 
    .. versionchanged:: 2.2.0 
 
        Parameters `on_finish` added. 
        Parameters `auth` added. 
 
    :Parameters: 
        `url`: str 
            Complete url string to call. 
        `on_success`: callback(request, result) 
            Callback function to call when the result has been fetched. 
        `on_redirect`: callback(request, result) 
            Callback function to call if the server returns a Redirect. 
        `on_failure`: callback(request, result) 
            Callback function to call if the server returns a Client or 
            Server Error. 
        `on_error`: callback(request, error) 
            Callback function to call if an error occurs. 
        `on_progress`: callback(request, current_size, total_size) 
            Callback function that will be called to report progression of the 
            download. `total_size` might be -1 if no Content-Length has been 
            reported in the http response. 
            This callback will be called after each `chunk_size` is read. 
        `on_cancel`: callback(request) 
            Callback function to call if user requested to cancel the download 
            operation via the .cancel() method. 
        `on_finish`: callback(request) 
            Additional callback function to call if request is done. 
        `req_body`: str, defaults to None 
            Data to sent in the request. If it's not None, a POST will be done 
            instead of a GET. 
        `req_headers`: dict, defaults to None 
            Custom headers to add to the request. 
        `chunk_size`: int, defaults to 8192 
            Size of each chunk to read, used only when `on_progress` callback 
            has been set. If you decrease it too much, a lot of on_progress 
            callbacks will be fired and will slow down your download. If you 
            want to have the maximum download speed, increase the chunk_size 
            or don't use ``on_progress``. 
        `timeout`: int, defaults to None 
            If set, blocking operations will timeout after this many seconds. 
        `method`: str, defaults to 'GET' (or 'POST' if ``body`` is specified) 
            The HTTP method to use. 
        `decode`: bool, defaults to True 
            If False, skip decoding of the response. 
        `debug`: bool, defaults to False 
            If True, it will use the Logger.debug to print information 
            about url access/progression/errors. 
        `file_path`: str, defaults to None 
            If set, the result of the UrlRequest will be written to this path 
            instead of in memory. 
        `ca_file`: str, defaults to None 
            Indicates a SSL CA certificate file path to validate HTTPS 
            certificates against 
        `verify`: bool, defaults to True 
            If False, disables SSL CA certificate verification 
        `proxy_host`: str, defaults to None 
            If set, the proxy host to use for this connection. 
        `proxy_port`: int, defaults to None 
            If set, and `proxy_host` is also set, the port to use for 
            connecting to the proxy server. 
        `proxy_headers`: dict, defaults to None 
            If set, and `proxy_host` is also set, the headers to send to the 
            proxy server in the ``CONNECT`` request. 
        `auth`: HTTPBasicAuth, defaults to None 
            If set, request will use basicauth to authenticate. 
            Only used in &quot;Requests&quot; implementation 
    '''</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">on_success</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">on_redirect</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">on_failure</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">on_error</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">on_progress</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">req_body</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">req_headers</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">=</span><span class="s5">8192</span><span class="s3">,</span>
        <span class="s1">timeout</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">decode</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">debug</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">file_path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">ca_file</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">verify</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">proxy_host</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">proxy_port</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">proxy_headers</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">user_agent</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">on_cancel</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">on_finish</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cookies</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">auth</span><span class="s3">=</span><span class="s2">None</span>
    <span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_queue </span><span class="s3">= </span><span class="s1">deque</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_result </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_dispatch_result</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">daemon </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">on_success </span><span class="s3">= </span><span class="s1">WeakMethod</span><span class="s3">(</span><span class="s1">on_success</span><span class="s3">) </span><span class="s2">if </span><span class="s1">on_success </span><span class="s2">else None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">on_redirect </span><span class="s3">= </span><span class="s1">WeakMethod</span><span class="s3">(</span><span class="s1">on_redirect</span><span class="s3">) </span><span class="s2">if </span><span class="s1">on_redirect </span><span class="s2">else None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">on_failure </span><span class="s3">= </span><span class="s1">WeakMethod</span><span class="s3">(</span><span class="s1">on_failure</span><span class="s3">) </span><span class="s2">if </span><span class="s1">on_failure </span><span class="s2">else None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">on_error </span><span class="s3">= </span><span class="s1">WeakMethod</span><span class="s3">(</span><span class="s1">on_error</span><span class="s3">) </span><span class="s2">if </span><span class="s1">on_error </span><span class="s2">else None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">on_progress </span><span class="s3">= </span><span class="s1">WeakMethod</span><span class="s3">(</span><span class="s1">on_progress</span><span class="s3">) </span><span class="s2">if </span><span class="s1">on_progress </span><span class="s2">else None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">on_cancel </span><span class="s3">= </span><span class="s1">WeakMethod</span><span class="s3">(</span><span class="s1">on_cancel</span><span class="s3">) </span><span class="s2">if </span><span class="s1">on_cancel </span><span class="s2">else None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">on_finish </span><span class="s3">= </span><span class="s1">WeakMethod</span><span class="s3">(</span><span class="s1">on_finish</span><span class="s3">) </span><span class="s2">if </span><span class="s1">on_finish </span><span class="s2">else None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">decode </span><span class="s3">= </span><span class="s1">decode</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">file_path </span><span class="s3">= </span><span class="s1">file_path</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_debug </span><span class="s3">= </span><span class="s1">debug</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_result </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_error </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_is_finished </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resp_status </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resp_headers </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resp_length </span><span class="s3">= -</span><span class="s5">1</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_chunk_size </span><span class="s3">= </span><span class="s1">chunk_size</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_timeout </span><span class="s3">= </span><span class="s1">timeout</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_method </span><span class="s3">= </span><span class="s1">method</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">verify </span><span class="s3">= </span><span class="s1">verify</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_host </span><span class="s3">= </span><span class="s1">proxy_host</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_port </span><span class="s3">= </span><span class="s1">proxy_port</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_headers </span><span class="s3">= </span><span class="s1">proxy_headers</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_event </span><span class="s3">= </span><span class="s1">Event</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_user_agent </span><span class="s3">= </span><span class="s1">user_agent</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cookies </span><span class="s3">= </span><span class="s1">cookies</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_requested_url </span><span class="s3">= </span><span class="s1">url</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_auth </span><span class="s3">= </span><span class="s1">auth</span>

        <span class="s2">if </span><span class="s1">platform </span><span class="s2">in </span><span class="s3">[</span><span class="s6">'android'</span><span class="s3">, </span><span class="s6">'ios'</span><span class="s3">]:</span>
            <span class="s2">import </span><span class="s1">certifi</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">ca_file </span><span class="s3">= </span><span class="s1">ca_file </span><span class="s2">or </span><span class="s1">certifi</span><span class="s3">.</span><span class="s1">where</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">ca_file </span><span class="s3">= </span><span class="s1">ca_file</span>

        <span class="s4">#: Url of the request</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">url </span><span class="s3">= </span><span class="s1">url</span>

        <span class="s4">#: Request body passed in __init__</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">req_body </span><span class="s3">= </span><span class="s1">req_body</span>

        <span class="s4">#: Request headers passed in __init__</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">req_headers </span><span class="s3">= </span><span class="s1">req_headers</span>

        <span class="s4"># save our request to prevent GC</span>
        <span class="s1">g_requests</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">start</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">q </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_queue</span><span class="s3">.</span><span class="s1">appendleft</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">url</span>
        <span class="s1">req_body </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">req_body</span>
        <span class="s1">req_headers </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">req_headers </span><span class="s2">or </span><span class="s3">{}</span>

        <span class="s1">user_agent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_user_agent</span>
        <span class="s1">cookies </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cookies</span>

        <span class="s2">if </span><span class="s1">user_agent</span><span class="s3">:</span>
            <span class="s1">req_headers</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s6">'User-Agent'</span><span class="s3">, </span><span class="s1">user_agent</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s3">(</span>
            <span class="s1">Config</span><span class="s3">.</span><span class="s1">has_section</span><span class="s3">(</span><span class="s6">'network'</span><span class="s3">)</span>
            <span class="s2">and </span><span class="s6">'useragent' </span><span class="s2">in </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">items</span><span class="s3">(</span><span class="s6">'network'</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s1">useragent </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">'network'</span><span class="s3">, </span><span class="s6">'useragent'</span><span class="s3">)</span>
            <span class="s1">req_headers</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s6">'User-Agent'</span><span class="s3">, </span><span class="s1">useragent</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">cookies</span><span class="s3">:</span>
            <span class="s1">req_headers</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s6">&quot;Cookie&quot;</span><span class="s3">, </span><span class="s1">cookies</span><span class="s3">)</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">result</span><span class="s3">, </span><span class="s1">resp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fetch_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">req_body</span><span class="s3">, </span><span class="s1">req_headers</span><span class="s3">, </span><span class="s1">q</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">:</span>
                <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">decode_result</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">q</span><span class="s3">((</span><span class="s6">'error'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">e</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_event</span><span class="s3">.</span><span class="s1">is_set</span><span class="s3">():</span>
                <span class="s1">q</span><span class="s3">((</span><span class="s6">'success'</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, </span><span class="s1">result</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">q</span><span class="s3">((</span><span class="s6">'killed'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

        <span class="s4"># using trigger can result in a missed on_success event</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_result</span><span class="s3">()</span>

        <span class="s4"># clean ourself when the queue is empty</span>
        <span class="s2">while </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_queue</span><span class="s3">):</span>
            <span class="s1">sleep</span><span class="s3">(</span><span class="s5">.1</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_result</span><span class="s3">()</span>

        <span class="s4"># ok, authorize the GC to clean us.</span>
        <span class="s2">if </span><span class="s1">self </span><span class="s2">in </span><span class="s1">g_requests</span><span class="s3">:</span>
            <span class="s1">g_requests</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_fetch_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">body</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">, </span><span class="s1">q</span><span class="s3">):</span>
        <span class="s4"># Parse and fetch the current url</span>
        <span class="s1">trigger </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_result</span>
        <span class="s1">chunk_size </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_chunk_size</span>
        <span class="s1">report_progress </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_progress </span><span class="s2">is not None</span>
        <span class="s1">file_path </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">file_path</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
            <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: {0} Fetch url &lt;{1}&gt;'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">url</span><span class="s3">))</span>
            <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: {0} - body: {1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">body</span><span class="s3">))</span>
            <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: {0} - headers: {1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">headers</span><span class="s3">))</span>

        <span class="s1">req</span><span class="s3">, </span><span class="s1">resp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">call_request</span><span class="s3">(</span><span class="s1">body</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">)</span>

        <span class="s4"># read content</span>
        <span class="s2">if </span><span class="s1">report_progress </span><span class="s2">or </span><span class="s1">file_path </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">total_size </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_total_size</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">)</span>

            <span class="s4"># before starting the download, send a fake progress to permit the</span>
            <span class="s4"># user to initialize his ui</span>
            <span class="s2">if </span><span class="s1">report_progress</span><span class="s3">:</span>
                <span class="s1">q</span><span class="s3">((</span><span class="s6">'progress'</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">)))</span>

            <span class="s2">if </span><span class="s1">file_path </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file_path</span><span class="s3">, </span><span class="s6">'wb'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fd</span><span class="s3">:</span>
                    <span class="s1">bytes_so_far</span><span class="s3">, </span><span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_chunks</span><span class="s3">(</span>
                        <span class="s1">resp</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">, </span><span class="s1">report_progress</span><span class="s3">, </span><span class="s1">q</span><span class="s3">,</span>
                        <span class="s1">trigger</span><span class="s3">, </span><span class="s1">fd</span><span class="s3">=</span><span class="s1">fd</span>
                    <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">bytes_so_far</span><span class="s3">, </span><span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_chunks</span><span class="s3">(</span>
                    <span class="s1">resp</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">, </span><span class="s1">report_progress</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">trigger</span>
                <span class="s3">)</span>

            <span class="s4"># ensure that results are dispatched for the last chunk,</span>
            <span class="s4"># avoid trigger</span>
            <span class="s2">if </span><span class="s1">report_progress</span><span class="s3">:</span>
                <span class="s1">q</span><span class="s3">((</span><span class="s6">'progress'</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, (</span><span class="s1">bytes_so_far</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">)))</span>
                <span class="s1">trigger</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_response</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                    <span class="s1">result </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">'utf-8'</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">UnicodeDecodeError</span><span class="s3">:</span>
                <span class="s4"># if it's an image? decoding would not work</span>
                <span class="s2">pass</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">close_connection</span><span class="s3">(</span><span class="s1">req</span><span class="s3">)</span>

        <span class="s4"># return everything</span>
        <span class="s2">return </span><span class="s1">result</span><span class="s3">, </span><span class="s1">resp</span>

    <span class="s2">def </span><span class="s1">decode_result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s0">'''Decode the result fetched from url according to his Content-Type. 
        Currently supports only application/json. 
        '''</span>
        <span class="s4"># Entry to decode url from the content type.</span>
        <span class="s4"># For example, if the content type is a json, it will be automatically</span>
        <span class="s4"># decoded.</span>
        <span class="s1">content_type </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_content_type</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">content_type </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">ct </span><span class="s3">= </span><span class="s1">content_type</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s6">';'</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">ct </span><span class="s3">== </span><span class="s6">'application/json'</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                    <span class="s1">result </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">'utf-8'</span><span class="s3">)</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s1">loads</span><span class="s3">(</span><span class="s1">result</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s1">result</span>

        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">_dispatch_result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">):</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s4"># Read the result pushed on the queue, and dispatch to the client</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">result</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_queue</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
                <span class="s2">return</span>

            <span class="s2">if </span><span class="s1">resp</span><span class="s3">:</span>
                <span class="s4"># Small workaround in order to prevent the situation mentioned</span>
                <span class="s4"># in the comment below</span>
                <span class="s1">final_cookies </span><span class="s3">= </span><span class="s6">&quot;&quot;</span>
                <span class="s1">parsed_headers </span><span class="s3">= []</span>
                <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_all_headers</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">):</span>
                    <span class="s2">if </span><span class="s1">key </span><span class="s3">== </span><span class="s6">&quot;Set-Cookie&quot;</span><span class="s3">:</span>
                        <span class="s1">final_cookies </span><span class="s3">+= </span><span class="s6">&quot;{};&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">parsed_headers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">))</span>
                <span class="s1">parsed_headers</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s6">&quot;Set-Cookie&quot;</span><span class="s3">, </span><span class="s1">final_cookies</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]))</span>

                <span class="s4"># XXX usage of dict can be dangerous if multiple headers</span>
                <span class="s4"># are set even if it's invalid. But it look like it's ok</span>
                <span class="s4"># ?  http://stackoverflow.com/questions/2454494/..</span>
                <span class="s4"># ..urllib2-multiple-set-cookie-headers-in-response</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_resp_headers </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">parsed_headers</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_resp_status </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_status_code</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">result </span><span class="s3">== </span><span class="s6">'success'</span><span class="s3">:</span>
                <span class="s1">status_class </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_status_code</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">) // </span><span class="s5">100</span>

                <span class="s2">if </span><span class="s1">status_class </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">):</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
                        <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                            <span class="s6">'UrlRequest: {0} Download finished with '</span>
                            <span class="s6">'{1} datalen'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">data</span><span class="s3">)</span>
                        <span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_is_finished </span><span class="s3">= </span><span class="s2">True</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_result </span><span class="s3">= </span><span class="s1">data</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_success</span><span class="s3">:</span>
                        <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_success</span><span class="s3">()</span>
                        <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
                            <span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

                <span class="s2">elif </span><span class="s1">status_class </span><span class="s3">== </span><span class="s5">3</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
                        <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: {} Download '</span>
                                     <span class="s6">'redirected'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)))</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_is_finished </span><span class="s3">= </span><span class="s2">True</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_result </span><span class="s3">= </span><span class="s1">data</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_redirect</span><span class="s3">:</span>
                        <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_redirect</span><span class="s3">()</span>
                        <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
                            <span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

                <span class="s2">elif </span><span class="s1">status_class </span><span class="s2">in </span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">):</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
                        <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                            <span class="s6">'UrlRequest: {} Download failed with '</span>
                            <span class="s6">'http error {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                                <span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">),</span>
                                <span class="s1">self</span><span class="s3">.</span><span class="s1">get_status_code</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">)</span>
                            <span class="s3">)</span>
                        <span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_is_finished </span><span class="s3">= </span><span class="s2">True</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_result </span><span class="s3">= </span><span class="s1">data</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_failure</span><span class="s3">:</span>
                        <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_failure</span><span class="s3">()</span>
                        <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
                            <span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

            <span class="s2">elif </span><span class="s1">result </span><span class="s3">== </span><span class="s6">'error'</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
                    <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: {0} Download error '</span>
                                 <span class="s6">'&lt;{1}&gt;'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">data</span><span class="s3">))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_is_finished </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_error </span><span class="s3">= </span><span class="s1">data</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_error</span><span class="s3">:</span>
                    <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_error</span><span class="s3">()</span>
                    <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
                        <span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

            <span class="s2">elif </span><span class="s1">result </span><span class="s3">== </span><span class="s6">'progress'</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
                    <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: {0} Download progress '</span>
                                 <span class="s6">'{1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">data</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_progress</span><span class="s3">:</span>
                    <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_progress</span><span class="s3">()</span>
                    <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
                        <span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">data</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>

            <span class="s2">elif </span><span class="s1">result </span><span class="s3">== </span><span class="s6">'killed'</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
                    <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: Cancelled by user'</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_cancel</span><span class="s3">:</span>
                    <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_cancel</span><span class="s3">()</span>
                    <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
                        <span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s5">0</span>

            <span class="s2">if </span><span class="s1">result </span><span class="s3">!= </span><span class="s6">&quot;progress&quot; </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_finish</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_debug</span><span class="s3">:</span>
                    <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: Request is finished'</span><span class="s3">)</span>
                <span class="s1">func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">on_finish</span><span class="s3">()</span>
                <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
                    <span class="s1">func</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">is_finished</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Return True if the request has finished, whether it's a 
        success or a failure. 
        '''</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_finished</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Return the result of the request. 
        This value is not determined until the request is finished. 
        '''</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_result</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">resp_headers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''If the request has been completed, return a dictionary containing 
        the headers of the response. Otherwise, it will return None. 
        '''</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resp_headers</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">resp_status</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Return the status code of the response if the request is complete, 
        otherwise return None. 
        '''</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resp_status</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Return the error of the request. 
        This value is not determined until the request is completed. 
        '''</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_error</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">chunk_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Return the size of a chunk, used only in &quot;progress&quot; mode (when 
        on_progress callback is set.) 
        '''</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_chunk_size</span>

    <span class="s2">def </span><span class="s1">wait</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">delay</span><span class="s3">=</span><span class="s5">0.5</span><span class="s3">):</span>
        <span class="s0">'''Wait for the request to finish (until :attr:`resp_status` is not 
        None) 
 
        .. note:: 
            This method is intended to be used in the main thread, and the 
            callback will be dispatched from the same thread 
            from which you're calling. 
 
        .. versionadded:: 1.1.0 
        '''</span>
        <span class="s2">while </span><span class="s1">self</span><span class="s3">.</span><span class="s1">resp_status </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_dispatch_result</span><span class="s3">(</span><span class="s1">delay</span><span class="s3">)</span>
            <span class="s1">sleep</span><span class="s3">(</span><span class="s1">delay</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cancel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Cancel the current request. It will be aborted, and the result 
        will not be dispatched. Once cancelled, the callback on_cancel will 
        be called. 
 
        .. versionadded:: 1.11.0 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_event</span><span class="s3">.</span><span class="s1">set</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">UrlRequestUrllib</span><span class="s3">(</span><span class="s1">UrlRequestBase</span><span class="s3">):</span>

    <span class="s2">def </span><span class="s1">get_chunks</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">, </span><span class="s1">report_progress</span><span class="s3">, </span><span class="s1">q</span><span class="s3">,</span>
        <span class="s1">trigger</span><span class="s3">, </span><span class="s1">fd</span><span class="s3">=</span><span class="s2">None</span>
    <span class="s3">):</span>
        <span class="s1">bytes_so_far </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s7">b''</span>

        <span class="s2">while </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">chunk </span><span class="s3">= </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">chunk_size</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">chunk</span><span class="s3">:</span>
                <span class="s2">break</span>

            <span class="s2">if </span><span class="s1">fd</span><span class="s3">:</span>
                <span class="s1">fd</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">)</span>

            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">result </span><span class="s3">+= </span><span class="s1">chunk</span>

            <span class="s1">bytes_so_far </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">report_progress</span><span class="s3">:</span>
                <span class="s1">q</span><span class="s3">((</span><span class="s6">'progress'</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, (</span><span class="s1">bytes_so_far</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">)))</span>
                <span class="s1">trigger</span><span class="s3">()</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_event</span><span class="s3">.</span><span class="s1">is_set</span><span class="s3">():</span>
                <span class="s2">break</span>

        <span class="s2">return </span><span class="s1">bytes_so_far</span><span class="s3">, </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">get_response</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">get_total_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">int</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">.</span><span class="s1">getheader</span><span class="s3">(</span><span class="s6">'content-length'</span><span class="s3">))</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">-</span><span class="s5">1</span>

    <span class="s2">def </span><span class="s1">get_content_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">getheader</span><span class="s3">(</span><span class="s6">'Content-Type'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_status_code</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">status</span>

    <span class="s2">def </span><span class="s1">get_all_headers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">getheaders</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">close_connection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">req</span><span class="s3">):</span>
        <span class="s1">req</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_parse_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">):</span>
        <span class="s1">parse </span><span class="s3">= </span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s1">host </span><span class="s3">= </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">hostname</span>
        <span class="s1">port </span><span class="s3">= </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">port</span>
        <span class="s1">userpass </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s4"># append user + pass to hostname if specified</span>
        <span class="s2">if </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">username </span><span class="s2">and </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">password</span><span class="s3">:</span>
            <span class="s1">userpass </span><span class="s3">= {</span>
                <span class="s6">&quot;Authorization&quot;</span><span class="s3">: </span><span class="s6">&quot;Basic {}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">b64encode</span><span class="s3">(</span>
                    <span class="s6">&quot;{}:{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                        <span class="s1">parse</span><span class="s3">.</span><span class="s1">username</span><span class="s3">,</span>
                        <span class="s1">parse</span><span class="s3">.</span><span class="s1">password</span>
                    <span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s6">'utf-8'</span><span class="s3">)</span>
                <span class="s3">).</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">'utf-8'</span><span class="s3">))</span>
            <span class="s3">}</span>

        <span class="s2">return </span><span class="s1">host</span><span class="s3">, </span><span class="s1">port</span><span class="s3">, </span><span class="s1">userpass</span><span class="s3">, </span><span class="s1">parse</span>

    <span class="s2">def </span><span class="s1">_get_connection_for_scheme</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">scheme</span><span class="s3">):</span>
        <span class="s0">'''Return the Connection class for a particular scheme. 
        This is an internal function that can be expanded to support custom 
        schemes. 
 
        Actual supported schemes: http, https. 
        '''</span>
        <span class="s2">if </span><span class="s1">scheme </span><span class="s3">== </span><span class="s6">'http'</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">HTTPConnection</span>
        <span class="s2">elif </span><span class="s1">scheme </span><span class="s3">== </span><span class="s6">'https' </span><span class="s2">and </span><span class="s1">HTTPSConnection </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">HTTPSConnection</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s6">'No class for scheme %s' </span><span class="s3">% </span><span class="s1">scheme</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">call_request</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">body</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">):</span>
        <span class="s1">timeout </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_timeout</span>
        <span class="s1">ca_file </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ca_file</span>
        <span class="s1">verify </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verify</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_requested_url</span>

        <span class="s4"># parse url</span>
        <span class="s1">host</span><span class="s3">, </span><span class="s1">port</span><span class="s3">, </span><span class="s1">userpass</span><span class="s3">, </span><span class="s1">parse </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_parse_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">userpass </span><span class="s2">and not </span><span class="s1">headers</span><span class="s3">:</span>
            <span class="s1">headers </span><span class="s3">= </span><span class="s1">userpass</span>
        <span class="s2">elif </span><span class="s1">userpass </span><span class="s2">and </span><span class="s1">headers</span><span class="s3">:</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">userpass</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s1">headers</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] = </span><span class="s1">userpass</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>

        <span class="s4"># translate scheme to connection class</span>
        <span class="s1">cls </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_connection_for_scheme</span><span class="s3">(</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">scheme</span><span class="s3">)</span>

        <span class="s4"># reconstruct path to pass on the request</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">path</span>
        <span class="s2">if </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">params</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">+= </span><span class="s6">';' </span><span class="s3">+ </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">params</span>
        <span class="s2">if </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">query</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">+= </span><span class="s6">'?' </span><span class="s3">+ </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">query</span>
        <span class="s2">if </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">fragment</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">+= </span><span class="s6">'#' </span><span class="s3">+ </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">fragment</span>

        <span class="s4"># create connection instance</span>
        <span class="s1">args </span><span class="s3">= {}</span>
        <span class="s2">if </span><span class="s1">timeout </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">args</span><span class="s3">[</span><span class="s6">'timeout'</span><span class="s3">] = </span><span class="s1">timeout</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">ca_file </span><span class="s2">is not None and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ssl</span><span class="s3">, </span><span class="s6">'create_default_context'</span><span class="s3">) </span><span class="s2">and</span>
                <span class="s1">parse</span><span class="s3">.</span><span class="s1">scheme </span><span class="s3">== </span><span class="s6">'https'</span><span class="s3">):</span>
            <span class="s1">ctx </span><span class="s3">= </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">create_default_context</span><span class="s3">(</span><span class="s1">cafile</span><span class="s3">=</span><span class="s1">ca_file</span><span class="s3">)</span>
            <span class="s1">ctx</span><span class="s3">.</span><span class="s1">verify_mode </span><span class="s3">= </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">CERT_REQUIRED</span>
            <span class="s1">args</span><span class="s3">[</span><span class="s6">'context'</span><span class="s3">] = </span><span class="s1">ctx</span>

        <span class="s2">if not </span><span class="s1">verify </span><span class="s2">and </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">scheme </span><span class="s3">== </span><span class="s6">'https' </span><span class="s2">and </span><span class="s3">(</span>
            <span class="s1">hasattr</span><span class="s3">(</span><span class="s1">ssl</span><span class="s3">, </span><span class="s6">'create_default_context'</span><span class="s3">)):</span>
            <span class="s1">ctx </span><span class="s3">= </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">create_default_context</span><span class="s3">()</span>
            <span class="s1">ctx</span><span class="s3">.</span><span class="s1">check_hostname </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s1">ctx</span><span class="s3">.</span><span class="s1">verify_mode </span><span class="s3">= </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">CERT_NONE</span>
            <span class="s1">args</span><span class="s3">[</span><span class="s6">'context'</span><span class="s3">] = </span><span class="s1">ctx</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_host</span><span class="s3">:</span>
            <span class="s1">Logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">'UrlRequest: {0} - proxy via {1}:{2}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_host</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_port</span>
            <span class="s3">))</span>
            <span class="s1">req </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_host</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_port</span><span class="s3">, **</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">parse</span><span class="s3">.</span><span class="s1">scheme </span><span class="s3">== </span><span class="s6">'https'</span><span class="s3">:</span>
                <span class="s1">req</span><span class="s3">.</span><span class="s1">set_tunnel</span><span class="s3">(</span><span class="s1">host</span><span class="s3">, </span><span class="s1">port</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_proxy_headers</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">path </span><span class="s3">= </span><span class="s1">urlunparse</span><span class="s3">(</span><span class="s1">parse</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">req </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">host</span><span class="s3">, </span><span class="s1">port</span><span class="s3">, **</span><span class="s1">args</span><span class="s3">)</span>

        <span class="s4"># send request</span>
        <span class="s1">method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_method</span>
        <span class="s2">if </span><span class="s1">method </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">method </span><span class="s3">= </span><span class="s6">'GET' </span><span class="s2">if </span><span class="s1">body </span><span class="s2">is None else </span><span class="s6">'POST'</span>

        <span class="s1">req</span><span class="s3">.</span><span class="s1">request</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">body</span><span class="s3">, </span><span class="s1">headers </span><span class="s2">or </span><span class="s3">{})</span>

        <span class="s4"># read header</span>
        <span class="s2">return </span><span class="s1">req</span><span class="s3">, </span><span class="s1">req</span><span class="s3">.</span><span class="s1">getresponse</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">UrlRequestRequests</span><span class="s3">(</span><span class="s1">UrlRequestBase</span><span class="s3">):</span>

    <span class="s2">def </span><span class="s1">get_chunks</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">, </span><span class="s1">report_progress</span><span class="s3">, </span><span class="s1">q</span><span class="s3">,</span>
        <span class="s1">trigger</span><span class="s3">, </span><span class="s1">fd</span><span class="s3">=</span><span class="s2">None</span>
    <span class="s3">):</span>
        <span class="s1">bytes_so_far </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s7">b''</span>

        <span class="s2">for </span><span class="s1">chunk </span><span class="s2">in </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">iter_content</span><span class="s3">(</span><span class="s1">chunk_size</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">chunk</span><span class="s3">:</span>
                <span class="s2">break</span>

            <span class="s2">if </span><span class="s1">fd</span><span class="s3">:</span>
                <span class="s1">fd</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">)</span>

            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">result </span><span class="s3">+= </span><span class="s1">chunk</span>

            <span class="s1">bytes_so_far </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">report_progress</span><span class="s3">:</span>
                <span class="s1">q</span><span class="s3">((</span><span class="s6">'progress'</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">, (</span><span class="s1">bytes_so_far</span><span class="s3">, </span><span class="s1">total_size</span><span class="s3">)))</span>
                <span class="s1">trigger</span><span class="s3">()</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_event</span><span class="s3">.</span><span class="s1">is_set</span><span class="s3">():</span>
                <span class="s2">break</span>

        <span class="s2">return </span><span class="s1">bytes_so_far</span><span class="s3">, </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">get_response</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">content</span>

    <span class="s2">def </span><span class="s1">get_total_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">int</span><span class="s3">(</span><span class="s1">resp</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">'Content-Length'</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">get_content_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">'Content-Type'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_status_code</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">status_code</span>

    <span class="s2">def </span><span class="s1">get_all_headers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">resp</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">close_connection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">req</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">call_request</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">body</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">):</span>
        <span class="s1">timeout </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_timeout</span>
        <span class="s1">ca_file </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ca_file</span>
        <span class="s1">verify </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verify</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_requested_url</span>
        <span class="s1">auth </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth</span>

        <span class="s1">req </span><span class="s3">= </span><span class="s1">requests</span>
        <span class="s1">kwargs </span><span class="s3">= {}</span>

        <span class="s4"># get method</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_method </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">method </span><span class="s3">= </span><span class="s6">'get' </span><span class="s2">if </span><span class="s1">body </span><span class="s2">is None else </span><span class="s6">'post'</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_method</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>

        <span class="s1">req_call </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">auth</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s6">&quot;auth&quot;</span><span class="s3">] = </span><span class="s1">auth</span>

        <span class="s4"># send request</span>
        <span class="s1">response </span><span class="s3">= </span><span class="s1">req_call</span><span class="s3">(</span>
            <span class="s1">url</span><span class="s3">,</span>
            <span class="s1">data</span><span class="s3">=</span><span class="s1">body</span><span class="s3">,</span>
            <span class="s1">headers</span><span class="s3">=</span><span class="s1">headers</span><span class="s3">,</span>
            <span class="s1">timeout</span><span class="s3">=</span><span class="s1">timeout</span><span class="s3">,</span>
            <span class="s1">verify</span><span class="s3">=</span><span class="s1">verify</span><span class="s3">,</span>
            <span class="s1">cert</span><span class="s3">=</span><span class="s1">ca_file</span><span class="s3">,</span>
            <span class="s3">**</span><span class="s1">kwargs</span>
        <span class="s3">)</span>

        <span class="s2">return None</span><span class="s3">, </span><span class="s1">response</span>


<span class="s1">implementation_map </span><span class="s3">= {</span>
    <span class="s6">&quot;default&quot;</span><span class="s3">: </span><span class="s1">UrlRequestUrllib</span><span class="s3">,</span>
    <span class="s6">&quot;requests&quot;</span><span class="s3">: </span><span class="s1">UrlRequestRequests</span><span class="s3">,</span>
    <span class="s6">&quot;urllib&quot;</span><span class="s3">: </span><span class="s1">UrlRequestUrllib</span><span class="s3">,</span>
<span class="s3">}</span>

<span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;KIVY_DOC_INCLUDE&quot;</span><span class="s3">):</span>
    <span class="s1">prefered_implementation </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">getdefault</span><span class="s3">(</span>
        <span class="s6">&quot;network&quot;</span><span class="s3">, </span><span class="s6">&quot;implementation&quot;</span><span class="s3">, </span><span class="s6">&quot;default&quot;</span>
    <span class="s3">)</span>
<span class="s2">else</span><span class="s3">:</span>
    <span class="s1">prefered_implementation </span><span class="s3">= </span><span class="s6">&quot;default&quot;</span>

<span class="s1">UrlRequest </span><span class="s3">= </span><span class="s1">implementation_map</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">prefered_implementation</span><span class="s3">)</span>
</pre>
</body>
</html>