<html>
<head>
<title>vertex_instructions_line.pxi</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
vertex_instructions_line.pxi</font>
</center></td></tr></table>
<pre><span class="s0">DEF </span><span class="s1">LINE_CAP_NONE </span><span class="s2">= </span><span class="s3">0</span>
<span class="s0">DEF </span><span class="s1">LINE_CAP_SQUARE </span><span class="s2">= </span><span class="s3">1</span>
<span class="s0">DEF </span><span class="s1">LINE_CAP_ROUND </span><span class="s2">= </span><span class="s3">2</span>

<span class="s0">DEF </span><span class="s1">LINE_JOINT_NONE </span><span class="s2">= </span><span class="s3">0</span>
<span class="s0">DEF </span><span class="s1">LINE_JOINT_MITER </span><span class="s2">= </span><span class="s3">1</span>
<span class="s0">DEF </span><span class="s1">LINE_JOINT_BEVEL </span><span class="s2">= </span><span class="s3">2</span>
<span class="s0">DEF </span><span class="s1">LINE_JOINT_ROUND </span><span class="s2">= </span><span class="s3">3</span>

<span class="s0">DEF </span><span class="s1">LINE_MODE_POINTS </span><span class="s2">= </span><span class="s3">0</span>
<span class="s0">DEF </span><span class="s1">LINE_MODE_ELLIPSE </span><span class="s2">= </span><span class="s3">1</span>
<span class="s0">DEF </span><span class="s1">LINE_MODE_CIRCLE </span><span class="s2">= </span><span class="s3">2</span>
<span class="s0">DEF </span><span class="s1">LINE_MODE_RECTANGLE </span><span class="s2">= </span><span class="s3">3</span>
<span class="s0">DEF </span><span class="s1">LINE_MODE_ROUNDED_RECTANGLE </span><span class="s2">= </span><span class="s3">4</span>
<span class="s0">DEF </span><span class="s1">LINE_MODE_BEZIER </span><span class="s2">= </span><span class="s3">5</span>

<span class="s0">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">cache </span><span class="s0">import </span><span class="s1">Cache</span>
<span class="s0">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">graphics</span><span class="s2">.</span><span class="s1">stencil_instructions </span><span class="s0">cimport </span><span class="s1">StencilUse</span><span class="s2">, </span><span class="s1">StencilUnUse</span><span class="s2">, </span><span class="s1">StencilPush</span><span class="s2">, </span><span class="s1">StencilPop</span>
<span class="s0">import </span><span class="s1">itertools</span>

<span class="s4"># register graphics texture cache</span>
<span class="s1">Cache</span><span class="s2">.</span><span class="s1">register</span><span class="s2">(</span><span class="s5">'kv.graphics.texture'</span><span class="s2">)</span>

<span class="s0">cdef </span><span class="s1">float PI </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s3">3.1415926535</span>

<span class="s0">cdef </span><span class="s1">inline int line_intersection</span><span class="s2">(</span><span class="s1">double x1</span><span class="s2">, </span><span class="s1">double y1</span><span class="s2">, </span><span class="s1">double x2</span><span class="s2">, </span><span class="s1">double y2</span><span class="s2">,</span>
        <span class="s1">double x3</span><span class="s2">, </span><span class="s1">double y3</span><span class="s2">, </span><span class="s1">double x4</span><span class="s2">, </span><span class="s1">double y4</span><span class="s2">, </span><span class="s1">double </span><span class="s2">*</span><span class="s1">px</span><span class="s2">, </span><span class="s1">double </span><span class="s2">*</span><span class="s1">py</span><span class="s2">):</span>
    <span class="s0">cdef </span><span class="s1">double u </span><span class="s2">= (</span><span class="s1">x1 </span><span class="s2">* </span><span class="s1">y2 </span><span class="s2">- </span><span class="s1">y1 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">double v </span><span class="s2">= (</span><span class="s1">x3 </span><span class="s2">* </span><span class="s1">y4 </span><span class="s2">- </span><span class="s1">y3 </span><span class="s2">* </span><span class="s1">x4</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">double denom </span><span class="s2">= (</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x2</span><span class="s2">) * (</span><span class="s1">y3 </span><span class="s2">- </span><span class="s1">y4</span><span class="s2">) - (</span><span class="s1">y1 </span><span class="s2">- </span><span class="s1">y2</span><span class="s2">) * (</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">x4</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">denom </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s3">0</span>
    <span class="s1">px</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = (</span><span class="s1">u </span><span class="s2">* (</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">x4</span><span class="s2">) - (</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x2</span><span class="s2">) * </span><span class="s1">v</span><span class="s2">) / </span><span class="s1">denom</span>
    <span class="s1">py</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = (</span><span class="s1">u </span><span class="s2">* (</span><span class="s1">y3 </span><span class="s2">- </span><span class="s1">y4</span><span class="s2">) - (</span><span class="s1">y1 </span><span class="s2">- </span><span class="s1">y2</span><span class="s2">) * </span><span class="s1">v</span><span class="s2">) / </span><span class="s1">denom</span>
    <span class="s0">return </span><span class="s3">1</span>

<span class="s0">cdef class </span><span class="s1">Line</span><span class="s2">(</span><span class="s1">VertexInstruction</span><span class="s2">):</span>
    <span class="s6">'''A 2d line. 
 
    Drawing a line can be done easily:: 
 
        with self.canvas: 
            Line(points=[100, 100, 200, 100, 100, 200], width=10) 
 
    The line has 3 internal drawing modes that you should be aware of 
    for optimal results: 
 
    #. If the :attr:`width` is 1.0 and :attr:`force_custom_drawing_method` is False, then the 
       standard GL_LINE drawing from OpenGL will be used. :attr:`dash_length`, 
       :attr:`dash_offset`, and :attr:`dashes` will work, while properties for 
       cap and joint have no meaning here. 
    #. If the :attr:`width` is greater than 1.0 or :attr:`force_custom_drawing_method` 
       is True, then a custom drawing method, based on triangulation, 
       will be used. :attr:`dash_length`, :attr:`dash_offset`, 
       and :attr:`dashes` do not work in this mode. 
       Additionally, if the current color has an alpha less than 1.0, a 
       stencil will be used internally to draw the line. 
 
    .. image:: images/line-instruction.png 
        :align: center 
 
    :Parameters: 
        `points`: list 
            List of points in the format (x1, y1, x2, y2...) 
        `dash_length`: int 
            Length of a segment (if dashed), defaults to 1. 
        `dash_offset`: int 
            Offset between the end of a segment and the beginning of the 
            next one, defaults to 0. Changing this makes it dashed. 
        `dashes`: list of ints 
            List of [ON length, offset, ON length, offset, ...]. E.g. ``[2,4,1,6,8,2]`` 
            would create a line with the first dash length 2 then an offset of 4 then 
            a dash length of 1 then an offset of 6 and so on. Defaults to ``[]``. 
            Changing this makes it dashed and overrides `dash_length` and `dash_offset`. 
        `width`: float 
            Width of the line, defaults to 1.0. 
        `cap`: str, defaults to 'round' 
            See :attr:`cap` for more information. 
        `joint`: str, defaults to 'round' 
            See :attr:`joint` for more information. 
        `cap_precision`: int, defaults to 10 
            See :attr:`cap_precision` for more information 
        `joint_precision`: int, defaults to 10 
            See :attr:`joint_precision` for more information 
            See :attr:`cap_precision` for more information. 
        `joint_precision`: int, defaults to 10 
            See :attr:`joint_precision` for more information. 
        `close`: bool, defaults to False 
            If True, the line will be closed. 
        `circle`: list 
            If set, the :attr:`points` will be set to build a circle. See 
            :attr:`circle` for more information. 
        `ellipse`: list 
            If set, the :attr:`points` will be set to build an ellipse. See 
            :attr:`ellipse` for more information. 
        `rectangle`: list 
            If set, the :attr:`points` will be set to build a rectangle. See 
            :attr:`rectangle` for more information. 
        `bezier`: list 
            If set, the :attr:`points` will be set to build a bezier line. See 
            :attr:`bezier` for more information. 
        `bezier_precision`: int, defaults to 180 
            Precision of the Bezier drawing. 
        `force_custom_drawing_method`: bool, defaults to False 
            Should the custom drawing method be used, instead of it depending on :attr:`width` 
            being equal to 1.o or not. 
 
    .. versionchanged:: 1.0.8 
        `dash_offset` and `dash_length` have been added. 
 
    .. versionchanged:: 1.4.1 
        `width`, `cap`, `joint`, `cap_precision`, `joint_precision`, `close`, 
        `ellipse`, `rectangle` have been added. 
 
    .. versionchanged:: 1.4.1 
        `bezier`, `bezier_precision` have been added. 
 
    .. versionchanged:: 1.11.0 
        `dashes` have been added 
 
    .. versionchanged:: 2.3.0 
        `force_custom_drawing_method` has been added 
 
    '''</span>
    <span class="s0">cdef </span><span class="s1">int _cap</span>
    <span class="s0">cdef </span><span class="s1">int _cap_precision</span>
    <span class="s0">cdef </span><span class="s1">int _joint_precision</span>
    <span class="s0">cdef </span><span class="s1">int _bezier_precision</span>
    <span class="s0">cdef </span><span class="s1">int _joint</span>
    <span class="s0">cdef </span><span class="s1">list _points</span>
    <span class="s0">cdef </span><span class="s1">list _dash_list</span>
    <span class="s0">cdef </span><span class="s1">float _width</span>
    <span class="s0">cdef </span><span class="s1">int _dash_offset</span><span class="s2">, </span><span class="s1">_dash_length</span>
    <span class="s0">cdef </span><span class="s1">int _use_stencil</span>
    <span class="s0">cdef </span><span class="s1">int _close</span>
    <span class="s0">cdef </span><span class="s1">str _close_mode</span>
    <span class="s0">cdef </span><span class="s1">int _force_custom_drawing_method</span>
    <span class="s0">cdef </span><span class="s1">int _mode</span>
    <span class="s0">cdef </span><span class="s1">Instruction _stencil_rect</span>
    <span class="s0">cdef </span><span class="s1">Instruction _stencil_push</span>
    <span class="s0">cdef </span><span class="s1">Instruction _stencil_use</span>
    <span class="s0">cdef </span><span class="s1">Instruction _stencil_unuse</span>
    <span class="s0">cdef </span><span class="s1">Instruction _stencil_pop</span>
    <span class="s0">cdef </span><span class="s1">double _bxmin</span><span class="s2">, </span><span class="s1">_bxmax</span><span class="s2">, </span><span class="s1">_bymin</span><span class="s2">, </span><span class="s1">_bymax</span>
    <span class="s0">cdef </span><span class="s1">tuple _mode_args</span>
    <span class="s0">cdef </span><span class="s1">tuple _rounded_rectangle</span><span class="s2">, </span><span class="s1">_rectangle</span><span class="s2">, </span><span class="s1">_ellipse</span><span class="s2">, </span><span class="s1">_circle</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Line</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'points'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">points </span><span class="s2">= </span><span class="s1">v </span><span class="s0">if </span><span class="s1">v </span><span class="s0">is not None else </span><span class="s2">[]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dashes </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'dashes'</span><span class="s2">, [])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">set_mode</span><span class="s2">(</span><span class="s5">'line_strip'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'dash_length'</span><span class="s2">) </span><span class="s0">or </span><span class="s3">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'dash_offset'</span><span class="s2">) </span><span class="s0">or </span><span class="s3">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_width </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'width'</span><span class="s2">) </span><span class="s0">or </span><span class="s3">1.0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">joint </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'joint'</span><span class="s2">) </span><span class="s0">or </span><span class="s5">'round'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cap </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'cap'</span><span class="s2">) </span><span class="s0">or </span><span class="s5">'round'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'cap_precision'</span><span class="s2">) </span><span class="s0">or </span><span class="s3">10</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'joint_precision'</span><span class="s2">) </span><span class="s0">or </span><span class="s3">10</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bezier_precision </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'bezier_precision'</span><span class="s2">) </span><span class="s0">or </span><span class="s3">180</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_close </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'close'</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'close_mode'</span><span class="s2">, </span><span class="s5">'straight-line'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_force_custom_drawing_method </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'force_custom_drawing_method'</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_rect </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_push </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_use </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_unuse </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_pop </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_use_stencil </span><span class="s2">= </span><span class="s3">0</span>

        <span class="s0">if </span><span class="s5">'ellipse' </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ellipse </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s5">'ellipse'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s5">'circle' </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">circle </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s5">'circle'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s5">'rectangle' </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rectangle </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s5">'rectangle'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s5">'rounded_rectangle' </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rounded_rectangle </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s5">'rounded_rectangle'</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s5">'bezier' </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">bezier </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s5">'bezier'</span><span class="s2">]</span>

    <span class="s0">cdef </span><span class="s1">void build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_ELLIPSE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_ellipse</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_CIRCLE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_circle</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_RECTANGLE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_rectangle</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_ROUNDED_RECTANGLE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_rounded_rectangle</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_BEZIER</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_bezier</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_width </span><span class="s2">== </span><span class="s3">1.0 </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_force_custom_drawing_method </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build_legacy</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build_extended</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">void ensure_stencil</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_rect </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_rect </span><span class="s2">= </span><span class="s1">Rectangle</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_push </span><span class="s2">= </span><span class="s1">StencilPush</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_pop </span><span class="s2">= </span><span class="s1">StencilPop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_use </span><span class="s2">= </span><span class="s1">StencilUse</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s5">'lequal'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_unuse </span><span class="s2">= </span><span class="s1">StencilUnUse</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">int apply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s0">except </span><span class="s2">-</span><span class="s3">1</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_width </span><span class="s2">== </span><span class="s3">1. </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_force_custom_drawing_method </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">VertexInstruction</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s3">0</span>

        <span class="s0">cdef </span><span class="s1">double alpha </span><span class="s2">= </span><span class="s1">getActiveContext</span><span class="s2">()[</span><span class="s5">'color'</span><span class="s2">][-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_use_stencil </span><span class="s2">= </span><span class="s1">alpha </span><span class="s2">&lt; </span><span class="s3">1</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_use_stencil</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">ensure_stencil</span><span class="s2">()</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_push</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">()</span>
            <span class="s1">VertexInstruction</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_use</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_rect</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bymin</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_rect</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmax </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bymax </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bymin</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_rect</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_unuse</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">()</span>
            <span class="s1">VertexInstruction</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_stencil_pop</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">VertexInstruction</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s3">0</span>

    <span class="s0">cdef </span><span class="s1">void build_legacy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">int i</span>
        <span class="s0">cdef </span><span class="s1">long count </span><span class="s2">= &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">int</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">points</span><span class="s2">) / </span><span class="s3">2.</span><span class="s2">)</span>
        <span class="s0">cdef </span><span class="s1">list p </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">points</span>
        <span class="s0">cdef </span><span class="s1">vertex_t </span><span class="s2">*</span><span class="s1">vertices </span><span class="s2">= </span><span class="s1">NULL</span>
        <span class="s0">cdef </span><span class="s1">unsigned short </span><span class="s2">*</span><span class="s1">indices </span><span class="s2">= </span><span class="s1">NULL</span>
        <span class="s0">cdef </span><span class="s1">float tex_x</span>
        <span class="s0">cdef </span><span class="s1">char </span><span class="s2">*</span><span class="s1">buf </span><span class="s2">= </span><span class="s1">NULL</span>
        <span class="s0">cdef </span><span class="s1">Texture texture </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">texture</span>
        <span class="s0">cdef </span><span class="s1">int length </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">int position </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">int val</span>

        <span class="s0">if </span><span class="s1">count </span><span class="s2">&lt; </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">clear_data</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">== </span><span class="s5">'straight-line'</span><span class="s2">:</span>
            <span class="s1">p </span><span class="s2">= </span><span class="s1">p </span><span class="s2">+ [</span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]]</span>
            <span class="s1">count </span><span class="s2">+= </span><span class="s3">1</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">set_mode</span><span class="s2">(</span><span class="s5">'line_strip'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_list</span><span class="s2">:</span>
            <span class="s1">length </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_list</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">texture </span><span class="s0">is None or </span><span class="s1">texture</span><span class="s2">.</span><span class="s1">_width </span><span class="s2">!= </span><span class="s1">length \</span>
                <span class="s0">or </span><span class="s1">texture</span><span class="s2">.</span><span class="s1">_height </span><span class="s2">!= </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s1">texture </span><span class="s2">= </span><span class="s1">Texture</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">length</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
                <span class="s1">texture</span><span class="s2">.</span><span class="s1">wrap </span><span class="s2">= </span><span class="s5">'repeat'</span>

            <span class="s4"># create a buffer to fill our texture</span>
            <span class="s1">buf </span><span class="s2">= &lt;</span><span class="s1">char </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s3">4 </span><span class="s2">* </span><span class="s1">length</span><span class="s2">)</span>
            <span class="s1">memset</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4 </span><span class="s2">* </span><span class="s1">length</span><span class="s2">)</span>

            <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_list</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">idx </span><span class="s2">% </span><span class="s3">2 </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">memset</span><span class="s2">(</span><span class="s1">buf </span><span class="s2">+ </span><span class="s1">position</span><span class="s2">, </span><span class="s3">255</span><span class="s2">, </span><span class="s1">val </span><span class="s2">* </span><span class="s3">4</span><span class="s2">)</span>
                <span class="s1">position </span><span class="s2">+= </span><span class="s1">val </span><span class="s2">* </span><span class="s3">4</span>

            <span class="s1">p_str </span><span class="s2">= </span><span class="s1">buf</span><span class="s2">[:</span><span class="s1">position</span><span class="s2">]</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">texture</span><span class="s2">.</span><span class="s1">blit_buffer</span><span class="s2">(</span><span class="s1">p_str</span><span class="s2">, </span><span class="s1">colorfmt</span><span class="s2">=</span><span class="s5">'rgba'</span><span class="s2">, </span><span class="s1">bufferfmt</span><span class="s2">=</span><span class="s5">'ubyte'</span><span class="s2">)</span>
            <span class="s0">finally</span><span class="s2">:</span>
                <span class="s1">free</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset </span><span class="s2">!= </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">length </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset</span>
            <span class="s0">if </span><span class="s1">texture </span><span class="s0">is None or </span><span class="s1">texture</span><span class="s2">.</span><span class="s1">_width </span><span class="s2">!= </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset</span><span class="s2">) </span><span class="s0">or </span><span class="s1">\</span>
                <span class="s1">texture</span><span class="s2">.</span><span class="s1">_height </span><span class="s2">!= </span><span class="s3">1</span><span class="s2">:</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s1">texture </span><span class="s2">= </span><span class="s1">Texture</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span>
                        <span class="s1">size</span><span class="s2">=(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
                <span class="s1">texture</span><span class="s2">.</span><span class="s1">wrap </span><span class="s2">= </span><span class="s5">'repeat'</span>

            <span class="s4"># create a buffer to fill our texture</span>
            <span class="s1">buf </span><span class="s2">= &lt;</span><span class="s1">char </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s3">4 </span><span class="s2">* (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset</span><span class="s2">))</span>
            <span class="s1">memset</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s3">255</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">* </span><span class="s3">4</span><span class="s2">)</span>
            <span class="s1">memset</span><span class="s2">(</span><span class="s1">buf </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">* </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset </span><span class="s2">* </span><span class="s3">4</span><span class="s2">)</span>
            <span class="s1">p_str </span><span class="s2">= </span><span class="s1">buf</span><span class="s2">[:(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset</span><span class="s2">) * </span><span class="s3">4</span><span class="s2">]</span>

            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">texture</span><span class="s2">.</span><span class="s1">blit_buffer</span><span class="s2">(</span><span class="s1">p_str</span><span class="s2">, </span><span class="s1">colorfmt</span><span class="s2">=</span><span class="s5">'rgba'</span><span class="s2">, </span><span class="s1">bufferfmt</span><span class="s2">=</span><span class="s5">'ubyte'</span><span class="s2">)</span>
            <span class="s0">finally</span><span class="s2">:</span>
                <span class="s1">free</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">texture </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">vertices </span><span class="s2">= &lt;</span><span class="s1">vertex_t </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s1">count </span><span class="s2">* </span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">vertex_t</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">vertices </span><span class="s2">== </span><span class="s1">NULL</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s5">'vertices'</span><span class="s2">)</span>

        <span class="s1">indices </span><span class="s2">= &lt;</span><span class="s1">unsigned short </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s1">count </span><span class="s2">* </span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">unsigned short</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">indices </span><span class="s2">== </span><span class="s1">NULL</span><span class="s2">:</span>
            <span class="s1">free</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">)</span>
            <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s5">'indices'</span><span class="s2">)</span>

        <span class="s1">tex_x </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset </span><span class="s2">!= </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_list</span><span class="s2">) </span><span class="s0">and </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">tex_x </span><span class="s2">+= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">sqrt</span><span class="s2">(</span>
                        <span class="s1">pow</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2</span><span class="s2">]     - </span><span class="s1">p</span><span class="s2">[(</span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) * </span><span class="s3">2</span><span class="s2">], </span><span class="s3">2</span><span class="s2">)  +</span>
                        <span class="s1">pow</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] - </span><span class="s1">p</span><span class="s2">[(</span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) * </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">], </span><span class="s3">2</span><span class="s2">)) / </span><span class="s1">length</span><span class="s2">)</span>

                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s1">tex_x</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>

            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2</span><span class="s2">]</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">i</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">, &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">count</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">count</span><span class="s2">)</span>

        <span class="s1">free</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">)</span>
        <span class="s1">free</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">)</span>

    <span class="s0">cdef </span><span class="s1">void build_extended</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">int i</span><span class="s2">, </span><span class="s1">j</span>
        <span class="s0">cdef </span><span class="s1">long count </span><span class="s2">= &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">int</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">points</span><span class="s2">) / </span><span class="s3">2.</span><span class="s2">)</span>
        <span class="s0">cdef </span><span class="s1">list p </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">points</span>
        <span class="s0">cdef </span><span class="s1">vertex_t </span><span class="s2">*</span><span class="s1">vertices </span><span class="s2">= </span><span class="s1">NULL</span>
        <span class="s0">cdef </span><span class="s1">unsigned short </span><span class="s2">*</span><span class="s1">indices </span><span class="s2">= </span><span class="s1">NULL</span>
        <span class="s0">cdef </span><span class="s1">float tex_x</span>
        <span class="s0">cdef </span><span class="s1">int cap</span>
        <span class="s0">cdef </span><span class="s1">char </span><span class="s2">*</span><span class="s1">buf </span><span class="s2">= </span><span class="s1">NULL</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmin </span><span class="s2">= </span><span class="s3">999999999</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bymin </span><span class="s2">= </span><span class="s3">999999999</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmax </span><span class="s2">= -</span><span class="s3">999999999</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bymax </span><span class="s2">= -</span><span class="s3">999999999</span>

        <span class="s0">if </span><span class="s1">count </span><span class="s2">&lt; </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">clear_data</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s1">cap </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">== </span><span class="s5">'straight-line' </span><span class="s0">and </span><span class="s1">count </span><span class="s2">&gt; </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">p </span><span class="s2">= </span><span class="s1">p </span><span class="s2">+ </span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:</span><span class="s3">4</span><span class="s2">]</span>
            <span class="s1">count </span><span class="s2">+= </span><span class="s3">2</span>
            <span class="s1">cap </span><span class="s2">= </span><span class="s1">LINE_CAP_NONE</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">set_mode</span><span class="s2">(</span><span class="s5">'triangles'</span><span class="s2">)</span>
        <span class="s0">cdef </span><span class="s1">unsigned long vertices_count </span><span class="s2">= (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) * </span><span class="s3">4</span>
        <span class="s0">cdef </span><span class="s1">unsigned long indices_count </span><span class="s2">= (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) * </span><span class="s3">6</span>
        <span class="s0">cdef </span><span class="s1">unsigned int iv </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">ii </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">siv </span><span class="s2">= </span><span class="s3">0</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_BEVEL</span><span class="s2">:</span>
            <span class="s1">indices_count </span><span class="s2">+= (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">2</span><span class="s2">) * </span><span class="s3">3</span>
            <span class="s1">vertices_count </span><span class="s2">+= (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_ROUND</span><span class="s2">:</span>
            <span class="s1">indices_count </span><span class="s2">+= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision </span><span class="s2">* </span><span class="s3">3</span><span class="s2">) * (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">2</span><span class="s2">)</span>
            <span class="s1">vertices_count </span><span class="s2">+= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision</span><span class="s2">) * (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_MITER</span><span class="s2">:</span>
            <span class="s1">indices_count </span><span class="s2">+= (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">2</span><span class="s2">) * </span><span class="s3">6</span>
            <span class="s1">vertices_count </span><span class="s2">+= (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">2</span><span class="s2">) * </span><span class="s3">2</span>

        <span class="s0">if </span><span class="s1">cap </span><span class="s2">== </span><span class="s1">LINE_CAP_SQUARE</span><span class="s2">:</span>
            <span class="s1">indices_count </span><span class="s2">+= </span><span class="s3">12</span>
            <span class="s1">vertices_count </span><span class="s2">+= </span><span class="s3">4</span>
        <span class="s0">elif </span><span class="s1">cap </span><span class="s2">== </span><span class="s1">LINE_CAP_ROUND</span><span class="s2">:</span>
            <span class="s1">indices_count </span><span class="s2">+= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision </span><span class="s2">* </span><span class="s3">3</span><span class="s2">) * </span><span class="s3">2</span>
            <span class="s1">vertices_count </span><span class="s2">+= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision</span><span class="s2">) * </span><span class="s3">2</span>

        <span class="s1">vertices </span><span class="s2">= &lt;</span><span class="s1">vertex_t </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s1">vertices_count </span><span class="s2">* </span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">vertex_t</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">vertices </span><span class="s2">== </span><span class="s1">NULL</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s5">'vertices'</span><span class="s2">)</span>

        <span class="s1">indices </span><span class="s2">= &lt;</span><span class="s1">unsigned short </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s1">indices_count </span><span class="s2">* </span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">unsigned short</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">indices </span><span class="s2">== </span><span class="s1">NULL</span><span class="s2">:</span>
            <span class="s1">free</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">)</span>
            <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s5">'indices'</span><span class="s2">)</span>

        <span class="s0">cdef </span><span class="s1">double ax</span><span class="s2">, </span><span class="s1">ay</span><span class="s2">, </span><span class="s1">bx</span><span class="s2">, </span><span class="s1">_by</span><span class="s2">, </span><span class="s1">cx</span><span class="s2">, </span><span class="s1">cy</span><span class="s2">, </span><span class="s1">angle</span><span class="s2">, </span><span class="s1">a1</span><span class="s2">, </span><span class="s1">a2</span>
        <span class="s0">cdef </span><span class="s1">double x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">, </span><span class="s1">y3</span><span class="s2">, </span><span class="s1">x4</span><span class="s2">, </span><span class="s1">y4</span>
        <span class="s0">cdef </span><span class="s1">double sx1</span><span class="s2">, </span><span class="s1">sy1</span><span class="s2">, </span><span class="s1">sx4</span><span class="s2">, </span><span class="s1">sy4</span><span class="s2">, </span><span class="s1">sangle</span>
        <span class="s0">cdef </span><span class="s1">double pcx</span><span class="s2">, </span><span class="s1">pcy</span><span class="s2">, </span><span class="s1">px1</span><span class="s2">, </span><span class="s1">py1</span><span class="s2">, </span><span class="s1">px2</span><span class="s2">, </span><span class="s1">py2</span><span class="s2">, </span><span class="s1">px3</span><span class="s2">, </span><span class="s1">py3</span><span class="s2">, </span><span class="s1">px4</span><span class="s2">, </span><span class="s1">py4</span><span class="s2">, </span><span class="s1">pangle </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">pangle2</span>
        <span class="s0">cdef </span><span class="s1">double w </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_width</span>
        <span class="s0">cdef </span><span class="s1">double ix</span><span class="s2">, </span><span class="s1">iy</span>
        <span class="s0">cdef </span><span class="s1">unsigned int piv</span><span class="s2">, </span><span class="s1">pii2</span><span class="s2">, </span><span class="s1">piv2</span><span class="s2">, </span><span class="s1">skip </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">double jangle</span>
        <span class="s1">angle </span><span class="s2">= </span><span class="s1">sangle </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">piv </span><span class="s2">= </span><span class="s1">pcx </span><span class="s2">= </span><span class="s1">pcy </span><span class="s2">= </span><span class="s1">cx </span><span class="s2">= </span><span class="s1">cy </span><span class="s2">= </span><span class="s1">ii </span><span class="s2">= </span><span class="s1">iv </span><span class="s2">= </span><span class="s1">ix </span><span class="s2">= </span><span class="s1">iy </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">px1 </span><span class="s2">= </span><span class="s1">px2 </span><span class="s2">= </span><span class="s1">px3 </span><span class="s2">= </span><span class="s1">px4 </span><span class="s2">= </span><span class="s1">py1 </span><span class="s2">= </span><span class="s1">py2 </span><span class="s2">= </span><span class="s1">py3 </span><span class="s2">= </span><span class="s1">py4 </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">sx1 </span><span class="s2">= </span><span class="s1">sy1 </span><span class="s2">= </span><span class="s1">sx4 </span><span class="s2">= </span><span class="s1">sy4 </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">x1 </span><span class="s2">= </span><span class="s1">x2 </span><span class="s2">= </span><span class="s1">x3 </span><span class="s2">= </span><span class="s1">x4 </span><span class="s2">= </span><span class="s1">y1 </span><span class="s2">= </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">y3 </span><span class="s2">= </span><span class="s1">y4 </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">double cos1 </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">cos2 </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">sin1 </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">sin2 </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">count </span><span class="s2">- </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">ax </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2</span><span class="s2">]</span>
            <span class="s1">ay </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">bx </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">]</span>
            <span class="s1">_by </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">]</span>

            <span class="s0">if </span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">ay</span><span class="s2">) == (</span><span class="s1">bx</span><span class="s2">, </span><span class="s1">_by</span><span class="s2">):</span>
                <span class="s1">skip </span><span class="s2">+= </span><span class="s3">1</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">i </span><span class="s2">- </span><span class="s1">skip </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">!= </span><span class="s1">LINE_JOINT_NONE</span><span class="s2">:</span>
                <span class="s1">pcx </span><span class="s2">= </span><span class="s1">cx</span>
                <span class="s1">pcy </span><span class="s2">= </span><span class="s1">cy</span>
                <span class="s1">px1 </span><span class="s2">= </span><span class="s1">x1</span>
                <span class="s1">px2 </span><span class="s2">= </span><span class="s1">x2</span>
                <span class="s1">px3 </span><span class="s2">= </span><span class="s1">x3</span>
                <span class="s1">px4 </span><span class="s2">= </span><span class="s1">x4</span>
                <span class="s1">py1 </span><span class="s2">= </span><span class="s1">y1</span>
                <span class="s1">py2 </span><span class="s2">= </span><span class="s1">y2</span>
                <span class="s1">py3 </span><span class="s2">= </span><span class="s1">y3</span>
                <span class="s1">py4 </span><span class="s2">= </span><span class="s1">y4</span>

            <span class="s1">piv2 </span><span class="s2">= </span><span class="s1">piv</span>
            <span class="s1">piv </span><span class="s2">= </span><span class="s1">iv</span>
            <span class="s1">pangle2 </span><span class="s2">= </span><span class="s1">pangle</span>
            <span class="s1">pangle </span><span class="s2">= </span><span class="s1">angle</span>

            <span class="s4"># calculate the orientation of the segment, between pi and -pi</span>
            <span class="s1">cx </span><span class="s2">= </span><span class="s1">bx </span><span class="s2">- </span><span class="s1">ax</span>
            <span class="s1">cy </span><span class="s2">= </span><span class="s1">_by </span><span class="s2">- </span><span class="s1">ay</span>
            <span class="s1">angle </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span><span class="s1">cy</span><span class="s2">, </span><span class="s1">cx</span><span class="s2">)</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">- </span><span class="s1">PI2</span>
            <span class="s1">a2 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">+ </span><span class="s1">PI2</span>

            <span class="s4"># calculate the position of the segment</span>
            <span class="s1">cos1 </span><span class="s2">= </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">) * </span><span class="s1">w</span>
            <span class="s1">sin1 </span><span class="s2">= </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">) * </span><span class="s1">w</span>
            <span class="s1">cos2 </span><span class="s2">= </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">) * </span><span class="s1">w</span>
            <span class="s1">sin2 </span><span class="s2">= </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">) * </span><span class="s1">w</span>
            <span class="s1">x1 </span><span class="s2">= </span><span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos1</span>
            <span class="s1">y1 </span><span class="s2">= </span><span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin1</span>
            <span class="s1">x4 </span><span class="s2">= </span><span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos2</span>
            <span class="s1">y4 </span><span class="s2">= </span><span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin2</span>
            <span class="s1">x2 </span><span class="s2">= </span><span class="s1">bx </span><span class="s2">+ </span><span class="s1">cos1</span>
            <span class="s1">y2 </span><span class="s2">= </span><span class="s1">_by </span><span class="s2">+ </span><span class="s1">sin1</span>
            <span class="s1">x3 </span><span class="s2">= </span><span class="s1">bx </span><span class="s2">+ </span><span class="s1">cos2</span>
            <span class="s1">y3 </span><span class="s2">= </span><span class="s1">_by </span><span class="s2">+ </span><span class="s1">sin2</span>

            <span class="s0">if </span><span class="s1">i </span><span class="s2">- </span><span class="s1">skip </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">sx1 </span><span class="s2">= </span><span class="s1">x1</span>
                <span class="s1">sy1 </span><span class="s2">= </span><span class="s1">y1</span>
                <span class="s1">sx4 </span><span class="s2">= </span><span class="s1">x4</span>
                <span class="s1">sy4 </span><span class="s2">= </span><span class="s1">y4</span>
                <span class="s1">sangle </span><span class="s2">= </span><span class="s1">angle</span>

            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii    </span><span class="s2">] = </span><span class="s1">iv</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">2</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">] = </span><span class="s1">iv</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">2</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">3</span>
            <span class="s1">ii </span><span class="s2">+= </span><span class="s3">6</span>

            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">x1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">y1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">x2</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">y2</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">x3</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">y3</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">x4</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">y4</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>

            <span class="s4"># joint generation</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">- </span><span class="s1">skip </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_NONE</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s4"># calculate the angle of the previous and current segment</span>
            <span class="s1">jangle </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span>
                <span class="s1">cx </span><span class="s2">* </span><span class="s1">pcy </span><span class="s2">- </span><span class="s1">cy </span><span class="s2">* </span><span class="s1">pcx</span><span class="s2">,</span>
                <span class="s1">cx </span><span class="s2">* </span><span class="s1">pcx </span><span class="s2">+ </span><span class="s1">cy </span><span class="s2">* </span><span class="s1">pcy</span><span class="s2">)</span>

            <span class="s4"># in case of the angle is NULL, avoid the generation</span>
            <span class="s0">if </span><span class="s1">jangle </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_ROUND</span><span class="s2">:</span>
                    <span class="s1">vertices_count </span><span class="s2">-= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision</span>
                    <span class="s1">indices_count </span><span class="s2">-= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision </span><span class="s2">* </span><span class="s3">3</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_BEVEL</span><span class="s2">:</span>
                    <span class="s1">vertices_count </span><span class="s2">-= </span><span class="s3">1</span>
                    <span class="s1">indices_count </span><span class="s2">-= </span><span class="s3">3</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_MITER</span><span class="s2">:</span>
                    <span class="s1">vertices_count </span><span class="s2">-= </span><span class="s3">2</span>
                    <span class="s1">indices_count </span><span class="s2">-= </span><span class="s3">6</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_BEVEL</span><span class="s2">:</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ax</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ay</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s0">if </span><span class="s1">jangle </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">piv2 </span><span class="s2">+ </span><span class="s3">1</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">piv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">piv2 </span><span class="s2">+ </span><span class="s3">2</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">3</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                <span class="s1">ii </span><span class="s2">+= </span><span class="s3">3</span>
                <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>

            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_MITER</span><span class="s2">:</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ax</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ay</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s0">if </span><span class="s1">jangle </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">line_intersection</span><span class="s2">(</span><span class="s1">px1</span><span class="s2">, </span><span class="s1">py1</span><span class="s2">, </span><span class="s1">px2</span><span class="s2">, </span><span class="s1">py2</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, &amp;</span><span class="s1">ix</span><span class="s2">, &amp;</span><span class="s1">iy</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s1">vertices_count </span><span class="s2">-= </span><span class="s3">2</span>
                        <span class="s1">indices_count </span><span class="s2">-= </span><span class="s3">6</span>
                        <span class="s0">continue</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ix</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">iy</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">iv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">piv2 </span><span class="s2">+ </span><span class="s3">1</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">] = </span><span class="s1">iv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">] = </span><span class="s1">piv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
                    <span class="s1">ii </span><span class="s2">+= </span><span class="s3">6</span>
                    <span class="s1">iv </span><span class="s2">+= </span><span class="s3">2</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">line_intersection</span><span class="s2">(</span><span class="s1">px3</span><span class="s2">, </span><span class="s1">py3</span><span class="s2">, </span><span class="s1">px4</span><span class="s2">, </span><span class="s1">py4</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">, </span><span class="s1">y3</span><span class="s2">, </span><span class="s1">x4</span><span class="s2">, </span><span class="s1">y4</span><span class="s2">, &amp;</span><span class="s1">ix</span><span class="s2">, &amp;</span><span class="s1">iy</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s1">vertices_count </span><span class="s2">-= </span><span class="s3">2</span>
                        <span class="s1">indices_count </span><span class="s2">-= </span><span class="s3">6</span>
                        <span class="s0">continue</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ix</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">iy</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">iv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">piv2 </span><span class="s2">+ </span><span class="s3">2</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">] = </span><span class="s1">iv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">] = </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">3</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
                    <span class="s1">ii </span><span class="s2">+= </span><span class="s3">6</span>
                    <span class="s1">iv </span><span class="s2">+= </span><span class="s3">2</span>

            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_ROUND</span><span class="s2">:</span>

                <span class="s4"># cap end</span>
                <span class="s0">if </span><span class="s1">jangle </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">a1 </span><span class="s2">= </span><span class="s1">pangle2 </span><span class="s2">- </span><span class="s1">PI2</span>
                    <span class="s1">a2 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">+ </span><span class="s1">PI2</span>
                    <span class="s1">a0 </span><span class="s2">= </span><span class="s1">a2</span>
                    <span class="s1">step </span><span class="s2">= (</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">jangle</span><span class="s2">)) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision</span><span class="s2">)</span>
                    <span class="s1">pivstart </span><span class="s2">= </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">3</span>
                    <span class="s1">pivend </span><span class="s2">= </span><span class="s1">piv2 </span><span class="s2">+ </span><span class="s3">1</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">a1 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">- </span><span class="s1">PI2</span>
                    <span class="s1">a2 </span><span class="s2">= </span><span class="s1">pangle2 </span><span class="s2">+ </span><span class="s1">PI2</span>
                    <span class="s1">a0 </span><span class="s2">= </span><span class="s1">a1</span>
                    <span class="s1">step </span><span class="s2">= -(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">jangle</span><span class="s2">)) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision</span><span class="s2">)</span>
                    <span class="s1">pivstart </span><span class="s2">= </span><span class="s1">piv</span>
                    <span class="s1">pivend </span><span class="s2">= </span><span class="s1">piv2 </span><span class="s2">+ </span><span class="s3">2</span>
                <span class="s1">siv </span><span class="s2">= </span><span class="s1">iv</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ax</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ay</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
                <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision </span><span class="s2">- </span><span class="s3">1</span><span class="s2">):</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">ax </span><span class="s2">- </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a0 </span><span class="s2">- </span><span class="s1">step </span><span class="s2">* </span><span class="s1">j</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">ay </span><span class="s2">- </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a0 </span><span class="s2">- </span><span class="s1">step </span><span class="s2">* </span><span class="s1">j</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
                    <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
                    <span class="s0">if </span><span class="s1">j </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
                        <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = &lt;</span><span class="s1">unsigned short</span><span class="s2">&gt;</span><span class="s1">pivstart</span>
                        <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
                        <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">- </span><span class="s3">1</span>
                        <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                    <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
                    <span class="s1">ii </span><span class="s2">+= </span><span class="s3">3</span>
                <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
                <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">- </span><span class="s3">1</span>
                <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = &lt;</span><span class="s1">unsigned short</span><span class="s2">&gt;</span><span class="s1">pivend</span>
                <span class="s1">ii </span><span class="s2">+= </span><span class="s3">3</span>

        <span class="s4"># caps</span>
        <span class="s0">if </span><span class="s1">cap </span><span class="s2">== </span><span class="s1">LINE_CAP_SQUARE</span><span class="s2">:</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">x2 </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">y2 </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">x3 </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">y3 </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">2</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">] = </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">] = </span><span class="s1">iv</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">ii </span><span class="s2">+= </span><span class="s3">6</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">2</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">sx1 </span><span class="s2">- </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">sangle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">sy1 </span><span class="s2">- </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">sangle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">sx4 </span><span class="s2">- </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">sangle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">sy4 </span><span class="s2">- </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">sangle</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s3">0</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s3">3</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">] = </span><span class="s3">0</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">] = </span><span class="s1">iv</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">ii </span><span class="s2">+= </span><span class="s3">6</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">2</span>

        <span class="s0">elif </span><span class="s1">cap </span><span class="s2">== </span><span class="s1">LINE_CAP_ROUND</span><span class="s2">:</span>

            <span class="s4"># cap start</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">sangle </span><span class="s2">- </span><span class="s1">PI2</span>
            <span class="s1">a2 </span><span class="s2">= </span><span class="s1">sangle </span><span class="s2">+ </span><span class="s1">PI2</span>
            <span class="s1">step </span><span class="s2">= (</span><span class="s1">a1 </span><span class="s2">- </span><span class="s1">a2</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision</span><span class="s2">)</span>
            <span class="s1">siv </span><span class="s2">= </span><span class="s1">iv</span>
            <span class="s1">cx </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s1">cy </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">cx</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">cy</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision </span><span class="s2">- </span><span class="s3">1</span><span class="s2">):</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">cx </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a1 </span><span class="s2">+ </span><span class="s1">step </span><span class="s2">* </span><span class="s1">i</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">cy </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a1 </span><span class="s2">+ </span><span class="s1">step </span><span class="s2">* </span><span class="s1">i</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">1</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">1</span>
                <span class="s0">if </span><span class="s1">i </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s3">0</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">- </span><span class="s3">1</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
                <span class="s1">ii </span><span class="s2">+= </span><span class="s3">3</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">- </span><span class="s3">1</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s3">3</span>
            <span class="s1">ii </span><span class="s2">+= </span><span class="s3">3</span>

            <span class="s4"># cap end</span>
            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">- </span><span class="s1">PI2</span>
            <span class="s1">a2 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">+ </span><span class="s1">PI2</span>
            <span class="s1">step </span><span class="s2">= (</span><span class="s1">a2 </span><span class="s2">- </span><span class="s1">a1</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision</span><span class="s2">)</span>
            <span class="s1">siv </span><span class="s2">= </span><span class="s1">iv</span>
            <span class="s1">cx </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[-</span><span class="s3">2</span><span class="s2">]</span>
            <span class="s1">cy </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">cx</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">cy</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision </span><span class="s2">- </span><span class="s3">1</span><span class="s2">):</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">cx </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a1 </span><span class="s2">+ </span><span class="s1">step </span><span class="s2">* </span><span class="s1">i</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;(</span><span class="s1">cy </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a1 </span><span class="s2">+ </span><span class="s1">step </span><span class="s2">* </span><span class="s1">i</span><span class="s2">) * </span><span class="s1">w</span><span class="s2">)</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s0">if </span><span class="s1">i </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">1</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">- </span><span class="s3">1</span>
                    <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">iv</span>
                <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
                <span class="s1">ii </span><span class="s2">+= </span><span class="s3">3</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">iv </span><span class="s2">- </span><span class="s3">1</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">piv </span><span class="s2">+ </span><span class="s3">2</span>
            <span class="s1">ii </span><span class="s2">+= </span><span class="s3">3</span>

        <span class="s0">while </span><span class="s1">ii </span><span class="s2">&lt; </span><span class="s1">indices_count</span><span class="s2">:</span>
            <span class="s4"># make all the remaining indices point to the last vertice</span>
            <span class="s1">indices</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">] = </span><span class="s1">siv</span>
            <span class="s1">ii </span><span class="s2">+= </span><span class="s3">1</span>

        <span class="s4"># compute bbox</span>
        <span class="s0">cdef </span><span class="s1">unsigned long iul</span>
        <span class="s0">for </span><span class="s1">iul </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">vertices_count</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmin</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmin </span><span class="s2">= </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">x</span>
            <span class="s0">if </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmax</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bxmax </span><span class="s2">= </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">x</span>
            <span class="s0">if </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bymin</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bymin </span><span class="s2">= </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">y</span>
            <span class="s0">if </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">y </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bymax</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bymax </span><span class="s2">= </span><span class="s1">vertices</span><span class="s2">[</span><span class="s1">iul</span><span class="s2">].</span><span class="s1">y</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">, &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">vertices_count</span><span class="s2">,</span>
                           <span class="s1">indices</span><span class="s2">, &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">indices_count</span><span class="s2">)</span>

        <span class="s1">free</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">)</span>
        <span class="s1">free</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">)</span>

    <span class="s1">property points</span><span class="s2">:</span>
        <span class="s5">'''Property for getting/settings points of the line 
 
        .. warning:: 
 
            This will always reconstruct the whole graphics from the new points 
            list. It can be very CPU expensive. 
        '''</span>
        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">points</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">points </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">points</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_points </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">chain</span><span class="s2">(*</span><span class="s1">points</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_points </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">points</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">= </span><span class="s1">LINE_MODE_POINTS</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property dash_length</span><span class="s2">:</span>
        <span class="s5">'''Property for getting/setting the length of the dashes in the curve 
 
        .. versionadded:: 1.0.8 
        '''</span>
        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid dash_length value, must be &gt;= 0'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_length </span><span class="s2">= </span><span class="s1">value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property dash_offset</span><span class="s2">:</span>
        <span class="s5">'''Property for getting/setting the offset between the dashes in the curve 
 
        .. versionadded:: 1.0.8 
        '''</span>
        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid dash_offset value, must be &gt;= 0'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_offset </span><span class="s2">= </span><span class="s1">value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property dashes</span><span class="s2">:</span>
        <span class="s5">'''Property for getting/setting ``dashes``. 
 
        List of [ON length, offset, ON length, offset, ...]. E.g. ``[2,4,1,6,8,2]`` 
        would create a line with the first dash length 2 then an offset of 4 then 
        a dash length of 1 then an offset of 6 and so on. 
 
        .. versionadded:: 1.11.0 
        '''</span>
        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_list</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_dash_list </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property width</span><span class="s2">:</span>
        <span class="s5">'''Determine the width of the line, defaults to 1.0. 
 
        .. versionadded:: 1.4.1 
        '''</span>
        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_width</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&lt;= </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid width value, must be &gt; 0'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_width </span><span class="s2">= </span><span class="s1">value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property cap</span><span class="s2">:</span>
        <span class="s5">'''Determine the cap of the line, defaults to 'round'. Can be one of 
        'none', 'square' or 'round' 
 
        .. versionadded:: 1.4.1 
        '''</span>
        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap </span><span class="s2">== </span><span class="s1">LINE_CAP_SQUARE</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s5">'square'</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap </span><span class="s2">== </span><span class="s1">LINE_CAP_ROUND</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s5">'round'</span>
            <span class="s0">return </span><span class="s5">'none'</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s0">not in </span><span class="s2">(</span><span class="s5">'none'</span><span class="s2">, </span><span class="s5">'square'</span><span class="s2">, </span><span class="s5">'round'</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid cap, must be one of '</span>
                        <span class="s5">'&quot;none&quot;, &quot;square&quot;, &quot;round&quot;'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">== </span><span class="s5">'square'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_cap </span><span class="s2">= </span><span class="s1">LINE_CAP_SQUARE</span>
            <span class="s0">elif </span><span class="s1">value </span><span class="s2">== </span><span class="s5">'round'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_cap </span><span class="s2">= </span><span class="s1">LINE_CAP_ROUND</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_cap </span><span class="s2">= </span><span class="s1">LINE_CAP_NONE</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property joint</span><span class="s2">:</span>
        <span class="s5">'''Determine the join of the line, defaults to 'round'. Can be one of 
        'none', 'round', 'bevel', 'miter'. 
 
        .. versionadded:: 1.4.1 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_ROUND</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s5">'round'</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_BEVEL</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s5">'bevel'</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">== </span><span class="s1">LINE_JOINT_MITER</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s5">'miter'</span>
            <span class="s0">return </span><span class="s5">'none'</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s0">not in </span><span class="s2">(</span><span class="s5">'none'</span><span class="s2">, </span><span class="s5">'miter'</span><span class="s2">, </span><span class="s5">'bevel'</span><span class="s2">, </span><span class="s5">'round'</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid joint, must be one of '</span>
                    <span class="s5">'&quot;none&quot;, &quot;miter&quot;, &quot;bevel&quot;, &quot;round&quot;'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">== </span><span class="s5">'round'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">= </span><span class="s1">LINE_JOINT_ROUND</span>
            <span class="s0">elif </span><span class="s1">value </span><span class="s2">== </span><span class="s5">'bevel'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">= </span><span class="s1">LINE_JOINT_BEVEL</span>
            <span class="s0">elif </span><span class="s1">value </span><span class="s2">== </span><span class="s5">'miter'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">= </span><span class="s1">LINE_JOINT_MITER</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_joint </span><span class="s2">= </span><span class="s1">LINE_JOINT_NONE</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property cap_precision</span><span class="s2">:</span>
        <span class="s5">'''Number of iteration for drawing the &quot;round&quot; cap, defaults to 10. 
        The cap_precision must be at least 1. 
 
        .. versionadded:: 1.4.1 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&lt; </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid cap_precision value, must be &gt;= 1'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cap_precision </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property joint_precision</span><span class="s2">:</span>
        <span class="s5">'''Number of iteration for drawing the &quot;round&quot; joint, defaults to 10. 
        The joint_precision must be at least 1. 
 
        .. versionadded:: 1.4.1 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&lt; </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid joint_precision value, must be &gt;= 1'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_joint_precision </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property close</span><span class="s2">:</span>
        <span class="s5">'''If True, the line will be closed by joining the two ends, according to :attr:`close_mode`. 
 
        .. versionadded:: 1.4.1 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_close </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">close_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">'''Defines how the ends of the line will be connected. 
        Defaults to ``&quot;straight-line&quot;``. 
 
        .. note:: 
            Support for the different closing modes depends on drawing shapes. 
 
        Available modes: 
 
        - ``&quot;straight-line&quot;`` (all drawing shapes): the ends will be closed by a straight line. 
        - ``&quot;center-connected&quot;`` (:attr:`ellipse` specific): the ends will be closed by a line passing through the center of the ellipse. 
 
        .. versionadded:: 2.2.0 
        '''</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode</span>

    <span class="s2">@</span><span class="s1">close_mode</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">close_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">not in </span><span class="s2">(</span><span class="s5">&quot;straight-line&quot;</span><span class="s2">, </span><span class="s5">&quot;center-connected&quot;</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">f'</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">} </span><span class="s5">- Invalid close_mode, must be one of &quot;straight-line&quot; or &quot;center-connected&quot;.'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property force_custom_drawing_method</span><span class="s2">:</span>
           <span class="s5">'''If True, the line will be drawn using the custom drawing method, no matter what the width is. 
 
           .. versionadded:: 2.3.0 
           '''</span>

           <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
               <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_force_custom_drawing_method</span>

           <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
               <span class="s1">self</span><span class="s2">.</span><span class="s1">_force_custom_drawing_method </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>
               <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s1">property ellipse</span><span class="s2">:</span>
        <span class="s5">'''Use this property to build an ellipse, without calculating the 
        :attr:`points`. 
 
        The argument must be a tuple of (x, y, width, height, angle_start, 
        angle_end, segments): 
 
        * x and y represent the bottom left of the ellipse 
        * width and height represent the size of the ellipse 
        * (optional) angle_start and angle_end are in degree. The default 
          value is 0 and 360. 
        * (optional) segments is the precision of the ellipse. The default 
          value is calculated from the range between angle. You can use this 
          property to create polygons with 3 or more sides. Values smaller than 
          3 will not be represented and the number of segments will be 
          automatically calculated. 
 
        Note that it's up to you to :attr:`close` or not. 
        If you choose to close, use :attr:`close_mode` to define how the figure 
        will be closed. Whether it will be by closed by a ``&quot;straight-line&quot;`` 
        or by ``&quot;center-connected&quot;``. 
 
        For example, for building a simple ellipse, in python:: 
 
            # simple ellipse 
            Line(ellipse=(0, 0, 150, 150)) 
 
            # only from 90 to 180 degrees 
            Line(ellipse=(0, 0, 150, 150, 90, 180)) 
 
            # only from 90 to 180 degrees, with few segments 
            Line(ellipse=(0, 0, 150, 150, 90, 180, 20)) 
 
        .. versionadded:: 1.4.1 
 
        .. versionchanged:: 2.2.0 
            Now you can get the ellipse generated through the property. 
 
            The minimum number of segments allowed is 3. Smaller values will be 
            ignored and the number of segments will be automatically calculated. 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ellipse</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">args </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span>
                        <span class="s5">'Invalid ellipse value: {0!r}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">args</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid number of arguments: '</span>
                        <span class="s5">'{0} instead of 4, 6 or 7.'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">= </span><span class="s1">LINE_MODE_ELLIPSE</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">void prebuild_ellipse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">double x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">angle_start </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">angle_end </span><span class="s2">= </span><span class="s3">360</span>
        <span class="s0">cdef </span><span class="s1">int angle_dir</span><span class="s2">, </span><span class="s1">segments </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">extra_segments </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">double angle_range</span>
        <span class="s0">cdef </span><span class="s1">tuple args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span>
        <span class="s0">cdef </span><span class="s1">bint center_connected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">== </span><span class="s5">&quot;center-connected&quot;</span>

        <span class="s1">extra_segments </span><span class="s2">= </span><span class="s3">3 </span><span class="s0">if </span><span class="s1">center_connected </span><span class="s0">else </span><span class="s3">1</span>

        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">4</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">6</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">angle_start</span><span class="s2">, </span><span class="s1">angle_end </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">7</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">angle_start</span><span class="s2">, </span><span class="s1">angle_end</span><span class="s2">, </span><span class="s1">segments </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">y </span><span class="s2">= </span><span class="s1">w </span><span class="s2">= </span><span class="s1">h </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s0">assert </span><span class="s3">0</span>

        <span class="s0">if </span><span class="s3">0 </span><span class="s0">in </span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">segments </span><span class="s2">&lt; </span><span class="s3">3</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">segments </span><span class="s2">!= </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">Logger</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s5">f'</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">} </span><span class="s5">- ellipse: A minimum of 3 segments is required. The default value will be used instead.'</span><span class="s2">)</span>
            <span class="s1">segments </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">angle_end </span><span class="s2">- </span><span class="s1">angle_start</span><span class="s2">) / </span><span class="s3">2</span><span class="s2">) + </span><span class="s1">extra_segments</span>

        <span class="s1">segments </span><span class="s2">+= </span><span class="s1">extra_segments</span>
        <span class="s1">segments </span><span class="s2">*= </span><span class="s3">2</span>

        <span class="s0">if </span><span class="s1">angle_end </span><span class="s2">&gt; </span><span class="s1">angle_start</span><span class="s2">:</span>
            <span class="s1">angle_dir </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">angle_dir </span><span class="s2">= -</span><span class="s3">1</span>

        <span class="s4"># Resulting ellipse</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ellipse </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">angle_start</span><span class="s2">, </span><span class="s1">angle_end</span><span class="s2">, </span><span class="s1">segments</span><span class="s2">)</span>
        <span class="s4"># Reset other properties</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rounded_rectangle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rectangle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_circle </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s4"># rad = deg * (pi / 180), where pi/180 = 0.0174...</span>
        <span class="s1">angle_start </span><span class="s2">= </span><span class="s1">angle_start </span><span class="s2">* </span><span class="s3">0.017453292519943295</span>
        <span class="s1">angle_end </span><span class="s2">= </span><span class="s1">angle_end </span><span class="s2">* </span><span class="s3">0.017453292519943295</span>
        <span class="s1">angle_range </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">angle_end </span><span class="s2">- </span><span class="s1">angle_start</span><span class="s2">) / (</span><span class="s1">segments </span><span class="s2">- </span><span class="s1">extra_segments </span><span class="s2">* </span><span class="s3">2</span><span class="s2">)</span>


        <span class="s0">cdef </span><span class="s1">list points </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, ] * </span><span class="s1">segments</span>
        <span class="s0">cdef </span><span class="s1">double angle</span>
        <span class="s0">cdef </span><span class="s1">double rx </span><span class="s2">= </span><span class="s1">w </span><span class="s2">* </span><span class="s3">0.5</span>
        <span class="s0">cdef </span><span class="s1">double ry </span><span class="s2">= </span><span class="s1">h </span><span class="s2">* </span><span class="s3">0.5</span>
        <span class="s0">cdef </span><span class="s1">int inc_x </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">inc_y </span><span class="s2">= </span><span class="s3">1</span>

        <span class="s0">if </span><span class="s1">center_connected </span><span class="s0">and </span><span class="s1">angle_start </span><span class="s2">!= </span><span class="s1">angle_end</span><span class="s2">:</span>
            <span class="s1">points</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">points</span><span class="s2">[</span><span class="s1">segments </span><span class="s2">- </span><span class="s3">2</span><span class="s2">] = </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">rx</span>
            <span class="s1">points</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">points</span><span class="s2">[</span><span class="s1">segments </span><span class="s2">- </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">ry</span>

            <span class="s1">inc_x </span><span class="s2">= </span><span class="s3">2</span>
            <span class="s1">inc_y </span><span class="s2">= </span><span class="s3">3</span>
            <span class="s1">segments </span><span class="s2">-= </span><span class="s3">4</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">segments</span><span class="s2">, </span><span class="s3">2</span><span class="s2">):</span>
            <span class="s1">angle </span><span class="s2">= </span><span class="s1">angle_start </span><span class="s2">+ (</span><span class="s1">angle_dir </span><span class="s2">* </span><span class="s1">i </span><span class="s2">* </span><span class="s1">angle_range</span><span class="s2">)</span>
            <span class="s1">points</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s1">inc_x</span><span class="s2">] = (</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">rx</span><span class="s2">) + (</span><span class="s1">rx </span><span class="s2">* </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">))</span>
            <span class="s1">points</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s1">inc_y</span><span class="s2">] = (</span><span class="s1">y </span><span class="s2">+ </span><span class="s1">ry</span><span class="s2">) + (</span><span class="s1">ry </span><span class="s2">* </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_points </span><span class="s2">= </span><span class="s1">points</span>

    <span class="s1">property circle</span><span class="s2">:</span>
        <span class="s5">'''Use this property to build a circle, without calculating the 
        :attr:`points`. 
 
        The argument must be a tuple of (center_x, center_y, radius, angle_start, 
        angle_end, segments): 
 
        * center_x and center_y represent the center of the circle 
        * radius represent the radius of the circle 
        * (optional) angle_start and angle_end are in degree. The default 
          value is 0 and 360. 
        * (optional) segments is the precision of the ellipse. The default 
          value is calculated from the range between angle. 
 
        Note that it's up to you to :attr:`close` the circle or not. 
 
        For example, for building a simple ellipse, in python:: 
 
            # simple circle 
            Line(circle=(150, 150, 50)) 
 
            # only from 90 to 180 degrees 
            Line(circle=(150, 150, 50, 90, 180)) 
 
            # only from 90 to 180 degrees, with few segments 
            Line(circle=(150, 150, 50, 90, 180, 20)) 
 
        .. versionadded:: 1.4.1 
 
        .. versionchanged:: 2.2.0 
            Now you can get the circle generated through the property. 
 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_circle</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">args </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span>
                        <span class="s5">'Invalid circle value: {0!r}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">args</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid number of arguments: '</span>
                        <span class="s5">'{0} instead of 3, 5 or 6.'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">= </span><span class="s1">LINE_MODE_CIRCLE</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">void prebuild_circle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">double x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">angle_start </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">angle_end </span><span class="s2">= </span><span class="s3">360</span>
        <span class="s0">cdef </span><span class="s1">int angle_dir</span><span class="s2">, </span><span class="s1">segments </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">double angle_range</span>
        <span class="s0">cdef </span><span class="s1">tuple args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span>

        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">3</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">5</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">angle_start</span><span class="s2">, </span><span class="s1">angle_end </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">6</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">angle_start</span><span class="s2">, </span><span class="s1">angle_end</span><span class="s2">, </span><span class="s1">segments </span><span class="s2">= </span><span class="s1">args</span>
            <span class="s1">segments </span><span class="s2">+= </span><span class="s3">1</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">y </span><span class="s2">= </span><span class="s1">r </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s0">assert </span><span class="s3">0</span>

        <span class="s0">if </span><span class="s1">angle_end </span><span class="s2">&gt; </span><span class="s1">angle_start</span><span class="s2">:</span>
            <span class="s1">angle_dir </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">angle_dir </span><span class="s2">= -</span><span class="s3">1</span>
        <span class="s0">if </span><span class="s1">segments </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">segments </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">angle_end </span><span class="s2">- </span><span class="s1">angle_start</span><span class="s2">) / </span><span class="s3">2</span><span class="s2">) + </span><span class="s3">3</span>

        <span class="s4"># Resulting circle</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_circle </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">angle_start</span><span class="s2">, </span><span class="s1">angle_end</span><span class="s2">, </span><span class="s1">segments</span><span class="s2">)</span>
        <span class="s4"># Reset other properties</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rounded_rectangle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rectangle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ellipse </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">segmentpoints </span><span class="s2">= </span><span class="s1">segments </span><span class="s2">* </span><span class="s3">2</span>

        <span class="s4"># rad = deg * (pi / 180), where pi/180 = 0.0174...</span>
        <span class="s1">angle_start </span><span class="s2">= </span><span class="s1">angle_start </span><span class="s2">* </span><span class="s3">0.017453292519943295</span>
        <span class="s1">angle_end </span><span class="s2">= </span><span class="s1">angle_end </span><span class="s2">* </span><span class="s3">0.017453292519943295</span>
        <span class="s1">angle_range </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">angle_end </span><span class="s2">- </span><span class="s1">angle_start</span><span class="s2">) / (</span><span class="s1">segmentpoints </span><span class="s2">- </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s0">cdef </span><span class="s1">list points </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, ] * </span><span class="s1">segmentpoints</span>
        <span class="s0">cdef </span><span class="s1">double angle</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">segmentpoints</span><span class="s2">, </span><span class="s3">2</span><span class="s2">):</span>
            <span class="s1">angle </span><span class="s2">= </span><span class="s1">angle_start </span><span class="s2">+ (</span><span class="s1">angle_dir </span><span class="s2">* </span><span class="s1">i </span><span class="s2">* </span><span class="s1">angle_range</span><span class="s2">)</span>
            <span class="s1">points</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">x </span><span class="s2">+ (</span><span class="s1">r </span><span class="s2">* </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">))</span>
            <span class="s1">points</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">y </span><span class="s2">+ (</span><span class="s1">r </span><span class="s2">* </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_points </span><span class="s2">= </span><span class="s1">points</span>

    <span class="s1">property rectangle</span><span class="s2">:</span>
        <span class="s5">'''Use this property to build a rectangle, without calculating the 
        :attr:`points`. 
 
        The argument must be a tuple of (x, y, width, height): 
 
        * x and y represent the bottom-left position of the rectangle 
        * width and height represent the size 
 
        The line is automatically closed. 
 
        Usage:: 
 
            Line(rectangle=(0, 0, 200, 200)) 
 
        .. versionadded:: 1.4.1 
 
        .. versionchanged:: 2.2.0 
            Now you can get the rectangle generated through the property. 
 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rectangle</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">args </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span>
                        <span class="s5">'Invalid rectangle value: {0!r}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">args</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) != </span><span class="s3">4</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid number of arguments: '</span>
                        <span class="s5">'{0} instead of 4.'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">= </span><span class="s1">LINE_MODE_RECTANGLE</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">void prebuild_rectangle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">double x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span>
        <span class="s0">cdef </span><span class="s1">int angle_dir</span><span class="s2">, </span><span class="s1">segments </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">double angle_range</span>
        <span class="s0">cdef </span><span class="s1">tuple args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span>

        <span class="s0">if </span><span class="s1">args </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span>
                    <span class="s5">'Invalid ellipse value: {0!r}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">args</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) == </span><span class="s3">4</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">y </span><span class="s2">= </span><span class="s1">width </span><span class="s2">= </span><span class="s1">height </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s0">assert </span><span class="s3">0</span>

        <span class="s4"># Resulting rectangle</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rectangle </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">)</span>
        <span class="s4"># Reset other properties</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rounded_rectangle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_circle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ellipse </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_points </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">height</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">height</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_close </span><span class="s2">= </span><span class="s3">1</span>

    <span class="s1">property rounded_rectangle</span><span class="s2">:</span>
        <span class="s5">'''Use this property to build a rectangle, without calculating the 
        :attr:`points`. 
 
        The argument must be a tuple of one of the following forms: 
 
        * (x, y, width, height, corner_radius) 
        * (x, y, width, height, corner_radius, resolution) 
        * (x, y, width, height, corner_radius1, corner_radius2, corner_radius3, corner_radius4) 
        * (x, y, width, height, corner_radius1, corner_radius2, corner_radius3, corner_radius4, resolution) 
 
        * `x` and `y` represent the bottom-left position of the rectangle. 
        * `width` and `height` represent the size. 
        * `corner_radius` specifies the radius used for the rounded corners clockwise: top-left, top-right, bottom-right, bottom-left. 
        * `resolution` is the number of line segment that will be used to draw the circle arc at each corner (defaults to 45). 
 
        The line is automatically closed. 
 
        Usage:: 
 
            Line(rounded_rectangle=(0, 0, 200, 200, 10, 20, 30, 40, 100)) 
 
        .. versionadded:: 1.9.0 
 
        .. versionchanged:: 2.2.0 
            Default value of `resolution` changed from 30 to 45. 
 
            Now you can get the rounded rectangle generated through the property. 
 
            The order of `corner_radius` has been changed to match the RoundedRectangle radius property (clockwise). 
            It was bottom-left, bottom-right, top-right, top-left in previous versions. 
            Now both are clockwise: top-left, top-right, bottom-right, bottom-left. 
            To keep the corner radius order without changing the order manually, you can use python's built-in method `reversed` or `[::-1]`, 
            to reverse the order of the corner radius. 
 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rounded_rectangle</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">args </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span>
                    <span class="s5">'Invalid rounded rectangle value: {0!r}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">args</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'invalid number of arguments:'</span>
                        <span class="s5">'{0} not in (5, 6, 8, 9)'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">= </span><span class="s1">LINE_MODE_ROUNDED_RECTANGLE</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">void prebuild_rounded_rectangle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">float a</span><span class="s2">, </span><span class="s1">max_a</span><span class="s2">, </span><span class="s1">px</span><span class="s2">, </span><span class="s1">py</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">c1</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">c4</span><span class="s2">, </span><span class="s1">step</span><span class="s2">, </span><span class="s1">min_dimension</span><span class="s2">, </span><span class="s1">half_min_dimension</span>
        <span class="s0">cdef </span><span class="s1">resolution </span><span class="s2">= </span><span class="s3">45</span>
        <span class="s0">cdef </span><span class="s1">int l </span><span class="s2">= &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_points </span><span class="s2">= []</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args </span><span class="s2">[:</span><span class="s3">4</span><span class="s2">]</span>

        <span class="s4"># zero size of the figure + avoid rendering issue with SmoothLine</span>
        <span class="s0">if </span><span class="s1">w </span><span class="s2">&lt;= </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">h </span><span class="s2">&lt;= </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">SmoothLine</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s1">w </span><span class="s2">&lt; </span><span class="s3">2 </span><span class="s0">or </span><span class="s1">h </span><span class="s2">&lt; </span><span class="s3">2</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">l </span><span class="s2">== </span><span class="s3">5</span><span class="s2">:</span>
            <span class="s1">c1 </span><span class="s2">= </span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">c3 </span><span class="s2">= </span><span class="s1">c4 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">[</span><span class="s3">4</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">l </span><span class="s2">== </span><span class="s3">6</span><span class="s2">:</span>
            <span class="s1">c1 </span><span class="s2">= </span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">c3 </span><span class="s2">= </span><span class="s1">c4 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">[</span><span class="s3">4</span><span class="s2">]</span>
            <span class="s1">resolution </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">[</span><span class="s3">5</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">l </span><span class="s2">== </span><span class="s3">8</span><span class="s2">:</span>
            <span class="s1">c1</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">c4 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">[</span><span class="s3">4</span><span class="s2">:]</span>
        <span class="s0">else</span><span class="s2">:  </span><span class="s4"># l == 9, but else make the compiler happy about uninitialization</span>
            <span class="s1">c1</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">c4 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">[</span><span class="s3">4</span><span class="s2">:</span><span class="s3">8</span><span class="s2">]</span>
            <span class="s1">resolution </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">[</span><span class="s3">8</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">resolution </span><span class="s2">&lt;= </span><span class="s3">4</span><span class="s2">:</span>
            <span class="s1">resolution </span><span class="s2">= </span><span class="s3">4</span>

        <span class="s4"># The minimum radius needs to be limited to 1px.</span>
        <span class="s4"># This avoid some known rendering issues with Line/SmoothLine.</span>
        <span class="s1">c1 </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">c1</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">)</span>
        <span class="s1">c2 </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">c2</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">)</span>
        <span class="s1">c3 </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">c3</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">)</span>
        <span class="s1">c4 </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">c4</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">)</span>
        <span class="s1">min_dimension </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>
        <span class="s1">half_min_dimension </span><span class="s2">= </span><span class="s1">min_dimension </span><span class="s2">/ </span><span class="s3">2.0</span>

        <span class="s4"># If larger values are passed for each corner, we will have to make some adjustments.</span>
        <span class="s0">if </span><span class="s1">c1 </span><span class="s2">&gt; </span><span class="s1">half_min_dimension</span><span class="s2">:</span>
            <span class="s1">c2 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c2</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c4 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c4</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c1 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c1</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c4</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">c2 </span><span class="s2">&gt; </span><span class="s1">half_min_dimension</span><span class="s2">:</span>
            <span class="s1">c1 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c1</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c3 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c3</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c2 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c2</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c1</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c3</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">c3 </span><span class="s2">&gt; </span><span class="s1">half_min_dimension</span><span class="s2">:</span>
            <span class="s1">c2 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c2</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c4 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c4</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c3 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c3</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c4</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">c4 </span><span class="s2">&gt; </span><span class="s1">half_min_dimension</span><span class="s2">:</span>
            <span class="s1">c3 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c3</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c1 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c1</span><span class="s2">, </span><span class="s1">half_min_dimension</span><span class="s2">)</span>
            <span class="s1">c4 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">c4</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">min_dimension </span><span class="s2">- </span><span class="s1">c1</span><span class="s2">)</span>

        <span class="s4"># Resulting rounded_rectangle</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rounded_rectangle </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">c1</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">c4</span><span class="s2">, </span><span class="s1">resolution</span><span class="s2">)</span>
        <span class="s4"># Reset other properties</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_rectangle </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ellipse </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_circle </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">step </span><span class="s2">= </span><span class="s1">PI </span><span class="s2">/ </span><span class="s1">resolution</span>
        <span class="s1">max_a </span><span class="s2">= </span><span class="s1">PI </span><span class="s2">/ </span><span class="s3">2.0 </span><span class="s2">- </span><span class="s1">step</span>

        <span class="s4"># top-left</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">0.0</span>
        <span class="s1">px </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">c1</span>
        <span class="s1">py </span><span class="s2">= </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">h </span><span class="s2">- </span><span class="s1">c1</span>

        <span class="s0">while </span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">max_a</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">+= </span><span class="s1">step</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span>
                <span class="s1">px </span><span class="s2">- </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c1</span><span class="s2">,</span>
                <span class="s1">py </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c1</span>
            <span class="s2">])</span>

        <span class="s4"># top-right</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">0.0</span>
        <span class="s1">px </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">w </span><span class="s2">- </span><span class="s1">c2</span>
        <span class="s1">py </span><span class="s2">= </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">h </span><span class="s2">- </span><span class="s1">c2</span>

        <span class="s0">while </span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">max_a</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">+= </span><span class="s1">step</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span>
                <span class="s1">px </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c2</span><span class="s2">,</span>
                <span class="s1">py </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c2</span>
            <span class="s2">])</span>

        <span class="s4"># bottom-right</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">0.0</span>
        <span class="s1">px </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">w </span><span class="s2">- </span><span class="s1">c3</span>
        <span class="s1">py </span><span class="s2">= </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">c3</span>

        <span class="s0">while </span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">max_a</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">+= </span><span class="s1">step</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span>
                <span class="s1">px </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c3</span><span class="s2">,</span>
                <span class="s1">py </span><span class="s2">- </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c3</span>
            <span class="s2">])</span>

        <span class="s4"># bottom-left</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">0.0</span>
        <span class="s1">px </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">c4</span>
        <span class="s1">py </span><span class="s2">= </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">c4</span>

        <span class="s0">while </span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">max_a</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">+= </span><span class="s1">step</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span>
                <span class="s1">px </span><span class="s2">- </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c4</span><span class="s2">,</span>
                <span class="s1">py </span><span class="s2">- </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) * </span><span class="s1">c4</span>
            <span class="s2">])</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_close </span><span class="s2">= </span><span class="s3">1</span>

    <span class="s1">property bezier</span><span class="s2">:</span>
        <span class="s5">'''Use this property to build a bezier line, without calculating the 
        :attr:`points`. You can only set this property, not get it. 
 
        The argument must be a tuple of 2n elements, n being the number of points. 
 
        Usage:: 
 
            Line(bezier=(x1, y1, x2, y2, x3, y3) 
 
        .. versionadded:: 1.4.2 
 
        .. note:: Bezier lines calculations are inexpensive for a low number of 
            points, but complexity is quadratic, so lines with a lot of points 
            can be very expensive to build, use with care! 
        '''</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">args </span><span class="s2">== </span><span class="s0">None or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">) % </span><span class="s3">2</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span>
                        <span class="s5">'Invalid bezier value: {0!r}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">args</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">= </span><span class="s1">LINE_MODE_BEZIER</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">void prebuild_bezier</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">double x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">l</span>
        <span class="s0">cdef </span><span class="s1">int segments </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bezier_precision</span>
        <span class="s0">cdef </span><span class="s1">list T </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode_args</span><span class="s2">)[:]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_points </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">segments</span><span class="s2">):</span>
            <span class="s1">l </span><span class="s2">= </span><span class="s1">x </span><span class="s2">/ (</span><span class="s3">1.0 </span><span class="s2">* </span><span class="s1">segments</span><span class="s2">)</span>
            <span class="s4"># http://en.wikipedia.org/wiki/De_Casteljau%27s_algorithm</span>
            <span class="s4"># as the list is in the form of (x1, y1, x2, y2...) iteration is</span>
            <span class="s4"># done on each item and the current item (xn or yn) in the list is</span>
            <span class="s4"># replaced with a calculation of &quot;xn + x(n+1) - xn&quot; x(n+1) is</span>
            <span class="s4"># placed at n+2. Each iteration makes the list one item shorter</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">T</span><span class="s2">)):</span>
                <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">xrange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">T</span><span class="s2">) - </span><span class="s3">2</span><span class="s2">*</span><span class="s1">i</span><span class="s2">):</span>
                    <span class="s1">T</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">T</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] + (</span><span class="s1">T</span><span class="s2">[</span><span class="s1">j</span><span class="s2">+</span><span class="s3">2</span><span class="s2">] - </span><span class="s1">T</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]) * </span><span class="s1">l</span>

            <span class="s4"># we got the coordinates of the point in T[0] and T[1]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">T</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">T</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>

        <span class="s4"># add one last point to join the curve to the end</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">T</span><span class="s2">[-</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_points</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">T</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s1">property bezier_precision</span><span class="s2">:</span>
        <span class="s5">'''Number of iteration for drawing the bezier between 2 segments, 
        defaults to 180. The bezier_precision must be at least 1. 
 
        .. versionadded:: 1.4.2 
        '''</span>

        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bezier_precision</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&lt; </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid bezier_precision value, must be &gt;= 1'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_bezier_precision </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>


<span class="s0">cdef class </span><span class="s1">SmoothLine</span><span class="s2">(</span><span class="s1">Line</span><span class="s2">):</span>
    <span class="s6">'''Experimental line using over-draw methods to get better anti-aliasing 
    results. It has few drawbacks: 
 
    - drawing a line with alpha will probably not have the intended result if 
      the line crosses itself. 
    - :attr:`~Line.cap`, :attr:`~Line.joint` and :attr:`~Line.dash` properties 
      are not supported. 
    - it uses a custom texture with a premultiplied alpha. 
    - lines under 1px in width are not supported: they will look the same. 
 
    .. warning:: 
 
        This is an unfinished work, experimental, and subject to crashes. 
 
    .. versionadded:: 1.9.0 
    '''</span>

    <span class="s0">cdef </span><span class="s1">float _owidth</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">Line</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_owidth </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">&quot;overdraw_width&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s2">&lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s3">1.2</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">set_mode</span><span class="s2">(</span><span class="s5">&quot;triangles&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">texture </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">premultiplied_texture</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">premultiplied_texture</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">texture </span><span class="s2">= </span><span class="s1">Cache</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">'kv.graphics.texture'</span><span class="s2">, </span><span class="s5">'smoothline'</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">texture</span><span class="s2">:</span>
            <span class="s1">texture </span><span class="s2">= </span><span class="s1">Texture</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s1">colorfmt</span><span class="s2">=</span><span class="s5">&quot;rgba&quot;</span><span class="s2">)</span>
            <span class="s1">texture</span><span class="s2">.</span><span class="s1">add_reload_observer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_smooth_reload_observer</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_smooth_reload_observer</span><span class="s2">(</span><span class="s1">texture</span><span class="s2">)</span>
            <span class="s1">Cache</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'kv.graphics.texture'</span><span class="s2">, </span><span class="s5">'smoothline'</span><span class="s2">, </span><span class="s1">texture</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">texture</span>

    <span class="s0">cpdef </span><span class="s1">_smooth_reload_observer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">texture</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">bytes GRADIENT_DATA </span><span class="s2">= (</span>
            <span class="s7">b&quot;</span><span class="s0">\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">texture</span><span class="s2">.</span><span class="s1">blit_buffer</span><span class="s2">(</span><span class="s1">GRADIENT_DATA</span><span class="s2">, </span><span class="s1">colorfmt</span><span class="s2">=</span><span class="s5">&quot;rgba&quot;</span><span class="s2">)</span>

    <span class="s0">cdef </span><span class="s1">void build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_ELLIPSE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_ellipse</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_CIRCLE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_circle</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_RECTANGLE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_rectangle</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_ROUNDED_RECTANGLE</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_rounded_rectangle</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mode </span><span class="s2">== </span><span class="s1">LINE_MODE_BEZIER</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">prebuild_bezier</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">build_smooth</span><span class="s2">()</span>

    <span class="s0">cdef </span><span class="s1">int apply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s0">except </span><span class="s2">-</span><span class="s3">1</span><span class="s2">:</span>
        <span class="s1">VertexInstruction</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s3">0</span>

    <span class="s4"># FIXME: Some artifacts can be observed, depending on the line width,</span>
    <span class="s4"># overdraw_width and radius. This occurs due to the way the vertices are</span>
    <span class="s4"># built. It is not noticeable when the alpha value of the color of the</span>
    <span class="s4"># active context is equal to 1. One solution would be to avoid overlapping</span>
    <span class="s4"># vertices.</span>
    <span class="s0">cdef </span><span class="s1">void build_smooth</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">cdef</span><span class="s2">:</span>
            <span class="s1">list p </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">points</span>
            <span class="s1">int must_close_line </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close</span>
            <span class="s1">double width </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_width </span><span class="s2">- </span><span class="s3">1.</span><span class="s2">))</span>
            <span class="s1">double owidth </span><span class="s2">= </span><span class="s1">width </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_owidth</span>
            <span class="s1">vertex_t </span><span class="s2">*</span><span class="s1">vertices </span><span class="s2">= </span><span class="s1">NULL</span>
            <span class="s1">unsigned short </span><span class="s2">*</span><span class="s1">indices </span><span class="s2">= </span><span class="s1">NULL</span>
            <span class="s1">unsigned short </span><span class="s2">*</span><span class="s1">tindices </span><span class="s2">= </span><span class="s1">NULL</span>
            <span class="s1">float min_distance_threshold </span><span class="s2">= </span><span class="s3">0.1</span>
            <span class="s1">double min_angle_threshold </span><span class="s2">= </span><span class="s3">0.017453292519943295  </span><span class="s4"># 1 degree in radians, determined empirically.</span>
            <span class="s1">double ax</span><span class="s2">, </span><span class="s1">ay</span><span class="s2">, </span><span class="s1">bx </span><span class="s2">= </span><span class="s3">0.</span><span class="s2">, </span><span class="s0">by </span><span class="s2">= </span><span class="s3">0.</span><span class="s2">, </span><span class="s1">rx </span><span class="s2">= </span><span class="s3">0.</span><span class="s2">, </span><span class="s1">ry </span><span class="s2">= </span><span class="s3">0.</span><span class="s2">, </span><span class="s1">last_angle </span><span class="s2">= </span><span class="s3">0.</span><span class="s2">, </span><span class="s1">angle</span><span class="s2">, </span><span class="s1">av_angle</span><span class="s2">, </span><span class="s1">ad_angle</span><span class="s2">, </span><span class="s1">angle_diff</span>
            <span class="s1">double cos1</span><span class="s2">, </span><span class="s1">sin1</span><span class="s2">, </span><span class="s1">cos2</span><span class="s2">, </span><span class="s1">sin2</span><span class="s2">, </span><span class="s1">ocos1</span><span class="s2">, </span><span class="s1">ocos2</span><span class="s2">, </span><span class="s1">osin1</span><span class="s2">, </span><span class="s1">osin2</span>
            <span class="s1">long index</span><span class="s2">, </span><span class="s1">icount</span><span class="s2">, </span><span class="s1">iv</span><span class="s2">, </span><span class="s1">ii</span><span class="s2">, </span><span class="s1">max_vindex</span><span class="s2">, </span><span class="s1">count</span>
            <span class="s1">unsigned short i0</span><span class="s2">, </span><span class="s1">i1</span><span class="s2">, </span><span class="s1">i2</span><span class="s2">, </span><span class="s1">i3</span><span class="s2">, </span><span class="s1">i4</span><span class="s2">, </span><span class="s1">i5</span><span class="s2">, </span><span class="s1">i6</span><span class="s2">, </span><span class="s1">i7</span><span class="s2">, </span><span class="s1">vindex</span><span class="s2">, </span><span class="s1">vcount</span>


        <span class="s4"># Points that are very close (with a distance less than 0.1) will</span>
        <span class="s4"># be discarded. This increases the reliability of line rendering.</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_remove_too_nearby_points</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">min_distance_threshold</span><span class="s2">)</span>

        <span class="s4"># If it is just a line segment, there will be no support to close the line.</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">p</span><span class="s2">) &lt;= </span><span class="s3">4</span><span class="s2">:</span>
            <span class="s1">must_close_line </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s4"># A new point needs to meet a minimum distance threshold before being added.</span>
        <span class="s0">if </span><span class="s1">must_close_line </span><span class="s0">and not </span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[-</span><span class="s3">2</span><span class="s2">] - </span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]) &lt; </span><span class="s1">min_distance_threshold </span><span class="s0">and </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] - </span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]) &lt; </span><span class="s1">min_distance_threshold</span><span class="s2">):</span>
            <span class="s1">p </span><span class="s2">= </span><span class="s1">p </span><span class="s2">+ </span><span class="s1">p</span><span class="s2">[:</span><span class="s3">2</span><span class="s2">]</span>

        <span class="s1">iv </span><span class="s2">= </span><span class="s1">vindex </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">count </span><span class="s2">= &lt;</span><span class="s1">long</span><span class="s2">&gt;</span><span class="s1">int</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">p</span><span class="s2">) / </span><span class="s3">2.</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">count </span><span class="s2">&lt; </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">clear_data</span><span class="s2">()</span>
            <span class="s0">return</span>

        <span class="s1">vcount </span><span class="s2">= &lt;</span><span class="s1">unsigned short</span><span class="s2">&gt;(</span><span class="s1">count </span><span class="s2">* </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">icount </span><span class="s2">= (</span><span class="s1">count </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) * </span><span class="s3">18</span>

        <span class="s1">vertices </span><span class="s2">= &lt;</span><span class="s1">vertex_t </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s1">vcount </span><span class="s2">* </span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">vertex_t</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">vertices </span><span class="s2">== </span><span class="s1">NULL</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s5">&quot;vertices&quot;</span><span class="s2">)</span>

        <span class="s1">indices </span><span class="s2">= &lt;</span><span class="s1">unsigned short </span><span class="s2">*&gt;</span><span class="s1">malloc</span><span class="s2">(</span><span class="s1">icount </span><span class="s2">* </span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">unsigned short</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">indices </span><span class="s2">== </span><span class="s1">NULL</span><span class="s2">:</span>
            <span class="s1">free</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">)</span>
            <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s5">&quot;indices&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">must_close_line </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">== </span><span class="s5">'straight-line'</span><span class="s2">:</span>
            <span class="s1">ax </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[-</span><span class="s3">4</span><span class="s2">]</span>
            <span class="s1">ay </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[-</span><span class="s3">3</span><span class="s2">]</span>
            <span class="s1">bx </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s0">by </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">rx </span><span class="s2">= </span><span class="s1">bx </span><span class="s2">- </span><span class="s1">ax</span>
            <span class="s1">ry </span><span class="s2">= </span><span class="s0">by </span><span class="s2">- </span><span class="s1">ay</span>
            <span class="s1">last_angle </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span><span class="s1">ry</span><span class="s2">, </span><span class="s1">rx</span><span class="s2">)</span>

        <span class="s1">max_index </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">max_index</span><span class="s2">, </span><span class="s3">2</span><span class="s2">):</span>
            <span class="s1">ax </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
            <span class="s1">ay </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>

            <span class="s0">if </span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">max_index </span><span class="s2">- </span><span class="s3">2</span><span class="s2">:</span>
                <span class="s1">bx </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">]</span>
                <span class="s0">by </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">]</span>
                <span class="s1">rx </span><span class="s2">= </span><span class="s1">bx </span><span class="s2">- </span><span class="s1">ax</span>
                <span class="s1">ry </span><span class="s2">= </span><span class="s0">by </span><span class="s2">- </span><span class="s1">ay</span>
                <span class="s1">angle </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span><span class="s1">ry</span><span class="s2">, </span><span class="s1">rx</span><span class="s2">)</span>

            <span class="s0">elif </span><span class="s1">must_close_line </span><span class="s0">and </span><span class="s1">index </span><span class="s2">== </span><span class="s1">max_index </span><span class="s2">- </span><span class="s3">2</span><span class="s2">:</span>
                <span class="s1">ax </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
                <span class="s1">ay </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>
                <span class="s1">bx </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">2</span><span class="s2">]</span>
                <span class="s0">by </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s3">3</span><span class="s2">]</span>
                <span class="s1">rx </span><span class="s2">= </span><span class="s1">bx </span><span class="s2">- </span><span class="s1">ax</span>
                <span class="s1">ry </span><span class="s2">= </span><span class="s0">by </span><span class="s2">- </span><span class="s1">ay</span>
                <span class="s1">angle </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span><span class="s1">ry</span><span class="s2">, </span><span class="s1">rx</span><span class="s2">)</span>

            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">angle </span><span class="s2">= </span><span class="s1">last_angle</span>

            <span class="s0">if </span><span class="s1">index </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">and </span><span class="s2">(</span><span class="s0">not </span><span class="s1">must_close_line </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">!= </span><span class="s5">'straight-line'</span><span class="s2">):</span>
                <span class="s1">av_angle </span><span class="s2">= </span><span class="s1">angle</span>
                <span class="s1">ad_angle </span><span class="s2">= </span><span class="s1">pi</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">av_angle </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span>
                        <span class="s1">sin</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) + </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">last_angle</span><span class="s2">),</span>
                        <span class="s1">cos</span><span class="s2">(</span><span class="s1">angle</span><span class="s2">) + </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">last_angle</span><span class="s2">))</span>

                <span class="s1">ad_angle </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pi </span><span class="s2">- </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">angle </span><span class="s2">- </span><span class="s1">last_angle</span><span class="s2">))</span>

            <span class="s1">a1 </span><span class="s2">= </span><span class="s1">av_angle </span><span class="s2">- </span><span class="s1">PI2</span>
            <span class="s1">a2 </span><span class="s2">= </span><span class="s1">av_angle </span><span class="s2">+ </span><span class="s1">PI2</span>


            <span class="s0">if </span><span class="s2">(</span><span class="s1">index </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s1">max_index </span><span class="s2">- </span><span class="s3">2</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s0">not </span><span class="s1">must_close_line </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_close_mode </span><span class="s2">!= </span><span class="s5">'straight-line'</span><span class="s2">):</span>
                <span class="s1">l </span><span class="s2">= </span><span class="s1">width</span>
                <span class="s1">ol </span><span class="s2">= </span><span class="s1">owidth</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">index </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">ox </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[- </span><span class="s3">4</span><span class="s2">]</span>
                    <span class="s1">oy </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[- </span><span class="s3">3</span><span class="s2">]</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">ox </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">- </span><span class="s3">2</span><span class="s2">]</span>
                    <span class="s1">oy </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">- </span><span class="s3">1</span><span class="s2">]</span>

                <span class="s1">la1 </span><span class="s2">= </span><span class="s1">last_angle </span><span class="s2">- </span><span class="s1">PI2</span>
                <span class="s1">la2 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">- </span><span class="s1">PI2</span>
                <span class="s1">ra1 </span><span class="s2">= </span><span class="s1">last_angle </span><span class="s2">+ </span><span class="s1">PI2</span>
                <span class="s1">ra2 </span><span class="s2">= </span><span class="s1">angle </span><span class="s2">+ </span><span class="s1">PI2</span>


                <span class="s1">angle_diff </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_angle_diff</span><span class="s2">(</span>
                    <span class="s1">ox </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                    <span class="s1">oy </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                    <span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                    <span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                    <span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                    <span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                    <span class="s1">bx </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                    <span class="s0">by </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                <span class="s2">)</span>

                <span class="s4"># If the angle difference is too small it is not safe to use</span>
                <span class="s4"># the calculated values of l or l. Otherwise, l and ol will</span>
                <span class="s4"># have extremely high values, causing the line to become</span>
                <span class="s4"># excessively thick at some intersections (in specific cases).</span>
                <span class="s0">if </span><span class="s1">angle_diff </span><span class="s2">&lt; </span><span class="s1">min_angle_threshold </span><span class="s0">or </span><span class="s1">ad_angle </span><span class="s2">&lt; </span><span class="s1">min_angle_threshold</span><span class="s2">:</span>
                    <span class="s1">l </span><span class="s2">= </span><span class="s1">width</span>
                    <span class="s1">ol </span><span class="s2">= </span><span class="s1">owidth</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">line_intersection</span><span class="s2">(</span>
                        <span class="s1">ox </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">la1</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s1">oy </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">la1</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">la1</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">la1</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">la2</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">la2</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s1">bx </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">la2</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s0">by </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">la2</span><span class="s2">) * </span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s2">&amp;</span><span class="s1">rx</span><span class="s2">, &amp;</span><span class="s1">ry</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s4"># print('ERROR LINE INTERSECTION 1')</span>
                        <span class="s0">pass</span>

                    <span class="s1">l </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">ax </span><span class="s2">- </span><span class="s1">rx</span><span class="s2">) ** </span><span class="s3">2 </span><span class="s2">+ (</span><span class="s1">ay </span><span class="s2">- </span><span class="s1">ry</span><span class="s2">) ** </span><span class="s3">2</span><span class="s2">)</span>

                    <span class="s0">if </span><span class="s1">line_intersection</span><span class="s2">(</span>
                        <span class="s1">ox </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s1">oy </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra1</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s1">bx </span><span class="s2">+ </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s0">by </span><span class="s2">+ </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">ra2</span><span class="s2">) * </span><span class="s1">owidth</span><span class="s2">,</span>
                        <span class="s2">&amp;</span><span class="s1">rx</span><span class="s2">, &amp;</span><span class="s1">ry</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s4"># print('ERROR LINE INTERSECTION 2')</span>
                        <span class="s0">pass</span>

                    <span class="s1">ol </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">ax </span><span class="s2">- </span><span class="s1">rx</span><span class="s2">) ** </span><span class="s3">2 </span><span class="s2">+ (</span><span class="s1">ay </span><span class="s2">- </span><span class="s1">ry</span><span class="s2">) ** </span><span class="s3">2</span><span class="s2">)</span>


            <span class="s1">last_angle </span><span class="s2">= </span><span class="s1">angle</span>

            <span class="s1">cos1 </span><span class="s2">= </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">) * </span><span class="s1">l</span>
            <span class="s1">sin1 </span><span class="s2">= </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">) * </span><span class="s1">l</span>
            <span class="s1">cos2 </span><span class="s2">= </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">) * </span><span class="s1">l</span>
            <span class="s1">sin2 </span><span class="s2">= </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">) * </span><span class="s1">l</span>

            <span class="s1">ocos1 </span><span class="s2">= </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">) * </span><span class="s1">ol</span>
            <span class="s1">osin1 </span><span class="s2">= </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">) * </span><span class="s1">ol</span>
            <span class="s1">ocos2 </span><span class="s2">= </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">) * </span><span class="s1">ol</span>
            <span class="s1">osin2 </span><span class="s2">= </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">) * </span><span class="s1">ol</span>

            <span class="s1">x1 </span><span class="s2">= </span><span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos1</span>
            <span class="s1">y1 </span><span class="s2">= </span><span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin1</span>
            <span class="s1">x2 </span><span class="s2">= </span><span class="s1">ax </span><span class="s2">+ </span><span class="s1">cos2</span>
            <span class="s1">y2 </span><span class="s2">= </span><span class="s1">ay </span><span class="s2">+ </span><span class="s1">sin2</span>

            <span class="s1">ox1 </span><span class="s2">= </span><span class="s1">ax </span><span class="s2">+ </span><span class="s1">ocos1</span>
            <span class="s1">oy1 </span><span class="s2">= </span><span class="s1">ay </span><span class="s2">+ </span><span class="s1">osin1</span>
            <span class="s1">ox2 </span><span class="s2">= </span><span class="s1">ax </span><span class="s2">+ </span><span class="s1">ocos2</span>
            <span class="s1">oy2 </span><span class="s2">= </span><span class="s1">ay </span><span class="s2">+ </span><span class="s1">osin2</span>

            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">x1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">y1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0.5</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0.25</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">x2</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">y2</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">0.5</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0.75</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ox1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">oy1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">ox2</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">y </span><span class="s2">= &lt;</span><span class="s1">float</span><span class="s2">&gt;</span><span class="s1">oy2</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">s0 </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s1">vertices</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">].</span><span class="s1">t0 </span><span class="s2">= </span><span class="s3">1</span>
            <span class="s1">iv </span><span class="s2">+= </span><span class="s3">1</span>

        <span class="s1">tindices </span><span class="s2">= </span><span class="s1">indices</span>
        <span class="s0">for </span><span class="s1">vindex </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">vcount </span><span class="s2">- </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">):</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">vindex</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">2</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">6</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">3</span><span class="s2">] = </span><span class="s1">vindex</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">4</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">6</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">5</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">4</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">6</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">7</span><span class="s2">] = </span><span class="s1">vindex</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">8</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">4</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">9</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">10</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">4</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">11</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">5</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">12</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">3</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">13</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">14</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">5</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">15</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">3</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">16</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">5</span>
            <span class="s1">tindices</span><span class="s2">[</span><span class="s3">17</span><span class="s2">] = </span><span class="s1">vindex </span><span class="s2">+ </span><span class="s3">7</span>
            <span class="s1">tindices </span><span class="s2">= </span><span class="s1">tindices </span><span class="s2">+ </span><span class="s3">18</span>

        <span class="s4"># print('tindices', &lt;long&gt;tindices, &lt;long&gt;indices, (&lt;long&gt;tindices - &lt;long&gt;indices) / sizeof(unsigned short))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">batch</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">, &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">vcount</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, &lt;</span><span class="s1">int</span><span class="s2">&gt;</span><span class="s1">icount</span><span class="s2">)</span>

        <span class="s1">free</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">)</span>
        <span class="s1">free</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">)</span>
    
    <span class="s0">cdef </span><span class="s1">list _remove_too_nearby_points</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">list p</span><span class="s2">, </span><span class="s1">float min_distance_threshold</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">int index </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s0">cdef </span><span class="s1">double x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">y2</span>

        <span class="s0">while </span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">p</span><span class="s2">) - </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">x1</span><span class="s2">, </span><span class="s1">y1 </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index</span><span class="s2">], </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">x2</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">], </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">+ </span><span class="s3">3</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">x1</span><span class="s2">) &lt; </span><span class="s1">min_distance_threshold </span><span class="s0">and </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y2 </span><span class="s2">- </span><span class="s1">y1</span><span class="s2">) &lt; </span><span class="s1">min_distance_threshold</span><span class="s2">:</span>
                <span class="s0">del </span><span class="s1">p</span><span class="s2">[</span><span class="s1">index </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">: </span><span class="s1">index </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">index </span><span class="s2">+= </span><span class="s3">2</span>
        <span class="s0">return </span><span class="s1">p</span>

    <span class="s0">cdef </span><span class="s1">double _get_angle_diff</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">double x1</span><span class="s2">, </span><span class="s1">double y1</span><span class="s2">, </span><span class="s1">double x2</span><span class="s2">, </span><span class="s1">double y2</span><span class="s2">, </span><span class="s1">double x3</span><span class="s2">, </span><span class="s1">double y3</span><span class="s2">, </span><span class="s1">double x4</span><span class="s2">, </span><span class="s1">double y4</span><span class="s2">):</span>
        <span class="s0">cdef </span><span class="s1">list vector_1</span><span class="s2">, </span><span class="s1">vector_2</span>

        <span class="s1">vector_1 </span><span class="s2">= [</span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">- </span><span class="s1">y1</span><span class="s2">]</span>
        <span class="s1">vector_2 </span><span class="s2">= [</span><span class="s1">x4 </span><span class="s2">- </span><span class="s1">x3</span><span class="s2">, </span><span class="s1">y4 </span><span class="s2">- </span><span class="s1">y3</span><span class="s2">]</span>

        <span class="s1">angle_1 </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span><span class="s1">vector_1</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">vector_1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">angle_2 </span><span class="s2">= </span><span class="s1">atan2</span><span class="s2">(</span><span class="s1">vector_2</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">vector_2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

        <span class="s1">angle_diff </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">angle_1 </span><span class="s2">- </span><span class="s1">angle_2</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">angle_diff </span><span class="s2">&gt; </span><span class="s1">pi</span><span class="s2">:</span>
            <span class="s1">angle_diff </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">pi </span><span class="s2">- </span><span class="s1">angle_diff</span>

        <span class="s0">return </span><span class="s1">angle_diff</span>


    <span class="s1">property overdraw_width</span><span class="s2">:</span>
        <span class="s5">'''Determine the overdraw width of the line, defaults to 1.2. 
        '''</span>
        <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_owidth</span>

        <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&lt;= </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">GraphicException</span><span class="s2">(</span><span class="s5">'Invalid width value, must be &gt; 0'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_owidth </span><span class="s2">= </span><span class="s1">value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">flag_data_update</span><span class="s2">()</span>
</pre>
</body>
</html>