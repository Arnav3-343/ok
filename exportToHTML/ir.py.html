<html>
<head>
<title>ir.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ir.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">defaultdict</span>
<span class="s0">import </span><span class="s1">copy</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">linecache</span>
<span class="s0">import </span><span class="s1">pprint</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">FunctionType</span><span class="s2">, </span><span class="s1">BuiltinFunctionType</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">total_ordering</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">StringIO</span>

<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">errors</span><span class="s2">, </span><span class="s1">config</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s2">(</span><span class="s1">BINOPS_TO_OPERATORS</span><span class="s2">, </span><span class="s1">INPLACE_BINOPS_TO_OPERATORS</span><span class="s2">,</span>
                              <span class="s1">UNARY_BUITINS_TO_OPERATORS</span><span class="s2">, </span><span class="s1">OPERATORS_TO_BUILTINS</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s2">(</span><span class="s1">NotDefinedError</span><span class="s2">, </span><span class="s1">RedefinedError</span><span class="s2">,</span>
                               <span class="s1">VerificationError</span><span class="s2">, </span><span class="s1">ConstantInferenceError</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">consts</span>

<span class="s3"># terminal color markup</span>
<span class="s1">_termcolor </span><span class="s2">= </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">termcolor</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">Loc</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Source location 
 
    &quot;&quot;&quot;</span>
    <span class="s1">_defmatcher </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s5">r'def\s+(\w+)'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">line</span><span class="s2">, </span><span class="s1">col</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">maybe_decorator</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; Arguments: 
        filename - name of the file 
        line - line in file 
        col - column 
        maybe_decorator - Set to True if location is likely a jit decorator 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">line </span><span class="s2">= </span><span class="s1">line</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">col </span><span class="s2">= </span><span class="s1">col</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lines </span><span class="s2">= </span><span class="s0">None </span><span class="s3"># the source lines from the linecache</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">maybe_decorator </span><span class="s2">= </span><span class="s1">maybe_decorator</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s3"># equivalence is solely based on filename, line and col</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s0">is not </span><span class="s1">type</span><span class="s2">(</span><span class="s1">other</span><span class="s2">): </span><span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">!= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">: </span><span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line </span><span class="s2">!= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">line</span><span class="s2">: </span><span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">col </span><span class="s2">!= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">col</span><span class="s2">: </span><span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">from_function_id</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">func_id</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">firstlineno</span><span class="s2">, </span><span class="s1">maybe_decorator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">&quot;Loc(filename=%s, line=%s, col=%s)&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">,</span>
                                                      <span class="s1">self</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">col</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">col </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;%s (%s:%s)&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">col</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;%s (%s)&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_find_definition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># try and find a def, go backwards from error line</span>
        <span class="s1">fn_name </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_lines</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[:</span><span class="s1">self</span><span class="s2">.</span><span class="s1">line </span><span class="s2">- </span><span class="s6">1</span><span class="s2">]):</span>
            <span class="s3"># the strip and startswith is to handle user code with commented out</span>
            <span class="s3"># 'def' or use of 'def' in a docstring.</span>
            <span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'def '</span><span class="s2">):</span>
                <span class="s1">fn_name </span><span class="s2">= </span><span class="s1">x</span>
                <span class="s0">break</span>

        <span class="s0">return </span><span class="s1">fn_name</span>

    <span class="s0">def </span><span class="s1">_raw_function_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">defn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_find_definition</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">defn</span><span class="s2">:</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_defmatcher</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">defn</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">())</span>
            <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">m</span><span class="s2">.</span><span class="s1">groups</span><span class="s2">()[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s3"># Probably exec(&lt;string&gt;) or REPL.</span>
        <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">get_lines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lines </span><span class="s0">is None</span><span class="s2">:</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">lines </span><span class="s2">= </span><span class="s1">linecache</span><span class="s2">.</span><span class="s1">getlines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_path</span><span class="s2">())</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lines</span>

    <span class="s0">def </span><span class="s1">_get_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># Try to get a relative path</span>
            <span class="s3"># ipython/jupyter input just returns as self.filename</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">relpath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s3"># Fallback to absolute path if error occurred in getting the</span>
            <span class="s3"># relative path.</span>
            <span class="s3"># This may happen on windows if the drive is different</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">path</span>


    <span class="s0">def </span><span class="s1">strformat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nlines_up</span><span class="s2">=</span><span class="s6">2</span><span class="s2">):</span>

        <span class="s1">lines </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_lines</span><span class="s2">()</span>

        <span class="s1">use_line </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">maybe_decorator</span><span class="s2">:</span>
            <span class="s3"># try and sort out a better `loc`, if it's suspected that this loc</span>
            <span class="s3"># points at a jit decorator by virtue of</span>
            <span class="s3"># `__code__.co_firstlineno`</span>

            <span class="s3"># get lines, add a dummy entry at the start as lines count from</span>
            <span class="s3"># 1 but list index counts from 0</span>
            <span class="s1">tmplines </span><span class="s2">= [</span><span class="s5">''</span><span class="s2">] + </span><span class="s1">lines</span>

            <span class="s0">if </span><span class="s1">lines </span><span class="s0">and </span><span class="s1">use_line </span><span class="s0">and </span><span class="s5">'def ' </span><span class="s0">not in </span><span class="s1">tmplines</span><span class="s2">[</span><span class="s1">use_line</span><span class="s2">]:</span>
                <span class="s3"># look forward 10 lines, unlikely anyone managed to stretch</span>
                <span class="s3"># a jit call declaration over &gt;10 lines?!</span>
                <span class="s1">min_line </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">use_line</span><span class="s2">)</span>
                <span class="s1">max_line </span><span class="s2">= </span><span class="s1">use_line </span><span class="s2">+ </span><span class="s6">10</span>
                <span class="s1">selected </span><span class="s2">= </span><span class="s1">tmplines</span><span class="s2">[</span><span class="s1">min_line </span><span class="s2">: </span><span class="s1">max_line</span><span class="s2">]</span>
                <span class="s1">index </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">x </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">selected</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s5">'def ' </span><span class="s0">in </span><span class="s1">x</span><span class="s2">:</span>
                        <span class="s1">index </span><span class="s2">= </span><span class="s1">idx</span>
                        <span class="s0">break</span>
                <span class="s1">use_line </span><span class="s2">= </span><span class="s1">use_line </span><span class="s2">+ </span><span class="s1">index</span>


        <span class="s1">ret </span><span class="s2">= [] </span><span class="s3"># accumulates output</span>
        <span class="s0">if </span><span class="s1">lines </span><span class="s0">and </span><span class="s1">use_line </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s2">:</span>

            <span class="s0">def </span><span class="s1">count_spaces</span><span class="s2">(</span><span class="s1">string</span><span class="s2">):</span>
                <span class="s1">spaces </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">takewhile</span><span class="s2">(</span><span class="s1">str</span><span class="s2">.</span><span class="s1">isspace</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">string</span><span class="s2">)):</span>
                    <span class="s1">spaces </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s0">return </span><span class="s1">spaces</span>

            <span class="s3"># A few places in the code still use no `loc` or default to line 1</span>
            <span class="s3"># this is often in places where exceptions are used for the purposes</span>
            <span class="s3"># of flow control. As a result max is in use to prevent slice from</span>
            <span class="s3"># `[negative: positive]`</span>
            <span class="s1">selected </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">max</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">use_line </span><span class="s2">- </span><span class="s1">nlines_up</span><span class="s2">):</span><span class="s1">use_line</span><span class="s2">]</span>

            <span class="s3"># see if selected contains a definition</span>
            <span class="s1">def_found </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">selected</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s5">'def ' </span><span class="s0">in </span><span class="s1">x</span><span class="s2">:</span>
                    <span class="s1">def_found </span><span class="s2">= </span><span class="s0">True</span>

            <span class="s3"># no definition found, try and find one</span>
            <span class="s0">if not </span><span class="s1">def_found</span><span class="s2">:</span>
                <span class="s3"># try and find a def, go backwards from error line</span>
                <span class="s1">fn_name </span><span class="s2">= </span><span class="s0">None</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">[:</span><span class="s1">use_line </span><span class="s2">- </span><span class="s6">1</span><span class="s2">]):</span>
                    <span class="s0">if </span><span class="s5">'def ' </span><span class="s0">in </span><span class="s1">x</span><span class="s2">:</span>
                        <span class="s1">fn_name </span><span class="s2">= </span><span class="s1">x</span>
                        <span class="s0">break</span>
                <span class="s0">if </span><span class="s1">fn_name</span><span class="s2">:</span>
                    <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">fn_name</span><span class="s2">)</span>
                    <span class="s1">spaces </span><span class="s2">= </span><span class="s1">count_spaces</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
                    <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">*(</span><span class="s6">4 </span><span class="s2">+ </span><span class="s1">spaces</span><span class="s2">) + </span><span class="s5">'&lt;source elided&gt;</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">selected</span><span class="s2">:</span>
                <span class="s1">ret</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">selected</span><span class="s2">[:-</span><span class="s6">1</span><span class="s2">])</span>
                <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">_termcolor</span><span class="s2">.</span><span class="s1">highlight</span><span class="s2">(</span><span class="s1">selected</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">]))</span>

                <span class="s3"># point at the problem with a caret</span>
                <span class="s1">spaces </span><span class="s2">= </span><span class="s1">count_spaces</span><span class="s2">(</span><span class="s1">selected</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">])</span>
                <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">*(</span><span class="s1">spaces</span><span class="s2">) + </span><span class="s1">_termcolor</span><span class="s2">.</span><span class="s1">indicate</span><span class="s2">(</span><span class="s5">&quot;^&quot;</span><span class="s2">))</span>

        <span class="s3"># if in the REPL source may not be available</span>
        <span class="s0">if not </span><span class="s1">ret</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">lines</span><span class="s2">:</span>
                <span class="s1">ret </span><span class="s2">= </span><span class="s5">&quot;&lt;source missing, REPL/exec in use?&gt;&quot;</span>
            <span class="s0">elif </span><span class="s1">use_line </span><span class="s2">&lt;= </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">ret </span><span class="s2">= </span><span class="s5">&quot;&lt;source line number missing&gt;&quot;</span>


        <span class="s1">err </span><span class="s2">= </span><span class="s1">_termcolor</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">(</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">File &quot;%s&quot;, line %d:'</span><span class="s2">)+</span><span class="s5">'</span><span class="s0">\n</span><span class="s5">%s'</span>
        <span class="s1">tmp </span><span class="s2">= </span><span class="s1">err </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_path</span><span class="s2">(), </span><span class="s1">use_line</span><span class="s2">, </span><span class="s1">_termcolor</span><span class="s2">.</span><span class="s1">code</span><span class="s2">(</span><span class="s5">''</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)))</span>
        <span class="s0">return </span><span class="s1">tmp</span>

    <span class="s0">def </span><span class="s1">with_lineno</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">line</span><span class="s2">, </span><span class="s1">col</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return a new Loc with this line number. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">line</span><span class="s2">, </span><span class="s1">col</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">short</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Returns a short string 
        &quot;&quot;&quot;</span>
        <span class="s1">shortfilename </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s5">&quot;%s:%s&quot; </span><span class="s2">% (</span><span class="s1">shortfilename</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">line</span><span class="s2">)</span>


<span class="s3"># Used for annotating errors when source location is unknown.</span>
<span class="s1">unknown_loc </span><span class="s2">= </span><span class="s1">Loc</span><span class="s2">(</span><span class="s5">&quot;unknown location&quot;</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">total_ordering</span>
<span class="s0">class </span><span class="s1">SlotEqualityCheckMixin</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s3"># some ir nodes are __dict__ free using __slots__ instead, this mixin</span>
    <span class="s3"># should not trigger the unintended creation of __dict__.</span>
    <span class="s1">__slots__ </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s0">is </span><span class="s1">type</span><span class="s2">(</span><span class="s1">other</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__slots__</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) != </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
                    <span class="s0">return False</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return True</span>
        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">__le__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) &lt;= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">total_ordering</span>
<span class="s0">class </span><span class="s1">EqualityCheckMixin</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; Mixin for basic equality checking &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s0">is </span><span class="s1">type</span><span class="s2">(</span><span class="s1">other</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">fixup</span><span class="s2">(</span><span class="s1">adict</span><span class="s2">):</span>
                <span class="s1">bad </span><span class="s2">= (</span><span class="s5">'loc'</span><span class="s2">, </span><span class="s5">'scope'</span><span class="s2">)</span>
                <span class="s1">d </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">adict</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">bad</span><span class="s2">:</span>
                    <span class="s1">d</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">d</span>
            <span class="s1">d1 </span><span class="s2">= </span><span class="s1">fixup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>
            <span class="s1">d2 </span><span class="s2">= </span><span class="s1">fixup</span><span class="s2">(</span><span class="s1">other</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">d1 </span><span class="s2">== </span><span class="s1">d2</span><span class="s2">:</span>
                <span class="s0">return True</span>
        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">__le__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) &lt; </span><span class="s1">str</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">VarMap</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_con </span><span class="s2">= {}</span>

    <span class="s0">def </span><span class="s1">define</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">var</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RedefinedError</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">var</span>

    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotDefinedError</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__contains__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">pprint</span><span class="s2">.</span><span class="s1">pformat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">.</span><span class="s1">iterkeys</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s0">is </span><span class="s1">type</span><span class="s2">(</span><span class="s1">other</span><span class="s2">):</span>
            <span class="s3"># check keys only, else __eq__ ref cycles, scope -&gt; varmap -&gt; var</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">() == </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_con</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>
        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">AbstractRHS</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Abstract base class for anything that can be the RHS of an assignment. 
    This class **does not** define any methods. 
    &quot;&quot;&quot;</span>


<span class="s0">class </span><span class="s1">Inst</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Base class for all IR instructions. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        List the variables used (read or written) by the instruction. 
        &quot;&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">_rec_list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        A recursive helper used to implement list_vars() in subclasses. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">[</span><span class="s1">val</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">Inst</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">val</span><span class="s2">.</span><span class="s1">list_vars</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)):</span>
            <span class="s1">lst </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">val</span><span class="s2">:</span>
                <span class="s1">lst</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rec_list_vars</span><span class="s2">(</span><span class="s1">v</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">lst</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s1">lst </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">val</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s1">lst</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rec_list_vars</span><span class="s2">(</span><span class="s1">v</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">lst</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">[]</span>


<span class="s0">class </span><span class="s1">Stmt</span><span class="s2">(</span><span class="s1">Inst</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Base class for IR statements (instructions which can appear on their 
    own in a Block). 
    &quot;&quot;&quot;</span>
    <span class="s3"># Whether this statement ends its basic block (i.e. it will either jump</span>
    <span class="s3"># to another block or exit the function).</span>
    <span class="s1">is_terminator </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s3"># Whether this statement exits the function.</span>
    <span class="s1">is_exit </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rec_list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Terminator</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    IR statements that are terminators: the last statement in a block. 
    A terminator must either: 
    - exit the function 
    - jump to a block 
 
    All subclass of Terminator must override `.get_targets()` to return a list 
    of jump targets. 
    &quot;&quot;&quot;</span>
    <span class="s1">is_terminator </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">Expr</span><span class="s2">(</span><span class="s1">Inst</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    An IR expression (an instruction which can only be part of a larger 
    statement). 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, **</span><span class="s1">kws</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">= </span><span class="s1">op</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_kws </span><span class="s2">= </span><span class="s1">kws</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'_'</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">Inst</span><span class="s2">.</span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kws</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s5">'op'</span><span class="s2">, </span><span class="s5">'loc'</span><span class="s2">, </span><span class="s5">'_kws'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_kws</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">binop</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">BuiltinFunctionType</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'binop'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">=</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">=</span><span class="s1">rhs</span><span class="s2">,</span>
                   <span class="s1">static_lhs</span><span class="s2">=</span><span class="s1">UNDEFINED</span><span class="s2">, </span><span class="s1">static_rhs</span><span class="s2">=</span><span class="s1">UNDEFINED</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">inplace_binop</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">immutable_fn</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">BuiltinFunctionType</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">immutable_fn</span><span class="s2">, </span><span class="s1">BuiltinFunctionType</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'inplace_binop'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">immutable_fn</span><span class="s2">=</span><span class="s1">immutable_fn</span><span class="s2">,</span>
                   <span class="s1">lhs</span><span class="s2">=</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">=</span><span class="s1">rhs</span><span class="s2">,</span>
                   <span class="s1">static_lhs</span><span class="s2">=</span><span class="s1">UNDEFINED</span><span class="s2">, </span><span class="s1">static_rhs</span><span class="s2">=</span><span class="s1">UNDEFINED</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">unary</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, (</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">, </span><span class="s1">FunctionType</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'unary'</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">UNARY_BUITINS_TO_OPERATORS</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">call</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">vararg</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">varkwarg</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'call'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">func</span><span class="s2">=</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=</span><span class="s1">args</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">=</span><span class="s1">kws</span><span class="s2">,</span>
                   <span class="s1">vararg</span><span class="s2">=</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">varkwarg</span><span class="s2">=</span><span class="s1">varkwarg</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s1">target</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">build_tuple</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'build_tuple'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">items</span><span class="s2">=</span><span class="s1">items</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">build_list</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'build_list'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">items</span><span class="s2">=</span><span class="s1">items</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">build_set</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'build_set'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">items</span><span class="s2">=</span><span class="s1">items</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">build_map</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">items</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">literal_value</span><span class="s2">, </span><span class="s1">value_indexes</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'build_map'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">items</span><span class="s2">=</span><span class="s1">items</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">,</span>
                   <span class="s1">literal_value</span><span class="s2">=</span><span class="s1">literal_value</span><span class="s2">, </span><span class="s1">value_indexes</span><span class="s2">=</span><span class="s1">value_indexes</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">pair_first</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'pair_first'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">pair_second</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'pair_second'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">getiter</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'getiter'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">iternext</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'iternext'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">exhaust_iter</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">count</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'exhaust_iter'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s1">count</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'getattr'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">=</span><span class="s1">attr</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">getitem</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'getitem'</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">getitem</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">typed_getitem</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'typed_getitem'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">,</span>
                   <span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">static_getitem</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">index_var</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">index_var </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index_var</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'static_getitem'</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">getitem</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">,</span>
                   <span class="s1">index_var</span><span class="s2">=</span><span class="s1">index_var</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">cast</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        A node for implicit casting at the return statement 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'cast'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">phi</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Phi node 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s5">'phi'</span><span class="s2">, </span><span class="s1">incoming_values</span><span class="s2">=[], </span><span class="s1">incoming_blocks</span><span class="s2">=[], </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">make_function</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">closure</span><span class="s2">, </span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        A node for making a function object. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'make_function'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">code</span><span class="s2">=</span><span class="s1">code</span><span class="s2">, </span><span class="s1">closure</span><span class="s2">=</span><span class="s1">closure</span><span class="s2">, </span><span class="s1">defaults</span><span class="s2">=</span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">null</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        A node for null value. 
 
        This node is not handled by type inference. It is only added by 
        post-typing passes. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'null'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">undef</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        A node for undefined value specifically from LOAD_FAST_AND_CLEAR opcode. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s5">'undef'</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">dummy</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">info</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        A node for a dummy value. 
 
        This node is a place holder for carrying information through to a point 
        where it is rewritten into something valid. This node is not handled 
        by type inference or lowering. It's presence outside of the interpreter 
        renders IR as illegal. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">, </span><span class="s1">info</span><span class="s2">=</span><span class="s1">info</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s5">'call'</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">pres_order </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kws</span><span class="s2">.</span><span class="s1">items</span><span class="s2">() </span><span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">DIFF_IR </span><span class="s2">== </span><span class="s6">0 </span><span class="s0">else </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kws</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
            <span class="s1">kws </span><span class="s2">= </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s5">'%s=%s' </span><span class="s2">% (</span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">pres_order</span><span class="s2">)</span>
            <span class="s1">vararg </span><span class="s2">= </span><span class="s5">'*%s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">,) </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vararg </span><span class="s0">is not None else </span><span class="s5">''</span>
            <span class="s1">arglist </span><span class="s2">= </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">filter</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, [</span><span class="s1">args</span><span class="s2">, </span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">]))</span>
            <span class="s0">return </span><span class="s5">'call %s(%s)' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">func</span><span class="s2">, </span><span class="s1">arglist</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s5">'binop'</span><span class="s2">:</span>
            <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rhs</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fn </span><span class="s2">== </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">:</span>
                <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">lhs</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">OPERATORS_TO_BUILTINS</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fn</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s5">'%s %s %s' </span><span class="s2">% (</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">pres_order </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kws</span><span class="s2">.</span><span class="s1">items</span><span class="s2">() </span><span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">DIFF_IR </span><span class="s2">== </span><span class="s6">0 </span><span class="s0">else </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kws</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
            <span class="s1">args </span><span class="s2">= (</span><span class="s5">'%s=%s' </span><span class="s2">% (</span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">pres_order</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s5">'%s(%s)' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span><span class="s2">, </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">args</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_rec_list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_kws</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">infer_constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ConstantInferenceError</span><span class="s2">(</span><span class="s5">'%s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SetItem</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    target[index] = value 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">target</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'%s[%s] = %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">StaticSetItem</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    target[constant index] = value 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">index_var</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index_var</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">target</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index_var </span><span class="s2">= </span><span class="s1">index_var</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'%s[%r] = %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DelItem</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    del target[index] 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">target</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'del %s[%s]' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SetAttr</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">target</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">attr </span><span class="s2">= </span><span class="s1">attr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'(%s).%s = %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DelAttr</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">target</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">attr </span><span class="s2">= </span><span class="s1">attr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'del (%s).%s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">attr</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">StoreMap</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dct</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dct</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dct </span><span class="s2">= </span><span class="s1">dct</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">key </span><span class="s2">= </span><span class="s1">key</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'%s[%s] = %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dct</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Del</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">&quot;del %s&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">Raise</span><span class="s2">(</span><span class="s1">Terminator</span><span class="s2">):</span>
    <span class="s1">is_exit </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exception</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">exception </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exception</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exception </span><span class="s2">= </span><span class="s1">exception</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">&quot;raise %s&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exception</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[]</span>


<span class="s0">class </span><span class="s1">StaticRaise</span><span class="s2">(</span><span class="s1">Terminator</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Raise an exception class and arguments known at compile-time. 
    Note that if *exc_class* is None, a bare &quot;raise&quot; statement is implied 
    (i.e. re-raise the current exception). 
    &quot;&quot;&quot;</span>
    <span class="s1">is_exit </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">exc_class </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">type</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">exc_args </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s2">= </span><span class="s1">exc_class</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s2">= </span><span class="s1">exc_args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;&lt;static&gt; raise&quot;</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;&lt;static&gt; raise %s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s2">,)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;&lt;static&gt; raise %s(%s)&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s2">,</span>
                                     <span class="s5">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[]</span>


<span class="s0">class </span><span class="s1">DynamicRaise</span><span class="s2">(</span><span class="s1">Terminator</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Raise an exception class and some argument *values* unknown at compile-time. 
    Note that if *exc_class* is None, a bare &quot;raise&quot; statement is implied 
    (i.e. re-raise the current exception). 
    &quot;&quot;&quot;</span>
    <span class="s1">is_exit </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">exc_class </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">type</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">exc_args </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s2">= </span><span class="s1">exc_class</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s2">= </span><span class="s1">exc_args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;&lt;dynamic&gt; raise&quot;</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;&lt;dynamic&gt; raise %s&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s2">,)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">&quot;&lt;dynamic&gt; raise %s(%s)&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s2">,</span>
                                     <span class="s5">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[]</span>


<span class="s0">class </span><span class="s1">TryRaise</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;A raise statement inside a try-block 
    Similar to ``Raise`` but does not terminate. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exception</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">exception </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exception</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exception </span><span class="s2">= </span><span class="s1">exception</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">&quot;try_raise %s&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exception</span>


<span class="s0">class </span><span class="s1">StaticTryRaise</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;A raise statement inside a try-block. 
    Similar to ``StaticRaise`` but does not terminate. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">exc_class </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">type</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">exc_args </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s2">= </span><span class="s1">exc_class</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s2">= </span><span class="s1">exc_args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">f&quot;static_try_raise&quot;</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">f&quot;static_try_raise </span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s0">}</span><span class="s5">&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s5">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s5">f&quot;static_try_raise </span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s0">}</span><span class="s5">(</span><span class="s0">{</span><span class="s1">args</span><span class="s0">}</span><span class="s5">)&quot;</span>


<span class="s0">class </span><span class="s1">DynamicTryRaise</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;A raise statement inside a try-block. 
    Similar to ``DynamicRaise`` but does not terminate. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">exc_class </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">type</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">exc_args </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s2">= </span><span class="s1">exc_class</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s2">= </span><span class="s1">exc_args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">f&quot;dynamic_try_raise&quot;</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s5">f&quot;dynamic_try_raise </span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s0">}</span><span class="s5">&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s5">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_args</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s5">f&quot;dynamic_try_raise </span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s0">}</span><span class="s5">(</span><span class="s0">{</span><span class="s1">args</span><span class="s0">}</span><span class="s5">)&quot;</span>


<span class="s0">class </span><span class="s1">Return</span><span class="s2">(</span><span class="s1">Terminator</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Return to caller. 
    &quot;&quot;&quot;</span>
    <span class="s1">is_exit </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'return %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[]</span>


<span class="s0">class </span><span class="s1">Jump</span><span class="s2">(</span><span class="s1">Terminator</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Unconditional branch. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">target</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'jump %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">Branch</span><span class="s2">(</span><span class="s1">Terminator</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Conditional branch. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cond</span><span class="s2">, </span><span class="s1">truebr</span><span class="s2">, </span><span class="s1">falsebr</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">cond</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cond </span><span class="s2">= </span><span class="s1">cond</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">truebr </span><span class="s2">= </span><span class="s1">truebr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">falsebr </span><span class="s2">= </span><span class="s1">falsebr</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'branch %s, %s, %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cond</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">truebr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">falsebr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_targets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">truebr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">falsebr</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">Assign</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Assign to a variable. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">target</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'%s = %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Print</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Print some values. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">args</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">vararg </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">vararg </span><span class="s2">= </span><span class="s1">vararg</span>
        <span class="s3"># Constant-inferred arguments</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">consts </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'print(%s)' </span><span class="s2">% </span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Yield</span><span class="s2">(</span><span class="s1">Inst</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'yield %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,)</span>

    <span class="s0">def </span><span class="s1">list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">EnterWith</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Enter a &quot;with&quot; context 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">contextmanager</span><span class="s2">, </span><span class="s1">begin</span><span class="s2">, </span><span class="s1">end</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Parameters 
        ---------- 
        contextmanager : IR value 
        begin, end : int 
            The beginning and the ending offset of the with-body. 
        loc : ir.Loc instance 
            Source location 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">contextmanager</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">contextmanager </span><span class="s2">= </span><span class="s1">contextmanager</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">begin </span><span class="s2">= </span><span class="s1">begin</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">end </span><span class="s2">= </span><span class="s1">end</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'enter_with {}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">contextmanager</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">list_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">contextmanager</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">PopBlock</span><span class="s2">(</span><span class="s1">Stmt</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Marker statement for a pop block op code&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'pop_block'</span>


<span class="s0">class </span><span class="s1">Arg</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'arg(%d, name=%s)' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">infer_constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ConstantInferenceError</span><span class="s2">(</span><span class="s5">'%s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Const</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">use_literal_type</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>
        <span class="s3"># Note: need better way to tell if this is a literal or not.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">use_literal_type </span><span class="s2">= </span><span class="s1">use_literal_type</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'const(%s, %s)' </span><span class="s2">% (</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">).</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">infer_constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s3"># Override to not copy constant values in code</span>
        <span class="s0">return </span><span class="s1">Const</span><span class="s2">(</span>
            <span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
            <span class="s1">use_literal_type</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">use_literal_type</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">class </span><span class="s1">Global</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'global(%s: %s)' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">infer_constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s3"># don't copy value since it can fail (e.g. modules)</span>
        <span class="s3"># value is readonly and doesn't need copying</span>
        <span class="s0">return </span><span class="s1">Global</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">FreeVar</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    A freevar, as loaded by LOAD_DECREF. 
    (i.e. a variable defined in an enclosing non-global scope) 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s3"># index inside __code__.co_freevars</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s3"># variable name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s3"># frozen value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'freevar(%s: %s)' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">infer_constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s3"># Override to not copy constant values in code</span>
        <span class="s0">return </span><span class="s1">FreeVar</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
                       <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>



<span class="s0">class </span><span class="s1">Var</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Attributes 
    ----------- 
    - scope: Scope 
 
    - name: str 
 
    - loc: Loc 
        Definition location 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s3"># NOTE: Use of scope=None should be removed.</span>
        <span class="s0">assert </span><span class="s1">scope </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">= </span><span class="s1">scope</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'Var(%s, %s)' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">short</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">is_temp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">&quot;$&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">unversioned_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;The unversioned name of this variable, i.e. SSA renaming removed 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">redef_set </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">var_redefinitions</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">redef_set</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">k</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">versioned_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Known versioned names for this variable, i.e. known variable names in 
        the scope that have been formed from applying SSA to this variable 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get_versions_of</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">unversioned_name</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">all_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;All known versioned and unversioned names for this variable 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">versioned_names </span><span class="s2">| {</span><span class="s1">self</span><span class="s2">.</span><span class="s1">unversioned_name</span><span class="s2">,}</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">):</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">Var</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">memo</span><span class="s2">[</span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)] = </span><span class="s1">out</span>
        <span class="s0">return </span><span class="s1">out</span>


<span class="s0">class </span><span class="s1">Scope</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Attributes 
    ----------- 
    - parent: Scope 
        Parent scope 
 
    - localvars: VarMap 
        Scope-local variable map 
 
    - loc: Loc 
        Start of scope location 
 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">parent </span><span class="s0">is None or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">parent</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">parent </span><span class="s2">= </span><span class="s1">parent</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">localvars </span><span class="s2">= </span><span class="s1">VarMap</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">redefined </span><span class="s2">= </span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">var_redefinitions </span><span class="s2">= </span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">set</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">define</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Define a variable 
        &quot;&quot;&quot;</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">Var</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">.</span><span class="s1">define</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">v</span>

    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Refer to a variable.  Returns the latest version. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">redefined</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s5">&quot;%s.%d&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">redefined</span><span class="s2">[</span><span class="s1">name</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_exact</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_exact</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Refer to a variable.  The returned variable has the exact 
        name (exact variable version). 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">NotDefinedError</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_parent</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">raise</span>

    <span class="s0">def </span><span class="s1">get_or_define</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">redefined</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s5">&quot;%s.%d&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">redefined</span><span class="s2">[</span><span class="s1">name</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">define</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">redefine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">rename</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Redefine if the name is already defined 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">define</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s1">rename</span><span class="s2">:</span>
            <span class="s3"># Must use the same name if the variable is a cellvar, which</span>
            <span class="s3"># means it could be captured in a closure.</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">while True</span><span class="s2">:</span>
                <span class="s1">ct </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">redefined</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">redefined</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">ct </span><span class="s2">+ </span><span class="s6">1</span>
                <span class="s1">newname </span><span class="s2">= </span><span class="s5">&quot;%s.%d&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">ct </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">define</span><span class="s2">(</span><span class="s1">newname</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">RedefinedError</span><span class="s2">:</span>
                    <span class="s0">continue</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">var_redefinitions</span><span class="s2">[</span><span class="s1">name</span><span class="s2">].</span><span class="s1">add</span><span class="s2">(</span><span class="s1">newname</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">res</span>

    <span class="s0">def </span><span class="s1">get_versions_of</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Gets all known versions of a given name 
        &quot;&quot;&quot;</span>
        <span class="s1">vers </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">def </span><span class="s1">walk</span><span class="s2">(</span><span class="s1">thename</span><span class="s2">):</span>
            <span class="s1">redefs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">var_redefinitions</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">thename</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">redefs</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">redefs</span><span class="s2">:</span>
                    <span class="s1">vers</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
                    <span class="s1">walk</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">walk</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">vers</span>

    <span class="s0">def </span><span class="s1">make_temp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">Var</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s5">'$%d' </span><span class="s2">% </span><span class="s1">n</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">.</span><span class="s1">define</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">v</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">has_parent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent </span><span class="s0">is not None</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">&quot;Scope(has_parent=%r, num_vars=%d, %s)&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">has_parent</span><span class="s2">,</span>
                                                          <span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">localvars</span><span class="s2">),</span>
                                                          <span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Block</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;A code block 
 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">Loc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">= </span><span class="s1">scope</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">body </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>

    <span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">block </span><span class="s2">= </span><span class="s1">Block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s1">block</span><span class="s2">.</span><span class="s1">body </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[:]</span>
        <span class="s0">return </span><span class="s1">block</span>

    <span class="s0">def </span><span class="s1">find_exprs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Iterate over exprs of the given *op* in this block. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">Assign</span><span class="s2">):</span>
                <span class="s1">expr </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">Expr</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">op </span><span class="s0">is None or </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s1">op</span><span class="s2">:</span>
                        <span class="s0">yield </span><span class="s1">expr</span>

    <span class="s0">def </span><span class="s1">find_insts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Iterate over insts of the given class in this block. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">):</span>
                <span class="s0">yield </span><span class="s1">inst</span>

    <span class="s0">def </span><span class="s1">find_variable_assignment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Returns the assignment inst associated with variable &quot;name&quot;, None if 
        it cannot be found. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">find_insts</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">=</span><span class="s1">Assign</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">name</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">x</span>
        <span class="s0">return None</span>

    <span class="s0">def </span><span class="s1">prepend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">Stmt</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">Stmt</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">Stmt</span><span class="s2">)</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[:]</span>

    <span class="s0">def </span><span class="s1">dump</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s3"># Avoid early bind of sys.stdout as default value</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">file </span><span class="s0">or </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s5">'dump'</span><span class="s2">):</span>
                <span class="s1">inst</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">inst_vars </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">list_vars</span><span class="s2">())</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s5">'    %-40s %s' </span><span class="s2">% (</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">inst_vars</span><span class="s2">), </span><span class="s1">file</span><span class="s2">=</span><span class="s1">file</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">terminator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">is_terminated</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">].</span><span class="s1">is_terminator</span>

    <span class="s0">def </span><span class="s1">verify</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_terminated</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">VerificationError</span><span class="s2">(</span><span class="s5">&quot;Missing block terminator&quot;</span><span class="s2">)</span>
            <span class="s3"># Only the last instruction can be a terminator</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">[:-</span><span class="s6">1</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">is_terminator</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">VerificationError</span><span class="s2">(</span><span class="s5">&quot;Terminator before the last &quot;</span>
                                        <span class="s5">&quot;instruction&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">insert_after</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Insert *stmt* after *other*. 
        &quot;&quot;&quot;</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">index </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">insert_before_terminator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">Stmt</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_terminated</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">, </span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">&quot;&lt;ir.Block at %s&gt;&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,)</span>


<span class="s0">class </span><span class="s1">Loop</span><span class="s2">(</span><span class="s1">SlotEqualityCheckMixin</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Describes a loop-block 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s2">= </span><span class="s5">&quot;entry&quot;</span><span class="s2">, </span><span class="s5">&quot;exit&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">, </span><span class="s1">exit</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entry </span><span class="s2">= </span><span class="s1">entry</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exit </span><span class="s2">= </span><span class="s1">exit</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entry</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exit</span>
        <span class="s0">return </span><span class="s5">&quot;Loop(entry=%s, exit=%s)&quot; </span><span class="s2">% </span><span class="s1">args</span>


<span class="s0">class </span><span class="s1">With</span><span class="s2">(</span><span class="s1">SlotEqualityCheckMixin</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Describes a with-block 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s2">= </span><span class="s5">&quot;entry&quot;</span><span class="s2">, </span><span class="s5">&quot;exit&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">, </span><span class="s1">exit</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entry </span><span class="s2">= </span><span class="s1">entry</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exit </span><span class="s2">= </span><span class="s1">exit</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entry</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exit</span>
        <span class="s0">return </span><span class="s5">&quot;With(entry=%s, exit=%s)&quot; </span><span class="s2">% </span><span class="s1">args</span>


<span class="s0">class </span><span class="s1">FunctionIR</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">blocks</span><span class="s2">, </span><span class="s1">is_generator</span><span class="s2">, </span><span class="s1">func_id</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">,</span>
                 <span class="s1">definitions</span><span class="s2">, </span><span class="s1">arg_count</span><span class="s2">, </span><span class="s1">arg_names</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">= </span><span class="s1">blocks</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_generator </span><span class="s2">= </span><span class="s1">is_generator</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">func_id </span><span class="s2">= </span><span class="s1">func_id</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">loc</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arg_count </span><span class="s2">= </span><span class="s1">arg_count</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arg_names </span><span class="s2">= </span><span class="s1">arg_names</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_definitions </span><span class="s2">= </span><span class="s1">definitions</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_reset_analysis_variables</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">equal_ir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; Checks that the IR contained within is equal to the IR in other. 
        Equality is defined by being equal in fundamental structure (blocks, 
        labels, IR node type and the order in which they are defined) and the 
        IR nodes being equal. IR node equality essentially comes down to 
        ensuring a node's `.__dict__` or `.__slots__` is equal, with the 
        exception of ignoring 'loc' and 'scope' entries. The upshot is that the 
        comparison is essentially location and scope invariant, but otherwise 
        behaves as unsurprisingly as possible. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s0">is </span><span class="s1">type</span><span class="s2">(</span><span class="s1">other</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">blocks</span>
        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">diff_str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Compute a human readable difference in the IR, returns a formatted 
        string ready for printing. 
        &quot;&quot;&quot;</span>
        <span class="s1">msg </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">label</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">other_blk </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">label</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">other_blk </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">block </span><span class="s2">!= </span><span class="s1">other_blk</span><span class="s2">:</span>
                    <span class="s1">msg</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s5">&quot;Block %s differs&quot; </span><span class="s2">% </span><span class="s1">label</span><span class="s2">).</span><span class="s1">center</span><span class="s2">(</span><span class="s6">80</span><span class="s2">, </span><span class="s5">'-'</span><span class="s2">))</span>
                    <span class="s3"># see if the instructions are just a permutation</span>
                    <span class="s1">block_del </span><span class="s2">= [</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">block</span><span class="s2">.</span><span class="s1">body </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">Del</span><span class="s2">)]</span>
                    <span class="s1">oth_del </span><span class="s2">= [</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">other_blk</span><span class="s2">.</span><span class="s1">body </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">Del</span><span class="s2">)]</span>
                    <span class="s0">if </span><span class="s1">block_del </span><span class="s2">!= </span><span class="s1">oth_del</span><span class="s2">:</span>
                        <span class="s3"># this is a common issue, dels are all present, but</span>
                        <span class="s3"># order shuffled.</span>
                        <span class="s0">if </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">block_del</span><span class="s2">) == </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">oth_del</span><span class="s2">):</span>
                            <span class="s1">msg</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s5">&quot;Block %s contains the same dels but &quot;</span>
                                        <span class="s5">&quot;their order is different&quot;</span><span class="s2">) % </span><span class="s1">label</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">) &gt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other_blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">):</span>
                        <span class="s1">msg</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">&quot;This block contains more statements&quot;</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">) &lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other_blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">):</span>
                        <span class="s1">msg</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">&quot;Other block contains more statements&quot;</span><span class="s2">)</span>

                    <span class="s3"># find the indexes where they don't match</span>
                    <span class="s1">tmp </span><span class="s2">= []</span>
                    <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">stmts </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">,</span>
                                                    <span class="s1">other_blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">)):</span>
                        <span class="s1">b_s</span><span class="s2">, </span><span class="s1">o_s </span><span class="s2">= </span><span class="s1">stmts</span>
                        <span class="s0">if </span><span class="s1">b_s </span><span class="s2">!= </span><span class="s1">o_s</span><span class="s2">:</span>
                            <span class="s1">tmp</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>

                    <span class="s0">def </span><span class="s1">get_pad</span><span class="s2">(</span><span class="s1">ablock</span><span class="s2">, </span><span class="s1">l</span><span class="s2">):</span>
                        <span class="s1">pointer </span><span class="s2">= </span><span class="s5">'-&gt; '</span>
                        <span class="s1">sp </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pointer</span><span class="s2">) * </span><span class="s5">' '</span>
                        <span class="s1">pad </span><span class="s2">= []</span>
                        <span class="s1">nstmt </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ablock</span><span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nstmt</span><span class="s2">):</span>
                            <span class="s0">if </span><span class="s1">i </span><span class="s0">in </span><span class="s1">tmp</span><span class="s2">:</span>
                                <span class="s1">item </span><span class="s2">= </span><span class="s1">pointer</span>
                            <span class="s0">elif </span><span class="s1">i </span><span class="s2">&gt;= </span><span class="s1">l</span><span class="s2">:</span>
                                <span class="s1">item </span><span class="s2">= </span><span class="s1">pointer</span>
                            <span class="s0">else</span><span class="s2">:</span>
                                <span class="s1">item </span><span class="s2">= </span><span class="s1">sp</span>
                            <span class="s1">pad</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
                        <span class="s0">return </span><span class="s1">pad</span>

                    <span class="s1">min_stmt_len </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other_blk</span><span class="s2">.</span><span class="s1">body</span><span class="s2">))</span>

                    <span class="s0">with </span><span class="s1">StringIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">buf</span><span class="s2">:</span>
                        <span class="s1">it </span><span class="s2">= [(</span><span class="s5">&quot;self&quot;</span><span class="s2">, </span><span class="s1">block</span><span class="s2">), (</span><span class="s5">&quot;other&quot;</span><span class="s2">, </span><span class="s1">other_blk</span><span class="s2">)]</span>
                        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">_block </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
                            <span class="s1">buf</span><span class="s2">.</span><span class="s1">truncate</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
                            <span class="s1">_block</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">(</span><span class="s1">file</span><span class="s2">=</span><span class="s1">buf</span><span class="s2">)</span>
                            <span class="s1">stmts </span><span class="s2">= </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">splitlines</span><span class="s2">()</span>
                            <span class="s1">pad </span><span class="s2">= </span><span class="s1">get_pad</span><span class="s2">(</span><span class="s1">_block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">, </span><span class="s1">min_stmt_len</span><span class="s2">)</span>
                            <span class="s1">title </span><span class="s2">= (</span><span class="s5">&quot;%s: block %s&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">label</span><span class="s2">))</span>
                            <span class="s1">msg</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">title</span><span class="s2">.</span><span class="s1">center</span><span class="s2">(</span><span class="s6">80</span><span class="s2">, </span><span class="s5">'-'</span><span class="s2">))</span>
                            <span class="s1">msg</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s5">&quot;{0}{1}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in</span>
                                        <span class="s1">zip</span><span class="s2">(</span><span class="s1">pad</span><span class="s2">, </span><span class="s1">stmts</span><span class="s2">)])</span>
        <span class="s0">if </span><span class="s1">msg </span><span class="s2">== []:</span>
            <span class="s1">msg</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">&quot;IR is considered equivalent.&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_reset_analysis_variables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_consts </span><span class="s2">= </span><span class="s1">consts</span><span class="s2">.</span><span class="s1">ConstantInference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s3"># Will be computed by PostProcessor</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">generator_info </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">variable_lifetime </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s3"># { ir.Block: { variable names (potentially) alive at start of block } }</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">block_entry_vars </span><span class="s2">= {}</span>

    <span class="s0">def </span><span class="s1">derive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">blocks</span><span class="s2">, </span><span class="s1">arg_count</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">arg_names</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
               <span class="s1">force_non_generator</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Derive a new function IR from this one, using the given blocks, 
        and possibly modifying the argument count and generator flag. 
 
        Post-processing will have to be run again on the new IR. 
        &quot;&quot;&quot;</span>
        <span class="s1">firstblock </span><span class="s2">= </span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">min</span><span class="s2">(</span><span class="s1">blocks</span><span class="s2">)]</span>

        <span class="s1">new_ir </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">= </span><span class="s1">blocks</span>
        <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">firstblock</span><span class="s2">.</span><span class="s1">loc</span>
        <span class="s0">if </span><span class="s1">force_non_generator</span><span class="s2">:</span>
            <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">is_generator </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">arg_count </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">arg_count </span><span class="s2">= </span><span class="s1">arg_count</span>
        <span class="s0">if </span><span class="s1">arg_names </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">arg_names </span><span class="s2">= </span><span class="s1">arg_names</span>
        <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">_reset_analysis_variables</span><span class="s2">()</span>
        <span class="s3"># Make fresh func_id</span>
        <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">func_id </span><span class="s2">= </span><span class="s1">new_ir</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">derive</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">new_ir</span>

    <span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">new_ir </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">blocks </span><span class="s2">= {}</span>
        <span class="s1">block_entry_vars </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">label</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">new_block </span><span class="s2">= </span><span class="s1">block</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">blocks</span><span class="s2">[</span><span class="s1">label</span><span class="s2">] = </span><span class="s1">new_block</span>
            <span class="s0">if </span><span class="s1">block </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">block_entry_vars</span><span class="s2">:</span>
                <span class="s1">block_entry_vars</span><span class="s2">[</span><span class="s1">new_block</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">block_entry_vars</span><span class="s2">[</span><span class="s1">block</span><span class="s2">]</span>
        <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">= </span><span class="s1">blocks</span>
        <span class="s1">new_ir</span><span class="s2">.</span><span class="s1">block_entry_vars </span><span class="s2">= </span><span class="s1">block_entry_vars</span>
        <span class="s0">return </span><span class="s1">new_ir</span>

    <span class="s0">def </span><span class="s1">get_block_entry_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">block</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Return a set of variable names possibly alive at the beginning of 
        the block. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">block_entry_vars</span><span class="s2">[</span><span class="s1">block</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">infer_constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Try to infer the constant value of a given variable. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_consts</span><span class="s2">.</span><span class="s1">infer_constant</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_definition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">lhs_only</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Get the definition site for the given variable name or instance. 
        A Expr instance is returned by default, but if lhs_only is set 
        to True, the left-hand-side variable is returned instead. 
        &quot;&quot;&quot;</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Var</span><span class="s2">):</span>
                <span class="s1">lhs </span><span class="s2">= </span><span class="s1">value</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s1">lhs </span><span class="s2">= </span><span class="s1">value</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">value</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">lhs </span><span class="s0">if </span><span class="s1">lhs_only </span><span class="s0">else </span><span class="s1">value</span>
            <span class="s1">defs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_definitions</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">defs</span><span class="s2">) == </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s5">&quot;no definition for %r&quot;</span>
                               <span class="s2">% (</span><span class="s1">name</span><span class="s2">,))</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">defs</span><span class="s2">) &gt; </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s5">&quot;more than one definition for %r&quot;</span>
                               <span class="s2">% (</span><span class="s1">name</span><span class="s2">,))</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">defs</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">get_assignee</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs_value</span><span class="s2">, </span><span class="s1">in_blocks</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Finds the assignee for a given RHS value. If in_blocks is given the 
        search will be limited to the specified blocks. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">in_blocks </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">blocks </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">in_blocks</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">blocks </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">in_blocks</span><span class="s2">]]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">blocks </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">blk</span><span class="s2">] </span><span class="s0">for </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">in_blocks</span><span class="s2">)]</span>

        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs_value</span><span class="s2">, </span><span class="s1">AbstractRHS</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">blocks</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">assign </span><span class="s0">in </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">find_insts</span><span class="s2">(</span><span class="s1">Assign</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">assign</span><span class="s2">.</span><span class="s1">value </span><span class="s2">== </span><span class="s1">rhs_value</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">assign</span><span class="s2">.</span><span class="s1">target</span>

        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s5">&quot;Could not find an assignee for %s&quot; </span><span class="s2">% </span><span class="s1">rhs_value</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">dump</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">nofile </span><span class="s2">= </span><span class="s1">file </span><span class="s0">is None</span>
        <span class="s3"># Avoid early bind of sys.stdout as default value</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">file </span><span class="s0">or </span><span class="s1">StringIO</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">'label %s:' </span><span class="s2">% (</span><span class="s1">offset</span><span class="s2">,), </span><span class="s1">file</span><span class="s2">=</span><span class="s1">file</span><span class="s2">)</span>
            <span class="s1">block</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">(</span><span class="s1">file</span><span class="s2">=</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">nofile</span><span class="s2">:</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s1">file</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">HIGHLIGHT_DUMPS</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">import </span><span class="s1">pygments</span>
                <span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Please install pygments to see highlighted dumps&quot;</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">from </span><span class="s1">pygments </span><span class="s0">import </span><span class="s1">highlight</span>
                    <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">dump_style </span><span class="s0">import </span><span class="s1">NumbaIRLexer </span><span class="s0">as </span><span class="s1">lexer</span>
                    <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">dump_style </span><span class="s0">import </span><span class="s1">by_colorscheme</span>
                    <span class="s0">from </span><span class="s1">pygments</span><span class="s2">.</span><span class="s1">formatters </span><span class="s0">import </span><span class="s1">Terminal256Formatter</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s1">highlight</span><span class="s2">(</span><span class="s1">text</span><span class="s2">, </span><span class="s1">lexer</span><span class="s2">(), </span><span class="s1">Terminal256Formatter</span><span class="s2">(</span>
                        <span class="s1">style</span><span class="s2">=</span><span class="s1">by_colorscheme</span><span class="s2">())))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s1">text</span><span class="s2">)</span>


    <span class="s0">def </span><span class="s1">dump_to_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">StringIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sb</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">(</span><span class="s1">file</span><span class="s2">=</span><span class="s1">sb</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">sb</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">dump_generator_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">file </span><span class="s0">or </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span>
        <span class="s1">gi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generator_info</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;generator state variables:&quot;</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">gi</span><span class="s2">.</span><span class="s1">state_vars</span><span class="s2">), </span><span class="s1">file</span><span class="s2">=</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">yp </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">gi</span><span class="s2">.</span><span class="s1">yield_points</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;yield point #%d: live variables = %s, weak live variables = %s&quot;</span>
                  <span class="s2">% (</span><span class="s1">index</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">yp</span><span class="s2">.</span><span class="s1">live_vars</span><span class="s2">), </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">yp</span><span class="s2">.</span><span class="s1">weak_live_vars</span><span class="s2">)),</span>
                  <span class="s1">file</span><span class="s2">=</span><span class="s1">file</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">render_dot</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename_prefix</span><span class="s2">=</span><span class="s5">&quot;numba_ir&quot;</span><span class="s2">, </span><span class="s1">include_ir</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Render the CFG of the IR with GraphViz DOT via the 
        ``graphviz`` python binding. 
 
        Returns 
        ------- 
        g : graphviz.Digraph 
            Use `g.view()` to open the graph in the default PDF application. 
        &quot;&quot;&quot;</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">import </span><span class="s1">graphviz </span><span class="s0">as </span><span class="s1">gv</span>
        <span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ImportError</span><span class="s2">(</span>
                <span class="s5">&quot;The feature requires `graphviz` but it is not available. &quot;</span>
                <span class="s5">&quot;Please install with `pip install graphviz`&quot;</span>
            <span class="s2">)</span>
        <span class="s1">g </span><span class="s2">= </span><span class="s1">gv</span><span class="s2">.</span><span class="s1">Digraph</span><span class="s2">(</span>
            <span class="s1">filename</span><span class="s2">=</span><span class="s5">&quot;{}{}.dot&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
                <span class="s1">filename_prefix</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">unique_name</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s3"># Populate the nodes</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">StringIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sb</span><span class="s2">:</span>
                <span class="s1">blk</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">(</span><span class="s1">sb</span><span class="s2">)</span>
                <span class="s1">label </span><span class="s2">= </span><span class="s1">sb</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">include_ir</span><span class="s2">:</span>
                <span class="s1">label </span><span class="s2">= </span><span class="s5">''</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s5">r'  {}\l'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">label</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">()],</span>
                <span class="s2">)</span>
                <span class="s1">label </span><span class="s2">= </span><span class="s5">r&quot;block {}\l&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">k</span><span class="s2">) + </span><span class="s1">label</span>
                <span class="s1">g</span><span class="s2">.</span><span class="s1">node</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">k</span><span class="s2">), </span><span class="s1">label</span><span class="s2">=</span><span class="s1">label</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s5">'rect'</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">label </span><span class="s2">= </span><span class="s5">r&quot;{}\l&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
                <span class="s1">g</span><span class="s2">.</span><span class="s1">node</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">k</span><span class="s2">), </span><span class="s1">label</span><span class="s2">=</span><span class="s1">label</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s5">'circle'</span><span class="s2">)</span>
        <span class="s3"># Populate the edges</span>
        <span class="s0">for </span><span class="s1">src</span><span class="s2">, </span><span class="s1">blk </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">dst </span><span class="s0">in </span><span class="s1">blk</span><span class="s2">.</span><span class="s1">terminator</span><span class="s2">.</span><span class="s1">get_targets</span><span class="s2">():</span>
                <span class="s1">g</span><span class="s2">.</span><span class="s1">edge</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">src</span><span class="s2">), </span><span class="s1">str</span><span class="s2">(</span><span class="s1">dst</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">g</span>


<span class="s3"># A stub for undefined global reference</span>
<span class="s0">class </span><span class="s1">UndefinedType</span><span class="s2">(</span><span class="s1">EqualityCheckMixin</span><span class="s2">):</span>

    <span class="s1">_singleton </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">obj </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_singleton</span>
        <span class="s0">if </span><span class="s1">obj </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">obj</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s1">object</span><span class="s2">.</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_singleton </span><span class="s2">= </span><span class="s1">obj</span>
        <span class="s0">return </span><span class="s1">obj</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">&quot;Undefined&quot;</span>


<span class="s1">UNDEFINED </span><span class="s2">= </span><span class="s1">UndefinedType</span><span class="s2">()</span>
</pre>
</body>
</html>