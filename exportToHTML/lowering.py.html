<html>
<head>
<title>lowering.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
lowering.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">namedtuple</span><span class="s2">, </span><span class="s1">defaultdict</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">partial</span>

<span class="s0">import </span><span class="s1">llvmlite</span><span class="s2">.</span><span class="s1">ir</span>
<span class="s0">from </span><span class="s1">llvmlite</span><span class="s2">.</span><span class="s1">ir </span><span class="s0">import </span><span class="s1">Constant</span><span class="s2">, </span><span class="s1">IRBuilder</span>

<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s2">(</span><span class="s1">typing</span><span class="s2">, </span><span class="s1">utils</span><span class="s2">, </span><span class="s1">types</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">, </span><span class="s1">debuginfo</span><span class="s2">, </span><span class="s1">funcdesc</span><span class="s2">,</span>
                        <span class="s1">generators</span><span class="s2">, </span><span class="s1">config</span><span class="s2">, </span><span class="s1">ir_utils</span><span class="s2">, </span><span class="s1">cgutils</span><span class="s2">, </span><span class="s1">removerefctpass</span><span class="s2">,</span>
                        <span class="s1">targetconfig</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s2">(</span><span class="s1">LoweringError</span><span class="s2">, </span><span class="s1">new_error_context</span><span class="s2">, </span><span class="s1">TypingError</span><span class="s2">,</span>
                               <span class="s1">LiteralTypingError</span><span class="s2">, </span><span class="s1">UnsupportedError</span><span class="s2">,</span>
                               <span class="s1">NumbaDebugInfoWarning</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">funcdesc </span><span class="s0">import </span><span class="s1">default_mangler</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">environment </span><span class="s0">import </span><span class="s1">Environment</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">analysis </span><span class="s0">import </span><span class="s1">compute_use_defs</span><span class="s2">, </span><span class="s1">must_use_alloca</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">firstlinefinder </span><span class="s0">import </span><span class="s1">get_func_body_first_lineno</span>


<span class="s1">_VarArgItem </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">&quot;_VarArgItem&quot;</span><span class="s2">, (</span><span class="s3">&quot;vararg&quot;</span><span class="s2">, </span><span class="s3">&quot;index&quot;</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">BaseLower</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Lower IR to LLVM 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">library</span><span class="s2">, </span><span class="s1">fndesc</span><span class="s2">, </span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">library </span><span class="s2">= </span><span class="s1">library</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc </span><span class="s2">= </span><span class="s1">fndesc</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blocks </span><span class="s2">= </span><span class="s1">utils</span><span class="s2">.</span><span class="s1">SortedMap</span><span class="s2">(</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir </span><span class="s2">= </span><span class="s1">func_ir</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">generator_info </span><span class="s2">= </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">generator_info</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">metadata </span><span class="s2">= </span><span class="s1">metadata</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">flags </span><span class="s2">= </span><span class="s1">targetconfig</span><span class="s2">.</span><span class="s1">ConfigStack</span><span class="s2">.</span><span class="s1">top_or_none</span><span class="s2">()</span>

        <span class="s5"># Initialize LLVM</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">module </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">library</span><span class="s2">.</span><span class="s1">create_ir_module</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">unique_name</span><span class="s2">)</span>

        <span class="s5"># Python execution environment (will be available to the compiled</span>
        <span class="s5"># function).</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">env </span><span class="s2">= </span><span class="s1">Environment</span><span class="s2">.</span><span class="s1">from_fndesc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">)</span>

        <span class="s5"># Internal states</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pending_phis </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">varmap </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">firstblk </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= -</span><span class="s6">1</span>

        <span class="s5"># Specializes the target context as seen inside the Lowerer</span>
        <span class="s5"># This adds:</span>
        <span class="s5">#  - environment: the python execution environment</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">subtarget</span><span class="s2">(</span><span class="s1">environment</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">,</span>
                                         <span class="s1">fndesc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">)</span>

        <span class="s5"># Debuginfo</span>
        <span class="s1">dibuildercls </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">DIBuilder</span>
                        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_debuginfo</span>
                        <span class="s0">else </span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">DummyDIBuilder</span><span class="s2">)</span>

        <span class="s5"># debuginfo def location</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">defn_loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compute_def_location</span><span class="s2">()</span>

        <span class="s1">directives_only </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">dbg_directives_only</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debuginfo </span><span class="s2">= </span><span class="s1">dibuildercls</span><span class="s2">(</span><span class="s1">module</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
                                      <span class="s1">filepath</span><span class="s2">=</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">,</span>
                                      <span class="s1">cgctx</span><span class="s2">=</span><span class="s1">context</span><span class="s2">,</span>
                                      <span class="s1">directives_only</span><span class="s2">=</span><span class="s1">directives_only</span><span class="s2">)</span>

        <span class="s5"># Subclass initialization</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">init</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">call_conv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_conv</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">init_pyapi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Init the Python API and Environment Manager for the function being 
        lowered. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_python_api</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">)</span>

        <span class="s5"># Store environment argument for later use</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_env_manager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">env_body </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager</span><span class="s2">.</span><span class="s1">env_body</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">envarg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager</span><span class="s2">.</span><span class="s1">env_ptr</span>

    <span class="s0">def </span><span class="s1">_compute_def_location</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Debuginfo requires source to be accurate. Find it and warn if not</span>
        <span class="s5"># found. If it's not found, use the func_ir line + 1, this assumes that</span>
        <span class="s5"># the function definition is decorated with a 1 line jit decorator.</span>
        <span class="s1">defn_loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">with_lineno</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">line </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_debuginfo</span><span class="s2">:</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span>
            <span class="s1">optional_lno </span><span class="s2">= </span><span class="s1">get_func_body_first_lineno</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">optional_lno </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s5"># -1 as lines start at 1 and this is an offset.</span>
                <span class="s1">offset </span><span class="s2">= </span><span class="s1">optional_lno </span><span class="s2">- </span><span class="s6">1</span>
                <span class="s1">defn_loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">with_lineno</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= (</span><span class="s3">&quot;Could not find source for function: &quot;</span>
                       <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func</span><span class="s0">}</span><span class="s3">. Debug line information &quot;</span>
                       <span class="s3">&quot;may be inaccurate.&quot;</span><span class="s2">)</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s1">NumbaDebugInfoWarning</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">defn_loc</span>

    <span class="s0">def </span><span class="s1">pre_lower</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Called before lowering all blocks. 
        &quot;&quot;&quot;</span>
        <span class="s5"># A given Lower object can be used for several LL functions</span>
        <span class="s5"># (for generators) and it's important to use a new API and</span>
        <span class="s5"># EnvironmentManager.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">mark_subprogram</span><span class="s2">(</span><span class="s1">function</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">function</span><span class="s2">,</span>
                                       <span class="s1">qualname</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">qualname</span><span class="s2">,</span>
                                       <span class="s1">argnames</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">args</span><span class="s2">,</span>
                                       <span class="s1">argtypes</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">argtypes</span><span class="s2">,</span>
                                       <span class="s1">line</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">defn_loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">)</span>

        <span class="s5"># When full debug info is enabled, disable inlining where possible, to</span>
        <span class="s5"># improve the quality of the debug experience. 'alwaysinline' functions</span>
        <span class="s5"># cannot have inlining disabled.</span>
        <span class="s1">attributes </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">function</span><span class="s2">.</span><span class="s1">attributes</span>
        <span class="s1">full_debug </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">debuginfo </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">dbg_directives_only</span>
        <span class="s0">if </span><span class="s1">full_debug </span><span class="s0">and </span><span class="s3">'alwaysinline' </span><span class="s0">not in </span><span class="s1">attributes</span><span class="s2">:</span>
            <span class="s1">attributes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">'noinline'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">post_lower</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Called after all blocks are lowered 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">finalize</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">pre_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">block</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Called before lowering a block. 
        &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">post_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">block</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Called after lowering a block. 
        &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">return_dynamic_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">nb_types</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_dynamic_user_exc</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">nb_types</span><span class="s2">,</span>
            <span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">func_name</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func_name</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">return_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Propagate exception to the caller. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_user_exc</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">,</span>
            <span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">func_name</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func_name</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">set_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Set exception state in the current function. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">set_static_user_exc</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">,</span>
            <span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">func_name</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">func_name</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">emit_environment_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Emit a pointer to hold the Environment object. 
        &quot;&quot;&quot;</span>
        <span class="s5"># Define global for the environment and initialize it to NULL</span>
        <span class="s1">envname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_env_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">declare_env_global</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">envname</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Emit the Env into the module</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">emit_environment_object</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generator_info </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">genlower </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_normal_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">genlower </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">GeneratorLower</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">gentype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">.</span><span class="s1">gentype</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">.</span><span class="s1">lower_init_func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">.</span><span class="s1">lower_next_func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gentype</span><span class="s2">.</span><span class="s1">has_finalizer</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">.</span><span class="s1">lower_finalize_func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">DUMP_LLVM</span><span class="s2">:</span>
            <span class="s1">utils</span><span class="s2">.</span><span class="s1">dump_llvm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">)</span>

        <span class="s5"># Special optimization to remove NRT on functions that do not need it.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_nrt </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generator_info </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">removerefctpass</span><span class="s2">.</span><span class="s1">remove_unnecessary_nrt_usage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">function</span><span class="s2">,</span>
                                                         <span class="s1">context</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">,</span>
                                                         <span class="s1">fndesc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">)</span>

        <span class="s5"># Run target specific post lowering transformation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">post_lowering</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">library</span><span class="s2">)</span>

        <span class="s5"># Materialize LLVM Module</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">library</span><span class="s2">.</span><span class="s1">add_ir_module</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">extract_function_arguments</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fnargs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">decode_arguments</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                                      <span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">argtypes</span><span class="s2">,</span>
                                                      <span class="s1">self</span><span class="s2">.</span><span class="s1">function</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fnargs</span>

    <span class="s0">def </span><span class="s1">lower_normal_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fndesc</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Lower non-generator *fndesc*. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setup_function</span><span class="s2">(</span><span class="s1">fndesc</span><span class="s2">)</span>

        <span class="s5"># Init argument values</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">extract_function_arguments</span><span class="s2">()</span>
        <span class="s1">entry_block_tail </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_function_body</span><span class="s2">()</span>

        <span class="s5"># Close tail of entry block, do not emit debug metadata else the</span>
        <span class="s5"># unconditional jump gets associated with the metadata from the function</span>
        <span class="s5"># body end.</span>
        <span class="s0">with </span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">suspend_emission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">position_at_end</span><span class="s2">(</span><span class="s1">entry_block_tail</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">firstblk</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">lower_function_body</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Lower the current function's body, and return the entry block. 
        &quot;&quot;&quot;</span>
        <span class="s5"># Init Python blocks</span>
        <span class="s0">for </span><span class="s1">offset </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">:</span>
            <span class="s1">bname </span><span class="s2">= </span><span class="s3">&quot;B%s&quot; </span><span class="s2">% </span><span class="s1">offset</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">function</span><span class="s2">.</span><span class="s1">append_basic_block</span><span class="s2">(</span><span class="s1">bname</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">pre_lower</span><span class="s2">()</span>
        <span class="s5"># pre_lower() may have changed the current basic block</span>
        <span class="s1">entry_block_tail </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">basic_block</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">&quot;# function begin: {0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">unique_name</span><span class="s2">))</span>

        <span class="s5"># Lower all blocks</span>
        <span class="s0">for </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">bb </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">position_at_end</span><span class="s2">(</span><span class="s1">bb</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">f&quot;# lower block: </span><span class="s0">{</span><span class="s1">offset</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_block</span><span class="s2">(</span><span class="s1">block</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">post_lower</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">entry_block_tail</span>

    <span class="s0">def </span><span class="s1">lower_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">block</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Lower the given block. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pre_block</span><span class="s2">(</span><span class="s1">block</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">block</span><span class="s2">.</span><span class="s1">body</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">loc</span>
            <span class="s1">defaulterrcls </span><span class="s2">= </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">LoweringError</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">new_error_context</span><span class="s2">(</span><span class="s3">'lowering &quot;{inst}&quot; at {loc}'</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">=</span><span class="s1">inst</span><span class="s2">,</span>
                                   <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">errcls_</span><span class="s2">=</span><span class="s1">defaulterrcls</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_inst</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">post_block</span><span class="s2">(</span><span class="s1">block</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">create_cpython_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">release_gil</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Create CPython wrapper(s) around this function (or generator). 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">create_cpython_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">library</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">.</span><span class="s1">gendesc</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">call_helper</span><span class="s2">,</span>
                                                <span class="s1">release_gil</span><span class="s2">=</span><span class="s1">release_gil</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">create_cpython_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">library</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">,</span>
                                            <span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">call_helper</span><span class="s2">,</span>
                                            <span class="s1">release_gil</span><span class="s2">=</span><span class="s1">release_gil</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">create_cfunc_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Create C wrapper around this function. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span><span class="s3">'generator as a first-class function type'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">create_cfunc_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">library</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">,</span>
                                          <span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">call_helper</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">setup_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fndesc</span><span class="s2">):</span>
        <span class="s5"># Setup function</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">function </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">declare_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">fndesc</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">dbg_optnone</span><span class="s2">:</span>
            <span class="s1">attrset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">function</span><span class="s2">.</span><span class="s1">attributes</span>
            <span class="s0">if </span><span class="s3">&quot;alwaysinline&quot; </span><span class="s0">not in </span><span class="s1">attrset</span><span class="s2">:</span>
                <span class="s1">attrset</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">&quot;optnone&quot;</span><span class="s2">)</span>
                <span class="s1">attrset</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">&quot;noinline&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entry_block </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">function</span><span class="s2">.</span><span class="s1">append_basic_block</span><span class="s2">(</span><span class="s3">'entry'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder </span><span class="s2">= </span><span class="s1">IRBuilder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">entry_block</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">call_helper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">init_call_helper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">varname</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">typemap</span><span class="s2">[</span><span class="s1">varname</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">debug_print</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">DEBUG_JIT</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">f&quot;DEBUGJIT [</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">qualname</span><span class="s0">}</span><span class="s3">]: </span><span class="s0">{</span><span class="s1">msg</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">print_variable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">varname</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Helper to emit ``print(msg, varname)`` for debugging. 
 
        Parameters 
        ---------- 
        msg : str 
            Literal string to be printed. 
        varname : str 
            A variable name whose value will be printed. 
        &quot;&quot;&quot;</span>
        <span class="s1">argtys </span><span class="s2">= (</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">),</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">typemap</span><span class="s2">[</span><span class="s1">varname</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">(),</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">varname</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">sig </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">none</span><span class="s2">, *</span><span class="s1">argtys</span><span class="s2">)</span>

        <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">print</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">)</span>
        <span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Lower</span><span class="s2">(</span><span class="s1">BaseLower</span><span class="s2">):</span>
    <span class="s1">GeneratorLower </span><span class="s2">= </span><span class="s1">generators</span><span class="s2">.</span><span class="s1">GeneratorLower</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">init</span><span class="s2">()</span>
        <span class="s5"># find all singly assigned variables</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_find_singly_assigned_variable</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">_disable_sroa_like_opt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;Flags that the SROA like optimisation that Numba performs (which 
        prevent alloca and subsequent load/store for locals) should be disabled. 
        Currently, this is conditional solely on the presence of a request for 
        the emission of debug information.&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return False</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">debuginfo </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">dbg_directives_only</span>

    <span class="s0">def </span><span class="s1">_find_singly_assigned_variable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">func_ir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span>
        <span class="s1">blocks </span><span class="s2">= </span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">blocks</span>

        <span class="s1">sav </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">func_id</span><span class="s2">.</span><span class="s1">is_generator</span><span class="s2">:</span>
            <span class="s1">use_defs </span><span class="s2">= </span><span class="s1">compute_use_defs</span><span class="s2">(</span><span class="s1">blocks</span><span class="s2">)</span>
            <span class="s1">alloca_vars </span><span class="s2">= </span><span class="s1">must_use_alloca</span><span class="s2">(</span><span class="s1">blocks</span><span class="s2">)</span>

            <span class="s5"># Compute where variables are defined</span>
            <span class="s1">var_assign_map </span><span class="s2">= </span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">set</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">blk</span><span class="s2">, </span><span class="s1">vl </span><span class="s0">in </span><span class="s1">use_defs</span><span class="s2">.</span><span class="s1">defmap</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">for </span><span class="s1">var </span><span class="s0">in </span><span class="s1">vl</span><span class="s2">:</span>
                    <span class="s1">var_assign_map</span><span class="s2">[</span><span class="s1">var</span><span class="s2">].</span><span class="s1">add</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">)</span>

            <span class="s5"># Compute where variables are used</span>
            <span class="s1">var_use_map </span><span class="s2">= </span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">set</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">blk</span><span class="s2">, </span><span class="s1">vl </span><span class="s0">in </span><span class="s1">use_defs</span><span class="s2">.</span><span class="s1">usemap</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">for </span><span class="s1">var </span><span class="s0">in </span><span class="s1">vl</span><span class="s2">:</span>
                    <span class="s1">var_use_map</span><span class="s2">[</span><span class="s1">var</span><span class="s2">].</span><span class="s1">add</span><span class="s2">(</span><span class="s1">blk</span><span class="s2">)</span>

            <span class="s5"># Keep only variables that are defined locally and used locally</span>
            <span class="s0">for </span><span class="s1">var </span><span class="s0">in </span><span class="s1">var_assign_map</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">var </span><span class="s0">not in </span><span class="s1">alloca_vars </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">var_assign_map</span><span class="s2">[</span><span class="s1">var</span><span class="s2">]) == </span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s5"># Usemap does not keep locally defined variables.</span>
                    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">var_use_map</span><span class="s2">[</span><span class="s1">var</span><span class="s2">]) == </span><span class="s6">0</span><span class="s2">:</span>
                        <span class="s5"># Ensure that the variable is not defined multiple times</span>
                        <span class="s5"># in the block</span>
                        <span class="s2">[</span><span class="s1">defblk</span><span class="s2">] = </span><span class="s1">var_assign_map</span><span class="s2">[</span><span class="s1">var</span><span class="s2">]</span>
                        <span class="s1">assign_stmts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s1">defblk</span><span class="s2">].</span><span class="s1">find_insts</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">)</span>
                        <span class="s1">assigns </span><span class="s2">= [</span><span class="s1">stmt </span><span class="s0">for </span><span class="s1">stmt </span><span class="s0">in </span><span class="s1">assign_stmts</span>
                                   <span class="s0">if </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">var</span><span class="s2">]</span>
                        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">assigns</span><span class="s2">) == </span><span class="s6">1</span><span class="s2">:</span>
                            <span class="s1">sav</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">var</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_singly_assigned_vars </span><span class="s2">= </span><span class="s1">sav</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap </span><span class="s2">= {}</span>

    <span class="s0">def </span><span class="s1">pre_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">block</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">unsafe </span><span class="s0">import </span><span class="s1">eh</span>

        <span class="s1">super</span><span class="s2">(</span><span class="s1">Lower</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">pre_block</span><span class="s2">(</span><span class="s1">block</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cur_ir_block </span><span class="s2">= </span><span class="s1">block</span>

        <span class="s0">if </span><span class="s1">block </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">firstblk</span><span class="s2">:</span>
            <span class="s5"># create slots for all the vars, irrespective of whether they are</span>
            <span class="s5"># initialized, SSA will pick this up and warn users about using</span>
            <span class="s5"># uninitialized variables. Slots are added as alloca in the first</span>
            <span class="s5"># block</span>
            <span class="s1">bb </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">firstblk</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">position_at_end</span><span class="s2">(</span><span class="s1">bb</span><span class="s2">)</span>
            <span class="s1">all_names </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">block </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">block</span><span class="s2">.</span><span class="s1">find_insts</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Del</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">value </span><span class="s0">not in </span><span class="s1">all_names</span><span class="s2">:</span>
                        <span class="s1">all_names</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">all_names</span><span class="s2">:</span>
                <span class="s1">fetype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_alloca_var</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">fetype</span><span class="s2">)</span>

        <span class="s5"># Detect if we are in a TRY block by looking for a call to</span>
        <span class="s5"># `eh.exception_check`.</span>
        <span class="s0">for </span><span class="s1">call </span><span class="s0">in </span><span class="s1">block</span><span class="s2">.</span><span class="s1">find_exprs</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s3">'call'</span><span class="s2">):</span>
            <span class="s1">defn </span><span class="s2">= </span><span class="s1">ir_utils</span><span class="s2">.</span><span class="s1">guard</span><span class="s2">(</span>
                <span class="s1">ir_utils</span><span class="s2">.</span><span class="s1">get_definition</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">, </span><span class="s1">call</span><span class="s2">.</span><span class="s1">func</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">defn </span><span class="s0">is not None and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">defn</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">defn</span><span class="s2">.</span><span class="s1">value </span><span class="s0">is </span><span class="s1">eh</span><span class="s2">.</span><span class="s1">exception_check</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">terminator</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Branch</span><span class="s2">):</span>
                        <span class="s1">targetblk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">block</span><span class="s2">.</span><span class="s1">terminator</span><span class="s2">.</span><span class="s1">truebr</span><span class="s2">]</span>
                        <span class="s5"># NOTE: This hacks in an attribute for call_conv to</span>
                        <span class="s5">#       pick up. This hack is no longer needed when</span>
                        <span class="s5">#       all old-style implementations are gone.</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">_in_try_block </span><span class="s2">= {</span><span class="s3">'target'</span><span class="s2">: </span><span class="s1">targetblk</span><span class="s2">}</span>
                        <span class="s0">break</span>

    <span class="s0">def </span><span class="s1">post_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">block</span><span class="s2">):</span>
        <span class="s5"># Clean-up</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">_in_try_block</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">lower_inst</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s5"># Set debug location for all subsequent LL instructions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">mark_location</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Assign</span><span class="s2">):</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_assign</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">)</span>
            <span class="s1">argidx </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s5"># If this is a store from an arg, like x = arg.x then tell debuginfo</span>
            <span class="s5"># that this is the arg</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Arg</span><span class="s2">):</span>
                <span class="s5"># NOTE: debug location is the `def &lt;func&gt;` line</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">mark_location</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">defn_loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">)</span>
                <span class="s1">argidx </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+ </span><span class="s6">1 </span><span class="s5"># args start at 1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">storevar</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">argidx</span><span class="s2">=</span><span class="s1">argidx</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Branch</span><span class="s2">):</span>
            <span class="s1">cond </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">cond</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">tr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">truebr</span><span class="s2">]</span>
            <span class="s1">fl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">falsebr</span><span class="s2">]</span>

            <span class="s1">condty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">cond</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">pred </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">cond</span><span class="s2">, </span><span class="s1">condty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">boolean</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">pred</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s1">llvmlite</span><span class="s2">.</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s6">1</span><span class="s2">),</span><span class="s1">\</span>
                <span class="s2">(</span><span class="s3">&quot;cond is not i1: %s&quot; </span><span class="s2">% </span><span class="s1">pred</span><span class="s2">.</span><span class="s1">type</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">cbranch</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">tr</span><span class="s2">, </span><span class="s1">fl</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Jump</span><span class="s2">):</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">blkmap</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Return</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generator_info</span><span class="s2">:</span>
                <span class="s5"># StopIteration</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">genlower</span><span class="s2">.</span><span class="s1">return_from_generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
                <span class="s0">return</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">oty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">restype</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Optional</span><span class="s2">):</span>
                <span class="s5"># If returning an optional type</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_optional_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">oty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
                <span class="s0">return</span>
            <span class="s0">assert </span><span class="s1">ty </span><span class="s2">== </span><span class="s1">oty</span><span class="s2">, (</span>
                <span class="s3">&quot;type '{}' does not match return type '{}'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">oty</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">))</span>
            <span class="s1">retval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_return_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">retval</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PopBlock</span><span class="s2">):</span>
            <span class="s0">pass </span><span class="s5"># this is just a marker</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">StaticSetItem</span><span class="s2">):</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">signature </span><span class="s0">is not None</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s3">'static_setitem'</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">NotImplementedError</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_setitem</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">index_var</span><span class="s2">,</span>
                                          <span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">valuety </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">valuety</span><span class="s2">,</span>
                                          <span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">2</span><span class="s2">])</span>
                <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">target</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Print</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_print</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetItem</span><span class="s2">):</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">signature </span><span class="s0">is not None</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_setitem</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
                                      <span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">StoreMap</span><span class="s2">):</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">signature </span><span class="s0">is not None</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_setitem</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">dct</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">key</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DelItem</span><span class="s2">):</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

            <span class="s1">targetty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">indexty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">signature </span><span class="s0">is not None</span>

            <span class="s1">op </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">delitem</span>
            <span class="s1">fnop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">.</span><span class="s1">resolve_value_type</span><span class="s2">(</span><span class="s1">op</span><span class="s2">)</span>
            <span class="s1">callsig </span><span class="s2">= </span><span class="s1">fnop</span><span class="s2">.</span><span class="s1">get_call_type</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, {},</span>
            <span class="s2">)</span>
            <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">fnop</span><span class="s2">, </span><span class="s1">callsig</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">targetty </span><span class="s2">== </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">indexty</span><span class="s2">,</span>
                                      <span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>

            <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">))</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Del</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">delvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">SetAttr</span><span class="s2">):</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">]</span>

            <span class="s1">targetty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">valuety </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">signature </span><span class="s0">is not None</span>
            <span class="s0">assert </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] == </span><span class="s1">targetty</span>
            <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_setattr</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

            <span class="s5"># Convert argument to match</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">valuety</span><span class="s2">,</span>
                                      <span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>

            <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">target</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DynamicRaise</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_dynamic_raise</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DynamicTryRaise</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_try_dynamic_raise</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">StaticRaise</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_static_raise</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">StaticTryRaise</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_static_try_raise</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">lower_setitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">target_var</span><span class="s2">, </span><span class="s1">index_var</span><span class="s2">, </span><span class="s1">value_var</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">target_var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">value_var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">index_var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s1">targetty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">target_var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">valuety </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">value_var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">indexty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">index_var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s1">op </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">setitem</span>
        <span class="s1">fnop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">.</span><span class="s1">resolve_value_type</span><span class="s2">(</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s1">callsig </span><span class="s2">= </span><span class="s1">fnop</span><span class="s2">.</span><span class="s1">get_call_type</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, {},</span>
        <span class="s2">)</span>
        <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">fnop</span><span class="s2">, </span><span class="s1">callsig</span><span class="s2">)</span>

        <span class="s5"># Convert argument to match</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">targetty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Optional</span><span class="s2">):</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">targetty</span><span class="s2">,</span>
                                       <span class="s1">targetty</span><span class="s2">.</span><span class="s1">type</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ul </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">unliteral</span>
            <span class="s0">assert </span><span class="s1">ul</span><span class="s2">(</span><span class="s1">targetty</span><span class="s2">) == </span><span class="s1">ul</span><span class="s2">(</span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">indexty</span><span class="s2">,</span>
                                  <span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">valuety</span><span class="s2">,</span>
                                  <span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">2</span><span class="s2">])</span>

        <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">target</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">lower_try_dynamic_raise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s5"># Numba is a bit limited in what it can do with exceptions in a try</span>
        <span class="s5"># block. Thus, it is safe to use the same code as the static try raise.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lower_static_try_raise</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_dynamic_raise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s1">exc_args </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_args</span>
        <span class="s1">args </span><span class="s2">= []</span>
        <span class="s1">nb_types </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">exc_arg </span><span class="s0">in </span><span class="s1">exc_args</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_arg</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">):</span>
                <span class="s5"># dynamic values</span>
                <span class="s1">typ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">exc_arg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">exc_arg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">typ </span><span class="s2">= </span><span class="s0">None</span>
                <span class="s1">val </span><span class="s2">= </span><span class="s1">exc_arg</span>
            <span class="s1">nb_types</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">)</span>
            <span class="s1">args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">return_dynamic_exception</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">),</span>
                                      <span class="s1">tuple</span><span class="s2">(</span><span class="s1">nb_types</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_static_raise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s5"># Reraise</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">return_exception</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">return_exception</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_static_try_raise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_class </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s5"># Reraise</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_exception</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_exception</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_class</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">exc_args</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_assign</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span>
        <span class="s5"># In nopython mode, closure vars are frozen like globals</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Const</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Global</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FreeVar</span><span class="s2">)):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_generic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">,</span>
                                                    <span class="s1">value</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Expr</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_expr</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Var</span><span class="s2">):</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">oty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">oty</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Arg</span><span class="s2">):</span>
            <span class="s5"># Suspend debug info else all the arg repacking ends up being</span>
            <span class="s5"># associated with some line or other and it's actually just a detail</span>
            <span class="s5"># of Numba's CC.</span>
            <span class="s0">with </span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">suspend_emission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">):</span>
                <span class="s5"># Cast from the argument type to the local variable type</span>
                <span class="s5"># (note the &quot;arg.FOO&quot; convention as used in typeinfer)</span>
                <span class="s1">argty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s3">&quot;arg.&quot; </span><span class="s2">+ </span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">argty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Omitted</span><span class="s2">):</span>
                    <span class="s1">pyval </span><span class="s2">= </span><span class="s1">argty</span><span class="s2">.</span><span class="s1">value</span>
                    <span class="s1">tyctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span>
                    <span class="s1">valty </span><span class="s2">= </span><span class="s1">tyctx</span><span class="s2">.</span><span class="s1">resolve_value_type_prefer_literal</span><span class="s2">(</span><span class="s1">pyval</span><span class="s2">)</span>
                    <span class="s5"># use the type of the constant value</span>
                    <span class="s1">const </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_generic</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">valty</span><span class="s2">, </span><span class="s1">pyval</span><span class="s2">,</span>
                    <span class="s2">)</span>
                    <span class="s5"># cast it to the variable type</span>
                    <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">const</span><span class="s2">, </span><span class="s1">valty</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fnargs</span><span class="s2">[</span><span class="s1">value</span><span class="s2">.</span><span class="s1">index</span><span class="s2">]</span>
                    <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">argty</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Yield</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_yield</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">), </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_yield</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">retty</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s1">yp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generator_info</span><span class="s2">.</span><span class="s1">yield_points</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">index</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">yp</span><span class="s2">.</span><span class="s1">inst </span><span class="s0">is </span><span class="s1">inst</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">generators</span><span class="s2">.</span><span class="s1">LowerYield</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">.</span><span class="s1">live_vars</span><span class="s2">)</span>
        <span class="s1">y</span><span class="s2">.</span><span class="s1">lower_yield_suspend</span><span class="s2">()</span>
        <span class="s5"># Yield to caller</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">typ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">actual_rettyp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gentype</span><span class="s2">.</span><span class="s1">yield_type</span>

        <span class="s5"># cast the local val to the type yielded</span>
        <span class="s1">yret </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">actual_rettyp</span><span class="s2">)</span>

        <span class="s5"># get the return repr of yielded value</span>
        <span class="s1">retval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_return_value</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">actual_rettyp</span><span class="s2">, </span><span class="s1">yret</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s5"># return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">retval</span><span class="s2">)</span>

        <span class="s5"># Resumption point</span>
        <span class="s1">y</span><span class="s2">.</span><span class="s1">lower_yield_resume</span><span class="s2">()</span>
        <span class="s5"># None is returned by the yield expression</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_generic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">retty</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_binop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s5"># if op in utils.OPERATORS_TO_BUILTINS:</span>
        <span class="s5"># map operator.the_op =&gt; the corresponding types.Function()</span>
        <span class="s5"># TODO: is this looks dodgy ...</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">.</span><span class="s1">resolve_value_type</span><span class="s2">(</span><span class="s1">op</span><span class="s2">)</span>

        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">lhs</span>
        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">rhs</span>
        <span class="s1">static_lhs </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">static_lhs</span>
        <span class="s1">static_rhs </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">static_rhs</span>
        <span class="s1">lty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">rty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s5"># Convert argument to match</span>
        <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">]</span>
        <span class="s1">lhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">lty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>
        <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">rty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>

        <span class="s0">def </span><span class="s1">cast_result</span><span class="s2">(</span><span class="s1">res</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res</span><span class="s2">,</span>
                                     <span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">)</span>

        <span class="s5"># First try with static operands, if known</span>
        <span class="s0">def </span><span class="s1">try_static_impl</span><span class="s2">(</span><span class="s1">tys</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">a </span><span class="s0">is </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">UNDEFINED </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">args</span><span class="s2">):</span>
                <span class="s0">return None</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Function</span><span class="s2">):</span>
                    <span class="s1">static_sig </span><span class="s2">= </span><span class="s1">op</span><span class="s2">.</span><span class="s1">get_call_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">,</span>
                                                  <span class="s1">tys</span><span class="s2">, {})</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">static_sig </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">, *</span><span class="s1">tys</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">TypingError</span><span class="s2">:</span>
                <span class="s0">return None</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">static_impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">static_sig</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">static_impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">NotImplementedError</span><span class="s2">:</span>
                <span class="s0">return None</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">try_static_impl</span><span class="s2">(</span>
            <span class="s2">(</span><span class="s1">_lit_or_omitted</span><span class="s2">(</span><span class="s1">static_lhs</span><span class="s2">), </span><span class="s1">_lit_or_omitted</span><span class="s2">(</span><span class="s1">static_rhs</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">static_lhs</span><span class="s2">, </span><span class="s1">static_rhs</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">res </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cast_result</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">try_static_impl</span><span class="s2">(</span>
            <span class="s2">(</span><span class="s1">_lit_or_omitted</span><span class="s2">(</span><span class="s1">static_lhs</span><span class="s2">), </span><span class="s1">rty</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">static_lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">res </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cast_result</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">try_static_impl</span><span class="s2">(</span>
            <span class="s2">(</span><span class="s1">lty</span><span class="s2">, </span><span class="s1">_lit_or_omitted</span><span class="s2">(</span><span class="s1">static_rhs</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">static_rhs</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">res </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cast_result</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>

        <span class="s5"># Normal implementation for generic arguments</span>

        <span class="s1">sig </span><span class="s2">= </span><span class="s1">op</span><span class="s2">.</span><span class="s1">get_call_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, {})</span>
        <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">cast_result</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_getitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s1">baseval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">indexval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s5"># Get implementation of getitem</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">getitem</span>
        <span class="s1">fnop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">.</span><span class="s1">resolve_value_type</span><span class="s2">(</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s1">callsig </span><span class="s2">= </span><span class="s1">fnop</span><span class="s2">.</span><span class="s1">get_call_type</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, {},</span>
        <span class="s2">)</span>
        <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">fnop</span><span class="s2">, </span><span class="s1">callsig</span><span class="s2">)</span>

        <span class="s1">argvals </span><span class="s2">= (</span><span class="s1">baseval</span><span class="s2">, </span><span class="s1">indexval</span><span class="s2">)</span>
        <span class="s1">argtyps </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                   <span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>
        <span class="s1">castvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">av</span><span class="s2">, </span><span class="s1">at</span><span class="s2">, </span><span class="s1">ft</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">av</span><span class="s2">, </span><span class="s1">at</span><span class="s2">, </span><span class="s1">ft </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">argvals</span><span class="s2">, </span><span class="s1">argtyps</span><span class="s2">,</span>
                                          <span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)]</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">castvals</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res</span><span class="s2">,</span>
                                 <span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">,</span>
                                 <span class="s1">resty</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_cast_var</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">var</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Cast a Numba IR variable to the given Numba type, returning a 
        low-level value. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">var</span><span class="s2">, </span><span class="s1">_VarArgItem</span><span class="s2">):</span>
            <span class="s1">varty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">var</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)[</span><span class="s1">var</span><span class="s2">.</span><span class="s1">index</span><span class="s2">]</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">var</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                                             <span class="s1">var</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">varty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">var</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">varty</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">fold_call_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">, </span><span class="s1">pos_args</span><span class="s2">, </span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">kw_args</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">vararg</span><span class="s2">:</span>
            <span class="s5"># Inject *args from function call</span>
            <span class="s5"># The lowering will be done in _cast_var() above.</span>
            <span class="s1">tp_vararg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">vararg</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tp_vararg</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">BaseTuple</span><span class="s2">)</span>
            <span class="s1">pos_args </span><span class="s2">= </span><span class="s1">pos_args </span><span class="s2">+ [</span><span class="s1">_VarArgItem</span><span class="s2">(</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
                                   <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">tp_vararg</span><span class="s2">))]</span>

        <span class="s5"># Fold keyword arguments and resolve default argument values</span>
        <span class="s1">pysig </span><span class="s2">= </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">pysig</span>
        <span class="s0">if </span><span class="s1">pysig </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">kw_args</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s3">&quot;unsupported keyword arguments &quot;</span>
                                          <span class="s3">&quot;when calling %s&quot; </span><span class="s2">% (</span><span class="s1">fnty</span><span class="s2">,))</span>
            <span class="s1">argvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cast_var</span><span class="s2">(</span><span class="s1">var</span><span class="s2">, </span><span class="s1">sigty</span><span class="s2">)</span>
                       <span class="s0">for </span><span class="s1">var</span><span class="s2">, </span><span class="s1">sigty </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">pos_args</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">normal_handler</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">param</span><span class="s2">, </span><span class="s1">var</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cast_var</span><span class="s2">(</span><span class="s1">var</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s1">index</span><span class="s2">])</span>

            <span class="s0">def </span><span class="s1">default_handler</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">param</span><span class="s2">, </span><span class="s1">default</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_generic</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s1">index</span><span class="s2">], </span><span class="s1">default</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">stararg_handler</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">param</span><span class="s2">, </span><span class="s1">vars</span><span class="s2">):</span>
                <span class="s1">stararg_ty </span><span class="s2">= </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s1">index</span><span class="s2">]</span>
                <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">stararg_ty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">BaseTuple</span><span class="s2">), </span><span class="s1">stararg_ty</span>
                <span class="s1">values </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cast_var</span><span class="s2">(</span><span class="s1">var</span><span class="s2">, </span><span class="s1">sigty</span><span class="s2">)</span>
                          <span class="s0">for </span><span class="s1">var</span><span class="s2">, </span><span class="s1">sigty </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">vars</span><span class="s2">, </span><span class="s1">stararg_ty</span><span class="s2">)]</span>
                <span class="s0">return </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">make_anonymous_struct</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">values</span><span class="s2">)</span>

            <span class="s1">argvals </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">fold_arguments</span><span class="s2">(</span><span class="s1">pysig</span><span class="s2">,</span>
                                            <span class="s1">pos_args</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">kw_args</span><span class="s2">),</span>
                                            <span class="s1">normal_handler</span><span class="s2">,</span>
                                            <span class="s1">default_handler</span><span class="s2">,</span>
                                            <span class="s1">stararg_handler</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">argvals</span>

    <span class="s0">def </span><span class="s1">lower_print</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Lower a ir.Print() 
        &quot;&quot;&quot;</span>
        <span class="s5"># We handle this, as far as possible, as a normal call to built-in</span>
        <span class="s5"># print().  This will make it easy to undo the special ir.Print</span>
        <span class="s5"># rewrite when it becomes unnecessary (e.g. when we have native</span>
        <span class="s5"># strings).</span>
        <span class="s1">sig </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">inst</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">none</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">.</span><span class="s1">resolve_value_type</span><span class="s2">(</span><span class="s1">print</span><span class="s2">)</span>

        <span class="s5"># Fix the call signature to inject any constant-inferred</span>
        <span class="s5"># string argument</span>
        <span class="s1">pos_tys </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">pos_args </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">pos_args</span><span class="s2">)):</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s0">in </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">consts</span><span class="s2">:</span>
                <span class="s1">pyval </span><span class="s2">= </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">consts</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">pyval</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                    <span class="s1">pos_tys</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">types</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">pyval</span><span class="s2">)</span>

        <span class="s1">fixed_sig </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">, *</span><span class="s1">pos_tys</span><span class="s2">)</span>
        <span class="s1">fixed_sig </span><span class="s2">= </span><span class="s1">fixed_sig</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">pysig</span><span class="s2">=</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">pysig</span><span class="s2">)</span>

        <span class="s1">argvals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fold_call_args</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">pos_args</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">, {})</span>
        <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">print</span><span class="s2">, </span><span class="s1">fixed_sig</span><span class="s2">)</span>
        <span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">argvals</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">lower_call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">):</span>
        <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">&quot;# lower_call: expr = {0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Phantom</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>

        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">ObjModeDispatcher</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lower_call_ObjModeDispatcher</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">ExternalFunction</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lower_call_ExternalFunction</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">ExternalFunctionPointer</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lower_call_ExternalFunctionPointer</span><span class="s2">(</span>
                <span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">RecursiveCall</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lower_call_RecursiveCall</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lower_call_FunctionType</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lower_call_normal</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>

        <span class="s5"># If lowering the call returned None, interpret that as returning dummy</span>
        <span class="s5"># value if the return type of the function is void, otherwise there is</span>
        <span class="s5"># a problem</span>
        <span class="s0">if </span><span class="s1">res </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">void</span><span class="s2">:</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">LoweringError</span><span class="s2">(</span>
                    <span class="s1">msg</span><span class="s2">=</span><span class="s3">&quot;non-void function returns None from implementation&quot;</span><span class="s2">,</span>
                    <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span>
                <span class="s2">)</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">,</span>
                                 <span class="s1">resty</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_lower_call_ObjModeDispatcher</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">pythonapi </span><span class="s0">import </span><span class="s1">ObjModeUtils</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">init_pyapi</span><span class="s2">()</span>
        <span class="s5"># Acquire the GIL</span>
        <span class="s1">gil_state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">gil_ensure</span><span class="s2">()</span>
        <span class="s5"># Fix types</span>
        <span class="s1">argnames </span><span class="s2">= [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">name </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">args</span><span class="s2">]</span>
        <span class="s1">argtypes </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">argnames</span><span class="s2">]</span>
        <span class="s1">argvalues </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">argnames</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">v</span><span class="s2">, </span><span class="s1">ty </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">argvalues</span><span class="s2">, </span><span class="s1">argtypes</span><span class="s2">):</span>
            <span class="s5"># Because .from_native_value steal the reference</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

        <span class="s1">argobjs </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">from_native_value</span><span class="s2">(</span><span class="s1">atyp</span><span class="s2">, </span><span class="s1">aval</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager</span><span class="s2">)</span>
                   <span class="s0">for </span><span class="s1">atyp</span><span class="s2">, </span><span class="s1">aval </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">argtypes</span><span class="s2">, </span><span class="s1">argvalues</span><span class="s2">)]</span>

        <span class="s5"># Load objmode dispatcher</span>
        <span class="s1">callee </span><span class="s2">= </span><span class="s1">ObjModeUtils</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">).</span><span class="s1">load_dispatcher</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">argtypes</span><span class="s2">)</span>
        <span class="s5"># Make Call</span>
        <span class="s1">ret_obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">call_function_objargs</span><span class="s2">(</span><span class="s1">callee</span><span class="s2">, </span><span class="s1">argobjs</span><span class="s2">)</span>
        <span class="s1">has_exception </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ret_obj</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">. </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_else</span><span class="s2">(</span><span class="s1">has_exception</span><span class="s2">) </span><span class="s0">as </span><span class="s2">(</span><span class="s1">then</span><span class="s2">, </span><span class="s1">orelse</span><span class="s2">):</span>
            <span class="s5"># Handles exception</span>
            <span class="s5"># This branch must exit the function</span>
            <span class="s0">with </span><span class="s1">then</span><span class="s2">:</span>
                <span class="s5"># Clean arg</span>
                <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">argobjs</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>

                <span class="s5"># Release the GIL</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">gil_release</span><span class="s2">(</span><span class="s1">gil_state</span><span class="s2">)</span>

                <span class="s5"># Return and signal exception</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_exc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">)</span>

            <span class="s5"># Handles normal return</span>
            <span class="s0">with </span><span class="s1">orelse</span><span class="s2">:</span>
                <span class="s5"># Fix output value</span>
                <span class="s1">native </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">to_native_value</span><span class="s2">(</span>
                    <span class="s1">fnty</span><span class="s2">.</span><span class="s1">dispatcher</span><span class="s2">.</span><span class="s1">output_types</span><span class="s2">,</span>
                    <span class="s1">ret_obj</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">output </span><span class="s2">= </span><span class="s1">native</span><span class="s2">.</span><span class="s1">value</span>

                <span class="s5"># Release objs</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">ret_obj</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">argobjs</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>

                <span class="s5"># cleanup output</span>
                <span class="s0">if </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">native</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">):</span>
                    <span class="s1">native</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>

                <span class="s5"># Release the GIL</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">gil_release</span><span class="s2">(</span><span class="s1">gil_state</span><span class="s2">)</span>

                <span class="s5"># Error during unboxing</span>
                <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_then</span><span class="s2">(</span><span class="s1">native</span><span class="s2">.</span><span class="s1">is_error</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_exc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">)</span>

                <span class="s0">return </span><span class="s1">output</span>

    <span class="s0">def </span><span class="s1">_lower_call_ExternalFunction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s5"># Handle a named external function</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">&quot;# external function&quot;</span><span class="s2">)</span>
        <span class="s1">argvals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fold_call_args</span><span class="s2">(</span>
            <span class="s1">fnty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">kws</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">fndesc </span><span class="s2">= </span><span class="s1">funcdesc</span><span class="s2">.</span><span class="s1">ExternalFunctionDescriptor</span><span class="s2">(</span>
            <span class="s1">fnty</span><span class="s2">.</span><span class="s1">symbol</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">declare_external_function</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">fndesc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_external_function</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">argtypes</span><span class="s2">, </span><span class="s1">argvals</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_lower_call_ExternalFunctionPointer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s5"># Handle a C function pointer</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">&quot;# calling external function pointer&quot;</span><span class="s2">)</span>
        <span class="s1">argvals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fold_call_args</span><span class="s2">(</span>
            <span class="s1">fnty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">kws</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">pointer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s5"># If the external function pointer uses libpython</span>
        <span class="s0">if </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">requires_gil</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">init_pyapi</span><span class="s2">()</span>
            <span class="s5"># Acquire the GIL</span>
            <span class="s1">gil_state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">gil_ensure</span><span class="s2">()</span>
            <span class="s5"># Make PyObjects</span>
            <span class="s1">newargvals </span><span class="s2">= []</span>
            <span class="s1">pyvals </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">exptyp</span><span class="s2">, </span><span class="s1">gottyp</span><span class="s2">, </span><span class="s1">aval </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">,</span>
                                            <span class="s1">argvals</span><span class="s2">):</span>
                <span class="s5"># Adjust argument values to pyobjects</span>
                <span class="s0">if </span><span class="s1">exptyp </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">ffi_forced_object</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">gottyp</span><span class="s2">, </span><span class="s1">aval</span><span class="s2">)</span>
                    <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">from_native_value</span><span class="s2">(</span>
                        <span class="s1">gottyp</span><span class="s2">, </span><span class="s1">aval</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager</span><span class="s2">,</span>
                    <span class="s2">)</span>
                    <span class="s1">newargvals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s1">pyvals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">newargvals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">aval</span><span class="s2">)</span>

            <span class="s5"># Call external function</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_function_pointer</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">pointer</span><span class="s2">, </span><span class="s1">newargvals</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">cconv</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s5"># Release PyObjects</span>
            <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">pyvals</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>

            <span class="s5"># Release the GIL</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">gil_release</span><span class="s2">(</span><span class="s1">gil_state</span><span class="s2">)</span>
        <span class="s5"># If the external function pointer does NOT use libpython</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_function_pointer</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">pointer</span><span class="s2">, </span><span class="s1">argvals</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">cconv</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span>

    <span class="s0">def </span><span class="s1">_lower_call_RecursiveCall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s5"># Recursive call</span>
        <span class="s1">argvals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fold_call_args</span><span class="s2">(</span>
            <span class="s1">fnty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">kws</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">rec_ov </span><span class="s2">= </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">get_overloads</span><span class="s2">(</span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">mangler </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">mangler </span><span class="s0">or </span><span class="s1">default_mangler</span>
        <span class="s1">abi_tags </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">abi_tags</span>
        <span class="s1">mangled_name </span><span class="s2">= </span><span class="s1">mangler</span><span class="s2">(</span><span class="s1">rec_ov</span><span class="s2">.</span><span class="s1">qualname</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">,</span>
                               <span class="s1">abi_tags</span><span class="s2">=</span><span class="s1">abi_tags</span><span class="s2">, </span><span class="s1">uid</span><span class="s2">=</span><span class="s1">rec_ov</span><span class="s2">.</span><span class="s1">uid</span><span class="s2">)</span>
        <span class="s5"># special case self recursion</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">function</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">mangled_name</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_internal</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">, </span><span class="s1">argvals</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_unresolved</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">mangled_name</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">, </span><span class="s1">argvals</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span>

    <span class="s0">def </span><span class="s1">_lower_call_FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">&quot;# calling first-class function type&quot;</span><span class="s2">)</span>
        <span class="s1">sig </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">unliteral</span><span class="s2">(</span><span class="s1">signature</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">check_signature</span><span class="s2">(</span><span class="s1">signature</span><span class="s2">):</span>
            <span class="s5"># value dependent polymorphism?</span>
            <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s2">(</span>
                <span class="s3">f'mismatch of function types:'</span>
                <span class="s3">f' expected </span><span class="s0">{</span><span class="s1">fnty</span><span class="s0">} </span><span class="s3">but got </span><span class="s0">{</span><span class="s1">types</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">)</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">ftype </span><span class="s2">= </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">ftype</span>
        <span class="s1">argvals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fold_call_args</span><span class="s2">(</span>
            <span class="s1">fnty</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">kws</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">func_ptr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__get_function_pointer</span><span class="s2">(</span><span class="s1">ftype</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">=</span><span class="s1">sig</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func_ptr</span><span class="s2">, </span><span class="s1">argvals</span><span class="s2">, </span><span class="s1">cconv</span><span class="s2">=</span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">cconv</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span>

    <span class="s0">def </span><span class="s1">__get_function_pointer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ftype</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">experimental</span><span class="s2">.</span><span class="s1">function_type </span><span class="s0">import </span><span class="s1">lower_get_wrapper_address</span>

        <span class="s1">llty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">ftype</span><span class="s2">)</span>
        <span class="s1">fstruct </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s1">addr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">fstruct</span><span class="s2">, </span><span class="s6">0</span><span class="s2">,</span>
                                          <span class="s1">name</span><span class="s2">=</span><span class="s3">'addr_of_%s' </span><span class="s2">% (</span><span class="s1">fname</span><span class="s2">))</span>

        <span class="s1">fptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">llty</span><span class="s2">,</span>
                                   <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;fptr_of_%s&quot; </span><span class="s2">% (</span><span class="s1">fname</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_else</span><span class="s2">(</span>
                <span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">),</span>
                <span class="s1">likely</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">as </span><span class="s2">(</span><span class="s1">then</span><span class="s2">, </span><span class="s1">orelse</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">then</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">init_pyapi</span><span class="s2">()</span>
                <span class="s5"># Acquire the GIL</span>
                <span class="s1">gil_state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">gil_ensure</span><span class="s2">()</span>
                <span class="s1">pyaddr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span>
                    <span class="s1">fstruct</span><span class="s2">, </span><span class="s6">1</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s3">'pyaddr_of_%s' </span><span class="s2">% (</span><span class="s1">fname</span><span class="s2">))</span>
                <span class="s5"># try to recover the function address, see</span>
                <span class="s5"># test_zero_address BadToGood example in</span>
                <span class="s5"># test_function_type.py</span>
                <span class="s1">addr1 </span><span class="s2">= </span><span class="s1">lower_get_wrapper_address</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">pyaddr</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">,</span>
                    <span class="s1">failure_mode</span><span class="s2">=</span><span class="s3">'ignore'</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_then</span><span class="s2">(</span>
                        <span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">addr1</span><span class="s2">), </span><span class="s1">likely</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">return_exception</span><span class="s2">(</span>
                        <span class="s1">RuntimeError</span><span class="s2">,</span>
                        <span class="s1">exc_args</span><span class="s2">=(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">ftype</span><span class="s0">} </span><span class="s3">function address is null&quot;</span><span class="s2">,),</span>
                        <span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">addr2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">long_as_voidptr</span><span class="s2">(</span><span class="s1">addr1</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">addr2</span><span class="s2">, </span><span class="s1">llty</span><span class="s2">), </span><span class="s1">fptr</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">addr1</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">gil_release</span><span class="s2">(</span><span class="s1">gil_state</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">orelse</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">addr</span><span class="s2">, </span><span class="s1">llty</span><span class="s2">), </span><span class="s1">fptr</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">fptr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_lower_call_normal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">):</span>
        <span class="s5"># Normal function resolution</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">&quot;# calling normal function: {0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">(</span><span class="s3">&quot;# signature: {0}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">signature</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">ObjModeDispatcher</span><span class="s2">):</span>
            <span class="s1">argvals </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">args</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">argvals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fold_call_args</span><span class="s2">(</span>
                <span class="s1">fnty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">vararg</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">kws</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s1">tname </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">target</span>
        <span class="s0">if </span><span class="s1">tname </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">target_extension </span><span class="s0">import </span><span class="s1">resolve_dispatcher_from_str</span>
            <span class="s1">disp </span><span class="s2">= </span><span class="s1">resolve_dispatcher_from_str</span><span class="s2">(</span><span class="s1">tname</span><span class="s2">)</span>
            <span class="s1">hw_ctx </span><span class="s2">= </span><span class="s1">disp</span><span class="s2">.</span><span class="s1">targetdescr</span><span class="s2">.</span><span class="s1">target_context</span>
            <span class="s1">impl </span><span class="s2">= </span><span class="s1">hw_ctx</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">recvr</span><span class="s2">:</span>
            <span class="s5"># The &quot;self&quot; object is passed as the function object</span>
            <span class="s5"># for bounded function</span>
            <span class="s1">the_self </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">func</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s5"># Prepend the self reference</span>
            <span class="s1">argvals </span><span class="s2">= [</span><span class="s1">the_self</span><span class="s2">] + </span><span class="s1">list</span><span class="s2">(</span><span class="s1">argvals</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">argvals</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span>

    <span class="s0">def </span><span class="s1">lower_expr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'binop'</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_binop</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'inplace_binop'</span><span class="s2">:</span>
            <span class="s1">lty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">lty</span><span class="s2">.</span><span class="s1">mutable</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_binop</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">fn</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s5"># inplace operators on non-mutable types reuse the same</span>
                <span class="s5"># definition as the corresponding copying operators.)</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_binop</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">immutable_fn</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'unary'</span><span class="s2">:</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">typ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">func_ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">.</span><span class="s1">resolve_value_type</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">fn</span><span class="s2">)</span>
            <span class="s5"># Get function</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">]</span>
            <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">func_ty</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
            <span class="s5"># Convert argument to match</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">])</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res</span><span class="s2">,</span>
                                    <span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'call'</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_call</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'pair_first'</span><span class="s2">:</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">pair_first</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'pair_second'</span><span class="s2">:</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">pair_second</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'getiter'</span><span class="s2">, </span><span class="s3">'iternext'</span><span class="s2">):</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">]</span>
            <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
            <span class="s2">[</span><span class="s1">fty</span><span class="s2">] = </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">args</span>
            <span class="s1">castval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">fty</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">castval</span><span class="s2">,))</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">,</span>
                                    <span class="s1">resty</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'exhaust_iter'</span><span class="s2">:</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s5"># Unpack optional</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Optional</span><span class="s2">):</span>
                <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">type</span><span class="s2">)</span>
                <span class="s1">ty </span><span class="s2">= </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">type</span>

            <span class="s5"># If we have a tuple, we needn't do anything</span>
            <span class="s5"># (and we can't iterate over the heterogeneous ones).</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">BaseTuple</span><span class="s2">):</span>
                <span class="s0">assert </span><span class="s1">ty </span><span class="s2">== </span><span class="s1">resty</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">val</span>

            <span class="s1">itemty </span><span class="s2">= </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">iterator_type</span><span class="s2">.</span><span class="s1">yield_type</span>
            <span class="s1">tup </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_undef</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">)</span>
            <span class="s1">pairty </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Pair</span><span class="s2">(</span><span class="s1">itemty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">boolean</span><span class="s2">)</span>
            <span class="s1">getiter_sig </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">.</span><span class="s1">iterator_type</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>
            <span class="s1">getiter_impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s3">'getiter'</span><span class="s2">,</span>
                                                     <span class="s1">getiter_sig</span><span class="s2">)</span>
            <span class="s1">iternext_sig </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span><span class="s1">pairty</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">iterator_type</span><span class="s2">)</span>
            <span class="s1">iternext_impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s3">'iternext'</span><span class="s2">,</span>
                                                      <span class="s1">iternext_sig</span><span class="s2">)</span>
            <span class="s1">iterobj </span><span class="s2">= </span><span class="s1">getiter_impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">val</span><span class="s2">,))</span>
            <span class="s5"># We call iternext() as many times as desired (`expr.count`).</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">count</span><span class="s2">):</span>
                <span class="s1">pair </span><span class="s2">= </span><span class="s1">iternext_impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">iterobj</span><span class="s2">,))</span>
                <span class="s1">is_valid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">pair_second</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                                    <span class="s1">pair</span><span class="s2">, </span><span class="s1">pairty</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">if_unlikely</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                         <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">not_</span><span class="s2">(</span><span class="s1">is_valid</span><span class="s2">)):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">return_exception</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>
                <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">pair_first</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                               <span class="s1">pair</span><span class="s2">, </span><span class="s1">pairty</span><span class="s2">)</span>
                <span class="s1">tup </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">insert_value</span><span class="s2">(</span><span class="s1">tup</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>

            <span class="s5"># Call iternext() once more to check that the iterator</span>
            <span class="s5"># is exhausted.</span>
            <span class="s1">pair </span><span class="s2">= </span><span class="s1">iternext_impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">iterobj</span><span class="s2">,))</span>
            <span class="s1">is_valid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">pair_second</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                                <span class="s1">pair</span><span class="s2">, </span><span class="s1">pairty</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">if_unlikely</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">is_valid</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">return_exception</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">.</span><span class="s1">iterator_type</span><span class="s2">, </span><span class="s1">iterobj</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">tup</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;getattr&quot;</span><span class="s2">:</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">BoundFunction</span><span class="s2">):</span>
                <span class="s5"># if we are getting out a method, assume we have typed this</span>
                <span class="s5"># properly and just build a bound function object</span>
                <span class="s1">casted </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">.</span><span class="s1">this</span><span class="s2">)</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_bound_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">casted</span><span class="s2">,</span>
                                                      <span class="s1">resty</span><span class="s2">.</span><span class="s1">this</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">res</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_getattr</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">attr</span><span class="s2">)</span>
                <span class="s1">attrty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">typing_context</span><span class="s2">.</span><span class="s1">resolve_getattr</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">,</span>
                                                                     <span class="s1">expr</span><span class="s2">.</span><span class="s1">attr</span><span class="s2">)</span>

                <span class="s0">if </span><span class="s1">impl </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s5"># ignore the attribute</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">res </span><span class="s2">= </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">attr</span><span class="s2">)</span>

                <span class="s5"># Cast the attribute type to the expected output type</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res</span><span class="s2">, </span><span class="s1">attrty</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;static_getitem&quot;</span><span class="s2">:</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span>
                <span class="s1">resty</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                <span class="s1">_lit_or_omitted</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">index</span><span class="s2">),</span>
            <span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s5"># Both get_function() and the returned implementation can</span>
                <span class="s5"># raise NotImplementedError if the types aren't supported</span>
                <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s3">&quot;static_getitem&quot;</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                            <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">), </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">index</span><span class="s2">))</span>
            <span class="s0">except </span><span class="s1">NotImplementedError</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">index_var </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">raise</span>
                <span class="s5"># Fall back on the generic getitem() implementation</span>
                <span class="s5"># for this type.</span>
                <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">]</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_getitem</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">,</span>
                                          <span class="s1">expr</span><span class="s2">.</span><span class="s1">index_var</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;typed_getitem&quot;</span><span class="s2">:</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span>
                <span class="s1">resty</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
            <span class="s2">)</span>
            <span class="s1">impl </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_function</span><span class="s2">(</span><span class="s3">&quot;typed_getitem&quot;</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)))</span>
        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;getitem&quot;</span><span class="s2">:</span>
            <span class="s1">signature </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">.</span><span class="s1">calltypes</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">]</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lower_getitem</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
                                      <span class="s1">signature</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;build_tuple&quot;</span><span class="s2">:</span>
            <span class="s1">itemvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">items</span><span class="s2">]</span>
            <span class="s1">itemtys </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">items</span><span class="s2">]</span>
            <span class="s1">castvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">val</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">, </span><span class="s1">fromty </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">itemvals</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">itemtys</span><span class="s2">)]</span>
            <span class="s1">tup </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">make_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">castvals</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">tup</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">tup</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;build_list&quot;</span><span class="s2">:</span>
            <span class="s1">itemvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">items</span><span class="s2">]</span>
            <span class="s1">itemtys </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">items</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">LiteralList</span><span class="s2">):</span>
                <span class="s1">castvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">)</span>
                            <span class="s0">for </span><span class="s1">val</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">, </span><span class="s1">fromty </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">itemvals</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">.</span><span class="s1">types</span><span class="s2">,</span>
                                                         <span class="s1">itemtys</span><span class="s2">)]</span>
                <span class="s1">tup </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">make_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                              <span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">.</span><span class="s1">types</span><span class="s2">),</span>
                                              <span class="s1">castvals</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">tup</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">tup</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">castvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">,</span>
                                              <span class="s1">resty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
                            <span class="s0">for </span><span class="s1">val</span><span class="s2">, </span><span class="s1">fromty </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">itemvals</span><span class="s2">, </span><span class="s1">itemtys</span><span class="s2">)]</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">build_list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">castvals</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;build_set&quot;</span><span class="s2">:</span>
            <span class="s5"># Insert in reverse order, as Python does</span>
            <span class="s1">items </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">items</span><span class="s2">[::-</span><span class="s6">1</span><span class="s2">]</span>
            <span class="s1">itemvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">items</span><span class="s2">]</span>
            <span class="s1">itemtys </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">items</span><span class="s2">]</span>
            <span class="s1">castvals </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">,</span>
                                          <span class="s1">resty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">val</span><span class="s2">, </span><span class="s1">fromty </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">itemvals</span><span class="s2">, </span><span class="s1">itemtys</span><span class="s2">)]</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">build_set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">, </span><span class="s1">castvals</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;build_map&quot;</span><span class="s2">:</span>
            <span class="s1">items </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">items</span>
            <span class="s1">keys</span><span class="s2">, </span><span class="s1">values </span><span class="s2">= [], []</span>
            <span class="s1">key_types</span><span class="s2">, </span><span class="s1">value_types </span><span class="s2">= [], []</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">items</span><span class="s2">:</span>
                <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">keytype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">valtype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">keys</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
                <span class="s1">values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>
                <span class="s1">key_types</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">keytype</span><span class="s2">)</span>
                <span class="s1">value_types</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">valtype</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">build_map</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">,</span>
                                          <span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">key_types</span><span class="s2">, </span><span class="s1">value_types</span><span class="s2">)),</span>
                                          <span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">values</span><span class="s2">)))</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;cast&quot;</span><span class="s2">:</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">castval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">resty</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">, </span><span class="s1">castval</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">castval</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">&quot;phi&quot;</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">LoweringError</span><span class="s2">(</span><span class="s3">&quot;PHI not stripped&quot;</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'null'</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_null</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s3">'undef'</span><span class="s2">:</span>
            <span class="s5"># Numba does not raise an UnboundLocalError for undefined variables.</span>
            <span class="s5"># The variable is set to zero.</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_null</span><span class="s2">(</span><span class="s1">resty</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">special_ops</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">special_ops</span><span class="s2">[</span><span class="s1">expr</span><span class="s2">.</span><span class="s1">op</span><span class="s2">](</span><span class="s1">self</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_alloca_var</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">fetype</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Ensure the given variable has an allocated stack slot (if needed). 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">varmap</span><span class="s2">:</span>
            <span class="s5"># quit early</span>
            <span class="s0">return</span>

        <span class="s5"># If the name is used in multiple blocks or lowering with debuginfo...</span>
        <span class="s0">if </span><span class="s2">((</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_singly_assigned_vars</span><span class="s2">) </span><span class="s0">or</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_disable_sroa_like_opt</span><span class="s2">):</span>
            <span class="s5"># If not already defined, allocate it</span>
            <span class="s1">ptr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">alloca</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">fetype</span><span class="s2">)</span>
            <span class="s5"># Remember the pointer</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">varmap</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">ptr</span>

    <span class="s0">def </span><span class="s1">getvar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Get a pointer to the given variable's slot. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_disable_sroa_like_opt</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap</span>
            <span class="s0">assert </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_singly_assigned_vars</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">varmap</span><span class="s2">:</span>
            <span class="s5"># Allocate undefined variable as needed.</span>
            <span class="s5"># NOTE: Py3.12 use of LOAD_FAST_AND_CLEAR will allow variable be</span>
            <span class="s5"># referenced before it is defined.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_alloca_var</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">name</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">varmap</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Load the given variable's value. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_disable_sroa_like_opt</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
        <span class="s1">ptr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getvar</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s5"># Don't associate debuginfo with the load for a function arg else it</span>
        <span class="s5"># creates instructions ahead of the first source line of the</span>
        <span class="s5"># function which then causes problems with breaking on the function</span>
        <span class="s5"># symbol (it hits the symbol, not the first line).</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">arg_names</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">suspend_emission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">storevar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">argidx</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Store the value into the given variable. 
        &quot;&quot;&quot;</span>
        <span class="s1">fetype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s5"># Define if not already</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alloca_var</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">fetype</span><span class="s2">)</span>

        <span class="s5"># Store variable</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_singly_assigned_vars </span><span class="s0">and</span>
                <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_disable_sroa_like_opt</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">argidx </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s5"># Clean up existing value stored in the variable, not needed</span>
                <span class="s5"># if it's an arg</span>
                <span class="s1">old </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loadvar</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">fetype</span><span class="s2">, </span><span class="s1">old</span><span class="s2">)</span>

            <span class="s5"># stack stored variable</span>
            <span class="s1">ptr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getvar</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">type </span><span class="s2">!= </span><span class="s1">ptr</span><span class="s2">.</span><span class="s1">type</span><span class="s2">.</span><span class="s1">pointee</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= (</span><span class="s3">&quot;Storing {value.type} to ptr of {ptr.type.pointee} &quot;</span>
                       <span class="s3">&quot;('{name}'). FE type {fetype}&quot;</span><span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">,</span>
                                                              <span class="s1">ptr</span><span class="s2">=</span><span class="s1">ptr</span><span class="s2">,</span>
                                                              <span class="s1">fetype</span><span class="s2">=</span><span class="s1">fetype</span><span class="s2">,</span>
                                                              <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

            <span class="s5"># If this store is associated with an argument to the function (i.e.</span>
            <span class="s5"># store following reassemble from CC splatting structs as many args</span>
            <span class="s5"># to the function) then mark this variable as such.</span>
            <span class="s0">if </span><span class="s1">argidx </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">suspend_emission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">)</span>
                <span class="s1">loc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">defn_loc </span><span class="s5"># the line with `def &lt;func&gt;`</span>
                <span class="s1">lltype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">fetype</span><span class="s2">)</span>
                <span class="s1">sizeof </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_abi_sizeof</span><span class="s2">(</span><span class="s1">lltype</span><span class="s2">)</span>
                <span class="s1">datamodel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">data_model_manager</span><span class="s2">[</span><span class="s1">fetype</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">mark_variable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
                                             <span class="s1">lltype</span><span class="s2">=</span><span class="s1">lltype</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">sizeof</span><span class="s2">,</span>
                                             <span class="s1">line</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">, </span><span class="s1">datamodel</span><span class="s2">=</span><span class="s1">datamodel</span><span class="s2">,</span>
                                             <span class="s1">argidx</span><span class="s2">=</span><span class="s1">argidx</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">delvar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot; 
        Delete the given variable. 
        &quot;&quot;&quot;</span>
        <span class="s1">fetype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">typeof</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s5"># Out-of-order</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap </span><span class="s0">and</span>
                <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_disable_sroa_like_opt</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_singly_assigned_vars</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_singly_assigned_vars</span><span class="s2">.</span><span class="s1">discard</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s5"># Define if not already (may happen if the variable is deleted</span>
        <span class="s5"># at the beginning of a loop, but only set later in the loop)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alloca_var</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">fetype</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_disable_sroa_like_opt</span><span class="s2">:</span>
            <span class="s1">llval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_blk_local_varmap</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">fetype</span><span class="s2">, </span><span class="s1">llval</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ptr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getvar</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">fetype</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">))</span>
            <span class="s5"># Zero-fill variable to avoid double frees on subsequent dels</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">ptr</span><span class="s2">.</span><span class="s1">type</span><span class="s2">.</span><span class="s1">pointee</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">ptr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">alloca</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">type</span><span class="s2">):</span>
        <span class="s1">lltype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">type</span><span class="s2">)</span>
        <span class="s1">datamodel </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">data_model_manager</span><span class="s2">[</span><span class="s1">type</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">alloca_lltype</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">lltype</span><span class="s2">, </span><span class="s1">datamodel</span><span class="s2">=</span><span class="s1">datamodel</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">alloca_lltype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">lltype</span><span class="s2">, </span><span class="s1">datamodel</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s5"># Is user variable?</span>
        <span class="s1">is_uservar </span><span class="s2">= </span><span class="s0">not </span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'$'</span><span class="s2">)</span>
        <span class="s5"># Allocate space for variable</span>
        <span class="s1">aptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">lltype</span><span class="s2">,</span>
                                   <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">, </span><span class="s1">zfill</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s5"># Emit debug info for user variable</span>
        <span class="s0">if </span><span class="s1">is_uservar</span><span class="s2">:</span>
            <span class="s5"># Don't associate debuginfo with the alloca for a function arg, this</span>
            <span class="s5"># is handled by the first store to the alloca so that repacking the</span>
            <span class="s5"># splatted args from the CC is dealt with.</span>
            <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">func_ir</span><span class="s2">.</span><span class="s1">arg_names</span><span class="s2">:</span>
                <span class="s1">sizeof </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_abi_sizeof</span><span class="s2">(</span><span class="s1">lltype</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">mark_variable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">aptr</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
                                             <span class="s1">lltype</span><span class="s2">=</span><span class="s1">lltype</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">sizeof</span><span class="s2">,</span>
                                             <span class="s1">line</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">.</span><span class="s1">line</span><span class="s2">,</span>
                                             <span class="s1">datamodel</span><span class="s2">=</span><span class="s1">datamodel</span><span class="s2">,)</span>
        <span class="s0">return </span><span class="s1">aptr</span>

    <span class="s0">def </span><span class="s1">incref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_nrt</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">nrt</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">decref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_nrt</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s5"># do not associate decref with &quot;use&quot;, it creates &quot;jumpy&quot; line info as</span>
        <span class="s5"># the decrefs are usually where the ir.Del nodes are, which is at the</span>
        <span class="s5"># end of the block.</span>
        <span class="s0">with </span><span class="s1">debuginfo</span><span class="s2">.</span><span class="s1">suspend_emission</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">nrt</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_lit_or_omitted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Returns a Literal instance if the type of value is supported; 
    otherwise, return `Omitted(value)`. 
    &quot;&quot;&quot;</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">types</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">LiteralTypingError</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Omitted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
</pre>
</body>
</html>