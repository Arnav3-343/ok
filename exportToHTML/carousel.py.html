<html>
<head>
<title>carousel.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
carousel.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
Carousel 
======== 
 
.. image:: images/carousel.gif 
    :align: right 
 
.. versionadded:: 1.4.0 
 
The :class:`Carousel` widget provides the classic mobile-friendly carousel view 
where you can swipe between slides. 
You can add any content to the carousel and have it move horizontally or 
vertically. The carousel can display pages in a sequence or a loop. 
 
Example:: 
 
    from kivy.app import App 
    from kivy.uix.carousel import Carousel 
    from kivy.uix.image import AsyncImage 
 
 
    class CarouselApp(App): 
        def build(self): 
            carousel = Carousel(direction='right') 
            for i in range(10): 
                src = &quot;http://placehold.it/480x270.png&amp;text=slide-%d&amp;.png&quot; % i 
                image = AsyncImage(source=src, fit_mode=&quot;contain&quot;) 
                carousel.add_widget(image) 
            return carousel 
 
 
    CarouselApp().run() 
 
 
Kv Example:: 
 
    Carousel: 
        direction: 'right' 
        AsyncImage: 
            source: 'http://placehold.it/480x270.png&amp;text=slide-1.png' 
        AsyncImage: 
            source: 'http://placehold.it/480x270.png&amp;text=slide-2.png' 
        AsyncImage: 
            source: 'http://placehold.it/480x270.png&amp;text=slide-3.png' 
        AsyncImage: 
            source: 'http://placehold.it/480x270.png&amp;text=slide-4.png' 
 
 
.. versionchanged:: 1.5.0 
    The carousel now supports active children, like the 
    :class:`~kivy.uix.scrollview.ScrollView`. It will detect a swipe gesture 
    according to the :attr:`Carousel.scroll_timeout` and 
    :attr:`Carousel.scroll_distance` properties. 
 
    In addition, the slide container is no longer exposed by the API. 
    The impacted properties are 
    :attr:`Carousel.slides`, :attr:`Carousel.current_slide`, 
    :attr:`Carousel.previous_slide` and :attr:`Carousel.next_slide`. 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'Carousel'</span><span class="s2">, )</span>

<span class="s4">from </span><span class="s1">functools </span><span class="s4">import </span><span class="s1">partial</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">clock </span><span class="s4">import </span><span class="s1">Clock</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">factory </span><span class="s4">import </span><span class="s1">Factory</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">animation </span><span class="s4">import </span><span class="s1">Animation</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">stencilview </span><span class="s4">import </span><span class="s1">StencilView</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">relativelayout </span><span class="s4">import </span><span class="s1">RelativeLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">BooleanProperty</span><span class="s2">, </span><span class="s1">OptionProperty</span><span class="s2">, </span><span class="s1">AliasProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">ListProperty</span><span class="s2">, </span><span class="s1">ObjectProperty</span><span class="s2">, </span><span class="s1">StringProperty</span>


<span class="s4">class </span><span class="s1">Carousel</span><span class="s2">(</span><span class="s1">StencilView</span><span class="s2">):</span>
    <span class="s0">'''Carousel class. See module documentation for more information. 
    '''</span>

    <span class="s1">slides </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([])</span>
    <span class="s3">'''List of slides inside the Carousel. The slides are the 
    widgets added to the Carousel using the :attr:`add_widget` method. 
 
    :attr:`slides` is a :class:`~kivy.properties.ListProperty` and is 
    read-only. 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_slides_container</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s2">[</span><span class="s1">x</span><span class="s2">.</span><span class="s1">parent </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">]</span>

    <span class="s1">slides_container </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_slides_container</span><span class="s2">, </span><span class="s1">bind</span><span class="s2">=(</span><span class="s3">'slides'</span><span class="s2">,))</span>

    <span class="s1">direction </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span><span class="s3">'right'</span><span class="s2">,</span>
                               <span class="s1">options</span><span class="s2">=(</span><span class="s3">'right'</span><span class="s2">, </span><span class="s3">'left'</span><span class="s2">, </span><span class="s3">'top'</span><span class="s2">, </span><span class="s3">'bottom'</span><span class="s2">))</span>
    <span class="s3">'''Specifies the direction in which the slides are ordered. This 
    corresponds to the direction from which the user swipes to go from one 
    slide to the next. It 
    can be `right`, `left`, `top`, or `bottom`. For example, with 
    the default value of `right`, the second slide is to the right 
    of the first and the user would swipe from the right towards the 
    left to get to the second slide. 
 
    :attr:`direction` is an :class:`~kivy.properties.OptionProperty` and 
    defaults to 'right'. 
    '''</span>

    <span class="s1">min_move </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">)</span>
    <span class="s3">'''Defines the minimum distance to be covered before the touch is 
    considered a swipe gesture and the Carousel content changed. 
    This is a expressed as a fraction of the Carousel's width. 
    If the movement doesn't reach this minimum value, the movement is 
    cancelled and the content is restored to its original position. 
 
    :attr:`min_move` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 0.2. 
    '''</span>

    <span class="s1">anim_move_duration </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s3">'''Defines the duration of the Carousel animation between pages. 
 
    :attr:`anim_move_duration` is a :class:`~kivy.properties.NumericProperty` 
    and defaults to 0.5. 
    '''</span>

    <span class="s1">anim_cancel_duration </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0.3</span><span class="s2">)</span>
    <span class="s3">'''Defines the duration of the animation when a swipe movement is not 
    accepted. This is generally when the user does not make a large enough 
    swipe. See :attr:`min_move`. 
 
    :attr:`anim_cancel_duration` is a :class:`~kivy.properties.NumericProperty` 
    and defaults to 0.3. 
    '''</span>

    <span class="s1">loop </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">'''Allow the Carousel to loop infinitely. If True, when the user tries to 
    swipe beyond last page, it will return to the first. If False, it will 
    remain on the last page. 
 
    :attr:`loop` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to False. 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">% </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">)</span>
        <span class="s4">return None</span>

    <span class="s4">def </span><span class="s1">_set_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">= </span><span class="s1">value </span><span class="s2">% </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_index </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s1">index </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_index</span><span class="s2">, </span><span class="s1">_set_index</span><span class="s2">,</span>
                          <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'_index'</span><span class="s2">, </span><span class="s3">'slides'</span><span class="s2">),</span>
                          <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Get/Set the current slide based on the index. 
 
    :attr:`index` is an :class:`~kivy.properties.AliasProperty` and defaults 
    to 0 (the first item). 
    '''</span>

    <span class="s4">def </span><span class="s1">_prev_slide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">slides </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span>
        <span class="s1">len_slides </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">slides</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s4">if </span><span class="s1">len_slides </span><span class="s2">&lt; </span><span class="s5">2</span><span class="s2">:  </span><span class="s6"># None, or 1 slide</span>
            <span class="s4">return None</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loop </span><span class="s4">and </span><span class="s1">index </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">slides</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">index </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">slides</span><span class="s2">[</span><span class="s1">index </span><span class="s2">- </span><span class="s5">1</span><span class="s2">]</span>

    <span class="s1">previous_slide </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_prev_slide</span><span class="s2">,</span>
                                   <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'slides'</span><span class="s2">, </span><span class="s3">'index'</span><span class="s2">, </span><span class="s3">'loop'</span><span class="s2">),</span>
                                   <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''The previous slide in the Carousel. It is None if the current slide is 
    the first slide in the Carousel. This ordering reflects the order in which 
    the slides are added: their presentation varies according to the 
    :attr:`direction` property. 
 
    :attr:`previous_slide` is an :class:`~kivy.properties.AliasProperty`. 
 
    .. versionchanged:: 1.5.0 
        This property no longer exposes the slides container. It returns 
        the widget you have added. 
    '''</span>

    <span class="s4">def </span><span class="s1">_curr_slide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">):</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s4">or </span><span class="s5">0</span><span class="s2">]</span>

    <span class="s1">current_slide </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_curr_slide</span><span class="s2">,</span>
                                  <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'slides'</span><span class="s2">, </span><span class="s3">'index'</span><span class="s2">),</span>
                                  <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''The currently shown slide. 
 
    :attr:`current_slide` is an :class:`~kivy.properties.AliasProperty`. 
 
    .. versionchanged:: 1.5.0 
        The property no longer exposes the slides container. It returns 
        the widget you have added. 
    '''</span>

    <span class="s4">def </span><span class="s1">_next_slide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">) &lt; </span><span class="s5">2</span><span class="s2">:  </span><span class="s6"># None, or 1 slide</span>
            <span class="s4">return None</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loop </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">]</span>

    <span class="s1">next_slide </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_next_slide</span><span class="s2">,</span>
                               <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'slides'</span><span class="s2">, </span><span class="s3">'index'</span><span class="s2">, </span><span class="s3">'loop'</span><span class="s2">),</span>
                               <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''The next slide in the Carousel. It is None if the current slide is 
    the last slide in the Carousel. This ordering reflects the order in which 
    the slides are added: their presentation varies according to the 
    :attr:`direction` property. 
 
    :attr:`next_slide` is an :class:`~kivy.properties.AliasProperty`. 
 
    .. versionchanged:: 1.5.0 
        The property no longer exposes the slides container. 
        It returns the widget you have added. 
    '''</span>

    <span class="s1">scroll_timeout </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">200</span><span class="s2">)</span>
    <span class="s3">'''Timeout allowed to trigger the :attr:`scroll_distance`, in milliseconds. 
    If the user has not moved :attr:`scroll_distance` within the timeout, 
    no scrolling will occur and the touch event will go to the children. 
 
    :attr:`scroll_timeout` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 200 (milliseconds) 
 
    .. versionadded:: 1.5.0 
    '''</span>

    <span class="s1">scroll_distance </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s3">'20dp'</span><span class="s2">)</span>
    <span class="s3">'''Distance to move before scrolling the :class:`Carousel` in pixels. As 
    soon as the distance has been traveled, the :class:`Carousel` will start 
    to scroll, and no touch event will go to children. 
    It is advisable that you base this value on the dpi of your target device's 
    screen. 
 
    :attr:`scroll_distance` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 20dp. 
 
    .. versionadded:: 1.5.0 
    '''</span>

    <span class="s1">anim_type </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">'out_quad'</span><span class="s2">)</span>
    <span class="s3">'''Type of animation to use while animating to the next/previous slide. 
    This should be the name of an 
    :class:`~kivy.animation.AnimationTransition` function. 
 
    :attr:`anim_type` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'out_quad'. 
 
    .. versionadded:: 1.8.0 
    '''</span>

    <span class="s1">ignore_perpendicular_swipes </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">'''Ignore swipes on axis perpendicular to direction. 
 
    :attr:`ignore_perpendicular_swipes` is a 
    :class:`~kivy.properties.BooleanProperty` and defaults to False. 
 
    .. versionadded:: 1.10.0 
    '''</span>

    <span class="s6"># private properties, for internal use only ###</span>
    <span class="s1">_index </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s1">_prev </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s1">_current </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s1">_next </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s1">_offset </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">_touch </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>

    <span class="s1">_change_touch_mode_ev </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_position_visible_slides </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_position_visible_slides</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_skip_slide </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">touch_mode_change </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_prioritize_next </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span><span class="s2">(</span><span class="s3">'loop'</span><span class="s2">, </span><span class="s4">lambda </span><span class="s2">*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_visible_slides</span><span class="s2">())</span>

    <span class="s4">def </span><span class="s1">load_slide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">slide</span><span class="s2">):</span>
        <span class="s0">'''Animate to the slide that is passed as the argument. 
 
        .. versionchanged:: 1.8.0 
        '''</span>
        <span class="s1">slides </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span>
        <span class="s1">start</span><span class="s2">, </span><span class="s1">stop </span><span class="s2">= </span><span class="s1">slides</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_slide</span><span class="s2">), </span><span class="s1">slides</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">slide</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">start </span><span class="s2">== </span><span class="s1">stop</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_skip_slide </span><span class="s2">= </span><span class="s1">stop</span>
        <span class="s4">if </span><span class="s1">stop </span><span class="s2">&gt; </span><span class="s1">start</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_prioritize_next </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_visible_slides</span><span class="s2">(</span><span class="s1">_next_slide</span><span class="s2">=</span><span class="s1">slide</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">load_next</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_prioritize_next </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_visible_slides</span><span class="s2">(</span><span class="s1">_prev_slide</span><span class="s2">=</span><span class="s1">slide</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">load_previous</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">load_previous</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">'''Animate to the previous slide. 
 
        .. versionadded:: 1.7.0 
        '''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">load_next</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'prev'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">load_next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'next'</span><span class="s2">):</span>
        <span class="s0">'''Animate to the next slide. 
 
        .. versionadded:: 1.7.0 
        '''</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span>
            <span class="s1">_direction </span><span class="s2">= {</span>
                <span class="s3">'top'</span><span class="s2">: -</span><span class="s1">h </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">,</span>
                <span class="s3">'bottom'</span><span class="s2">: </span><span class="s1">h </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">,</span>
                <span class="s3">'left'</span><span class="s2">: </span><span class="s1">w </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">,</span>
                <span class="s3">'right'</span><span class="s2">: -</span><span class="s1">w </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">}</span>
            <span class="s1">_offset </span><span class="s2">= </span><span class="s1">_direction</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">direction</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s3">'prev'</span><span class="s2">:</span>
                <span class="s1">_offset </span><span class="s2">= -</span><span class="s1">_offset</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_animation</span><span class="s2">(</span><span class="s1">min_move</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s1">_offset</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">get_slide_container</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">slide</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">slide</span><span class="s2">.</span><span class="s1">parent</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s4">def </span><span class="s1">_prev_equals_next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loop </span><span class="s4">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">) == </span><span class="s5">2</span>

    <span class="s4">def </span><span class="s1">_insert_visible_slides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_next_slide</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">_prev_slide</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s1">get_slide_container </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_slide_container</span>

        <span class="s1">previous_slide </span><span class="s2">= </span><span class="s1">_prev_slide </span><span class="s4">if </span><span class="s1">_prev_slide </span><span class="s4">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">previous_slide</span>
        <span class="s4">if </span><span class="s1">previous_slide</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_prev </span><span class="s2">= </span><span class="s1">get_slide_container</span><span class="s2">(</span><span class="s1">previous_slide</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_prev </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">current_slide </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_slide</span>
        <span class="s4">if </span><span class="s1">current_slide</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_current </span><span class="s2">= </span><span class="s1">get_slide_container</span><span class="s2">(</span><span class="s1">current_slide</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_current </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">next_slide </span><span class="s2">= </span><span class="s1">_next_slide </span><span class="s4">if </span><span class="s1">_next_slide </span><span class="s4">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">next_slide</span>
        <span class="s4">if </span><span class="s1">next_slide</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_next </span><span class="s2">= </span><span class="s1">get_slide_container</span><span class="s2">(</span><span class="s1">next_slide</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_next </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_equals_next</span><span class="s2">:</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'_prev' </span><span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prioritize_next </span><span class="s4">else </span><span class="s3">'_next'</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>

        <span class="s1">super_remove </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">remove_widget</span>
        <span class="s4">for </span><span class="s1">container </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides_container</span><span class="s2">:</span>
            <span class="s1">super_remove</span><span class="s2">(</span><span class="s1">container</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev</span><span class="s2">.</span><span class="s1">parent </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_next </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_next</span><span class="s2">.</span><span class="s1">parent </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_next</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_current</span><span class="s2">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_current</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_position_visible_slides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">slides</span><span class="s2">, </span><span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">no_of_slides </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">slides</span><span class="s2">) - </span><span class="s5">1</span>
        <span class="s4">if not </span><span class="s1">slides</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s1">_offset</span><span class="s2">, </span><span class="s1">direction </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_offset</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direction</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">_prev</span><span class="s2">, </span><span class="s1">_next</span><span class="s2">, </span><span class="s1">_current </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_next</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_current</span>
        <span class="s1">get_slide_container </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_slide_container</span>
        <span class="s1">last_slide </span><span class="s2">= </span><span class="s1">get_slide_container</span><span class="s2">(</span><span class="s1">slides</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">first_slide </span><span class="s2">= </span><span class="s1">get_slide_container</span><span class="s2">(</span><span class="s1">slides</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">skip_next </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">_loop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loop</span>

        <span class="s4">if </span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'rl'</span><span class="s2">:</span>
            <span class="s1">xoff </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">_offset</span>
            <span class="s1">x_prev </span><span class="s2">= {</span><span class="s3">'l'</span><span class="s2">: </span><span class="s1">xoff </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">: </span><span class="s1">xoff </span><span class="s2">- </span><span class="s1">width</span><span class="s2">}</span>
            <span class="s1">x_next </span><span class="s2">= {</span><span class="s3">'l'</span><span class="s2">: </span><span class="s1">xoff </span><span class="s2">- </span><span class="s1">width</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">: </span><span class="s1">xoff </span><span class="s2">+ </span><span class="s1">width</span><span class="s2">}</span>
            <span class="s4">if </span><span class="s1">_prev</span><span class="s2">:</span>
                <span class="s1">_prev</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x_prev</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">], </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">_loop </span><span class="s4">and </span><span class="s1">_next </span><span class="s4">and </span><span class="s1">index </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s6"># if first slide is moving to right with direction set to right</span>
                <span class="s6"># or toward left with direction set to left</span>
                <span class="s4">if </span><span class="s2">((</span><span class="s1">_offset </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'r'</span><span class="s2">) </span><span class="s4">or</span>
                        <span class="s2">(</span><span class="s1">_offset </span><span class="s2">&lt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'l'</span><span class="s2">)):</span>
                    <span class="s6"># put last_slide before first slide</span>
                    <span class="s1">last_slide</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x_prev</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">], </span><span class="s1">y</span><span class="s2">)</span>
                    <span class="s1">skip_next </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s4">if </span><span class="s1">_current</span><span class="s2">:</span>
                <span class="s1">_current</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">xoff</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">skip_next</span><span class="s2">:</span>
                <span class="s4">return</span>
            <span class="s4">if </span><span class="s1">_next</span><span class="s2">:</span>
                <span class="s1">_next</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x_next</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">], </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">_loop </span><span class="s4">and </span><span class="s1">_prev </span><span class="s4">and </span><span class="s1">index </span><span class="s2">== </span><span class="s1">no_of_slides</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s2">((</span><span class="s1">_offset </span><span class="s2">&lt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'r'</span><span class="s2">) </span><span class="s4">or</span>
                        <span class="s2">(</span><span class="s1">_offset </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'l'</span><span class="s2">)):</span>
                    <span class="s1">first_slide</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x_next</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">], </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'tb'</span><span class="s2">:</span>
            <span class="s1">yoff </span><span class="s2">= </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">_offset</span>
            <span class="s1">y_prev </span><span class="s2">= {</span><span class="s3">'t'</span><span class="s2">: </span><span class="s1">yoff </span><span class="s2">- </span><span class="s1">height</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">: </span><span class="s1">yoff </span><span class="s2">+ </span><span class="s1">height</span><span class="s2">}</span>
            <span class="s1">y_next </span><span class="s2">= {</span><span class="s3">'t'</span><span class="s2">: </span><span class="s1">yoff </span><span class="s2">+ </span><span class="s1">height</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">: </span><span class="s1">yoff </span><span class="s2">- </span><span class="s1">height</span><span class="s2">}</span>
            <span class="s4">if </span><span class="s1">_prev</span><span class="s2">:</span>
                <span class="s1">_prev</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_prev</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">])</span>
            <span class="s4">elif </span><span class="s1">_loop </span><span class="s4">and </span><span class="s1">_next </span><span class="s4">and </span><span class="s1">index </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s2">((</span><span class="s1">_offset </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'t'</span><span class="s2">) </span><span class="s4">or</span>
                        <span class="s2">(</span><span class="s1">_offset </span><span class="s2">&lt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'b'</span><span class="s2">)):</span>
                    <span class="s1">last_slide</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_prev</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">])</span>
                    <span class="s1">skip_next </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s4">if </span><span class="s1">_current</span><span class="s2">:</span>
                <span class="s1">_current</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">yoff</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">skip_next</span><span class="s2">:</span>
                <span class="s4">return</span>
            <span class="s4">if </span><span class="s1">_next</span><span class="s2">:</span>
                <span class="s1">_next</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_next</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">])</span>
            <span class="s4">elif </span><span class="s1">_loop </span><span class="s4">and </span><span class="s1">_prev </span><span class="s4">and </span><span class="s1">index </span><span class="s2">== </span><span class="s1">no_of_slides</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s2">((</span><span class="s1">_offset </span><span class="s2">&lt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'t'</span><span class="s2">) </span><span class="s4">or</span>
                        <span class="s2">(</span><span class="s1">_offset </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s4">and </span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'b'</span><span class="s2">)):</span>
                    <span class="s1">first_slide</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_next</span><span class="s2">[</span><span class="s1">direction</span><span class="s2">])</span>

    <span class="s4">def </span><span class="s1">on_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s4">for </span><span class="s1">slide </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides_container</span><span class="s2">:</span>
            <span class="s1">slide</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_position_visible_slides</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_pos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_position_visible_slides</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_visible_slides</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_position_visible_slides</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s4">def </span><span class="s1">on_slides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">% </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert_visible_slides</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_position_visible_slides</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on__offset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_position_visible_slides</span><span class="s2">()</span>
        <span class="s6"># if reached full offset, switch index to next or prev</span>
        <span class="s1">direction </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direction</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">_offset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_offset</span>
        <span class="s1">width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s1">height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_skip_slide </span><span class="s4">is not None or </span><span class="s1">index </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s6"># Move to next slide?</span>
        <span class="s4">if </span><span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'r' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&lt;= -</span><span class="s1">width</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'l' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&gt;= </span><span class="s1">width</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'t' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&lt;= - </span><span class="s1">height</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'b' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&gt;= </span><span class="s1">height</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">next_slide</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+= </span><span class="s5">1</span>

        <span class="s6"># Move to previous slide?</span>
        <span class="s4">elif </span><span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'r' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&gt;= </span><span class="s1">width</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'l' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&lt;= -</span><span class="s1">width</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'t' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&gt;= </span><span class="s1">height</span><span class="s2">) </span><span class="s4">or </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">direction </span><span class="s2">== </span><span class="s3">'b' </span><span class="s4">and </span><span class="s1">_offset </span><span class="s2">&lt;= -</span><span class="s1">height</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">previous_slide</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">-= </span><span class="s5">1</span>

        <span class="s4">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev_equals_next</span><span class="s2">:</span>
            <span class="s1">new_value </span><span class="s2">= (</span><span class="s1">_offset </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">) </span><span class="s4">is </span><span class="s2">(</span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'rt'</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prioritize_next </span><span class="s4">is not </span><span class="s1">new_value</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_prioritize_next </span><span class="s2">= </span><span class="s1">new_value</span>
                <span class="s4">if </span><span class="s1">new_value </span><span class="s4">is </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_next </span><span class="s4">is None</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_prev</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_next </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_next</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prev</span>

    <span class="s4">def </span><span class="s1">_start_animation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6"># compute target offset for ease back, next or prev</span>
        <span class="s1">new_offset </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">direction </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'direction'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direction</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">is_horizontal </span><span class="s2">= </span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'rl'</span>
        <span class="s1">extent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s4">if </span><span class="s1">is_horizontal </span><span class="s4">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s1">min_move </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'min_move'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">min_move</span><span class="s2">)</span>
        <span class="s1">_offset </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'offset'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_offset</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">_offset </span><span class="s2">&lt; </span><span class="s1">min_move </span><span class="s2">* -</span><span class="s1">extent</span><span class="s2">:</span>
            <span class="s1">new_offset </span><span class="s2">= -</span><span class="s1">extent</span>
        <span class="s4">elif </span><span class="s1">_offset </span><span class="s2">&gt; </span><span class="s1">min_move </span><span class="s2">* </span><span class="s1">extent</span><span class="s2">:</span>
            <span class="s1">new_offset </span><span class="s2">= </span><span class="s1">extent</span>

        <span class="s6"># if new_offset is 0, it wasn't enough to go next/prev</span>
        <span class="s1">dur </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">anim_move_duration</span>
        <span class="s4">if </span><span class="s1">new_offset </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">dur </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">anim_cancel_duration</span>

        <span class="s6"># detect edge cases if not looping</span>
        <span class="s1">len_slides </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loop </span><span class="s4">or </span><span class="s1">len_slides </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">is_first </span><span class="s2">= (</span><span class="s1">index </span><span class="s2">== </span><span class="s5">0</span><span class="s2">)</span>
            <span class="s1">is_last </span><span class="s2">= (</span><span class="s1">index </span><span class="s2">== </span><span class="s1">len_slides </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'rt'</span><span class="s2">:</span>
                <span class="s1">towards_prev </span><span class="s2">= (</span><span class="s1">new_offset </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">)</span>
                <span class="s1">towards_next </span><span class="s2">= (</span><span class="s1">new_offset </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">towards_prev </span><span class="s2">= (</span><span class="s1">new_offset </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">)</span>
                <span class="s1">towards_next </span><span class="s2">= (</span><span class="s1">new_offset </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s2">(</span><span class="s1">is_first </span><span class="s4">and </span><span class="s1">towards_prev</span><span class="s2">) </span><span class="s4">or </span><span class="s2">(</span><span class="s1">is_last </span><span class="s4">and </span><span class="s1">towards_next</span><span class="s2">):</span>
                <span class="s1">new_offset </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s1">anim </span><span class="s2">= </span><span class="s1">Animation</span><span class="s2">(</span><span class="s1">_offset</span><span class="s2">=</span><span class="s1">new_offset</span><span class="s2">, </span><span class="s1">d</span><span class="s2">=</span><span class="s1">dur</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">anim_type</span><span class="s2">)</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">cancel_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s4">def </span><span class="s1">_cmp</span><span class="s2">(*</span><span class="s1">l</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_skip_slide </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_skip_slide</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_skip_slide </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">anim</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">on_complete</span><span class="s2">=</span><span class="s1">_cmp</span><span class="s2">)</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s3">'sv'</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">'{0}.{1}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">prefix</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'cavoid'</span><span class="s2">)] = </span><span class="s4">True</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">disabled</span><span class="s2">:</span>
            <span class="s4">return True</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s1">Animation</span><span class="s2">.</span><span class="s1">cancel_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s1">touch</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">] = {</span>
            <span class="s3">'mode'</span><span class="s2">: </span><span class="s3">'unknown'</span><span class="s2">,</span>
            <span class="s3">'time'</span><span class="s2">: </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">time_start</span><span class="s2">}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_timeout </span><span class="s2">/ </span><span class="s5">1000.</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">touch_mode_change </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">touch_mode_change</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignore_perpendicular_swipes </span><span class="s4">and </span><span class="s1">\</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">direction </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'top'</span><span class="s2">, </span><span class="s3">'bottom'</span><span class="s2">):</span>
                <span class="s4">if </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">oy </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y</span><span class="s2">) &lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_distance</span><span class="s2">:</span>
                    <span class="s4">if </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ox </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">) &gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_distance</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode</span><span class="s2">()</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">touch_mode_change </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s4">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ignore_perpendicular_swipes </span><span class="s4">and </span><span class="s1">\</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">direction </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'right'</span><span class="s2">, </span><span class="s3">'left'</span><span class="s2">):</span>
                <span class="s4">if </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ox </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">) &lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_distance</span><span class="s2">:</span>
                    <span class="s4">if </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">oy </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y</span><span class="s2">) &gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_distance</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode</span><span class="s2">()</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">touch_mode_change </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'cavoid'</span><span class="s2">) </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s4">is not </span><span class="s1">touch</span><span class="s2">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">() </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return True</span>
        <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()]</span>
        <span class="s1">direction </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direction</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] == </span><span class="s3">'unknown'</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'rl'</span><span class="s2">:</span>
                <span class="s1">distance </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ox </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">distance </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">oy </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">distance </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_distance</span><span class="s2">:</span>
                <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode_ev</span>
                <span class="s4">if </span><span class="s1">ev </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                <span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] = </span><span class="s3">'scroll'</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'rl'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">+= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">dx</span>
            <span class="s4">if </span><span class="s1">direction </span><span class="s4">in </span><span class="s3">'tb'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">+= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">dy</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'cavoid'</span><span class="s2">) </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self </span><span class="s4">in </span><span class="s2">[</span><span class="s1">x</span><span class="s2">() </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_list</span><span class="s2">]:</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">ungrab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()]</span>
            <span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] == </span><span class="s3">'unknown'</span><span class="s2">:</span>
                <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode_ev</span>
                <span class="s4">if </span><span class="s1">ev </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
                <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_do_touch_up</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">), </span><span class="s5">.1</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_animation</span><span class="s2">()</span>

        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s4">is not </span><span class="s1">touch </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid </span><span class="s4">not in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
                <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">() </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span>

    <span class="s4">def </span><span class="s1">_do_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s6"># don't forget about grab event!</span>
        <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_list</span><span class="s2">[:]:</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_list</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">x</span><span class="s2">:</span>
                <span class="s4">continue</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s2">= </span><span class="s1">x</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">_change_touch_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_animation</span><span class="s2">()</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()</span>
        <span class="s1">touch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch</span>
        <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] == </span><span class="s3">'unknown'</span><span class="s2">:</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">ungrab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s4">return</span>

    <span class="s4">def </span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">container </span><span class="s2">= </span><span class="s1">RelativeLayout</span><span class="s2">(</span>
            <span class="s1">size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">container</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">container</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">index </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">index </span><span class="s2">- </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">), </span><span class="s1">widget</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6"># XXX be careful, the widget.parent refer to the RelativeLayout</span>
        <span class="s6"># added in add_widget(). But it will break if RelativeLayout</span>
        <span class="s6"># implementation change.</span>
        <span class="s6"># if we passed the real widget</span>
        <span class="s1">slides </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span>
        <span class="s4">if </span><span class="s1">widget </span><span class="s4">in </span><span class="s1">slides</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s1">slides</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">container </span><span class="s2">= </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">parent</span>
            <span class="s1">slides</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">)</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">container</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s1">container</span><span class="s2">.</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">)</span>
            <span class="s4">return</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">clear_widgets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">children</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6"># `children` must be a list of slides or None</span>
        <span class="s4">if </span><span class="s1">children </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">children </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">slides</span><span class="s2">[:]</span>
        <span class="s1">remove_widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">remove_widget</span>
        <span class="s4">for </span><span class="s1">widget </span><span class="s4">in </span><span class="s1">children</span><span class="s2">:</span>
            <span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Carousel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">clear_widgets</span><span class="s2">()</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">app </span><span class="s4">import </span><span class="s1">App</span>

    <span class="s4">class </span><span class="s1">Example1</span><span class="s2">(</span><span class="s1">App</span><span class="s2">):</span>

        <span class="s4">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">carousel </span><span class="s2">= </span><span class="s1">Carousel</span><span class="s2">(</span><span class="s1">direction</span><span class="s2">=</span><span class="s3">'left'</span><span class="s2">,</span>
                                <span class="s1">loop</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">4</span><span class="s2">):</span>
                <span class="s1">src </span><span class="s2">= </span><span class="s3">&quot;http://placehold.it/480x270.png&amp;text=slide-%d&amp;.png&quot; </span><span class="s2">% </span><span class="s1">i</span>
                <span class="s1">image </span><span class="s2">= </span><span class="s1">Factory</span><span class="s2">.</span><span class="s1">AsyncImage</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">src</span><span class="s2">, </span><span class="s1">fit_mode</span><span class="s2">=</span><span class="s3">&quot;contain&quot;</span><span class="s2">)</span>
                <span class="s1">carousel</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
            <span class="s4">return </span><span class="s1">carousel</span>

    <span class="s1">Example1</span><span class="s2">().</span><span class="s1">run</span><span class="s2">()</span>
</pre>
</body>
</html>