<html>
<head>
<title>bubble.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
bubble.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
Bubble 
====== 
 
.. versionadded:: 1.1.0 
 
.. image:: images/bubble.jpg 
    :align: right 
 
The :class:`Bubble` widget is a form of menu or a small popup with an arrow 
arranged on one side of it's content. 
 
The :class:`Bubble` contains an arrow attached to the content 
(e.g., :class:`BubbleContent`) pointing in the direction you choose. It can 
be placed either at a predefined location or flexibly by specifying a relative 
position on the border of the widget. 
 
The :class:`BubbleContent` is a styled BoxLayout and is thought to be added to 
the :class:`Bubble` as a child widget. The :class:`Bubble` will then arrange 
an arrow around the content as desired. Instead of the class:`BubbleContent`, 
you can theoretically use any other :class:`Widget` as well as long as it 
supports the 'bind' and 'unbind' function of the :class:`EventDispatcher` and 
is compatible with Kivy to be placed inside a :class:`BoxLayout`. 
 
The :class:`BubbleButton`is a styled Button. It suits to the style of 
:class:`Bubble` and :class:`BubbleContent`. Feel free to place other Widgets 
inside the 'content' of the :class:`Bubble`. 
 
 
.. versionchanged:: 2.2.0 
The properties :attr:`background_image`, :attr:`background_color`, 
:attr:`border` and :attr:`border_auto_scale` were removed from :class:`Bubble`. 
These properties had only been used by the content widget that now uses it's 
own properties instead. The color of the arrow is now changed with 
:attr:`arrow_color` instead of :attr:`background_color`. 
These changes makes the :class:`Bubble` transparent to use with other layouts 
as content without any side-effects due to property inheritance. 
 
The property :attr:`flex_arrow_pos` has been added to allow further 
customization of the arrow positioning. 
 
The properties :attr:`arrow_margin`, :attr:`arrow_margin_x`, 
:attr:`arrow_margin_y`, :attr:`content_size`, :attr:`content_width` and 
:attr:`content_height` have been added to ease proper sizing of a 
:class:`Bubble` e.g., based on it's content size. 
 
BubbleContent 
============= 
 
The :class:`BubbleContent` is a styled BoxLayout that can be used to 
add e.g., :class:`BubbleButtons` as menu items. 
 
.. versionchanged:: 2.2.0 
The properties :attr:`background_image`, :attr:`background_color`, 
:attr:`border` and :attr:`border_auto_scale` were added to the 
:class:`BubbleContent`. The :class:`BubbleContent` does no longer rely on these 
properties being present in the parent class. 
 
BubbleButton 
============ 
 
The :class:`BubbleButton` is a styled :class:`Button` that can be used to be 
added to the :class:`BubbleContent`. 
 
Simple example 
-------------- 
 
.. include:: ../../examples/widgets/bubble_test.py 
    :literal: 
 
Customize the Bubble 
-------------------- 
 
You can choose the direction in which the arrow points:: 
 
    Bubble(arrow_pos='top_mid') 
    or 
    Bubble(size=(200, 40), flex_arrow_pos=(175, 40)) 
 
    Similarly, the corresponding properties in the '.kv' language can be used 
    as well. 
 
You can change the appearance of the bubble:: 
 
    Bubble( 
        arrow_image='/path/to/arrow/image', 
        arrow_color=(1, 0, 0, .5)), 
    ) 
    BubbleContent( 
        background_image='/path/to/background/image', 
        background_color=(1, 0, 0, .5),  # 50% translucent red 
        border=(0,0,0,0), 
    ) 
 
    Similarly, the corresponding properties in the '.kv' language can be used 
    as well. 
 
----------------------------- 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'Bubble'</span><span class="s2">, </span><span class="s3">'BubbleButton'</span><span class="s2">, </span><span class="s3">'BubbleContent'</span><span class="s2">)</span>

<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">image </span><span class="s4">import </span><span class="s1">Image</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">scatter </span><span class="s4">import </span><span class="s1">Scatter</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">boxlayout </span><span class="s4">import </span><span class="s1">BoxLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">relativelayout </span><span class="s4">import </span><span class="s1">RelativeLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">button </span><span class="s4">import </span><span class="s1">Button</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">ObjectProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">StringProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">OptionProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">ListProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">BooleanProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">ColorProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">NumericProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">ReferenceListProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">base </span><span class="s4">import </span><span class="s1">EventLoop</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">metrics </span><span class="s4">import </span><span class="s1">dp</span>


<span class="s4">class </span><span class="s1">BubbleException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">BubbleButton</span><span class="s2">(</span><span class="s1">Button</span><span class="s2">):</span>
    <span class="s0">'''A button intended for use in a BubbleContent widget. 
    You can use a &quot;normal&quot; button class, but it will not look good unless the 
    background is changed. 
 
    Rather use this BubbleButton widget that is already defined and provides a 
    suitable background for you. 
    '''</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">BubbleContent</span><span class="s2">(</span><span class="s1">BoxLayout</span><span class="s2">):</span>
    <span class="s0">'''A styled BoxLayout that can be used as the content widget of a Bubble. 
 
    .. versionchanged:: 2.2.0 
    The graphical appearance of :class:`BubbleContent` is now based on it's 
    own properties :attr:`background_image`, :attr:`background_color`, 
    :attr:`border` and :attr:`border_auto_scale`. The parent widget properties 
    are no longer considered. This makes the BubbleContent a standalone themed 
    BoxLayout. 
    '''</span>

    <span class="s1">background_color </span><span class="s2">= </span><span class="s1">ColorProperty</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s3">'''Background color, in the format (r, g, b, a). To use it you have to set 
    :attr:`background_image` first. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`background_color` is a :class:`~kivy.properties.ColorProperty` and 
    defaults to [1, 1, 1, 1]. 
    '''</span>

    <span class="s1">background_image </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">'atlas://data/images/defaulttheme/bubble'</span><span class="s2">)</span>
    <span class="s3">'''Background image of the bubble. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`background_image` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/bubble'. 
    '''</span>

    <span class="s1">border </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([</span><span class="s5">16</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">16</span><span class="s2">])</span>
    <span class="s3">'''Border used for :class:`~kivy.graphics.vertex_instructions.BorderImage` 
    graphics instruction. Used with the :attr:`background_image`. 
    It should be used when using custom backgrounds. 
 
    It must be a list of 4 values: (bottom, right, top, left). Read the 
    BorderImage instructions for more information about how to use it. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`border` is a :class:`~kivy.properties.ListProperty` and defaults to 
    (16, 16, 16, 16) 
    '''</span>

    <span class="s1">border_auto_scale </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span>
        <span class="s3">'both_lower'</span><span class="s2">,</span>
        <span class="s1">options</span><span class="s2">=[</span>
            <span class="s3">'off'</span><span class="s2">, </span><span class="s3">'both'</span><span class="s2">, </span><span class="s3">'x_only'</span><span class="s2">, </span><span class="s3">'y_only'</span><span class="s2">, </span><span class="s3">'y_full_x_lower'</span><span class="s2">,</span>
            <span class="s3">'x_full_y_lower'</span><span class="s2">, </span><span class="s3">'both_lower'</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s3">'''Specifies the :attr:`kivy.graphics.BorderImage.auto_scale` 
    value on the background BorderImage. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`border_auto_scale` is a 
    :class:`~kivy.properties.OptionProperty` and defaults to 
    'both_lower'. 
    '''</span>


<span class="s4">class </span><span class="s1">Bubble</span><span class="s2">(</span><span class="s1">BoxLayout</span><span class="s2">):</span>
    <span class="s0">'''Bubble class. See module documentation for more information. 
    '''</span>

    <span class="s1">content </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''This is the object where the main content of the bubble is held. 
 
    The content of the Bubble set by 'add_widget' and removed with 
    'remove_widget' similarly to the :class:`ActionView` which is placed into 
    a class:`ActionBar` 
 
    :attr:`content` is a :class:`~kivy.properties.ObjectProperty` and defaults 
    to None. 
    '''</span>

    <span class="s1">arrow_image </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/bubble_arrow'</span>
    <span class="s2">)</span>
    <span class="s3">''' Image of the arrow pointing to the bubble. 
 
    :attr:`arrow_image` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/bubble_arrow'. 
    '''</span>

    <span class="s1">arrow_color </span><span class="s2">= </span><span class="s1">ColorProperty</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s3">'''Arrow color, in the format (r, g, b, a). To use it you have to set 
    :attr:`arrow_image` first. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`arrow_color` is a :class:`~kivy.properties.ColorProperty` and 
    defaults to [1, 1, 1, 1]. 
    '''</span>

    <span class="s1">show_arrow </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">''' Indicates whether to show arrow. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`show_arrow` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to `True`. 
    '''</span>

    <span class="s1">arrow_pos </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span>
        <span class="s3">'bottom_mid'</span><span class="s2">,</span>
        <span class="s1">options</span><span class="s2">=(</span>
            <span class="s3">'left_top'</span><span class="s2">, </span><span class="s3">'left_mid'</span><span class="s2">, </span><span class="s3">'left_bottom'</span><span class="s2">,</span>
            <span class="s3">'top_left'</span><span class="s2">, </span><span class="s3">'top_mid'</span><span class="s2">, </span><span class="s3">'top_right'</span><span class="s2">,</span>
            <span class="s3">'right_top'</span><span class="s2">, </span><span class="s3">'right_mid'</span><span class="s2">, </span><span class="s3">'right_bottom'</span><span class="s2">,</span>
            <span class="s3">'bottom_left'</span><span class="s2">, </span><span class="s3">'bottom_mid'</span><span class="s2">, </span><span class="s3">'bottom_right'</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s3">'''Specifies the position of the arrow as predefined relative position to 
    the bubble. 
    Can be one of: left_top, left_mid, left_bottom top_left, top_mid, top_right 
    right_top, right_mid, right_bottom bottom_left, bottom_mid, bottom_right. 
 
    :attr:`arrow_pos` is a :class:`~kivy.properties.OptionProperty` and 
    defaults to 'bottom_mid'. 
    '''</span>

    <span class="s1">flex_arrow_pos </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s3">'''Specifies the position of the arrow as flex coordinate around the 
    border of the :class:`Bubble` Widget. 
    If this property is set to a proper position (relative pixel coordinates 
    within the :class:`Bubble` widget, it overwrites the setting 
    :attr:`arrow_pos`. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`flex_arrow_pos` is a :class:`~kivy.properties.ListProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">limit_to </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Specifies the widget to which the bubbles position is restricted. 
 
    .. versionadded:: 1.6.0 
 
    :attr:`limit_to` is a :class:`~kivy.properties.ObjectProperty` and defaults 
    to 'None'. 
    '''</span>

    <span class="s1">arrow_margin_x </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s3">'''Automatically computed margin in x direction that the arrow widget 
    occupies in pixel. 
 
    In combination with the :attr:`content_width`, this property can be used 
    to determine the correct width of the Bubble to exactly enclose the 
    arrow + content by adding :attr:`content_width` and :attr:`arrow_margin_x` 
 
    .. versionadded:: 2.2.0 
 
    :attr:`arrow_margin_x` is a :class:`~kivy.properties.NumericProperty` and 
    represents the added margin in x direction due to the arrow widget. 
    It defaults to 0 and is read only. 
    '''</span>

    <span class="s1">arrow_margin_y </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s3">'''Automatically computed margin in y direction that the arrow widget 
    occupies in pixel. 
 
    In combination with the :attr:`content_height`, this property can be used 
    to determine the correct height of the Bubble to exactly enclose the 
    arrow + content by adding :attr:`content_height` and :attr:`arrow_margin_y` 
 
    .. versionadded:: 2.2.0 
 
    :attr:`arrow_margin_y` is a :class:`~kivy.properties.NumericProperty` and 
    represents the added margin in y direction due to the arrow widget. 
    It defaults to 0 and is read only. 
    '''</span>

    <span class="s1">arrow_margin </span><span class="s2">= </span><span class="s1">ReferenceListProperty</span><span class="s2">(</span><span class="s1">arrow_margin_x</span><span class="s2">, </span><span class="s1">arrow_margin_y</span><span class="s2">)</span>
    <span class="s3">'''Automatically computed margin that the arrow widget occupies in 
    x and y direction in pixel. 
 
    Check the description of :attr:`arrow_margin_x` and :attr:`arrow_margin_y`. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`arrow_margin` is a :class:`~kivy.properties.ReferenceListProperty` 
    of (:attr:`arrow_margin_x`, :attr:`arrow_margin_y`) properties. 
    It is read only. 
    '''</span>

    <span class="s1">content_width </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s3">'''The width of the content Widget. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`content_width` is a :class:`~kivy.properties.NumericProperty` and 
    is the same as self.content.width if content is not None, else it defaults 
    to 0. It is read only. 
    '''</span>

    <span class="s1">content_height </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s3">'''The height of the content Widget. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`content_height` is a :class:`~kivy.properties.NumericProperty` and 
    is the same as self.content.height if content is not None, else it defaults 
    to 0. It is read only. 
    '''</span>

    <span class="s1">content_size </span><span class="s2">= </span><span class="s1">ReferenceListProperty</span><span class="s2">(</span><span class="s1">content_width</span><span class="s2">, </span><span class="s1">content_height</span><span class="s2">)</span>
    <span class="s3">''' The size of the content Widget. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`content_size` is a :class:`~kivy.properties.ReferenceListProperty` 
    of (:attr:`content_width`, :attr:`content_height`) properties. 
    It is read only. 
    '''</span>

    <span class="s6"># Internal map that specifies the different parameters for fixed arrow</span>
    <span class="s6"># position layouts. The flex_arrow_pos uses these parameter sets</span>
    <span class="s6"># as a template.</span>
    <span class="s6"># 0: orientation of the children of Bubble ([content, arrow])</span>
    <span class="s6"># 1: order of widgets to add to the BoxLayout (default: [content, arrow])</span>
    <span class="s6"># 2: size_hint of _arrow_image_layout</span>
    <span class="s6"># 3: rotation of the _arrow_image</span>
    <span class="s6"># 4: pos_hint of the _arrow_image_layout</span>
    <span class="s1">ARROW_LAYOUTS </span><span class="s2">= {</span>
        <span class="s3">&quot;bottom_left&quot;</span><span class="s2">:  (   </span><span class="s3">&quot;vertical&quot;</span><span class="s2">,  </span><span class="s5">1</span><span class="s2">, (   </span><span class="s5">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),   </span><span class="s5">0</span><span class="s2">, {   </span><span class="s3">&quot;top&quot;</span><span class="s2">: </span><span class="s5">1.0</span><span class="s2">,        </span><span class="s3">&quot;x&quot;</span><span class="s2">: </span><span class="s5">0.05</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;bottom_mid&quot;</span><span class="s2">:   (   </span><span class="s3">&quot;vertical&quot;</span><span class="s2">,  </span><span class="s5">1</span><span class="s2">, (   </span><span class="s5">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),   </span><span class="s5">0</span><span class="s2">, {   </span><span class="s3">&quot;top&quot;</span><span class="s2">: </span><span class="s5">1.0</span><span class="s2">, </span><span class="s3">&quot;center_x&quot;</span><span class="s2">: </span><span class="s5">0.50</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;bottom_right&quot;</span><span class="s2">: (   </span><span class="s3">&quot;vertical&quot;</span><span class="s2">,  </span><span class="s5">1</span><span class="s2">, (   </span><span class="s5">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),   </span><span class="s5">0</span><span class="s2">, {   </span><span class="s3">&quot;top&quot;</span><span class="s2">: </span><span class="s5">1.0</span><span class="s2">,    </span><span class="s3">&quot;right&quot;</span><span class="s2">: </span><span class="s5">0.95</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;right_bottom&quot;</span><span class="s2">: ( </span><span class="s3">&quot;horizontal&quot;</span><span class="s2">,  </span><span class="s5">1</span><span class="s2">, (</span><span class="s4">None</span><span class="s2">,    </span><span class="s5">1</span><span class="s2">),  </span><span class="s5">90</span><span class="s2">, {  </span><span class="s3">&quot;left&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">,        </span><span class="s3">&quot;y&quot;</span><span class="s2">: </span><span class="s5">0.05</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;right_mid&quot;</span><span class="s2">:    ( </span><span class="s3">&quot;horizontal&quot;</span><span class="s2">,  </span><span class="s5">1</span><span class="s2">, (</span><span class="s4">None</span><span class="s2">,    </span><span class="s5">1</span><span class="s2">),  </span><span class="s5">90</span><span class="s2">, {  </span><span class="s3">&quot;left&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">, </span><span class="s3">&quot;center_y&quot;</span><span class="s2">: </span><span class="s5">0.50</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;right_top&quot;</span><span class="s2">:    ( </span><span class="s3">&quot;horizontal&quot;</span><span class="s2">,  </span><span class="s5">1</span><span class="s2">, (</span><span class="s4">None</span><span class="s2">,    </span><span class="s5">1</span><span class="s2">),  </span><span class="s5">90</span><span class="s2">, {  </span><span class="s3">&quot;left&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">,      </span><span class="s3">&quot;top&quot;</span><span class="s2">: </span><span class="s5">0.95</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;top_left&quot;</span><span class="s2">:     (   </span><span class="s3">&quot;vertical&quot;</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, (   </span><span class="s5">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">), </span><span class="s5">180</span><span class="s2">, {</span><span class="s3">&quot;bottom&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">,        </span><span class="s3">&quot;x&quot;</span><span class="s2">: </span><span class="s5">0.05</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;top_mid&quot;</span><span class="s2">:      (   </span><span class="s3">&quot;vertical&quot;</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, (   </span><span class="s5">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">), </span><span class="s5">180</span><span class="s2">, {</span><span class="s3">&quot;bottom&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">, </span><span class="s3">&quot;center_x&quot;</span><span class="s2">: </span><span class="s5">0.50</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;top_right&quot;</span><span class="s2">:    (   </span><span class="s3">&quot;vertical&quot;</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, (   </span><span class="s5">1</span><span class="s2">, </span><span class="s4">None</span><span class="s2">), </span><span class="s5">180</span><span class="s2">, {</span><span class="s3">&quot;bottom&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">,    </span><span class="s3">&quot;right&quot;</span><span class="s2">: </span><span class="s5">0.95</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;left_bottom&quot;</span><span class="s2">:  ( </span><span class="s3">&quot;horizontal&quot;</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, (</span><span class="s4">None</span><span class="s2">,    </span><span class="s5">1</span><span class="s2">), -</span><span class="s5">90</span><span class="s2">, {</span><span class="s3">&quot;right&quot;</span><span class="s2">:  </span><span class="s5">1.0</span><span class="s2">,        </span><span class="s3">&quot;y&quot;</span><span class="s2">: </span><span class="s5">0.05</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;left_mid&quot;</span><span class="s2">:     ( </span><span class="s3">&quot;horizontal&quot;</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, (</span><span class="s4">None</span><span class="s2">,    </span><span class="s5">1</span><span class="s2">), -</span><span class="s5">90</span><span class="s2">, {</span><span class="s3">&quot;right&quot;</span><span class="s2">:  </span><span class="s5">1.0</span><span class="s2">, </span><span class="s3">&quot;center_y&quot;</span><span class="s2">: </span><span class="s5">0.50</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
        <span class="s3">&quot;left_top&quot;</span><span class="s2">:     ( </span><span class="s3">&quot;horizontal&quot;</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, (</span><span class="s4">None</span><span class="s2">,    </span><span class="s5">1</span><span class="s2">), -</span><span class="s5">90</span><span class="s2">, {</span><span class="s3">&quot;right&quot;</span><span class="s2">:  </span><span class="s5">1.0</span><span class="s2">,      </span><span class="s3">&quot;top&quot;</span><span class="s2">: </span><span class="s5">0.95</span><span class="s2">}),  </span><span class="s6"># noqa: E201,E241,E501</span>
    <span class="s2">}</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_flex_arrow_layout_params </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_temporarily_ignore_limits </span><span class="s2">= </span><span class="s4">False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">(</span>
            <span class="s1">source</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_image</span><span class="s2">,</span>
            <span class="s1">fit_mode</span><span class="s2">=</span><span class="s3">&quot;scale-down&quot;</span><span class="s2">,</span>
            <span class="s1">color</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_color</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">texture_size</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">dp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">texture_size</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter </span><span class="s2">= </span><span class="s1">Scatter</span><span class="s2">(</span>
            <span class="s1">size_hint</span><span class="s2">=(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),</span>
            <span class="s1">do_scale</span><span class="s2">=</span><span class="s4">False</span><span class="s2">,</span>
            <span class="s1">do_rotation</span><span class="s2">=</span><span class="s4">False</span><span class="s2">,</span>
            <span class="s1">do_translation</span><span class="s2">=</span><span class="s4">False</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">texture_size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter_wrapper </span><span class="s2">= </span><span class="s1">BoxLayout</span><span class="s2">(</span>
            <span class="s1">size_hint</span><span class="s2">=(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter_wrapper</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_layout </span><span class="s2">= </span><span class="s1">RelativeLayout</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_layout</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter_wrapper</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_layout </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reposition_inner_widgets</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">content </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s1">widget</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">content_size </span><span class="s2">= </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">size</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">update_content_size</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reposition_inner_widgets</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">BubbleException</span><span class="s2">(</span>
                <span class="s3">&quot;Bubble can only contain a single Widget or Layout&quot;</span>
            <span class="s2">)</span>

    <span class="s4">def </span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">widget </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">content</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">unbind</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">update_content_size</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">content </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">content_size </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">reposition_inner_widgets</span><span class="s2">()</span>
            <span class="s4">return</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_content_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">adjust_position</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_limit_to</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">adjust_position</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_pos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">adjust_position</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reposition_inner_widgets</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_arrow_image</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">source </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_image</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">texture_size</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">dp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">texture_size</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">texture_size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reposition_inner_widgets</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_arrow_color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_color</span>

    <span class="s4">def </span><span class="s1">on_arrow_pos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reposition_inner_widgets</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_flex_arrow_pos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_flex_arrow_layout_params </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flex_arrow_layout_params</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reposition_inner_widgets</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">get_flex_arrow_layout_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flex_arrow_pos</span>

        <span class="s4">if </span><span class="s1">pos </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">return None</span>

        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">pos</span>
        <span class="s4">if not </span><span class="s2">(</span><span class="s5">0 </span><span class="s2">&lt;= </span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s4">and </span><span class="s5">0 </span><span class="s2">&lt;= </span><span class="s1">y </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">):</span>
            <span class="s4">return None</span>

        <span class="s6"># the order of the following list defines the side that the arrow</span>
        <span class="s6"># will be attached to in case of ambiguity (same distances)</span>
        <span class="s1">base_layouts_map </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s3">&quot;bottom_mid&quot;</span><span class="s2">, </span><span class="s1">y</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;top_mid&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">y</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;left_mid&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;right_mid&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">- </span><span class="s1">x</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s1">base_layout_key </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">base_layouts_map</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">lambda </span><span class="s1">val</span><span class="s2">: </span><span class="s1">val</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">arrow_layout </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">Bubble</span><span class="s2">.</span><span class="s1">ARROW_LAYOUTS</span><span class="s2">[</span><span class="s1">base_layout_key</span><span class="s2">])</span>

        <span class="s1">arrow_width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image</span><span class="s2">.</span><span class="s1">width</span>

        <span class="s6"># This function calculates the proper value for pos_hint, i.e., the</span>
        <span class="s6"># arrow texture does not 'overflow' and stays entirely connected to</span>
        <span class="s6"># the side of the content.</span>
        <span class="s4">def </span><span class="s1">calc_x0</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
            <span class="s4">return </span><span class="s1">x </span><span class="s2">* (</span><span class="s1">length </span><span class="s2">- </span><span class="s1">arrow_width</span><span class="s2">) / (</span><span class="s1">length </span><span class="s2">* </span><span class="s1">length</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">base_layout_key </span><span class="s2">== </span><span class="s3">&quot;bottom_mid&quot;</span><span class="s2">:</span>
            <span class="s1">arrow_layout</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = {</span><span class="s3">&quot;top&quot;</span><span class="s2">: </span><span class="s5">1.0</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">: </span><span class="s1">calc_x0</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)}</span>
        <span class="s4">elif </span><span class="s1">base_layout_key </span><span class="s2">== </span><span class="s3">&quot;top_mid&quot;</span><span class="s2">:</span>
            <span class="s1">arrow_layout</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = {</span><span class="s3">&quot;bottom&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">: </span><span class="s1">calc_x0</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)}</span>
        <span class="s4">elif </span><span class="s1">base_layout_key </span><span class="s2">== </span><span class="s3">&quot;left_mid&quot;</span><span class="s2">:</span>
            <span class="s1">arrow_layout</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = {</span><span class="s3">&quot;right&quot;</span><span class="s2">: </span><span class="s5">1.0</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">: </span><span class="s1">calc_x0</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">)}</span>
        <span class="s4">elif </span><span class="s1">base_layout_key </span><span class="s2">== </span><span class="s3">&quot;right_mid&quot;</span><span class="s2">:</span>
            <span class="s1">arrow_layout</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = {</span><span class="s3">&quot;left&quot;</span><span class="s2">: </span><span class="s5">0.0</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">: </span><span class="s1">calc_x0</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">)}</span>
        <span class="s4">return </span><span class="s1">arrow_layout</span>

    <span class="s4">def </span><span class="s1">update_content_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">content_size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">size</span>

    <span class="s4">def </span><span class="s1">adjust_position</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_to </span><span class="s4">is not None and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_temporarily_ignore_limits</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_to </span><span class="s4">is </span><span class="s1">EventLoop</span><span class="s2">.</span><span class="s1">window</span><span class="s2">:</span>
                <span class="s1">lim_x</span><span class="s2">, </span><span class="s1">lim_y </span><span class="s2">= </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span>
                <span class="s1">lim_top</span><span class="s2">, </span><span class="s1">lim_right </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_to</span><span class="s2">.</span><span class="s1">size</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">lim_x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_to</span><span class="s2">.</span><span class="s1">x</span>
                <span class="s1">lim_y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_to</span><span class="s2">.</span><span class="s1">y</span>
                <span class="s1">lim_top </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_to</span><span class="s2">.</span><span class="s1">top</span>
                <span class="s1">lim_right </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_to</span><span class="s2">.</span><span class="s1">right</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_temporarily_ignore_limits </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s4">if not </span><span class="s2">(</span><span class="s1">lim_x </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s4">and </span><span class="s1">lim_right </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">right</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">lim_x</span><span class="s2">, </span><span class="s1">min</span><span class="s2">(</span><span class="s1">lim_right </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">))</span>

            <span class="s4">if not </span><span class="s2">(</span><span class="s1">lim_y </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s4">and </span><span class="s1">lim_right </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">right</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">lim_top </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s1">lim_y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">))</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_temporarily_ignore_limits </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">def </span><span class="s1">reposition_inner_widgets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arrow_image_layout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_layout</span>
        <span class="s1">arrow_image_scatter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter</span>
        <span class="s1">arrow_image_scatter_wrapper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_arrow_image_scatter_wrapper</span>
        <span class="s1">content </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">content</span>

        <span class="s6"># Remove the children of the Bubble (BoxLayout) as a first step</span>
        <span class="s4">for </span><span class="s1">child </span><span class="s4">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">().</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">child</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas </span><span class="s4">is None or </span><span class="s1">content </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s6"># find the layout parameters that define a specific bubble setup</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_flex_arrow_layout_params </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">layout_params </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_flex_arrow_layout_params</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">layout_params </span><span class="s2">= </span><span class="s1">Bubble</span><span class="s2">.</span><span class="s1">ARROW_LAYOUTS</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_pos</span><span class="s2">]</span>
        <span class="s2">(</span><span class="s1">bubble_orientation</span><span class="s2">,</span>
         <span class="s1">widget_order</span><span class="s2">,</span>
         <span class="s1">arrow_size_hint</span><span class="s2">,</span>
         <span class="s1">arrow_rotation</span><span class="s2">,</span>
         <span class="s1">arrow_pos_hint</span><span class="s2">) = </span><span class="s1">layout_params</span>

        <span class="s6"># rotate the arrow, place it at the right pos and setup the size</span>
        <span class="s6"># of the widget, so the BoxLayout can do the rest.</span>
        <span class="s1">arrow_image_scatter</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= </span><span class="s1">arrow_rotation</span>
        <span class="s1">arrow_image_scatter_wrapper</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">arrow_image_scatter</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">arrow_image_scatter_wrapper</span><span class="s2">.</span><span class="s1">pos_hint </span><span class="s2">= </span><span class="s1">arrow_pos_hint</span>
        <span class="s1">arrow_image_layout</span><span class="s2">.</span><span class="s1">size_hint </span><span class="s2">= </span><span class="s1">arrow_size_hint</span>
        <span class="s1">arrow_image_layout</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= </span><span class="s1">arrow_image_scatter</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>

        <span class="s6"># set the orientation of the Bubble (BoxLayout)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">orientation </span><span class="s2">= </span><span class="s1">bubble_orientation</span>

        <span class="s6"># Add the updated children of the Bubble (BoxLayout) and update</span>
        <span class="s6"># properties</span>
        <span class="s1">widgets_to_add </span><span class="s2">= [</span><span class="s1">content</span><span class="s2">, </span><span class="s1">arrow_image_layout</span><span class="s2">]</span>

        <span class="s6"># Set the arrow_margin, so we can use this property for proper sizing</span>
        <span class="s6"># of the Bubble Widget.</span>
        <span class="s6"># Determine whether to add the arrow_image_layout to the</span>
        <span class="s6"># Bubble (BoxLayout) or not.</span>
        <span class="s1">arrow_margin_x</span><span class="s2">, </span><span class="s1">arrow_margin_y </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">show_arrow</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">bubble_orientation</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s3">&quot;h&quot;</span><span class="s2">:</span>
                <span class="s1">arrow_margin_x </span><span class="s2">= </span><span class="s1">arrow_image_layout</span><span class="s2">.</span><span class="s1">width</span>
            <span class="s4">elif </span><span class="s1">bubble_orientation</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s3">&quot;v&quot;</span><span class="s2">:</span>
                <span class="s1">arrow_margin_y </span><span class="s2">= </span><span class="s1">arrow_image_layout</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">widgets_to_add</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

        <span class="s4">for </span><span class="s1">widget </span><span class="s4">in </span><span class="s1">widgets_to_add</span><span class="s2">[::</span><span class="s1">widget_order</span><span class="s2">]:</span>
            <span class="s1">super</span><span class="s2">().</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">arrow_margin </span><span class="s2">= (</span><span class="s1">arrow_margin_x</span><span class="s2">, </span><span class="s1">arrow_margin_y</span><span class="s2">)</span>
</pre>
</body>
</html>