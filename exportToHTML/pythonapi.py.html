<html>
<head>
<title>pythonapi.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pythonapi.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">namedtuple</span>
<span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">pickle</span>
<span class="s0">import </span><span class="s1">hashlib</span>
<span class="s0">import </span><span class="s1">sys</span>

<span class="s0">from </span><span class="s1">llvmlite </span><span class="s0">import </span><span class="s1">ir</span>
<span class="s0">from </span><span class="s1">llvmlite</span><span class="s2">.</span><span class="s1">ir </span><span class="s0">import </span><span class="s1">Constant</span>

<span class="s0">import </span><span class="s1">ctypes</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">_helperlib</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">types</span><span class="s2">, </span><span class="s1">utils</span><span class="s2">, </span><span class="s1">config</span><span class="s2">, </span><span class="s1">lowering</span><span class="s2">, </span><span class="s1">cgutils</span><span class="s2">, </span><span class="s1">imputils</span><span class="s2">, </span><span class="s1">serialize</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">PYVERSION</span>

<span class="s1">PY_UNICODE_1BYTE_KIND </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_unicode_1byte_kind</span>
<span class="s1">PY_UNICODE_2BYTE_KIND </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_unicode_2byte_kind</span>
<span class="s1">PY_UNICODE_4BYTE_KIND </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_unicode_4byte_kind</span>
<span class="s0">if </span><span class="s1">PYVERSION </span><span class="s0">in </span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">9</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">10</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)):</span>
    <span class="s1">PY_UNICODE_WCHAR_KIND </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_unicode_wchar_kind</span>


<span class="s0">class </span><span class="s1">_Registry</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">functions </span><span class="s2">= {}</span>

    <span class="s0">def </span><span class="s1">register</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typeclass</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">typeclass</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Type</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">func</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">typeclass </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">functions</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s4">&quot;duplicate registration for %s&quot; </span><span class="s2">% (</span><span class="s1">typeclass</span><span class="s2">,))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">functions</span><span class="s2">[</span><span class="s1">typeclass</span><span class="s2">] = </span><span class="s1">func</span>
            <span class="s0">return </span><span class="s1">func</span>
        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typeclass</span><span class="s2">, </span><span class="s1">default</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">typeclass</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Type</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">cls </span><span class="s0">in </span><span class="s1">typeclass</span><span class="s2">.</span><span class="s1">__mro__</span><span class="s2">:</span>
            <span class="s1">func </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">functions</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">func </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">func</span>
        <span class="s0">return </span><span class="s1">default</span>

<span class="s5"># Registries of boxing / unboxing implementations</span>
<span class="s1">_boxers </span><span class="s2">= </span><span class="s1">_Registry</span><span class="s2">()</span>
<span class="s1">_unboxers </span><span class="s2">= </span><span class="s1">_Registry</span><span class="s2">()</span>
<span class="s1">_reflectors </span><span class="s2">= </span><span class="s1">_Registry</span><span class="s2">()</span>

<span class="s1">box </span><span class="s2">= </span><span class="s1">_boxers</span><span class="s2">.</span><span class="s1">register</span>
<span class="s1">unbox </span><span class="s2">= </span><span class="s1">_unboxers</span><span class="s2">.</span><span class="s1">register</span>
<span class="s1">reflect </span><span class="s2">= </span><span class="s1">_reflectors</span><span class="s2">.</span><span class="s1">register</span>

<span class="s0">class </span><span class="s1">_BoxContext</span><span class="s2">(</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s4">&quot;_BoxContext&quot;</span><span class="s2">,</span>
                  <span class="s2">(</span><span class="s4">&quot;context&quot;</span><span class="s2">, </span><span class="s4">&quot;builder&quot;</span><span class="s2">, </span><span class="s4">&quot;pyapi&quot;</span><span class="s2">, </span><span class="s4">&quot;env_manager&quot;</span><span class="s2">))):</span>
    <span class="s6">&quot;&quot;&quot; 
    The facilities required by boxing implementations. 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s2">= ()</span>

    <span class="s0">def </span><span class="s1">box</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">from_native_value</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_UnboxContext</span><span class="s2">(</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s4">&quot;_UnboxContext&quot;</span><span class="s2">,</span>
                    <span class="s2">(</span><span class="s4">&quot;context&quot;</span><span class="s2">, </span><span class="s4">&quot;builder&quot;</span><span class="s2">, </span><span class="s4">&quot;pyapi&quot;</span><span class="s2">))):</span>
    <span class="s6">&quot;&quot;&quot; 
    The facilities required by unboxing implementations. 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s2">= ()</span>

    <span class="s0">def </span><span class="s1">unbox</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">to_native_value</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_ReflectContext</span><span class="s2">(</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s4">&quot;_ReflectContext&quot;</span><span class="s2">,</span>
                      <span class="s2">(</span><span class="s4">&quot;context&quot;</span><span class="s2">, </span><span class="s4">&quot;builder&quot;</span><span class="s2">, </span><span class="s4">&quot;pyapi&quot;</span><span class="s2">, </span><span class="s4">&quot;env_manager&quot;</span><span class="s2">,</span>
                       <span class="s4">&quot;is_error&quot;</span><span class="s2">))):</span>
    <span class="s6">&quot;&quot;&quot; 
    The facilities required by reflection implementations. 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s2">= ()</span>

    <span class="s5"># XXX the error bit is currently unused by consumers (e.g. PyCallWrapper)</span>
    <span class="s0">def </span><span class="s1">set_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_error</span><span class="s2">, </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">true_bit</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">box</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">from_native_value</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">reflect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">reflect_native_value</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env_manager</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">NativeValue</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Encapsulate the result of converting a Python object to a native value, 
    recording whether the conversion was successful and how to cleanup. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">is_error</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">cleanup</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_error </span><span class="s2">= </span><span class="s1">is_error </span><span class="s0">if </span><span class="s1">is_error </span><span class="s0">is not None else </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">false_bit</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cleanup </span><span class="s2">= </span><span class="s1">cleanup</span>


<span class="s0">class </span><span class="s1">EnvironmentManager</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyapi</span><span class="s2">, </span><span class="s1">env</span><span class="s2">, </span><span class="s1">env_body</span><span class="s2">, </span><span class="s1">env_ptr</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">env</span><span class="s2">, </span><span class="s1">lowering</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi </span><span class="s2">= </span><span class="s1">pyapi</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">env </span><span class="s2">= </span><span class="s1">env</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">env_body </span><span class="s2">= </span><span class="s1">env_body</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">env_ptr </span><span class="s2">= </span><span class="s1">env_ptr</span>

    <span class="s0">def </span><span class="s1">add_const</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">const</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Add a constant to the environment, return its index. 
        &quot;&quot;&quot;</span>
        <span class="s5"># All constants are frozen inside the environment</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">const</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">const </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">intern</span><span class="s2">(</span><span class="s1">const</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">.</span><span class="s1">consts</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">val </span><span class="s0">is </span><span class="s1">const</span><span class="s2">:</span>
                <span class="s0">break</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">.</span><span class="s1">consts</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">.</span><span class="s1">consts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">const</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">index</span>

    <span class="s0">def </span><span class="s1">read_const</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Look up constant number *index* inside the environment body. 
        A borrowed reference is returned. 
 
        The returned LLVM value may have NULL value at runtime which indicates 
        an error at runtime. 
        &quot;&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">env</span><span class="s2">.</span><span class="s1">consts</span><span class="s2">)</span>

        <span class="s1">builder </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">builder</span>
        <span class="s1">consts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">env_body</span><span class="s2">.</span><span class="s1">consts</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">zfill</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_else</span><span class="s2">(</span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_not_null</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">consts</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">\</span>
                <span class="s2">(</span><span class="s1">br_not_null</span><span class="s2">, </span><span class="s1">br_null</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">br_not_null</span><span class="s2">:</span>
                <span class="s1">getitem </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">list_getitem</span><span class="s2">(</span><span class="s1">consts</span><span class="s2">, </span><span class="s1">index</span><span class="s2">)</span>
                <span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">getitem</span><span class="s2">, </span><span class="s1">ret</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">br_null</span><span class="s2">:</span>
                <span class="s5"># This can happen when the Environment is accidentally released</span>
                <span class="s5"># and has subsequently been garbage collected.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">err_set_string</span><span class="s2">(</span>
                    <span class="s4">&quot;PyExc_RuntimeError&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;`env.consts` is NULL in `read_const`&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>


<span class="s1">_IteratorLoop </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s4">'_IteratorLoop'</span><span class="s2">, (</span><span class="s4">'value'</span><span class="s2">, </span><span class="s4">'do_break'</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">PythonAPI</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Code generation facilities to call into the CPython C API (and related 
    helpers). 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Note: Maybe called multiple times when lowering a function 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">context</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder </span><span class="s2">= </span><span class="s1">builder</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">module </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">basic_block</span><span class="s2">.</span><span class="s1">function</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s5"># A unique mapping of serialized objects in this module</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">__serialized</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">__serialized </span><span class="s2">= {}</span>

        <span class="s5"># Initialize types</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_argument_type</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">pyobject</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pyobjptr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">8</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">long </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">ctypes</span><span class="s2">.</span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">ctypes</span><span class="s2">.</span><span class="s1">c_long</span><span class="s2">) * </span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ulong </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">longlong </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">ctypes</span><span class="s2">.</span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">ctypes</span><span class="s2">.</span><span class="s1">c_ulonglong</span><span class="s2">) * </span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ulonglong </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">longlong</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">double </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cstring </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">8</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">gil_state </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_gil_state_size </span><span class="s2">* </span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">py_buffer_t </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">ArrayType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">8</span><span class="s2">), </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_buffer_size</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">py_hash_t </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">py_unicode_1byte_kind </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_unicode_1byte_kind</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">py_unicode_2byte_kind </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_unicode_2byte_kind</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">py_unicode_4byte_kind </span><span class="s2">= </span><span class="s1">_helperlib</span><span class="s2">.</span><span class="s1">py_unicode_4byte_kind</span>

    <span class="s0">def </span><span class="s1">get_env_manager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">env</span><span class="s2">, </span><span class="s1">env_body</span><span class="s2">, </span><span class="s1">env_ptr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">EnvironmentManager</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">env</span><span class="s2">, </span><span class="s1">env_body</span><span class="s2">, </span><span class="s1">env_ptr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">emit_environment_sentry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">envptr</span><span class="s2">, </span><span class="s1">return_pyobject</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                                <span class="s1">debug_msg</span><span class="s2">=</span><span class="s4">''</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Emits LLVM code to ensure the `envptr` is not NULL 
        &quot;&quot;&quot;</span>
        <span class="s1">is_null </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">envptr</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">if_unlikely</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">is_null</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">return_pyobject</span><span class="s2">:</span>
                <span class="s1">fnty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">function</span><span class="s2">.</span><span class="s1">type</span><span class="s2">.</span><span class="s1">pointee</span>
                <span class="s0">assert </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">return_type </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">err_set_string</span><span class="s2">(</span>
                    <span class="s4">&quot;PyExc_RuntimeError&quot;</span><span class="s2">, </span><span class="s4">f&quot;missing Environment: </span><span class="s0">{</span><span class="s1">debug_msg</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">ret</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">())</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">return_user_exc</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">RuntimeError</span><span class="s2">,</span>
                    <span class="s2">(</span><span class="s4">f&quot;missing Environment: </span><span class="s0">{</span><span class="s1">debug_msg</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,),</span>
                <span class="s2">)</span>

    <span class="s5"># ------ Python API -----</span>

    <span class="s5">#</span>
    <span class="s5"># Basic object API</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">incref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;Py_IncRef&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">decref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;Py_DecRef&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">get_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_py_type&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s5">#</span>
    <span class="s5"># Argument unpacking</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">parse_tuple_and_keywords</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">keywords</span><span class="s2">, *</span><span class="s1">objs</span><span class="s2">):</span>
        <span class="s1">charptr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">8</span><span class="s2">))</span>
        <span class="s1">charptrary </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">charptr</span><span class="s2">)</span>
        <span class="s1">argtypes </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">charptr</span><span class="s2">, </span><span class="s1">charptrary</span><span class="s2">]</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">argtypes</span><span class="s2">, </span><span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyArg_ParseTupleAndKeywords&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">args</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">keywords</span><span class="s2">] + </span><span class="s1">list</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">parse_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, *</span><span class="s1">objs</span><span class="s2">):</span>
        <span class="s1">charptr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">8</span><span class="s2">))</span>
        <span class="s1">argtypes </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">charptr</span><span class="s2">]</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">argtypes</span><span class="s2">, </span><span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyArg_ParseTuple&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">args</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">] + </span><span class="s1">list</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">unpack_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">n_min</span><span class="s2">, </span><span class="s1">n_max</span><span class="s2">, *</span><span class="s1">objs</span><span class="s2">):</span>
        <span class="s1">charptr </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">8</span><span class="s2">))</span>
        <span class="s1">argtypes </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">charptr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">]</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">argtypes</span><span class="s2">, </span><span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyArg_UnpackTuple&quot;</span><span class="s2">)</span>
        <span class="s1">n_min </span><span class="s2">= </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">n_min</span><span class="s2">))</span>
        <span class="s1">n_max </span><span class="s2">= </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">n_max</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">args</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">n_min</span><span class="s2">, </span><span class="s1">n_max</span><span class="s2">] + </span><span class="s1">list</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">))</span>

    <span class="s5">#</span>
    <span class="s5"># Exception and errors</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">err_occurred</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, ())</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_Occurred&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">err_clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), ())</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_Clear&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, ())</span>

    <span class="s0">def </span><span class="s1">err_set_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_SetString&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">exctype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_c_object</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">err_format</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, *</span><span class="s1">format_args</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">], </span><span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_Format&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">exctype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_c_object</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">) + </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">format_args</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">raise_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Raise an arbitrary exception (type or value or (type, args) 
        or None - if reraising).  A reference to the argument is consumed. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_do_raise&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">exc </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">exc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_none</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">exc</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">err_set_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">excval</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_SetObject&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">exctype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_c_object</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">excval</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">err_set_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exctype</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_SetNone&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">exctype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_c_object</span><span class="s2">(</span><span class="s1">exctype</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">exctype</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">err_write_unraisable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_WriteUnraisable&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">err_fetch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pty</span><span class="s2">, </span><span class="s1">pval</span><span class="s2">, </span><span class="s1">ptb</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobjptr</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_Fetch&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">pty</span><span class="s2">, </span><span class="s1">pval</span><span class="s2">, </span><span class="s1">ptb</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">err_restore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyErr_Restore&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">err_push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">keep_new</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Temporarily push the current error indicator while the code 
        block is executed.  If *keep_new* is True and the code block 
        raises a new error, the new error is kept, otherwise the old 
        error indicator is restored at the end of the block. 
        &quot;&quot;&quot;</span>
        <span class="s1">pty</span><span class="s2">, </span><span class="s1">pval</span><span class="s2">, </span><span class="s1">ptb </span><span class="s2">= [</span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">)</span>
                          <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">err_fetch</span><span class="s2">(</span><span class="s1">pty</span><span class="s2">, </span><span class="s1">pval</span><span class="s2">, </span><span class="s1">ptb</span><span class="s2">)</span>
        <span class="s0">yield</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">pty</span><span class="s2">)</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">pval</span><span class="s2">)</span>
        <span class="s1">tb </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">ptb</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">keep_new</span><span class="s2">:</span>
            <span class="s1">new_error </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_not_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">err_occurred</span><span class="s2">())</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_else</span><span class="s2">(</span><span class="s1">new_error</span><span class="s2">, </span><span class="s1">likely</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">as </span><span class="s2">(</span><span class="s1">if_error</span><span class="s2">, </span><span class="s1">if_ok</span><span class="s2">):</span>
                <span class="s0">with </span><span class="s1">if_error</span><span class="s2">:</span>
                    <span class="s5"># Code block raised an error, keep it</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">tb</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">if_ok</span><span class="s2">:</span>
                    <span class="s5"># Restore previous error</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">err_restore</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">err_restore</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_c_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get a Python object through its C-accessible *name* 
        (e.g. &quot;PyExc_ValueError&quot;).  The underlying variable must be 
        a `PyObject *`, and the value of that pointer is returned. 
        &quot;&quot;&quot;</span>
        <span class="s5"># A LLVM global variable is implicitly a pointer to the declared</span>
        <span class="s5"># type, so fix up by using pyobj.pointee.</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_c_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">.</span><span class="s1">pointee</span><span class="s2">, </span><span class="s1">name</span><span class="s2">,</span>
                                        <span class="s1">dllimport</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">raise_missing_global_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;global name '%s' is not defined&quot; </span><span class="s2">% </span><span class="s1">name</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">err_set_string</span><span class="s2">(</span><span class="s4">&quot;PyExc_NameError&quot;</span><span class="s2">, </span><span class="s1">cstr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">raise_missing_name_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;name '%s' is not defined&quot; </span><span class="s2">% </span><span class="s1">name</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">err_set_string</span><span class="s2">(</span><span class="s4">&quot;PyExc_NameError&quot;</span><span class="s2">, </span><span class="s1">cstr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">fatal_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;Py_FatalError&quot;</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;noreturn&quot;</span><span class="s2">)</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">cstr</span><span class="s2">,))</span>

    <span class="s5">#</span>
    <span class="s5"># Concrete dict API</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">dict_getitem_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dic</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Lookup name inside dict 
 
        Returns a borrowed reference 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyDict_GetItemString&quot;</span><span class="s2">)</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">dic</span><span class="s2">, </span><span class="s1">cstr</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">dict_getitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dic</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Lookup name inside dict 
 
        Returns a borrowed reference 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyDict_GetItem&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">dic</span><span class="s2">, </span><span class="s1">name</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">dict_new</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">presize</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">presize </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, ())</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyDict_New&quot;</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, ())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;_PyDict_NewPresized&quot;</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">,</span>
                                     <span class="s2">[</span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">presize</span><span class="s2">))])</span>

    <span class="s0">def </span><span class="s1">dict_setitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dictobj</span><span class="s2">, </span><span class="s1">nameobj</span><span class="s2">, </span><span class="s1">valobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">))</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyDict_SetItem&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">dictobj</span><span class="s2">, </span><span class="s1">nameobj</span><span class="s2">, </span><span class="s1">valobj</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">dict_setitem_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dictobj</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">valobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">))</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyDict_SetItemString&quot;</span><span class="s2">)</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">dictobj</span><span class="s2">, </span><span class="s1">cstr</span><span class="s2">, </span><span class="s1">valobj</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">dict_pack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">keyvalues</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Args 
        ----- 
        keyvalues: iterable of (str, llvm.Value of PyObject*) 
        &quot;&quot;&quot;</span>
        <span class="s1">dictobj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dict_new</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">if_object_ok</span><span class="s2">(</span><span class="s1">dictobj</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">keyvalues</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">dict_setitem_string</span><span class="s2">(</span><span class="s1">dictobj</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">dictobj</span>

    <span class="s5">#</span>
    <span class="s5"># Concrete number APIs</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">float_from_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fval</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">double</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyFloat_FromDouble&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">fval</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">number_as_ssize_t</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">numobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyNumber_AsSsize_t&quot;</span><span class="s2">)</span>
        <span class="s5"># We don't want any clipping, so pass OverflowError as the 2nd arg</span>
        <span class="s1">exc_class </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_c_object</span><span class="s2">(</span><span class="s4">&quot;PyExc_OverflowError&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">numobj</span><span class="s2">, </span><span class="s1">exc_class</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">number_long</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">numobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyNumber_Long&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">numobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">long_as_ulonglong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">numobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyLong_AsUnsignedLongLong&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">numobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">long_as_longlong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">numobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyLong_AsLongLong&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">numobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">long_as_voidptr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">numobj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Convert the given Python integer to a void*.  This is recommended 
        over number_as_ssize_t as it isn't affected by signedness. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyLong_AsVoidPtr&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">numobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">_long_from_native_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">, </span><span class="s1">func_name</span><span class="s2">, </span><span class="s1">native_int_type</span><span class="s2">,</span>
                              <span class="s1">signed</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">native_int_type</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">func_name</span><span class="s2">)</span>
        <span class="s1">resptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">func_name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">ival</span><span class="s2">]), </span><span class="s1">resptr</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">resptr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">long_from_long</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s1">func_name </span><span class="s2">= </span><span class="s4">&quot;PyLong_FromLong&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">long</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">func_name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">ival</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">long_from_ulong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_long_from_native_int</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s4">&quot;PyLong_FromUnsignedLong&quot;</span><span class="s2">,</span>
                                          <span class="s1">self</span><span class="s2">.</span><span class="s1">long</span><span class="s2">, </span><span class="s1">signed</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">long_from_ssize_t</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_long_from_native_int</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s4">&quot;PyLong_FromSsize_t&quot;</span><span class="s2">,</span>
                                          <span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s1">signed</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">long_from_longlong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_long_from_native_int</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s4">&quot;PyLong_FromLongLong&quot;</span><span class="s2">,</span>
                                          <span class="s1">self</span><span class="s2">.</span><span class="s1">longlong</span><span class="s2">, </span><span class="s1">signed</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">long_from_ulonglong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_long_from_native_int</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s4">&quot;PyLong_FromUnsignedLongLong&quot;</span><span class="s2">,</span>
                                          <span class="s1">self</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">, </span><span class="s1">signed</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">long_from_signed_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a Python integer from any native integer value. 
        &quot;&quot;&quot;</span>
        <span class="s1">bits </span><span class="s2">= </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">type</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s0">if </span><span class="s1">bits </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long</span><span class="s2">.</span><span class="s1">width</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long_from_long</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">sext</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">bits </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">longlong</span><span class="s2">.</span><span class="s1">width</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long_from_longlong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">sext</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">longlong</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">OverflowError</span><span class="s2">(</span><span class="s4">&quot;integer too big (%d bits)&quot; </span><span class="s2">% (</span><span class="s1">bits</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">long_from_unsigned_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Same as long_from_signed_int, but for unsigned values. 
        &quot;&quot;&quot;</span>
        <span class="s1">bits </span><span class="s2">= </span><span class="s1">ival</span><span class="s2">.</span><span class="s1">type</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s0">if </span><span class="s1">bits </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ulong</span><span class="s2">.</span><span class="s1">width</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long_from_ulong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">zext</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ulong</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">bits </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">.</span><span class="s1">width</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long_from_ulonglong</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">zext</span><span class="s2">(</span><span class="s1">ival</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ulonglong</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">OverflowError</span><span class="s2">(</span><span class="s4">&quot;integer too big (%d bits)&quot; </span><span class="s2">% (</span><span class="s1">bits</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_get_number_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyNumber_%s&quot; </span><span class="s2">% </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">fn</span>

    <span class="s0">def </span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">inplace</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s4">&quot;InPlace&quot; </span><span class="s2">+ </span><span class="s1">name</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_number_operator</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">number_add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Add&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_subtract</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Subtract&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_multiply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Multiply&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_truedivide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;TrueDivide&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_floordivide</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;FloorDivide&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_remainder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Remainder&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_matrix_multiply</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;MatrixMultiply&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_lshift</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Lshift&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_rshift</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Rshift&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_and</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;And&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_or</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Or&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_xor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_call_number_operator</span><span class="s2">(</span><span class="s4">&quot;Xor&quot;</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s1">inplace</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">number_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyNumber_InPlacePower&quot; </span><span class="s0">if </span><span class="s1">inplace </span><span class="s0">else </span><span class="s4">&quot;PyNumber_Power&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">borrow_none</span><span class="s2">()])</span>

    <span class="s0">def </span><span class="s1">number_negative</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyNumber_Negative&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">number_positive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyNumber_Positive&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">number_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyNumber_Float&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">number_invert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyNumber_Invert&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">float_as_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">double</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyFloat_AsDouble&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">fobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">bool_from_bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bval</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get a Python bool from a LLVM boolean. 
        &quot;&quot;&quot;</span>
        <span class="s1">longval </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">zext</span><span class="s2">(</span><span class="s1">bval</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">long</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bool_from_long</span><span class="s2">(</span><span class="s1">longval</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bool_from_long</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ival</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">long</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyBool_FromLong&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">ival</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">complex_from_doubles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">realval</span><span class="s2">, </span><span class="s1">imagval</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">()])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyComplex_FromDoubles&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">realval</span><span class="s2">, </span><span class="s1">imagval</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">complex_real_as_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyComplex_RealAsDouble&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">cobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">complex_imag_as_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyComplex_ImagAsDouble&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">cobj</span><span class="s2">])</span>

    <span class="s5">#</span>
    <span class="s5"># Concrete slice API</span>
    <span class="s5">#</span>
    <span class="s0">def </span><span class="s1">slice_as_ints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Read the members of a slice of integers. 
 
        Returns a (ok, start, stop, step) tuple where ok is a boolean and 
        the following members are pointer-sized ints. 
        &quot;&quot;&quot;</span>
        <span class="s1">pstart </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">)</span>
        <span class="s1">pstop </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">)</span>
        <span class="s1">pstep </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">),</span>
                               <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">] + [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">()] * </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_unpack_slice&quot;</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">pstart</span><span class="s2">, </span><span class="s1">pstop</span><span class="s2">, </span><span class="s1">pstep</span><span class="s2">))</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">pstart</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">pstop</span><span class="s2">)</span>
        <span class="s1">step </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">pstep</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res</span><span class="s2">), </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">step</span>

    <span class="s5">#</span>
    <span class="s5"># List and sequence APIs</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">sequence_getslice</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">,</span>
                                            <span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySequence_GetSlice&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">sequence_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySequence_Tuple&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">sequence_concat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj1</span><span class="s2">, </span><span class="s1">obj2</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySequence_Concat&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj1</span><span class="s2">, </span><span class="s1">obj2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">list_new</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">szval</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyList_New&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">szval</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">list_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyList_Size&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">lst</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">list_append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyList_Append&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">lst</span><span class="s2">, </span><span class="s1">val</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">list_setitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Warning: Steals reference to ``val`` 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyList_SetItem&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">lst</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">val</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">list_getitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Returns a borrowed reference. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyList_GetItem&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">idx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">lst</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">list_setslice</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">()</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyList_SetSlice&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">lst</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">))</span>


    <span class="s5">#</span>
    <span class="s5"># Concrete tuple API</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">tuple_getitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tup</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Borrow reference 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyTuple_GetItem&quot;</span><span class="s2">)</span>
        <span class="s1">idx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">tup</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">tuple_pack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">items</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">], </span><span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyTuple_Pack&quot;</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">items</span><span class="s2">))</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">n</span><span class="s2">]</span>
        <span class="s1">args</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">items</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">tuple_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tup</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyTuple_Size&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">tup</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">tuple_new</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">'PyTuple_New'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">,</span>
                                                                <span class="s1">count</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">tuple_setitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tuple_val</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Steals a reference to `item`. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">setitem_fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">'PyTuple_SetItem'</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">setitem_fn</span><span class="s2">, [</span><span class="s1">tuple_val</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">item</span><span class="s2">])</span>

    <span class="s5">#</span>
    <span class="s5"># Concrete set API</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">set_new</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">iterable</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">iterable </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">iterable </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">()</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySet_New&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">iterable</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">set_add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">set</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySet_Add&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">set</span><span class="s2">, </span><span class="s1">value</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">set_clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">set</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySet_Clear&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">set</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">set</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySet_Size&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">set</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">set_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">set</span><span class="s2">, </span><span class="s1">iterable</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;_PySet_Update&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">set</span><span class="s2">, </span><span class="s1">iterable</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">set_next_entry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">set</span><span class="s2">, </span><span class="s1">posptr</span><span class="s2">, </span><span class="s1">keyptr</span><span class="s2">, </span><span class="s1">hashptr</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">),</span>
                               <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">(),</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_hash_t</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">()])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;_PySet_NextEntry&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">set</span><span class="s2">, </span><span class="s1">posptr</span><span class="s2">, </span><span class="s1">keyptr</span><span class="s2">, </span><span class="s1">hashptr</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">set_iterate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">set</span><span class="s2">):</span>
        <span class="s1">builder </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span>

        <span class="s1">hashptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_hash_t</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;hashptr&quot;</span><span class="s2">)</span>
        <span class="s1">keyptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;keyptr&quot;</span><span class="s2">)</span>
        <span class="s1">posptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once_value</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">,</span>
                                           <span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s3">0</span><span class="s2">),</span>
                                           <span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;posptr&quot;</span><span class="s2">)</span>

        <span class="s1">bb_body </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">append_basic_block</span><span class="s2">(</span><span class="s4">&quot;bb_body&quot;</span><span class="s2">)</span>
        <span class="s1">bb_end </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">append_basic_block</span><span class="s2">(</span><span class="s4">&quot;bb_end&quot;</span><span class="s2">)</span>

        <span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">bb_body</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">do_break</span><span class="s2">():</span>
            <span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">bb_end</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">goto_block</span><span class="s2">(</span><span class="s1">bb_body</span><span class="s2">):</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">set_next_entry</span><span class="s2">(</span><span class="s1">set</span><span class="s2">, </span><span class="s1">posptr</span><span class="s2">, </span><span class="s1">keyptr</span><span class="s2">, </span><span class="s1">hashptr</span><span class="s2">)</span>
            <span class="s1">finished </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_then</span><span class="s2">(</span><span class="s1">finished</span><span class="s2">, </span><span class="s1">likely</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                <span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">bb_end</span><span class="s2">)</span>
            <span class="s0">yield </span><span class="s1">_IteratorLoop</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">keyptr</span><span class="s2">), </span><span class="s1">do_break</span><span class="s2">)</span>
            <span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">bb_body</span><span class="s2">)</span>

        <span class="s1">builder</span><span class="s2">.</span><span class="s1">position_at_end</span><span class="s2">(</span><span class="s1">bb_end</span><span class="s2">)</span>

    <span class="s5">#</span>
    <span class="s5"># GIL APIs</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">gil_ensure</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Ensure the GIL is acquired. 
        The returned value must be consumed by gil_release(). 
        &quot;&quot;&quot;</span>
        <span class="s1">gilptrty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">gil_state</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">gilptrty</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s4">&quot;numba_gil_ensure&quot;</span><span class="s2">)</span>
        <span class="s1">gilptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gil_state</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">gilptr</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">gilptr</span>

    <span class="s0">def </span><span class="s1">gil_release</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">gil</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Release the acquired GIL by gil_ensure(). 
        Must be paired with a gil_ensure(). 
        &quot;&quot;&quot;</span>
        <span class="s1">gilptrty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">gil_state</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">gilptrty</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s4">&quot;numba_gil_release&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">gil</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">save_thread</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Release the GIL and return the former thread state 
        (an opaque non-NULL pointer). 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">, [])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyEval_SaveThread&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [])</span>

    <span class="s0">def </span><span class="s1">restore_thread</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">thread_state</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Restore the given thread state by reacquiring the GIL. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyEval_RestoreThread&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">thread_state</span><span class="s2">])</span>

    <span class="s5">#</span>
    <span class="s5"># Generic object private data (a way of associating an arbitrary void *</span>
    <span class="s5"># pointer to an arbitrary Python object).</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">object_get_private_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_get_pyobject_private_data&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">object_set_private_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_set_pyobject_private_data&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">object_reset_private_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_reset_pyobject_private_data&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>


    <span class="s5">#</span>
    <span class="s5"># Other APIs (organize them better!)</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">import_module_noblock</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">modname</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyImport_ImportModuleNoBlock&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">modname</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">call_function_objargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">callee</span><span class="s2">, </span><span class="s1">objargs</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">], </span><span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_CallFunctionObjArgs&quot;</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">callee</span><span class="s2">] + </span><span class="s1">list</span><span class="s2">(</span><span class="s1">objargs</span><span class="s2">)</span>
        <span class="s1">args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_null</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">pyobject</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">call_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">callee</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">objargs</span><span class="s2">=()):</span>
        <span class="s1">cname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">],</span>
                             <span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_CallMethod&quot;</span><span class="s2">)</span>
        <span class="s1">fmt </span><span class="s2">= </span><span class="s4">'O' </span><span class="s2">* </span><span class="s1">len</span><span class="s2">(</span><span class="s1">objargs</span><span class="s2">)</span>
        <span class="s1">cfmt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">callee</span><span class="s2">, </span><span class="s1">cname</span><span class="s2">, </span><span class="s1">cfmt</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">objargs</span><span class="s2">:</span>
            <span class="s1">args</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">objargs</span><span class="s2">)</span>
        <span class="s1">args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant_null</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">pyobject</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">callee</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">args_was_none </span><span class="s2">:= </span><span class="s1">args </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tuple_new</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">kws </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">kws </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">()</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_Call&quot;</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">callee</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kws</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">args_was_none</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">object_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Emit a call to ``PyObject_Type(obj)`` to get the type of ``obj``. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_Type&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">object_istrue</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_IsTrue&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_not</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_Not&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_richcompare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">opstr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Refer to Python source Include/object.h for macros definition 
        of the opid. 
        &quot;&quot;&quot;</span>
        <span class="s1">ops </span><span class="s2">= [</span><span class="s4">'&lt;'</span><span class="s2">, </span><span class="s4">'&lt;='</span><span class="s2">, </span><span class="s4">'=='</span><span class="s2">, </span><span class="s4">'!='</span><span class="s2">, </span><span class="s4">'&gt;'</span><span class="s2">, </span><span class="s4">'&gt;='</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">opstr </span><span class="s0">in </span><span class="s1">ops</span><span class="s2">:</span>
            <span class="s1">opid </span><span class="s2">= </span><span class="s1">ops</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">opstr</span><span class="s2">)</span>
            <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)])</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_RichCompare&quot;</span><span class="s2">)</span>
            <span class="s1">lopid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">opid</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">lopid</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">opstr </span><span class="s2">== </span><span class="s4">'is'</span><span class="s2">:</span>
            <span class="s1">bitflag </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_unsigned</span><span class="s2">(</span><span class="s4">'=='</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bool_from_bool</span><span class="s2">(</span><span class="s1">bitflag</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">opstr </span><span class="s2">== </span><span class="s4">'is not'</span><span class="s2">:</span>
            <span class="s1">bitflag </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_unsigned</span><span class="s2">(</span><span class="s4">'!='</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bool_from_bool</span><span class="s2">(</span><span class="s1">bitflag</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">opstr </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'in'</span><span class="s2">, </span><span class="s4">'not in'</span><span class="s2">):</span>
            <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySequence_Contains&quot;</span><span class="s2">)</span>
            <span class="s1">status </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">))</span>
            <span class="s1">negone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">is_good </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_unsigned</span><span class="s2">(</span><span class="s4">'!='</span><span class="s2">, </span><span class="s1">status</span><span class="s2">, </span><span class="s1">negone</span><span class="s2">)</span>
            <span class="s5"># Stack allocate output and initialize to Null</span>
            <span class="s1">outptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                               <span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
            <span class="s5"># If PySequence_Contains returns non-error value</span>
            <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">if_likely</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">is_good</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">opstr </span><span class="s2">== </span><span class="s4">'not in'</span><span class="s2">:</span>
                    <span class="s1">status </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">not_</span><span class="s2">(</span><span class="s1">status</span><span class="s2">)</span>
                <span class="s5"># Store the status as a boolean object</span>
                <span class="s1">truncated </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">(</span><span class="s1">status</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bool_from_bool</span><span class="s2">(</span><span class="s1">truncated</span><span class="s2">),</span>
                                   <span class="s1">outptr</span><span class="s2">)</span>

            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">outptr</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s4">&quot;Unknown operator {op!r}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
                <span class="s1">op</span><span class="s2">=</span><span class="s1">opstr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">iter_next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">iterobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyIter_Next&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">iterobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_getiter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_GetIter&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_getattr_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_GetAttrString&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">cstr</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_GetAttr&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_setattr_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_SetAttrString&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">cstr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_SetAttr&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_delattr_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s5"># PyObject_DelAttrString() is actually a C macro calling</span>
        <span class="s5"># PyObject_SetAttrString() with value == NULL.</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_setattr_string</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">object_delattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s5"># PyObject_DelAttr() is actually a C macro calling</span>
        <span class="s5"># PyObject_SetAttr() with value == NULL.</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_setattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">object_getitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return obj[key] 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_GetItem&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">object_setitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        obj[key] = val 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_SetItem&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">object_delitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        del obj[key] 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_DelItem&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">string_as_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">strobj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyUnicode_AsUTF8&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">strobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">string_as_string_and_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">strobj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Returns a tuple of ``(ok, buffer, length)``. 
        The ``ok`` is i1 value that is set if ok. 
        The ``buffer`` is a i8* of the output buffer. 
        The ``length`` is a i32/i64 (py_ssize_t) of the length of the buffer. 
        &quot;&quot;&quot;</span>

        <span class="s1">p_length </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">,</span>
                                              <span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">()])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyUnicode_AsUTF8AndSize&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>

        <span class="s1">buffer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">strobj</span><span class="s2">, </span><span class="s1">p_length</span><span class="s2">])</span>
        <span class="s1">ok </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_unsigned</span><span class="s2">(</span><span class="s4">'!='</span><span class="s2">,</span>
                                        <span class="s1">Constant</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
                                        <span class="s1">buffer</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">ok</span><span class="s2">, </span><span class="s1">buffer</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">p_length</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">string_as_string_size_and_kind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">strobj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Returns a tuple of ``(ok, buffer, length, kind)``. 
        The ``ok`` is i1 value that is set if ok. 
        The ``buffer`` is a i8* of the output buffer. 
        The ``length`` is a i32/i64 (py_ssize_t) of the length of the buffer. 
        The ``kind`` is a i32 (int32) of the Unicode kind constant 
        The ``hash`` is a long/uint64_t (py_hash_t) of the Unicode constant hash 
        &quot;&quot;&quot;</span>
        <span class="s1">p_length </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">)</span>
        <span class="s1">p_kind </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">))</span>
        <span class="s1">p_ascii </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">))</span>
        <span class="s1">p_hash </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_hash_t</span><span class="s2">)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">,</span>
                                              <span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">(),</span>
                                              <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">).</span><span class="s1">as_pointer</span><span class="s2">(),</span>
                                              <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">).</span><span class="s1">as_pointer</span><span class="s2">(),</span>
                                              <span class="s1">self</span><span class="s2">.</span><span class="s1">py_hash_t</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">()])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;numba_extract_unicode&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>

        <span class="s1">buffer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span>
            <span class="s1">fn</span><span class="s2">, [</span><span class="s1">strobj</span><span class="s2">, </span><span class="s1">p_length</span><span class="s2">, </span><span class="s1">p_kind</span><span class="s2">, </span><span class="s1">p_ascii</span><span class="s2">, </span><span class="s1">p_hash</span><span class="s2">])</span>
        <span class="s1">ok </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_unsigned</span><span class="s2">(</span><span class="s4">'!='</span><span class="s2">,</span>
                                        <span class="s1">Constant</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
                                        <span class="s1">buffer</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">ok</span><span class="s2">, </span><span class="s1">buffer</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">p_length</span><span class="s2">),</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">p_kind</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">p_ascii</span><span class="s2">),</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">p_hash</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">string_from_string_and_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">string</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyString_FromStringAndSize&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">string</span><span class="s2">, </span><span class="s1">size</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">string_from_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">string</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyUnicode_FromString&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">string</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">string_from_kind_and_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">, </span><span class="s1">string</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyUnicode_FromKindAndData&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">kind</span><span class="s2">, </span><span class="s1">string</span><span class="s2">, </span><span class="s1">size</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">bytes_as_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyBytes_AsString&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">bytes_as_string_and_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">p_buffer</span><span class="s2">, </span><span class="s1">p_length</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">),</span>
            <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">.</span><span class="s1">as_pointer</span><span class="s2">()],</span>
        <span class="s2">)</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyBytes_AsStringAndSize&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">p_buffer</span><span class="s2">, </span><span class="s1">p_length</span><span class="s2">])</span>
        <span class="s1">ok </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_signed</span><span class="s2">(</span><span class="s4">&quot;!=&quot;</span><span class="s2">, </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), </span><span class="s1">result</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ok</span>

    <span class="s0">def </span><span class="s1">bytes_from_string_and_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">string</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyBytes_FromStringAndSize&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">string</span><span class="s2">, </span><span class="s1">size</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">object_hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_hash_t</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, ])</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s4">&quot;PyObject_Hash&quot;</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">,])</span>

    <span class="s0">def </span><span class="s1">object_str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PyObject_Str&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">make_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">borrow_none</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">obj</span>

    <span class="s0">def </span><span class="s1">borrow_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_c_object</span><span class="s2">(</span><span class="s4">&quot;_Py_NoneStruct&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">sys_write_stdout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cstring</span><span class="s2">], </span><span class="s1">var_arg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;PySys_FormatStdout&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">fmt</span><span class="s2">,) + </span><span class="s1">args</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">object_dump</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Dump a Python object on C stderr.  For debugging purposes. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;_PyObject_Dump&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">obj</span><span class="s2">,))</span>

    <span class="s5">#</span>
    <span class="s5"># NRT (Numba runtime) APIs</span>
    <span class="s5">#</span>

    <span class="s0">def </span><span class="s1">nrt_adapt_ndarray_to_python</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">aryty</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">, </span><span class="s1">dtypeptr</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_nrt</span><span class="s2">, </span><span class="s4">&quot;NRT required&quot;</span>

        <span class="s1">intty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)</span>
        <span class="s5"># Embed the Python type of the array (maybe subclass) in the LLVM IR.</span>
        <span class="s1">serial_aryty_pytype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unserialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">serialize_object</span><span class="s2">(</span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">box_type</span><span class="s2">))</span>

        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">,</span>
                               <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">intty</span><span class="s2">, </span><span class="s1">intty</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;NRT_adapt_ndarray_to_python_acqref&quot;</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>

        <span class="s1">ndim </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">)</span>
        <span class="s1">writable </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">mutable</span><span class="s2">))</span>

        <span class="s1">aryptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">aryptr</span><span class="s2">,</span>
                                                           <span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">),</span>
                                      <span class="s1">serial_aryty_pytype</span><span class="s2">,</span>
                                      <span class="s1">ndim</span><span class="s2">, </span><span class="s1">writable</span><span class="s2">, </span><span class="s1">dtypeptr</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">nrt_meminfo_new_from_pyobject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">pyobj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Allocate a new MemInfo with data payload borrowed from a python 
        object. 
        &quot;&quot;&quot;</span>
        <span class="s1">mod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">cgutils</span><span class="s2">.</span><span class="s1">voidptr_t</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">voidptr_t</span><span class="s2">, </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">voidptr_t</span><span class="s2">],</span>
            <span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
            <span class="s1">mod</span><span class="s2">,</span>
            <span class="s1">fnty</span><span class="s2">,</span>
            <span class="s4">&quot;NRT_meminfo_new_from_pyobject&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">return_value</span><span class="s2">.</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">&quot;noalias&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">data</span><span class="s2">, </span><span class="s1">pyobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">nrt_meminfo_as_pyobject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">miptr</span><span class="s2">):</span>
        <span class="s1">mod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">voidptr_t</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
            <span class="s1">mod</span><span class="s2">,</span>
            <span class="s1">fnty</span><span class="s2">,</span>
            <span class="s4">'NRT_meminfo_as_pyobject'</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">return_value</span><span class="s2">.</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">&quot;noalias&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">miptr</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">nrt_meminfo_from_pyobject</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">miobj</span><span class="s2">):</span>
        <span class="s1">mod </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">cgutils</span><span class="s2">.</span><span class="s1">voidptr_t</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
            <span class="s1">mod</span><span class="s2">,</span>
            <span class="s1">fnty</span><span class="s2">,</span>
            <span class="s4">'NRT_meminfo_from_pyobject'</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">return_value</span><span class="s2">.</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">&quot;noalias&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">miobj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">nrt_adapt_ndarray_from_python</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_nrt</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;NRT_adapt_ndarray_from_python&quot;</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">nrt_adapt_buffer_from_python</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">buf</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_nrt</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_buffer_t</span><span class="s2">),</span>
                                               <span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;NRT_adapt_buffer_from_python&quot;</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">))</span>

    <span class="s5"># ------ utils -----</span>

    <span class="s0">def </span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">alloca_obj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">alloca</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">alloca_buffer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return a pointer to a stack-allocated, zero-initialized Py_buffer. 
        &quot;&quot;&quot;</span>
        <span class="s5"># Treat the buffer as an opaque array of bytes</span>
        <span class="s1">ptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                                        <span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_buffer_t</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">ptr</span>

    <span class="s2">@</span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">if_object_ok</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">if_likely</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">,</span>
                               <span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_not_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)):</span>
            <span class="s0">yield</span>

    <span class="s0">def </span><span class="s1">print_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">strobj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_str</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">string_as_string</span><span class="s2">(</span><span class="s1">strobj</span><span class="s2">)</span>
        <span class="s1">fmt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s4">&quot;%s&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sys_write_stdout</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">cstr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">strobj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">print_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
        <span class="s1">fmt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">text</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sys_write_stdout</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_null_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">return_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_none</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">ret</span><span class="s2">(</span><span class="s1">none</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">list_pack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">items</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">items</span><span class="s2">)</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">list_new</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">if_object_ok</span><span class="s2">(</span><span class="s1">seq</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
                <span class="s1">idx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">items</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">list_setitem</span><span class="s2">(</span><span class="s1">seq</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">items</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">seq</span>

    <span class="s0">def </span><span class="s1">unserialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">structptr</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Unserialize some data.  *structptr* should be a pointer to 
        a {i8* data, i32 length, i8* hashbuf, i8* func_ptr, i32 alloc_flag} 
        structure. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">,</span>
                             <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">))</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_unpickle&quot;</span><span class="s2">)</span>
        <span class="s1">ptr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">structptr</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">structptr</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">hashed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">structptr</span><span class="s2">), </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">hashed</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">build_dynamic_excinfo_struct</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">struct_gv</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Serialize some data at runtime. Returns a pointer to a python tuple 
        (bytes_data, hash) where the first element is the serialized data as 
        bytes and the second its hash. 
        &quot;&quot;&quot;</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">))</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_runtime_build_excinfo_struct&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">struct_gv</span><span class="s2">, </span><span class="s1">exc_args</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">serialize_uncached</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Same as serialize_object(), but don't create a global variable, 
        simply return a literal for structure: 
        {i8* data, i32 length, i8* hashbuf, i8* func_ptr, i32 alloc_flag} 
        &quot;&quot;&quot;</span>
        <span class="s5"># First make the array constant</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">serialize</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) &lt; </span><span class="s3">2</span><span class="s2">**</span><span class="s3">31</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s4">&quot;.const.pickledata.%s&quot; </span><span class="s2">% (</span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">DIFF_IR </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">else </span><span class="s4">&quot;DIFF_IR&quot;</span><span class="s2">)</span>
        <span class="s1">bdata </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">make_bytearray</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s5"># Make SHA1 hash on the pickled content</span>
        <span class="s5"># NOTE: update buffer size in numba_unpickle() when changing the</span>
        <span class="s5">#       hash algorithm.</span>
        <span class="s1">hashed </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">make_bytearray</span><span class="s2">(</span><span class="s1">hashlib</span><span class="s2">.</span><span class="s1">sha1</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">digest</span><span class="s2">())</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_unique_const</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">bdata</span><span class="s2">)</span>
        <span class="s1">hasharr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_unique_const</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">.sha1&quot;</span><span class="s2">, </span><span class="s1">hashed</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s5"># Then populate the structure constant</span>
        <span class="s1">struct </span><span class="s2">= </span><span class="s1">Constant</span><span class="s2">.</span><span class="s1">literal_struct</span><span class="s2">([</span>
            <span class="s1">arr</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">),</span>
            <span class="s1">Constant</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">type</span><span class="s2">.</span><span class="s1">pointee</span><span class="s2">.</span><span class="s1">count</span><span class="s2">),</span>
            <span class="s1">hasharr</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">),</span>
            <span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_null_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">),</span>
            <span class="s1">Constant</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s3">0</span><span class="s2">),</span>
            <span class="s2">])</span>
        <span class="s0">return </span><span class="s1">struct</span>

    <span class="s0">def </span><span class="s1">serialize_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Serialize the given object in the bitcode, and return it 
        as a pointer to a 
        {i8* data, i32 length, i8* hashbuf, i8* fn_ptr, i32 alloc_flag}, 
        structure constant (suitable for passing to unserialize()). 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">gv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">__serialized</span><span class="s2">[</span><span class="s1">obj</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s1">struct </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">serialize_uncached</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s4">&quot;.const.picklebuf.%s&quot; </span><span class="s2">% (</span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">if </span><span class="s1">config</span><span class="s2">.</span><span class="s1">DIFF_IR </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">else </span><span class="s4">&quot;DIFF_IR&quot;</span><span class="s2">)</span>
            <span class="s1">gv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_unique_const</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">struct</span><span class="s2">)</span>
            <span class="s5"># Make the id() (and hence the name) unique while populating the module.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">.</span><span class="s1">__serialized</span><span class="s2">[</span><span class="s1">obj</span><span class="s2">] = </span><span class="s1">gv</span>
        <span class="s0">return </span><span class="s1">gv</span>

    <span class="s0">def </span><span class="s1">c_api_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_not_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">err_occurred</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">to_native_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Unbox the Python object as the given Numba type. 
        A NativeValue instance is returned. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">boxing </span><span class="s0">import </span><span class="s1">unbox_unsupported</span>

        <span class="s1">impl </span><span class="s2">= </span><span class="s1">_unboxers</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">unbox_unsupported</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">_UnboxContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">from_native_return</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">env_manager</span><span class="s2">):</span>
        <span class="s0">assert not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Optional</span><span class="s2">), </span><span class="s4">&quot;callconv should have &quot; </span><span class="s1">\</span>
                                                    <span class="s4">&quot;prevented the return of &quot; </span><span class="s1">\</span>
                                                    <span class="s4">&quot;optional value&quot;</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">from_native_value</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">env_manager</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">out</span>

    <span class="s0">def </span><span class="s1">from_native_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">env_manager</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Box the native value of the given Numba type.  A Python object 
        pointer is returned (NULL if an error occurred). 
        This method steals any native (NRT) reference embedded in *val*. 
        &quot;&quot;&quot;</span>
        <span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">boxing </span><span class="s0">import </span><span class="s1">box_unsupported</span>

        <span class="s1">impl </span><span class="s2">= </span><span class="s1">_boxers</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">box_unsupported</span><span class="s2">)</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">_BoxContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">env_manager</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">reflect_native_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">env_manager</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Reflect the native value onto its Python original, if any. 
        An error bit (as an LLVM value) is returned. 
        &quot;&quot;&quot;</span>
        <span class="s1">impl </span><span class="s2">= </span><span class="s1">_reflectors</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">impl </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s5"># Reflection isn't needed for most types</span>
            <span class="s0">return </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">false_bit</span>

        <span class="s1">is_error </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">false_bit</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">_ReflectContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">env_manager</span><span class="s2">,</span>
                            <span class="s1">is_error</span><span class="s2">)</span>
        <span class="s1">impl</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">is_error</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">to_native_generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Extract the generator structure pointer from a generator *obj* 
        (a _dynfunc.Generator instance). 
        &quot;&quot;&quot;</span>
        <span class="s1">gen_ptr_ty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_data_type</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">))</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_generator_state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">gen_ptr_ty</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">NativeValue</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">from_native_generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Make a Numba generator (a _dynfunc.Generator instance) from a 
        generator structure pointer *val*. 
        *env* is an optional _dynfunc.Environment instance to be wrapped 
        in the generator. 
        &quot;&quot;&quot;</span>
        <span class="s1">llty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_data_type</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">llty</span><span class="s2">.</span><span class="s1">is_pointer</span>
        <span class="s1">gen_struct_size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_abi_sizeof</span><span class="s2">(</span><span class="s1">llty</span><span class="s2">)</span>

        <span class="s1">gendesc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_generator_desc</span><span class="s2">(</span><span class="s1">typ</span><span class="s2">)</span>

        <span class="s5"># This is the PyCFunctionWithKeywords generated by PyCallWrapper</span>
        <span class="s1">genfnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">genfn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">genfnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">gendesc</span><span class="s2">.</span><span class="s1">llvm_cpython_wrapper_name</span><span class="s2">)</span>

        <span class="s5"># This is the raw finalizer generated by _lower_generator_finalize_func()</span>
        <span class="s1">finalizerty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">typ</span><span class="s2">.</span><span class="s1">has_finalizer</span><span class="s2">:</span>
            <span class="s1">finalizer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">finalizerty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">gendesc</span><span class="s2">.</span><span class="s1">llvm_finalizer_name</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">finalizer </span><span class="s2">= </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">finalizerty</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s5"># PyObject *numba_make_generator(state_size, initial_state, nextfunc, finalizer, env)</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">,</span>
                                            <span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">,</span>
                                            <span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">genfnty</span><span class="s2">),</span>
                                            <span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">finalizerty</span><span class="s2">),</span>
                                            <span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_make_generator&quot;</span><span class="s2">)</span>

        <span class="s1">state_size </span><span class="s2">= </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_ssize_t</span><span class="s2">, </span><span class="s1">gen_struct_size</span><span class="s2">)</span>
        <span class="s1">initial_state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">env </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">env </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_null_object</span><span class="s2">()</span>
        <span class="s1">env </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">env</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">,</span>
                                 <span class="s2">(</span><span class="s1">state_size</span><span class="s2">, </span><span class="s1">initial_state</span><span class="s2">, </span><span class="s1">genfn</span><span class="s2">, </span><span class="s1">finalizer</span><span class="s2">, </span><span class="s1">env</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">numba_array_adaptor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s0">assert not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">enable_nrt</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_adapt_ndarray&quot;</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">numba_buffer_adaptor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">buf</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(),</span>
                             <span class="s2">[</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_buffer_t</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_adapt_buffer&quot;</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">add_attribute</span><span class="s2">(</span><span class="s4">'nocapture'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, (</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">complex_adaptor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cobj</span><span class="s2">, </span><span class="s1">cmplx</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">cmplx</span><span class="s2">.</span><span class="s1">type</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_complex_adaptor&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">cobj</span><span class="s2">, </span><span class="s1">cmplx</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">extract_record_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">pbuf</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">voidptr</span><span class="s2">,</span>
                               <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_buffer_t</span><span class="s2">)])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_extract_record_data&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">pbuf</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">get_buffer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">pbuf</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">),</span>
                               <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_buffer_t</span><span class="s2">)])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_get_buffer&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">pbuf</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">release_buffer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pbuf</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">py_buffer_t</span><span class="s2">)])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_release_buffer&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">pbuf</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">extract_np_datetime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">64</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_extract_np_datetime&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">extract_np_timedelta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">64</span><span class="s2">), [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_extract_np_timedelta&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">obj</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">create_np_datetime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">unit_code</span><span class="s2">):</span>
        <span class="s1">unit_code </span><span class="s2">= </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">unit_code</span><span class="s2">))</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">64</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_create_np_datetime&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">, </span><span class="s1">unit_code</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">create_np_timedelta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">unit_code</span><span class="s2">):</span>
        <span class="s1">unit_code </span><span class="s2">= </span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">unit_code</span><span class="s2">))</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">64</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_create_np_timedelta&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">, </span><span class="s1">unit_code</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">recreate_record</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pdata</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">env_manager</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">, [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">8</span><span class="s2">)),</span>
                                            <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s3">32</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">])</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_function</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;numba_recreate_record&quot;</span><span class="s2">)</span>
        <span class="s1">dtypeaddr </span><span class="s2">= </span><span class="s1">env_manager</span><span class="s2">.</span><span class="s1">read_const</span><span class="s2">(</span><span class="s1">env_manager</span><span class="s2">.</span><span class="s1">add_const</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span><span class="s1">pdata</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtypeaddr</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">string_from_constant_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">string</span><span class="s2">):</span>
        <span class="s1">cstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">insert_const_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">module</span><span class="s2">, </span><span class="s1">string</span><span class="s2">)</span>
        <span class="s1">sz </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">string</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">string_from_string_and_size</span><span class="s2">(</span><span class="s1">cstr</span><span class="s2">, </span><span class="s1">sz</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">call_jit_code</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Calls into Numba jitted code and propagate error using the Python 
        calling convention. 
 
        Parameters 
        ---------- 
        func : function 
            The Python function to be compiled. This function is compiled 
            in nopython-mode. 
        sig : numba.typing.Signature 
            The function signature for *func*. 
        args : Sequence[llvmlite.binding.Value] 
            LLVM values to use as arguments. 
 
        Returns 
        ------- 
        (is_error, res) :  2-tuple of llvmlite.binding.Value. 
            is_error : true iff *func* raised an exception. 
            res : Returned value from *func* iff *is_error* is false. 
 
        If *is_error* is true, this method will adapt the nopython exception 
        into a Python exception. Caller should return NULL to Python to 
        indicate an error. 
        &quot;&quot;&quot;</span>
        <span class="s5"># Compile *func*</span>
        <span class="s1">builder </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">builder</span>
        <span class="s1">cres </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_subroutine</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">)</span>
        <span class="s1">got_retty </span><span class="s2">= </span><span class="s1">cres</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">.</span><span class="s1">return_type</span>
        <span class="s1">retty </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span>
        <span class="s0">if </span><span class="s1">got_retty </span><span class="s2">!= </span><span class="s1">retty</span><span class="s2">:</span>
            <span class="s5"># This error indicates an error in *func* or the caller of this</span>
            <span class="s5"># method.</span>
            <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">LoweringError</span><span class="s2">(</span>
                <span class="s4">f'mismatching signature </span><span class="s0">{</span><span class="s1">got_retty</span><span class="s0">} </span><span class="s4">!= </span><span class="s0">{</span><span class="s1">retty</span><span class="s0">}</span><span class="s4">.</span><span class="s0">\n</span><span class="s4">'</span>
            <span class="s2">)</span>
        <span class="s5"># Call into *func*</span>
        <span class="s1">status</span><span class="s2">, </span><span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_internal_no_propagate</span><span class="s2">(</span>
            <span class="s1">builder</span><span class="s2">, </span><span class="s1">cres</span><span class="s2">.</span><span class="s1">fndesc</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s5"># Post-call handling for *func*</span>
        <span class="s1">is_error_ptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">bool_t</span><span class="s2">, </span><span class="s1">zfill</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">res_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">)</span>
        <span class="s1">res_ptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">res_type</span><span class="s2">, </span><span class="s1">zfill</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s5"># Handle error and adapt the nopython exception into cpython exception</span>
        <span class="s0">with </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_else</span><span class="s2">(</span><span class="s1">status</span><span class="s2">.</span><span class="s1">is_error</span><span class="s2">) </span><span class="s0">as </span><span class="s2">(</span><span class="s1">has_err</span><span class="s2">, </span><span class="s1">no_err</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">has_err</span><span class="s2">:</span>
                <span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">status</span><span class="s2">.</span><span class="s1">is_error</span><span class="s2">, </span><span class="s1">is_error_ptr</span><span class="s2">)</span>
                <span class="s5"># Set error state in the Python interpreter</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">.</span><span class="s1">call_conv</span><span class="s2">.</span><span class="s1">raise_error</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">status</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">no_err</span><span class="s2">:</span>
                <span class="s5"># Handle returned value</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">imputils</span><span class="s2">.</span><span class="s1">fix_returning_optional</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">status</span><span class="s2">, </span><span class="s1">res</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">res_ptr</span><span class="s2">)</span>

        <span class="s1">is_error </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">is_error_ptr</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">res_ptr</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">is_error</span><span class="s2">, </span><span class="s1">res</span>


<span class="s0">class </span><span class="s1">ObjModeUtils</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot;Internal utils for calling objmode dispatcher from within NPM code. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyapi</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi </span><span class="s2">= </span><span class="s1">pyapi</span>

    <span class="s0">def </span><span class="s1">load_dispatcher</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">argtypes</span><span class="s2">):</span>
        <span class="s1">builder </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">builder</span>
        <span class="s1">tyctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">context</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>

        <span class="s5"># Add a global variable to cache the objmode dispatcher</span>
        <span class="s1">gv </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">GlobalVariable</span><span class="s2">(</span>
            <span class="s1">m</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">pyobj</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">m</span><span class="s2">.</span><span class="s1">get_unique_name</span><span class="s2">(</span><span class="s4">&quot;cached_objmode_dispatcher&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">gv</span><span class="s2">.</span><span class="s1">initializer </span><span class="s2">= </span><span class="s1">gv</span><span class="s2">.</span><span class="s1">type</span><span class="s2">.</span><span class="s1">pointee</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">gv</span><span class="s2">.</span><span class="s1">linkage </span><span class="s2">= </span><span class="s4">'internal'</span>

        <span class="s5"># Make a basic-block to common exit</span>
        <span class="s1">bb_end </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">append_basic_block</span><span class="s2">(</span><span class="s4">&quot;bb_end&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">serialize</span><span class="s2">.</span><span class="s1">is_serialiable</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">dispatcher</span><span class="s2">):</span>
            <span class="s1">serialized_dispatcher </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">serialize_object</span><span class="s2">(</span>
                <span class="s2">(</span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">dispatcher</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">argtypes</span><span class="s2">)),</span>
            <span class="s2">)</span>
            <span class="s1">compile_args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">unserialize</span><span class="s2">(</span><span class="s1">serialized_dispatcher</span><span class="s2">)</span>
            <span class="s5"># unserialize (unpickling) can fail</span>
            <span class="s1">failed_unser </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">compile_args</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_then</span><span class="s2">(</span><span class="s1">failed_unser</span><span class="s2">):</span>
                <span class="s5"># early exit. `gv` is still null.</span>
                <span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">bb_end</span><span class="s2">)</span>

        <span class="s1">cached </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">gv</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">if_then</span><span class="s2">(</span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">cached</span><span class="s2">)):</span>
            <span class="s0">if </span><span class="s1">serialize</span><span class="s2">.</span><span class="s1">is_serialiable</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">dispatcher</span><span class="s2">):</span>
                <span class="s1">cls </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
                <span class="s1">compiler </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">unserialize</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">serialize_object</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_call_objmode_dispatcher</span><span class="s2">)</span>
                <span class="s2">)</span>
                <span class="s1">callee </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">call_function_objargs</span><span class="s2">(</span>
                    <span class="s1">compiler</span><span class="s2">, [</span><span class="s1">compile_args</span><span class="s2">],</span>
                <span class="s2">)</span>
                <span class="s5"># Clean up</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">compiler</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">decref</span><span class="s2">(</span><span class="s1">compile_args</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">entry_pt </span><span class="s2">= </span><span class="s1">fnty</span><span class="s2">.</span><span class="s1">dispatcher</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">argtypes</span><span class="s2">))</span>
                <span class="s1">callee </span><span class="s2">= </span><span class="s1">tyctx</span><span class="s2">.</span><span class="s1">add_dynamic_addr</span><span class="s2">(</span>
                    <span class="s1">builder</span><span class="s2">, </span><span class="s1">id</span><span class="s2">(</span><span class="s1">entry_pt</span><span class="s2">), </span><span class="s1">info</span><span class="s2">=</span><span class="s4">&quot;with_objectmode&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s5"># Incref the dispatcher and cache it</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pyapi</span><span class="s2">.</span><span class="s1">incref</span><span class="s2">(</span><span class="s1">callee</span><span class="s2">)</span>
            <span class="s1">builder</span><span class="s2">.</span><span class="s1">store</span><span class="s2">(</span><span class="s1">callee</span><span class="s2">, </span><span class="s1">gv</span><span class="s2">)</span>
        <span class="s5"># Jump to the exit block</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">branch</span><span class="s2">(</span><span class="s1">bb_end</span><span class="s2">)</span>
        <span class="s5"># Define the exit block</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">position_at_end</span><span class="s2">(</span><span class="s1">bb_end</span><span class="s2">)</span>
        <span class="s1">callee </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">gv</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">callee</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">_call_objmode_dispatcher</span><span class="s2">(</span><span class="s1">compile_args</span><span class="s2">):</span>
        <span class="s1">dispatcher</span><span class="s2">, </span><span class="s1">argtypes </span><span class="s2">= </span><span class="s1">compile_args</span>
        <span class="s1">entrypt </span><span class="s2">= </span><span class="s1">dispatcher</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">argtypes</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">entrypt</span>
</pre>
</body>
</html>