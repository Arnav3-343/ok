<html>
<head>
<title>_dynfunc.c</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #6aab73;}
.s4 { color: #0da19e;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_dynfunc.c</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Definition of Environment and Closure objects. 
 * This module is included by _dynfuncmod.c and by pycc-compiled modules. 
 */</span>

<span class="s2">#include </span><span class="s3">&quot;_pymodule.h&quot;</span>

<span class="s2">#include </span><span class="s1">&lt;string.h&gt;</span>

<span class="s0">/* NOTE: EnvironmentObject and ClosureObject must be kept in sync with 
 * the definitions in numba/targets/base.py (EnvBody and ClosureBody). 
 */</span>

<span class="s0">/* 
 * EnvironmentObject hosts data needed for execution of compiled functions. 
 */</span>
<span class="s2">typedef struct </span><span class="s1">{</span>
    <span class="s1">PyObject_HEAD</span>
    <span class="s1">PyObject *globals;</span>
    <span class="s0">/* Assorted &quot;constants&quot; that are needed at runtime to execute 
       the compiled function.  This can include frozen closure variables, 
       lifted loops, etc. */</span>
    <span class="s1">PyObject *consts;</span>
<span class="s1">} EnvironmentObject;</span>


<span class="s2">static </span><span class="s1">PyMemberDef env_members[] = {</span>
    <span class="s1">{</span><span class="s3">&quot;globals&quot;</span><span class="s1">, T_OBJECT, offsetof(EnvironmentObject, globals), READONLY, NULL},</span>
    <span class="s1">{</span><span class="s3">&quot;consts&quot;</span><span class="s1">, T_OBJECT, offsetof(EnvironmentObject, consts), READONLY, NULL},</span>
    <span class="s1">{NULL}  </span><span class="s0">/* Sentinel */</span>
<span class="s1">};</span>

<span class="s2">static int</span>
<span class="s1">env_traverse(EnvironmentObject *env, visitproc visit, </span><span class="s2">void </span><span class="s1">*arg)</span>
<span class="s1">{</span>
    <span class="s1">Py_VISIT(env</span><span class="s4">-&gt;</span><span class="s1">globals);</span>
    <span class="s1">Py_VISIT(env</span><span class="s4">-&gt;</span><span class="s1">consts);</span>
    <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">static int</span>
<span class="s1">env_clear(EnvironmentObject *env)</span>
<span class="s1">{</span>
    <span class="s1">Py_CLEAR(env</span><span class="s4">-&gt;</span><span class="s1">globals);</span>
    <span class="s1">Py_CLEAR(env</span><span class="s4">-&gt;</span><span class="s1">consts);</span>
    <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">static void</span>
<span class="s1">env_dealloc(EnvironmentObject *env)</span>
<span class="s1">{</span>
    <span class="s1">PyObject_GC_UnTrack((PyObject *) env);</span>
    <span class="s1">env_clear(env);</span>
    <span class="s1">Py_TYPE(env)</span><span class="s4">-&gt;</span><span class="s1">tp_free((PyObject *) env);</span>
<span class="s1">}</span>

<span class="s2">static </span><span class="s1">EnvironmentObject *</span>
<span class="s1">env_new_empty(PyTypeObject* type)</span>
<span class="s1">{</span>
    <span class="s2">return </span><span class="s1">(EnvironmentObject *) PyType_GenericNew(type, NULL, NULL);</span>
<span class="s1">}</span>

<span class="s2">static </span><span class="s1">PyObject *</span>
<span class="s1">env_new(PyTypeObject* type, PyObject* args, PyObject* kwds)</span>
<span class="s1">{</span>
    <span class="s1">PyObject *globals;</span>
    <span class="s1">EnvironmentObject *env;</span>
    <span class="s2">static char </span><span class="s1">*kwlist[] = {</span><span class="s3">&quot;globals&quot;</span><span class="s1">, </span><span class="s5">0</span><span class="s1">};</span>

    <span class="s2">if </span><span class="s1">(!PyArg_ParseTupleAndKeywords(</span>
            <span class="s1">args, kwds, </span><span class="s3">&quot;O!:function&quot;</span><span class="s1">, kwlist,</span>
            <span class="s1">&amp;PyDict_Type, &amp;globals))</span>
        <span class="s2">return </span><span class="s1">NULL;</span>

    <span class="s1">env = env_new_empty(type);</span>
    <span class="s2">if </span><span class="s1">(env == NULL)</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">Py_INCREF(globals);</span>
    <span class="s1">env</span><span class="s4">-&gt;</span><span class="s1">globals = globals;</span>
    <span class="s1">env</span><span class="s4">-&gt;</span><span class="s1">consts = PyList_New(</span><span class="s5">0</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(!env</span><span class="s4">-&gt;</span><span class="s1">consts) {</span>
        <span class="s1">Py_DECREF(env);</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">(PyObject *) env;</span>
<span class="s1">}</span>


<span class="s2">static </span><span class="s1">PyTypeObject EnvironmentType = {</span>
    <span class="s1">PyVarObject_HEAD_INIT(NULL, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s3">&quot;_dynfunc.Environment&quot;</span><span class="s1">,                  </span><span class="s0">/* tp_name */</span>
    <span class="s2">sizeof</span><span class="s1">(EnvironmentObject),               </span><span class="s0">/* tp_basicsize */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_itemsize */</span>
    <span class="s1">(destructor) env_dealloc,                </span><span class="s0">/* tp_dealloc */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_vectorcall_offset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_getattr*/</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_setattr */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_async */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_repr */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_number */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_sequence */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_mapping */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_hash */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_call */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_str */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_getattro */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_setattro */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_buffer */</span>
    <span class="s1">Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE | Py_TPFLAGS_HAVE_GC, </span><span class="s0">/* tp_flags */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_doc */</span>
    <span class="s1">(traverseproc) env_traverse,             </span><span class="s0">/* tp_traverse */</span>
    <span class="s1">(inquiry) env_clear,                     </span><span class="s0">/* tp_clear */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_richcompare */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_weaklistoffset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_iter */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_iternext */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_methods */</span>
    <span class="s1">env_members,                             </span><span class="s0">/* tp_members */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_getset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_base */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_dict */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_descr_get */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_descr_set */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_dictoffset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_init */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_alloc */</span>
    <span class="s1">env_new,                                 </span><span class="s0">/* tp_new */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_free */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_is_gc */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_bases */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_mro */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_cache */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_subclasses */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_weaklist */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_del */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_version_tag */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_finalize */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_vectorcall */</span>
<span class="s2">#if </span><span class="s1">(PY_MAJOR_VERSION == </span><span class="s5">3</span><span class="s1">) &amp;&amp; (PY_MINOR_VERSION == </span><span class="s5">12</span><span class="s1">)</span>
<span class="s0">/* This was introduced first in 3.12 
 * https://github.com/python/cpython/issues/91051 
 */</span>
    <span class="s5">0</span><span class="s1">,                                           </span><span class="s0">/* tp_watched */</span>
<span class="s2">#endif</span>

<span class="s0">/* WARNING: Do not remove this, only modify it! It is a version guard to 
 * act as a reminder to update this struct on Python version update! */</span>
<span class="s2">#if </span><span class="s1">(PY_MAJOR_VERSION == </span><span class="s5">3</span><span class="s1">)</span>
<span class="s2">#if </span><span class="s1">! ((PY_MINOR_VERSION == </span><span class="s5">9</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">10</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">11</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">12</span><span class="s1">))</span>
<span class="s2">#error </span><span class="s3">&quot;Python minor version is not supported.&quot;</span>
<span class="s2">#endif</span>
<span class="s2">#else</span>
<span class="s2">#error </span><span class="s3">&quot;Python major version is not supported.&quot;</span>
<span class="s2">#endif</span>
<span class="s0">/* END WARNING*/</span>
<span class="s1">};</span>

<span class="s0">/* A closure object is created for each call to make_function(), and stored 
   as the resulting PyCFunction object's &quot;self&quot; pointer.  It points to an 
   EnvironmentObject which is constructed during compilation.  This allows 
   for two things: 
       - lifetime management of dependent data (e.g. lifted loop dispatchers) 
       - access to the execution environment by the compiled function 
         (for example the globals module) 
   */</span>

<span class="s0">/* Closure is a variable-sized object for binary compatibility with 
   Generator (see below). */</span>
<span class="s2">#define </span><span class="s1">CLOSURE_HEAD          \</span>
    <span class="s1">PyObject_VAR_HEAD         \</span>
    <span class="s1">EnvironmentObject *env;</span>

<span class="s2">typedef struct </span><span class="s1">{</span>
    <span class="s1">CLOSURE_HEAD</span>
    <span class="s0">/* The dynamically-filled method definition for the PyCFunction object 
       using this closure. */</span>
    <span class="s1">PyMethodDef def;</span>
    <span class="s0">/* Arbitrary object to keep alive during the closure's lifetime. 
       (put a tuple to put several objects alive). 
       In practice, this helps keep the LLVM module and its generated 
       code alive. */</span>
    <span class="s1">PyObject *keepalive;</span>
    <span class="s1">PyObject *weakreflist;</span>
<span class="s1">} ClosureObject;</span>


<span class="s2">static int</span>
<span class="s1">closure_traverse(ClosureObject *clo, visitproc visit, </span><span class="s2">void </span><span class="s1">*arg)</span>
<span class="s1">{</span>
    <span class="s1">Py_VISIT(clo</span><span class="s4">-&gt;</span><span class="s1">env);</span>
    <span class="s1">Py_VISIT(clo</span><span class="s4">-&gt;</span><span class="s1">keepalive);</span>
    <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">static void</span>
<span class="s1">closure_dealloc(ClosureObject *clo)</span>
<span class="s1">{</span>
    <span class="s1">PyObject_GC_UnTrack((PyObject *) clo);</span>
    <span class="s2">if </span><span class="s1">(clo</span><span class="s4">-&gt;</span><span class="s1">weakreflist != NULL)</span>
        <span class="s1">PyObject_ClearWeakRefs((PyObject *) clo);</span>
    <span class="s1">PyObject_Free((</span><span class="s2">void </span><span class="s1">*) clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_name);</span>
    <span class="s1">PyObject_Free((</span><span class="s2">void </span><span class="s1">*) clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_doc);</span>
    <span class="s1">Py_XDECREF(clo</span><span class="s4">-&gt;</span><span class="s1">env);</span>
    <span class="s1">Py_XDECREF(clo</span><span class="s4">-&gt;</span><span class="s1">keepalive);</span>
    <span class="s1">Py_TYPE(clo)</span><span class="s4">-&gt;</span><span class="s1">tp_free((PyObject *) clo);</span>
<span class="s1">}</span>

<span class="s2">static </span><span class="s1">PyTypeObject ClosureType = {</span>
    <span class="s1">PyVarObject_HEAD_INIT(NULL, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s3">&quot;_dynfunc._Closure&quot;</span><span class="s1">,                     </span><span class="s0">/* tp_name */</span>
    <span class="s2">sizeof</span><span class="s1">(ClosureObject),                   </span><span class="s0">/* tp_basicsize */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_itemsize */</span>
    <span class="s1">(destructor) closure_dealloc,            </span><span class="s0">/* tp_dealloc */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_vectorcall_offset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_getattr */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_setattr */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_async */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_repr */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_number */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_sequence */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_mapping */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_hash */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_call */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_str */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_getattro */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_setattro */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_as_buffer */</span>
    <span class="s1">Py_TPFLAGS_DEFAULT | Py_TPFLAGS_HAVE_GC, </span><span class="s0">/* tp_flags */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_doc */</span>
    <span class="s1">(traverseproc) closure_traverse,         </span><span class="s0">/* tp_traverse */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_clear */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_richcompare */</span>
    <span class="s1">offsetof(ClosureObject, weakreflist),    </span><span class="s0">/* tp_weaklistoffset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_iter */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_iternext */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_methods */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_members */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_getset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_base */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_dict */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_descr_get */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_descr_set */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_dictoffset */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_init */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_alloc */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_new */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_free */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_is_gc */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_bases */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_mro */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_cache */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_subclasses */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_weaklist */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_del */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_version_tag */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_finalize */</span>
    <span class="s5">0</span><span class="s1">,                                       </span><span class="s0">/* tp_vectorcall */</span>
<span class="s2">#if </span><span class="s1">(PY_MAJOR_VERSION == </span><span class="s5">3</span><span class="s1">) &amp;&amp; (PY_MINOR_VERSION == </span><span class="s5">12</span><span class="s1">)</span>
<span class="s0">/* This was introduced first in 3.12 
 * https://github.com/python/cpython/issues/91051 
 */</span>
    <span class="s5">0</span><span class="s1">,                                           </span><span class="s0">/* tp_watched */</span>
<span class="s2">#endif</span>

<span class="s0">/* WARNING: Do not remove this, only modify it! It is a version guard to 
 * act as a reminder to update this struct on Python version update! */</span>
<span class="s2">#if </span><span class="s1">(PY_MAJOR_VERSION == </span><span class="s5">3</span><span class="s1">)</span>
<span class="s2">#if </span><span class="s1">! ((PY_MINOR_VERSION == </span><span class="s5">9</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">10</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">11</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">12</span><span class="s1">))</span>
<span class="s2">#error </span><span class="s3">&quot;Python minor version is not supported.&quot;</span>
<span class="s2">#endif</span>
<span class="s2">#else</span>
<span class="s2">#error </span><span class="s3">&quot;Python major version is not supported.&quot;</span>
<span class="s2">#endif</span>
<span class="s0">/* END WARNING*/</span>
<span class="s1">};</span>


<span class="s0">/* Return an owned piece of character data duplicating a Python string 
   object's value. */</span>
<span class="s2">static char </span><span class="s1">*</span>
<span class="s1">dup_string(PyObject *strobj)</span>
<span class="s1">{</span>
    <span class="s2">const char </span><span class="s1">*tmp = NULL;</span>
    <span class="s2">char </span><span class="s1">*str;</span>
    <span class="s1">tmp = PyString_AsString(strobj);</span>
    <span class="s2">if </span><span class="s1">(tmp == NULL)</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s0">/* Using PyObject_Malloc allows this memory to be tracked for 
       leaks. */</span>
    <span class="s1">str = PyObject_Malloc(strlen(tmp) + </span><span class="s5">1</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(str == NULL) {</span>
        <span class="s1">PyErr_NoMemory();</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">}</span>
    <span class="s1">strcpy(str, tmp);</span>
    <span class="s2">return </span><span class="s1">str;</span>
<span class="s1">}</span>

<span class="s0">/* Create and initialize a new Closure object */</span>
<span class="s2">static </span><span class="s1">ClosureObject *</span>
<span class="s1">closure_new(PyObject *name, PyObject *doc, PyCFunction fnaddr,</span>
            <span class="s1">EnvironmentObject *env, PyObject *keepalive)</span>
<span class="s1">{</span>
    <span class="s1">ClosureObject *clo = (ClosureObject *) PyType_GenericAlloc(&amp;ClosureType, </span><span class="s5">0</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(clo == NULL)</span>
        <span class="s2">return </span><span class="s1">NULL;</span>

    <span class="s1">clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_name = dup_string(name);</span>
    <span class="s2">if </span><span class="s1">(!clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_name) {</span>
        <span class="s1">Py_DECREF(clo);</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">}</span>
    <span class="s1">clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_meth = fnaddr;</span>
    <span class="s1">clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_flags = METH_VARARGS | METH_KEYWORDS;</span>
    <span class="s1">clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_doc = dup_string(doc);</span>
    <span class="s2">if </span><span class="s1">(!clo</span><span class="s4">-&gt;</span><span class="s1">def.ml_doc) {</span>
        <span class="s1">Py_DECREF(clo);</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">}</span>
    <span class="s1">Py_INCREF(env);</span>
    <span class="s1">clo</span><span class="s4">-&gt;</span><span class="s1">env = env;</span>
    <span class="s1">Py_XINCREF(keepalive);</span>
    <span class="s1">clo</span><span class="s4">-&gt;</span><span class="s1">keepalive = keepalive;</span>
    <span class="s2">return </span><span class="s1">clo;</span>
<span class="s1">}</span>

<span class="s0">/* Create a new PyCFunction object wrapping a closure defined by 
   the given arguments. */</span>
<span class="s2">static </span><span class="s1">PyObject *</span>
<span class="s1">pycfunction_new(PyObject *module, PyObject *name, PyObject *doc,</span>
                <span class="s1">PyCFunction fnaddr, EnvironmentObject *env, PyObject *keepalive)</span>
<span class="s1">{</span>
    <span class="s1">PyObject *funcobj;</span>
    <span class="s1">PyObject *modname = NULL;</span>
    <span class="s1">ClosureObject *closure = NULL;</span>

    <span class="s1">closure = closure_new(name, doc, fnaddr, env, keepalive);</span>
    <span class="s2">if </span><span class="s1">(closure == NULL) </span><span class="s2">goto </span><span class="s1">FAIL;</span>

    <span class="s1">modname = PyObject_GetAttrString(module, </span><span class="s3">&quot;__name__&quot;</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(modname == NULL) </span><span class="s2">goto </span><span class="s1">FAIL;</span>

    <span class="s1">funcobj = PyCFunction_NewEx(&amp;closure</span><span class="s4">-&gt;</span><span class="s1">def, (PyObject *) closure, modname);</span>
    <span class="s1">Py_DECREF(closure);</span>
    <span class="s1">Py_DECREF(modname);</span>

    <span class="s2">return </span><span class="s1">funcobj;</span>

<span class="s1">FAIL:</span>
    <span class="s1">Py_XDECREF(closure);</span>
    <span class="s1">Py_XDECREF(modname);</span>
    <span class="s2">return </span><span class="s1">NULL;</span>
<span class="s1">}</span>

<span class="s0">/* 
 * Python-facing wrapper for Numba-compiled generator. 
 * Note the Environment's offset inside the struct is the same as in the 
 * Closure object.  This is required to simplify generation of Python wrappers. 
 */</span>

<span class="s2">typedef void </span><span class="s1">(*gen_finalizer_t)(</span><span class="s2">void </span><span class="s1">*);</span>

<span class="s2">typedef struct </span><span class="s1">{</span>
    <span class="s1">CLOSURE_HEAD</span>
    <span class="s1">PyCFunctionWithKeywords nextfunc;</span>
    <span class="s1">gen_finalizer_t finalizer;</span>
    <span class="s1">PyObject *weakreflist;</span>
    <span class="s2">union </span><span class="s1">{</span>
        <span class="s2">double </span><span class="s1">dummy;   </span><span class="s0">/* Force alignment */</span>
        <span class="s2">char </span><span class="s1">state[</span><span class="s5">0</span><span class="s1">];</span>
    <span class="s1">};</span>
<span class="s1">} GeneratorObject;</span>

<span class="s2">static int</span>
<span class="s1">generator_traverse(GeneratorObject *gen, visitproc visit, </span><span class="s2">void </span><span class="s1">*arg)</span>
<span class="s1">{</span>
    <span class="s0">/* XXX this doesn't traverse the state, which can own references to 
       PyObjects */</span>
    <span class="s1">Py_VISIT(gen</span><span class="s4">-&gt;</span><span class="s1">env);</span>
    <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">static int</span>
<span class="s1">generator_clear(GeneratorObject *gen)</span>
<span class="s1">{</span>
    <span class="s2">if </span><span class="s1">(gen</span><span class="s4">-&gt;</span><span class="s1">finalizer != NULL) {</span>
        <span class="s1">gen</span><span class="s4">-&gt;</span><span class="s1">finalizer(gen</span><span class="s4">-&gt;</span><span class="s1">state);</span>
        <span class="s1">gen</span><span class="s4">-&gt;</span><span class="s1">finalizer = NULL;</span>
    <span class="s1">}</span>
    <span class="s1">Py_CLEAR(gen</span><span class="s4">-&gt;</span><span class="s1">env);</span>
    <span class="s1">gen</span><span class="s4">-&gt;</span><span class="s1">nextfunc = NULL;</span>
    <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">static void</span>
<span class="s1">generator_dealloc(GeneratorObject *gen)</span>
<span class="s1">{</span>
    <span class="s1">PyObject_GC_UnTrack((PyObject *) gen);</span>
    <span class="s2">if </span><span class="s1">(gen</span><span class="s4">-&gt;</span><span class="s1">weakreflist != NULL)</span>
        <span class="s1">PyObject_ClearWeakRefs((PyObject *) gen);</span>
    <span class="s0">/* XXX The finalizer may be called after the LLVM module has been 
       destroyed (typically at interpreter shutdown) */</span>
    <span class="s2">if </span><span class="s1">(!_Py_IsFinalizing())</span>
        <span class="s2">if </span><span class="s1">(gen</span><span class="s4">-&gt;</span><span class="s1">finalizer != NULL)</span>
            <span class="s1">gen</span><span class="s4">-&gt;</span><span class="s1">finalizer(gen</span><span class="s4">-&gt;</span><span class="s1">state);</span>
    <span class="s1">Py_XDECREF(gen</span><span class="s4">-&gt;</span><span class="s1">env);</span>
    <span class="s1">Py_TYPE(gen)</span><span class="s4">-&gt;</span><span class="s1">tp_free((PyObject *) gen);</span>
<span class="s1">}</span>

<span class="s2">static </span><span class="s1">PyObject *</span>
<span class="s1">generator_iternext(GeneratorObject *gen)</span>
<span class="s1">{</span>
    <span class="s1">PyObject *res, *args;</span>
    <span class="s2">if </span><span class="s1">(gen</span><span class="s4">-&gt;</span><span class="s1">nextfunc == NULL) {</span>
        <span class="s1">PyErr_SetString(PyExc_RuntimeError,</span>
                        <span class="s3">&quot;cannot call next() on finalized generator&quot;</span><span class="s1">);</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">}</span>
    <span class="s1">args = PyTuple_Pack(</span><span class="s5">1</span><span class="s1">, (PyObject *) gen);</span>
    <span class="s2">if </span><span class="s1">(args == NULL)</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">res = (*gen</span><span class="s4">-&gt;</span><span class="s1">nextfunc)((PyObject *) gen, args, NULL);</span>
    <span class="s1">Py_DECREF(args);</span>
    <span class="s2">return </span><span class="s1">res;</span>
<span class="s1">}</span>

<span class="s2">static </span><span class="s1">PyTypeObject GeneratorType = {</span>
    <span class="s1">PyVarObject_HEAD_INIT(NULL, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s3">&quot;_dynfunc._Generator&quot;</span><span class="s1">,                    </span><span class="s0">/* tp_name*/</span>
    <span class="s1">offsetof(GeneratorObject, state),         </span><span class="s0">/* tp_basicsize*/</span>
    <span class="s5">1</span><span class="s1">,                                        </span><span class="s0">/* tp_itemsize*/</span>
    <span class="s1">(destructor) generator_dealloc,           </span><span class="s0">/* tp_dealloc*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_vectorcall_offset*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_getattr*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_setattr*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_as_async*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_repr*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_as_number*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_as_sequence*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_as_mapping*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_hash */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_call*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_str*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_getattro*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_setattro*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_as_buffer*/</span>
    <span class="s1">Py_TPFLAGS_DEFAULT | Py_TPFLAGS_HAVE_GC</span>
                       <span class="s1">| Py_TPFLAGS_BASETYPE, </span><span class="s0">/* tp_flags*/</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_doc */</span>
    <span class="s1">(traverseproc) generator_traverse,        </span><span class="s0">/* tp_traverse */</span>
    <span class="s1">(inquiry) generator_clear,                </span><span class="s0">/* tp_clear */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_richcompare */</span>
    <span class="s1">offsetof(GeneratorObject, weakreflist),   </span><span class="s0">/* tp_weaklistoffset */</span>
    <span class="s1">PyObject_SelfIter,                        </span><span class="s0">/* tp_iter */</span>
    <span class="s1">(iternextfunc) generator_iternext,        </span><span class="s0">/* tp_iternext */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_methods */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_members */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_getset */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_base */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_dict */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_descr_get */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_descr_set */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_dictoffset */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_init */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_alloc */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_new */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_free */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_is_gc */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_bases */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_mro */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_cache */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_subclasses */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_weaklist */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_del */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_version_tag */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_finalize */</span>
    <span class="s5">0</span><span class="s1">,                                        </span><span class="s0">/* tp_vectorcall */</span>
<span class="s2">#if </span><span class="s1">(PY_MAJOR_VERSION == </span><span class="s5">3</span><span class="s1">) &amp;&amp; (PY_MINOR_VERSION == </span><span class="s5">12</span><span class="s1">)</span>
<span class="s0">/* This was introduced first in 3.12 
 * https://github.com/python/cpython/issues/91051 
 */</span>
    <span class="s5">0</span><span class="s1">,                                           </span><span class="s0">/* tp_watched */</span>
<span class="s2">#endif</span>

<span class="s0">/* WARNING: Do not remove this, only modify it! It is a version guard to 
 * act as a reminder to update this struct on Python version update! */</span>
<span class="s2">#if </span><span class="s1">(PY_MAJOR_VERSION == </span><span class="s5">3</span><span class="s1">)</span>
<span class="s2">#if </span><span class="s1">! ((PY_MINOR_VERSION == </span><span class="s5">9</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">10</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">11</span><span class="s1">) || (PY_MINOR_VERSION == </span><span class="s5">12</span><span class="s1">))</span>
<span class="s2">#error </span><span class="s3">&quot;Python minor version is not supported.&quot;</span>
<span class="s2">#endif</span>
<span class="s2">#else</span>
<span class="s2">#error </span><span class="s3">&quot;Python major version is not supported.&quot;</span>
<span class="s2">#endif</span>
<span class="s0">/* END WARNING*/</span>
<span class="s1">};</span>

<span class="s0">/* Dynamically create a new generator object */</span>
<span class="s2">static </span><span class="s1">PyObject *</span>
<span class="s1">Numba_make_generator(Py_ssize_t gen_state_size,</span>
                     <span class="s2">void </span><span class="s1">*initial_state,</span>
                     <span class="s1">PyCFunctionWithKeywords nextfunc,</span>
                     <span class="s1">gen_finalizer_t finalizer,</span>
                     <span class="s1">EnvironmentObject *env)</span>
<span class="s1">{</span>
    <span class="s1">GeneratorObject *gen;</span>
    <span class="s1">gen = (GeneratorObject *) PyType_GenericAlloc(&amp;GeneratorType, gen_state_size);</span>
    <span class="s2">if </span><span class="s1">(gen == NULL)</span>
        <span class="s2">return </span><span class="s1">NULL;</span>
    <span class="s1">memcpy(gen</span><span class="s4">-&gt;</span><span class="s1">state, initial_state, gen_state_size);</span>
    <span class="s1">gen</span><span class="s4">-&gt;</span><span class="s1">nextfunc = nextfunc;</span>
    <span class="s1">Py_XINCREF(env);</span>
    <span class="s1">gen</span><span class="s4">-&gt;</span><span class="s1">env = env;</span>
    <span class="s1">gen</span><span class="s4">-&gt;</span><span class="s1">finalizer = finalizer;</span>
    <span class="s2">return </span><span class="s1">(PyObject *) gen;</span>
<span class="s1">}</span>

<span class="s0">/* Initialization subroutine for use by modules including this */</span>
<span class="s2">static int</span>
<span class="s1">init_dynfunc_module(PyObject *module)</span>
<span class="s1">{</span>
    <span class="s2">if </span><span class="s1">(PyType_Ready(&amp;ClosureType))</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s5">1</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(PyType_Ready(&amp;EnvironmentType))</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s5">1</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(PyType_Ready(&amp;GeneratorType))</span>
        <span class="s2">return </span><span class="s1">-</span><span class="s5">1</span><span class="s1">;</span>
    <span class="s2">return </span><span class="s5">0</span><span class="s1">;</span>
<span class="s1">}</span>
</pre>
</body>
</html>