<html>
<head>
<title>atlas.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
atlas.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
Atlas 
===== 
 
.. versionadded:: 1.1.0 
 
Atlas manages texture atlases: packing multiple textures into 
one. With it, you reduce the number of images loaded and speedup the 
application loading. This module contains both the Atlas class and command line 
processing for creating an atlas from a set of individual PNG files. The 
command line section requires the Pillow library, or the defunct Python Imaging 
Library (PIL), to be installed. 
 
An Atlas is composed of 2 or more files: 
    - a json file (.atlas) that contains the image file names and texture 
      locations of the atlas. 
    - one or multiple image files containing textures referenced by the .atlas 
      file. 
 
Definition of .atlas files 
-------------------------- 
 
A file with ``&lt;basename&gt;.atlas`` is a json file formatted like this:: 
 
    { 
        &quot;&lt;basename&gt;-&lt;index&gt;.png&quot;: { 
            &quot;id1&quot;: [ &lt;x&gt;, &lt;y&gt;, &lt;width&gt;, &lt;height&gt; ], 
            &quot;id2&quot;: [ &lt;x&gt;, &lt;y&gt;, &lt;width&gt;, &lt;height&gt; ], 
            # ... 
        }, 
        # ... 
    } 
 
Example from the Kivy ``data/images/defaulttheme.atlas``:: 
 
    { 
        &quot;defaulttheme-0.png&quot;: { 
            &quot;progressbar_background&quot;: [431, 224, 59, 24], 
            &quot;image-missing&quot;: [253, 344, 48, 48], 
            &quot;filechooser_selected&quot;: [1, 207, 118, 118], 
            &quot;bubble_btn&quot;: [83, 174, 32, 32], 
            # ... and more ... 
        } 
    } 
 
In this example, &quot;defaulttheme-0.png&quot; is a large image, with the pixels in the 
rectangle from (431, 224) to (431 + 59, 224 + 24) usable as 
``atlas://data/images/defaulttheme/progressbar_background`` in 
any image parameter. 
 
How to create an Atlas 
---------------------- 
 
.. warning:: 
 
    The atlas creation requires the Pillow library (or the defunct Imaging/PIL 
    library). This requirement will be removed in the future when the Kivy core 
    Image is able to support loading, blitting, and saving operations. 
 
You can directly use this module to create atlas files with this command:: 
 
    $ python -m kivy.atlas &lt;basename&gt; &lt;size&gt; &lt;list of images...&gt; 
 
 
Let's say you have a list of images that you want to put into an Atlas. The 
directory is named ``images`` with lots of 64x64 png files inside:: 
 
    $ ls 
    images 
    $ cd images 
    $ ls 
    bubble.png bubble-red.png button.png button-down.png 
 
You can combine all the png's into one and generate the atlas file with:: 
 
    $ python -m kivy.atlas myatlas 256x256 *.png 
    Atlas created at myatlas.atlas 
    1 image has been created 
    $ ls 
    bubble.png bubble-red.png button.png button-down.png myatlas.atlas 
    myatlas-0.png 
 
As you can see, we get 2 new files: ``myatlas.atlas`` and ``myatlas-0.png``. 
``myatlas-0.png`` is a new 256x256 .png composed of all your images. If the 
size you specify is not large enough to fit all of the source images, more 
atlas images will be created as required e.g. ``myatlas-1.png``, 
``myatlas-2.png`` etc. 
 
.. note:: 
 
    When using this script, the ids referenced in the atlas are the base names 
    of the images without the extension. So, if you are going to name a file 
    ``../images/button.png``, the id for this image will be ``button``. 
 
    If you need path information included, you should include ``use_path`` as 
    follows:: 
 
        $ python -m kivy.atlas -- --use_path myatlas 256 *.png 
 
    In which case the id for ``../images/button.png`` will be ``images_button`` 
 
 
How to use an Atlas 
------------------- 
 
Usually, you would specify the images by supplying the path:: 
 
    a = Button(background_normal='images/button.png', 
               background_down='images/button_down.png') 
 
In our previous example, we have created the atlas containing both images and 
put them in ``images/myatlas.atlas``. You can use url notation to reference 
them:: 
 
    a = Button(background_normal='atlas://images/myatlas/button', 
               background_down='atlas://images/myatlas/button_down') 
 
In other words, the path to the images is replaced by:: 
 
    atlas://path/to/myatlas/id 
    # will search for the ``path/to/myatlas.atlas`` and get the image ``id`` 
 
.. note:: 
 
    In the atlas url, there is no need to add the ``.atlas`` extension. It will 
    be automatically append to the filename. 
 
Manual usage of the Atlas 
------------------------- 
 
:: 
 
    &gt;&gt;&gt; from kivy.atlas import Atlas 
    &gt;&gt;&gt; atlas = Atlas('path/to/myatlas.atlas') 
    &gt;&gt;&gt; print(atlas.textures.keys()) 
    ['bubble', 'bubble-red', 'button', 'button-down'] 
    &gt;&gt;&gt; print(atlas['button']) 
    &lt;kivy.graphics.texture.TextureRegion object at 0x2404d10&gt; 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'Atlas'</span><span class="s2">, )</span>

<span class="s4">import </span><span class="s1">json</span>
<span class="s4">from </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path </span><span class="s4">import </span><span class="s1">basename</span><span class="s2">, </span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">join</span><span class="s2">, </span><span class="s1">splitext</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">event </span><span class="s4">import </span><span class="s1">EventDispatcher</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">logger </span><span class="s4">import </span><span class="s1">Logger</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">AliasProperty</span><span class="s2">, </span><span class="s1">DictProperty</span><span class="s2">, </span><span class="s1">ListProperty</span>
<span class="s4">import </span><span class="s1">os</span>


<span class="s5"># late import to prevent recursion</span>
<span class="s1">CoreImage </span><span class="s2">= </span><span class="s4">None</span>


<span class="s4">class </span><span class="s1">Atlas</span><span class="s2">(</span><span class="s1">EventDispatcher</span><span class="s2">):</span>
    <span class="s0">'''Manage texture atlas. See module documentation for more information. 
    '''</span>

    <span class="s1">original_textures </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([])</span>
    <span class="s3">'''List of original atlas textures (which contain the :attr:`textures`). 
 
    :attr:`original_textures` is a :class:`~kivy.properties.ListProperty` and 
    defaults to []. 
 
    .. versionadded:: 1.9.1 
    '''</span>

    <span class="s1">textures </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s3">'''List of available textures within the atlas. 
 
    :attr:`textures` is a :class:`~kivy.properties.DictProperty` and defaults 
    to {}. 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_filename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_filename</span>

    <span class="s1">filename </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_filename</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
    <span class="s3">'''Filename of the current Atlas. 
 
    :attr:`filename` is an :class:`~kivy.properties.AliasProperty` and defaults 
    to None. 
    '''</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_filename </span><span class="s2">= </span><span class="s1">filename</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Atlas</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">textures</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">_load</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># late import to prevent recursive import.</span>
        <span class="s4">global </span><span class="s1">CoreImage</span>
        <span class="s4">if </span><span class="s1">CoreImage </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">image </span><span class="s4">import </span><span class="s1">Image </span><span class="s4">as </span><span class="s1">CoreImage</span>

        <span class="s5"># must be a name finished by .atlas ?</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_filename</span>
        <span class="s4">assert </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'.atlas'</span><span class="s2">)</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">)</span>

        <span class="s1">Logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">'Atlas: Load &lt;%s&gt;' </span><span class="s2">% </span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s4">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">) </span><span class="s4">as </span><span class="s1">fd</span><span class="s2">:</span>
            <span class="s1">meta </span><span class="s2">= </span><span class="s1">json</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">)</span>

        <span class="s1">Logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">'Atlas: Need to load %d images' </span><span class="s2">% </span><span class="s1">len</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">))</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s1">textures </span><span class="s2">= {}</span>
        <span class="s4">for </span><span class="s1">subfilename</span><span class="s2">, </span><span class="s1">ids </span><span class="s4">in </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">subfilename </span><span class="s2">= </span><span class="s1">join</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">subfilename</span><span class="s2">)</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s3">'Atlas: Load &lt;%s&gt;' </span><span class="s2">% </span><span class="s1">subfilename</span><span class="s2">)</span>

            <span class="s5"># load the image</span>
            <span class="s1">ci </span><span class="s2">= </span><span class="s1">CoreImage</span><span class="s2">(</span><span class="s1">subfilename</span><span class="s2">)</span>
            <span class="s1">atlas_texture </span><span class="s2">= </span><span class="s1">ci</span><span class="s2">.</span><span class="s1">texture</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">original_textures</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">atlas_texture</span><span class="s2">)</span>

            <span class="s5"># for all the uid, load the image, get the region, and put</span>
            <span class="s5"># it in our dict.</span>
            <span class="s4">for </span><span class="s1">meta_id</span><span class="s2">, </span><span class="s1">meta_coords </span><span class="s4">in </span><span class="s1">ids</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">meta_coords</span>
                <span class="s1">textures</span><span class="s2">[</span><span class="s1">meta_id</span><span class="s2">] = </span><span class="s1">atlas_texture</span><span class="s2">.</span><span class="s1">get_region</span><span class="s2">(*</span><span class="s1">meta_coords</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">textures </span><span class="s2">= </span><span class="s1">textures</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s4">def </span><span class="s1">create</span><span class="s2">(</span><span class="s1">outname</span><span class="s2">, </span><span class="s1">filenames</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">padding</span><span class="s2">=</span><span class="s6">2</span><span class="s2">, </span><span class="s1">use_path</span><span class="s2">=</span><span class="s4">False</span><span class="s2">):</span>
        <span class="s0">'''This method can be used to create an atlas manually from a set of 
        images. 
 
        :Parameters: 
            `outname`: str 
                Basename to use for ``.atlas`` creation and ``-&lt;idx&gt;.png`` 
                associated images. 
            `filenames`: list 
                List of filenames to put in the atlas. 
            `size`: int or list (width, height) 
                Size of the atlas image. If the size is not large enough to 
                fit all of the source images, more atlas images will created 
                as required. 
            `padding`: int, defaults to 2 
                Padding to put around each image. 
 
                Be careful. If you're using a padding &lt; 2, you might have 
                issues with the borders of the images. Because of the OpenGL 
                linearization, it might use the pixels of the adjacent image. 
 
                If you're using a padding &gt;= 2, we'll automatically generate a 
                &quot;border&quot; of 1px around your image. If you look at 
                the result, don't be scared if the image inside is not 
                exactly the same as yours :). 
 
            `use_path`: bool, defaults to False 
                If True, the relative path of the source png 
                file names will be included in the atlas ids rather 
                that just in the file names. Leading dots and slashes will be 
                excluded and all other slashes in the path will be replaced 
                with underscores. For example, if `use_path` is False 
                (the default) and the file name is 
                ``../data/tiles/green_grass.png``, the id will be 
                ``green_grass``. If `use_path` is True, it will be 
                ``data_tiles_green_grass``. 
 
            .. versionchanged:: 1.8.0 
                Parameter use_path added 
        '''</span>
        <span class="s5"># Thanks to</span>
        <span class="s5"># omnisaurusgames.com/2011/06/texture-atlas-generation-using-python/</span>
        <span class="s5"># for its initial implementation.</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">from </span><span class="s1">PIL </span><span class="s4">import </span><span class="s1">Image</span>
        <span class="s4">except </span><span class="s1">ImportError</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">critical</span><span class="s2">(</span><span class="s3">'Atlas: Imaging/PIL are missing'</span><span class="s2">)</span>
            <span class="s4">raise</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">size</span><span class="s2">, (</span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)):</span>
            <span class="s1">size_w</span><span class="s2">, </span><span class="s1">size_h </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">int</span><span class="s2">, </span><span class="s1">size</span><span class="s2">))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">size_w </span><span class="s2">= </span><span class="s1">size_h </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>

        <span class="s5"># open all of the images</span>
        <span class="s1">ims </span><span class="s2">= </span><span class="s1">list</span><span class="s2">()</span>
        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">filenames</span><span class="s2">:</span>
            <span class="s1">fp </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s3">'rb'</span><span class="s2">)</span>
            <span class="s1">im </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)</span>
            <span class="s1">im</span><span class="s2">.</span><span class="s1">load</span><span class="s2">()</span>
            <span class="s1">fp</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s1">ims</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">f</span><span class="s2">, </span><span class="s1">im</span><span class="s2">))</span>

        <span class="s5"># sort by image area</span>
        <span class="s1">ims </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">ims</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">lambda </span><span class="s1">im</span><span class="s2">: </span><span class="s1">im</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">size</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] * </span><span class="s1">im</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">size</span><span class="s2">[</span><span class="s6">1</span><span class="s2">],</span>
                     <span class="s1">reverse</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>

        <span class="s5"># free boxes are empty space in our output image set</span>
        <span class="s5"># the freebox tuple format is: outidx, x, y, w, h</span>
        <span class="s1">freeboxes </span><span class="s2">= [(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">size_w</span><span class="s2">, </span><span class="s1">size_h</span><span class="s2">)]</span>
        <span class="s1">numoutimages </span><span class="s2">= </span><span class="s6">1</span>

        <span class="s5"># full boxes are areas where we have placed images in the atlas</span>
        <span class="s5"># the full box tuple format is: image, outidx, x, y, w, h, filename</span>
        <span class="s1">fullboxes </span><span class="s2">= []</span>

        <span class="s5"># do the actual atlasing by sticking the largest images we can</span>
        <span class="s5"># have into the smallest valid free boxes</span>
        <span class="s4">for </span><span class="s1">imageinfo </span><span class="s4">in </span><span class="s1">ims</span><span class="s2">:</span>
            <span class="s1">im </span><span class="s2">= </span><span class="s1">imageinfo</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>
            <span class="s1">imw</span><span class="s2">, </span><span class="s1">imh </span><span class="s2">= </span><span class="s1">im</span><span class="s2">.</span><span class="s1">size</span>
            <span class="s1">imw </span><span class="s2">+= </span><span class="s1">padding</span>
            <span class="s1">imh </span><span class="s2">+= </span><span class="s1">padding</span>
            <span class="s4">if </span><span class="s1">imw </span><span class="s2">&gt; </span><span class="s1">size_w </span><span class="s4">or </span><span class="s1">imh </span><span class="s2">&gt; </span><span class="s1">size_h</span><span class="s2">:</span>
                <span class="s1">Logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span>
                    <span class="s3">'Atlas: image %s (%d by %d) is larger than the atlas size!'</span>
                    <span class="s2">% (</span><span class="s1">imageinfo</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">imw</span><span class="s2">, </span><span class="s1">imh</span><span class="s2">))</span>
                <span class="s4">return</span>

            <span class="s1">inserted </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">while not </span><span class="s1">inserted</span><span class="s2">:</span>
                <span class="s4">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">fb </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">freeboxes</span><span class="s2">):</span>
                    <span class="s5"># find the smallest free box that will contain this image</span>
                    <span class="s4">if </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">3</span><span class="s2">] &gt;= </span><span class="s1">imw </span><span class="s4">and </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">4</span><span class="s2">] &gt;= </span><span class="s1">imh</span><span class="s2">:</span>
                        <span class="s5"># we found a valid spot! Remove the current</span>
                        <span class="s5"># freebox, and split the leftover space into (up to)</span>
                        <span class="s5"># two new freeboxes</span>
                        <span class="s4">del </span><span class="s1">freeboxes</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
                        <span class="s4">if </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">3</span><span class="s2">] &gt; </span><span class="s1">imw</span><span class="s2">:</span>
                            <span class="s1">freeboxes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span>
                                <span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] + </span><span class="s1">imw</span><span class="s2">, </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">2</span><span class="s2">],</span>
                                <span class="s1">fb</span><span class="s2">[</span><span class="s6">3</span><span class="s2">] - </span><span class="s1">imw</span><span class="s2">, </span><span class="s1">imh</span><span class="s2">))</span>

                        <span class="s4">if </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">4</span><span class="s2">] &gt; </span><span class="s1">imh</span><span class="s2">:</span>
                            <span class="s1">freeboxes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span>
                                <span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">1</span><span class="s2">], </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">2</span><span class="s2">] + </span><span class="s1">imh</span><span class="s2">,</span>
                                <span class="s1">fb</span><span class="s2">[</span><span class="s6">3</span><span class="s2">], </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">4</span><span class="s2">] - </span><span class="s1">imh</span><span class="s2">))</span>

                        <span class="s5"># keep this sorted!</span>
                        <span class="s1">freeboxes </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">freeboxes</span><span class="s2">,</span>
                                           <span class="s1">key</span><span class="s2">=</span><span class="s4">lambda </span><span class="s1">fb</span><span class="s2">: </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">3</span><span class="s2">] * </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">4</span><span class="s2">])</span>
                        <span class="s1">fullboxes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">im</span><span class="s2">,</span>
                                          <span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] + </span><span class="s1">padding</span><span class="s2">,</span>
                                          <span class="s1">fb</span><span class="s2">[</span><span class="s6">2</span><span class="s2">] + </span><span class="s1">padding</span><span class="s2">, </span><span class="s1">imw </span><span class="s2">- </span><span class="s1">padding</span><span class="s2">,</span>
                                          <span class="s1">imh </span><span class="s2">- </span><span class="s1">padding</span><span class="s2">, </span><span class="s1">imageinfo</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]))</span>
                        <span class="s1">inserted </span><span class="s2">= </span><span class="s4">True</span>
                        <span class="s4">break</span>

                <span class="s4">if not </span><span class="s1">inserted</span><span class="s2">:</span>
                    <span class="s5"># oh crap - there isn't room in any of our free</span>
                    <span class="s5"># boxes, so we have to add a new output image</span>
                    <span class="s1">freeboxes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">numoutimages</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">size_w</span><span class="s2">, </span><span class="s1">size_h</span><span class="s2">))</span>
                    <span class="s1">numoutimages </span><span class="s2">+= </span><span class="s6">1</span>

        <span class="s5"># now that we've figured out where everything goes, make the output</span>
        <span class="s5"># images and blit the source images to the appropriate locations</span>
        <span class="s1">Logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">'Atlas: create an {0}x{1} rgba image'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">size_w</span><span class="s2">,</span>
                                                                 <span class="s1">size_h</span><span class="s2">))</span>
        <span class="s1">outimages </span><span class="s2">= [</span><span class="s1">Image</span><span class="s2">.</span><span class="s1">new</span><span class="s2">(</span><span class="s3">'RGBA'</span><span class="s2">, (</span><span class="s1">size_w</span><span class="s2">, </span><span class="s1">size_h</span><span class="s2">))</span>
                     <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">numoutimages</span><span class="s2">))]</span>
        <span class="s4">for </span><span class="s1">fb </span><span class="s4">in </span><span class="s1">fullboxes</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">3</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">outimages</span><span class="s2">[</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]]</span>
            <span class="s1">out</span><span class="s2">.</span><span class="s1">paste</span><span class="s2">(</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], (</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">2</span><span class="s2">], </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">3</span><span class="s2">]))</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">size</span>
            <span class="s4">if </span><span class="s1">padding </span><span class="s2">&gt; </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">out</span><span class="s2">.</span><span class="s1">paste</span><span class="s2">(</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">crop</span><span class="s2">((</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)), (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">- </span><span class="s6">1</span><span class="s2">))</span>
                <span class="s1">out</span><span class="s2">.</span><span class="s1">paste</span><span class="s2">(</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">crop</span><span class="s2">((</span><span class="s6">0</span><span class="s2">, </span><span class="s1">h </span><span class="s2">- </span><span class="s6">1</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)), (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">h</span><span class="s2">))</span>
                <span class="s1">out</span><span class="s2">.</span><span class="s1">paste</span><span class="s2">(</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">crop</span><span class="s2">((</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)), (</span><span class="s1">x </span><span class="s2">- </span><span class="s6">1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
                <span class="s1">out</span><span class="s2">.</span><span class="s1">paste</span><span class="s2">(</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">crop</span><span class="s2">((</span><span class="s1">w </span><span class="s2">- </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)), (</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">w</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>

        <span class="s5"># save the output images</span>
        <span class="s4">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">outimage </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">outimages</span><span class="s2">):</span>
            <span class="s1">outimage</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s3">'%s-%d.png' </span><span class="s2">% (</span><span class="s1">outname</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">))</span>

        <span class="s5"># write out an json file that says where everything ended up</span>
        <span class="s1">meta </span><span class="s2">= {}</span>
        <span class="s4">for </span><span class="s1">fb </span><span class="s4">in </span><span class="s1">fullboxes</span><span class="s2">:</span>
            <span class="s1">fn </span><span class="s2">= </span><span class="s3">'%s-%d.png' </span><span class="s2">% (</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">outname</span><span class="s2">), </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>
            <span class="s4">if </span><span class="s1">fn </span><span class="s4">not in </span><span class="s1">meta</span><span class="s2">:</span>
                <span class="s1">d </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">[</span><span class="s1">fn</span><span class="s2">] = {}</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">d </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">[</span><span class="s1">fn</span><span class="s2">]</span>

            <span class="s5"># fb[6] contain the filename</span>
            <span class="s4">if </span><span class="s1">use_path</span><span class="s2">:</span>
                <span class="s5"># use the path with separators replaced by _</span>
                <span class="s5"># example '../data/tiles/green_grass.png' becomes</span>
                <span class="s5"># 'data_tiles_green_grass'</span>
                <span class="s1">uid </span><span class="s2">= </span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">6</span><span class="s2">])[</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s5"># remove leading dots and slashes</span>
                <span class="s1">uid </span><span class="s2">= </span><span class="s1">uid</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s3">'./</span><span class="s4">\\</span><span class="s3">'</span><span class="s2">)</span>
                <span class="s5"># replace remaining slashes with _</span>
                <span class="s1">uid </span><span class="s2">= </span><span class="s1">uid</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">, </span><span class="s3">'_'</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s3">'_'</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># for example, '../data/tiles/green_grass.png'</span>
                <span class="s5"># just get only 'green_grass' as the uniq id.</span>
                <span class="s1">uid </span><span class="s2">= </span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">fb</span><span class="s2">[</span><span class="s6">6</span><span class="s2">]))[</span><span class="s6">0</span><span class="s2">]</span>

            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">fb</span><span class="s2">[</span><span class="s6">2</span><span class="s2">:</span><span class="s6">6</span><span class="s2">]</span>
            <span class="s1">d</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">] = </span><span class="s1">x</span><span class="s2">, </span><span class="s1">size_h </span><span class="s2">- </span><span class="s1">y </span><span class="s2">- </span><span class="s1">h</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span>

        <span class="s1">outfn </span><span class="s2">= </span><span class="s3">'%s.atlas' </span><span class="s2">% </span><span class="s1">outname</span>
        <span class="s4">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">outfn</span><span class="s2">, </span><span class="s3">'w'</span><span class="s2">) </span><span class="s4">as </span><span class="s1">fd</span><span class="s2">:</span>
            <span class="s1">json</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">, </span><span class="s1">fd</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">outfn</span><span class="s2">, </span><span class="s1">meta</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; Main line program. Process command line arguments 
    to make a new atlas. &quot;&quot;&quot;</span>

    <span class="s4">import </span><span class="s1">sys</span>
    <span class="s4">from </span><span class="s1">glob </span><span class="s4">import </span><span class="s1">glob</span>
    <span class="s1">argv </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]</span>
    <span class="s5"># earlier import of kivy has already called getopt to remove kivy system</span>
    <span class="s5"># arguments from this line. That is all arguments up to the first '--'</span>
    <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">) &lt; </span><span class="s6">3</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'Usage: python -m kivy.atlas [-- [--use-path] '</span>
              <span class="s3">'[--padding=2]] &lt;outname&gt; '</span>
              <span class="s3">'&lt;size|512x256&gt; &lt;img1.png&gt; [&lt;img2.png&gt;, ...]'</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s1">options </span><span class="s2">= {</span><span class="s3">'use_path'</span><span class="s2">: </span><span class="s4">False</span><span class="s2">}</span>
    <span class="s4">while True</span><span class="s2">:</span>
        <span class="s1">option </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">option </span><span class="s2">== </span><span class="s3">'--use-path'</span><span class="s2">:</span>
            <span class="s1">options</span><span class="s2">[</span><span class="s3">'use_path'</span><span class="s2">] = </span><span class="s4">True</span>
        <span class="s4">elif </span><span class="s1">option</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'--padding='</span><span class="s2">):</span>
            <span class="s1">options</span><span class="s2">[</span><span class="s3">'padding'</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">option</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)[-</span><span class="s6">1</span><span class="s2">])</span>
        <span class="s4">elif </span><span class="s1">option</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">] == </span><span class="s3">'--'</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">'Unknown option {}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">option</span><span class="s2">))</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">break</span>
        <span class="s1">argv </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]</span>

    <span class="s1">outname </span><span class="s2">= </span><span class="s1">argv</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
    <span class="s4">try</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s3">'x' </span><span class="s4">in </span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]:</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">int</span><span class="s2">, </span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'x'</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>
    <span class="s4">except </span><span class="s1">ValueError</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'Error: size must be an integer or &lt;integer&gt;x&lt;integer&gt;'</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s1">filenames </span><span class="s2">= [</span><span class="s1">fname </span><span class="s4">for </span><span class="s1">fnames </span><span class="s4">in </span><span class="s1">argv</span><span class="s2">[</span><span class="s6">2</span><span class="s2">:] </span><span class="s4">for </span><span class="s1">fname </span><span class="s4">in </span><span class="s1">glob</span><span class="s2">(</span><span class="s1">fnames</span><span class="s2">)]</span>
    <span class="s1">ret </span><span class="s2">= </span><span class="s1">Atlas</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">outname</span><span class="s2">, </span><span class="s1">filenames</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>
    <span class="s4">if not </span><span class="s1">ret</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">'Error while creating atlas!'</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s1">fn</span><span class="s2">, </span><span class="s1">meta </span><span class="s2">= </span><span class="s1">ret</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">'Atlas created at'</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">'%d image%s been created' </span><span class="s2">% (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">),</span>
          <span class="s3">'s have' </span><span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">) &gt; </span><span class="s6">1 </span><span class="s4">else </span><span class="s3">' has'</span><span class="s2">))</span>
</pre>
</body>
</html>