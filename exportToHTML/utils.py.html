<html>
<head>
<title>utils.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
utils.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">atexit</span>
<span class="s0">import </span><span class="s1">builtins</span>
<span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">timeit</span>
<span class="s0">import </span><span class="s1">math</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">traceback</span>
<span class="s0">import </span><span class="s1">weakref</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">typing </span><span class="s0">as </span><span class="s1">_tp</span>

<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">ModuleType</span>
<span class="s0">from </span><span class="s1">importlib </span><span class="s0">import </span><span class="s1">import_module</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">inspect </span><span class="s0">import </span><span class="s1">signature </span><span class="s0">as </span><span class="s1">pysignature </span><span class="s2"># noqa: F401</span>
<span class="s0">from </span><span class="s1">inspect </span><span class="s0">import </span><span class="s1">Signature </span><span class="s0">as </span><span class="s1">pySignature </span><span class="s2"># noqa: F401</span>
<span class="s0">from </span><span class="s1">inspect </span><span class="s0">import </span><span class="s1">Parameter </span><span class="s0">as </span><span class="s1">pyParameter </span><span class="s2"># noqa: F401</span>

<span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">config </span><span class="s0">import </span><span class="s3">(</span><span class="s1">PYVERSION</span><span class="s3">, </span><span class="s1">MACHINE_BITS</span><span class="s3">, </span><span class="s2"># noqa: F401</span>
                               <span class="s1">DEVELOPER_MODE</span><span class="s3">) </span><span class="s2"># noqa: F401</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">config</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">types</span>

<span class="s0">from </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Mapping</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">, </span><span class="s1">MutableSet</span><span class="s3">, </span><span class="s1">MutableMapping</span>


<span class="s0">def </span><span class="s1">erase_traceback</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Erase the traceback and hanging locals from the given exception instance. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">__traceback__ </span><span class="s0">is not None</span><span class="s3">:</span>
        <span class="s1">traceback</span><span class="s3">.</span><span class="s1">clear_frames</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">__traceback__</span><span class="s3">)</span>
    <span class="s0">return </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">with_traceback</span><span class="s3">(</span><span class="s0">None</span><span class="s3">)</span>


<span class="s0">def </span><span class="s1">safe_relpath</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s1">os</span><span class="s3">.</span><span class="s1">curdir</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Produces a &quot;safe&quot; relative path, on windows relpath doesn't work across 
    drives as technically they don't share the same root. 
    See: https://bugs.python.org/issue7195 for details. 
    &quot;&quot;&quot;</span>
    <span class="s2"># find the drive letters for path and start and if they are not the same</span>
    <span class="s2"># then don't use relpath!</span>
    <span class="s1">drive_letter </span><span class="s3">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitdrive</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">drive_path </span><span class="s3">= </span><span class="s1">drive_letter</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
    <span class="s1">drive_start </span><span class="s3">= </span><span class="s1">drive_letter</span><span class="s3">(</span><span class="s1">start</span><span class="s3">)</span>
    <span class="s0">if </span><span class="s1">drive_path </span><span class="s3">!= </span><span class="s1">drive_start</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
    <span class="s0">else</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s1">start</span><span class="s3">)</span>


<span class="s2"># Mapping between operator module functions and the corresponding built-in</span>
<span class="s2"># operators.</span>

<span class="s1">BINOPS_TO_OPERATORS </span><span class="s3">= {</span>
    <span class="s6">'+'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">add</span><span class="s3">,</span>
    <span class="s6">'-'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">,</span>
    <span class="s6">'*'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">mul</span><span class="s3">,</span>
    <span class="s6">'//'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">floordiv</span><span class="s3">,</span>
    <span class="s6">'/'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">truediv</span><span class="s3">,</span>
    <span class="s6">'%'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">mod</span><span class="s3">,</span>
    <span class="s6">'**'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">pow</span><span class="s3">,</span>
    <span class="s6">'&amp;'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">,</span>
    <span class="s6">'|'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">,</span>
    <span class="s6">'^'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">xor</span><span class="s3">,</span>
    <span class="s6">'&lt;&lt;'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">lshift</span><span class="s3">,</span>
    <span class="s6">'&gt;&gt;'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">rshift</span><span class="s3">,</span>
    <span class="s6">'=='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">eq</span><span class="s3">,</span>
    <span class="s6">'!='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ne</span><span class="s3">,</span>
    <span class="s6">'&lt;'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">lt</span><span class="s3">,</span>
    <span class="s6">'&lt;='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">le</span><span class="s3">,</span>
    <span class="s6">'&gt;'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">gt</span><span class="s3">,</span>
    <span class="s6">'&gt;='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ge</span><span class="s3">,</span>
    <span class="s6">'is'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">is_</span><span class="s3">,</span>
    <span class="s6">'is not'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">is_not</span><span class="s3">,</span>
    <span class="s2"># This one has its args reversed!</span>
    <span class="s6">'in'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">,</span>
    <span class="s6">'@'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">matmul</span><span class="s3">,</span>
<span class="s3">}</span>

<span class="s1">INPLACE_BINOPS_TO_OPERATORS </span><span class="s3">= {</span>
    <span class="s6">'+='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">iadd</span><span class="s3">,</span>
    <span class="s6">'-='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">isub</span><span class="s3">,</span>
    <span class="s6">'*='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">imul</span><span class="s3">,</span>
    <span class="s6">'//='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ifloordiv</span><span class="s3">,</span>
    <span class="s6">'/='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">itruediv</span><span class="s3">,</span>
    <span class="s6">'%='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">imod</span><span class="s3">,</span>
    <span class="s6">'**='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ipow</span><span class="s3">,</span>
    <span class="s6">'&amp;='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">iand</span><span class="s3">,</span>
    <span class="s6">'|='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ior</span><span class="s3">,</span>
    <span class="s6">'^='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ixor</span><span class="s3">,</span>
    <span class="s6">'&lt;&lt;='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">ilshift</span><span class="s3">,</span>
    <span class="s6">'&gt;&gt;='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">irshift</span><span class="s3">,</span>
    <span class="s6">'@='</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">imatmul</span><span class="s3">,</span>
<span class="s3">}</span>


<span class="s1">ALL_BINOPS_TO_OPERATORS </span><span class="s3">= {**</span><span class="s1">BINOPS_TO_OPERATORS</span><span class="s3">,</span>
                           <span class="s3">**</span><span class="s1">INPLACE_BINOPS_TO_OPERATORS</span><span class="s3">}</span>


<span class="s1">UNARY_BUITINS_TO_OPERATORS </span><span class="s3">= {</span>
    <span class="s6">'+'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">,</span>
    <span class="s6">'-'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">neg</span><span class="s3">,</span>
    <span class="s6">'~'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">invert</span><span class="s3">,</span>
    <span class="s6">'not'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">,</span>
    <span class="s6">'is_true'</span><span class="s3">: </span><span class="s1">operator</span><span class="s3">.</span><span class="s1">truth</span>
<span class="s3">}</span>

<span class="s1">OPERATORS_TO_BUILTINS </span><span class="s3">= {</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">add</span><span class="s3">: </span><span class="s6">'+'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">iadd</span><span class="s3">: </span><span class="s6">'+='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">: </span><span class="s6">'-'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">isub</span><span class="s3">: </span><span class="s6">'-='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">mul</span><span class="s3">: </span><span class="s6">'*'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">imul</span><span class="s3">: </span><span class="s6">'*='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">floordiv</span><span class="s3">: </span><span class="s6">'//'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">ifloordiv</span><span class="s3">: </span><span class="s6">'//='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">truediv</span><span class="s3">: </span><span class="s6">'/'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">itruediv</span><span class="s3">: </span><span class="s6">'/='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">mod</span><span class="s3">: </span><span class="s6">'%'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">imod</span><span class="s3">: </span><span class="s6">'%='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">pow</span><span class="s3">: </span><span class="s6">'**'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">ipow</span><span class="s3">: </span><span class="s6">'**='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">: </span><span class="s6">'&amp;'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">iand</span><span class="s3">: </span><span class="s6">'&amp;='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">: </span><span class="s6">'|'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">ior</span><span class="s3">: </span><span class="s6">'|='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">xor</span><span class="s3">: </span><span class="s6">'^'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">ixor</span><span class="s3">: </span><span class="s6">'^='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">lshift</span><span class="s3">: </span><span class="s6">'&lt;&lt;'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">ilshift</span><span class="s3">: </span><span class="s6">'&lt;&lt;='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">rshift</span><span class="s3">: </span><span class="s6">'&gt;&gt;'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">irshift</span><span class="s3">: </span><span class="s6">'&gt;&gt;='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">eq</span><span class="s3">: </span><span class="s6">'=='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">ne</span><span class="s3">: </span><span class="s6">'!='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">lt</span><span class="s3">: </span><span class="s6">'&lt;'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">le</span><span class="s3">: </span><span class="s6">'&lt;='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">gt</span><span class="s3">: </span><span class="s6">'&gt;'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">ge</span><span class="s3">: </span><span class="s6">'&gt;='</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">is_</span><span class="s3">: </span><span class="s6">'is'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">is_not</span><span class="s3">: </span><span class="s6">'is not'</span><span class="s3">,</span>
    <span class="s2"># This one has its args reversed!</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">: </span><span class="s6">'in'</span><span class="s3">,</span>
    <span class="s2"># Unary</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">: </span><span class="s6">'+'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">neg</span><span class="s3">: </span><span class="s6">'-'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">invert</span><span class="s3">: </span><span class="s6">'~'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">: </span><span class="s6">'not'</span><span class="s3">,</span>
    <span class="s1">operator</span><span class="s3">.</span><span class="s1">truth</span><span class="s3">: </span><span class="s6">'is_true'</span><span class="s3">,</span>
<span class="s3">}</span>


<span class="s1">_shutting_down </span><span class="s3">= </span><span class="s0">False</span>


<span class="s0">def </span><span class="s1">_at_shutdown</span><span class="s3">():</span>
    <span class="s0">global </span><span class="s1">_shutting_down</span>
    <span class="s1">_shutting_down </span><span class="s3">= </span><span class="s0">True</span>


<span class="s0">def </span><span class="s1">shutting_down</span><span class="s3">(</span><span class="s1">globals</span><span class="s3">=</span><span class="s1">globals</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Whether the interpreter is currently shutting down. 
    For use in finalizers, __del__ methods, and similar; it is advised 
    to early bind this function rather than look it up when calling it, 
    since at shutdown module globals may be cleared. 
    &quot;&quot;&quot;</span>
    <span class="s2"># At shutdown, the attribute may have been cleared or set to None.</span>
    <span class="s1">v </span><span class="s3">= </span><span class="s1">globals</span><span class="s3">().</span><span class="s1">get</span><span class="s3">(</span><span class="s6">'_shutting_down'</span><span class="s3">)</span>
    <span class="s0">return </span><span class="s1">v </span><span class="s0">is True or </span><span class="s1">v </span><span class="s0">is None</span>


<span class="s2"># weakref.finalize registers an exit function that runs all finalizers for</span>
<span class="s2"># which atexit is True. Some of these finalizers may call shutting_down() to</span>
<span class="s2"># check whether the interpreter is shutting down. For this to behave correctly,</span>
<span class="s2"># we need to make sure that _at_shutdown is called before the finalizer exit</span>
<span class="s2"># function. Since atexit operates as a LIFO stack, we first construct a dummy</span>
<span class="s2"># finalizer then register atexit to ensure this ordering.</span>
<span class="s1">weakref</span><span class="s3">.</span><span class="s1">finalize</span><span class="s3">(</span><span class="s0">lambda</span><span class="s3">: </span><span class="s0">None</span><span class="s3">, </span><span class="s0">lambda</span><span class="s3">: </span><span class="s0">None</span><span class="s3">)</span>
<span class="s1">atexit</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s1">_at_shutdown</span><span class="s3">)</span>


<span class="s1">_old_style_deprecation_msg </span><span class="s3">= (</span>
    <span class="s6">&quot;Code using Numba extension API maybe depending on 'old_style' &quot;</span>
    <span class="s6">&quot;error-capturing, which is deprecated and will be replaced by 'new_style' &quot;</span>
    <span class="s6">&quot;in the next release. See details at &quot;</span>
    <span class="s6">&quot;https://numba.readthedocs.io/en/latest/reference/deprecation.html#deprecation-of-old-style-numba-captured-errors&quot; </span><span class="s2"># noqa: E501</span>
<span class="s3">)</span>


<span class="s0">def </span><span class="s1">_warn_old_style</span><span class="s3">():</span>
    <span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">errors  </span><span class="s2"># to prevent circular import</span>

    <span class="s1">exccls</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">tb </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">exc_info</span><span class="s3">()</span>
    <span class="s2"># Warn only if the active exception is not a NumbaError</span>
    <span class="s2"># and not a NumbaWarning which is raised if -Werror is set.</span>
    <span class="s1">numba_errs </span><span class="s3">= (</span><span class="s1">errors</span><span class="s3">.</span><span class="s1">NumbaError</span><span class="s3">, </span><span class="s1">errors</span><span class="s3">.</span><span class="s1">NumbaWarning</span><span class="s3">)</span>
    <span class="s0">if </span><span class="s1">exccls </span><span class="s0">is not None and not </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">exccls</span><span class="s3">, </span><span class="s1">numba_errs</span><span class="s3">):</span>
        <span class="s1">tb_last </span><span class="s3">= </span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">format_tb</span><span class="s3">(</span><span class="s1">tb</span><span class="s3">)[-</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">_old_style_deprecation_msg</span><span class="s0">}\n</span><span class="s6">Exception origin:</span><span class="s0">\n{</span><span class="s1">tb_last</span><span class="s0">}</span><span class="s6">&quot;</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">,</span>
                      <span class="s1">errors</span><span class="s3">.</span><span class="s1">NumbaDeprecationWarning</span><span class="s3">)</span>


<span class="s0">def </span><span class="s1">use_new_style_errors</span><span class="s3">():</span>
    <span class="s4">&quot;&quot;&quot;Returns True if new style errors are to be used, false otherwise&quot;&quot;&quot;</span>
    <span class="s2"># This uses `config` so as to make sure it gets the current value from the</span>
    <span class="s2"># module as e.g. some tests mutate the config with `override_config`.</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">CAPTURED_ERRORS </span><span class="s3">== </span><span class="s6">'new_style'</span>
    <span class="s0">if not </span><span class="s1">res</span><span class="s3">:</span>
        <span class="s1">_warn_old_style</span><span class="s3">()</span>
    <span class="s0">return </span><span class="s1">res</span>


<span class="s0">def </span><span class="s1">use_old_style_errors</span><span class="s3">():</span>
    <span class="s4">&quot;&quot;&quot;Returns True if old style errors are to be used, false otherwise&quot;&quot;&quot;</span>
    <span class="s2"># This uses `config` so as to make sure it gets the current value from the</span>
    <span class="s2"># module as e.g. some tests mutate the config with `override_config`.</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">CAPTURED_ERRORS </span><span class="s3">== </span><span class="s6">'old_style'</span>
    <span class="s0">if </span><span class="s1">res</span><span class="s3">:</span>
        <span class="s1">_warn_old_style</span><span class="s3">()</span>
    <span class="s0">return </span><span class="s1">res</span>


<span class="s0">class </span><span class="s1">ThreadLocalStack</span><span class="s3">:</span>
    <span class="s4">&quot;&quot;&quot;A TLS stack container. 
 
    Uses the BORG pattern and stores states in threadlocal storage. 
    &quot;&quot;&quot;</span>
    <span class="s1">_tls </span><span class="s3">= </span><span class="s1">threading</span><span class="s3">.</span><span class="s1">local</span><span class="s3">()</span>
    <span class="s1">stack_name</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">_registered </span><span class="s3">= {}</span>

    <span class="s0">def </span><span class="s1">__init_subclass__</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, *, </span><span class="s1">stack_name</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init_subclass__</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2"># Register stack_name mapping to the new subclass</span>
        <span class="s0">assert </span><span class="s1">stack_name </span><span class="s0">not in </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">_registered</span><span class="s3">, </span><span class="s1">\</span>
            <span class="s6">f&quot;stack_name: '</span><span class="s0">{</span><span class="s1">stack_name</span><span class="s0">}</span><span class="s6">' already in use&quot;</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">stack_name </span><span class="s3">= </span><span class="s1">stack_name</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">_registered</span><span class="s3">[</span><span class="s1">stack_name</span><span class="s3">] = </span><span class="s1">cls</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2"># This class must not be used directly.</span>
        <span class="s0">assert </span><span class="s1">type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s0">is not </span><span class="s1">ThreadLocalStack</span>
        <span class="s1">tls </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tls</span>
        <span class="s1">attr </span><span class="s3">= </span><span class="s6">f&quot;stack_</span><span class="s0">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">stack_name</span><span class="s0">}</span><span class="s6">&quot;</span>
        <span class="s0">try</span><span class="s3">:</span>
            <span class="s1">tls_stack </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">tls</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s1">tls_stack </span><span class="s3">= </span><span class="s1">list</span><span class="s3">()</span>
            <span class="s1">setattr</span><span class="s3">(</span><span class="s1">tls</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">tls_stack</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack </span><span class="s3">= </span><span class="s1">tls_stack</span>

    <span class="s0">def </span><span class="s1">push</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Push to the stack 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">pop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Pop from the stack 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

    <span class="s0">def </span><span class="s1">top</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Get the top item on the stack. 
 
        Raises IndexError if the stack is empty. Users should check the size 
        of the stack beforehand. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stack</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">enter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">state</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;A contextmanager that pushes ``state`` for the duration of the 
        context. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">state</span><span class="s3">)</span>
        <span class="s0">try</span><span class="s3">:</span>
            <span class="s0">yield</span>
        <span class="s0">finally</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>


<span class="s0">class </span><span class="s1">ConfigOptions</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s1">OPTIONS </span><span class="s3">= {}</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_values </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">OPTIONS</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

    <span class="s0">def </span><span class="s1">set</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s0">True</span><span class="s3">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">OPTIONS</span><span class="s3">:</span>
            <span class="s0">raise </span><span class="s1">NameError</span><span class="s3">(</span><span class="s6">&quot;Invalid flag: %s&quot; </span><span class="s3">% </span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">unset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s0">False</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">_check_attr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">OPTIONS</span><span class="s3">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s3">(</span><span class="s6">&quot;Invalid flag: %s&quot; </span><span class="s3">% </span><span class="s1">name</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_attr</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]</span>

    <span class="s0">def </span><span class="s1">__setattr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s0">if </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s6">'_'</span><span class="s3">):</span>
            <span class="s1">super</span><span class="s3">(</span><span class="s1">ConfigOptions</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">__setattr__</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_attr</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s6">&quot;Flags(%s)&quot; </span><span class="s3">% </span><span class="s6">', '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s6">'%s=%s' </span><span class="s3">% (</span><span class="s1">k</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)</span>
                                       <span class="s0">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()</span>
                                       <span class="s0">if </span><span class="s1">v </span><span class="s0">is not False</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">copy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">copy </span><span class="s3">= </span><span class="s1">type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)()</span>
        <span class="s1">copy</span><span class="s3">.</span><span class="s1">_values </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s0">return </span><span class="s1">copy</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">other</span><span class="s3">, </span><span class="s1">ConfigOptions</span><span class="s3">) </span><span class="s0">and</span>
                <span class="s1">other</span><span class="s3">.</span><span class="s1">_values </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s0">return not </span><span class="s1">self </span><span class="s3">== </span><span class="s1">other</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s3">(</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">items</span><span class="s3">())))</span>


<span class="s0">def </span><span class="s1">order_by_target_specificity</span><span class="s3">(</span><span class="s1">target</span><span class="s3">, </span><span class="s1">templates</span><span class="s3">, </span><span class="s1">fnkey</span><span class="s3">=</span><span class="s6">''</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;This orders the given templates from most to least specific against the 
    current &quot;target&quot;. &quot;fnkey&quot; is an indicative typing key for use in the 
    exception message in the case that there's no usable templates for the 
    current &quot;target&quot;. 
    &quot;&quot;&quot;</span>
    <span class="s2"># No templates... return early!</span>
    <span class="s0">if </span><span class="s1">templates </span><span class="s3">== []:</span>
        <span class="s0">return </span><span class="s3">[]</span>

    <span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">target_extension </span><span class="s0">import </span><span class="s1">target_registry</span>

    <span class="s2"># fish out templates that are specific to the target if a target is</span>
    <span class="s2"># specified</span>
    <span class="s1">DEFAULT_TARGET </span><span class="s3">= </span><span class="s6">'generic'</span>
    <span class="s1">usable </span><span class="s3">= []</span>
    <span class="s0">for </span><span class="s1">ix</span><span class="s3">, </span><span class="s1">temp_cls </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">templates</span><span class="s3">):</span>
        <span class="s2"># ? Need to do something about this next line</span>
        <span class="s1">md </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">temp_cls</span><span class="s3">, </span><span class="s6">&quot;metadata&quot;</span><span class="s3">, {})</span>
        <span class="s1">hw </span><span class="s3">= </span><span class="s1">md</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">'target'</span><span class="s3">, </span><span class="s1">DEFAULT_TARGET</span><span class="s3">)</span>
        <span class="s0">if </span><span class="s1">hw </span><span class="s0">is not None</span><span class="s3">:</span>
            <span class="s1">hw_clazz </span><span class="s3">= </span><span class="s1">target_registry</span><span class="s3">[</span><span class="s1">hw</span><span class="s3">]</span>
            <span class="s0">if </span><span class="s1">target</span><span class="s3">.</span><span class="s1">inherits_from</span><span class="s3">(</span><span class="s1">hw_clazz</span><span class="s3">):</span>
                <span class="s1">usable</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">temp_cls</span><span class="s3">, </span><span class="s1">hw_clazz</span><span class="s3">, </span><span class="s1">ix</span><span class="s3">))</span>

    <span class="s2"># sort templates based on target specificity</span>
    <span class="s0">def </span><span class="s1">key</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">target</span><span class="s3">.</span><span class="s1">__mro__</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s1">order </span><span class="s3">= [</span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">usable</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)]</span>

    <span class="s0">if not </span><span class="s1">order</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= (</span><span class="s6">f&quot;Function resolution cannot find any matches for function &quot;</span>
               <span class="s6">f&quot;'</span><span class="s0">{</span><span class="s1">fnkey</span><span class="s0">}</span><span class="s6">' for the current target: '</span><span class="s0">{</span><span class="s1">target</span><span class="s0">}</span><span class="s6">'.&quot;</span><span class="s3">)</span>
        <span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">UnsupportedError</span>
        <span class="s0">raise </span><span class="s1">UnsupportedError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s0">return </span><span class="s1">order</span>


<span class="s1">T </span><span class="s3">= </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">TypeVar</span><span class="s3">(</span><span class="s6">'T'</span><span class="s3">)</span>


<span class="s0">class </span><span class="s1">OrderedSet</span><span class="s3">(</span><span class="s1">MutableSet</span><span class="s3">[</span><span class="s1">T</span><span class="s3">]):</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">iterable</span><span class="s3">: </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">Iterable</span><span class="s3">[</span><span class="s1">T</span><span class="s3">] = ()):</span>
        <span class="s2"># Just uses a dictionary under-the-hood to maintain insertion order.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_data </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">.</span><span class="s1">fromkeys</span><span class="s3">(</span><span class="s1">iterable</span><span class="s3">, </span><span class="s0">None</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__contains__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_data</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_data</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_data</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_data</span><span class="s3">[</span><span class="s1">item</span><span class="s3">] = </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">discard</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">item</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_data</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s0">None</span><span class="s3">)</span>


<span class="s0">class </span><span class="s1">MutableSortedSet</span><span class="s3">(</span><span class="s1">MutableSet</span><span class="s3">[</span><span class="s1">T</span><span class="s3">], </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">Generic</span><span class="s3">[</span><span class="s1">T</span><span class="s3">]):</span>
    <span class="s4">&quot;&quot;&quot;Mutable Sorted Set 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">values</span><span class="s3">: </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">Iterable</span><span class="s3">[</span><span class="s1">T</span><span class="s3">] = ()):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_values </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">values</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">k </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">))</span>

    <span class="s0">def </span><span class="s1">__contains__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">T</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">__contains__</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">T</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">discard</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">: </span><span class="s1">T</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">discard</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">values</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">values</span><span class="s3">)</span>


<span class="s1">Tk </span><span class="s3">= </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">TypeVar</span><span class="s3">(</span><span class="s6">'Tk'</span><span class="s3">)</span>
<span class="s1">Tv </span><span class="s3">= </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">TypeVar</span><span class="s3">(</span><span class="s6">'Tv'</span><span class="s3">)</span>


<span class="s0">class </span><span class="s1">SortedMap</span><span class="s3">(</span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">Tk</span><span class="s3">, </span><span class="s1">Tv</span><span class="s3">], </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">Generic</span><span class="s3">[</span><span class="s1">Tk</span><span class="s3">, </span><span class="s1">Tv</span><span class="s3">]):</span>
    <span class="s4">&quot;&quot;&quot;Immutable 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">seq</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_values </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_index </span><span class="s3">= {}</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s3">, (</span><span class="s1">k</span><span class="s3">, </span><span class="s1">v</span><span class="s3">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">seq</span><span class="s3">)):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_index</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">i</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">k</span><span class="s3">, </span><span class="s1">v</span><span class="s3">))</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">):</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_index</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">[</span><span class="s1">i</span><span class="s3">][</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">k </span><span class="s0">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_values</span><span class="s3">)</span>


<span class="s0">class </span><span class="s1">MutableSortedMap</span><span class="s3">(</span><span class="s1">MutableMapping</span><span class="s3">[</span><span class="s1">Tk</span><span class="s3">, </span><span class="s1">Tv</span><span class="s3">], </span><span class="s1">_tp</span><span class="s3">.</span><span class="s1">Generic</span><span class="s3">[</span><span class="s1">Tk</span><span class="s3">, </span><span class="s1">Tv</span><span class="s3">]):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dct</span><span class="s3">=</span><span class="s0">None</span><span class="s3">):</span>
        <span class="s0">if </span><span class="s1">dct </span><span class="s0">is None</span><span class="s3">:</span>
            <span class="s1">dct </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_dct</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">Tk</span><span class="s3">, </span><span class="s1">Tv</span><span class="s3">] = </span><span class="s1">dct</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">Tk</span><span class="s3">) </span><span class="s1">-&gt; Tv</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_dct</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>

    <span class="s0">def </span><span class="s1">__setitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">Tk</span><span class="s3">, </span><span class="s1">v</span><span class="s3">: </span><span class="s1">Tv</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_dct</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">v</span>

    <span class="s0">def </span><span class="s1">__delitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">: </span><span class="s1">Tk</span><span class="s3">):</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_dct</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_dct</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">k </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_dct</span><span class="s3">))</span>


<span class="s0">class </span><span class="s1">UniqueDict</span><span class="s3">(</span><span class="s1">dict</span><span class="s3">):</span>
    <span class="s0">def </span><span class="s1">__setitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s3">:</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s3">(</span><span class="s6">&quot;key already in dictionary: %r&quot; </span><span class="s3">% (</span><span class="s1">key</span><span class="s3">,))</span>
        <span class="s1">super</span><span class="s3">(</span><span class="s1">UniqueDict</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">__setitem__</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>


<span class="s0">def </span><span class="s1">runonce</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">):</span>
    <span class="s3">@</span><span class="s1">functools</span><span class="s3">.</span><span class="s1">wraps</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">)</span>
    <span class="s0">def </span><span class="s1">inner</span><span class="s3">():</span>
        <span class="s0">if not </span><span class="s1">inner</span><span class="s3">.</span><span class="s1">_ran</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">()</span>
            <span class="s1">inner</span><span class="s3">.</span><span class="s1">_result </span><span class="s3">= </span><span class="s1">res</span>
            <span class="s1">inner</span><span class="s3">.</span><span class="s1">_ran </span><span class="s3">= </span><span class="s0">True</span>
        <span class="s0">return </span><span class="s1">inner</span><span class="s3">.</span><span class="s1">_result</span>

    <span class="s1">inner</span><span class="s3">.</span><span class="s1">_ran </span><span class="s3">= </span><span class="s0">False</span>
    <span class="s0">return </span><span class="s1">inner</span>


<span class="s0">def </span><span class="s1">bit_length</span><span class="s3">(</span><span class="s1">intval</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Return the number of bits necessary to represent integer `intval`. 
    &quot;&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">intval</span><span class="s3">, </span><span class="s1">int</span><span class="s3">)</span>
    <span class="s0">if </span><span class="s1">intval </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">bin</span><span class="s3">(</span><span class="s1">intval</span><span class="s3">)) - </span><span class="s5">2</span>
    <span class="s0">else</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">bin</span><span class="s3">(-</span><span class="s1">intval </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)) - </span><span class="s5">2</span>


<span class="s0">def </span><span class="s1">stream_list</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Given a list, return an infinite iterator of iterators. 
    Each iterator iterates over the list from the last seen point up to 
    the current end-of-list. 
 
    In effect, each iterator will give the newly appended elements from the 
    previous iterator instantiation time. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">sublist_iterator</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">[</span><span class="s1">start</span><span class="s3">:</span><span class="s1">stop</span><span class="s3">])</span>

    <span class="s1">start </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s0">while True</span><span class="s3">:</span>
        <span class="s1">stop </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">)</span>
        <span class="s0">yield </span><span class="s1">sublist_iterator</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">)</span>
        <span class="s1">start </span><span class="s3">= </span><span class="s1">stop</span>


<span class="s0">class </span><span class="s1">BenchmarkResult</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">records</span><span class="s3">, </span><span class="s1">loop</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">func </span><span class="s3">= </span><span class="s1">func</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">loop </span><span class="s3">= </span><span class="s1">loop</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">records </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">records</span><span class="s3">) / </span><span class="s1">loop</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">best </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">records</span><span class="s3">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">func</span><span class="s3">, </span><span class="s6">&quot;__name__&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">func</span><span class="s3">)</span>
        <span class="s1">args </span><span class="s3">= (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">loop</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">records</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s1">format_time</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">best</span><span class="s3">))</span>
        <span class="s0">return </span><span class="s6">&quot;%20s: %10d loops, best of %d: %s per loop&quot; </span><span class="s3">% </span><span class="s1">args</span>


<span class="s0">def </span><span class="s1">format_time</span><span class="s3">(</span><span class="s1">tm</span><span class="s3">):</span>
    <span class="s1">units </span><span class="s3">= </span><span class="s6">&quot;s ms us ns ps&quot;</span><span class="s3">.</span><span class="s1">split</span><span class="s3">()</span>
    <span class="s1">base </span><span class="s3">= </span><span class="s5">1</span>
    <span class="s0">for </span><span class="s1">unit </span><span class="s0">in </span><span class="s1">units</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]:</span>
        <span class="s0">if </span><span class="s1">tm </span><span class="s3">&gt;= </span><span class="s1">base</span><span class="s3">:</span>
            <span class="s0">break</span>
        <span class="s1">base </span><span class="s3">/= </span><span class="s5">1000</span>
    <span class="s0">else</span><span class="s3">:</span>
        <span class="s1">unit </span><span class="s3">= </span><span class="s1">units</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]</span>
    <span class="s0">return </span><span class="s6">&quot;%.1f%s&quot; </span><span class="s3">% (</span><span class="s1">tm </span><span class="s3">/ </span><span class="s1">base</span><span class="s3">, </span><span class="s1">unit</span><span class="s3">)</span>


<span class="s0">def </span><span class="s1">benchmark</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">maxsec</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
    <span class="s1">timer </span><span class="s3">= </span><span class="s1">timeit</span><span class="s3">.</span><span class="s1">Timer</span><span class="s3">(</span><span class="s1">func</span><span class="s3">)</span>
    <span class="s1">number </span><span class="s3">= </span><span class="s5">1</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">timer</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">number</span><span class="s3">)</span>
    <span class="s2"># Too fast to be measured</span>
    <span class="s0">while </span><span class="s1">min</span><span class="s3">(</span><span class="s1">result</span><span class="s3">) / </span><span class="s1">number </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
        <span class="s1">number </span><span class="s3">*= </span><span class="s5">10</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">timer</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">number</span><span class="s3">)</span>
    <span class="s1">best </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">result</span><span class="s3">) / </span><span class="s1">number</span>
    <span class="s0">if </span><span class="s1">best </span><span class="s3">&gt;= </span><span class="s1">maxsec</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">BenchmarkResult</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">number</span><span class="s3">)</span>
        <span class="s2"># Scale it up to make it close the maximum time</span>
    <span class="s1">max_per_run_time </span><span class="s3">= </span><span class="s1">maxsec </span><span class="s3">/ </span><span class="s5">3 </span><span class="s3">/ </span><span class="s1">number</span>
    <span class="s1">number </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">max_per_run_time </span><span class="s3">/ </span><span class="s1">best </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2"># Round to the next power of 10</span>
    <span class="s1">number </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s5">10 </span><span class="s3">** </span><span class="s1">math</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">log10</span><span class="s3">(</span><span class="s1">number</span><span class="s3">)))</span>
    <span class="s1">records </span><span class="s3">= </span><span class="s1">timer</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">number</span><span class="s3">)</span>
    <span class="s0">return </span><span class="s1">BenchmarkResult</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">records</span><span class="s3">, </span><span class="s1">number</span><span class="s3">)</span>


<span class="s2"># A dummy module for dynamically-generated functions</span>
<span class="s1">_dynamic_modname </span><span class="s3">= </span><span class="s6">'&lt;dynamic&gt;'</span>
<span class="s1">_dynamic_module </span><span class="s3">= </span><span class="s1">ModuleType</span><span class="s3">(</span><span class="s1">_dynamic_modname</span><span class="s3">)</span>
<span class="s1">_dynamic_module</span><span class="s3">.</span><span class="s1">__builtins__ </span><span class="s3">= </span><span class="s1">builtins</span>


<span class="s0">def </span><span class="s1">chain_exception</span><span class="s3">(</span><span class="s1">new_exc</span><span class="s3">, </span><span class="s1">old_exc</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;Set the __cause__ attribute on *new_exc* for explicit exception 
    chaining.  Returns the inplace modified *new_exc*. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">DEVELOPER_MODE</span><span class="s3">:</span>
        <span class="s1">new_exc</span><span class="s3">.</span><span class="s1">__cause__ </span><span class="s3">= </span><span class="s1">old_exc</span>
    <span class="s0">return </span><span class="s1">new_exc</span>


<span class="s0">def </span><span class="s1">get_nargs_range</span><span class="s3">(</span><span class="s1">pyfunc</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;Return the minimal and maximal number of Python function 
    positional arguments. 
    &quot;&quot;&quot;</span>
    <span class="s1">sig </span><span class="s3">= </span><span class="s1">pysignature</span><span class="s3">(</span><span class="s1">pyfunc</span><span class="s3">)</span>
    <span class="s1">min_nargs </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s1">max_nargs </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">parameters</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
        <span class="s1">max_nargs </span><span class="s3">+= </span><span class="s5">1</span>
        <span class="s0">if </span><span class="s1">p</span><span class="s3">.</span><span class="s1">default </span><span class="s3">== </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">_empty</span><span class="s3">:</span>
            <span class="s1">min_nargs </span><span class="s3">+= </span><span class="s5">1</span>
    <span class="s0">return </span><span class="s1">min_nargs</span><span class="s3">, </span><span class="s1">max_nargs</span>


<span class="s0">def </span><span class="s1">unify_function_types</span><span class="s3">(</span><span class="s1">numba_types</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;Return a normalized tuple of Numba function types so that 
 
        Tuple(numba_types) 
 
    becomes 
 
        UniTuple(dtype=&lt;unified function type&gt;, count=len(numba_types)) 
 
    If the above transformation would be incorrect, return the 
    original input as given. For instance, if the input tuple contains 
    types that are not function or dispatcher type, the transformation 
    is considered incorrect. 
    &quot;&quot;&quot;</span>
    <span class="s1">dtype </span><span class="s3">= </span><span class="s1">unified_function_type</span><span class="s3">(</span><span class="s1">numba_types</span><span class="s3">)</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s0">is None</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">numba_types</span>
    <span class="s0">return </span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">,) * </span><span class="s1">len</span><span class="s3">(</span><span class="s1">numba_types</span><span class="s3">)</span>


<span class="s0">def </span><span class="s1">unified_function_type</span><span class="s3">(</span><span class="s1">numba_types</span><span class="s3">, </span><span class="s1">require_precise</span><span class="s3">=</span><span class="s0">True</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;Returns a unified Numba function type if possible. 
 
    Parameters 
    ---------- 
    numba_types : Sequence of numba Type instances. 
    require_precise : bool 
      If True, the returned Numba function type must be precise. 
 
    Returns 
    ------- 
    typ : {numba.core.types.Type, None} 
      A unified Numba function type. Or ``None`` when the Numba types 
      cannot be unified, e.g. when the ``numba_types`` contains at 
      least two different Numba function type instances. 
 
    If ``numba_types`` contains a Numba dispatcher type, the unified 
    Numba function type will be an imprecise ``UndefinedFunctionType`` 
    instance, or None when ``require_precise=True`` is specified. 
 
    Specifying ``require_precise=False`` enables unifying imprecise 
    Numba dispatcher instances when used in tuples or if-then branches 
    when the precise Numba function cannot be determined on the first 
    occurrence that is not a call expression. 
    &quot;&quot;&quot;</span>
    <span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">NumbaExperimentalFeatureWarning</span>

    <span class="s0">if not </span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">numba_types</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">) </span><span class="s0">and</span>
            <span class="s1">len</span><span class="s3">(</span><span class="s1">numba_types</span><span class="s3">) &gt; </span><span class="s5">0 </span><span class="s0">and</span>
            <span class="s1">isinstance</span><span class="s3">(</span><span class="s1">numba_types</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],</span>
                       <span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">Dispatcher</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">))):</span>
        <span class="s0">return</span>

    <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s6">&quot;First-class function type feature is experimental&quot;</span><span class="s3">,</span>
                  <span class="s1">category</span><span class="s3">=</span><span class="s1">NumbaExperimentalFeatureWarning</span><span class="s3">)</span>

    <span class="s1">mnargs</span><span class="s3">, </span><span class="s1">mxargs </span><span class="s3">= </span><span class="s0">None</span><span class="s3">, </span><span class="s0">None</span>
    <span class="s1">dispatchers </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s1">function </span><span class="s3">= </span><span class="s0">None</span>
    <span class="s1">undefined_function </span><span class="s3">= </span><span class="s0">None</span>

    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">numba_types</span><span class="s3">:</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">Dispatcher</span><span class="s3">):</span>
            <span class="s1">mnargs1</span><span class="s3">, </span><span class="s1">mxargs1 </span><span class="s3">= </span><span class="s1">get_nargs_range</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">dispatcher</span><span class="s3">.</span><span class="s1">py_func</span><span class="s3">)</span>
            <span class="s0">if </span><span class="s1">mnargs </span><span class="s0">is None</span><span class="s3">:</span>
                <span class="s1">mnargs</span><span class="s3">, </span><span class="s1">mxargs </span><span class="s3">= </span><span class="s1">mnargs1</span><span class="s3">, </span><span class="s1">mxargs1</span>
            <span class="s0">elif not </span><span class="s3">(</span><span class="s1">mnargs</span><span class="s3">, </span><span class="s1">mxargs</span><span class="s3">) == (</span><span class="s1">mnargs1</span><span class="s3">, </span><span class="s1">mxargs1</span><span class="s3">):</span>
                <span class="s0">return</span>
            <span class="s1">dispatchers</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">dispatcher</span><span class="s3">)</span>
            <span class="s1">t </span><span class="s3">= </span><span class="s1">t</span><span class="s3">.</span><span class="s1">dispatcher</span><span class="s3">.</span><span class="s1">get_function_type</span><span class="s3">()</span>
            <span class="s0">if </span><span class="s1">t </span><span class="s0">is None</span><span class="s3">:</span>
                <span class="s0">continue</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">):</span>
            <span class="s0">if </span><span class="s1">mnargs </span><span class="s0">is None</span><span class="s3">:</span>
                <span class="s1">mnargs </span><span class="s3">= </span><span class="s1">mxargs </span><span class="s3">= </span><span class="s1">t</span><span class="s3">.</span><span class="s1">nargs</span>
            <span class="s0">elif not </span><span class="s3">(</span><span class="s1">mnargs </span><span class="s3">== </span><span class="s1">mxargs </span><span class="s3">== </span><span class="s1">t</span><span class="s3">.</span><span class="s1">nargs</span><span class="s3">):</span>
                <span class="s0">return</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">UndefinedFunctionType</span><span class="s3">):</span>
                <span class="s0">if </span><span class="s1">undefined_function </span><span class="s0">is None</span><span class="s3">:</span>
                    <span class="s1">undefined_function </span><span class="s3">= </span><span class="s1">t</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s2"># Refuse to unify using function type</span>
                    <span class="s0">return</span>
                <span class="s1">dispatchers</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">dispatchers</span><span class="s3">)</span>
            <span class="s0">else</span><span class="s3">:</span>
                <span class="s0">if </span><span class="s1">function </span><span class="s0">is None</span><span class="s3">:</span>
                    <span class="s1">function </span><span class="s3">= </span><span class="s1">t</span>
                <span class="s0">else</span><span class="s3">:</span>
                    <span class="s0">assert </span><span class="s1">function </span><span class="s3">== </span><span class="s1">t</span>
        <span class="s0">else</span><span class="s3">:</span>
            <span class="s0">return</span>
    <span class="s0">if </span><span class="s1">require_precise </span><span class="s0">and </span><span class="s3">(</span><span class="s1">function </span><span class="s0">is None or </span><span class="s1">undefined_function </span><span class="s0">is not None</span><span class="s3">):</span>
        <span class="s0">return</span>
    <span class="s0">if </span><span class="s1">function </span><span class="s0">is not None</span><span class="s3">:</span>
        <span class="s0">if </span><span class="s1">undefined_function </span><span class="s0">is not None</span><span class="s3">:</span>
            <span class="s0">assert </span><span class="s1">function</span><span class="s3">.</span><span class="s1">nargs </span><span class="s3">== </span><span class="s1">undefined_function</span><span class="s3">.</span><span class="s1">nargs</span>
            <span class="s1">function </span><span class="s3">= </span><span class="s1">undefined_function</span>
    <span class="s0">elif </span><span class="s1">undefined_function </span><span class="s0">is not None</span><span class="s3">:</span>
        <span class="s1">undefined_function</span><span class="s3">.</span><span class="s1">dispatchers</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">dispatchers</span><span class="s3">)</span>
        <span class="s1">function </span><span class="s3">= </span><span class="s1">undefined_function</span>
    <span class="s0">else</span><span class="s3">:</span>
        <span class="s1">function </span><span class="s3">= </span><span class="s1">types</span><span class="s3">.</span><span class="s1">UndefinedFunctionType</span><span class="s3">(</span><span class="s1">mnargs</span><span class="s3">, </span><span class="s1">dispatchers</span><span class="s3">)</span>

    <span class="s0">return </span><span class="s1">function</span>


<span class="s0">class </span><span class="s1">_RedirectSubpackage</span><span class="s3">(</span><span class="s1">ModuleType</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;Redirect a subpackage to a subpackage. 
 
    This allows all references like: 
 
    &gt;&gt;&gt; from numba.old_subpackage import module 
    &gt;&gt;&gt; module.item 
 
    &gt;&gt;&gt; import numba.old_subpackage.module 
    &gt;&gt;&gt; numba.old_subpackage.module.item 
 
    &gt;&gt;&gt; from numba.old_subpackage.module import item 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">old_module_locals</span><span class="s3">, </span><span class="s1">new_module</span><span class="s3">):</span>
        <span class="s1">old_module </span><span class="s3">= </span><span class="s1">old_module_locals</span><span class="s3">[</span><span class="s6">'__name__'</span><span class="s3">]</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">old_module</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">__old_module_states </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">__new_module </span><span class="s3">= </span><span class="s1">new_module</span>

        <span class="s1">new_mod_obj </span><span class="s3">= </span><span class="s1">import_module</span><span class="s3">(</span><span class="s1">new_module</span><span class="s3">)</span>

        <span class="s2"># Map all sub-modules over</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">new_mod_obj</span><span class="s3">.</span><span class="s1">__dict__</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2"># Get attributes so that `subpackage.xyz` and</span>
            <span class="s2"># `from subpackage import xyz` work</span>
            <span class="s1">setattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">ModuleType</span><span class="s3">):</span>
                <span class="s2"># Map modules into the interpreter so that</span>
                <span class="s2"># `import subpackage.xyz` works</span>
                <span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">old_module</span><span class="s0">}</span><span class="s6">.</span><span class="s0">{</span><span class="s1">k</span><span class="s0">}</span><span class="s6">&quot;</span><span class="s3">] = </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s1">v</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">]</span>

        <span class="s2"># copy across dunders so that package imports work too</span>
        <span class="s0">for </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">old_module_locals</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s0">if </span><span class="s1">attr</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s6">'__'</span><span class="s3">) </span><span class="s0">and </span><span class="s1">attr</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s6">'__'</span><span class="s3">):</span>
                <span class="s0">if </span><span class="s1">attr </span><span class="s3">!= </span><span class="s6">&quot;__builtins__&quot;</span><span class="s3">:</span>
                    <span class="s1">setattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">__old_module_states</span><span class="s3">[</span><span class="s1">attr</span><span class="s3">] = </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__reduce__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">args </span><span class="s3">= (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__old_module_states</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__new_module</span><span class="s3">)</span>
        <span class="s0">return </span><span class="s1">_RedirectSubpackage</span><span class="s3">, </span><span class="s1">args</span>


<span class="s0">def </span><span class="s1">get_hashable_key</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot; 
        Given a value, returns a key that can be used 
        as a hash. If the value is hashable, we return 
        the value, otherwise we return id(value). 
 
        See discussion in gh #6957 
    &quot;&quot;&quot;</span>
    <span class="s0">try</span><span class="s3">:</span>
        <span class="s1">hash</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">id</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
    <span class="s0">else</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">threadsafe_cached_property</span><span class="s3">(</span><span class="s1">functools</span><span class="s3">.</span><span class="s1">cached_property</span><span class="s3">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lock </span><span class="s3">= </span><span class="s1">threading</span><span class="s3">.</span><span class="s1">RLock</span><span class="s3">()</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lock</span><span class="s3">:</span>
            <span class="s0">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">__get__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>


<span class="s0">def </span><span class="s1">dump_llvm</span><span class="s3">(</span><span class="s1">fndesc</span><span class="s3">, </span><span class="s1">module</span><span class="s3">):</span>
    <span class="s1">print</span><span class="s3">((</span><span class="s6">&quot;LLVM DUMP %s&quot; </span><span class="s3">% </span><span class="s1">fndesc</span><span class="s3">).</span><span class="s1">center</span><span class="s3">(</span><span class="s5">80</span><span class="s3">, </span><span class="s6">'-'</span><span class="s3">))</span>
    <span class="s0">if </span><span class="s1">config</span><span class="s3">.</span><span class="s1">HIGHLIGHT_DUMPS</span><span class="s3">:</span>
        <span class="s0">try</span><span class="s3">:</span>
            <span class="s0">from </span><span class="s1">pygments </span><span class="s0">import </span><span class="s1">highlight</span>
            <span class="s0">from </span><span class="s1">pygments</span><span class="s3">.</span><span class="s1">lexers </span><span class="s0">import </span><span class="s1">LlvmLexer </span><span class="s0">as </span><span class="s1">lexer</span>
            <span class="s0">from </span><span class="s1">pygments</span><span class="s3">.</span><span class="s1">formatters </span><span class="s0">import </span><span class="s1">Terminal256Formatter</span>
            <span class="s0">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">dump_style </span><span class="s0">import </span><span class="s1">by_colorscheme</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">highlight</span><span class="s3">(</span><span class="s1">module</span><span class="s3">.</span><span class="s1">__repr__</span><span class="s3">(), </span><span class="s1">lexer</span><span class="s3">(),</span>
                            <span class="s1">Terminal256Formatter</span><span class="s3">( </span><span class="s1">style</span><span class="s3">=</span><span class="s1">by_colorscheme</span><span class="s3">())))</span>
        <span class="s0">except </span><span class="s1">ImportError</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Please install pygments to see highlighted dumps&quot;</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
    <span class="s0">else</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s1">module</span><span class="s3">)</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s6">'=' </span><span class="s3">* </span><span class="s5">80</span><span class="s3">)</span>
</pre>
</body>
</html>