<html>
<head>
<title>test_intrinsics.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_intrinsics.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">cuda</span><span class="s2">, </span><span class="s1">int64</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda </span><span class="s0">import </span><span class="s1">compile_ptx</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">TypingError</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">types </span><span class="s0">import </span><span class="s1">f2</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span><span class="s1">unittest</span><span class="s2">, </span><span class="s1">CUDATestCase</span><span class="s2">, </span><span class="s1">skip_on_cudasim</span><span class="s2">,</span>
                                <span class="s1">skip_unless_cc_53</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_threadidx</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">x</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">i</span>


<span class="s0">def </span><span class="s1">fill_threadidx</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">x</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">i</span>


<span class="s0">def </span><span class="s1">fill3d_threadidx</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">x</span>
    <span class="s1">j </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">y</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">z</span>

    <span class="s1">ary</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">k</span><span class="s2">] = (</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">) * (</span><span class="s1">j </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">) * (</span><span class="s1">k </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_grid1d</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">i</span>


<span class="s0">def </span><span class="s1">simple_grid2d</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">] = </span><span class="s1">i </span><span class="s2">+ </span><span class="s1">j</span>


<span class="s0">def </span><span class="s1">simple_gridsize1d</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridsize</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">i </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
        <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">x</span>


<span class="s0">def </span><span class="s1">simple_gridsize2d</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridsize</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">i </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">j </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
        <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">x</span>
        <span class="s1">ary</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">y</span>


<span class="s0">def </span><span class="s1">intrinsic_forloop_step</span><span class="s2">(</span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">startX</span><span class="s2">, </span><span class="s1">startY </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">gridX </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridDim</span><span class="s2">.</span><span class="s1">x </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">x</span>
    <span class="s1">gridY </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridDim</span><span class="s2">.</span><span class="s1">y </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">y</span>
    <span class="s1">height</span><span class="s2">, </span><span class="s1">width </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">startX</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">gridX</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">startY</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">gridY</span><span class="s2">):</span>
            <span class="s1">c</span><span class="s2">[</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">] = </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span>


<span class="s0">def </span><span class="s1">simple_popc</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">popc</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_fma</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fma</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hadd</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hadd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hadd_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hadd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hfma</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hfma</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">c</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hfma_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hfma</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hsub</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hsub</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hsub_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hsub</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hmul</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hmul</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hmul_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hmul</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hdiv_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hdiv</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hdiv_kernel</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">array_a</span><span class="s2">, </span><span class="s1">array_b</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">ary</span><span class="s2">.</span><span class="s1">size</span><span class="s2">:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array_a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array_b</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">ary</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hdiv</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hneg</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hneg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hneg_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hneg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_habs</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">habs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_habs_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">habs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_heq_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">heq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hne_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hne</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hge_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hge</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hgt_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hgt</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hle_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hle</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hlt_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">device</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">hlt_func_1</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">device</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">hlt_func_2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multiple_hcmp_1</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s4"># float16 predicates used in two separate functions</span>
    <span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">hlt_func_1</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">and </span><span class="s1">hlt_func_2</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multiple_hcmp_2</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s4"># The same float16 predicate used in the caller and callee</span>
    <span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">hlt_func_1</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">and </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multiple_hcmp_3</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s4"># Different float16 predicates used in the caller and callee</span>
    <span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">hlt_func_1</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">and </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hge</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multiple_hcmp_4</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s4"># The same float16 predicates used twice in a function</span>
    <span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">and </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multiple_hcmp_5</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s4"># Different float16 predicates used in a function</span>
    <span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">and </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hge</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hmax_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hmax</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hmin_scalar</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hmin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_hsin</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hsin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hcos</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hcos</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hlog</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlog</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hlog2</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlog2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hlog10</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlog10</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hexp</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hexp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hexp2</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hexp2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hsqrt</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hsqrt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hrsqrt</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hrsqrt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">numpy_hrsqrt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">x </span><span class="s2">** -</span><span class="s3">0.5</span>


<span class="s0">def </span><span class="s1">simple_hceil</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hceil</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hfloor</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hfloor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hrcp</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hrcp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_htrunc</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">htrunc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_hrint</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hrint</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">simple_cbrt</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_brev</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">brev</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_clz</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">clz</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_ffs</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">ffs</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_round</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">round</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_round_to</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">round</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">branching_with_ifs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] &gt; </span><span class="s3">4</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">b </span><span class="s2">% </span><span class="s3">2 </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">c</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s3">13</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s3">3</span>


<span class="s0">def </span><span class="s1">branching_with_selps</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s1">inner </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">selp</span><span class="s2">(</span><span class="s1">b </span><span class="s2">% </span><span class="s3">2 </span><span class="s2">== </span><span class="s3">0</span><span class="s2">, </span><span class="s1">c</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s3">13</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">selp</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] &gt; </span><span class="s3">4</span><span class="s2">, </span><span class="s1">inner</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">simple_laneid</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">laneid</span>


<span class="s0">def </span><span class="s1">simple_warpsize</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">):</span>
    <span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">warpsize</span>


<span class="s0">def </span><span class="s1">nonliteral_grid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">nonliteral_gridsize</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridsize</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestCudaIntrinsic</span><span class="s2">(</span><span class="s1">CUDATestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">setUp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">setUp</span><span class="s2">()</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_threadidx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_threadidx</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fill_threadidx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:])&quot;</span><span class="s2">)(</span><span class="s1">fill_threadidx</span><span class="s2">)</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s3">10</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">ary </span><span class="s2">== </span><span class="s1">exp</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_fill3d_threadidx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Z </span><span class="s2">= </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span>

        <span class="s0">def </span><span class="s1">c_contigous</span><span class="s2">():</span>
            <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:,:,::1])&quot;</span><span class="s2">)(</span><span class="s1">fill3d_threadidx</span><span class="s2">)</span>
            <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
            <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, (</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">)](</span><span class="s1">ary</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">ary</span>

        <span class="s0">def </span><span class="s1">f_contigous</span><span class="s2">():</span>
            <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[::1,:,:])&quot;</span><span class="s2">)(</span><span class="s1">fill3d_threadidx</span><span class="s2">)</span>
            <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asfortranarray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
            <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, (</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">)](</span><span class="s1">ary</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">ary</span>

        <span class="s1">c_res </span><span class="s2">= </span><span class="s1">c_contigous</span><span class="s2">()</span>
        <span class="s1">f_res </span><span class="s2">= </span><span class="s1">f_contigous</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">c_res </span><span class="s2">== </span><span class="s1">f_res</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Cudasim does not check types'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_nonliteral_grid_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaisesRegex</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">, </span><span class="s5">'RequireLiteralValue'</span><span class="s2">):</span>
            <span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">'void(int32)'</span><span class="s2">)(</span><span class="s1">nonliteral_grid</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Cudasim does not check types'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_nonliteral_gridsize_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaisesRegex</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">, </span><span class="s5">'RequireLiteralValue'</span><span class="s2">):</span>
            <span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">'void(int32)'</span><span class="s2">)(</span><span class="s1">nonliteral_gridsize</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_grid1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[::1])&quot;</span><span class="s2">)(</span><span class="s1">simple_grid1d</span><span class="s2">)</span>
        <span class="s1">ntid</span><span class="s2">, </span><span class="s1">nctaid </span><span class="s2">= </span><span class="s3">3</span><span class="s2">, </span><span class="s3">7</span>
        <span class="s1">nelem </span><span class="s2">= </span><span class="s1">ntid </span><span class="s2">* </span><span class="s1">nctaid</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">nelem</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s1">nctaid</span><span class="s2">, </span><span class="s1">ntid</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">ary </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">nelem</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_simple_grid2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:,::1])&quot;</span><span class="s2">)(</span><span class="s1">simple_grid2d</span><span class="s2">)</span>
        <span class="s1">ntid </span><span class="s2">= (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">nctaid </span><span class="s2">= (</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">shape </span><span class="s2">= (</span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] * </span><span class="s1">nctaid</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">nctaid</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">ary</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s1">nctaid</span><span class="s2">, </span><span class="s1">ntid</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]):</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]):</span>
                <span class="s1">exp</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">] = </span><span class="s1">i </span><span class="s2">+ </span><span class="s1">j</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">ary </span><span class="s2">== </span><span class="s1">exp</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_gridsize1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[::1])&quot;</span><span class="s2">)(</span><span class="s1">simple_gridsize1d</span><span class="s2">)</span>
        <span class="s1">ntid</span><span class="s2">, </span><span class="s1">nctaid </span><span class="s2">= </span><span class="s3">3</span><span class="s2">, </span><span class="s3">7</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s1">nctaid</span><span class="s2">, </span><span class="s1">ntid</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">nctaid </span><span class="s2">* </span><span class="s1">ntid</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Requires too many threads'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_issue_9229</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Ensure that grid and grid size are correct - #9229 showed that they</span>
        <span class="s4"># overflowed an int32.</span>
        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">grid_error</span><span class="s2">, </span><span class="s1">gridsize_error</span><span class="s2">):</span>
            <span class="s1">i1 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">i2 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockIdx</span><span class="s2">.</span><span class="s1">x </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">x</span>
            <span class="s1">gs1 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridsize</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">gs2 </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">x </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridDim</span><span class="s2">.</span><span class="s1">x</span>
            <span class="s0">if </span><span class="s1">i1 </span><span class="s2">!= </span><span class="s1">i2</span><span class="s2">:</span>
                <span class="s1">grid_error</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s3">1</span>
            <span class="s0">if </span><span class="s1">gs1 </span><span class="s2">!= </span><span class="s1">gs2</span><span class="s2">:</span>
                <span class="s1">gridsize_error</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s3">1</span>

        <span class="s1">grid_error </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">)</span>
        <span class="s1">gridsize_error </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">)</span>

        <span class="s4"># A large enough grid for thread IDs to overflow an int32</span>
        <span class="s4"># (22121216 * 256 = 5663031296, which is greater than 2 ** 32)</span>
        <span class="s1">f</span><span class="s2">[</span><span class="s3">22121216</span><span class="s2">, </span><span class="s3">256</span><span class="s2">](</span><span class="s1">grid_error</span><span class="s2">, </span><span class="s1">gridsize_error</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">grid_error</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">gridsize_error</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Tests PTX emission'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_selp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sig </span><span class="s2">= (</span><span class="s1">int64</span><span class="s2">[:], </span><span class="s1">int64</span><span class="s2">, </span><span class="s1">int64</span><span class="s2">[:])</span>
        <span class="s1">cu_branching_with_ifs </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">)(</span><span class="s1">branching_with_ifs</span><span class="s2">)</span>
        <span class="s1">cu_branching_with_selps </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">)(</span><span class="s1">branching_with_selps</span><span class="s2">)</span>

        <span class="s1">n </span><span class="s2">= </span><span class="s3">32</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s3">6</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=</span><span class="s3">32</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s3">17</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">[:</span><span class="s3">5</span><span class="s2">] = </span><span class="s3">3</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">cu_branching_with_ifs</span><span class="s2">[</span><span class="s1">n</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">ptx </span><span class="s2">= </span><span class="s1">cu_branching_with_ifs</span><span class="s2">.</span><span class="s1">inspect_asm</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">re</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s5">r'\s+bra\s+'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)))</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s5">'branching'</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">cu_branching_with_selps</span><span class="s2">[</span><span class="s1">n</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">ptx </span><span class="s2">= </span><span class="s1">cu_branching_with_selps</span><span class="s2">.</span><span class="s1">inspect_asm</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">re</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s5">r'\s+bra\s+'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)))</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s5">'selp'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_gridsize2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[::1])&quot;</span><span class="s2">)(</span><span class="s1">simple_gridsize2d</span><span class="s2">)</span>
        <span class="s1">ntid </span><span class="s2">= (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">nctaid </span><span class="s2">= (</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s1">nctaid</span><span class="s2">, </span><span class="s1">ntid</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">nctaid</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] * </span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">nctaid</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_intrinsic_forloop_step</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:,::1])&quot;</span><span class="s2">)(</span><span class="s1">intrinsic_forloop_step</span><span class="s2">)</span>
        <span class="s1">ntid </span><span class="s2">= (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">nctaid </span><span class="s2">= (</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
        <span class="s1">shape </span><span class="s2">= (</span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] * </span><span class="s1">nctaid</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">nctaid</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s1">compiled</span><span class="s2">[</span><span class="s1">nctaid</span><span class="s2">, </span><span class="s1">ntid</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>

        <span class="s1">gridX</span><span class="s2">, </span><span class="s1">gridY </span><span class="s2">= </span><span class="s1">shape</span>
        <span class="s1">height</span><span class="s2">, </span><span class="s1">width </span><span class="s2">= </span><span class="s1">ary</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]), </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ntid</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])):</span>
            <span class="s1">startX</span><span class="s2">, </span><span class="s1">startY </span><span class="s2">= </span><span class="s1">gridX </span><span class="s2">+ </span><span class="s1">i</span><span class="s2">, </span><span class="s1">gridY </span><span class="s2">+ </span><span class="s1">j</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">startX</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">gridX</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">startY</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">gridY</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">] == </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">, (</span><span class="s1">ary</span><span class="s2">[</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">], </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_3dgrid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">out</span><span class="s2">):</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridsize</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">[</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b </span><span class="s2">* </span><span class="s1">c</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">9 </span><span class="s2">** </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">9</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">9</span><span class="s2">)</span>
        <span class="s1">foo</span><span class="s2">[(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)](</span><span class="s1">arr</span><span class="s2">)</span>

        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s3">9 </span><span class="s2">** </span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_3dgrid_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span>
        <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">out</span><span class="s2">):</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridsize</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
            <span class="s1">grid_is_right </span><span class="s2">= (</span>
                <span class="s1">x </span><span class="s2">== </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockIdx</span><span class="s2">.</span><span class="s1">x </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">x </span><span class="s0">and</span>
                <span class="s1">y </span><span class="s2">== </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+ </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockIdx</span><span class="s2">.</span><span class="s1">y </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">y </span><span class="s0">and</span>
                <span class="s1">z </span><span class="s2">== </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">threadIdx</span><span class="s2">.</span><span class="s1">z </span><span class="s2">+ </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockIdx</span><span class="s2">.</span><span class="s1">z </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">z</span>
            <span class="s2">)</span>
            <span class="s1">gridsize_is_right </span><span class="s2">= (</span><span class="s1">a </span><span class="s2">== </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">x </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridDim</span><span class="s2">.</span><span class="s1">x </span><span class="s0">and</span>
                                 <span class="s1">b </span><span class="s2">== </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">y </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridDim</span><span class="s2">.</span><span class="s1">y </span><span class="s0">and</span>
                                 <span class="s1">c </span><span class="s2">== </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">blockDim</span><span class="s2">.</span><span class="s1">z </span><span class="s2">* </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">gridDim</span><span class="s2">.</span><span class="s1">z</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">[</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">] = </span><span class="s1">grid_is_right </span><span class="s0">and </span><span class="s1">gridsize_is_right</span>

        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= (</span><span class="s3">4 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">* </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">x </span><span class="s2">* </span><span class="s1">y </span><span class="s2">* </span><span class="s1">z</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">foo</span><span class="s2">[(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)](</span><span class="s1">arr</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_popc_u4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], uint32)&quot;</span><span class="s2">)(</span><span class="s1">simple_popc</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0xF0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_popc_u8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], uint64)&quot;</span><span class="s2">)(</span><span class="s1">simple_popc</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0xF00000000000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fma_f4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f4[:], f4, f4, f4)&quot;</span><span class="s2">)(</span><span class="s1">simple_fma</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">2 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fma_f8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f8[:], f8, f8, f8)&quot;</span><span class="s2">)(</span><span class="s1">simple_fma</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">2 </span><span class="s2">* </span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">4</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hadd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2[:], f2[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_hadd</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">4.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg1 </span><span class="s2">+ </span><span class="s1">arg2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hadd_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hadd_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.1415926</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">arg1 </span><span class="s2">+ </span><span class="s1">arg2</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Compilation unsupported in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_hadd_ptx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">f2</span><span class="s2">[:], </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">ptx</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">compile_ptx</span><span class="s2">(</span><span class="s1">simple_hadd_scalar</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">'add.f16'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hfma</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2[:], f2[:], f2[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_hfma</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">4.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg1 </span><span class="s2">* </span><span class="s1">arg2 </span><span class="s2">+ </span><span class="s1">arg3</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hfma_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2, f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hfma_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.</span><span class="s2">)</span>
        <span class="s1">arg3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">4.</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">arg1 </span><span class="s2">* </span><span class="s1">arg2 </span><span class="s2">+ </span><span class="s1">arg3</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Compilation unsupported in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_hfma_ptx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">f2</span><span class="s2">[:], </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">ptx</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">compile_ptx</span><span class="s2">(</span><span class="s1">simple_hfma_scalar</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">'fma.rn.f16'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hsub</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2[:], f2[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_hsub</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">4.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg1 </span><span class="s2">- </span><span class="s1">arg2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hsub_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hsub_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.1415926</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">1.57</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">arg1 </span><span class="s2">- </span><span class="s1">arg2</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Compilation unsupported in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_hsub_ptx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">f2</span><span class="s2">[:], </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">ptx</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">compile_ptx</span><span class="s2">(</span><span class="s1">simple_hsub_scalar</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">'sub.f16'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hmul</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">()(</span><span class="s1">simple_hmul</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">4.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg1 </span><span class="s2">* </span><span class="s1">arg2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hmul_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hmul_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.1415926</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">1.57</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">arg1 </span><span class="s2">* </span><span class="s1">arg2</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Compilation unsupported in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_hmul_ptx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">f2</span><span class="s2">[:], </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">ptx</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">compile_ptx</span><span class="s2">(</span><span class="s1">simple_hmul_scalar</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">'mul.f16'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hdiv_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hdiv_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.1415926</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">1.57</span><span class="s2">)</span>

        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">arg1 </span><span class="s2">/ </span><span class="s1">arg2</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hdiv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2[:], f2[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_hdiv_kernel</span><span class="s2">)</span>
        <span class="s1">arry1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(-</span><span class="s3">65504</span><span class="s2">, </span><span class="s3">65505</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">500</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arry2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(-</span><span class="s3">65504</span><span class="s2">, </span><span class="s3">65505</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">500</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">arry1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>

        <span class="s1">compiled</span><span class="s2">.</span><span class="s1">forall</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arry1</span><span class="s2">, </span><span class="s1">arry2</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">arry1 </span><span class="s2">/ </span><span class="s1">arry2</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hneg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_hneg</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], -</span><span class="s1">arg1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hneg_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hneg_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.1415926</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= -</span><span class="s1">arg1</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Compilation unsupported in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_hneg_ptx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">f2</span><span class="s2">[:], </span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">ptx</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">compile_ptx</span><span class="s2">(</span><span class="s1">simple_hneg_scalar</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">'neg.f16'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_habs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">()(</span><span class="s1">simple_habs</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">3.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_habs_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_habs_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(-</span><span class="s3">3.1415926</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Compilation unsupported in the simulator'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_habs_ptx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">f2</span><span class="s2">[:], </span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">ptx</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">compile_ptx</span><span class="s2">(</span><span class="s1">simple_habs_scalar</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIn</span><span class="s2">(</span><span class="s5">'abs.f16'</span><span class="s2">, </span><span class="s1">ptx</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_fp16_intrinsics_common</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">kernels </span><span class="s2">= (</span><span class="s1">simple_hsin</span><span class="s2">, </span><span class="s1">simple_hcos</span><span class="s2">,</span>
                   <span class="s1">simple_hlog</span><span class="s2">, </span><span class="s1">simple_hlog2</span><span class="s2">, </span><span class="s1">simple_hlog10</span><span class="s2">,</span>
                   <span class="s1">simple_hsqrt</span><span class="s2">, </span><span class="s1">simple_hceil</span><span class="s2">, </span><span class="s1">simple_hfloor</span><span class="s2">,</span>
                   <span class="s1">simple_hrcp</span><span class="s2">, </span><span class="s1">simple_htrunc</span><span class="s2">, </span><span class="s1">simple_hrint</span><span class="s2">,</span>
                   <span class="s1">simple_hrsqrt</span><span class="s2">)</span>
        <span class="s1">exp_kernels </span><span class="s2">= (</span><span class="s1">simple_hexp</span><span class="s2">, </span><span class="s1">simple_hexp2</span><span class="s2">)</span>
        <span class="s1">expected_functions </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">reciprocal</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rint</span><span class="s2">,</span>
                              <span class="s1">numpy_hrsqrt</span><span class="s2">)</span>
        <span class="s1">expected_exp_functions </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp2</span><span class="s2">)</span>

        <span class="s4"># Generate random data</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s3">32</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">65505</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">N</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">fn </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">kernels</span><span class="s2">, </span><span class="s1">expected_functions</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">):</span>
                <span class="s1">kernel </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2[:])&quot;</span><span class="s2">)(</span><span class="s1">kernel</span><span class="s2">)</span>
                <span class="s1">kernel</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s1">N</span><span class="s2">](</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">fn</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">x2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">N</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">fn </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">exp_kernels</span><span class="s2">, </span><span class="s1">expected_exp_functions</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">):</span>
                <span class="s1">kernel </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2[:])&quot;</span><span class="s2">)(</span><span class="s1">kernel</span><span class="s2">)</span>
                <span class="s1">kernel</span><span class="s2">[</span><span class="s3">1</span><span class="s2">,</span><span class="s1">N</span><span class="s2">](</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">fn</span><span class="s2">(</span><span class="s1">x2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hexp10</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">()</span>
        <span class="s0">def </span><span class="s1">hexp10_vectors</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">grid</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
                <span class="s1">r</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hexp10</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>

        <span class="s4"># Generate random data</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s3">32</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">N</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s4"># Run the kernel</span>
        <span class="s1">hexp10_vectors</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">](</span><span class="s1">r</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s3">10 </span><span class="s2">** </span><span class="s1">x</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_fp16_comparison</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">fns </span><span class="s2">= (</span><span class="s1">simple_heq_scalar</span><span class="s2">, </span><span class="s1">simple_hne_scalar</span><span class="s2">, </span><span class="s1">simple_hge_scalar</span><span class="s2">,</span>
               <span class="s1">simple_hgt_scalar</span><span class="s2">, </span><span class="s1">simple_hle_scalar</span><span class="s2">, </span><span class="s1">simple_hlt_scalar</span><span class="s2">)</span>
        <span class="s1">ops </span><span class="s2">= (</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">eq</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ne</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ge</span><span class="s2">,</span>
               <span class="s1">operator</span><span class="s2">.</span><span class="s1">gt</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">le</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lt</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">op </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">fns</span><span class="s2">, </span><span class="s1">ops</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">):</span>
                <span class="s1">kernel </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(b1[:], f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">fn</span><span class="s2">)</span>

                <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
                <span class="s1">got </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
                <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
                <span class="s1">arg3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
                <span class="s1">arg4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">4</span><span class="s2">)</span>

                <span class="s4"># Check with equal arguments</span>
                <span class="s1">kernel</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">got</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">arg3</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

                <span class="s4"># Check with LHS &lt; RHS</span>
                <span class="s1">kernel</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">got</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">, </span><span class="s1">arg4</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">arg3</span><span class="s2">, </span><span class="s1">arg4</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

                <span class="s4"># Check with LHS &gt; RHS</span>
                <span class="s1">kernel</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">got</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">arg3</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_multiple_float16_comparisons</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">functions </span><span class="s2">= (</span><span class="s1">test_multiple_hcmp_1</span><span class="s2">,</span>
                     <span class="s1">test_multiple_hcmp_2</span><span class="s2">,</span>
                     <span class="s1">test_multiple_hcmp_3</span><span class="s2">,</span>
                     <span class="s1">test_multiple_hcmp_4</span><span class="s2">,</span>
                     <span class="s1">test_multiple_hcmp_5</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">fn </span><span class="s0">in </span><span class="s1">functions</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">=</span><span class="s1">fn</span><span class="s2">):</span>
                <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(b1[:], f2, f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">fn</span><span class="s2">)</span>
                <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
                <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">)</span>
                <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.</span><span class="s2">)</span>
                <span class="s1">arg3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">4.</span><span class="s2">)</span>
                <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">, </span><span class="s1">arg3</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hmax</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hmax_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">4.</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_unless_cc_53</span>
    <span class="s0">def </span><span class="s1">test_hmin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(f2[:], f2, f2)&quot;</span><span class="s2">)(</span><span class="s1">simple_hmin_scalar</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">3.</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">4.</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg1</span><span class="s2">)</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arg2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cbrt_f32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float32[:], float32)&quot;</span><span class="s2">)(</span><span class="s1">simple_cbrt</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">cbrt_arg </span><span class="s2">= </span><span class="s3">2.</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">cbrt_arg</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">cbrt_arg </span><span class="s2">** (</span><span class="s3">1 </span><span class="s2">/ </span><span class="s3">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_cbrt_f64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float64[:], float64)&quot;</span><span class="s2">)(</span><span class="s1">simple_cbrt</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">cbrt_arg </span><span class="s2">= </span><span class="s3">6.</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">cbrt_arg</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">cbrt_arg </span><span class="s2">** (</span><span class="s3">1 </span><span class="s2">/ </span><span class="s3">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_brev_u4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(uint32[:], uint32)&quot;</span><span class="s2">)(</span><span class="s1">simple_brev</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x000030F0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0x0F0C0000</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'only get given a Python &quot;int&quot;, assumes 32 bits'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_brev_u8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(uint64[:], uint64)&quot;</span><span class="s2">)(</span><span class="s1">simple_brev</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x000030F0000030F0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0x0F0C00000F0C0000</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_clz_i4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_clz</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x00100000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">11</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_clz_u4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Although the CUDA Math API 
        (http://docs.nvidia.com/cuda/cuda-math-api/group__CUDA__MATH__INTRINSIC__INT.html) 
        only says int32 &amp; int64 arguments are supported in C code, the LLVM 
        IR input supports i8, i16, i32 &amp; i64 (LLVM doesn't have a concept of 
        unsigned integers, just unsigned operations on integers). 
        http://docs.nvidia.com/cuda/nvvm-ir-spec/index.html#bit-manipulations-intrinics 
        &quot;&quot;&quot;</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], uint32)&quot;</span><span class="s2">)(</span><span class="s1">simple_clz</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x00100000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">11</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_clz_i4_1s</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_clz</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0xFFFFFFFF</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_clz_i4_0s</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_clz</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">32</span><span class="s2">, </span><span class="s5">&quot;CUDA semantics&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'only get given a Python &quot;int&quot;, assumes 32 bits'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_clz_i8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int64)&quot;</span><span class="s2">)(</span><span class="s1">simple_clz</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x000000000010000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">47</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ffs_i4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_ffs</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x00100000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">21</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x80000000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">32</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ffs_u4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], uint32)&quot;</span><span class="s2">)(</span><span class="s1">simple_ffs</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x00100000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">21</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x80000000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">32</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ffs_i4_1s</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_ffs</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0xFFFFFFFF</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ffs_i4_0s</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_ffs</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'only get given a Python &quot;int&quot;, assumes 32 bits'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_ffs_i8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:], int64)&quot;</span><span class="s2">)(</span><span class="s1">simple_ffs</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x000000000010000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">17</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s3">0x100000000</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">33</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_laneid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_laneid</span><span class="s2">)</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s3">2</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">count </span><span class="s2">* </span><span class="s3">32</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">32</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">count</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">count </span><span class="s2">* </span><span class="s3">32</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertTrue</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">ary </span><span class="s2">== </span><span class="s1">exp</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_warpsize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int32[:])&quot;</span><span class="s2">)(</span><span class="s1">simple_warpsize</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">32</span><span class="s2">, </span><span class="s5">&quot;CUDA semantics&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_round_f4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int64[:], float32)&quot;</span><span class="s2">)(</span><span class="s1">simple_round</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[-</span><span class="s3">3.0</span><span class="s2">, -</span><span class="s3">2.5</span><span class="s2">, -</span><span class="s3">2.25</span><span class="s2">, -</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.25</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">2.75</span><span class="s2">]:</span>
            <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">round</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_round_f8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(int64[:], float64)&quot;</span><span class="s2">)(</span><span class="s1">simple_round</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[-</span><span class="s3">3.0</span><span class="s2">, -</span><span class="s3">2.5</span><span class="s2">, -</span><span class="s3">2.25</span><span class="s2">, -</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.25</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">2.75</span><span class="s2">]:</span>
            <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">round</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_round_to_f4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float32[:], float32, int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_round_to</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">123</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s3">32</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])))</span>
        <span class="s1">digits </span><span class="s2">= (</span>
            <span class="s4"># Common case branch of round_to_impl</span>
            <span class="s2">-</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">,</span>
            <span class="s4"># The algorithm currently implemented can only round to 13 digits</span>
            <span class="s4"># with single precision. Note that this doesn't trigger the</span>
            <span class="s4"># &quot;overflow safe&quot; branch of the implementation, which can only be</span>
            <span class="s4"># hit when using double precision.</span>
            <span class="s3">13</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">digits</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">val</span><span class="s2">=</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">=</span><span class="s1">ndigits</span><span class="s2">):</span>
                <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">round</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">),</span>
                                        <span class="s1">prec</span><span class="s2">=</span><span class="s5">'single'</span><span class="s2">)</span>

    <span class="s4"># CPython on most platforms uses rounding based on dtoa.c, whereas the CUDA</span>
    <span class="s4"># round-to implementation uses CPython's fallback implementation, which has</span>
    <span class="s4"># slightly different behavior at the edges of the domain. Since the CUDA</span>
    <span class="s4"># simulator executes using CPython, we need to skip this test when the</span>
    <span class="s4"># simulator is active.</span>
    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Overflow behavior differs on CPython'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_round_to_f4_overflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that the input value is returned when y in round_ndigits</span>
        <span class="s4"># overflows.</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float32[:], float32, int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_round_to</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">max</span>
        <span class="s4"># An unusually large number of digits is required to hit the &quot;y</span>
        <span class="s4"># overflows&quot; branch of the implementation because the typing results in</span>
        <span class="s4"># the computation of y as float64.</span>
        <span class="s1">ndigits </span><span class="s2">= </span><span class="s3">300</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_round_to_f4_halfway</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float32[:], float32, int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_round_to</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s4"># Value chosen to trigger the &quot;round to even&quot; branch of the</span>
        <span class="s4"># implementation</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s3">0.3425</span>
        <span class="s1">ndigits </span><span class="s2">= </span><span class="s3">3</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">round</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">), </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'single'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_round_to_f8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float64[:], float64, int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_round_to</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">123</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])))</span>
        <span class="s1">digits </span><span class="s2">= (-</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">digits</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">val</span><span class="s2">=</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">=</span><span class="s1">ndigits</span><span class="s2">):</span>
                <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">round</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">),</span>
                                        <span class="s1">prec</span><span class="s2">=</span><span class="s5">'exact'</span><span class="s2">)</span>

        <span class="s4"># Trigger the &quot;overflow safe&quot; branch of the implementation</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s3">0.12345678987654321 </span><span class="s2">* </span><span class="s3">10e-15</span>
        <span class="s1">ndigits </span><span class="s2">= </span><span class="s3">23</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">subTest</span><span class="s2">(</span><span class="s1">val</span><span class="s2">=</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">=</span><span class="s1">ndigits</span><span class="s2">):</span>
            <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">round</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">),</span>
                                    <span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">)</span>

    <span class="s4"># Skipped on cudasim for the same reasons as test_round_to_f4 above.</span>
    <span class="s2">@</span><span class="s1">skip_on_cudasim</span><span class="s2">(</span><span class="s5">'Overflow behavior differs on CPython'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_round_to_f8_overflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that the input value is returned when y in round_ndigits</span>
        <span class="s4"># overflows.</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float64[:], float64, int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_round_to</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">max</span>
        <span class="s4"># Unlike test_round_to_f4_overflow, a reasonable number of digits can</span>
        <span class="s4"># be used for this test to overflow y in round_ndigits.</span>
        <span class="s1">ndigits </span><span class="s2">= </span><span class="s3">12</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_round_to_f8_halfway</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">compiled </span><span class="s2">= </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">jit</span><span class="s2">(</span><span class="s5">&quot;void(float64[:], float64, int32)&quot;</span><span class="s2">)(</span><span class="s1">simple_round_to</span><span class="s2">)</span>
        <span class="s1">ary </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s4"># Value chosen to trigger the &quot;round to even&quot; branch of the</span>
        <span class="s4"># implementation, with a value that is not exactly representable with a</span>
        <span class="s4"># float32, but only a float64.</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s3">0.5425</span>
        <span class="s1">ndigits </span><span class="s2">= </span><span class="s3">3</span>
        <span class="s1">compiled</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">](</span><span class="s1">ary</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">round</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">), </span><span class="s1">prec</span><span class="s2">=</span><span class="s5">'double'</span><span class="s2">)</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s5">'__main__'</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>