<html>
<head>
<title>rst.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
rst.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
reStructuredText renderer 
========================= 
 
.. versionadded:: 1.1.0 
 
`reStructuredText &lt;http://docutils.sourceforge.net/rst.html&gt;`_ is an 
easy-to-read, what-you-see-is-what-you-get plaintext markup syntax and parser 
system. 
 
.. note:: 
 
    This widget requires the ``docutils`` package to run. Install it with 
    ``pip`` or include it as one of your deployment requirements. 
 
.. warning:: 
 
    This widget is highly experimental. The styling and implementation should 
    not be considered stable until this warning has been removed. 
 
Usage with Text 
--------------- 
 
:: 
 
    text = &quot;&quot;&quot; 
    .. _top: 
 
    Hello world 
    =========== 
 
    This is an **emphased text**, some ``interpreted text``. 
    And this is a reference to top_:: 
 
        $ print(&quot;Hello world&quot;) 
 
    &quot;&quot;&quot; 
    document = RstDocument(text=text) 
 
The rendering will output: 
 
.. image:: images/rstdocument.png 
 
Usage with Source 
----------------- 
 
You can also render a rst file using the :attr:`~RstDocument.source` property:: 
 
    document = RstDocument(source='index.rst') 
 
You can reference other documents using the role ``:doc:``. For example, in the 
document ``index.rst`` you can write:: 
 
    Go to my next document: :doc:`moreinfo.rst` 
 
It will generate a link that, when clicked, opens the ``moreinfo.rst`` 
document. 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'RstDocument'</span><span class="s2">, )</span>

<span class="s4">import </span><span class="s1">os</span>
<span class="s4">from </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path </span><span class="s4">import </span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">join</span><span class="s2">, </span><span class="s1">exists</span><span class="s2">, </span><span class="s1">abspath</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">clock </span><span class="s4">import </span><span class="s1">Clock</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">compat </span><span class="s4">import </span><span class="s1">PY2</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">ObjectProperty</span><span class="s2">, </span><span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">DictProperty</span><span class="s2">, </span><span class="s1">ListProperty</span><span class="s2">, </span><span class="s1">StringProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">BooleanProperty</span><span class="s2">, </span><span class="s1">OptionProperty</span><span class="s2">, </span><span class="s1">AliasProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">lang </span><span class="s4">import </span><span class="s1">Builder</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">utils </span><span class="s4">import </span><span class="s1">get_hex_from_color</span><span class="s2">, </span><span class="s1">get_color_from_hex</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">widget </span><span class="s4">import </span><span class="s1">Widget</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">scrollview </span><span class="s4">import </span><span class="s1">ScrollView</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">gridlayout </span><span class="s4">import </span><span class="s1">GridLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">label </span><span class="s4">import </span><span class="s1">Label</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">image </span><span class="s4">import </span><span class="s1">AsyncImage</span><span class="s2">, </span><span class="s1">Image</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">videoplayer </span><span class="s4">import </span><span class="s1">VideoPlayer</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">anchorlayout </span><span class="s4">import </span><span class="s1">AnchorLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">animation </span><span class="s4">import </span><span class="s1">Animation</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">logger </span><span class="s4">import </span><span class="s1">Logger</span>
<span class="s4">from </span><span class="s1">docutils</span><span class="s2">.</span><span class="s1">parsers </span><span class="s4">import </span><span class="s1">rst</span>
<span class="s4">from </span><span class="s1">docutils</span><span class="s2">.</span><span class="s1">parsers</span><span class="s2">.</span><span class="s1">rst </span><span class="s4">import </span><span class="s1">roles</span>
<span class="s4">from </span><span class="s1">docutils </span><span class="s4">import </span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">frontend</span><span class="s2">, </span><span class="s1">utils</span>
<span class="s4">from </span><span class="s1">docutils</span><span class="s2">.</span><span class="s1">parsers</span><span class="s2">.</span><span class="s1">rst </span><span class="s4">import </span><span class="s1">Directive</span><span class="s2">, </span><span class="s1">directives</span>
<span class="s4">from </span><span class="s1">docutils</span><span class="s2">.</span><span class="s1">parsers</span><span class="s2">.</span><span class="s1">rst</span><span class="s2">.</span><span class="s1">roles </span><span class="s4">import </span><span class="s1">set_classes</span>


<span class="s5">#</span>
<span class="s5"># Handle some additional roles</span>
<span class="s5">#</span>
<span class="s4">if </span><span class="s3">'KIVY_DOC' </span><span class="s4">not in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">:</span>

    <span class="s4">class </span><span class="s1">role_doc</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">Inline</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">TextElement</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">class </span><span class="s1">role_video</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">General</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">TextElement</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">class </span><span class="s1">VideoDirective</span><span class="s2">(</span><span class="s1">Directive</span><span class="s2">):</span>
        <span class="s1">has_content </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">required_arguments </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">optional_arguments </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">final_argument_whitespace </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">option_spec </span><span class="s2">= {</span><span class="s3">'width'</span><span class="s2">: </span><span class="s1">directives</span><span class="s2">.</span><span class="s1">nonnegative_int</span><span class="s2">,</span>
                       <span class="s3">'height'</span><span class="s2">: </span><span class="s1">directives</span><span class="s2">.</span><span class="s1">nonnegative_int</span><span class="s2">}</span>

        <span class="s4">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">set_classes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">options</span><span class="s2">)</span>
            <span class="s1">node </span><span class="s2">= </span><span class="s1">role_video</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arguments</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], **</span><span class="s1">self</span><span class="s2">.</span><span class="s1">options</span><span class="s2">)</span>
            <span class="s4">return </span><span class="s2">[</span><span class="s1">node</span><span class="s2">]</span>

    <span class="s1">generic_docroles </span><span class="s2">= {</span>
        <span class="s3">'doc'</span><span class="s2">: </span><span class="s1">role_doc</span><span class="s2">}</span>

    <span class="s4">for </span><span class="s1">rolename</span><span class="s2">, </span><span class="s1">nodeclass </span><span class="s4">in </span><span class="s1">generic_docroles</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s1">generic </span><span class="s2">= </span><span class="s1">roles</span><span class="s2">.</span><span class="s1">GenericRole</span><span class="s2">(</span><span class="s1">rolename</span><span class="s2">, </span><span class="s1">nodeclass</span><span class="s2">)</span>
        <span class="s1">role </span><span class="s2">= </span><span class="s1">roles</span><span class="s2">.</span><span class="s1">CustomRole</span><span class="s2">(</span><span class="s1">rolename</span><span class="s2">, </span><span class="s1">generic</span><span class="s2">, {</span><span class="s3">'classes'</span><span class="s2">: [</span><span class="s1">rolename</span><span class="s2">]})</span>
        <span class="s1">roles</span><span class="s2">.</span><span class="s1">register_local_role</span><span class="s2">(</span><span class="s1">rolename</span><span class="s2">, </span><span class="s1">role</span><span class="s2">)</span>

    <span class="s1">directives</span><span class="s2">.</span><span class="s1">register_directive</span><span class="s2">(</span><span class="s3">'video'</span><span class="s2">, </span><span class="s1">VideoDirective</span><span class="s2">)</span>

<span class="s1">Builder</span><span class="s2">.</span><span class="s1">load_string</span><span class="s2">(</span><span class="s3">''' 
#:import parse_color kivy.parser.parse_color 
 
 
 
&lt;RstDocument&gt;: 
    content: content 
    scatter: scatter 
    do_scroll_x: False 
    canvas.before: 
        Color: 
            rgba: parse_color(root.colors['background']) 
        Rectangle: 
            pos: self.pos 
            size: self.size 
 
    Scatter: 
        id: scatter 
        size_hint_y: None 
        height: content.minimum_height 
        width: root.width 
        scale: 1 
        do_translation: False, False 
        do_scale: False 
        do_rotation: False 
 
        GridLayout: 
            id: content 
            cols: 1 
            height: self.minimum_height 
            width: root.width 
            padding: 10 
 
&lt;RstTitle&gt;: 
    markup: True 
    valign: 'top' 
    font_size: 
        sp(self.document.base_font_size - self.section * ( 
        self.document.base_font_size / 31.0 * 2)) 
    size_hint_y: None 
    height: self.texture_size[1] + dp(20) 
    text_size: self.width, None 
    bold: True 
 
    canvas: 
        Color: 
            rgba: parse_color(self.document.underline_color) 
        Rectangle: 
            pos: self.x, self.y + 5 
            size: self.width, 1 
 
 
&lt;RstParagraph&gt;: 
    markup: True 
    valign: 'top' 
    size_hint_y: None 
    height: self.texture_size[1] + self.my 
    text_size: self.width - self.mx, None 
    font_size: sp(self.document.base_font_size / 2.0) 
 
&lt;RstTerm&gt;: 
    size_hint: None, None 
    height: label.height 
    anchor_x: 'left' 
    Label: 
        id: label 
        text: root.text 
        markup: True 
        valign: 'top' 
        size_hint: None, None 
        size: self.texture_size[0] + dp(10), self.texture_size[1] + dp(10) 
        font_size: sp(root.document.base_font_size / 2.0) 
 
&lt;RstBlockQuote&gt;: 
    cols: 2 
    content: content 
    size_hint_y: None 
    height: content.height 
    Widget: 
        size_hint_x: None 
        width: 20 
    GridLayout: 
        id: content 
        cols: 1 
        size_hint_y: None 
        height: self.minimum_height 
 
&lt;RstLiteralBlock&gt;: 
    cols: 1 
    content: content 
    size_hint_y: None 
    height: content.texture_size[1] + dp(20) 
    canvas: 
        Color: 
            rgb: parse_color('#cccccc') 
        Rectangle: 
            pos: self.x - 1, self.y - 1 
            size: self.width + 2, self.height + 2 
        Color: 
            rgb: parse_color('#eeeeee') 
        Rectangle: 
            pos: self.pos 
            size: self.size 
    Label: 
        id: content 
        markup: True 
        valign: 'top' 
        text_size: self.width - 20, None 
        font_name: 'data/fonts/RobotoMono-Regular.ttf' 
        color: (0, 0, 0, 1) 
 
&lt;RstList&gt;: 
    cols: 2 
    size_hint_y: None 
    height: self.minimum_height 
 
&lt;RstListItem&gt;: 
    cols: 1 
    size_hint_y: None 
    height: self.minimum_height 
 
&lt;RstSystemMessage&gt;: 
    cols: 1 
    size_hint_y: None 
    height: self.minimum_height 
    canvas: 
        Color: 
            rgba: 1, 0, 0, .3 
        Rectangle: 
            pos: self.pos 
            size: self.size 
 
&lt;RstWarning&gt;: 
    content: content 
    cols: 1 
    padding: 20 
    size_hint_y: None 
    height: self.minimum_height 
    canvas: 
        Color: 
            rgba: 1, 0, 0, .5 
        Rectangle: 
            pos: self.x + 10, self.y + 10 
            size: self.width - 20, self.height - 20 
    GridLayout: 
        cols: 1 
        id: content 
        size_hint_y: None 
        height: self.minimum_height 
 
&lt;RstNote&gt;: 
    content: content 
    cols: 1 
    padding: 20 
    size_hint_y: None 
    height: self.minimum_height 
    canvas: 
        Color: 
            rgba: 0, 1, 0, .5 
        Rectangle: 
            pos: self.x + 10, self.y + 10 
            size: self.width - 20, self.height - 20 
    GridLayout: 
        cols: 1 
        id: content 
        size_hint_y: None 
        height: self.minimum_height 
 
&lt;RstImage&gt;: 
    size_hint: None, None 
    size: self.texture_size[0], self.texture_size[1] + dp(10) 
 
&lt;RstAsyncImage&gt;: 
    size_hint: None, None 
    size: self.texture_size[0], self.texture_size[1] + dp(10) 
 
&lt;RstDefinitionList&gt;: 
    cols: 1 
    size_hint_y: None 
    height: self.minimum_height 
    font_size: sp(self.document.base_font_size / 2.0) 
 
&lt;RstDefinition&gt;: 
    cols: 2 
    size_hint_y: None 
    height: self.minimum_height 
    font_size: sp(self.document.base_font_size / 2.0) 
 
&lt;RstFieldList&gt;: 
    cols: 2 
    size_hint_y: None 
    height: self.minimum_height 
 
&lt;RstFieldName&gt;: 
    markup: True 
    valign: 'top' 
    size_hint: 0.2, 1 
    color: (0, 0, 0, 1) 
    bold: True 
    text_size: self.width - 10, self.height - 10 
    valign: 'top' 
    font_size: sp(self.document.base_font_size / 2.0) 
 
&lt;RstFieldBody&gt;: 
    cols: 1 
    size_hint_y: None 
    height: self.minimum_height 
 
&lt;RstFootnote&gt;: 
    cols: 2 
    size_hint_y: None 
    height: self.minimum_height 
 
&lt;RstFootName&gt;: 
    markup: True 
    valign: 'top' 
    size_hint: 0.2, 1 
    color: (0, 0, 0, 1) 
    bold: True 
    text_size: self.width - 10, self.height - 10 
    valign: 'top' 
    font_size: sp(self.document.base_font_size / 2.0) 
 
&lt;RstTable&gt;: 
    size_hint_y: None 
    height: self.minimum_height 
 
&lt;RstEntry&gt;: 
    cols: 1 
    size_hint_y: None 
    height: self.minimum_height 
 
    canvas: 
        Color: 
            rgb: .2, .2, .2 
        Line: 
            points: [</span><span class="s4">\ 
            </span><span class="s3">self.x,</span><span class="s4">\ 
            </span><span class="s3">self.y,</span><span class="s4">\ 
            </span><span class="s3">self.right,</span><span class="s4">\ 
            </span><span class="s3">self.y,</span><span class="s4">\ 
            </span><span class="s3">self.right,</span><span class="s4">\ 
            </span><span class="s3">self.top,</span><span class="s4">\ 
            </span><span class="s3">self.x,</span><span class="s4">\ 
            </span><span class="s3">self.top,</span><span class="s4">\ 
            </span><span class="s3">self.x,</span><span class="s4">\ 
            </span><span class="s3">self.y] 
 
&lt;RstTransition&gt;: 
    size_hint_y: None 
    height: 20 
    canvas: 
        Color: 
            rgb: .2, .2, .2 
        Line: 
            points: [self.x, self.center_y, self.right, self.center_y] 
 
&lt;RstListBullet&gt;: 
    markup: True 
    valign: 'top' 
    size_hint_x: None 
    width: self.texture_size[0] + dp(10) 
    text_size: None, self.height - dp(10) 
    font_size: sp(self.document.base_font_size / 2.0) 
 
&lt;RstEmptySpace&gt;: 
    size_hint: 0.01, 0.01 
 
&lt;RstDefinitionSpace&gt;: 
    size_hint: None, 0.1 
    width: 50 
    font_size: sp(self.document.base_font_size / 2.0) 
 
&lt;RstVideoPlayer&gt;: 
    options: {'fit_mode': 'contain'} 
    canvas.before: 
        Color: 
            rgba: (1, 1, 1, 1) 
        BorderImage: 
            source: 'atlas://data/images/defaulttheme/player-background' 
            pos: self.x - 25, self.y - 25 
            size: self.width + 50, self.height + 50 
            border: (25, 25, 25, 25) 
'''</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstVideoPlayer</span><span class="s2">(</span><span class="s1">VideoPlayer</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstDocument</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">):</span>
    <span class="s0">'''Base widget used to store an Rst document. See module documentation for 
    more information. 
    '''</span>
    <span class="s1">source </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s3">'''Filename of the RST document. 
 
    :attr:`source` is a :class:`~kivy.properties.StringProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">source_encoding </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">)</span>
    <span class="s3">'''Encoding to be used for the :attr:`source` file. 
 
    :attr:`source_encoding` is a :class:`~kivy.properties.StringProperty` and 
    defaults to `utf-8`. 
 
    .. Note:: 
        It is your responsibility to ensure that the value provided is a 
        valid codec supported by python. 
    '''</span>

    <span class="s1">source_error </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span><span class="s3">'strict'</span><span class="s2">,</span>
                                  <span class="s1">options</span><span class="s2">=(</span><span class="s3">'strict'</span><span class="s2">, </span><span class="s3">'ignore'</span><span class="s2">, </span><span class="s3">'replace'</span><span class="s2">,</span>
                                           <span class="s3">'xmlcharrefreplace'</span><span class="s2">,</span>
                                           <span class="s3">'backslashreplac'</span><span class="s2">))</span>
    <span class="s3">'''Error handling to be used while encoding the :attr:`source` file. 
 
    :attr:`source_error` is an :class:`~kivy.properties.OptionProperty` and 
    defaults to `strict`. Can be one of 'strict', 'ignore', 'replace', 
    'xmlcharrefreplace' or 'backslashreplac'. 
    '''</span>

    <span class="s1">text </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s3">'''RST markup text of the document. 
 
    :attr:`text` is a :class:`~kivy.properties.StringProperty` and defaults to 
    None. 
    '''</span>

    <span class="s1">document_root </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s3">'''Root path where :doc: will search for rst documents. If no path is 
    given, it will use the directory of the first loaded source file. 
 
    :attr:`document_root` is a :class:`~kivy.properties.StringProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">base_font_size </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">31</span><span class="s2">)</span>
    <span class="s3">'''Font size for the biggest title, 31 by default. All other font sizes are 
    derived from this. 
 
    .. versionadded:: 1.8.0 
    '''</span>

    <span class="s1">show_errors </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">'''Indicate whether RST parsers errors should be shown on the screen 
    or not. 
 
    :attr:`show_errors` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to False. 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_bgc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">get_color_from_hex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">background</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_set_bgc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">background </span><span class="s2">= </span><span class="s1">get_hex_from_color</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)[</span><span class="s6">1</span><span class="s2">:]</span>

    <span class="s1">background_color </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_bgc</span><span class="s2">, </span><span class="s1">_set_bgc</span><span class="s2">,</span>
                                     <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'colors'</span><span class="s2">,),</span>
                                     <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Specifies the background_color to be used for the RstDocument. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`background_color` is an :class:`~kivy.properties.AliasProperty` 
    for colors['background']. 
    '''</span>

    <span class="s1">colors </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({</span>
        <span class="s3">'background'</span><span class="s2">: </span><span class="s3">'e5e6e9ff'</span><span class="s2">,</span>
        <span class="s3">'link'</span><span class="s2">: </span><span class="s3">'ce5c00ff'</span><span class="s2">,</span>
        <span class="s3">'paragraph'</span><span class="s2">: </span><span class="s3">'202020ff'</span><span class="s2">,</span>
        <span class="s3">'title'</span><span class="s2">: </span><span class="s3">'204a87ff'</span><span class="s2">,</span>
        <span class="s3">'bullet'</span><span class="s2">: </span><span class="s3">'000000ff'</span><span class="s2">})</span>
    <span class="s3">'''Dictionary of all the colors used in the RST rendering. 
 
    .. warning:: 
 
        This dictionary is needs special handling. You also need to call 
        :meth:`RstDocument.render` if you change them after loading. 
 
    :attr:`colors` is a :class:`~kivy.properties.DictProperty`. 
    '''</span>

    <span class="s1">title </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
    <span class="s3">'''Title of the current document. 
 
    :attr:`title` is a :class:`~kivy.properties.StringProperty` and defaults to 
    ''. It is read-only. 
    '''</span>

    <span class="s1">toctrees </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s3">'''Toctree of all loaded or preloaded documents. This dictionary is filled 
    when a rst document is explicitly loaded or where :meth:`preload` has been 
    called. 
 
    If the document has no filename, e.g. when the document is loaded from a 
    text file, the key will be ''. 
 
    :attr:`toctrees` is a :class:`~kivy.properties.DictProperty` and defaults 
    to {}. 
    '''</span>

    <span class="s1">underline_color </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">'204a9699'</span><span class="s2">)</span>
    <span class="s3">'''underline color of the titles, expressed in html color notation 
 
    :attr:`underline_color` is a 
    :class:`~kivy.properties.StringProperty` and defaults to '204a9699'. 
 
    .. versionadded: 1.9.0 
    '''</span>

    <span class="s5"># internals.</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">scatter </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s1">anchors_widgets </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([])</span>
    <span class="s1">refs_assoc </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_load </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_load_from_text</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_parser </span><span class="s2">= </span><span class="s1">rst</span><span class="s2">.</span><span class="s1">Parser</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_settings </span><span class="s2">= </span><span class="s1">frontend</span><span class="s2">.</span><span class="s1">OptionParser</span><span class="s2">(</span>
            <span class="s1">components</span><span class="s2">=(</span><span class="s1">rst</span><span class="s2">.</span><span class="s1">Parser</span><span class="s2">, )).</span><span class="s1">get_default_values</span><span class="s2">()</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">RstDocument</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_source</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">document_root </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s5"># set the documentation root to the directory name of the</span>
            <span class="s5"># first tile</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">document_root </span><span class="s2">= </span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_from_source</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_load</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">render</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">'''Force document rendering. 
        '''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_from_text</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">resolve_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">):</span>
        <span class="s0">'''Get the path for this filename. If the filename doesn't exist, 
        it returns the document_root + filename. 
        '''</span>
        <span class="s4">if </span><span class="s1">exists</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">):</span>
            <span class="s4">return </span><span class="s1">filename</span>
        <span class="s4">return </span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">document_root</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">preload</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">'utf-8'</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">'strict'</span><span class="s2">):</span>
        <span class="s0">'''Preload a rst file to get its toctree and its title. 
 
        The result will be stored in :attr:`toctrees` with the ``filename`` as 
        key. 
        '''</span>

        <span class="s4">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s3">'rb'</span><span class="s2">) </span><span class="s4">as </span><span class="s1">fd</span><span class="s2">:</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">)</span>
        <span class="s5"># parse the source</span>
        <span class="s1">document </span><span class="s2">= </span><span class="s1">utils</span><span class="s2">.</span><span class="s1">new_document</span><span class="s2">(</span><span class="s3">'Document'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_settings</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">text</span><span class="s2">, </span><span class="s1">document</span><span class="s2">)</span>
        <span class="s5"># fill the current document node</span>
        <span class="s1">visitor </span><span class="s2">= </span><span class="s1">_ToctreeVisitor</span><span class="s2">(</span><span class="s1">document</span><span class="s2">)</span>
        <span class="s1">document</span><span class="s2">.</span><span class="s1">walkabout</span><span class="s2">(</span><span class="s1">visitor</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">toctrees</span><span class="s2">[</span><span class="s1">filename</span><span class="s2">] = </span><span class="s1">visitor</span><span class="s2">.</span><span class="s1">toctree</span>
        <span class="s4">return </span><span class="s1">text</span>

    <span class="s4">def </span><span class="s1">_load_from_source</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolve_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">preload</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">,</span>
                                 <span class="s1">self</span><span class="s2">.</span><span class="s1">source_encoding</span><span class="s2">,</span>
                                 <span class="s1">self</span><span class="s2">.</span><span class="s1">source_error</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_load_from_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s5"># clear the current widgets</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">clear_widgets</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">anchors_widgets </span><span class="s2">= []</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">refs_assoc </span><span class="s2">= {}</span>

            <span class="s5"># parse the source</span>
            <span class="s1">document </span><span class="s2">= </span><span class="s1">utils</span><span class="s2">.</span><span class="s1">new_document</span><span class="s2">(</span><span class="s3">'Document'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_settings</span><span class="s2">)</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span>
            <span class="s4">if </span><span class="s1">PY2 </span><span class="s4">and </span><span class="s1">type</span><span class="s2">(</span><span class="s1">text</span><span class="s2">) </span><span class="s4">is </span><span class="s1">str</span><span class="s2">:</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s1">text</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">text</span><span class="s2">, </span><span class="s1">document</span><span class="s2">)</span>

            <span class="s5"># fill the current document node</span>
            <span class="s1">visitor </span><span class="s2">= </span><span class="s1">_Visitor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">document</span><span class="s2">)</span>
            <span class="s1">document</span><span class="s2">.</span><span class="s1">walkabout</span><span class="s2">(</span><span class="s1">visitor</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">title </span><span class="s2">= </span><span class="s1">visitor</span><span class="s2">.</span><span class="s1">title </span><span class="s4">or </span><span class="s3">'No title'</span>
        <span class="s4">except</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">(</span><span class="s3">'Rst: error while loading text'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_ref_press</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">goto</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">goto</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s0">'''Scroll to the reference. If it's not found, nothing will be done. 
 
        For this text:: 
 
            .. _myref: 
 
            This is something I always wanted. 
 
        You can do:: 
 
            from kivy.clock import Clock 
            from functools import partial 
 
            doc = RstDocument(...) 
            Clock.schedule_once(partial(doc.goto, 'myref'), 0.1) 
 
        .. note:: 
 
            It is preferable to delay the call of the goto if you just loaded 
            the document because the layout might not be finished or the 
            size of the RstDocument has not yet been determined. In 
            either case, the calculation of the scrolling would be 
            wrong. 
 
            You can, however, do a direct call if the document is already 
            loaded. 
 
        .. versionadded:: 1.3.0 
        '''</span>
        <span class="s5"># check if it's a file ?</span>
        <span class="s4">if </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'.rst'</span><span class="s2">):</span>
            <span class="s5"># whether it's a valid or invalid file, let source deal with it</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">source </span><span class="s2">= </span><span class="s1">ref</span>
            <span class="s4">return</span>

        <span class="s5"># get the association</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">)</span>

        <span class="s5"># search into all the nodes containing anchors</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">ay </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">for </span><span class="s1">node </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">anchors_widgets</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">ref </span><span class="s4">in </span><span class="s1">node</span><span class="s2">.</span><span class="s1">anchors</span><span class="s2">:</span>
                <span class="s1">ax</span><span class="s2">, </span><span class="s1">ay </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">anchors</span><span class="s2">[</span><span class="s1">ref</span><span class="s2">]</span>
                <span class="s4">break</span>

        <span class="s5"># not found, stop here</span>
        <span class="s4">if </span><span class="s1">ax </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s5"># found, calculate the real coordinate</span>

        <span class="s5"># get the anchor coordinate inside widget space</span>
        <span class="s1">ax </span><span class="s2">+= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">x</span>
        <span class="s1">ay </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">top </span><span class="s2">- </span><span class="s1">ay</span>
        <span class="s5"># ay += node.y</span>

        <span class="s5"># what's the current coordinate for us?</span>
        <span class="s1">sx</span><span class="s2">, </span><span class="s1">sy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">.</span><span class="s1">top</span>
        <span class="s5"># ax, ay = self.scatter.to_parent(ax, ay)</span>

        <span class="s1">ay </span><span class="s2">-= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>

        <span class="s1">dx</span><span class="s2">, </span><span class="s1">dy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_distance_to_scroll</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">ay</span><span class="s2">)</span>
        <span class="s1">dy </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">min</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">dy</span><span class="s2">))</span>
        <span class="s1">Animation</span><span class="s2">(</span><span class="s1">scroll_y</span><span class="s2">=</span><span class="s1">dy</span><span class="s2">, </span><span class="s1">d</span><span class="s2">=</span><span class="s6">.25</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s3">'in_out_expo'</span><span class="s2">).</span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">add_anchors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">anchors_widgets</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstTitle</span><span class="s2">(</span><span class="s1">Label</span><span class="s2">):</span>

    <span class="s1">section </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstParagraph</span><span class="s2">(</span><span class="s1">Label</span><span class="s2">):</span>

    <span class="s1">mx </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">10</span><span class="s2">)</span>

    <span class="s1">my </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">10</span><span class="s2">)</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstTerm</span><span class="s2">(</span><span class="s1">AnchorLayout</span><span class="s2">):</span>

    <span class="s1">text </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstBlockQuote</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstLiteralBlock</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstList</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstListItem</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstListBullet</span><span class="s2">(</span><span class="s1">Label</span><span class="s2">):</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstSystemMessage</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstWarning</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstNote</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s1">content </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstImage</span><span class="s2">(</span><span class="s1">Image</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstAsyncImage</span><span class="s2">(</span><span class="s1">AsyncImage</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstDefinitionList</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstDefinition</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstFieldList</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstFieldName</span><span class="s2">(</span><span class="s1">Label</span><span class="s2">):</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstFieldBody</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstFootnote</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstFootName</span><span class="s2">(</span><span class="s1">Label</span><span class="s2">):</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">RstGridLayout</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstTable</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstEntry</span><span class="s2">(</span><span class="s1">GridLayout</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstTransition</span><span class="s2">(</span><span class="s1">Widget</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstEmptySpace</span><span class="s2">(</span><span class="s1">Widget</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">RstDefinitionSpace</span><span class="s2">(</span><span class="s1">Widget</span><span class="s2">):</span>

    <span class="s1">document </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">_ToctreeVisitor</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">NodeVisitor</span><span class="s2">):</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">toctree </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">queue </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">nodes</span><span class="s2">.</span><span class="s1">NodeVisitor</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tree</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">queue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">tree</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current </span><span class="s2">= </span><span class="s1">tree</span>

    <span class="s4">def </span><span class="s1">pop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">queue</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">dispatch_visit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">cls </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">__class__</span>
        <span class="s4">if </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">section</span><span class="s2">:</span>
            <span class="s1">section </span><span class="s2">= {</span>
                <span class="s3">'ids'</span><span class="s2">: </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">],</span>
                <span class="s3">'names'</span><span class="s2">: </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'names'</span><span class="s2">],</span>
                <span class="s3">'title'</span><span class="s2">: </span><span class="s3">''</span><span class="s2">,</span>
                <span class="s3">'children'</span><span class="s2">: []}</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">[</span><span class="s3">'children'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">section</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">section</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">section</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">title</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">Text</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s1">node</span>

    <span class="s4">def </span><span class="s1">dispatch_departure</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">cls </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">__class__</span>
        <span class="s4">if </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">section</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">title</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">[</span><span class="s3">'title'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span>


<span class="s4">class </span><span class="s1">_Visitor</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">NodeVisitor</span><span class="s2">):</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">root</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">root</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">title </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_list </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">idx_list </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_have_anchor </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">section </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_strip_text </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">substitution </span><span class="s2">= {}</span>

        <span class="s5"># store refblock here while building</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">foot_refblock </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s5"># store order for autonum/sym footnotes+refs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes </span><span class="s2">= {</span>
            <span class="s3">'autonum'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">,</span>
            <span class="s3">'autosym'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">,</span>
            <span class="s3">'autonum_ref'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">,</span>
            <span class="s3">'autosym_ref'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">,</span>
        <span class="s2">}</span>

        <span class="s5"># last four default chars aren't in our Roboto font,</span>
        <span class="s5"># those were replaced with something else</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">footlist </span><span class="s2">= [</span>
            <span class="s3">'</span><span class="s4">\u002A</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># asterisk</span>
            <span class="s3">'</span><span class="s4">\u2020</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># dagger</span>
            <span class="s3">'</span><span class="s4">\u2021</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># doubledagger</span>
            <span class="s3">'</span><span class="s4">\u00A7</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># section</span>
            <span class="s3">'</span><span class="s4">\u00B6</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># pilcrow</span>
            <span class="s3">'</span><span class="s4">\u0023</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># number</span>
            <span class="s3">'</span><span class="s4">\u2206</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># cap delta</span>
            <span class="s3">'</span><span class="s4">\u220F</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># cap pi</span>
            <span class="s3">'</span><span class="s4">\u0470</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># cap psi</span>
            <span class="s3">'</span><span class="s4">\u0466</span><span class="s3">'</span><span class="s2">,  </span><span class="s5"># cap yus</span>
        <span class="s2">]</span>
        <span class="s1">nodes</span><span class="s2">.</span><span class="s1">NodeVisitor</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current </span><span class="s2">= </span><span class="s1">widget</span>

    <span class="s4">def </span><span class="s1">pop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">current </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">current_list</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">brute_refs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s5"># get foot/cit refs manually because the output from</span>
        <span class="s5"># docutils' parser doesn't contain any of these:</span>
        <span class="s5"># node's refid, refname, backref, ... and/or are just ''/[]</span>

        <span class="s4">def </span><span class="s1">get_refs</span><span class="s2">(</span><span class="s1">condition</span><span class="s2">, </span><span class="s1">backref</span><span class="s2">=</span><span class="s4">False</span><span class="s2">):</span>
            <span class="s5"># backref=True is used in nodes.footnote</span>
            <span class="s1">autonum </span><span class="s2">= </span><span class="s1">autosym </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s1">_nodes </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span><span class="s1">condition</span><span class="s2">=</span><span class="s1">condition</span><span class="s2">, </span><span class="s1">ascend</span><span class="s2">=</span><span class="s4">False</span><span class="s2">)</span>

            <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">_nodes</span><span class="s2">:</span>
                <span class="s1">id </span><span class="s2">= </span><span class="s1">f</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s1">auto </span><span class="s2">= </span><span class="s3">''</span>
                <span class="s4">if </span><span class="s3">'auto' </span><span class="s4">in </span><span class="s1">f</span><span class="s2">:</span>
                    <span class="s1">auto </span><span class="s2">= </span><span class="s1">f</span><span class="s2">[</span><span class="s3">'auto'</span><span class="s2">]</span>

                <span class="s5"># auto is either 1(int) or '*'</span>
                <span class="s4">if </span><span class="s1">auto </span><span class="s2">== </span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s1">autonum </span><span class="s2">+= </span><span class="s6">1</span>
                    <span class="s1">key </span><span class="s2">= </span><span class="s3">'backref' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">autonum</span><span class="s2">) </span><span class="s4">if </span><span class="s1">backref </span><span class="s4">else </span><span class="s1">str</span><span class="s2">(</span><span class="s1">autonum</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">id</span>
                <span class="s4">elif </span><span class="s1">auto </span><span class="s2">== </span><span class="s3">'*'</span><span class="s2">:</span>
                    <span class="s1">sym </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">footlist</span><span class="s2">[</span>
                        <span class="s1">autosym </span><span class="s2">% </span><span class="s6">10</span>
                    <span class="s2">] * (</span><span class="s1">int</span><span class="s2">(</span><span class="s1">autosym </span><span class="s2">/ </span><span class="s6">10</span><span class="s2">) + </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">key </span><span class="s2">= </span><span class="s3">'backref' </span><span class="s2">+ </span><span class="s1">sym </span><span class="s4">if </span><span class="s1">backref </span><span class="s4">else </span><span class="s1">sym</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">id</span>
                    <span class="s1">autosym </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s4">if not </span><span class="s1">backref</span><span class="s2">:</span>
                        <span class="s1">key </span><span class="s2">= </span><span class="s1">f</span><span class="s2">[</span><span class="s3">'names'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
                        <span class="s4">if </span><span class="s1">key</span><span class="s2">:</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">id</span>
                        <span class="s4">continue</span>

                    <span class="s1">key </span><span class="s2">= </span><span class="s3">'backref' </span><span class="s2">+ </span><span class="s1">f</span><span class="s2">[</span><span class="s3">'refname'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>

                    <span class="s4">if </span><span class="s1">key </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">id</span><span class="s2">)</span>
                    <span class="s4">else</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = [</span><span class="s1">id</span><span class="s2">, ]</span>

        <span class="s5"># these are unique and need to go FIRST</span>
        <span class="s1">get_refs</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">footnote</span><span class="s2">, </span><span class="s1">backref</span><span class="s2">=</span><span class="s4">False</span><span class="s2">)</span>

        <span class="s5"># autonum &amp; autosym are unique</span>
        <span class="s1">get_refs</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">footnote_reference</span><span class="s2">, </span><span class="s1">backref</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">dispatch_visit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">cls </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">__class__</span>
        <span class="s4">if </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">document</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">content</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">brute_refs</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">section</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">section </span><span class="s2">+= </span><span class="s6">1</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">substitution_definition</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'names'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">substitution</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">node</span><span class="s2">.</span><span class="s1">children</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">substitution_reference</span><span class="s2">:</span>
            <span class="s1">node </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">substitution</span><span class="s2">[</span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'refname'</span><span class="s2">]]</span>
            <span class="s5"># it can be e.g. image or something else too!</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">Text</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s1">node</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">footnote</span><span class="s2">:</span>
            <span class="s5"># .. [x] footnote</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s1">foot </span><span class="s2">= </span><span class="s1">RstFootnote</span><span class="s2">()</span>
            <span class="s1">ids </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">foot</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">foot</span><span class="s2">)</span>

            <span class="s5"># check if its autonumbered</span>
            <span class="s1">auto </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s4">if </span><span class="s3">'auto' </span><span class="s4">in </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">:</span>
                <span class="s1">auto </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'auto'</span><span class="s2">]</span>

            <span class="s5"># auto is either 1(int) or '*'</span>
            <span class="s4">if </span><span class="s1">auto </span><span class="s2">== </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autonum'</span><span class="s2">] += </span><span class="s6">1</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autonum'</span><span class="s2">])</span>
                <span class="s1">node_id </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s4">elif </span><span class="s1">auto </span><span class="s2">== </span><span class="s3">'*'</span><span class="s2">:</span>
                <span class="s1">autosym </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autosym'</span><span class="s2">]</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">footlist</span><span class="s2">[</span>
                    <span class="s1">autosym </span><span class="s2">% </span><span class="s6">10</span>
                <span class="s2">] * (</span><span class="s1">int</span><span class="s2">(</span><span class="s1">autosym </span><span class="s2">/ </span><span class="s6">10</span><span class="s2">) + </span><span class="s6">1</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autosym'</span><span class="s2">] += </span><span class="s6">1</span>
                <span class="s1">node_id </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># can have multiple refs:</span>
                <span class="s5"># [8] (1, 2) Footnote ref</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'names'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s1">node_id </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>

            <span class="s5"># we can have a footnote without any link or ref</span>
            <span class="s5"># .. [1] Empty footnote</span>
            <span class="s1">link </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s3">''</span><span class="s2">)</span>

            <span class="s5"># handle no refs</span>
            <span class="s1">ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'backref' </span><span class="s2">+ </span><span class="s1">name</span><span class="s2">, </span><span class="s3">''</span><span class="s2">)</span>

            <span class="s5"># colorize only with refs</span>
            <span class="s1">colorized </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">colorize</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s3">'link'</span><span class="s2">) </span><span class="s4">if </span><span class="s1">ref </span><span class="s4">else </span><span class="s1">name</span>

            <span class="s5"># has no refs</span>
            <span class="s4">if not </span><span class="s1">ref</span><span class="s2">:</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s3">'&amp;bl;%s&amp;br;' </span><span class="s2">% (</span><span class="s1">colorized</span><span class="s2">)</span>
            <span class="s5"># list of refs</span>
            <span class="s4">elif </span><span class="s1">ref </span><span class="s4">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
                <span class="s1">ref_block </span><span class="s2">= [</span>
                    <span class="s3">'[ref=%s][u]%s[/u][/ref]' </span><span class="s2">% (</span><span class="s1">r</span><span class="s2">, </span><span class="s1">i </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s4">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">r </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">)</span>
                <span class="s2">]</span>
                <span class="s5"># [1] ( 1, 2, ...) Footnote</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">foot_refblock </span><span class="s2">= </span><span class="s3">''</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span>
                    <span class="s3">'[i]( '</span><span class="s2">, </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">ref_block</span><span class="s2">), </span><span class="s3">' )[/i]'</span>
                <span class="s2">])</span>

                <span class="s1">text </span><span class="s2">= </span><span class="s3">'[anchor=%s]&amp;bl;%s&amp;br;' </span><span class="s2">% (</span>
                    <span class="s1">node</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">], </span><span class="s1">colorized</span>
                <span class="s2">)</span>
            <span class="s5"># single ref</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s3">'[anchor=%s][ref=%s]&amp;bl;%s&amp;br;[/ref]' </span><span class="s2">% (</span>
                    <span class="s1">node</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">], </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">colorized</span>
                <span class="s2">)</span>

            <span class="s1">name </span><span class="s2">= </span><span class="s1">RstFootName</span><span class="s2">(</span>
                <span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">,</span>
                <span class="s1">text</span><span class="s2">=</span><span class="s1">text</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s5"># give it anchor + event manually</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">add_anchors</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">name</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">on_ref_press</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">on_ref_press</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">footnote_reference</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'&amp;bl;'</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s3">''</span>

            <span class="s5"># check if its autonumbered</span>
            <span class="s1">auto </span><span class="s2">= </span><span class="s3">''</span>
            <span class="s4">if </span><span class="s3">'auto' </span><span class="s4">in </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">:</span>
                <span class="s1">auto </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'auto'</span><span class="s2">]</span>

            <span class="s5"># auto is either 1(int) or '*'</span>
            <span class="s4">if </span><span class="s1">auto </span><span class="s2">== </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autonum_ref'</span><span class="s2">] += </span><span class="s6">1</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autonum_ref'</span><span class="s2">])</span>
                <span class="s1">node_id </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s4">elif </span><span class="s1">auto </span><span class="s2">== </span><span class="s3">'*'</span><span class="s2">:</span>
                <span class="s1">autosym </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autosym_ref'</span><span class="s2">]</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">footlist</span><span class="s2">[</span>
                    <span class="s1">autosym </span><span class="s2">% </span><span class="s6">10</span>
                <span class="s2">] * (</span><span class="s1">int</span><span class="s2">(</span><span class="s1">autosym </span><span class="s2">/ </span><span class="s6">10</span><span class="s2">) + </span><span class="s6">1</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">footnotes</span><span class="s2">[</span><span class="s3">'autosym_ref'</span><span class="s2">] += </span><span class="s6">1</span>
                <span class="s1">node_id </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attributes</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># can have multiple refs:</span>
                <span class="s5"># [8] (1, 2) Footnote ref</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">children</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s1">node_id </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">text </span><span class="s2">+= </span><span class="s1">name</span>

            <span class="s1">refs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s3">''</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">refs </span><span class="s4">and </span><span class="s1">auto </span><span class="s4">in </span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s3">'*'</span><span class="s2">):</span>
                <span class="s5"># parser should trigger it when checking</span>
                <span class="s5"># for backlinks, but we don't have **any** refs</span>
                <span class="s5"># to work with, so we have to trigger it manually</span>
                <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span>
                    <span class="s3">'Too many autonumbered or autosymboled '</span>
                    <span class="s3">'footnote references!'</span>
                <span class="s2">)</span>

            <span class="s5"># has a single or no refs ( '' )</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s3">'[anchor=%s][ref=%s][color=%s]%s' </span><span class="s2">% (</span>
                <span class="s1">node_id</span><span class="s2">, </span><span class="s1">refs</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span>
                    <span class="s3">'link'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'paragraph'</span><span class="s2">)</span>
                <span class="s2">),</span>
                <span class="s1">text</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s1">text</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text_have_anchor </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">title</span><span class="s2">:</span>
            <span class="s1">label </span><span class="s2">= </span><span class="s1">RstTitle</span><span class="s2">(</span><span class="s1">section</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">section</span><span class="s2">, </span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>
            <span class="s5"># assert self.text == ''</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">Text</span><span class="s2">:</span>
            <span class="s5"># check if parent isn't a special directive</span>
            <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s3">'parent'</span><span class="s2">):</span>
                <span class="s4">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">tagname </span><span class="s2">== </span><span class="s3">'substitution_definition'</span><span class="s2">:</span>
                    <span class="s5"># .. |ref| replace:: something</span>
                    <span class="s4">return</span>
                <span class="s4">elif </span><span class="s1">node</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">tagname </span><span class="s2">== </span><span class="s3">'substitution_reference'</span><span class="s2">:</span>
                    <span class="s5"># |ref|</span>
                    <span class="s4">return</span>
                <span class="s4">elif </span><span class="s1">node</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">tagname </span><span class="s2">== </span><span class="s3">'comment'</span><span class="s2">:</span>
                    <span class="s5"># .. COMMENT</span>
                    <span class="s4">return</span>
                <span class="s4">elif </span><span class="s1">node</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">tagname </span><span class="s2">== </span><span class="s3">'footnote_reference'</span><span class="s2">:</span>
                    <span class="s5"># .. [#]_</span>
                    <span class="s5"># .. [*]_</span>
                    <span class="s5"># rewrite it to handle autonum/sym here</span>
                    <span class="s5"># close tags with departure</span>
                    <span class="s4">return</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_strip_text</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\n</span><span class="s3">'</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'  '</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'</span><span class="s4">\t</span><span class="s3">'</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'  '</span><span class="s2">, </span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">):</span>
                    <span class="s1">node </span><span class="s2">= </span><span class="s3">' ' </span><span class="s2">+ </span><span class="s1">node</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">):</span>
                    <span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">) + </span><span class="s3">' '</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">) </span><span class="s4">and </span><span class="s1">node</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">):</span>
                    <span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s1">node</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">paragraph</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">do_strip_text </span><span class="s2">= </span><span class="s4">True</span>

            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">footnote</span><span class="s2">):</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">foot_refblock</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">foot_refblock </span><span class="s2">+ </span><span class="s3">' '</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">foot_refblock </span><span class="s2">= </span><span class="s4">None</span>
                <span class="s5"># self.do_strip_text = False</span>

            <span class="s1">label </span><span class="s2">= </span><span class="s1">RstParagraph</span><span class="s2">(</span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstEntry</span><span class="s2">):</span>
                <span class="s1">label</span><span class="s2">.</span><span class="s1">mx </span><span class="s2">= </span><span class="s6">10</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">literal_block</span><span class="s2">:</span>
            <span class="s1">box </span><span class="s2">= </span><span class="s1">RstLiteralBlock</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">emphasis</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[i]'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">strong</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[b]'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[font=fonts/RobotoMono-Regular.ttf]'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">block_quote</span><span class="s2">:</span>
            <span class="s1">box </span><span class="s2">= </span><span class="s1">RstBlockQuote</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">box</span><span class="s2">.</span><span class="s1">content</span><span class="s2">)</span>
            <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">== </span><span class="s3">''</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">enumerated_list</span><span class="s2">:</span>
            <span class="s1">box </span><span class="s2">= </span><span class="s1">RstList</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">idx_list </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">bullet_list</span><span class="s2">:</span>
            <span class="s1">box </span><span class="s2">= </span><span class="s1">RstList</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">idx_list </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">list_item</span><span class="s2">:</span>
            <span class="s1">bullet </span><span class="s2">= </span><span class="s3">'-'</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">idx_list </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">idx_list </span><span class="s2">+= </span><span class="s6">1</span>
                <span class="s1">bullet </span><span class="s2">= </span><span class="s3">'%d.' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">idx_list</span>
            <span class="s1">bullet </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">colorize</span><span class="s2">(</span><span class="s1">bullet</span><span class="s2">, </span><span class="s3">'bullet'</span><span class="s2">)</span>
            <span class="s1">item </span><span class="s2">= </span><span class="s1">RstListItem</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">RstListBullet</span><span class="s2">(</span>
                <span class="s1">text</span><span class="s2">=</span><span class="s1">bullet</span><span class="s2">, </span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">system_message</span><span class="s2">:</span>
            <span class="s1">label </span><span class="s2">= </span><span class="s1">RstSystemMessage</span><span class="s2">()</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">show_errors</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">:</span>
            <span class="s1">label </span><span class="s2">= </span><span class="s1">RstWarning</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">label</span><span class="s2">.</span><span class="s1">content</span><span class="s2">)</span>
            <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">== </span><span class="s3">''</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">note</span><span class="s2">:</span>
            <span class="s1">label </span><span class="s2">= </span><span class="s1">RstNote</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">label</span><span class="s2">.</span><span class="s1">content</span><span class="s2">)</span>
            <span class="s4">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">== </span><span class="s3">''</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">image</span><span class="s2">:</span>
            <span class="s5"># docutils parser breaks path with spaces</span>
            <span class="s5"># e.g. &quot;C:/my path&quot; -&gt; &quot;C:/mypath&quot;</span>
            <span class="s1">uri </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'uri'</span><span class="s2">]</span>
            <span class="s1">align </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'align'</span><span class="s2">, </span><span class="s3">'center'</span><span class="s2">)</span>
            <span class="s1">image_size </span><span class="s2">= [</span>
                <span class="s1">node</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'width'</span><span class="s2">),</span>
                <span class="s1">node</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'height'</span><span class="s2">)</span>
            <span class="s2">]</span>

            <span class="s5"># use user's size if defined</span>
            <span class="s4">def </span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">img</span><span class="s2">, </span><span class="s1">size</span><span class="s2">):</span>
                <span class="s1">img</span><span class="s2">.</span><span class="s1">size </span><span class="s2">= [</span>
                    <span class="s1">size</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] </span><span class="s4">or </span><span class="s1">img</span><span class="s2">.</span><span class="s1">width</span><span class="s2">,</span>
                    <span class="s1">size</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] </span><span class="s4">or </span><span class="s1">img</span><span class="s2">.</span><span class="s1">height</span>
                <span class="s2">]</span>

            <span class="s4">if </span><span class="s1">uri</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">) </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">document_root</span><span class="s2">:</span>
                <span class="s1">uri </span><span class="s2">= </span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">document_root</span><span class="s2">, </span><span class="s1">uri</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:])</span>

            <span class="s4">if </span><span class="s1">uri</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'http://'</span><span class="s2">) </span><span class="s4">or </span><span class="s1">uri</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'https://'</span><span class="s2">):</span>
                <span class="s1">image </span><span class="s2">= </span><span class="s1">RstAsyncImage</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">uri</span><span class="s2">)</span>
                <span class="s1">image</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">on_load</span><span class="s2">=</span><span class="s4">lambda </span><span class="s2">*</span><span class="s1">a</span><span class="s2">: </span><span class="s1">set_size</span><span class="s2">(</span><span class="s1">image</span><span class="s2">, </span><span class="s1">image_size</span><span class="s2">))</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">image </span><span class="s2">= </span><span class="s1">RstImage</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">uri</span><span class="s2">)</span>
                <span class="s1">set_size</span><span class="s2">(</span><span class="s1">image</span><span class="s2">, </span><span class="s1">image_size</span><span class="s2">)</span>

            <span class="s1">root </span><span class="s2">= </span><span class="s1">AnchorLayout</span><span class="s2">(</span>
                <span class="s1">size_hint_y</span><span class="s2">=</span><span class="s4">None</span><span class="s2">,</span>
                <span class="s1">anchor_x</span><span class="s2">=</span><span class="s1">align</span><span class="s2">,</span>
                <span class="s1">height</span><span class="s2">=</span><span class="s1">image</span><span class="s2">.</span><span class="s1">height</span>
            <span class="s2">)</span>

            <span class="s1">image</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">height</span><span class="s2">=</span><span class="s1">root</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'height'</span><span class="s2">))</span>
            <span class="s1">root</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s5"># TODO:</span>
            <span class="s5"># .. _img: &lt;url&gt;</span>
            <span class="s5"># .. |img| image:: &lt;img&gt;</span>
            <span class="s5"># |img|_ &lt;- needs refs and on_ref_press</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">definition_list</span><span class="s2">:</span>
            <span class="s1">lst </span><span class="s2">= </span><span class="s1">RstDefinitionList</span><span class="s2">(</span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">lst</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">lst</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">term</span><span class="s2">:</span>
            <span class="s4">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstDefinitionList</span><span class="s2">)</span>
            <span class="s1">term </span><span class="s2">= </span><span class="s1">RstTerm</span><span class="s2">(</span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">term</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">term</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">definition</span><span class="s2">:</span>
            <span class="s4">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstDefinitionList</span><span class="s2">)</span>
            <span class="s1">definition </span><span class="s2">= </span><span class="s1">RstDefinition</span><span class="s2">(</span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s1">definition</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">RstDefinitionSpace</span><span class="s2">(</span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">definition</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">definition</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">field_list</span><span class="s2">:</span>
            <span class="s1">fieldlist </span><span class="s2">= </span><span class="s1">RstFieldList</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">fieldlist</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">fieldlist</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">field_name</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">RstFieldName</span><span class="s2">(</span><span class="s1">document</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">field_body</span><span class="s2">:</span>
            <span class="s1">body </span><span class="s2">= </span><span class="s1">RstFieldBody</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">body</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">body</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">table</span><span class="s2">:</span>
            <span class="s1">table </span><span class="s2">= </span><span class="s1">RstTable</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">=</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">table</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">table</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">colspec</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">cols </span><span class="s2">+= </span><span class="s6">1</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">entry</span><span class="s2">:</span>
            <span class="s1">entry </span><span class="s2">= </span><span class="s1">RstEntry</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">transition</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">RstTransition</span><span class="s2">())</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">reference</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s1">node</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'refuri'</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[ref=%s][color=%s]' </span><span class="s2">% (</span>
                <span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span>
                    <span class="s3">'link'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'paragraph'</span><span class="s2">)))</span>
            <span class="s4">if </span><span class="s3">'refname' </span><span class="s4">in </span><span class="s1">node </span><span class="s4">and </span><span class="s3">'name' </span><span class="s4">in </span><span class="s1">node</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">refs_assoc</span><span class="s2">[</span><span class="s1">node</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]] = </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'refname'</span><span class="s2">]</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">target</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">if </span><span class="s3">'ids' </span><span class="s4">in </span><span class="s1">node</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'ids'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s4">elif </span><span class="s3">'names' </span><span class="s4">in </span><span class="s1">node</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'names'</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[anchor=%s]' </span><span class="s2">% </span><span class="s1">name</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text_have_anchor </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">role_doc</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">doc_index </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">role_video</span><span class="s2">:</span>
            <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">dispatch_departure</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">cls </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">__class__</span>
        <span class="s4">if </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">document</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">section</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">section </span><span class="s2">-= </span><span class="s6">1</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">title</span><span class="s2">:</span>
            <span class="s4">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstTitle</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">title</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">title </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s3">'title'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">Text</span><span class="s2">:</span>
            <span class="s4">pass</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">paragraph</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">do_strip_text </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstParagraph</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s3">'paragraph'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">literal_block</span><span class="s2">:</span>
            <span class="s4">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstLiteralBlock</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">content</span><span class="s2">, </span><span class="s3">'literal_block'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">emphasis</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[/i]'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">strong</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[/b]'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[/font]'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">block_quote</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">enumerated_list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">idx_list </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">bullet_list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">list_item</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">system_message</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">note</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">definition_list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">term</span><span class="s2">:</span>
            <span class="s4">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstTerm</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s3">'term'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">definition</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">field_list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">field_name</span><span class="s2">:</span>
            <span class="s4">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s1">RstFieldName</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s3">'field_name'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">field_body</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">table</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">colspec</span><span class="s2">:</span>
            <span class="s4">pass</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">entry</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">reference</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[/color][/ref]'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">footnote</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">, </span><span class="s3">'link'</span><span class="s2">)</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">nodes</span><span class="s2">.</span><span class="s1">footnote_reference</span><span class="s2">:</span>
            <span class="s5"># close opened footnote [x]</span>
            <span class="s5"># self.text += '[/ref]'</span>
            <span class="s5"># self.set_text(self.current, 'link')</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'[/color][/ref]'</span>
            <span class="s5"># self.text += '[/color][/ref]'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">+= </span><span class="s3">'&amp;br;'</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">role_doc</span><span class="s2">:</span>
            <span class="s1">docname </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">doc_index</span><span class="s2">:]</span>
            <span class="s1">rst_docname </span><span class="s2">= </span><span class="s1">docname</span>
            <span class="s4">if </span><span class="s1">rst_docname</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'.rst'</span><span class="s2">):</span>
                <span class="s1">docname </span><span class="s2">= </span><span class="s1">docname</span><span class="s2">[:-</span><span class="s6">4</span><span class="s2">]</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">rst_docname </span><span class="s2">+= </span><span class="s3">'.rst'</span>

            <span class="s5"># try to preload it</span>
            <span class="s1">filename </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">resolve_path</span><span class="s2">(</span><span class="s1">rst_docname</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">preload</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

            <span class="s5"># if exist, use the title of the first section found in the</span>
            <span class="s5"># document</span>
            <span class="s1">title </span><span class="s2">= </span><span class="s1">docname</span>
            <span class="s4">if </span><span class="s1">filename </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">toctrees</span><span class="s2">:</span>
                <span class="s1">toctree </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">toctrees</span><span class="s2">[</span><span class="s1">filename</span><span class="s2">]</span>
                <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">toctree</span><span class="s2">):</span>
                    <span class="s1">title </span><span class="s2">= </span><span class="s1">toctree</span><span class="s2">[</span><span class="s6">0</span><span class="s2">][</span><span class="s3">'title'</span><span class="s2">]</span>

            <span class="s5"># replace the text with a good reference</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s3">'[ref=%s]%s[/ref]' </span><span class="s2">% (</span>
                <span class="s1">rst_docname</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">colorize</span><span class="s2">(</span><span class="s1">title</span><span class="s2">, </span><span class="s3">'link'</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">[:</span><span class="s1">self</span><span class="s2">.</span><span class="s1">doc_index</span><span class="s2">] + </span><span class="s1">text</span>

        <span class="s4">elif </span><span class="s1">cls </span><span class="s4">is </span><span class="s1">role_video</span><span class="s2">:</span>
            <span class="s1">width </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'width'</span><span class="s2">] </span><span class="s4">if </span><span class="s3">'width' </span><span class="s4">in </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attlist</span><span class="s2">() </span><span class="s4">else </span><span class="s6">400</span>
            <span class="s1">height </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'height'</span><span class="s2">] </span><span class="s4">if </span><span class="s3">'height' </span><span class="s4">in </span><span class="s1">node</span><span class="s2">.</span><span class="s1">attlist</span><span class="s2">() </span><span class="s4">else </span><span class="s6">300</span>
            <span class="s1">uri </span><span class="s2">= </span><span class="s1">node</span><span class="s2">[</span><span class="s3">'source'</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">uri</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'/'</span><span class="s2">) </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">document_root</span><span class="s2">:</span>
                <span class="s1">uri </span><span class="s2">= </span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">document_root</span><span class="s2">, </span><span class="s1">uri</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:])</span>
            <span class="s1">video </span><span class="s2">= </span><span class="s1">RstVideoPlayer</span><span class="s2">(</span>
                <span class="s1">source</span><span class="s2">=</span><span class="s1">uri</span><span class="s2">,</span>
                <span class="s1">size_hint</span><span class="s2">=(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),</span>
                <span class="s1">size</span><span class="s2">=(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">))</span>
            <span class="s1">anchor </span><span class="s2">= </span><span class="s1">AnchorLayout</span><span class="s2">(</span><span class="s1">size_hint_y</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">height</span><span class="s2">=</span><span class="s1">height </span><span class="s2">+ </span><span class="s6">20</span><span class="s2">)</span>
            <span class="s1">anchor</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">video</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">current</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">anchor</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">set_text</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">):</span>
        <span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span>
        <span class="s4">if </span><span class="s1">parent </span><span class="s2">== </span><span class="s3">'term' </span><span class="s4">or </span><span class="s1">parent </span><span class="s2">== </span><span class="s3">'field_name'</span><span class="s2">:</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s3">'[b]%s[/b]' </span><span class="s2">% </span><span class="s1">text</span>
        <span class="s5"># search anchors</span>
        <span class="s1">node</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">colorize</span><span class="s2">(</span><span class="s1">text</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">)</span>
        <span class="s1">node</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">on_ref_press</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">on_ref_press</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">text_have_anchor</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">add_anchors</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">text_have_anchor </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">def </span><span class="s1">colorize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">text</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">'[color=%s]%s[/color]' </span><span class="s2">% (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">[</span><span class="s3">'paragraph'</span><span class="s2">]),</span>
            <span class="s1">text</span><span class="s2">)</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">base </span><span class="s4">import </span><span class="s1">runTouchApp</span>
    <span class="s4">import </span><span class="s1">sys</span>
    <span class="s1">runTouchApp</span><span class="s2">(</span><span class="s1">RstDocument</span><span class="s2">(</span><span class="s1">source</span><span class="s2">=</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]))</span>
</pre>
</body>
</html>