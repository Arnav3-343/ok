<html>
<head>
<title>gallery.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
gallery.py</font>
</center></td></tr></table>
<pre><span class="s0">''' Create rst documentation of the examples directory. 
 
This uses screenshots in the screenshots_dir 
(currently doc/sources/images/examples) along with source code and files 
in the examples/ directory to create rst files in the generation_dir 
(doc/sources/examples) gallery.rst, index.rst, and gen__*.rst 
 
'''</span>


<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">sep</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">join </span><span class="s2">as </span><span class="s1">slash  </span><span class="s4"># just like that name better</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">dirname</span><span class="s3">, </span><span class="s1">abspath</span>
<span class="s2">import </span><span class="s1">kivy</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">logger </span><span class="s2">import </span><span class="s1">Logger</span>
<span class="s2">import </span><span class="s1">textwrap</span>

<span class="s4"># from here to the kivy top</span>
<span class="s1">base_dir </span><span class="s3">= </span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">__file__</span><span class="s3">)))</span>
<span class="s1">examples_dir </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">base_dir</span><span class="s3">, </span><span class="s5">'examples'</span><span class="s3">)</span>
<span class="s1">screenshots_dir </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">base_dir</span><span class="s3">, </span><span class="s5">'doc/sources/images/examples'</span><span class="s3">)</span>
<span class="s1">generation_dir </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">base_dir</span><span class="s3">, </span><span class="s5">'doc/sources/examples'</span><span class="s3">)</span>

<span class="s1">image_dir </span><span class="s3">= </span><span class="s5">&quot;../images/examples/&quot;  </span><span class="s4"># relative to generation_dir</span>
<span class="s1">gallery_filename </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">generation_dir</span><span class="s3">, </span><span class="s5">'gallery.rst'</span><span class="s3">)</span>


<span class="s4"># Info is a dict built up from</span>
<span class="s4"># straight filename information, more from reading the docstring,</span>
<span class="s4"># and more from parsing the description text. Errors are often</span>
<span class="s4"># shown by setting the key 'error' with the value being the error message.</span>
<span class="s4">#</span>
<span class="s4"># It doesn't quite meet the requirements for a class, but is a vocabulary</span>
<span class="s4"># word in this module.</span>

<span class="s2">def </span><span class="s1">iter_filename_info</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Yield info (dict) of each matching screenshot found walking the 
    directory dir_name. A matching screenshot uses double underscores to 
    separate fields, i.e. path__to__filename__py.png as the screenshot for 
    examples/path/to/filename.py. 
 
    Files not ending with .png are ignored, others are either parsed or 
    yield an error. 
 
    Info fields 'dunder', 'dir', 'file', 'ext', 'source' if not 'error' 
    &quot;&quot;&quot;</span>
    <span class="s1">pattern </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'^((.+)__(.+)__([^-]+))\.png'</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">walk</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">filename </span><span class="s2">in </span><span class="s1">t</span><span class="s3">[</span><span class="s6">2</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">filename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s5">'.png'</span><span class="s3">):</span>
                <span class="s1">m </span><span class="s3">= </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">m </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s2">yield </span><span class="s3">{</span><span class="s5">'error'</span><span class="s3">: </span><span class="s5">'png filename not following screenshot'</span>
                                    <span class="s5">' pattern: {}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)}</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">d </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'__'</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">)</span>
                    <span class="s2">yield </span><span class="s3">{</span><span class="s5">'dunder'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">1</span><span class="s3">),</span>
                           <span class="s5">'dir'</span><span class="s3">: </span><span class="s1">d</span><span class="s3">,</span>
                           <span class="s5">'file'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">3</span><span class="s3">),</span>
                           <span class="s5">'ext'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">4</span><span class="s3">),</span>
                           <span class="s5">'source'</span><span class="s3">: </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">3</span><span class="s3">) + </span><span class="s5">'.' </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">4</span><span class="s3">))</span>
                           <span class="s3">}</span>


<span class="s2">def </span><span class="s1">parse_docstring_info</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
    <span class="s0">''' parse docstring from text (normal string with '\n's) and return an info 
    dict. A docstring should the first triple quoted string, have a title 
    followed by a line of equal signs, and then a description at 
    least one sentence long. 
 
    fields are 'docstring', 'title', and 'first_sentence' if not 'error' 
    'first_sentence' is a single line without newlines. 
    '''</span>
    <span class="s1">q </span><span class="s3">= </span><span class="s5">'</span><span class="s2">\&quot;\&quot;\&quot;</span><span class="s5">|</span><span class="s2">\'\'\'</span><span class="s5">'</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s5">r'({})\s+([^\n]+)\s+\=+\s+(.*?)(\1)'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">q</span><span class="s3">)</span>
    <span class="s1">m </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">S</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">m</span><span class="s3">:</span>
        <span class="s1">comment </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">3</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">, </span><span class="s5">' '</span><span class="s3">)</span>
        <span class="s1">first_sentence </span><span class="s3">= </span><span class="s1">comment</span><span class="s3">[:</span><span class="s1">comment</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">) + </span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s5">'docstring'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">0</span><span class="s3">), </span><span class="s5">'title'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">2</span><span class="s3">),</span>
                <span class="s5">'description'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s6">3</span><span class="s3">), </span><span class="s5">'first_sentence'</span><span class="s3">: </span><span class="s1">first_sentence</span><span class="s3">}</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s5">'error'</span><span class="s3">: </span><span class="s5">'Did not find docstring with title at top of file.'</span><span class="s3">}</span>


<span class="s2">def </span><span class="s1">iter_docstring_info</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">):</span>
    <span class="s0">''' Iterate over screenshots in directory, yield info from the file 
     name and initial parse of the docstring. Errors are logged, but 
     files with errors are skipped. 
    '''</span>
    <span class="s2">for </span><span class="s1">file_info </span><span class="s2">in </span><span class="s1">iter_filename_info</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s5">'error' </span><span class="s2">in </span><span class="s1">file_info</span><span class="s3">:</span>
            <span class="s1">Logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">'error'</span><span class="s3">])</span>
            <span class="s2">continue</span>
        <span class="s1">source </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">examples_dir</span><span class="s3">, </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">'dir'</span><span class="s3">],</span>
                       <span class="s1">file_info</span><span class="s3">[</span><span class="s5">'file'</span><span class="s3">] + </span><span class="s5">'.' </span><span class="s3">+ </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">'ext'</span><span class="s3">])</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
            <span class="s1">Logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s5">'Screen shot references source code that does '</span>
                         <span class="s5">'not exist:  %s'</span><span class="s3">, </span><span class="s1">source</span><span class="s3">)</span>
            <span class="s2">continue</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">source</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
            <span class="s1">docstring_info </span><span class="s3">= </span><span class="s1">parse_docstring_info</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s5">'error' </span><span class="s2">in </span><span class="s1">docstring_info</span><span class="s3">:</span>
                <span class="s1">Logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">docstring_info</span><span class="s3">[</span><span class="s5">'error'</span><span class="s3">] + </span><span class="s5">'  File: ' </span><span class="s3">+ </span><span class="s1">source</span><span class="s3">)</span>
                <span class="s2">continue  </span><span class="s4"># don't want to show ugly entries</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">file_info</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">docstring_info</span><span class="s3">)</span>
        <span class="s2">yield </span><span class="s1">file_info</span>


<span class="s2">def </span><span class="s1">enhance_info_description</span><span class="s3">(</span><span class="s1">info</span><span class="s3">, </span><span class="s1">line_length</span><span class="s3">=</span><span class="s6">79</span><span class="s3">):</span>
    <span class="s0">''' Using the info['description'], add fields to info. 
 
    info['files'] is the source filename and any filenames referenced by the 
    magic words in the description, e.g. 'the file xxx.py' or 
    'The image this.png'. These are as written in the description, do 
    not allow ../dir notation, and are relative to the source directory. 
 
    info['enhanced_description'] is the description, as an array of 
    paragraphs where each paragraph is an array of lines wrapped to width 
    line_length. This enhanced description include the rst links to 
    the files of info['files']. 
    '''</span>

    <span class="s4"># make text a set of long lines, one per paragraph.</span>
    <span class="s1">paragraphs </span><span class="s3">= </span><span class="s1">info</span><span class="s3">[</span><span class="s5">'description'</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n\n</span><span class="s5">'</span><span class="s3">)</span>
    <span class="s1">lines </span><span class="s3">= [</span>
        <span class="s1">paragraph</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">, </span><span class="s5">'$newline$'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">paragraph </span><span class="s2">in </span><span class="s1">paragraphs</span>
    <span class="s3">]</span>
    <span class="s1">text </span><span class="s3">= </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">)</span>

    <span class="s1">info</span><span class="s3">[</span><span class="s5">'files'</span><span class="s3">] = [</span><span class="s1">info</span><span class="s3">[</span><span class="s5">'file'</span><span class="s3">] + </span><span class="s5">'.' </span><span class="s3">+ </span><span class="s1">info</span><span class="s3">[</span><span class="s5">'ext'</span><span class="s3">]]</span>
    <span class="s1">regex </span><span class="s3">= </span><span class="s5">r'[tT]he (?:file|image) ([\w\/]+\.\w+)'</span>
    <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">re</span><span class="s3">.</span><span class="s1">findall</span><span class="s3">(</span><span class="s1">regex</span><span class="s3">, </span><span class="s1">text</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s2">not in </span><span class="s1">info</span><span class="s3">[</span><span class="s5">'files'</span><span class="s3">]:</span>
            <span class="s1">info</span><span class="s3">[</span><span class="s5">'files'</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s4"># add links where the files are referenced</span>
    <span class="s1">folder </span><span class="s3">= </span><span class="s5">'_'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">info</span><span class="s3">[</span><span class="s5">'source'</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s1">sep</span><span class="s3">)[:-</span><span class="s6">1</span><span class="s3">]) + </span><span class="s5">'_'</span>
    <span class="s1">text </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">(</span><span class="s5">r'([tT]he (?:file|image) )([\w\/]+\.\w+)'</span><span class="s3">,</span>
                  <span class="s5">r'\1:ref:`\2 &lt;$folder$\2&gt;`'</span><span class="s3">, </span><span class="s1">text</span><span class="s3">)</span>
    <span class="s1">text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'$folder$'</span><span class="s3">, </span><span class="s1">folder</span><span class="s3">)</span>

    <span class="s4"># now break up text into array of paragraphs, each an array of lines.</span>
    <span class="s1">lines </span><span class="s3">= [</span><span class="s1">line</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'$newline$'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">) </span><span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">)]</span>
    <span class="s1">paragraphs </span><span class="s3">= [</span>
        <span class="s1">textwrap</span><span class="s3">.</span><span class="s1">wrap</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">line_length</span><span class="s3">)</span>
        <span class="s4"># ignore wrapping if .. note:: or similar block</span>
        <span class="s2">if not </span><span class="s1">line</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">' '</span><span class="s3">) </span><span class="s2">else </span><span class="s3">[</span><span class="s1">line</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">lines</span>
    <span class="s3">]</span>
    <span class="s1">info</span><span class="s3">[</span><span class="s5">'enhanced_description'</span><span class="s3">] = </span><span class="s1">paragraphs</span>


<span class="s2">def </span><span class="s1">get_infos</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">):</span>
    <span class="s0">''' return infos, an array info dicts for each matching screenshot in the 
    dir, sorted by source file name, and adding the field 'num' as he unique 
    order in this array of dicts'. 
 
    '''</span>
    <span class="s1">infos </span><span class="s3">= [</span><span class="s1">i </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">iter_docstring_info</span><span class="s3">(</span><span class="s1">dir_name</span><span class="s3">)]</span>
    <span class="s1">infos</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">[</span><span class="s5">'source'</span><span class="s3">])</span>
    <span class="s2">for </span><span class="s1">num</span><span class="s3">, </span><span class="s1">info </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">infos</span><span class="s3">):</span>
        <span class="s1">info</span><span class="s3">[</span><span class="s5">'num'</span><span class="s3">] = </span><span class="s1">num</span>
        <span class="s1">enhance_info_description</span><span class="s3">(</span><span class="s1">info</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">infos</span>


<span class="s2">def </span><span class="s1">make_gallery_page</span><span class="s3">(</span><span class="s1">infos</span><span class="s3">):</span>
    <span class="s0">''' return string of the rst (Restructured Text) of the gallery page, 
    showing information on all screenshots found. 
    '''</span>

    <span class="s1">gallery_top </span><span class="s3">= </span><span class="s5">''' 
Gallery 
------- 
 
.. _Tutorials:  ../tutorials-index.html 
 
.. container:: title 
 
    This gallery lets you explore the many examples included with Kivy. 
    Click on any screenshot to see the code. 
 
This gallery contains: 
 
    * Examples from the examples/ directory that show specific capabilities of 
      different libraries and features of Kivy. 
    * Demonstrations from the examples/demos/ directory that explore many of 
      Kivy's abilities. 
 
There are more Kivy programs elsewhere: 
 
    * Tutorials_ walks through the development of complete Kivy applications. 
    * Unit tests found in the source code under the subdirectory kivy/tests/ 
      can also be useful. 
 
We hope your journey into learning Kivy is exciting and fun! 
 
'''</span>
    <span class="s1">output </span><span class="s3">= [</span><span class="s1">gallery_top</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">info </span><span class="s2">in </span><span class="s1">infos</span><span class="s3">:</span>
        <span class="s1">output</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                <span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">**{title}** (:doc:`{source}&lt;gen__{dunder}&gt;`)</span><span class="s2">\n</span><span class="s5">&quot;</span>
                <span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">{description}&quot;</span>
                <span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">.. image:: ../images/examples/{dunder}.png&quot;</span>
                <span class="s5">&quot;</span><span class="s2">\n  </span><span class="s5">:width:  216pt&quot;</span>
                <span class="s5">&quot;</span><span class="s2">\n  </span><span class="s5">:align:  left&quot;</span>
                <span class="s5">&quot;</span><span class="s2">\n  </span><span class="s5">:target: gen__{dunder}.html&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(**</span><span class="s1">info</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">output</span><span class="s3">) + </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span>


<span class="s2">def </span><span class="s1">make_detail_page</span><span class="s3">(</span><span class="s1">info</span><span class="s3">):</span>
    <span class="s0">''' return str of the rst text for the detail page of the file in info. '''</span>

    <span class="s2">def </span><span class="s1">a</span><span class="s3">(</span><span class="s1">s</span><span class="s3">=</span><span class="s5">''</span><span class="s3">):</span>
        <span class="s0">''' append formatted s to output, which will be joined into lines '''</span>
        <span class="s1">output</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(**</span><span class="s1">info</span><span class="s3">))</span>

    <span class="s1">output </span><span class="s3">= []</span>
    <span class="s1">a</span><span class="s3">(</span><span class="s5">'{title}'</span><span class="s3">)</span>
    <span class="s1">a</span><span class="s3">(</span><span class="s5">'=' </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">info</span><span class="s3">[</span><span class="s5">'title'</span><span class="s3">]))</span>
    <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">.. |pic{num}| image:: /images/examples/{dunder}.png'</span>
      <span class="s5">'</span><span class="s2">\n   </span><span class="s5">:width: 50%'</span>
      <span class="s5">'</span><span class="s2">\n   </span><span class="s5">:align: middle'</span><span class="s3">)</span>
    <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">|pic{num}|'</span><span class="s3">)</span>
    <span class="s1">a</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">paragraph </span><span class="s2">in </span><span class="s1">info</span><span class="s3">[</span><span class="s5">'enhanced_description'</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">paragraph</span><span class="s3">:</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
        <span class="s1">a</span><span class="s3">()</span>

    <span class="s4"># include images</span>
    <span class="s1">last_lang </span><span class="s3">= </span><span class="s5">'.py'</span>
    <span class="s2">for </span><span class="s1">fname </span><span class="s2">in </span><span class="s1">info</span><span class="s3">[</span><span class="s5">'files'</span><span class="s3">]:</span>
        <span class="s1">full_name </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">info</span><span class="s3">[</span><span class="s5">'dir'</span><span class="s3">], </span><span class="s1">fname</span><span class="s3">)</span>
        <span class="s1">ext </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s5">r'\.\w+$'</span><span class="s3">, </span><span class="s1">fname</span><span class="s3">).</span><span class="s1">group</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
        <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">.. _`' </span><span class="s3">+ </span><span class="s1">full_name</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">sep</span><span class="s3">, </span><span class="s5">'_'</span><span class="s3">) + </span><span class="s5">'`:'</span><span class="s3">)</span>
        <span class="s4"># double separator if building on windows (sphinx skips backslash)</span>
        <span class="s2">if </span><span class="s5">'</span><span class="s2">\\</span><span class="s5">' </span><span class="s2">in </span><span class="s1">full_name</span><span class="s3">:</span>
            <span class="s1">full_name </span><span class="s3">= </span><span class="s1">full_name</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">sep</span><span class="s3">, </span><span class="s1">sep </span><span class="s3">* </span><span class="s6">2</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">ext </span><span class="s2">in </span><span class="s3">[</span><span class="s5">'.png'</span><span class="s3">, </span><span class="s5">'.jpg'</span><span class="s3">, </span><span class="s5">'.jpeg'</span><span class="s3">]:</span>
            <span class="s1">title </span><span class="s3">= </span><span class="s5">'Image **' </span><span class="s3">+ </span><span class="s1">full_name </span><span class="s3">+ </span><span class="s5">'**'</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">+ </span><span class="s1">title</span><span class="s3">)</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'~' </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">title</span><span class="s3">))</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">.. image:: ../../../examples/' </span><span class="s3">+ </span><span class="s1">full_name</span><span class="s3">)</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'    :align: ' ' center'</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:  </span><span class="s4"># code</span>
            <span class="s1">title </span><span class="s3">= </span><span class="s5">'File **' </span><span class="s3">+ </span><span class="s1">full_name </span><span class="s3">+ </span><span class="s5">'**'</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">+ </span><span class="s1">title</span><span class="s3">)</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'~' </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">title</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">ext </span><span class="s3">!= </span><span class="s1">last_lang </span><span class="s2">and </span><span class="s1">ext </span><span class="s3">!= </span><span class="s5">'.txt'</span><span class="s3">:</span>
                <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">.. highlight:: ' </span><span class="s3">+ </span><span class="s1">ext</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:])</span>
                <span class="s1">a</span><span class="s3">(</span><span class="s5">'    :linenothreshold: 3'</span><span class="s3">)</span>
                <span class="s1">last_lang </span><span class="s3">= </span><span class="s1">ext</span>
            <span class="s4"># prevent highlight errors with 'none'</span>
            <span class="s2">elif </span><span class="s1">ext </span><span class="s3">== </span><span class="s5">'.txt'</span><span class="s3">:</span>
                <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">.. highlight:: none'</span><span class="s3">)</span>
                <span class="s1">a</span><span class="s3">(</span><span class="s5">'    :linenothreshold: 3'</span><span class="s3">)</span>
                <span class="s1">last_lang </span><span class="s3">= </span><span class="s1">ext</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">.. include:: ../../../examples/' </span><span class="s3">+ </span><span class="s1">full_name</span><span class="s3">)</span>
            <span class="s1">a</span><span class="s3">(</span><span class="s5">'    :code:'</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">output</span><span class="s3">) + </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span>


<span class="s2">def </span><span class="s1">write_file</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">s</span><span class="s3">):</span>
    <span class="s0">''' write the string to the filename '''</span>

    <span class="s4"># Make sure all the directories has been created before</span>
    <span class="s4"># trying to write to the file</span>
    <span class="s1">directory </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">directory</span><span class="s3">):</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">directory</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s5">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">make_index</span><span class="s3">(</span><span class="s1">infos</span><span class="s3">):</span>
    <span class="s0">''' return string of the rst for the gallery's index.rst file. '''</span>
    <span class="s1">start_string </span><span class="s3">= </span><span class="s5">''' 
Gallery of Examples 
=================== 
 
.. toctree:: 
    :maxdepth: 1 
 
    gallery'''</span>
    <span class="s1">output </span><span class="s3">= [</span><span class="s1">start_string</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">info </span><span class="s2">in </span><span class="s1">infos</span><span class="s3">:</span>
        <span class="s1">output</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">'    gen__{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">info</span><span class="s3">[</span><span class="s5">'dunder'</span><span class="s3">]))</span>
    <span class="s2">return </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">output</span><span class="s3">) + </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span>


<span class="s2">def </span><span class="s1">write_all_rst_pages</span><span class="s3">():</span>
    <span class="s0">''' Do the main task of writing the gallery, 
    detail, and index rst pages. 
    '''</span>
    <span class="s1">infos </span><span class="s3">= </span><span class="s1">get_infos</span><span class="s3">(</span><span class="s1">screenshots_dir</span><span class="s3">)</span>
    <span class="s1">s </span><span class="s3">= </span><span class="s1">make_gallery_page</span><span class="s3">(</span><span class="s1">infos</span><span class="s3">)</span>
    <span class="s1">write_file</span><span class="s3">(</span><span class="s1">gallery_filename</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">info </span><span class="s2">in </span><span class="s1">infos</span><span class="s3">:</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">make_detail_page</span><span class="s3">(</span><span class="s1">info</span><span class="s3">)</span>
        <span class="s1">detail_name </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">generation_dir</span><span class="s3">,</span>
                            <span class="s5">'gen__{}.rst'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">info</span><span class="s3">[</span><span class="s5">'dunder'</span><span class="s3">]))</span>
        <span class="s1">write_file</span><span class="s3">(</span><span class="s1">detail_name</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>

    <span class="s1">s </span><span class="s3">= </span><span class="s1">make_index</span><span class="s3">(</span><span class="s1">infos</span><span class="s3">)</span>
    <span class="s1">index_name </span><span class="s3">= </span><span class="s1">slash</span><span class="s3">(</span><span class="s1">generation_dir</span><span class="s3">, </span><span class="s5">'index.rst'</span><span class="s3">)</span>
    <span class="s1">write_file</span><span class="s3">(</span><span class="s1">index_name</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>
    <span class="s1">Logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s5">'gallery.py: Created gallery rst documentation pages.'</span><span class="s3">)</span>


<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s5">'__main__'</span><span class="s3">:</span>
    <span class="s1">write_all_rst_pages</span><span class="s3">()</span>
</pre>
</body>
</html>