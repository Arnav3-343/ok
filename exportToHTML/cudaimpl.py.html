<html>
<head>
<title>cudaimpl.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
cudaimpl.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">reduce</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">math</span>

<span class="s0">from </span><span class="s1">llvmlite </span><span class="s0">import </span><span class="s1">ir</span>
<span class="s0">import </span><span class="s1">llvmlite</span><span class="s2">.</span><span class="s1">binding </span><span class="s0">as </span><span class="s1">ll</span>

<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">imputils </span><span class="s0">import </span><span class="s1">Registry</span><span class="s2">, </span><span class="s1">lower_cast</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">npydecl </span><span class="s0">import </span><span class="s1">parse_dtype</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">datamodel </span><span class="s0">import </span><span class="s1">models</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core </span><span class="s0">import </span><span class="s1">types</span><span class="s2">, </span><span class="s1">cgutils</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">np </span><span class="s0">import </span><span class="s1">ufunc_db</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">np</span><span class="s2">.</span><span class="s1">npyimpl </span><span class="s0">import </span><span class="s1">register_ufuncs</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">cudadrv </span><span class="s0">import </span><span class="s1">nvvm</span>
<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">cuda</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda </span><span class="s0">import </span><span class="s1">nvvmutils</span><span class="s2">, </span><span class="s1">stubs</span><span class="s2">, </span><span class="s1">errors</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">types </span><span class="s0">import </span><span class="s1">dim3</span><span class="s2">, </span><span class="s1">CUDADispatcher</span>

<span class="s1">registry </span><span class="s2">= </span><span class="s1">Registry</span><span class="s2">()</span>
<span class="s1">lower </span><span class="s2">= </span><span class="s1">registry</span><span class="s2">.</span><span class="s1">lower</span>
<span class="s1">lower_attr </span><span class="s2">= </span><span class="s1">registry</span><span class="s2">.</span><span class="s1">lower_getattr</span>
<span class="s1">lower_constant </span><span class="s2">= </span><span class="s1">registry</span><span class="s2">.</span><span class="s1">lower_constant</span>


<span class="s0">def </span><span class="s1">initialize_dim3</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">call_sreg</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">&quot;%s.x&quot; </span><span class="s2">% </span><span class="s1">prefix</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">call_sreg</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">&quot;%s.y&quot; </span><span class="s2">% </span><span class="s1">prefix</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">call_sreg</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">&quot;%s.z&quot; </span><span class="s2">% </span><span class="s1">prefix</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">pack_struct</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Module</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">), </span><span class="s3">'threadIdx'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_threadIdx</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">initialize_dim3</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">'tid'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Module</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">), </span><span class="s3">'blockDim'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_blockDim</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">initialize_dim3</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">'ntid'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Module</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">), </span><span class="s3">'blockIdx'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_blockIdx</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">initialize_dim3</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">'ctaid'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Module</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">), </span><span class="s3">'gridDim'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_gridDim</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">initialize_dim3</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">'nctaid'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Module</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">), </span><span class="s3">'laneid'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_laneid</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">call_sreg</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s3">'laneid'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">dim3</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">dim3_x</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">dim3</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">dim3_y</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_attr</span><span class="s2">(</span><span class="s1">dim3</span><span class="s2">, </span><span class="s3">'z'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">dim3_z</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>


<span class="s5"># -----------------------------------------------------------------------------</span>

<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">const</span><span class="s2">.</span><span class="s1">array_like</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_const_array_like</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s5"># This is a no-op because CUDATargetContext.make_constant_array already</span>
    <span class="s5"># created the constant array.</span>
    <span class="s0">return </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>


<span class="s1">_unique_smem_id </span><span class="s2">= </span><span class="s4">0</span>


<span class="s0">def </span><span class="s1">_get_unique_smem_id</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Due to bug with NVVM invalid internalizing of shared memory in the 
    PTX output.  We can't mark shared memory to be internal. We have to 
    ensure unique name is generated for shared memory symbol. 
    &quot;&quot;&quot;</span>
    <span class="s0">global </span><span class="s1">_unique_smem_id</span>
    <span class="s1">_unique_smem_id </span><span class="s2">+= </span><span class="s4">1</span>
    <span class="s0">return </span><span class="s3">&quot;{0}_{1}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">_unique_smem_id</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">shared</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">IntegerLiteral</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_shared_array_integer</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">length </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">literal_value</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">parse_dtype</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">_generic_array</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">length</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">,</span>
                          <span class="s1">symbol_name</span><span class="s2">=</span><span class="s1">_get_unique_smem_id</span><span class="s2">(</span><span class="s3">'_cudapy_smem'</span><span class="s2">),</span>
                          <span class="s1">addrspace</span><span class="s2">=</span><span class="s1">nvvm</span><span class="s2">.</span><span class="s1">ADDRSPACE_SHARED</span><span class="s2">,</span>
                          <span class="s1">can_dynsized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">shared</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">shared</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_shared_array_tuple</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">shape </span><span class="s2">= [ </span><span class="s1">s</span><span class="s2">.</span><span class="s1">literal_value </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] ]</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">parse_dtype</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">_generic_array</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">,</span>
                          <span class="s1">symbol_name</span><span class="s2">=</span><span class="s1">_get_unique_smem_id</span><span class="s2">(</span><span class="s3">'_cudapy_smem'</span><span class="s2">),</span>
                          <span class="s1">addrspace</span><span class="s2">=</span><span class="s1">nvvm</span><span class="s2">.</span><span class="s1">ADDRSPACE_SHARED</span><span class="s2">,</span>
                          <span class="s1">can_dynsized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">local</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">IntegerLiteral</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_local_array_integer</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">length </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">literal_value</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">parse_dtype</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">_generic_array</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">length</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">,</span>
                          <span class="s1">symbol_name</span><span class="s2">=</span><span class="s3">'_cudapy_lmem'</span><span class="s2">,</span>
                          <span class="s1">addrspace</span><span class="s2">=</span><span class="s1">nvvm</span><span class="s2">.</span><span class="s1">ADDRSPACE_LOCAL</span><span class="s2">,</span>
                          <span class="s1">can_dynsized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">local</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">local</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_lmem_alloc_array</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">shape </span><span class="s2">= [ </span><span class="s1">s</span><span class="s2">.</span><span class="s1">literal_value </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] ]</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">parse_dtype</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">_generic_array</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">,</span>
                          <span class="s1">symbol_name</span><span class="s2">=</span><span class="s3">'_cudapy_lmem'</span><span class="s2">,</span>
                          <span class="s1">addrspace</span><span class="s2">=</span><span class="s1">nvvm</span><span class="s2">.</span><span class="s1">ADDRSPACE_LOCAL</span><span class="s2">,</span>
                          <span class="s1">can_dynsized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">threadfence_block</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_threadfence_block</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">assert not </span><span class="s1">args</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.membar.cta'</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), ())</span>
    <span class="s1">sync </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">sync</span><span class="s2">, ())</span>
    <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">threadfence_system</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_threadfence_system</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">assert not </span><span class="s1">args</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.membar.sys'</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), ())</span>
    <span class="s1">sync </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">sync</span><span class="s2">, ())</span>
    <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">threadfence</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_threadfence_device</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">assert not </span><span class="s1">args</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.membar.gl'</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), ())</span>
    <span class="s1">sync </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">sync</span><span class="s2">, ())</span>
    <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">syncwarp</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_syncwarp</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s4">0xFFFFFFFF</span><span class="s2">)</span>
    <span class="s1">mask_sig </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">none</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ptx_syncwarp_mask</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">mask_sig</span><span class="s2">, [</span><span class="s1">mask</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">syncwarp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_syncwarp_mask</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.bar.warp.sync'</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">),))</span>
    <span class="s1">sync </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">sync</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">shfl_sync_intrinsic</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">,</span>
       <span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">shfl_sync_intrinsic</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i8</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">,</span>
       <span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">shfl_sync_intrinsic</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">,</span>
       <span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">shfl_sync_intrinsic</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">,</span>
       <span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_shfl_sync_i32</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    The NVVM intrinsic for shfl only supports i32, but the cuda intrinsic 
    function supports both 32 and 64 bit ints and floats, so for feature parity, 
    i64, f32, and f64 are implemented. Floats by way of bitcasting the float to 
    an int, then shuffling, then bitcasting back. And 64-bit values by packing 
    them into 2 32bit values, shuffling thoose, and then packing back together. 
    &quot;&quot;&quot;</span>
    <span class="s1">mask</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">clamp </span><span class="s2">= </span><span class="s1">args</span>
    <span class="s1">value_type </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">value_type </span><span class="s0">in </span><span class="s1">types</span><span class="s2">.</span><span class="s1">real_domain</span><span class="s2">:</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">value_type</span><span class="s2">.</span><span class="s1">bitwidth</span><span class="s2">))</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.shfl.sync.i32'</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">LiteralStructType</span><span class="s2">((</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))),</span>
                            <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">),</span>
                             <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">))</span>
    <span class="s2">)</span>
    <span class="s1">func </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">value_type</span><span class="s2">.</span><span class="s1">bitwidth </span><span class="s2">== </span><span class="s4">32</span><span class="s2">:</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, (</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">clamp</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">value_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
            <span class="s1">rv </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">pred </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">fv </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">rv</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">())</span>
            <span class="s1">ret </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">make_anonymous_struct</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">fv</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">value1 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">))</span>
        <span class="s1">value_lshr </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">lshr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">i8</span><span class="s2">, </span><span class="s4">32</span><span class="s2">))</span>
        <span class="s1">value2 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">(</span><span class="s1">value_lshr</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">))</span>
        <span class="s1">ret1 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, (</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">value1</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">clamp</span><span class="s2">))</span>
        <span class="s1">ret2 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, (</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">value2</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">clamp</span><span class="s2">))</span>
        <span class="s1">rv1 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">ret1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">rv2 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">ret2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">pred </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">extract_value</span><span class="s2">(</span><span class="s1">ret1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">rv1_64 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">zext</span><span class="s2">(</span><span class="s1">rv1</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">64</span><span class="s2">))</span>
        <span class="s1">rv2_64 </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">zext</span><span class="s2">(</span><span class="s1">rv2</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">64</span><span class="s2">))</span>
        <span class="s1">rv_shl </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">shl</span><span class="s2">(</span><span class="s1">rv2_64</span><span class="s2">, </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">i8</span><span class="s2">, </span><span class="s4">32</span><span class="s2">))</span>
        <span class="s1">rv </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">(</span><span class="s1">rv_shl</span><span class="s2">, </span><span class="s1">rv1_64</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value_type </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">:</span>
            <span class="s1">rv </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">rv</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">())</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">make_anonymous_struct</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, (</span><span class="s1">rv</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">ret</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">vote_sync_intrinsic</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">boolean</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_vote_sync</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.vote.sync'</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">LiteralStructType</span><span class="s2">((</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">),</span>
                                                 <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))),</span>
                           <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)))</span>
    <span class="s1">func </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_any_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_any_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i8</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_any_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_any_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_match_any_sync</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">mask</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span>
    <span class="s1">width </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">bitwidth</span>
    <span class="s0">if </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">in </span><span class="s1">types</span><span class="s2">.</span><span class="s1">real_domain</span><span class="s2">:</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">width</span><span class="s2">))</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.match.any.sync.i{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">width</span><span class="s2">)</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">width</span><span class="s2">)))</span>
    <span class="s1">func </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, (</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_all_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_all_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i8</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_all_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">match_all_sync</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_match_all_sync</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">mask</span><span class="s2">, </span><span class="s1">value </span><span class="s2">= </span><span class="s1">args</span>
    <span class="s1">width </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">bitwidth</span>
    <span class="s0">if </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">in </span><span class="s1">types</span><span class="s2">.</span><span class="s1">real_domain</span><span class="s2">:</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">width</span><span class="s2">))</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s3">'llvm.nvvm.match.all.sync.i{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">width</span><span class="s2">)</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">LiteralStructType</span><span class="s2">((</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">),</span>
                                                 <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))),</span>
                           <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s1">width</span><span class="s2">)))</span>
    <span class="s1">func </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, (</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">activemask</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_activemask</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">activemask </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), []),</span>
                              <span class="s3">&quot;activemask.b32 $0;&quot;</span><span class="s2">, </span><span class="s3">'=r'</span><span class="s2">, </span><span class="s1">side_effect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">activemask</span><span class="s2">, [])</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">lanemask_lt</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_lanemask_lt</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">activemask </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), []),</span>
                              <span class="s3">&quot;mov.u32 $0, %lanemask_lt;&quot;</span><span class="s2">, </span><span class="s3">'=r'</span><span class="s2">,</span>
                              <span class="s1">side_effect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">activemask</span><span class="s2">, [])</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">popc</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_popc</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">ctpop</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fma</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_fma</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">fma</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">float16_float_ty_constraint</span><span class="s2">(</span><span class="s1">bitwidth</span><span class="s2">):</span>
    <span class="s1">typemap </span><span class="s2">= {</span><span class="s4">32</span><span class="s2">: (</span><span class="s3">'f32'</span><span class="s2">, </span><span class="s3">'f'</span><span class="s2">), </span><span class="s4">64</span><span class="s2">: (</span><span class="s3">'f64'</span><span class="s2">, </span><span class="s3">'d'</span><span class="s2">)}</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">typemap</span><span class="s2">[</span><span class="s1">bitwidth</span><span class="s2">]</span>
    <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">f&quot;Conversion between float16 and float</span><span class="s0">{</span><span class="s1">bitwidth</span><span class="s0">} </span><span class="s3">unsupported&quot;</span>
        <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">CudaLoweringError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_cast</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Float</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">float16_to_float_cast</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">fromty</span><span class="s2">.</span><span class="s1">bitwidth </span><span class="s2">== </span><span class="s1">toty</span><span class="s2">.</span><span class="s1">bitwidth</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">val</span>

    <span class="s1">ty</span><span class="s2">, </span><span class="s1">constraint </span><span class="s2">= </span><span class="s1">float16_float_ty_constraint</span><span class="s2">(</span><span class="s1">toty</span><span class="s2">.</span><span class="s1">bitwidth</span><span class="s2">)</span>

    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">toty</span><span class="s2">), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)])</span>
    <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s3">f&quot;cvt.</span><span class="s0">{</span><span class="s1">ty</span><span class="s0">}</span><span class="s3">.f16 $0, $1;&quot;</span><span class="s2">, </span><span class="s3">f&quot;=</span><span class="s0">{</span><span class="s1">constraint</span><span class="s0">}</span><span class="s3">,h&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">lower_cast</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Float</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">float_to_float16_cast</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">fromty</span><span class="s2">.</span><span class="s1">bitwidth </span><span class="s2">== </span><span class="s1">toty</span><span class="s2">.</span><span class="s1">bitwidth</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">val</span>

    <span class="s1">ty</span><span class="s2">, </span><span class="s1">constraint </span><span class="s2">= </span><span class="s1">float16_float_ty_constraint</span><span class="s2">(</span><span class="s1">fromty</span><span class="s2">.</span><span class="s1">bitwidth</span><span class="s2">)</span>

    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), [</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">fromty</span><span class="s2">)])</span>
    <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s3">f&quot;cvt.rn.f16.</span><span class="s0">{</span><span class="s1">ty</span><span class="s0">} </span><span class="s3">$0, $1;&quot;</span><span class="s2">, </span><span class="s3">f&quot;=h,</span><span class="s0">{</span><span class="s1">constraint</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">float16_int_constraint</span><span class="s2">(</span><span class="s1">bitwidth</span><span class="s2">):</span>
    <span class="s1">typemap </span><span class="s2">= { </span><span class="s4">8</span><span class="s2">: </span><span class="s3">'c'</span><span class="s2">, </span><span class="s4">16</span><span class="s2">: </span><span class="s3">'h'</span><span class="s2">, </span><span class="s4">32</span><span class="s2">: </span><span class="s3">'r'</span><span class="s2">, </span><span class="s4">64</span><span class="s2">: </span><span class="s3">'l' </span><span class="s2">}</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">typemap</span><span class="s2">[</span><span class="s1">bitwidth</span><span class="s2">]</span>
    <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">f&quot;Conversion between float16 and int</span><span class="s0">{</span><span class="s1">bitwidth</span><span class="s0">} </span><span class="s3">unsupported&quot;</span>
        <span class="s0">raise </span><span class="s1">errors</span><span class="s2">.</span><span class="s1">CudaLoweringError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower_cast</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Integer</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">float16_to_integer_cast</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">bitwidth </span><span class="s2">= </span><span class="s1">toty</span><span class="s2">.</span><span class="s1">bitwidth</span>
    <span class="s1">constraint </span><span class="s2">= </span><span class="s1">float16_int_constraint</span><span class="s2">(</span><span class="s1">bitwidth</span><span class="s2">)</span>
    <span class="s1">signedness </span><span class="s2">= </span><span class="s3">'s' </span><span class="s0">if </span><span class="s1">toty</span><span class="s2">.</span><span class="s1">signed </span><span class="s0">else </span><span class="s3">'u'</span>

    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">toty</span><span class="s2">), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)])</span>
    <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">,</span>
                       <span class="s3">f&quot;cvt.rni.</span><span class="s0">{</span><span class="s1">signedness</span><span class="s0">}{</span><span class="s1">bitwidth</span><span class="s0">}</span><span class="s3">.f16 $0, $1;&quot;</span><span class="s2">,</span>
                       <span class="s3">f&quot;=</span><span class="s0">{</span><span class="s1">constraint</span><span class="s0">}</span><span class="s3">,h&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">lower_cast</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Integer</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower_cast</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">IntegerLiteral</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">integer_to_float16_cast</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">fromty</span><span class="s2">, </span><span class="s1">toty</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">bitwidth </span><span class="s2">= </span><span class="s1">fromty</span><span class="s2">.</span><span class="s1">bitwidth</span>
    <span class="s1">constraint </span><span class="s2">= </span><span class="s1">float16_int_constraint</span><span class="s2">(</span><span class="s1">bitwidth</span><span class="s2">)</span>
    <span class="s1">signedness </span><span class="s2">= </span><span class="s3">'s' </span><span class="s0">if </span><span class="s1">fromty</span><span class="s2">.</span><span class="s1">signed </span><span class="s0">else </span><span class="s3">'u'</span>

    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">),</span>
                           <span class="s2">[</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">fromty</span><span class="s2">)])</span>
    <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">,</span>
                       <span class="s3">f&quot;cvt.rn.f16.</span><span class="s0">{</span><span class="s1">signedness</span><span class="s0">}{</span><span class="s1">bitwidth</span><span class="s0">} </span><span class="s3">$0, $1;&quot;</span><span class="s2">,</span>
                       <span class="s3">f&quot;=h,</span><span class="s0">{</span><span class="s1">constraint</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, [</span><span class="s1">val</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">ptx_fp16_binary</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">),</span>
                               <span class="s2">[</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)])</span>
        <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s3">f'</span><span class="s0">{</span><span class="s1">op</span><span class="s0">}</span><span class="s3">.f16 $0,$1,$2;'</span><span class="s2">, </span><span class="s3">'=h,h,h'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hadd</span><span class="s2">, </span><span class="s3">'add'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s3">'add'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">iadd</span><span class="s2">, </span><span class="s3">'add'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hsub</span><span class="s2">, </span><span class="s3">'sub'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">, </span><span class="s3">'sub'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">isub</span><span class="s2">, </span><span class="s3">'sub'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hmul</span><span class="s2">, </span><span class="s3">'mul'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">mul</span><span class="s2">, </span><span class="s3">'mul'</span><span class="s2">)</span>
<span class="s1">lower_fp16_binary</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">imul</span><span class="s2">, </span><span class="s3">'mul'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hneg</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_fp16_hneg</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)])</span>
    <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s3">'neg.f16 $0, $1;'</span><span class="s2">, </span><span class="s3">'=h,h'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">neg</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">operator_hneg</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">ptx_fp16_hneg</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">habs</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_fp16_habs</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)])</span>
    <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s3">'abs.f16 $0, $1;'</span><span class="s2">, </span><span class="s3">'=h,h'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">operator_habs</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">ptx_fp16_habs</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hfma</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_hfma</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">argtys </span><span class="s2">= [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)]</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), </span><span class="s1">argtys</span><span class="s2">)</span>
    <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s3">&quot;fma.rn.f16 $0,$1,$2,$3;&quot;</span><span class="s2">, </span><span class="s3">&quot;=h,h,h,h&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">truediv</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">itruediv</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">fp16_div_impl</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">fp16_div</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hdiv</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">fp16_div</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s1">_fp16_cmp </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;{{ 
          .reg .pred __$$f16_cmp_tmp; 
          setp.{op}.f16 __$$f16_cmp_tmp, $1, $2; 
          selp.u16 $0, 1, 0, __$$f16_cmp_tmp; 
        }}&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s1">op</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">ptx_fp16_comparison</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">)])</span>
        <span class="s1">asm </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">_fp16_cmp</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">), </span><span class="s3">'=h,h,h'</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">asm</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

        <span class="s1">zero </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">int_result </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">16</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">icmp_unsigned</span><span class="s2">(</span><span class="s3">&quot;!=&quot;</span><span class="s2">, </span><span class="s1">int_result</span><span class="s2">, </span><span class="s1">zero</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ptx_fp16_comparison</span>


<span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">heq</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'eq'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">eq</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'eq'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hne</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'ne'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ne</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'ne'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hge</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'ge'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ge</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'ge'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hgt</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'gt'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">gt</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'gt'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hle</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'le'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">le</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'le'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hlt</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'lt'</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lt</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)(</span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s3">'lt'</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">lower_fp16_minmax</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">ptx_fp16_minmax</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">choice </span><span class="s2">= </span><span class="s1">_gen_fp16_cmp</span><span class="s2">(</span><span class="s1">op</span><span class="s2">)(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s1">choice</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>


<span class="s1">lower_fp16_minmax</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hmax</span><span class="s2">, </span><span class="s3">'max'</span><span class="s2">, </span><span class="s3">'gt'</span><span class="s2">)</span>
<span class="s1">lower_fp16_minmax</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">fp16</span><span class="s2">.</span><span class="s1">hmin</span><span class="s2">, </span><span class="s3">'min'</span><span class="s2">, </span><span class="s3">'lt'</span><span class="s2">)</span>

<span class="s5"># See:</span>
<span class="s5"># https://docs.nvidia.com/cuda/libdevice-users-guide/__nv_cbrt.html#__nv_cbrt</span>
<span class="s5"># https://docs.nvidia.com/cuda/libdevice-users-guide/__nv_cbrtf.html#__nv_cbrtf</span>


<span class="s1">cbrt_funcs </span><span class="s2">= {</span>
    <span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">: </span><span class="s3">'__nv_cbrtf'</span><span class="s2">,</span>
    <span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">: </span><span class="s3">'__nv_cbrt'</span><span class="s2">,</span>
<span class="s2">}</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_cbrt</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">ty </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span>
    <span class="s1">fname </span><span class="s2">= </span><span class="s1">cbrt_funcs</span><span class="s2">[</span><span class="s1">ty</span><span class="s2">]</span>
    <span class="s1">fty </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_value_type</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">)</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s1">fnty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">fty</span><span class="s2">, [</span><span class="s1">fty</span><span class="s2">])</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">fnty</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">brev</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">u4</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_brev_u4</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s5"># FIXME the llvm.bitreverse.i32 intrinsic isn't supported by nvcc</span>
    <span class="s5"># return builder.bitreverse(args[0])</span>

    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">),)),</span>
        <span class="s3">'__nv_brev'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">brev</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">u8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_brev_u8</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s5"># FIXME the llvm.bitreverse.i64 intrinsic isn't supported by nvcc</span>
    <span class="s5"># return builder.bitreverse(args[0])</span>

    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">64</span><span class="s2">), (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">64</span><span class="s2">),)),</span>
        <span class="s3">'__nv_brevll'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">clz</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_clz</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">ctlz</span><span class="s2">(</span>
        <span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">boolean</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">ffs</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">ffs</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">u4</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_ffs_32</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">),)),</span>
        <span class="s3">'__nv_ffs'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">ffs</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">i8</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">ffs</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">u8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_ffs_64</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), (</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">64</span><span class="s2">),)),</span>
        <span class="s3">'__nv_ffsll'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">selp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_selp</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">test</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">args</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">max</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_max_f4</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">ir</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">(),</span>
            <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">(), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">())),</span>
        <span class="s3">'__nv_fmaxf'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">max</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">max</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">max</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_max_f8</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(),</span>
            <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">())),</span>
        <span class="s3">'__nv_fmax'</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">),</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">),</span>
    <span class="s2">])</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">min</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_min_f4</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">ir</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">(),</span>
            <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">(), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FloatType</span><span class="s2">())),</span>
        <span class="s3">'__nv_fminf'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">min</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">min</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">min</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_min_f8</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(),</span>
            <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(), </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">())),</span>
        <span class="s3">'__nv_fmin'</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">),</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">),</span>
    <span class="s2">])</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">round</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">round</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_round</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_or_insert_function</span><span class="s2">(</span>
        <span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span><span class="s2">,</span>
        <span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span>
            <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">64</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">DoubleType</span><span class="s2">(),)),</span>
        <span class="s3">'__nv_llrint'</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, [</span>
        <span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">types</span><span class="s2">.</span><span class="s1">double</span><span class="s2">),</span>
    <span class="s2">])</span>


<span class="s5"># This rounding implementation follows the algorithm used in the &quot;fallback</span>
<span class="s5"># version&quot; of double_round in CPython.</span>
<span class="s5"># https://github.com/python/cpython/blob/a755410e054e1e2390de5830befc08fe80706c66/Objects/floatobject.c#L964-L1007</span>

<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">round</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Integer</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">round</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Integer</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">round_to_impl</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">round_ndigits</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ndigits</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">math</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">or </span><span class="s1">math</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">x</span>

        <span class="s0">if </span><span class="s1">ndigits </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">ndigits </span><span class="s2">&gt; </span><span class="s4">22</span><span class="s2">:</span>
                <span class="s5"># pow1 and pow2 are each safe from overflow, but</span>
                <span class="s5"># pow1*pow2 ~= pow(10.0, ndigits) might overflow.</span>
                <span class="s1">pow1 </span><span class="s2">= </span><span class="s4">10.0 </span><span class="s2">** (</span><span class="s1">ndigits </span><span class="s2">- </span><span class="s4">22</span><span class="s2">)</span>
                <span class="s1">pow2 </span><span class="s2">= </span><span class="s4">1e22</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">pow1 </span><span class="s2">= </span><span class="s4">10.0 </span><span class="s2">** </span><span class="s1">ndigits</span>
                <span class="s1">pow2 </span><span class="s2">= </span><span class="s4">1.0</span>
            <span class="s1">y </span><span class="s2">= (</span><span class="s1">x </span><span class="s2">* </span><span class="s1">pow1</span><span class="s2">) * </span><span class="s1">pow2</span>
            <span class="s0">if </span><span class="s1">math</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">y</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">x</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">pow1 </span><span class="s2">= </span><span class="s4">10.0 </span><span class="s2">** (-</span><span class="s1">ndigits</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">/ </span><span class="s1">pow1</span>

        <span class="s1">z </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">fabs</span><span class="s2">(</span><span class="s1">y </span><span class="s2">- </span><span class="s1">z</span><span class="s2">) == </span><span class="s4">0.5</span><span class="s2">):</span>
            <span class="s5"># halfway between two integers; use round-half-even</span>
            <span class="s1">z </span><span class="s2">= </span><span class="s4">2.0 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">(</span><span class="s1">y </span><span class="s2">/ </span><span class="s4">2.0</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">ndigits </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">z </span><span class="s2">= (</span><span class="s1">z </span><span class="s2">/ </span><span class="s1">pow2</span><span class="s2">) / </span><span class="s1">pow1</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">z </span><span class="s2">*= </span><span class="s1">pow1</span>

        <span class="s0">return </span><span class="s1">z</span>

    <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">compile_internal</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">round_ndigits</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, )</span>


<span class="s0">def </span><span class="s1">gen_deg_rad</span><span class="s2">(</span><span class="s1">const</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">impl</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">argty</span><span class="s2">, = </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span>
        <span class="s1">factor </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">argty</span><span class="s2">, </span><span class="s1">const</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">fmul</span><span class="s2">(</span><span class="s1">factor</span><span class="s2">, </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">impl</span>


<span class="s1">_deg2rad </span><span class="s2">= </span><span class="s1">math</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s4">180.</span>
<span class="s1">_rad2deg </span><span class="s2">= </span><span class="s4">180. </span><span class="s2">/ </span><span class="s1">math</span><span class="s2">.</span><span class="s1">pi</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">radians</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)(</span><span class="s1">gen_deg_rad</span><span class="s2">(</span><span class="s1">_deg2rad</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">radians</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)(</span><span class="s1">gen_deg_rad</span><span class="s2">(</span><span class="s1">_deg2rad</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">degrees</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f4</span><span class="s2">)(</span><span class="s1">gen_deg_rad</span><span class="s2">(</span><span class="s1">_rad2deg</span><span class="s2">))</span>
<span class="s1">lower</span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">degrees</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">f8</span><span class="s2">)(</span><span class="s1">gen_deg_rad</span><span class="s2">(</span><span class="s1">_rad2deg</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_normalize_indices</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">indty</span><span class="s2">, </span><span class="s1">inds</span><span class="s2">, </span><span class="s1">aryty</span><span class="s2">, </span><span class="s1">valty</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Convert integer indices into tuple of intp 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">indty </span><span class="s0">in </span><span class="s1">types</span><span class="s2">.</span><span class="s1">integer_domain</span><span class="s2">:</span>
        <span class="s1">indty </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">indty</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">indices </span><span class="s2">= [</span><span class="s1">inds</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">indices </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">unpack_tuple</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">inds</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">indty</span><span class="s2">))</span>
    <span class="s1">indices </span><span class="s2">= [</span><span class="s1">context</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>
               <span class="s0">for </span><span class="s1">t</span><span class="s2">, </span><span class="s1">i </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">indty</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">)]</span>

    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s2">!= </span><span class="s1">valty</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">&quot;expect %s but got %s&quot; </span><span class="s2">% (</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">valty</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">!= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">indty</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">&quot;indexing %d-D array with %d-D index&quot; </span><span class="s2">%</span>
                        <span class="s2">(</span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">indty</span><span class="s2">)))</span>

    <span class="s0">return </span><span class="s1">indty</span><span class="s2">, </span><span class="s1">indices</span>


<span class="s0">def </span><span class="s1">_atomic_dispatcher</span><span class="s2">(</span><span class="s1">dispatch_fn</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">imp</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
        <span class="s5"># The common argument handling code</span>
        <span class="s1">aryty</span><span class="s2">, </span><span class="s1">indty</span><span class="s2">, </span><span class="s1">valty </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span>
        <span class="s1">ary</span><span class="s2">, </span><span class="s1">inds</span><span class="s2">, </span><span class="s1">val </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">indty</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">_normalize_indices</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">indty</span><span class="s2">, </span><span class="s1">inds</span><span class="s2">,</span>
                                            <span class="s1">aryty</span><span class="s2">, </span><span class="s1">valty</span><span class="s2">)</span>

        <span class="s1">lary </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">make_array</span><span class="s2">(</span><span class="s1">aryty</span><span class="s2">)(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">)</span>
        <span class="s1">ptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_item_pointer</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">aryty</span><span class="s2">, </span><span class="s1">lary</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">,</span>
                                       <span class="s1">wraparound</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s5"># dispatcher to implementation base on dtype</span>
        <span class="s0">return </span><span class="s1">dispatch_fn</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">imp</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_add_tuple</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_add_float32</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">:</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_add_float64</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'add'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s3">'monotonic'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_sub</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_sub_float32</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">:</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_sub_float64</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'sub'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s3">'monotonic'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">inc</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">inc</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">inc</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_inc</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadecl</span><span class="s2">.</span><span class="s1">unsigned_int_numba_types</span><span class="s2">:</span>
        <span class="s1">bw </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">bitwidth</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">, </span><span class="s3">f'declare_atomic_inc_int</span><span class="s0">{</span><span class="s1">bw</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">), (</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">f'Unimplemented atomic inc with </span><span class="s0">{</span><span class="s1">dtype</span><span class="s0">} </span><span class="s3">array'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">dec</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">dec</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">dec</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_dec</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadecl</span><span class="s2">.</span><span class="s1">unsigned_int_numba_types</span><span class="s2">:</span>
        <span class="s1">bw </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">bitwidth</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s1">fn </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">, </span><span class="s3">f'declare_atomic_dec_int</span><span class="s0">{</span><span class="s1">bw</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">), (</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">f'Unimplemented atomic dec with </span><span class="s0">{</span><span class="s1">dtype</span><span class="s0">} </span><span class="s3">array'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">ptx_atomic_bitwise</span><span class="s2">(</span><span class="s1">stub</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
    <span class="s0">def </span><span class="s1">impl_ptx_atomic</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadecl</span><span class="s2">.</span><span class="s1">integer_numba_types</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s3">'monotonic'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">f'Unimplemented atomic </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s3">with </span><span class="s0">{</span><span class="s1">dtype</span><span class="s0">} </span><span class="s3">array'</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ty </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">):</span>
        <span class="s1">lower</span><span class="s2">(</span><span class="s1">stub</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)(</span><span class="s1">impl_ptx_atomic</span><span class="s2">)</span>


<span class="s1">ptx_atomic_bitwise</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s3">'and'</span><span class="s2">)</span>
<span class="s1">ptx_atomic_bitwise</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">, </span><span class="s3">'or'</span><span class="s2">)</span>
<span class="s1">ptx_atomic_bitwise</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">xor</span><span class="s2">, </span><span class="s3">'xor'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">exch</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">exch</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">exch</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_exch</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadecl</span><span class="s2">.</span><span class="s1">integer_numba_types</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'xchg'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">f'Unimplemented atomic exch with </span><span class="s0">{</span><span class="s1">dtype</span><span class="s0">} </span><span class="s3">array'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_max</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_max_float64</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_max_float32</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'max'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'umax'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'Unimplemented atomic max with %s array' </span><span class="s2">% </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_min</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_min_float64</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_min_float32</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'min'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'umin'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'Unimplemented atomic min with %s array' </span><span class="s2">% </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">nanmax</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">nanmax</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">nanmax</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_nanmax</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_nanmax_float64</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_nanmax_float32</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'max'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'umax'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'Unimplemented atomic max with %s array' </span><span class="s2">% </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">nanmin</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">nanmin</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">nanmin</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">_atomic_dispatcher</span>
<span class="s0">def </span><span class="s1">ptx_atomic_nanmin</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_nanmin_float64</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">declare_atomic_nanmin_float32</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'min'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">atomic_rmw</span><span class="s2">(</span><span class="s3">'umin'</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">ordering</span><span class="s2">=</span><span class="s3">'monotonic'</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'Unimplemented atomic min with %s array' </span><span class="s2">% </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">compare_and_swap</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_atomic_compare_and_swap</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">sig </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">return_type</span><span class="s2">(</span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>
    <span class="s1">args </span><span class="s2">= (</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">args</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">ptx_atomic_cas</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">cas</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">cas</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">.</span><span class="s1">cas</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">UniTuple</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_atomic_cas</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">aryty</span><span class="s2">, </span><span class="s1">indty</span><span class="s2">, </span><span class="s1">oldty</span><span class="s2">, </span><span class="s1">valty </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">args</span>
    <span class="s1">ary</span><span class="s2">, </span><span class="s1">inds</span><span class="s2">, </span><span class="s1">old</span><span class="s2">, </span><span class="s1">val </span><span class="s2">= </span><span class="s1">args</span>

    <span class="s1">indty</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">_normalize_indices</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">indty</span><span class="s2">, </span><span class="s1">inds</span><span class="s2">, </span><span class="s1">aryty</span><span class="s2">,</span>
                                        <span class="s1">valty</span><span class="s2">)</span>

    <span class="s1">lary </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">make_array</span><span class="s2">(</span><span class="s1">aryty</span><span class="s2">)(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">)</span>
    <span class="s1">ptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">get_item_pointer</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">aryty</span><span class="s2">, </span><span class="s1">lary</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">,</span>
                                   <span class="s1">wraparound</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">cuda</span><span class="s2">.</span><span class="s1">cudadecl</span><span class="s2">.</span><span class="s1">integer_numba_types</span><span class="s2">):</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>
        <span class="s1">bitwidth </span><span class="s2">= </span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">bitwidth</span>
        <span class="s0">return </span><span class="s1">nvvmutils</span><span class="s2">.</span><span class="s1">atomic_cmpxchg</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">bitwidth</span><span class="s2">, </span><span class="s1">ptr</span><span class="s2">, </span><span class="s1">old</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'Unimplemented atomic cas with %s array' </span><span class="s2">% </span><span class="s1">aryty</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s5"># -----------------------------------------------------------------------------</span>

<span class="s2">@</span><span class="s1">lower</span><span class="s2">(</span><span class="s1">stubs</span><span class="s2">.</span><span class="s1">nanosleep</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">ptx_nanosleep</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">nanosleep </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">VoidType</span><span class="s2">(), [</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">)]),</span>
                             <span class="s3">&quot;nanosleep.u32 $0;&quot;</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">side_effect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ns </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">nanosleep</span><span class="s2">, [</span><span class="s1">ns</span><span class="s2">])</span>


<span class="s5"># -----------------------------------------------------------------------------</span>


<span class="s0">def </span><span class="s1">_generic_array</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">symbol_name</span><span class="s2">, </span><span class="s1">addrspace</span><span class="s2">,</span>
                   <span class="s1">can_dynsized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s1">elemcount </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">mul</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s5"># Check for valid shape for this type of allocation.</span>
    <span class="s5"># Only 1d arrays can be dynamic.</span>
    <span class="s1">dynamic_smem </span><span class="s2">= </span><span class="s1">elemcount </span><span class="s2">&lt;= </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">can_dynsized </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s0">if </span><span class="s1">elemcount </span><span class="s2">&lt;= </span><span class="s4">0 </span><span class="s0">and not </span><span class="s1">dynamic_smem</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;array length &lt;= 0&quot;</span><span class="s2">)</span>

    <span class="s5"># Check that we support the requested dtype</span>
    <span class="s1">data_model </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">data_model_manager</span><span class="s2">[</span><span class="s1">dtype</span><span class="s2">]</span>
    <span class="s1">other_supported_type </span><span class="s2">= (</span>
        <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, (</span><span class="s1">types</span><span class="s2">.</span><span class="s1">Record</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Boolean</span><span class="s2">))</span>
        <span class="s0">or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data_model</span><span class="s2">, </span><span class="s1">models</span><span class="s2">.</span><span class="s1">StructModel</span><span class="s2">)</span>
        <span class="s0">or </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">types</span><span class="s2">.</span><span class="s1">float16</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s0">not in </span><span class="s1">types</span><span class="s2">.</span><span class="s1">number_domain </span><span class="s0">and not </span><span class="s1">other_supported_type</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">&quot;unsupported type: %s&quot; </span><span class="s2">% </span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">lldtype </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_data_type</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">laryty </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">ArrayType</span><span class="s2">(</span><span class="s1">lldtype</span><span class="s2">, </span><span class="s1">elemcount</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">addrspace </span><span class="s2">== </span><span class="s1">nvvm</span><span class="s2">.</span><span class="s1">ADDRSPACE_LOCAL</span><span class="s2">:</span>
        <span class="s5"># Special case local address space allocation to use alloca</span>
        <span class="s5"># NVVM is smart enough to only use local memory if no register is</span>
        <span class="s5"># available</span>
        <span class="s1">dataptr </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">alloca_once</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">, </span><span class="s1">laryty</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">symbol_name</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">lmod </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">module</span>

        <span class="s5"># Create global variable in the requested address space</span>
        <span class="s1">gvmem </span><span class="s2">= </span><span class="s1">cgutils</span><span class="s2">.</span><span class="s1">add_global_variable</span><span class="s2">(</span><span class="s1">lmod</span><span class="s2">, </span><span class="s1">laryty</span><span class="s2">, </span><span class="s1">symbol_name</span><span class="s2">,</span>
                                            <span class="s1">addrspace</span><span class="s2">)</span>
        <span class="s5"># Specify alignment to avoid misalignment bug</span>
        <span class="s1">align </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_abi_sizeof</span><span class="s2">(</span><span class="s1">lldtype</span><span class="s2">)</span>
        <span class="s5"># Alignment is required to be a power of 2 for shared memory. If it is</span>
        <span class="s5"># not a power of 2 (e.g. for a Record array) then round up accordingly.</span>
        <span class="s1">gvmem</span><span class="s2">.</span><span class="s1">align </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">&lt;&lt; (</span><span class="s1">align </span><span class="s2">- </span><span class="s4">1 </span><span class="s2">).</span><span class="s1">bit_length</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">dynamic_smem</span><span class="s2">:</span>
            <span class="s1">gvmem</span><span class="s2">.</span><span class="s1">linkage </span><span class="s2">= </span><span class="s3">'external'</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s5">## Comment out the following line to workaround a NVVM bug</span>
            <span class="s5">## which generates a invalid symbol name when the linkage</span>
            <span class="s5">## is internal and in some situation.</span>
            <span class="s5">## See _get_unique_smem_id()</span>
            <span class="s5"># gvmem.linkage = lc.LINKAGE_INTERNAL</span>

            <span class="s1">gvmem</span><span class="s2">.</span><span class="s1">initializer </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">laryty</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">Undefined</span><span class="s2">)</span>

        <span class="s5"># Convert to generic address-space</span>
        <span class="s1">dataptr </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">addrspacecast</span><span class="s2">(</span><span class="s1">gvmem</span><span class="s2">, </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)),</span>
                                        <span class="s3">'generic'</span><span class="s2">)</span>

    <span class="s1">targetdata </span><span class="s2">= </span><span class="s1">ll</span><span class="s2">.</span><span class="s1">create_target_data</span><span class="s2">(</span><span class="s1">nvvm</span><span class="s2">.</span><span class="s1">NVVM</span><span class="s2">().</span><span class="s1">data_layout</span><span class="s2">)</span>
    <span class="s1">lldtype </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_data_type</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">itemsize </span><span class="s2">= </span><span class="s1">lldtype</span><span class="s2">.</span><span class="s1">get_abi_size</span><span class="s2">(</span><span class="s1">targetdata</span><span class="s2">)</span>

    <span class="s5"># Compute strides</span>
    <span class="s1">laststride </span><span class="s2">= </span><span class="s1">itemsize</span>
    <span class="s1">rstrides </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">lastsize </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
        <span class="s1">rstrides</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">laststride</span><span class="s2">)</span>
        <span class="s1">laststride </span><span class="s2">*= </span><span class="s1">lastsize</span>
    <span class="s1">strides </span><span class="s2">= [</span><span class="s1">s </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">rstrides</span><span class="s2">)]</span>
    <span class="s1">kstrides </span><span class="s2">= [</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">s</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">strides</span><span class="s2">]</span>

    <span class="s5"># Compute shape</span>
    <span class="s0">if </span><span class="s1">dynamic_smem</span><span class="s2">:</span>
        <span class="s5"># Compute the shape based on the dynamic shared memory configuration.</span>
        <span class="s5"># Unfortunately NVVM does not provide an intrinsic for the</span>
        <span class="s5"># %dynamic_smem_size register, so we must read it using inline</span>
        <span class="s5"># assembly.</span>
        <span class="s1">get_dynshared_size </span><span class="s2">= </span><span class="s1">ir</span><span class="s2">.</span><span class="s1">InlineAsm</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">FunctionType</span><span class="s2">(</span><span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">32</span><span class="s2">), []),</span>
                                          <span class="s3">&quot;mov.u32 $0, %dynamic_smem_size;&quot;</span><span class="s2">,</span>
                                          <span class="s3">'=r'</span><span class="s2">, </span><span class="s1">side_effect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">dynsmem_size </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">zext</span><span class="s2">(</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s1">get_dynshared_size</span><span class="s2">, []),</span>
                                    <span class="s1">ir</span><span class="s2">.</span><span class="s1">IntType</span><span class="s2">(</span><span class="s4">64</span><span class="s2">))</span>
        <span class="s5"># Only 1-D dynamic shared memory is supported so the following is a</span>
        <span class="s5"># sufficient construction of the shape</span>
        <span class="s1">kitemsize </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">itemsize</span><span class="s2">)</span>
        <span class="s1">kshape </span><span class="s2">= [</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">udiv</span><span class="s2">(</span><span class="s1">dynsmem_size</span><span class="s2">, </span><span class="s1">kitemsize</span><span class="s2">)]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">kshape </span><span class="s2">= [</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">s</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">shape</span><span class="s2">]</span>

    <span class="s5"># Create array object</span>
    <span class="s1">ndim </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">aryty </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ndim</span><span class="s2">=</span><span class="s1">ndim</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
    <span class="s1">ary </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">make_array</span><span class="s2">(</span><span class="s1">aryty</span><span class="s2">)(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">)</span>

    <span class="s1">context</span><span class="s2">.</span><span class="s1">populate_array</span><span class="s2">(</span><span class="s1">ary</span><span class="s2">,</span>
                           <span class="s1">data</span><span class="s2">=</span><span class="s1">builder</span><span class="s2">.</span><span class="s1">bitcast</span><span class="s2">(</span><span class="s1">dataptr</span><span class="s2">, </span><span class="s1">ary</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">type</span><span class="s2">),</span>
                           <span class="s1">shape</span><span class="s2">=</span><span class="s1">kshape</span><span class="s2">,</span>
                           <span class="s1">strides</span><span class="s2">=</span><span class="s1">kstrides</span><span class="s2">,</span>
                           <span class="s1">itemsize</span><span class="s2">=</span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_constant</span><span class="s2">(</span><span class="s1">types</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">, </span><span class="s1">itemsize</span><span class="s2">),</span>
                           <span class="s1">meminfo</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ary</span><span class="s2">.</span><span class="s1">_getvalue</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">lower_constant</span><span class="s2">(</span><span class="s1">CUDADispatcher</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">cuda_dispatcher_const</span><span class="s2">(</span><span class="s1">context</span><span class="s2">, </span><span class="s1">builder</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">pyval</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">get_dummy_value</span><span class="s2">()</span>


<span class="s5"># NumPy</span>

<span class="s1">register_ufuncs</span><span class="s2">(</span><span class="s1">ufunc_db</span><span class="s2">.</span><span class="s1">get_ufuncs</span><span class="s2">(), </span><span class="s1">lower</span><span class="s2">)</span>
</pre>
</body>
</html>