<html>
<head>
<title>filechooser.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
filechooser.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
FileChooser 
=========== 
 
The FileChooser module provides various classes for describing, displaying and 
browsing file systems. 
 
Simple widgets 
-------------- 
 
There are two ready-to-use widgets that provide views of the file system. Each 
of these present the files and folders in a different style. 
 
The :class:`FileChooserListView` displays file entries as text items in a 
vertical list, where folders can be collapsed and expanded. 
 
.. image:: images/filechooser_list.png 
 
The :class:`FileChooserIconView` presents icons and text from left to right, 
wrapping them as required. 
 
.. image:: images/filechooser_icon.png 
 
They both provide for scrolling, selection and basic user interaction. 
Please refer to the :class:`FileChooserController` for details on supported 
events and properties. 
 
Widget composition 
------------------ 
 
FileChooser classes adopt a 
`MVC &lt;https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller&gt;`_ 
design. They are exposed so that you to extend and customize your file chooser 
according to your needs. 
 
The FileChooser classes can be categorized as follows: 
 
* Models are represented by concrete implementations of the 
  :class:`FileSystemAbstract` class, such as the :class:`FileSystemLocal`. 
 
* Views are represented by the :class:`FileChooserListLayout` and 
  :class:`FileChooserIconLayout` classes. These are used by the 
  :class:`FileChooserListView` and :class:`FileChooserIconView` widgets 
  respectively. 
 
* Controllers are represented by concrete implementations of the 
  :class:`FileChooserController`, namely the :class:`FileChooser`, 
  :class:`FileChooserIconView` and :class:`FileChooserListView` classes. 
 
This means you can define your own views or provide :class:`FileSystemAbstract` 
implementations for alternative file systems for use with these widgets. 
The :class:`FileChooser` can be used as a controller for handling multiple, 
synchronized views of the same path. By combining these elements, you can add 
your own views and file systems and have them easily interact with the existing 
components. 
 
Usage example 
------------- 
 
main.py 
 
.. include:: ../../examples/RST_Editor/main.py 
    :literal: 
 
editor.kv 
 
.. highlight:: kv 
 
.. include:: ../../examples/RST_Editor/editor.kv 
    :literal: 
 
.. versionadded:: 1.0.5 
 
.. versionchanged:: 1.2.0 
 
    In the chooser template, the `controller` is no longer a direct reference 
    but a weak-reference. If you are upgrading, you should change the notation 
    `root.controller.xxx` to `root.controller().xxx`. 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'FileChooserListView'</span><span class="s2">, </span><span class="s3">'FileChooserIconView'</span><span class="s2">,</span>
           <span class="s3">'FileChooserListLayout'</span><span class="s2">, </span><span class="s3">'FileChooserIconLayout'</span><span class="s2">,</span>
           <span class="s3">'FileChooser'</span><span class="s2">, </span><span class="s3">'FileChooserController'</span><span class="s2">,</span>
           <span class="s3">'FileChooserProgressBase'</span><span class="s2">, </span><span class="s3">'FileSystemAbstract'</span><span class="s2">,</span>
           <span class="s3">'FileSystemLocal'</span><span class="s2">)</span>

<span class="s4">from </span><span class="s1">weakref </span><span class="s4">import </span><span class="s1">ref</span>
<span class="s4">from </span><span class="s1">time </span><span class="s4">import </span><span class="s1">time</span>

<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">text </span><span class="s4">import </span><span class="s1">DEFAULT_FONT</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">compat </span><span class="s4">import </span><span class="s1">string_types</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">factory </span><span class="s4">import </span><span class="s1">Factory</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">clock </span><span class="s4">import </span><span class="s1">Clock</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">lang </span><span class="s4">import </span><span class="s1">Builder</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">logger </span><span class="s4">import </span><span class="s1">Logger</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">utils </span><span class="s4">import </span><span class="s1">platform </span><span class="s4">as </span><span class="s1">core_platform</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">floatlayout </span><span class="s4">import </span><span class="s1">FloatLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">relativelayout </span><span class="s4">import </span><span class="s1">RelativeLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">screenmanager </span><span class="s4">import </span><span class="s1">ScreenManager</span><span class="s2">, </span><span class="s1">Screen</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s2">(</span>
    <span class="s1">StringProperty</span><span class="s2">, </span><span class="s1">ListProperty</span><span class="s2">, </span><span class="s1">BooleanProperty</span><span class="s2">, </span><span class="s1">ObjectProperty</span><span class="s2">,</span>
    <span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">AliasProperty</span><span class="s2">)</span>
<span class="s4">import </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc</span>
<span class="s4">from </span><span class="s1">os </span><span class="s4">import </span><span class="s1">listdir</span>
<span class="s4">from </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path </span><span class="s4">import </span><span class="s2">(</span>
    <span class="s1">basename</span><span class="s2">, </span><span class="s1">join</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">, </span><span class="s1">normpath</span><span class="s2">, </span><span class="s1">expanduser</span><span class="s2">, </span><span class="s1">altsep</span><span class="s2">,</span>
    <span class="s1">splitdrive</span><span class="s2">, </span><span class="s1">realpath</span><span class="s2">, </span><span class="s1">getsize</span><span class="s2">, </span><span class="s1">isdir</span><span class="s2">, </span><span class="s1">abspath</span><span class="s2">, </span><span class="s1">isfile</span><span class="s2">, </span><span class="s1">dirname</span><span class="s2">)</span>
<span class="s4">from </span><span class="s1">fnmatch </span><span class="s4">import </span><span class="s1">fnmatch</span>

<span class="s1">platform </span><span class="s2">= </span><span class="s1">core_platform</span>
<span class="s1">filesize_units </span><span class="s2">= (</span><span class="s3">'B'</span><span class="s2">, </span><span class="s3">'KB'</span><span class="s2">, </span><span class="s3">'MB'</span><span class="s2">, </span><span class="s3">'GB'</span><span class="s2">, </span><span class="s3">'TB'</span><span class="s2">)</span>

<span class="s1">_have_win32file </span><span class="s2">= </span><span class="s4">False</span>
<span class="s4">if </span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win'</span><span class="s2">:</span>
    <span class="s5"># Import that module here as it's not available on non-windows machines.</span>
    <span class="s5"># See http://bit.ly/i9klJE except that the attributes are defined in</span>
    <span class="s5"># win32file not win32com (bug on page).</span>
    <span class="s5"># Note: For some reason this doesn't work after a os.chdir(), no matter to</span>
    <span class="s5">#       what directory you change from where. Windows weirdness.</span>
    <span class="s4">try</span><span class="s2">:</span>
        <span class="s4">from </span><span class="s1">win32file </span><span class="s4">import </span><span class="s1">FILE_ATTRIBUTE_HIDDEN</span><span class="s2">, </span><span class="s1">GetFileAttributesExW</span><span class="s2">, </span><span class="s1">\</span>
                              <span class="s1">error</span>
        <span class="s1">_have_win32file </span><span class="s2">= </span><span class="s4">True</span>
    <span class="s4">except </span><span class="s1">ImportError</span><span class="s2">:</span>
        <span class="s1">Logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">'filechooser: win32file module is missing'</span><span class="s2">)</span>
        <span class="s1">Logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">'filechooser: we cannot check if a file is hidden or not'</span><span class="s2">)</span>


<span class="s4">def </span><span class="s1">alphanumeric_folders_first</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">filesystem</span><span class="s2">):</span>
    <span class="s4">return </span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">f </span><span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">files </span><span class="s4">if </span><span class="s1">filesystem</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)) +</span>
            <span class="s1">sorted</span><span class="s2">(</span><span class="s1">f </span><span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">files </span><span class="s4">if not </span><span class="s1">filesystem</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)))</span>


<span class="s4">class </span><span class="s1">FileSystemAbstract</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">'''Class for implementing a File System view that can be used with the 
    :class:`FileChooser &lt;FileChooser&gt;`. 
 
    .. versionadded:: 1.8.0 
    '''</span>

    <span class="s4">def </span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">'''Return the list of files in the directory `fn` 
        '''</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">getsize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">'''Return the size in bytes of a file 
        '''</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">is_hidden</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">'''Return True if the file is hidden 
        '''</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">'''Return True if the argument passed to this method is a directory 
        '''</span>
        <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">FileSystemLocal</span><span class="s2">(</span><span class="s1">FileSystemAbstract</span><span class="s2">):</span>
    <span class="s0">'''Implementation of :class:`FileSystemAbstract` for local files. 
 
    .. versionadded:: 1.8.0 
    '''</span>

    <span class="s4">def </span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">getsize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">getsize</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">is_hidden</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win'</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s1">_have_win32file</span><span class="s2">:</span>
                <span class="s4">return False</span>
            <span class="s4">try</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s1">GetFileAttributesExW</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">] &amp; </span><span class="s1">FILE_ATTRIBUTE_HIDDEN</span>
            <span class="s4">except </span><span class="s1">error</span><span class="s2">:</span>
                <span class="s5"># This error can occurred when a file is already accessed by</span>
                <span class="s5"># someone else. So don't return to True, because we have lot</span>
                <span class="s5"># of chances to not being able to do anything with it.</span>
                <span class="s1">Logger</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">(</span><span class="s3">'unable to access to &lt;%s&gt;' </span><span class="s2">% </span><span class="s1">fn</span><span class="s2">)</span>
                <span class="s4">return True</span>

        <span class="s4">return </span><span class="s1">basename</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">).</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">FileChooserProgressBase</span><span class="s2">(</span><span class="s1">FloatLayout</span><span class="s2">):</span>
    <span class="s0">'''Base for implementing a progress view. This view is used when too many 
    entries need to be created and are delayed over multiple frames. 
 
    .. versionadded:: 1.2.0 
    '''</span>

    <span class="s1">path </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">''</span><span class="s2">)</span>
    <span class="s3">'''Current path of the FileChooser, read-only. 
    '''</span>

    <span class="s1">index </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Current index of :attr:`total` entries to be loaded. 
    '''</span>

    <span class="s1">total </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">1</span><span class="s2">)</span>
    <span class="s3">'''Total number of entries to load. 
    '''</span>

    <span class="s4">def </span><span class="s1">cancel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s0">'''Cancel any action from the FileChooserController. 
        '''</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserProgressBase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserProgressBase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserProgressBase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s4">return True</span>


<span class="s4">class </span><span class="s1">FileChooserProgress</span><span class="s2">(</span><span class="s1">FileChooserProgressBase</span><span class="s2">):</span>
    <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">FileChooserLayout</span><span class="s2">(</span><span class="s1">FloatLayout</span><span class="s2">):</span>
    <span class="s0">'''Base class for file chooser layouts. 
 
    .. versionadded:: 1.9.0 
    '''</span>

    <span class="s1">VIEWNAME </span><span class="s2">= </span><span class="s3">'undefined'</span>

    <span class="s1">__events__ </span><span class="s2">= (</span><span class="s3">'on_entry_added'</span><span class="s2">, </span><span class="s3">'on_entries_cleared'</span><span class="s2">,</span>
                  <span class="s3">'on_subentry_to_entry'</span><span class="s2">, </span><span class="s3">'on_remove_subentry'</span><span class="s2">, </span><span class="s3">'on_submit'</span><span class="s2">)</span>

    <span class="s1">controller </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">()</span>
    <span class="s3">''' 
    Reference to the controller handling this layout. 
 
    :class:`~kivy.properties.ObjectProperty` 
    '''</span>

    <span class="s4">def </span><span class="s1">on_entry_added</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">on_entries_cleared</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">on_subentry_to_entry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">on_remove_subentry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">on_submit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">selected</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s4">pass</span>


<span class="s4">class </span><span class="s1">FileChooserListLayout</span><span class="s2">(</span><span class="s1">FileChooserLayout</span><span class="s2">):</span>
    <span class="s0">'''File chooser layout using a list view. 
 
    .. versionadded:: 1.9.0 
    '''</span>
    <span class="s1">VIEWNAME </span><span class="s2">= </span><span class="s3">'list'</span>
    <span class="s1">_ENTRY_TEMPLATE </span><span class="s2">= </span><span class="s3">'FileListEntry'</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserListLayout</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span><span class="s2">(</span><span class="s3">'on_entries_cleared'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_to_top</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">scroll_to_top</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ids</span><span class="s2">.</span><span class="s1">scrollview</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">= </span><span class="s6">1.0</span>


<span class="s4">class </span><span class="s1">FileChooserIconLayout</span><span class="s2">(</span><span class="s1">FileChooserLayout</span><span class="s2">):</span>
    <span class="s0">'''File chooser layout using an icon view. 
 
    .. versionadded:: 1.9.0 
    '''</span>

    <span class="s1">VIEWNAME </span><span class="s2">= </span><span class="s3">'icon'</span>
    <span class="s1">_ENTRY_TEMPLATE </span><span class="s2">= </span><span class="s3">'FileIconEntry'</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserIconLayout</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span><span class="s2">(</span><span class="s3">'on_entries_cleared'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_to_top</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">scroll_to_top</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ids</span><span class="s2">.</span><span class="s1">scrollview</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">= </span><span class="s6">1.0</span>


<span class="s4">class </span><span class="s1">FileChooserController</span><span class="s2">(</span><span class="s1">RelativeLayout</span><span class="s2">):</span>
    <span class="s0">'''Base for implementing a FileChooser. Don't use this class directly, but 
    prefer using an implementation such as the :class:`FileChooser`, 
    :class:`FileChooserListView` or :class:`FileChooserIconView`. 
 
    :Events: 
        `on_entry_added`: entry, parent 
            Fired when a root-level entry is added to the file list. If you 
            return True from this event, the entry is not added to FileChooser. 
        `on_entries_cleared` 
            Fired when the the entries list is cleared, usually when the 
            root is refreshed. 
        `on_subentry_to_entry`: entry, parent 
            Fired when a sub-entry is added to an existing entry or 
            when entries are removed from an entry e.g. when 
            a node is closed. 
        `on_submit`: selection, touch 
            Fired when a file has been selected with a double-tap. 
    '''</span>
    <span class="s1">_ENTRY_TEMPLATE </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s1">layout </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s1">baseclass</span><span class="s2">=</span><span class="s1">FileChooserLayout</span><span class="s2">)</span>
    <span class="s3">''' 
    Reference to the layout widget instance. 
 
    layout is an :class:`~kivy.properties.ObjectProperty`. 
 
    .. versionadded:: 1.9.0 
    '''</span>

    <span class="s1">path </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">u'/'</span><span class="s2">)</span>
    <span class="s3">''' 
    path is a :class:`~kivy.properties.StringProperty` and defaults to the 
    current working directory as a unicode string. It specifies the path on the 
    filesystem that this controller should refer to. 
 
    .. warning:: 
 
        If a unicode path is specified, all the files returned will be in 
        unicode, allowing the display of unicode files and paths. If a bytes 
        path is specified, only files and paths with ascii names will be 
        displayed properly: non-ascii filenames will be displayed and listed 
        with questions marks (?) instead of their unicode characters. 
    '''</span>

    <span class="s1">filters </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([])</span>
    <span class="s3">''' 
    filters specifies the filters to be applied to the files in the directory. 
    filters is a :class:`~kivy.properties.ListProperty` and defaults to []. 
    This is equivalent to '</span><span class="s4">\\</span><span class="s3">*' i.e. nothing is filtered. 
 
    The filters are not reset when the path changes. You need to do that 
    yourself if desired. 
 
    There are two kinds of filters: patterns and callbacks. 
 
    #. Patterns 
 
        e.g. ['</span><span class="s4">\\</span><span class="s3">*.png']. 
        You can use the following patterns: 
 
            ========== ================================= 
            Pattern     Meaning 
            ========== ================================= 
            </span><span class="s4">\\</span><span class="s3">*         matches everything 
            ?          matches any single character 
            [seq]      matches any character in seq 
            [!seq]     matches any character not in seq 
            ========== ================================= 
 
    #. Callbacks 
 
        You can specify a function that will be called for each file. The 
        callback will be passed the folder and file name as the first 
        and second parameters respectively. It should return True to 
        indicate a match and False otherwise. 
 
    .. versionchanged:: 1.4.0 
        Added the option to specify the filter as a callback. 
    '''</span>

    <span class="s1">filter_dirs </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">''' 
    Indicates whether filters should also apply to directories. 
    filter_dirs is a :class:`~kivy.properties.BooleanProperty` and defaults to 
    False. 
    '''</span>

    <span class="s1">sort_func </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s1">alphanumeric_folders_first</span><span class="s2">)</span>
    <span class="s3">''' 
    Provides a function to be called with a list of filenames as the first 
    argument and the filesystem implementation as the second argument. It 
    returns a list of filenames sorted for display in the view. 
 
    sort_func is an :class:`~kivy.properties.ObjectProperty` and defaults to a 
    function returning alphanumerically named folders first. 
 
    .. versionchanged:: 1.8.0 
 
        The signature needs now 2 arguments: first the list of files, 
        second the filesystem class to use. 
    '''</span>

    <span class="s1">files </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([])</span>
    <span class="s3">''' 
    The list of files in the directory specified by path after applying the 
    filters. 
 
    files is a read-only :class:`~kivy.properties.ListProperty`. 
    '''</span>

    <span class="s1">show_hidden </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">''' 
    Determines whether hidden files and folders should be shown. 
 
    show_hidden is a :class:`~kivy.properties.BooleanProperty` and defaults to 
    False. 
    '''</span>

    <span class="s1">selection </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([])</span>
    <span class="s3">''' 
    Contains the list of files that are currently selected. 
 
    selection is a read-only :class:`~kivy.properties.ListProperty` and 
    defaults to []. 
    '''</span>

    <span class="s1">multiselect </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">''' 
    Determines whether the user is able to select multiple files or not. 
 
    multiselect is a :class:`~kivy.properties.BooleanProperty` and defaults to 
    False. 
    '''</span>

    <span class="s1">dirselect </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">''' 
    Determines whether directories are valid selections or not. 
 
    dirselect is a :class:`~kivy.properties.BooleanProperty` and defaults to 
    False. 
 
    .. versionadded:: 1.1.0 
    '''</span>

    <span class="s1">rootpath </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">''' 
    Root path to use instead of the system root path. If set, it will not show 
    a &quot;..&quot; directory to go up to the root path. For example, if you set 
    rootpath to /users/foo, the user will be unable to go to /users or to any 
    other directory not starting with /users/foo. 
 
    rootpath is a :class:`~kivy.properties.StringProperty` and defaults 
    to None. 
 
    .. versionadded:: 1.2.0 
 
    .. note:: 
 
        Similarly to :attr:`path`, whether `rootpath` is specified as 
        bytes or a unicode string determines the type of the filenames and 
        paths read. 
    '''</span>

    <span class="s1">progress_cls </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s1">FileChooserProgress</span><span class="s2">)</span>
    <span class="s3">'''Class to use for displaying a progress indicator for filechooser 
    loading. 
 
    progress_cls is an :class:`~kivy.properties.ObjectProperty` and defaults to 
    :class:`FileChooserProgress`. 
 
    .. versionadded:: 1.2.0 
 
    .. versionchanged:: 1.8.0 
 
        If set to a string, the :class:`~kivy.factory.Factory` will be used to 
        resolve the class name. 
 
    '''</span>

    <span class="s1">file_encodings </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s3">'utf-8'</span><span class="s2">, </span><span class="s3">'latin1'</span><span class="s2">, </span><span class="s3">'cp1252'</span><span class="s2">], </span><span class="s1">deprecated</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Possible encodings for decoding a filename to unicode. In the case that 
    the user has a non-ascii filename, undecodable without knowing its 
    initial encoding, we have no other choice than to guess it. 
 
    Please note that if you encounter an issue because of a missing encoding 
    here, we'll be glad to add it to this list. 
 
    file_encodings is a :class:`~kivy.properties.ListProperty` and defaults to 
    ['utf-8', 'latin1', 'cp1252']. 
 
    .. versionadded:: 1.3.0 
 
    .. deprecated:: 1.8.0 
       This property is no longer used as the filechooser no longer decodes 
       the file names. 
 
    '''</span>

    <span class="s1">file_system </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s1">FileSystemLocal</span><span class="s2">(),</span>
                                 <span class="s1">baseclass</span><span class="s2">=</span><span class="s1">FileSystemAbstract</span><span class="s2">)</span>
    <span class="s3">'''The file system object used to access the file system. This should be a 
    subclass of :class:`FileSystemAbstract`. 
 
    file_system is an :class:`~kivy.properties.ObjectProperty` and defaults to 
    :class:`FileSystemLocal()` 
 
    .. versionadded:: 1.8.0 
    '''</span>

    <span class="s1">font_name </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s1">DEFAULT_FONT</span><span class="s2">)</span>
    <span class="s3">'''Filename of the font to use in UI components. The path can be 
    absolute or relative.  Relative paths are resolved by the 
    :func:`~kivy.resources.resource_find` function. 
 
    :attr:`font_name` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'Roboto'. This value is taken 
    from :class:`~kivy.config.Config`. 
    '''</span>

    <span class="s1">_update_files_ev </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">_create_files_entries_ev </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s1">__events__ </span><span class="s2">= (</span><span class="s3">'on_entry_added'</span><span class="s2">, </span><span class="s3">'on_entries_cleared'</span><span class="s2">,</span>
                  <span class="s3">'on_subentry_to_entry'</span><span class="s2">, </span><span class="s3">'on_remove_subentry'</span><span class="s2">, </span><span class="s3">'on_submit'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_progress </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserController</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_items </span><span class="s2">= []</span>
        <span class="s1">fbind </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'selection'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_item_selection</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_previous_path </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">]</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'path'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_save_previous_path</span><span class="s2">)</span>
        <span class="s1">update </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'path'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'filters'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'rootpath'</span><span class="s2">, </span><span class="s1">update</span><span class="s2">)</span>
        <span class="s1">update</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s5"># don't respond to touchs outside self</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">disabled</span><span class="s2">:</span>
            <span class="s4">return True</span>
        <span class="s4">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserController</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s5"># don't respond to touchs outside self</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">disabled</span><span class="s2">:</span>
            <span class="s4">return True</span>
        <span class="s4">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooserController</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_update_item_selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">item </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_items</span><span class="s2">:</span>
            <span class="s1">item</span><span class="s2">.</span><span class="s1">selected </span><span class="s2">= </span><span class="s1">item</span><span class="s2">.</span><span class="s1">path </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span>

    <span class="s4">def </span><span class="s1">_save_previous_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_previous_path</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_previous_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_previous_path</span><span class="s2">[-</span><span class="s6">2</span><span class="s2">:]</span>

    <span class="s4">def </span><span class="s1">_trigger_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_files_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_files_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_files</span><span class="s2">)</span>
        <span class="s1">ev</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_entry_added</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_entry_added'</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_entries_cleared</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_entries_cleared'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_subentry_to_entry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_subentry_to_entry'</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_remove_subentry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_remove_subentry'</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_submit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">selected</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_submit'</span><span class="s2">, </span><span class="s1">selected</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">entry_touched</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s0">'''(internal) This method must be called by the template when an entry 
        is touched by the user. 
        '''</span>
        <span class="s4">if </span><span class="s2">(</span>
            <span class="s3">'button' </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">profile </span><span class="s4">and </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">button </span><span class="s4">in </span><span class="s2">(</span>
                <span class="s3">'scrollup'</span><span class="s2">, </span><span class="s3">'scrolldown'</span><span class="s2">, </span><span class="s3">'scrollleft'</span><span class="s2">, </span><span class="s3">'scrollright'</span><span class="s2">)):</span>
            <span class="s4">return False</span>

        <span class="s1">_dir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">dirselect </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirselect</span>

        <span class="s4">if </span><span class="s1">_dir </span><span class="s4">and </span><span class="s1">dirselect </span><span class="s4">and </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">is_double_tap</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">open_entry</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>
            <span class="s4">return</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiselect</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">_dir </span><span class="s4">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirselect</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">open_entry</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>
                    <span class="s4">return</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">_dir </span><span class="s4">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirselect</span><span class="s2">:</span>
                <span class="s4">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)), ]</span>

    <span class="s4">def </span><span class="s1">entry_released</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s0">'''(internal) This method must be called by the template when an entry 
        is touched by the user. 
 
        .. versionadded:: 1.1.0 
        '''</span>
        <span class="s4">if </span><span class="s2">(</span>
            <span class="s3">'button' </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">profile </span><span class="s4">and </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">button </span><span class="s4">in </span><span class="s2">(</span>
                <span class="s3">'scrollup'</span><span class="s2">, </span><span class="s3">'scrolldown'</span><span class="s2">, </span><span class="s3">'scrollleft'</span><span class="s2">, </span><span class="s3">'scrollright'</span><span class="s2">)):</span>
            <span class="s4">return False</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multiselect</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">) </span><span class="s4">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirselect</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">open_entry</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">is_double_tap</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirselect </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">):</span>
                    <span class="s4">return</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_submit'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">open_entry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s5"># Just check if we can list the directory. This is also what</span>
            <span class="s5"># _add_file does, so if it fails here, it would also fail later</span>
            <span class="s5"># on. Do the check here to prevent setting path to an invalid</span>
            <span class="s5"># directory that we cannot list.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s4">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s1">entry</span><span class="s2">.</span><span class="s1">locked </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s5"># If entry.path is to jump to previous directory, update path with</span>
            <span class="s5"># parent directory</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">selection </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, ] </span><span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirselect </span><span class="s4">else </span><span class="s2">[]</span>

    <span class="s4">def </span><span class="s1">_apply_filters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">files</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filters</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">files</span>
        <span class="s1">filtered </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">filt </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filters</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">filt</span><span class="s2">, </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">):</span>
                <span class="s1">filtered</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">fn </span><span class="s4">for </span><span class="s1">fn </span><span class="s4">in </span><span class="s1">files </span><span class="s4">if </span><span class="s1">filt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">)])</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">filtered</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">fn </span><span class="s4">for </span><span class="s1">fn </span><span class="s4">in </span><span class="s1">files </span><span class="s4">if </span><span class="s1">fnmatch</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">filt</span><span class="s2">)])</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">filter_dirs</span><span class="s2">:</span>
            <span class="s1">dirs </span><span class="s2">= [</span><span class="s1">fn </span><span class="s4">for </span><span class="s1">fn </span><span class="s4">in </span><span class="s1">files </span><span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)]</span>
            <span class="s1">filtered</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">dirs</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">filtered</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">get_nice_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">'''Pass the filepath. Returns the size in the best human readable 
        format or '' if it is a directory (Don't recursively calculate size). 
        '''</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">):</span>
            <span class="s4">return </span><span class="s3">''</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">size </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">getsize</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s4">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s3">'--'</span>

        <span class="s4">for </span><span class="s1">unit </span><span class="s4">in </span><span class="s1">filesize_units</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">size </span><span class="s2">&lt; </span><span class="s6">1024.0</span><span class="s2">:</span>
                <span class="s4">return </span><span class="s3">'%1.0f %s' </span><span class="s2">% (</span><span class="s1">size</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">)</span>
            <span class="s1">size </span><span class="s2">/= </span><span class="s6">1024.0</span>

    <span class="s4">def </span><span class="s1">_update_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s5"># trigger to start gathering the files in the new directory</span>
        <span class="s5"># we'll start a timer that will do the job, 10 times per frames</span>
        <span class="s5"># (default)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems_parent </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'parent'</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems_gen </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_generate_file_entries</span><span class="s2">(</span>
            <span class="s1">path</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'path'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">),</span>
            <span class="s1">parent</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems_parent</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s5"># cancel any previous clock if exist</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_files_entries_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>

        <span class="s5"># show the progression screen</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_hide_progress</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_files_entries</span><span class="s2">():</span>
            <span class="s5"># not enough for creating all the entries, all a clock to continue</span>
            <span class="s5"># start a timer for the next 100 ms</span>
            <span class="s4">if </span><span class="s1">ev </span><span class="s4">is None</span><span class="s2">:</span>
                <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_files_entries_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_interval</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_create_files_entries</span><span class="s2">, </span><span class="s6">.1</span><span class="s2">)</span>
            <span class="s1">ev</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_get_file_paths</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">items</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s2">[</span><span class="s1">file</span><span class="s2">.</span><span class="s1">path </span><span class="s4">for </span><span class="s1">file </span><span class="s4">in </span><span class="s1">items</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">_create_files_entries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s5"># create maximum entries during 50ms max, or 10 minimum (slow system)</span>
        <span class="s5"># (on a &quot;fast system&quot; (core i7 2700K), we can create up to 40 entries</span>
        <span class="s5"># in 50 ms. So 10 is fine for low system.</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">time</span><span class="s2">()</span>
        <span class="s1">finished </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">total </span><span class="s2">= </span><span class="s1">count </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">while </span><span class="s1">time</span><span class="s2">() - </span><span class="s1">start </span><span class="s2">&lt; </span><span class="s6">0.05 </span><span class="s4">or </span><span class="s1">count </span><span class="s2">&lt; </span><span class="s6">10</span><span class="s2">:</span>
            <span class="s4">try</span><span class="s2">:</span>
                <span class="s1">index</span><span class="s2">, </span><span class="s1">total</span><span class="s2">, </span><span class="s1">item </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems_gen</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
                <span class="s1">count </span><span class="s2">+= </span><span class="s6">1</span>
            <span class="s4">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                <span class="s1">finished </span><span class="s2">= </span><span class="s4">True</span>
                <span class="s4">break</span>
            <span class="s4">except </span><span class="s1">TypeError</span><span class="s2">:  </span><span class="s5"># in case _gitems_gen is None</span>
                <span class="s1">finished </span><span class="s2">= </span><span class="s4">True</span>
                <span class="s4">break</span>

        <span class="s5"># if this wasn't enough for creating all the entries, show a progress</span>
        <span class="s5"># bar, and report the activity to the user.</span>
        <span class="s4">if not </span><span class="s1">finished</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_show_progress</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">.</span><span class="s1">total </span><span class="s2">= </span><span class="s1">total</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
            <span class="s4">return True</span>

        <span class="s5"># we created all the files, now push them on the view</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_items </span><span class="s2">= </span><span class="s1">items </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems</span>
        <span class="s1">parent </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems_parent</span>
        <span class="s4">if </span><span class="s1">parent </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_entries_cleared'</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">entry </span><span class="s4">in </span><span class="s1">items</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_entry_added'</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">parent</span><span class="s2">.</span><span class="s1">entries</span><span class="s2">[:] = </span><span class="s1">items</span>
            <span class="s4">for </span><span class="s1">entry </span><span class="s4">in </span><span class="s1">items</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_subentry_to_entry'</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_file_paths</span><span class="s2">(</span><span class="s1">items</span><span class="s2">)</span>

        <span class="s5"># stop the progression / creation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_hide_progress</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_gitems_gen </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_files_entries_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
        <span class="s4">return False</span>

    <span class="s4">def </span><span class="s1">cancel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s0">'''Cancel any background action started by filechooser, such as loading 
        a new directory. 
 
        .. versionadded:: 1.2.0 
        '''</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_files_entries_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_hide_progress</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_previous_path</span><span class="s2">) &gt; </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s5"># if we cancel any action, the path will be set same as the</span>
            <span class="s5"># previous one, so we can safely cancel the update of the previous</span>
            <span class="s5"># path.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_previous_path</span><span class="s2">[-</span><span class="s6">2</span><span class="s2">]</span>

            <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_files_ev</span>
            <span class="s4">if </span><span class="s1">ev </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_show_progress</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">cls </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">progress_cls</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">string_types</span><span class="s2">):</span>
            <span class="s1">cls </span><span class="s2">= </span><span class="s1">Factory</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_progress </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_hide_progress</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_progress </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">_generate_file_entries</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s5"># Generator that will create all the files entries.</span>
        <span class="s5"># the generator is used via _update_files() and _create_files_entries()</span>
        <span class="s5"># don't use it directly.</span>
        <span class="s1">is_root </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'path'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">have_parent </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'parent'</span><span class="s2">, </span><span class="s4">None</span><span class="s2">) </span><span class="s4">is not None</span>

        <span class="s5"># Add the components that are always needed</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rootpath</span><span class="s2">:</span>
            <span class="s1">rootpath </span><span class="s2">= </span><span class="s1">realpath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rootpath</span><span class="s2">)</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">realpath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">rootpath</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">rootpath</span>
                <span class="s4">return</span>
            <span class="s4">elif </span><span class="s1">path </span><span class="s2">== </span><span class="s1">rootpath</span><span class="s2">:</span>
                <span class="s1">is_root </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win'</span><span class="s2">:</span>
                <span class="s1">is_root </span><span class="s2">= </span><span class="s1">splitdrive</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)[</span><span class="s6">1</span><span class="s2">] </span><span class="s4">in </span><span class="s2">(</span><span class="s1">sep</span><span class="s2">, </span><span class="s1">altsep</span><span class="s2">)</span>
            <span class="s4">elif </span><span class="s1">platform </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'macosx'</span><span class="s2">, </span><span class="s3">'linux'</span><span class="s2">, </span><span class="s3">'android'</span><span class="s2">, </span><span class="s3">'ios'</span><span class="s2">):</span>
                <span class="s1">is_root </span><span class="s2">= </span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">expanduser</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)) == </span><span class="s1">sep</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s5"># Unknown fs, just always add the .. entry but also log</span>
                <span class="s1">Logger</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'Filechooser: Unsupported OS: %r' </span><span class="s2">% </span><span class="s1">platform</span><span class="s2">)</span>
        <span class="s5"># generate an entries to go back to previous</span>
        <span class="s4">if not </span><span class="s1">is_root </span><span class="s4">and not </span><span class="s1">have_parent</span><span class="s2">:</span>
            <span class="s1">back </span><span class="s2">= </span><span class="s3">'..' </span><span class="s2">+ </span><span class="s1">sep</span>
            <span class="s4">if </span><span class="s1">platform </span><span class="s2">== </span><span class="s3">'win'</span><span class="s2">:</span>
                <span class="s1">new_path </span><span class="s2">= </span><span class="s1">path</span><span class="s2">[:</span><span class="s1">path</span><span class="s2">.</span><span class="s1">rfind</span><span class="s2">(</span><span class="s1">sep</span><span class="s2">)]</span>
                <span class="s4">if </span><span class="s1">sep </span><span class="s4">not in </span><span class="s1">new_path</span><span class="s2">:</span>
                    <span class="s1">new_path </span><span class="s2">+= </span><span class="s1">sep</span>
                <span class="s1">pardir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_entry_widget</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s1">back</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">''</span><span class="s2">, </span><span class="s1">path</span><span class="s2">=</span><span class="s1">new_path</span><span class="s2">, </span><span class="s1">controller</span><span class="s2">=</span><span class="s1">ref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">),</span>
                    <span class="s1">isdir</span><span class="s2">=</span><span class="s4">True</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s1">sep</span><span class="s2">,</span>
                    <span class="s1">get_nice_size</span><span class="s2">=</span><span class="s4">lambda</span><span class="s2">: </span><span class="s3">''</span><span class="s2">))</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">pardir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_entry_widget</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s1">back</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">''</span><span class="s2">, </span><span class="s1">path</span><span class="s2">=</span><span class="s1">back</span><span class="s2">, </span><span class="s1">controller</span><span class="s2">=</span><span class="s1">ref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">),</span>
                    <span class="s1">isdir</span><span class="s2">=</span><span class="s4">True</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s1">sep</span><span class="s2">,</span>
                    <span class="s1">get_nice_size</span><span class="s2">=</span><span class="s4">lambda</span><span class="s2">: </span><span class="s3">''</span><span class="s2">))</span>
            <span class="s4">yield </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s1">pardir</span>

        <span class="s5"># generate all the entries for files</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">total</span><span class="s2">, </span><span class="s1">item </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_add_files</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
                <span class="s4">yield </span><span class="s1">index</span><span class="s2">, </span><span class="s1">total</span><span class="s2">, </span><span class="s1">item</span>
        <span class="s4">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">(</span><span class="s3">'Unable to open directory &lt;%s&gt;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">[:] = []</span>

    <span class="s4">def </span><span class="s1">_create_entry_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">template </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">.</span><span class="s1">_ENTRY_TEMPLATE\</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout </span><span class="s4">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ENTRY_TEMPLATE</span>
        <span class="s4">return </span><span class="s1">Builder</span><span class="s2">.</span><span class="s1">template</span><span class="s2">(</span><span class="s1">template</span><span class="s2">, **</span><span class="s1">ctx</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_add_files</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">expanduser</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">files </span><span class="s2">= []</span>
        <span class="s1">fappend </span><span class="s2">= </span><span class="s1">files</span><span class="s2">.</span><span class="s1">append</span>
        <span class="s4">for </span><span class="s1">f </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
            <span class="s4">try</span><span class="s2">:</span>
                <span class="s5"># In the following, use fully qualified filenames</span>
                <span class="s1">fappend</span><span class="s2">(</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)))</span>
            <span class="s4">except </span><span class="s1">UnicodeDecodeError</span><span class="s2">:</span>
                <span class="s1">Logger</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">(</span><span class="s3">'unable to decode &lt;{}&gt;'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">f</span><span class="s2">))</span>
            <span class="s4">except </span><span class="s1">UnicodeEncodeError</span><span class="s2">:</span>
                <span class="s1">Logger</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">(</span><span class="s3">'unable to encode &lt;{}&gt;'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">f</span><span class="s2">))</span>
        <span class="s5"># Apply filename filters</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_apply_filters</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
        <span class="s5"># Sort the list of files</span>
        <span class="s1">files </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sort_func</span><span class="s2">(</span><span class="s1">files</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">)</span>
        <span class="s1">is_hidden </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_hidden</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">show_hidden</span><span class="s2">:</span>
            <span class="s1">files </span><span class="s2">= [</span><span class="s1">x </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">files </span><span class="s4">if not </span><span class="s1">is_hidden</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">files</span><span class="s2">[:] = </span><span class="s1">files</span>
        <span class="s1">total </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">files</span><span class="s2">)</span>
        <span class="s1">wself </span><span class="s2">= </span><span class="s1">ref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">fn </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">files</span><span class="s2">):</span>

            <span class="s4">def </span><span class="s1">get_nice_size</span><span class="s2">():</span>
                <span class="s5"># Use a closure for lazy-loading here</span>
                <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_nice_size</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>

            <span class="s1">ctx </span><span class="s2">= {</span><span class="s3">'name'</span><span class="s2">: </span><span class="s1">basename</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">),</span>
                   <span class="s3">'get_nice_size'</span><span class="s2">: </span><span class="s1">get_nice_size</span><span class="s2">,</span>
                   <span class="s3">'path'</span><span class="s2">: </span><span class="s1">fn</span><span class="s2">,</span>
                   <span class="s3">'controller'</span><span class="s2">: </span><span class="s1">wself</span><span class="s2">,</span>
                   <span class="s3">'isdir'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">),</span>
                   <span class="s3">'parent'</span><span class="s2">: </span><span class="s1">parent</span><span class="s2">,</span>
                   <span class="s3">'sep'</span><span class="s2">: </span><span class="s1">sep</span><span class="s2">}</span>
            <span class="s1">entry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_entry_widget</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
            <span class="s4">yield </span><span class="s1">index</span><span class="s2">, </span><span class="s1">total</span><span class="s2">, </span><span class="s1">entry</span>

    <span class="s4">def </span><span class="s1">entry_subselect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_system</span><span class="s2">.</span><span class="s1">is_dir</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">):</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_files</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s1">entry</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">close_subselection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">subentry </span><span class="s4">in </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">entries</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_remove_subentry'</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">FileChooserListView</span><span class="s2">(</span><span class="s1">FileChooserController</span><span class="s2">):</span>
    <span class="s0">'''Implementation of a :class:`FileChooserController` using a list view. 
 
    .. versionadded:: 1.9.0 
    '''</span>
    <span class="s1">_ENTRY_TEMPLATE </span><span class="s2">= </span><span class="s3">'FileListEntry'</span>


<span class="s4">class </span><span class="s1">FileChooserIconView</span><span class="s2">(</span><span class="s1">FileChooserController</span><span class="s2">):</span>
    <span class="s0">'''Implementation of a :class:`FileChooserController` using an icon view. 
 
    .. versionadded:: 1.9.0 
    '''</span>
    <span class="s1">_ENTRY_TEMPLATE </span><span class="s2">= </span><span class="s3">'FileIconEntry'</span>


<span class="s4">class </span><span class="s1">FileChooser</span><span class="s2">(</span><span class="s1">FileChooserController</span><span class="s2">):</span>
    <span class="s0">'''Implementation of a :class:`FileChooserController` which supports 
    switching between multiple, synced layout views. 
 
    The FileChooser can be used as follows: 
 
    .. code-block:: kv 
 
        BoxLayout: 
            orientation: 'vertical' 
 
            BoxLayout: 
                size_hint_y: None 
                height: sp(52) 
 
                Button: 
                    text: 'Icon View' 
                    on_press: fc.view_mode = 'icon' 
                Button: 
                    text: 'List View' 
                    on_press: fc.view_mode = 'list' 
 
            FileChooser: 
                id: fc 
                FileChooserIconLayout 
                FileChooserListLayout 
 
    .. versionadded:: 1.9.0 
    '''</span>

    <span class="s1">manager </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">()</span>
    <span class="s3">''' 
    Reference to the :class:`~kivy.uix.screenmanager.ScreenManager` instance. 
 
    manager is an :class:`~kivy.properties.ObjectProperty`. 
    '''</span>

    <span class="s1">_view_list </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">get_view_list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_list</span>

    <span class="s1">view_list </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">get_view_list</span><span class="s2">, </span><span class="s1">bind</span><span class="s2">=(</span><span class="s3">'_view_list'</span><span class="s2">,))</span>
    <span class="s3">''' 
    List of views added to this FileChooser. 
 
    view_list is an :class:`~kivy.properties.AliasProperty` of type 
    :class:`list`. 
    '''</span>

    <span class="s1">_view_mode </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">get_view_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_mode</span>

    <span class="s4">def </span><span class="s1">set_view_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">mode </span><span class="s4">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_list</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'unknown view mode %r' </span><span class="s2">% </span><span class="s1">mode</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_view_mode </span><span class="s2">= </span><span class="s1">mode</span>

    <span class="s1">view_mode </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span>
        <span class="s1">get_view_mode</span><span class="s2">, </span><span class="s1">set_view_mode</span><span class="s2">, </span><span class="s1">bind</span><span class="s2">=(</span><span class="s3">'_view_mode'</span><span class="s2">,))</span>
    <span class="s3">''' 
    Current layout view mode. 
 
    view_mode is an :class:`~kivy.properties.AliasProperty` of type 
    :class:`str`. 
    '''</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s4">def </span><span class="s1">_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s2">[</span><span class="s1">screen</span><span class="s2">.</span><span class="s1">children</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] </span><span class="s4">for </span><span class="s1">screen </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">screens</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooser</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">manager </span><span class="s2">= </span><span class="s1">ScreenManager</span><span class="s2">()</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooser</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">trigger_update_view </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">update_view</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span><span class="s2">(</span><span class="s3">'view_mode'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">trigger_update_view</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">widget </span><span class="s4">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_progress</span><span class="s2">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">FileChooser</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s4">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">, </span><span class="s3">'VIEWNAME'</span><span class="s2">):</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">widget</span><span class="s2">.</span><span class="s1">VIEWNAME </span><span class="s2">+ </span><span class="s3">'view'</span>
            <span class="s1">screen </span><span class="s2">= </span><span class="s1">Screen</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">widget</span><span class="s2">.</span><span class="s1">controller </span><span class="s2">= </span><span class="s1">self</span>
            <span class="s1">screen</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">screen</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">trigger_update_view</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s3">'widget must be a FileChooserLayout,'</span>
                <span class="s3">' not %s' </span><span class="s2">% </span><span class="s1">type</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">).</span><span class="s1">__name__</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">rebuild_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">views </span><span class="s2">= [</span><span class="s1">view</span><span class="s2">.</span><span class="s1">VIEWNAME </span><span class="s4">for </span><span class="s1">view </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">views </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_list</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_view_list </span><span class="s2">= </span><span class="s1">views</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_mode </span><span class="s4">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_list</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_view_mode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_list</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">update_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rebuild_views</span><span class="s2">()</span>

        <span class="s1">sm </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">manager</span>
        <span class="s1">viewlist </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_view_list</span>
        <span class="s1">view </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">view_mode</span>
        <span class="s1">current </span><span class="s2">= </span><span class="s1">sm</span><span class="s2">.</span><span class="s1">current</span><span class="s2">[:-</span><span class="s6">4</span><span class="s2">]</span>

        <span class="s1">viewindex </span><span class="s2">= </span><span class="s1">viewlist</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">view</span><span class="s2">) </span><span class="s4">if </span><span class="s1">view </span><span class="s4">in </span><span class="s1">viewlist </span><span class="s4">else </span><span class="s6">0</span>
        <span class="s1">currentindex </span><span class="s2">= </span><span class="s1">viewlist</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">current</span><span class="s2">) </span><span class="s4">if </span><span class="s1">current </span><span class="s4">in </span><span class="s1">viewlist </span><span class="s4">else </span><span class="s6">0</span>

        <span class="s1">direction </span><span class="s2">= </span><span class="s3">'left' </span><span class="s4">if </span><span class="s1">currentindex </span><span class="s2">&lt; </span><span class="s1">viewindex </span><span class="s4">else </span><span class="s3">'right'</span>

        <span class="s1">sm</span><span class="s2">.</span><span class="s1">transition</span><span class="s2">.</span><span class="s1">direction </span><span class="s2">= </span><span class="s1">direction</span>
        <span class="s1">sm</span><span class="s2">.</span><span class="s1">current </span><span class="s2">= </span><span class="s1">view </span><span class="s2">+ </span><span class="s3">'view'</span>

    <span class="s4">def </span><span class="s1">_create_entry_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s2">[</span><span class="s1">Builder</span><span class="s2">.</span><span class="s1">template</span><span class="s2">(</span><span class="s1">view</span><span class="s2">.</span><span class="s1">_ENTRY_TEMPLATE</span><span class="s2">, **</span><span class="s1">ctx</span><span class="s2">)</span>
                <span class="s4">for </span><span class="s1">view </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">]</span>

    <span class="s4">def </span><span class="s1">_get_file_paths</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">items</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s2">[</span><span class="s1">file</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">path </span><span class="s4">for </span><span class="s1">file </span><span class="s4">in </span><span class="s1">items</span><span class="s2">]</span>
        <span class="s4">return </span><span class="s2">[]</span>

    <span class="s4">def </span><span class="s1">_update_item_selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">viewitem </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_items</span><span class="s2">:</span>
            <span class="s1">selected </span><span class="s2">= </span><span class="s1">viewitem</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">path </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">selection</span>
            <span class="s4">for </span><span class="s1">item </span><span class="s4">in </span><span class="s1">viewitem</span><span class="s2">:</span>
                <span class="s1">item</span><span class="s2">.</span><span class="s1">selected </span><span class="s2">= </span><span class="s1">selected</span>

    <span class="s4">def </span><span class="s1">on_entry_added</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">view </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">):</span>
            <span class="s1">view</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span>
                <span class="s3">'on_entry_added'</span><span class="s2">,</span>
                <span class="s1">node</span><span class="s2">[</span><span class="s1">index</span><span class="s2">], </span><span class="s1">parent</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] </span><span class="s4">if </span><span class="s1">parent </span><span class="s4">else None</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_entries_cleared</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">view </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">:</span>
            <span class="s1">view</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_entries_cleared'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_subentry_to_entry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">view </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">):</span>
            <span class="s1">view</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_subentry_to_entry'</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">[</span><span class="s1">index</span><span class="s2">], </span><span class="s1">entry</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_remove_subentry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">view </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">):</span>
            <span class="s1">view</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_remove_subentry'</span><span class="s2">, </span><span class="s1">subentry</span><span class="s2">[</span><span class="s1">index</span><span class="s2">], </span><span class="s1">entry</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_submit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">selected</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s1">view_mode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">view_mode</span>
        <span class="s4">for </span><span class="s1">view </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_views</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">view_mode </span><span class="s2">== </span><span class="s1">view</span><span class="s2">.</span><span class="s1">VIEWNAME</span><span class="s2">:</span>
                <span class="s1">view</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_submit'</span><span class="s2">, </span><span class="s1">selected</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">)</span>
                <span class="s4">return</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">app </span><span class="s4">import </span><span class="s1">App</span>
    <span class="s4">from </span><span class="s1">pprint </span><span class="s4">import </span><span class="s1">pprint</span>
    <span class="s4">import </span><span class="s1">textwrap</span>
    <span class="s4">import </span><span class="s1">sys</span>

    <span class="s1">root </span><span class="s2">= </span><span class="s1">Builder</span><span class="s2">.</span><span class="s1">load_string</span><span class="s2">(</span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">'''</span><span class="s4">\ 
    </span><span class="s3">BoxLayout: 
        orientation: 'vertical' 
 
        BoxLayout: 
            size_hint_y: None 
            height: sp(52) 
 
            Button: 
                text: 'Icon View' 
                on_press: fc.view_mode = 'icon' 
            Button: 
                text: 'List View' 
                on_press: fc.view_mode = 'list' 
 
        FileChooser: 
            id: fc 
 
            FileChooserIconLayout 
            FileChooserListLayout 
    '''</span><span class="s2">))</span>

    <span class="s4">class </span><span class="s1">FileChooserApp</span><span class="s2">(</span><span class="s1">App</span><span class="s2">):</span>

        <span class="s4">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">root</span><span class="s2">.</span><span class="s1">ids</span><span class="s2">.</span><span class="s1">fc</span>
            <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">) &gt; </span><span class="s6">1</span><span class="s2">:</span>
                <span class="s1">v</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>

            <span class="s1">v</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">selection</span><span class="s2">=</span><span class="s4">lambda </span><span class="s2">*</span><span class="s1">x</span><span class="s2">: </span><span class="s1">pprint</span><span class="s2">(</span><span class="s3">&quot;selection: %s&quot; </span><span class="s2">% </span><span class="s1">x</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]))</span>
            <span class="s1">v</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s4">lambda </span><span class="s2">*</span><span class="s1">x</span><span class="s2">: </span><span class="s1">pprint</span><span class="s2">(</span><span class="s3">&quot;path: %s&quot; </span><span class="s2">% </span><span class="s1">x</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]))</span>

            <span class="s4">return </span><span class="s1">root</span>

    <span class="s1">FileChooserApp</span><span class="s2">().</span><span class="s1">run</span><span class="s2">()</span>
</pre>
</body>
</html>