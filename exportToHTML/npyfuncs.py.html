<html>
<head>
<title>npyfuncs.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
npyfuncs.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Codegen for functions used as kernels in NumPy functions 
 
Typically, the kernels of several ufuncs that can't map directly to 
Python builtins 
&quot;&quot;&quot;</span>


<span class="s2">import </span><span class="s1">math</span>

<span class="s2">import </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>

<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">extending </span><span class="s2">import </span><span class="s1">overload</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">imputils </span><span class="s2">import </span><span class="s1">impl_ret_untracked</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core </span><span class="s2">import </span><span class="s1">typing</span><span class="s3">, </span><span class="s1">types</span><span class="s3">, </span><span class="s1">errors</span><span class="s3">, </span><span class="s1">lowering</span><span class="s3">, </span><span class="s1">cgutils</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">extending </span><span class="s2">import </span><span class="s1">register_jitable</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">np </span><span class="s2">import </span><span class="s1">npdatetime</span>
<span class="s2">from </span><span class="s1">numba</span><span class="s3">.</span><span class="s1">np</span><span class="s3">.</span><span class="s1">math </span><span class="s2">import </span><span class="s1">cmathimpl</span><span class="s3">, </span><span class="s1">mathimpl</span><span class="s3">, </span><span class="s1">numbers</span>

<span class="s4"># some NumPy constants. Note that we could generate some of them using</span>
<span class="s4"># the math library, but having the values copied from npy_math seems to</span>
<span class="s4"># yield more accurate results</span>
<span class="s1">_NPY_LOG2E  </span><span class="s3">= </span><span class="s5">1.442695040888963407359924681001892137 </span><span class="s4"># math.log(math.e, 2)</span>
<span class="s1">_NPY_LOG10E </span><span class="s3">= </span><span class="s5">0.434294481903251827651128918916605082 </span><span class="s4"># math.log(math.e, 10)</span>
<span class="s1">_NPY_LOGE2  </span><span class="s3">= </span><span class="s5">0.693147180559945309417232121458176568 </span><span class="s4"># math.log(2)</span>


<span class="s2">def </span><span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">arity</span><span class="s3">, </span><span class="s1">return_type </span><span class="s3">= </span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;checks that the following are true: 
    - args and sig.args have arg_count elements 
    - all input types are homogeneous 
    - return type is 'return_type' if provided, otherwise it must be 
      homogeneous with the input types. 
    &quot;&quot;&quot;</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">args</span><span class="s3">) == </span><span class="s1">arity</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">) == </span><span class="s1">arity</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">return_type </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">return_type </span><span class="s3">= </span><span class="s1">ty</span>
    <span class="s4"># must have homogeneous args</span>
    <span class="s2">if not</span><span class="s3">( </span><span class="s1">all</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">==</span><span class="s1">ty </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">) </span><span class="s2">and </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type </span><span class="s3">== </span><span class="s1">return_type</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">inspect</span>
        <span class="s1">fname </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">currentframe</span><span class="s3">().</span><span class="s1">f_back</span><span class="s3">.</span><span class="s1">f_code</span><span class="s3">.</span><span class="s1">co_name</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">'{0} called with invalid types: {1}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">)</span>
        <span class="s2">assert False</span><span class="s3">, </span><span class="s1">msg</span>


<span class="s2">def </span><span class="s1">_call_func_by_name_with_cast</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">,</span>
                                 <span class="s1">func_name</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">):</span>
    <span class="s4"># it is quite common in NumPy to have loops implemented as a call</span>
    <span class="s4"># to the double version of the function, wrapped in casts. This</span>
    <span class="s4"># helper function facilitates that.</span>
    <span class="s1">mod </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">module</span>
    <span class="s1">lty </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_argument_type</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">fnty </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">(</span><span class="s1">lty</span><span class="s3">, [</span><span class="s1">lty</span><span class="s3">]*</span><span class="s1">len</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">))</span>
    <span class="s1">fn </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">insert_pure_function</span><span class="s3">(</span><span class="s1">mod</span><span class="s3">, </span><span class="s1">fnty</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">func_name</span><span class="s3">)</span>
    <span class="s1">cast_args </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">, </span><span class="s1">argty</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
                 <span class="s2">for </span><span class="s1">arg</span><span class="s3">, </span><span class="s1">argty </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">args</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">) ]</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">cast_args</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_dispatch_func_by_name_type</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">table</span><span class="s3">, </span><span class="s1">user_name</span><span class="s3">):</span>
    <span class="s4"># for most cases the functions are homogeneous on all their types.</span>
    <span class="s4"># this code dispatches on the first argument type as it is the most useful</span>
    <span class="s4"># for our uses (all cases but ldexp are homogeneous in all types, and</span>
    <span class="s4"># dispatching on the first argument type works of ldexp as well)</span>
    <span class="s4">#</span>
    <span class="s4"># assumes that the function pointed by func_name has the type</span>
    <span class="s4"># signature sig (but needs translation to llvm types).</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">func_name </span><span class="s3">= </span><span class="s1">table</span><span class="s3">[</span><span class="s1">ty</span><span class="s3">]</span>
    <span class="s2">except </span><span class="s1">KeyError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;No {0} function for real type {1}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">user_name</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">))</span>
        <span class="s2">raise </span><span class="s1">errors</span><span class="s3">.</span><span class="s1">LoweringError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s1">mod </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">module</span>
    <span class="s2">if </span><span class="s1">ty </span><span class="s2">in </span><span class="s1">types</span><span class="s3">.</span><span class="s1">complex_domain</span><span class="s3">:</span>
        <span class="s4"># In numba struct types are always passed by pointer. So the call has to</span>
        <span class="s4"># be transformed from &quot;result = func(ops...)&quot; to &quot;func(&amp;result, ops...).</span>
        <span class="s4"># note that the result value pointer as first argument is the convention</span>
        <span class="s4"># used by numba.</span>

        <span class="s4"># First, prepare the return value</span>
        <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
        <span class="s1">ptrargs </span><span class="s3">= [</span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">alloca_once_value</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">)</span>
                   <span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
        <span class="s1">call_args </span><span class="s3">= [</span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getpointer</span><span class="s3">()] + </span><span class="s1">ptrargs</span>
        <span class="s4"># get_value_as_argument for struct types like complex allocate stack space</span>
        <span class="s4"># and initialize with the value, the return value is the pointer to that</span>
        <span class="s4"># allocated space (ie: pointer to a copy of the value in the stack).</span>
        <span class="s4"># get_argument_type returns a pointer to the struct type in consonance.</span>
        <span class="s1">call_argtys </span><span class="s3">= [</span><span class="s1">ty</span><span class="s3">] + </span><span class="s1">list</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">call_argltys </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">).</span><span class="s1">as_pointer</span><span class="s3">()</span>
                        <span class="s2">for </span><span class="s1">ty </span><span class="s2">in </span><span class="s1">call_argtys</span><span class="s3">]</span>
        <span class="s1">fnty </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">(</span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">VoidType</span><span class="s3">(), </span><span class="s1">call_argltys</span><span class="s3">)</span>
        <span class="s4"># Note: the function isn't pure here (it writes to its pointer args)</span>
        <span class="s1">fn </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">get_or_insert_function</span><span class="s3">(</span><span class="s1">mod</span><span class="s3">, </span><span class="s1">fnty</span><span class="s3">, </span><span class="s1">func_name</span><span class="s3">)</span>
        <span class="s1">builder</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">call_args</span><span class="s3">)</span>
        <span class="s1">retval </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">call_args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">argtypes </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_argument_type</span><span class="s3">(</span><span class="s1">aty</span><span class="s3">) </span><span class="s2">for </span><span class="s1">aty </span><span class="s2">in </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">]</span>
        <span class="s1">restype </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_argument_type</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">)</span>
        <span class="s1">fnty </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">(</span><span class="s1">restype</span><span class="s3">, </span><span class="s1">argtypes</span><span class="s3">)</span>
        <span class="s1">fn </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">insert_pure_function</span><span class="s3">(</span><span class="s1">mod</span><span class="s3">, </span><span class="s1">fnty</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">func_name</span><span class="s3">)</span>
        <span class="s1">retval </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">call_external_function</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">retval</span>



<span class="s4">########################################################################</span>
<span class="s4"># Division kernels inspired by NumPy loops.c.src code</span>
<span class="s4">#</span>
<span class="s4"># The builtins are not applicable as they rely on a test for zero in the</span>
<span class="s4"># denominator. If it is zero the appropriate exception is raised.</span>
<span class="s4"># In NumPy, a division by zero does not raise an exception, but instead</span>
<span class="s4"># generated a known value. Note that a division by zero in any of the</span>
<span class="s4"># operations of a vector may raise an exception or issue a warning</span>
<span class="s4"># depending on the np.seterr configuration. This is not supported</span>
<span class="s4"># right now (and in any case, it won't be handled by these functions</span>
<span class="s4"># either)</span>

<span class="s2">def </span><span class="s1">np_int_sdiv_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># based on the actual code in NumPy loops.c.src for signed integer types</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">num</span><span class="s3">, </span><span class="s1">den </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]  </span><span class="s4"># any arg type will do, homogeneous</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">MINUS_ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">MIN_INT </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">&lt;&lt; (</span><span class="s1">den</span><span class="s3">.</span><span class="s1">type</span><span class="s3">.</span><span class="s1">width</span><span class="s3">-</span><span class="s5">1</span><span class="s3">))</span>
    <span class="s1">den_is_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
    <span class="s1">den_is_minus_one </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">MINUS_ONE</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
    <span class="s1">num_is_min_int </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">MIN_INT</span><span class="s3">, </span><span class="s1">num</span><span class="s3">)</span>
    <span class="s1">could_cause_sigfpe </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">den_is_minus_one</span><span class="s3">, </span><span class="s1">num_is_min_int</span><span class="s3">)</span>
    <span class="s1">force_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">den_is_zero</span><span class="s3">, </span><span class="s1">could_cause_sigfpe</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">force_zero</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">then</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">then</span><span class="s3">:</span>
            <span class="s1">bb_then </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>
        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s1">bb_otherwise </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>
            <span class="s1">div </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">sdiv</span><span class="s3">(</span><span class="s1">num</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
            <span class="s1">mod </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">srem</span><span class="s3">(</span><span class="s1">num</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
            <span class="s1">num_gt_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">num</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
            <span class="s1">den_gt_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">den</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
            <span class="s1">not_same_sign </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">xor</span><span class="s3">(</span><span class="s1">num_gt_zero</span><span class="s3">, </span><span class="s1">den_gt_zero</span><span class="s3">)</span>
            <span class="s1">mod_not_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">mod</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
            <span class="s1">needs_fixing </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">not_same_sign</span><span class="s3">, </span><span class="s1">mod_not_zero</span><span class="s3">)</span>
            <span class="s1">fix_value </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">needs_fixing</span><span class="s3">, </span><span class="s1">MINUS_ONE</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
            <span class="s1">result_otherwise </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">div</span><span class="s3">, </span><span class="s1">fix_value</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">phi</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">type</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">bb_then</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">result_otherwise</span><span class="s3">, </span><span class="s1">bb_otherwise</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">result</span>


<span class="s2">def </span><span class="s1">np_int_srem_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># based on the actual code in NumPy loops.c.src for signed integers</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">num</span><span class="s3">, </span><span class="s1">den </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]  </span><span class="s4"># any arg type will do, homogeneous</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">den_not_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
    <span class="s1">bb_no_if </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>
    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_unlikely</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">den_not_zero</span><span class="s3">):</span>
        <span class="s1">bb_if </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>
        <span class="s1">mod </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">srem</span><span class="s3">(</span><span class="s1">num</span><span class="s3">,</span><span class="s1">den</span><span class="s3">)</span>
        <span class="s1">num_gt_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">num</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
        <span class="s1">den_gt_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">den</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
        <span class="s1">not_same_sign </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">xor</span><span class="s3">(</span><span class="s1">num_gt_zero</span><span class="s3">, </span><span class="s1">den_gt_zero</span><span class="s3">)</span>
        <span class="s1">mod_not_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">mod</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
        <span class="s1">needs_fixing </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">not_same_sign</span><span class="s3">, </span><span class="s1">mod_not_zero</span><span class="s3">)</span>
        <span class="s1">fix_value </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">needs_fixing</span><span class="s3">, </span><span class="s1">den</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
        <span class="s1">final_mod </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">fix_value</span><span class="s3">, </span><span class="s1">mod</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">phi</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">type</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">bb_no_if</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">final_mod</span><span class="s3">, </span><span class="s1">bb_if</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">result</span>


<span class="s2">def </span><span class="s1">np_int_sdivrem_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">div </span><span class="s3">= </span><span class="s1">np_int_sdiv_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">[</span><span class="s5">0</span><span class="s3">](*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">), </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">rem </span><span class="s3">= </span><span class="s1">np_int_srem_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">[</span><span class="s5">1</span><span class="s3">](*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">), </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_tuple</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">, [</span><span class="s1">div</span><span class="s3">, </span><span class="s1">rem</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_int_udiv_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">num</span><span class="s3">, </span><span class="s1">den </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]  </span><span class="s4"># any arg type will do, homogeneous</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">div_by_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">div_by_zero</span><span class="s3">, </span><span class="s1">likely</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">then</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">then</span><span class="s3">:</span>
            <span class="s4"># division by zero</span>
            <span class="s1">bb_then </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>
        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s4"># divide!</span>
            <span class="s1">div </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">udiv</span><span class="s3">(</span><span class="s1">num</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
            <span class="s1">bb_otherwise </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">phi</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">type</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">bb_then</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">div</span><span class="s3">, </span><span class="s1">bb_otherwise</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">result</span>


<span class="s2">def </span><span class="s1">np_int_urem_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># based on the actual code in NumPy loops.c.src for signed integers</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">num</span><span class="s3">, </span><span class="s1">den </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]  </span><span class="s4"># any arg type will do, homogeneous</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">den_not_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">den</span><span class="s3">)</span>
    <span class="s1">bb_no_if </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>
    <span class="s2">with </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">if_unlikely</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">den_not_zero</span><span class="s3">):</span>
        <span class="s1">bb_if </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">basic_block</span>
        <span class="s1">mod </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">urem</span><span class="s3">(</span><span class="s1">num</span><span class="s3">,</span><span class="s1">den</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">phi</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">type</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">bb_no_if</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">add_incoming</span><span class="s3">(</span><span class="s1">mod</span><span class="s3">, </span><span class="s1">bb_if</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">result</span>


<span class="s2">def </span><span class="s1">np_int_udivrem_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">div </span><span class="s3">= </span><span class="s1">np_int_udiv_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">[</span><span class="s5">0</span><span class="s3">](*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">), </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">rem </span><span class="s3">= </span><span class="s1">np_int_urem_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">[</span><span class="s5">1</span><span class="s3">](*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">), </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_tuple</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">, [</span><span class="s1">div</span><span class="s3">, </span><span class="s1">rem</span><span class="s3">])</span>


<span class="s4"># implementation of int_fmod is in fact the same as the unsigned remainder,</span>
<span class="s4"># that is: srem with a special case returning 0 when the denominator is 0.</span>
<span class="s1">np_int_fmod_impl </span><span class="s3">= </span><span class="s1">np_int_urem_impl</span>


<span class="s2">def </span><span class="s1">np_real_div_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># in NumPy real div has the same semantics as an fdiv for generating</span>
    <span class="s4"># NANs, INF and NINF</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_mod_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># note: this maps to NumPy remainder, which has the same semantics as Python</span>
    <span class="s4"># based on code in loops.c.src</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">ty</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">frem</span><span class="s3">(</span><span class="s1">in1</span><span class="s3">, </span><span class="s1">in2</span><span class="s3">)</span>
    <span class="s1">res_ne_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">res</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
    <span class="s1">den_lt_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;'</span><span class="s3">, </span><span class="s1">in2</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
    <span class="s1">res_lt_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;'</span><span class="s3">, </span><span class="s1">res</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
    <span class="s1">needs_fixing </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">res_ne_zero</span><span class="s3">,</span>
                                <span class="s1">builder</span><span class="s3">.</span><span class="s1">xor</span><span class="s3">(</span><span class="s1">den_lt_zero</span><span class="s3">, </span><span class="s1">res_lt_zero</span><span class="s3">))</span>
    <span class="s1">fix_value </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">needs_fixing</span><span class="s3">, </span><span class="s1">in2</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">fix_value</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_fmod_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">frem</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_fabs</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">):</span>
    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>
    <span class="s1">arg_negated </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">)</span>
    <span class="s1">arg_is_negative </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;'</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg_is_negative</span><span class="s3">, </span><span class="s1">arg_negated</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_div_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># Extracted from numpy/core/src/umath/loops.c.src,</span>
    <span class="s4"># inspired by complex_div_impl</span>
    <span class="s4"># variables named coherent with loops.c.src</span>
    <span class="s4"># This is implemented using the approach described in</span>
    <span class="s4">#   R.L. Smith. Algorithm 116: Complex division.</span>
    <span class="s4">#   Communications of the ACM, 5(8):435, 1962</span>

    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>

    <span class="s1">in1r </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real  </span><span class="s4"># numerator.real</span>
    <span class="s1">in1i </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag  </span><span class="s4"># numerator.imag</span>
    <span class="s1">in2r </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real  </span><span class="s4"># denominator.real</span>
    <span class="s1">in2i </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag  </span><span class="s4"># denominator.imag</span>
    <span class="s1">ftype </span><span class="s3">= </span><span class="s1">in1r</span><span class="s3">.</span><span class="s1">type</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">([</span><span class="s1">i</span><span class="s3">.</span><span class="s1">type</span><span class="s3">==</span><span class="s1">ftype </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s3">[</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">in2i</span><span class="s3">]]), </span><span class="s6">&quot;mismatched types&quot;</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_helper</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">)</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">ftype</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>
    <span class="s1">ONE </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">ftype</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>

    <span class="s4"># if abs(denominator.real) &gt;= abs(denominator.imag)</span>
    <span class="s1">in2r_abs </span><span class="s3">= </span><span class="s1">_fabs</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">in2r</span><span class="s3">)</span>
    <span class="s1">in2i_abs </span><span class="s3">= </span><span class="s1">_fabs</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">in2i</span><span class="s3">)</span>
    <span class="s1">in2r_abs_ge_in2i_abs </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">in2r_abs</span><span class="s3">, </span><span class="s1">in2i_abs</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">in2r_abs_ge_in2i_abs</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">then</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">then</span><span class="s3">:</span>
            <span class="s4"># if abs(denominator.real) == 0 and abs(denominator.imag) == 0</span>
            <span class="s1">in2r_is_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">in2r_abs</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
            <span class="s1">in2i_is_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">in2i_abs</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">)</span>
            <span class="s1">in2_is_zero </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">in2r_is_zero</span><span class="s3">, </span><span class="s1">in2i_is_zero</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">in2_is_zero</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">inn_then</span><span class="s3">, </span><span class="s1">inn_otherwise</span><span class="s3">):</span>
                <span class="s2">with </span><span class="s1">inn_then</span><span class="s3">:</span>
                    <span class="s4"># division by 0.</span>
                    <span class="s4"># fdiv generates the appropriate NAN/INF/NINF</span>
                    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">in2r_abs</span><span class="s3">)</span>
                    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">in2i_abs</span><span class="s3">)</span>
                <span class="s2">with </span><span class="s1">inn_otherwise</span><span class="s3">:</span>
                    <span class="s4"># general case for:</span>
                    <span class="s4"># abs(denominator.real) &gt; abs(denominator.imag)</span>
                    <span class="s1">rat </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in2i</span><span class="s3">, </span><span class="s1">in2r</span><span class="s3">)</span>
                    <span class="s4"># scl = 1.0/(in2r + in2i*rat)</span>
                    <span class="s1">tmp1 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in2i</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
                    <span class="s1">tmp2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">tmp1</span><span class="s3">)</span>
                    <span class="s1">scl </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">ONE</span><span class="s3">, </span><span class="s1">tmp2</span><span class="s3">)</span>
                    <span class="s4"># out.real = (in1r + in1i*rat)*scl</span>
                    <span class="s4"># out.imag = (in1i - in1r*rat)*scl</span>
                    <span class="s1">tmp3 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
                    <span class="s1">tmp4 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
                    <span class="s1">tmp5 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">tmp3</span><span class="s3">)</span>
                    <span class="s1">tmp6 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">tmp4</span><span class="s3">)</span>
                    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">tmp5</span><span class="s3">, </span><span class="s1">scl</span><span class="s3">)</span>
                    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">tmp6</span><span class="s3">, </span><span class="s1">scl</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s4"># general case for:</span>
            <span class="s4"># abs(denominator.imag) &gt; abs(denominator.real)</span>
            <span class="s1">rat </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">in2i</span><span class="s3">)</span>
            <span class="s4"># scl = 1.0/(in2i + in2r*rat)</span>
            <span class="s1">tmp1 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
            <span class="s1">tmp2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in2i</span><span class="s3">, </span><span class="s1">tmp1</span><span class="s3">)</span>
            <span class="s1">scl </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">ONE</span><span class="s3">, </span><span class="s1">tmp2</span><span class="s3">)</span>
            <span class="s4"># out.real = (in1r*rat + in1i)*scl</span>
            <span class="s4"># out.imag = (in1i*rat - in1r)*scl</span>
            <span class="s1">tmp3 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
            <span class="s1">tmp4 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
            <span class="s1">tmp5 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">tmp3</span><span class="s3">, </span><span class="s1">in1i</span><span class="s3">)</span>
            <span class="s1">tmp6 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s1">tmp4</span><span class="s3">, </span><span class="s1">in1r</span><span class="s3">)</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">tmp5</span><span class="s3">, </span><span class="s1">scl</span><span class="s3">)</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">tmp6</span><span class="s3">, </span><span class="s1">scl</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy logaddexp</span>

<span class="s2">def </span><span class="s1">_npy_logaddexp</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">):</span>
    <span class="s2">pass</span>

<span class="s2">def </span><span class="s1">_generate_logaddexp</span><span class="s3">(</span><span class="s1">fnoverload</span><span class="s3">, </span><span class="s1">const</span><span class="s3">, </span><span class="s1">log1pfn</span><span class="s3">, </span><span class="s1">expfn</span><span class="s3">):</span>
    <span class="s4"># Code generation for logaddexp and logaddexp2 is based on:</span>
    <span class="s4"># https://github.com/numpy/numpy/blob/12c2b7dd62fc0c14b81c8892ed5f4f59cc94d09c/numpy/core/src/npymath/npy_math_internal.h.src#L467-L507</span>

    <span class="s3">@</span><span class="s1">overload</span><span class="s3">(</span><span class="s1">fnoverload</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s6">'generic'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">ol_npy_logaddexp</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">x1 </span><span class="s3">!= </span><span class="s1">x2</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">shift </span><span class="s3">= </span><span class="s1">x1</span><span class="s3">(</span><span class="s1">const</span><span class="s3">)</span>
        <span class="s2">def </span><span class="s1">impl</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">):</span>
            <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">x </span><span class="s3">== </span><span class="s1">y</span><span class="s3">):</span>
                <span class="s4"># Handles infinities of the same sign without warnings</span>
                <span class="s2">return </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">shift</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">tmp </span><span class="s3">= </span><span class="s1">x </span><span class="s3">- </span><span class="s1">y</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">tmp </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">):</span>
                    <span class="s2">return </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">log1pfn</span><span class="s3">(</span><span class="s1">expfn</span><span class="s3">(-</span><span class="s1">tmp</span><span class="s3">))</span>
                <span class="s2">elif </span><span class="s3">(</span><span class="s1">tmp </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">):</span>
                    <span class="s2">return </span><span class="s1">y </span><span class="s3">+ </span><span class="s1">log1pfn</span><span class="s3">(</span><span class="s1">expfn</span><span class="s3">(</span><span class="s1">tmp</span><span class="s3">))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s4"># NaN</span>
                    <span class="s2">return </span><span class="s1">tmp</span>
        <span class="s2">return </span><span class="s1">impl</span>

<span class="s2">def </span><span class="s1">_npy_logaddexp</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">):</span>
    <span class="s2">pass</span>


<span class="s1">_generate_logaddexp</span><span class="s3">(</span><span class="s1">_npy_logaddexp</span><span class="s3">, </span><span class="s1">_NPY_LOGE2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log1p</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_logaddexp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">fnty </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">typing_context</span><span class="s3">.</span><span class="s1">resolve_value_type</span><span class="s3">(</span><span class="s1">_npy_logaddexp</span><span class="s3">)</span>
    <span class="s1">sig </span><span class="s3">= </span><span class="s1">fnty</span><span class="s3">.</span><span class="s1">get_call_type</span><span class="s3">(</span><span class="s1">context</span><span class="s3">.</span><span class="s1">typing_context</span><span class="s3">, (*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">,), {})</span>
    <span class="s1">impl </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_function</span><span class="s3">(</span><span class="s1">fnty</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">impl</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

<span class="s4">########################################################################</span>
<span class="s4"># NumPy logaddexp2</span>
<span class="s2">def </span><span class="s1">_npy_logaddexp2</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">):</span>
    <span class="s2">pass</span>

<span class="s2">def </span><span class="s1">npy_log2_1p</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
    <span class="s2">pass</span>

<span class="s4"># The following npy_log2_1p function is a translation of:</span>
<span class="s4"># https://github.com/numpy/numpy/blob/12c2b7dd62fc0c14b81c8892ed5f4f59cc94d09c/numpy/core/src/npymath/npy_math_internal.h.src#L457-L460</span>

<span class="s3">@</span><span class="s1">overload</span><span class="s3">(</span><span class="s1">npy_log2_1p</span><span class="s3">, </span><span class="s1">target</span><span class="s3">=</span><span class="s6">'generic'</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">ol_npy_log2_1p</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
    <span class="s1">LOG2E </span><span class="s3">= </span><span class="s1">x</span><span class="s3">(</span><span class="s1">_NPY_LOG2E</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">impl</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">LOG2E </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log1p</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">impl</span>


<span class="s1">_generate_logaddexp</span><span class="s3">(</span><span class="s1">_npy_logaddexp2</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s1">npy_log2_1p</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_logaddexp2_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">fnty </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">typing_context</span><span class="s3">.</span><span class="s1">resolve_value_type</span><span class="s3">(</span><span class="s1">_npy_logaddexp2</span><span class="s3">)</span>
    <span class="s1">sig </span><span class="s3">= </span><span class="s1">fnty</span><span class="s3">.</span><span class="s1">get_call_type</span><span class="s3">(</span><span class="s1">context</span><span class="s3">.</span><span class="s1">typing_context</span><span class="s3">, (*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">,), {})</span>
    <span class="s1">impl </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_function</span><span class="s3">(</span><span class="s1">fnty</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">impl</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># true div kernels</span>

<span class="s2">def </span><span class="s1">np_int_truediv_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># in NumPy we don't check for 0 denominator... fdiv handles div by</span>
    <span class="s4"># 0 in the way NumPy expects..</span>
    <span class="s4"># integer truediv always yields double</span>
    <span class="s1">num</span><span class="s3">, </span><span class="s1">den </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">lltype </span><span class="s3">= </span><span class="s1">num</span><span class="s3">.</span><span class="s1">type</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span><span class="s1">i</span><span class="s3">.</span><span class="s1">type</span><span class="s3">==</span><span class="s1">lltype </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">args</span><span class="s3">), </span><span class="s6">&quot;must have homogeneous types&quot;</span>
    <span class="s1">numty</span><span class="s3">, </span><span class="s1">denty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span>

    <span class="s1">num </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">num</span><span class="s3">, </span><span class="s1">numty</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">den </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">den</span><span class="s3">, </span><span class="s1">denty</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">num</span><span class="s3">,</span><span class="s1">den</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># floor div kernels</span>

<span class="s2">def </span><span class="s1">np_real_floor_div_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">np_real_div_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">s </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">np_real_floor_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">s</span><span class="s3">, (</span><span class="s1">res</span><span class="s3">,))</span>


<span class="s2">def </span><span class="s1">np_real_divmod_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">div </span><span class="s3">= </span><span class="s1">np_real_floor_div_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">[</span><span class="s5">0</span><span class="s3">](*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">), </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">rem </span><span class="s3">= </span><span class="s1">np_real_mod_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">[</span><span class="s5">1</span><span class="s3">](*</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">), </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_tuple</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">, [</span><span class="s1">div</span><span class="s3">, </span><span class="s1">rem</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_complex_floor_div_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># this is based on the complex floor divide in Numpy's loops.c.src</span>
    <span class="s4"># This is basically a full complex division with a complex floor</span>
    <span class="s4"># applied.</span>
    <span class="s4"># The complex floor seems to be defined as the real floor applied</span>
    <span class="s4"># with the real part and zero in the imaginary part. Fully developed</span>
    <span class="s4"># so it avoids computing anything related to the imaginary result.</span>
    <span class="s1">float_kind </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">underlying_float</span>
    <span class="s1">floor_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">float_kind</span><span class="s3">, </span><span class="s1">float_kind</span><span class="s3">)</span>

    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>

    <span class="s1">in1r </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">in1i </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">in2r </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">in2i </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">ftype </span><span class="s3">= </span><span class="s1">in1r</span><span class="s3">.</span><span class="s1">type</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">([</span><span class="s1">i</span><span class="s3">.</span><span class="s1">type</span><span class="s3">==</span><span class="s1">ftype </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s3">[</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">in2i</span><span class="s3">]]), </span><span class="s6">&quot;mismatched types&quot;</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">Constant</span><span class="s3">(</span><span class="s1">ftype</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>

    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_helper</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">ZERO</span>

    <span class="s1">in2r_abs </span><span class="s3">= </span><span class="s1">_fabs</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">in2r</span><span class="s3">)</span>
    <span class="s1">in2i_abs </span><span class="s3">= </span><span class="s1">_fabs</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">in2i</span><span class="s3">)</span>
    <span class="s1">in2r_abs_ge_in2i_abs </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">in2r_abs</span><span class="s3">, </span><span class="s1">in2i_abs</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">in2r_abs_ge_in2i_abs</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">then</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">then</span><span class="s3">:</span>
            <span class="s1">rat </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in2i</span><span class="s3">, </span><span class="s1">in2r</span><span class="s3">)</span>
            <span class="s4"># out.real = floor((in1r+in1i*rat)/(in2r + in2i*rat))</span>
            <span class="s1">tmp1 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
            <span class="s1">tmp2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in2i</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
            <span class="s1">tmp3 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">tmp1</span><span class="s3">)</span>
            <span class="s1">tmp4 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">tmp2</span><span class="s3">)</span>
            <span class="s1">tmp5 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">tmp3</span><span class="s3">, </span><span class="s1">tmp4</span><span class="s3">)</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">np_real_floor_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">floor_sig</span><span class="s3">, (</span><span class="s1">tmp5</span><span class="s3">,))</span>
        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s1">rat </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">in2i</span><span class="s3">)</span>
            <span class="s4"># out.real = floor((in1i + in1r*rat)/(in2i + in2r*rat))</span>
            <span class="s1">tmp1 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
            <span class="s1">tmp2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in2r</span><span class="s3">, </span><span class="s1">rat</span><span class="s3">)</span>
            <span class="s1">tmp3 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">tmp1</span><span class="s3">)</span>
            <span class="s1">tmp4 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in2i</span><span class="s3">, </span><span class="s1">tmp2</span><span class="s3">)</span>
            <span class="s1">tmp5 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">tmp3</span><span class="s3">, </span><span class="s1">tmp4</span><span class="s3">)</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">np_real_floor_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">floor_sig</span><span class="s3">, (</span><span class="s1">tmp5</span><span class="s3">,))</span>
    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># numpy power funcs</span>

<span class="s2">def </span><span class="s1">np_complex_power_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">complex_power_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># numpy float power funcs</span>

<span class="s2">def </span><span class="s1">real_float_power_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">real_power_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_float_power_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">complex_power_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># numpy greatest common denominator</span>

<span class="s2">def </span><span class="s1">np_gcd_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">gcd_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># numpy lowest common multiple</span>

<span class="s2">def </span><span class="s1">np_lcm_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>

    <span class="s1">xty</span><span class="s3">, </span><span class="s1">yty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span>
    <span class="s2">assert </span><span class="s1">xty </span><span class="s3">== </span><span class="s1">yty </span><span class="s3">== </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">args</span>

    <span class="s2">def </span><span class="s1">lcm</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Like gcd, heavily cribbed from Julia. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s5">0 </span><span class="s2">if </span><span class="s1">a </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">else </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">a </span><span class="s3">* (</span><span class="s1">b </span><span class="s3">// </span><span class="s1">np</span><span class="s3">.</span><span class="s1">gcd</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)))</span>

    <span class="s1">res </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">compile_internal</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">lcm</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">impl_ret_untracked</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># Numpy style complex sign</span>

<span class="s2">def </span><span class="s1">np_complex_sign_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># equivalent to complex sign in NumPy's sign</span>
    <span class="s4"># but implemented via selects, balancing the 4 cases.</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">op </span><span class="s3">= </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>
    <span class="s1">ONE  </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s1">MINUS_ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, -</span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s1">NAN </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s6">'nan'</span><span class="s3">))</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">ZERO</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">ZERO</span>

    <span class="s1">cmp_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, *[</span><span class="s1">ty</span><span class="s3">] * </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">cmp_args </span><span class="s3">= [</span><span class="s1">op</span><span class="s3">, </span><span class="s1">result</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()]</span>
    <span class="s1">arg1_ge_arg2 </span><span class="s3">= </span><span class="s1">np_complex_ge_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cmp_sig</span><span class="s3">, </span><span class="s1">cmp_args</span><span class="s3">)</span>
    <span class="s1">arg1_eq_arg2 </span><span class="s3">= </span><span class="s1">np_complex_eq_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cmp_sig</span><span class="s3">, </span><span class="s1">cmp_args</span><span class="s3">)</span>
    <span class="s1">arg1_lt_arg2 </span><span class="s3">= </span><span class="s1">np_complex_lt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">cmp_sig</span><span class="s3">, </span><span class="s1">cmp_args</span><span class="s3">)</span>

    <span class="s1">real_when_ge </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_eq_arg2</span><span class="s3">, </span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">ONE</span><span class="s3">)</span>
    <span class="s1">real_when_nge </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_lt_arg2</span><span class="s3">, </span><span class="s1">MINUS_ONE</span><span class="s3">, </span><span class="s1">NAN</span><span class="s3">)</span>
    <span class="s1">result</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_ge_arg2</span><span class="s3">, </span><span class="s1">real_when_ge</span><span class="s3">, </span><span class="s1">real_when_nge</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">result</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># Numpy rint</span>

<span class="s2">def </span><span class="s1">np_real_rint_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">call_fp_intrinsic</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s6">'llvm.rint'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_rint_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># based on code in NumPy's funcs.inc.src</span>
    <span class="s4"># rint of a complex number defined as rint of its real and imag</span>
    <span class="s4"># parts</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">in1 </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>

    <span class="s1">inner_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">float_ty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">np_real_rint_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">inner_sig</span><span class="s3">, [</span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span><span class="s3">])</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">np_real_rint_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">inner_sig</span><span class="s3">, [</span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy exp</span>

<span class="s2">def </span><span class="s1">np_real_exp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">exp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_exp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">exp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

<span class="s4">########################################################################</span>
<span class="s4"># NumPy exp2</span>

<span class="s2">def </span><span class="s1">np_real_exp2_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ll_ty </span><span class="s3">= </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">type</span>
    <span class="s1">fnty </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">(</span><span class="s1">ll_ty</span><span class="s3">, [</span><span class="s1">ll_ty</span><span class="s3">,])</span>
    <span class="s1">fn </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">insert_pure_function</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">module</span><span class="s3">, </span><span class="s1">fnty</span><span class="s3">,</span>
                                      <span class="s1">name</span><span class="s3">=</span><span class="s6">'llvm.exp2'</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, [</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]])</span>


<span class="s2">def </span><span class="s1">np_complex_exp2_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">in1 </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">tmp </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">loge2 </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s1">_NPY_LOGE2</span><span class="s3">)</span>
    <span class="s1">tmp</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">loge2</span><span class="s3">, </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
    <span class="s1">tmp</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">loge2</span><span class="s3">, </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">np_complex_exp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, [</span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()])</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy log</span>

<span class="s2">def </span><span class="s1">np_real_log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

<span class="s4">########################################################################</span>
<span class="s4"># NumPy log2</span>

<span class="s2">def </span><span class="s1">np_real_log2_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ll_ty </span><span class="s3">= </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">type</span>
    <span class="s1">fnty </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">(</span><span class="s1">ll_ty</span><span class="s3">, [</span><span class="s1">ll_ty</span><span class="s3">,])</span>
    <span class="s1">fn </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">insert_pure_function</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">module</span><span class="s3">, </span><span class="s1">fnty</span><span class="s3">,</span>
                                      <span class="s1">name</span><span class="s3">=</span><span class="s6">'llvm.log2'</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, [</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]])</span>

<span class="s2">def </span><span class="s1">np_complex_log2_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">tmp </span><span class="s3">= </span><span class="s1">np_complex_log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">tmp </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">tmp</span><span class="s3">)</span>
    <span class="s1">log2e </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s1">_NPY_LOG2E</span><span class="s3">)</span>
    <span class="s1">tmp</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">log2e</span><span class="s3">, </span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
    <span class="s1">tmp</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">log2e</span><span class="s3">, </span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy log10</span>

<span class="s2">def </span><span class="s1">np_real_log10_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">log10_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_log10_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">tmp </span><span class="s3">= </span><span class="s1">np_complex_log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">tmp </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">tmp</span><span class="s3">)</span>
    <span class="s1">log10e </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s1">_NPY_LOG10E</span><span class="s3">)</span>
    <span class="s1">tmp</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">log10e</span><span class="s3">, </span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
    <span class="s1">tmp</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">log10e</span><span class="s3">, </span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy expm1</span>

<span class="s2">def </span><span class="s1">np_real_expm1_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">expm1_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">np_complex_expm1_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># this is based on nc_expm1 in funcs.inc.src</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">float_unary_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">float_ty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">MINUS_ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, -</span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s1">in1 </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">np_real_exp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">float_unary_sig</span><span class="s3">, [</span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span><span class="s3">])</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">cos_imag </span><span class="s3">= </span><span class="s1">np_real_cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">float_unary_sig</span><span class="s3">, [</span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">])</span>
    <span class="s1">sin_imag </span><span class="s3">= </span><span class="s1">np_real_sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">float_unary_sig</span><span class="s3">, [</span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">])</span>
    <span class="s1">tmp </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">cos_imag</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">sin_imag</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">tmp</span><span class="s3">, </span><span class="s1">MINUS_ONE</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy log1p</span>

<span class="s2">def </span><span class="s1">np_real_log1p_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">log1p_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">np_complex_log1p_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># base on NumPy's nc_log1p in funcs.inc.src</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">float_unary_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">float_ty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">float_binary_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">float_ty</span><span class="s3">]*</span><span class="s5">3</span><span class="s3">)</span>

    <span class="s1">ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s1">in1 </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">real_plus_one </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span><span class="s3">, </span><span class="s1">ONE</span><span class="s3">)</span>
    <span class="s1">l </span><span class="s3">= </span><span class="s1">np_real_hypot_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">float_binary_sig</span><span class="s3">,</span>
                           <span class="s3">[</span><span class="s1">real_plus_one</span><span class="s3">, </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">])</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">np_real_atan2_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">float_binary_sig</span><span class="s3">,</span>
                                  <span class="s3">[</span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">, </span><span class="s1">real_plus_one</span><span class="s3">])</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">np_real_log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">float_unary_sig</span><span class="s3">, [</span><span class="s1">l</span><span class="s3">])</span>

    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy sqrt</span>

<span class="s2">def </span><span class="s1">np_real_sqrt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">sqrt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_sqrt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">sqrt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy square</span>

<span class="s2">def </span><span class="s1">np_int_square_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">mul</span><span class="s3">(</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_real_square_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

<span class="s2">def </span><span class="s1">np_complex_square_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">binary_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">]*</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">complex_mul_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">binary_sig</span><span class="s3">,</span>
                                     <span class="s3">[</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]])</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy cbrt</span>

<span class="s2">def </span><span class="s1">np_real_cbrt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s4"># We enable fastmath here to force np.power(x, 1/3) to generate a</span>
    <span class="s4"># call to libm cbrt function</span>
    <span class="s3">@</span><span class="s1">register_jitable</span><span class="s3">(</span><span class="s1">fastmath</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">cbrt</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">x </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1.0 </span><span class="s3">/ </span><span class="s5">3.0</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1.0 </span><span class="s3">/ </span><span class="s5">3.0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_cbrt</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
        <span class="s2">return </span><span class="s1">cbrt</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">context</span><span class="s3">.</span><span class="s1">compile_internal</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">_cbrt</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy reciprocal</span>

<span class="s2">def </span><span class="s1">np_int_reciprocal_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># based on the implementation in loops.c.src</span>
    <span class="s4"># integer versions for reciprocal are performed via promotion</span>
    <span class="s4"># using double, and then converted back to the type</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span>

    <span class="s1">binary_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">ty</span><span class="s3">]*</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">in_as_float </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">result_as_float </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">ONE</span><span class="s3">, </span><span class="s1">in_as_float</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">result_as_float</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_reciprocal_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">ONE</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_complex_reciprocal_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># based on the implementation in loops.c.src</span>
    <span class="s4"># Basically the same Smith method used for division, but with</span>
    <span class="s4"># the numerator substituted by 1.0</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">float_ty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>

    <span class="s1">ZERO </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>
    <span class="s1">ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">float_ty</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s1">in1 </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">in1r </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">in1i </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">in1r_abs </span><span class="s3">= </span><span class="s1">_fabs</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">in1r</span><span class="s3">)</span>
    <span class="s1">in1i_abs </span><span class="s3">= </span><span class="s1">_fabs</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">in1i</span><span class="s3">)</span>
    <span class="s1">in1i_abs_le_in1r_abs </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;='</span><span class="s3">, </span><span class="s1">in1i_abs</span><span class="s3">, </span><span class="s1">in1r_abs</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">if_else</span><span class="s3">(</span><span class="s1">in1i_abs_le_in1r_abs</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">then</span><span class="s3">, </span><span class="s1">otherwise</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">then</span><span class="s3">:</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">in1r</span><span class="s3">)</span>
            <span class="s1">tmp0 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1i</span><span class="s3">, </span><span class="s1">r</span><span class="s3">)</span>
            <span class="s1">d </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">tmp0</span><span class="s3">)</span>
            <span class="s1">inv_d </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">ONE</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
            <span class="s1">minus_r </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">r</span><span class="s3">)</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">inv_d</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">minus_r</span><span class="s3">, </span><span class="s1">inv_d</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">otherwise</span><span class="s3">:</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">in1i</span><span class="s3">)</span>
            <span class="s1">tmp0 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">in1r</span><span class="s3">, </span><span class="s1">r</span><span class="s3">)</span>
            <span class="s1">d </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">tmp0</span><span class="s3">, </span><span class="s1">in1i</span><span class="s3">)</span>
            <span class="s1">inv_d </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">ONE</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">inv_d</span><span class="s3">)</span>
            <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s1">ZERO</span><span class="s3">, </span><span class="s1">inv_d</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy sin</span>

<span class="s2">def </span><span class="s1">np_real_sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy cos</span>

<span class="s2">def </span><span class="s1">np_real_cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy tan</span>

<span class="s2">def </span><span class="s1">np_real_tan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">tan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy asin</span>

<span class="s2">def </span><span class="s1">np_real_asin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">asin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy acos</span>

<span class="s2">def </span><span class="s1">np_real_acos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">acos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy atan</span>

<span class="s2">def </span><span class="s1">np_real_atan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">atan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy atan2</span>

<span class="s2">def </span><span class="s1">np_real_atan2_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">atan2_float_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy hypot</span>

<span class="s2">def </span><span class="s1">np_real_hypot_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">hypot_float_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy sinh</span>

<span class="s2">def </span><span class="s1">np_real_sinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">sinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_sinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># npymath does not provide a complex sinh. The code in funcs.inc.src</span>
    <span class="s4"># is translated here...</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>


    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">fty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">fsig1 </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">fty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">sxi </span><span class="s3">= </span><span class="s1">np_real_sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xi</span><span class="s3">])</span>
    <span class="s1">shxr </span><span class="s3">= </span><span class="s1">np_real_sinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xr</span><span class="s3">])</span>
    <span class="s1">cxi </span><span class="s3">= </span><span class="s1">np_real_cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xi</span><span class="s3">])</span>
    <span class="s1">chxr </span><span class="s3">= </span><span class="s1">np_real_cosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xr</span><span class="s3">])</span>

    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">cxi</span><span class="s3">, </span><span class="s1">shxr</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">sxi</span><span class="s3">, </span><span class="s1">chxr</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy cosh</span>

<span class="s2">def </span><span class="s1">np_real_cosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">cosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_cosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># npymath does not provide a complex cosh. The code in funcs.inc.src</span>
    <span class="s4"># is translated here...</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">fty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">fsig1 </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">fty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">cxi </span><span class="s3">= </span><span class="s1">np_real_cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xi</span><span class="s3">])</span>
    <span class="s1">chxr </span><span class="s3">= </span><span class="s1">np_real_cosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xr</span><span class="s3">])</span>
    <span class="s1">sxi </span><span class="s3">= </span><span class="s1">np_real_sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xi</span><span class="s3">])</span>
    <span class="s1">shxr </span><span class="s3">= </span><span class="s1">np_real_sinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xr</span><span class="s3">])</span>

    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">cxi</span><span class="s3">, </span><span class="s1">chxr</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">sxi</span><span class="s3">, </span><span class="s1">shxr</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy tanh</span>

<span class="s2">def </span><span class="s1">np_real_tanh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">tanh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_tanh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># npymath does not provide complex tan functions. The code</span>
    <span class="s4"># in funcs.inc.src for tanh is translated here...</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">fty </span><span class="s3">= </span><span class="s1">ty</span><span class="s3">.</span><span class="s1">underlying_float</span>
    <span class="s1">fsig1 </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">fty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">fty</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>

    <span class="s1">xr </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">si </span><span class="s3">= </span><span class="s1">np_real_sin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xi</span><span class="s3">])</span>
    <span class="s1">ci </span><span class="s3">= </span><span class="s1">np_real_cos_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xi</span><span class="s3">])</span>
    <span class="s1">shr </span><span class="s3">= </span><span class="s1">np_real_sinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xr</span><span class="s3">])</span>
    <span class="s1">chr_ </span><span class="s3">= </span><span class="s1">np_real_cosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">fsig1</span><span class="s3">, [</span><span class="s1">xr</span><span class="s3">])</span>
    <span class="s1">rs </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">, </span><span class="s1">shr</span><span class="s3">)</span>
    <span class="s1">is_ </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">si</span><span class="s3">, </span><span class="s1">chr_</span><span class="s3">)</span>
    <span class="s1">rc </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">, </span><span class="s1">chr_</span><span class="s3">)</span>
    <span class="s1">ic </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">si</span><span class="s3">, </span><span class="s1">shr</span><span class="s3">) </span><span class="s4"># note: opposite sign from code in funcs.inc.src</span>
    <span class="s1">sqr_rc </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">rc</span><span class="s3">, </span><span class="s1">rc</span><span class="s3">)</span>
    <span class="s1">sqr_ic </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">ic</span><span class="s3">, </span><span class="s1">ic</span><span class="s3">)</span>
    <span class="s1">d </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">sqr_rc</span><span class="s3">, </span><span class="s1">sqr_ic</span><span class="s3">)</span>
    <span class="s1">inv_d </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fdiv</span><span class="s3">(</span><span class="s1">ONE</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
    <span class="s1">rs_rc </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">rs</span><span class="s3">, </span><span class="s1">rc</span><span class="s3">)</span>
    <span class="s1">is_ic </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">is_</span><span class="s3">, </span><span class="s1">ic</span><span class="s3">)</span>
    <span class="s1">is_rc </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">is_</span><span class="s3">, </span><span class="s1">rc</span><span class="s3">)</span>
    <span class="s1">rs_ic </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">rs</span><span class="s3">, </span><span class="s1">ic</span><span class="s3">)</span>
    <span class="s1">numr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fadd</span><span class="s3">(</span><span class="s1">rs_rc</span><span class="s3">, </span><span class="s1">is_ic</span><span class="s3">)</span>
    <span class="s1">numi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s1">is_rc</span><span class="s3">, </span><span class="s1">rs_ic</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">real </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">numr</span><span class="s3">, </span><span class="s1">inv_d</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">.</span><span class="s1">imag </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fmul</span><span class="s3">(</span><span class="s1">numi</span><span class="s3">, </span><span class="s1">inv_d</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">out</span><span class="s3">.</span><span class="s1">_getvalue</span><span class="s3">()</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy asinh</span>

<span class="s2">def </span><span class="s1">np_real_asinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">asinh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy acosh</span>

<span class="s2">def </span><span class="s1">np_real_acosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">acosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_acosh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># npymath does not provide a complex acosh. The code in funcs.inc.src</span>
    <span class="s4"># is translated here...</span>
    <span class="s4"># log(x + sqrt(x+1) * sqrt(x-1))</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">csig2 </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(*[</span><span class="s1">ty</span><span class="s3">]*</span><span class="s5">3</span><span class="s3">)</span>

    <span class="s1">ONE </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant_generic</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s5">1.0 </span><span class="s3">+ </span><span class="s5">0.0j</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

    <span class="s1">x_plus_one </span><span class="s3">= </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">complex_add_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">csig2</span><span class="s3">, [</span><span class="s1">x</span><span class="s3">,</span>
                                                                     <span class="s1">ONE</span><span class="s3">])</span>
    <span class="s1">x_minus_one </span><span class="s3">= </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">complex_sub_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">csig2</span><span class="s3">, [</span><span class="s1">x</span><span class="s3">,</span>
                                                                      <span class="s1">ONE</span><span class="s3">])</span>
    <span class="s1">sqrt_x_plus_one </span><span class="s3">= </span><span class="s1">np_complex_sqrt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, [</span><span class="s1">x_plus_one</span><span class="s3">])</span>
    <span class="s1">sqrt_x_minus_one </span><span class="s3">= </span><span class="s1">np_complex_sqrt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, [</span><span class="s1">x_minus_one</span><span class="s3">])</span>
    <span class="s1">prod_sqrt </span><span class="s3">= </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">complex_mul_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">csig2</span><span class="s3">,</span>
                                          <span class="s3">[</span><span class="s1">sqrt_x_plus_one</span><span class="s3">,</span>
                                           <span class="s1">sqrt_x_minus_one</span><span class="s3">])</span>
    <span class="s1">log_arg </span><span class="s3">= </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">complex_add_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">csig2</span><span class="s3">, [</span><span class="s1">x</span><span class="s3">,</span>
                                                                  <span class="s1">prod_sqrt</span><span class="s3">])</span>

    <span class="s2">return </span><span class="s1">np_complex_log_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, [</span><span class="s1">log_arg</span><span class="s3">])</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy atanh</span>

<span class="s2">def </span><span class="s1">np_real_atanh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">atanh_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy floor</span>

<span class="s2">def </span><span class="s1">np_real_floor_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">call_fp_intrinsic</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s6">'llvm.floor'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy ceil</span>

<span class="s2">def </span><span class="s1">np_real_ceil_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">call_fp_intrinsic</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s6">'llvm.ceil'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy trunc</span>

<span class="s2">def </span><span class="s1">np_real_trunc_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">call_fp_intrinsic</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s6">'llvm.trunc'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy fabs</span>

<span class="s2">def </span><span class="s1">np_real_fabs_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">call_fp_intrinsic</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s6">'llvm.fabs'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy style predicates</span>

<span class="s4"># For real and integer types rely on numbers... but complex ordering in</span>
<span class="s4"># NumPy is lexicographic (while Python does not provide ordering).</span>
<span class="s2">def </span><span class="s1">np_complex_ge_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># equivalent to macro CGE in NumPy's loops.c.src</span>
    <span class="s4"># ((xr &gt; yr &amp;&amp; !npy_isnan(xi) &amp;&amp; !npy_isnan(yi)) || (xr == yr &amp;&amp; xi &gt;= yi))</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">yr </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">yi </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">xr_gt_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">no_nan_xi_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'ord'</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">xr_eq_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">xi_ge_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">first_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_gt_yr</span><span class="s3">, </span><span class="s1">no_nan_xi_yi</span><span class="s3">)</span>
    <span class="s1">second_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_eq_yr</span><span class="s3">, </span><span class="s1">xi_ge_yi</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">first_term</span><span class="s3">, </span><span class="s1">second_term</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_le_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># equivalent to macro CLE in NumPy's loops.c.src</span>
    <span class="s4"># ((xr &lt; yr &amp;&amp; !npy_isnan(xi) &amp;&amp; !npy_isnan(yi)) || (xr == yr &amp;&amp; xi &lt;= yi))</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">yr </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">yi </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">xr_lt_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;'</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">no_nan_xi_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'ord'</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">xr_eq_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">xi_le_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;='</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">first_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_lt_yr</span><span class="s3">, </span><span class="s1">no_nan_xi_yi</span><span class="s3">)</span>
    <span class="s1">second_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_eq_yr</span><span class="s3">, </span><span class="s1">xi_le_yi</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">first_term</span><span class="s3">, </span><span class="s1">second_term</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_gt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># equivalent to macro CGT in NumPy's loops.c.src</span>
    <span class="s4"># ((xr &gt; yr &amp;&amp; !npy_isnan(xi) &amp;&amp; !npy_isnan(yi)) || (xr == yr &amp;&amp; xi &gt; yi))</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">yr </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">yi </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">xr_gt_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">no_nan_xi_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'ord'</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">xr_eq_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">xi_gt_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;'</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">first_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_gt_yr</span><span class="s3">, </span><span class="s1">no_nan_xi_yi</span><span class="s3">)</span>
    <span class="s1">second_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_eq_yr</span><span class="s3">, </span><span class="s1">xi_gt_yi</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">first_term</span><span class="s3">, </span><span class="s1">second_term</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_lt_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># equivalent to macro CLT in NumPy's loops.c.src</span>
    <span class="s4"># ((xr &lt; yr &amp;&amp; !npy_isnan(xi) &amp;&amp; !npy_isnan(yi)) || (xr == yr &amp;&amp; xi &lt; yi))</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">yr </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">yi </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">xr_lt_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;'</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">no_nan_xi_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'ord'</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">xr_eq_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">xi_lt_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;'</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s1">first_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_lt_yr</span><span class="s3">, </span><span class="s1">no_nan_xi_yi</span><span class="s3">)</span>
    <span class="s1">second_term </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_eq_yr</span><span class="s3">, </span><span class="s1">xi_lt_yi</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">first_term</span><span class="s3">, </span><span class="s1">second_term</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_eq_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># equivalent to macro CEQ in NumPy's loops.c.src</span>
    <span class="s4"># (xr == yr &amp;&amp; xi == yi)</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">yr </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">yi </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">xr_eq_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">xi_eq_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">xr_eq_yr</span><span class="s3">, </span><span class="s1">xi_eq_yi</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_ne_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># equivalent to macro CNE in NumPy's loops.c.src</span>
    <span class="s4"># (xr != yr || xi != yi)</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>

    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">in1</span><span class="s3">, </span><span class="s1">in2 </span><span class="s3">= [</span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
    <span class="s1">xr </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">xi </span><span class="s3">= </span><span class="s1">in1</span><span class="s3">.</span><span class="s1">imag</span>
    <span class="s1">yr </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">real</span>
    <span class="s1">yi </span><span class="s3">= </span><span class="s1">in2</span><span class="s3">.</span><span class="s1">imag</span>

    <span class="s1">xr_ne_yr </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">xr</span><span class="s3">, </span><span class="s1">yr</span><span class="s3">)</span>
    <span class="s1">xi_ne_yi </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">xr_ne_yr</span><span class="s3">, </span><span class="s1">xi_ne_yi</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy logical algebra</span>

<span class="s4"># these are made generic for all types for now, assuming that</span>
<span class="s4"># cgutils.is_true works in the underlying types.</span>

<span class="s2">def </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">val</span><span class="s3">):</span>
    <span class="s1">complex_val </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">val</span><span class="s3">)</span>
    <span class="s1">re_true </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">complex_val</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
    <span class="s1">im_true </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">complex_val</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">re_true</span><span class="s3">, </span><span class="s1">im_true</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_logical_and_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_logical_and_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_logical_or_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_logical_or_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_logical_xor_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_true</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">xor</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_logical_xor_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">xor</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_logical_not_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">is_false</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_complex_logical_not_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">_complex_is_true</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">not_</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>

<span class="s4">########################################################################</span>
<span class="s4"># NumPy style max/min</span>
<span class="s4">#</span>
<span class="s4"># There are 2 different sets of functions to perform max and min in</span>
<span class="s4"># NumPy: maximum/minimum and fmax/fmin.</span>
<span class="s4"># Both differ in the way NaNs are handled, so the actual differences</span>
<span class="s4"># come in action only on float/complex numbers. The functions used for</span>
<span class="s4"># integers is shared. For booleans maximum is equivalent to or, and</span>
<span class="s4"># minimum is equivalent to and. Datetime support will go elsewhere.</span>

<span class="s2">def </span><span class="s1">np_int_smax_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_sge_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_sge_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_int_umax_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_uge_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_uge_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_maximum_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># maximum prefers nan (tries to return a nan).</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">)</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s1">arg1_ge_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_ge_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_fmax_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># fmax prefers non-nan (tries to return a non-nan).</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg2_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg2_nan</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s1">arg1_ge_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&gt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_ge_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_maximum_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># maximum prefers nan (tries to return a nan).</span>
    <span class="s4"># There is an extra caveat with complex numbers, as there is more</span>
    <span class="s4"># than one type of nan. NumPy's docs state that the nan in the</span>
    <span class="s4"># first argument is returned when both arguments are nans.</span>
    <span class="s4"># If only one nan is found, that nan is returned.</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">bc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">bcc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, *[</span><span class="s1">ty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg1</span><span class="s3">])</span>
    <span class="s1">arg2_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg2</span><span class="s3">])</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg2_nan</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s1">arg1_ge_arg2 </span><span class="s3">= </span><span class="s1">np_complex_ge_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bcc_sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_ge_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_fmax_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># fmax prefers non-nan (tries to return a non-nan).</span>
    <span class="s4"># There is an extra caveat with complex numbers, as there is more</span>
    <span class="s4"># than one type of nan. NumPy's docs state that the nan in the</span>
    <span class="s4"># first argument is returned when both arguments are nans.</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">bc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">bcc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, *[</span><span class="s1">ty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg1</span><span class="s3">])</span>
    <span class="s1">arg2_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg2</span><span class="s3">])</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg2_nan</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg2_nan</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s1">arg1_ge_arg2 </span><span class="s3">= </span><span class="s1">np_complex_ge_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bcc_sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_ge_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_int_smin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_sle_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'&lt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_sle_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_int_umin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_ule_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'&lt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_ule_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_minimum_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># minimum prefers nan (tries to return a nan).</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">)</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s1">arg1_le_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_le_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_fmin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># fmin prefers non-nan (tries to return a non-nan).</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">)</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_unordered</span><span class="s3">(</span><span class="s6">'uno'</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">)</span>

    <span class="s1">arg1_le_arg2 </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fcmp_ordered</span><span class="s3">(</span><span class="s6">'&lt;='</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_le_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_minimum_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># minimum prefers nan (tries to return a nan).</span>
    <span class="s4"># There is an extra caveat with complex numbers, as there is more</span>
    <span class="s4"># than one type of nan. NumPy's docs state that the nan in the</span>
    <span class="s4"># first argument is returned when both arguments are nans.</span>
    <span class="s4"># If only one nan is found, that nan is returned.</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">bc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">bcc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, *[</span><span class="s1">ty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg1</span><span class="s3">])</span>
    <span class="s1">arg2_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg2</span><span class="s3">])</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg2_nan</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s1">arg1_le_arg2 </span><span class="s3">= </span><span class="s1">np_complex_le_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bcc_sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_le_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_complex_fmin_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># fmin prefers non-nan (tries to return a non-nan).</span>
    <span class="s4"># There is an extra caveat with complex numbers, as there is more</span>
    <span class="s4"># than one type of nan. NumPy's docs state that the nan in the</span>
    <span class="s4"># first argument is returned when both arguments are nans.</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">bc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">bcc_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">, *[</span><span class="s1">ty</span><span class="s3">]*</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">arg1_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg1</span><span class="s3">])</span>
    <span class="s1">arg2_nan </span><span class="s3">= </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bc_sig</span><span class="s3">, [</span><span class="s1">arg2</span><span class="s3">])</span>
    <span class="s1">any_nan </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">or_</span><span class="s3">(</span><span class="s1">arg1_nan</span><span class="s3">, </span><span class="s1">arg2_nan</span><span class="s3">)</span>
    <span class="s1">nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg2_nan</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s1">arg1_le_arg2 </span><span class="s3">= </span><span class="s1">np_complex_le_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">bcc_sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
    <span class="s1">non_nan_result </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">arg1_le_arg2</span><span class="s3">, </span><span class="s1">arg1</span><span class="s3">, </span><span class="s1">arg2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">select</span><span class="s3">(</span><span class="s1">any_nan</span><span class="s3">, </span><span class="s1">nan_result</span><span class="s3">, </span><span class="s1">non_nan_result</span><span class="s3">)</span>


<span class="s4">########################################################################</span>
<span class="s4"># NumPy floating point misc</span>

<span class="s2">def </span><span class="s1">np_int_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span>


<span class="s2">def </span><span class="s1">np_real_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">is_nan</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_complex_isnan_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>

    <span class="s1">x</span><span class="s3">, = </span><span class="s1">args</span>
    <span class="s1">ty</span><span class="s3">, = </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span>
    <span class="s1">complex_val </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">is_nan</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">complex_val</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_int_isfinite_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">true_bit</span>


<span class="s2">def </span><span class="s1">np_datetime_isfinite_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">npdatetime</span><span class="s3">.</span><span class="s1">NAT</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_datetime_isnat_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_signed</span><span class="s3">(</span><span class="s6">'=='</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">npdatetime</span><span class="s3">.</span><span class="s1">NAT</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_isfinite_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">is_finite</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_complex_isfinite_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">, = </span><span class="s1">args</span>
    <span class="s1">ty</span><span class="s3">, = </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span>
    <span class="s1">complex_val </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">is_finite</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">complex_val</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_int_isinf_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">false_bit</span>


<span class="s2">def </span><span class="s1">np_real_isinf_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">is_inf</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_complex_isinf_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">, = </span><span class="s1">args</span>
    <span class="s1">ty</span><span class="s3">, = </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span>
    <span class="s1">complex_val </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">make_complex</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">cmathimpl</span><span class="s3">.</span><span class="s1">is_inf</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">complex_val</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">np_real_signbit_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">return_type</span><span class="s3">=</span><span class="s1">types</span><span class="s3">.</span><span class="s1">boolean</span><span class="s3">)</span>
    <span class="s4"># there's no signbit intrinsic in LLVM, so just bitcast as int, mask the</span>
    <span class="s4"># signbit and cmp against 0.</span>
    <span class="s1">masks </span><span class="s3">= {</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">: </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">uint16</span><span class="s3">, </span><span class="s5">0x8000</span><span class="s3">),</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">: </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">uint32</span><span class="s3">, </span><span class="s5">0x80000000</span><span class="s3">),</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">: </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_constant</span><span class="s3">(</span><span class="s1">types</span><span class="s3">.</span><span class="s1">uint64</span><span class="s3">, </span><span class="s5">0x8000000000000000</span><span class="s3">),</span>
    <span class="s3">}</span>
    <span class="s1">arg_ty </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">arg_int_ty </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">types</span><span class="s3">, </span><span class="s6">f'uint</span><span class="s2">{</span><span class="s1">arg_ty</span><span class="s3">.</span><span class="s1">bitwidth</span><span class="s2">}</span><span class="s6">'</span><span class="s3">)</span>
    <span class="s1">arg_ll_int_ty </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">get_value_type</span><span class="s3">(</span><span class="s1">arg_int_ty</span><span class="s3">)</span>
    <span class="s1">int_res </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">and_</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">bitcast</span><span class="s3">(</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">arg_ll_int_ty</span><span class="s3">),</span>
                           <span class="s1">masks</span><span class="s3">[</span><span class="s1">arg_ty</span><span class="s3">])</span>
    <span class="s1">bool_res </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">icmp_unsigned</span><span class="s3">(</span><span class="s6">'!='</span><span class="s3">, </span><span class="s1">int_res</span><span class="s3">, </span><span class="s1">int_res</span><span class="s3">.</span><span class="s1">type</span><span class="s3">(</span><span class="s5">0</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">bool_res</span>


<span class="s2">def </span><span class="s1">np_real_copysign_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">copysign_float_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">np_real_nextafter_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">dispatch_table </span><span class="s3">= {</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">: </span><span class="s6">'numba_nextafterf'</span><span class="s3">,</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">: </span><span class="s6">'numba_nextafter'</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s2">return </span><span class="s1">_dispatch_func_by_name_type</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">,</span>
                                       <span class="s1">dispatch_table</span><span class="s3">, </span><span class="s6">'nextafter'</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">np_real_spacing_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># This is different to how NumPy does it, NumPy has a specialisation of</span>
    <span class="s4"># nextafter called _next, which is used. See:</span>
    <span class="s4"># https://github.com/numpy/numpy/blob/12c2b7dd62fc0c14b81c8892ed5f4f59cc94d09c/numpy/core/src/npymath/ieee754.c.src#L32-L38</span>
    <span class="s4"># Numba elects to use `nextafter` for a similar behaviour to save</span>
    <span class="s4"># translating this very involved function. Further, the NumPy comments note</span>
    <span class="s4"># that there is a lot of redundancy present between the two.</span>
    <span class="s1">_check_arity_and_homogeneity</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">dispatch_table </span><span class="s3">= {</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">: </span><span class="s6">'numba_nextafterf'</span><span class="s3">,</span>
        <span class="s1">types</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">: </span><span class="s6">'numba_nextafter'</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s3">[</span><span class="s1">ty</span><span class="s3">] = </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span>
    <span class="s1">inner_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">sig</span><span class="s3">.</span><span class="s1">return_type</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">, </span><span class="s1">ty</span><span class="s3">)</span>
    <span class="s1">ll_ty </span><span class="s3">= </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">type</span>
    <span class="s1">ll_inf </span><span class="s3">= </span><span class="s1">ll_ty</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
    <span class="s1">fnty </span><span class="s3">= </span><span class="s1">llvmlite</span><span class="s3">.</span><span class="s1">ir</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">(</span><span class="s1">ll_ty</span><span class="s3">, [</span><span class="s1">ll_ty</span><span class="s3">, </span><span class="s1">ll_ty</span><span class="s3">])</span>
    <span class="s1">fn </span><span class="s3">= </span><span class="s1">cgutils</span><span class="s3">.</span><span class="s1">insert_pure_function</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">module</span><span class="s3">, </span><span class="s1">fnty</span><span class="s3">,</span>
                                      <span class="s1">name</span><span class="s3">=</span><span class="s6">'llvm.copysign'</span><span class="s3">)</span>
    <span class="s1">ll_sinf </span><span class="s3">= </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, [</span><span class="s1">ll_inf</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]])</span>
    <span class="s1">inner_args </span><span class="s3">= </span><span class="s1">args </span><span class="s3">+ [</span><span class="s1">ll_sinf</span><span class="s3">,]</span>
    <span class="s1">nextafter </span><span class="s3">= </span><span class="s1">_dispatch_func_by_name_type</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">inner_sig</span><span class="s3">,</span>
                                            <span class="s1">inner_args</span><span class="s3">, </span><span class="s1">dispatch_table</span><span class="s3">,</span>
                                            <span class="s6">'nextafter'</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">builder</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s1">nextafter</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">np_real_ldexp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s4"># this one is slightly different to other ufuncs.</span>
    <span class="s4"># arguments are not homogeneous and second arg may come as</span>
    <span class="s4"># an 'i' or an 'l'.</span>

    <span class="s4"># the function expects the second argument to be have a C int type</span>
    <span class="s1">x1</span><span class="s3">, </span><span class="s1">x2 </span><span class="s3">= </span><span class="s1">args</span>
    <span class="s1">ty1</span><span class="s3">, </span><span class="s1">ty2 </span><span class="s3">= </span><span class="s1">sig</span><span class="s3">.</span><span class="s1">args</span>
    <span class="s4"># note that types.intc should be equivalent to int_ that is</span>
    <span class="s4"># 'NumPy's default int')</span>
    <span class="s1">x2 </span><span class="s3">= </span><span class="s1">context</span><span class="s3">.</span><span class="s1">cast</span><span class="s3">(</span><span class="s1">builder</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">ty2</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">intc</span><span class="s3">)</span>
    <span class="s1">f_fi_sig </span><span class="s3">= </span><span class="s1">typing</span><span class="s3">.</span><span class="s1">signature</span><span class="s3">(</span><span class="s1">ty1</span><span class="s3">, </span><span class="s1">ty1</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">intc</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mathimpl</span><span class="s3">.</span><span class="s1">ldexp_impl</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">builder</span><span class="s3">, </span><span class="s1">f_fi_sig</span><span class="s3">, (</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">))</span>
</pre>
</body>
</html>