<html>
<head>
<title>colorpicker.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
colorpicker.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
Color Picker 
============ 
 
.. versionadded:: 1.7.0 
 
.. warning:: 
 
    This widget is experimental. Its use and API can change at any time until 
    this warning is removed. 
 
.. image:: images/colorpicker.png 
    :align: right 
 
The ColorPicker widget allows a user to select a color from a chromatic 
wheel where pinch and zoom can be used to change the wheel's saturation. 
Sliders and TextInputs are also provided for entering the RGBA/HSV/HEX values 
directly. 
 
Usage:: 
 
    clr_picker = ColorPicker() 
    parent.add_widget(clr_picker) 
 
    # To monitor changes, we can bind to color property changes 
    def on_color(instance, value): 
        print(&quot;RGBA = &quot;, str(value))  #  or instance.color 
        print(&quot;HSV = &quot;, str(instance.hsv)) 
        print(&quot;HEX = &quot;, str(instance.hex_color)) 
 
    clr_picker.bind(color=on_color) 
 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'ColorPicker'</span><span class="s2">, </span><span class="s3">'ColorWheel'</span><span class="s2">)</span>

<span class="s4">from </span><span class="s1">math </span><span class="s4">import </span><span class="s1">cos</span><span class="s2">, </span><span class="s1">sin</span><span class="s2">, </span><span class="s1">pi</span><span class="s2">, </span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">atan</span>
<span class="s4">from </span><span class="s1">colorsys </span><span class="s4">import </span><span class="s1">rgb_to_hsv</span><span class="s2">, </span><span class="s1">hsv_to_rgb</span>

<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">clock </span><span class="s4">import </span><span class="s1">Clock</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">graphics </span><span class="s4">import </span><span class="s1">Mesh</span><span class="s2">, </span><span class="s1">InstructionGroup</span><span class="s2">, </span><span class="s1">Color</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">logger </span><span class="s4">import </span><span class="s1">Logger</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s2">(</span><span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">BoundedNumericProperty</span><span class="s2">,</span>
                             <span class="s1">ListProperty</span><span class="s2">, </span><span class="s1">ObjectProperty</span><span class="s2">,</span>
                             <span class="s1">ReferenceListProperty</span><span class="s2">, </span><span class="s1">StringProperty</span><span class="s2">,</span>
                             <span class="s1">AliasProperty</span><span class="s2">)</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">relativelayout </span><span class="s4">import </span><span class="s1">RelativeLayout</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">widget </span><span class="s4">import </span><span class="s1">Widget</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">utils </span><span class="s4">import </span><span class="s1">get_color_from_hex</span><span class="s2">, </span><span class="s1">get_hex_from_color</span>


<span class="s4">def </span><span class="s1">distance</span><span class="s2">(</span><span class="s1">pt1</span><span class="s2">, </span><span class="s1">pt2</span><span class="s2">):</span>
    <span class="s4">return </span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">pt1</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] - </span><span class="s1">pt2</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]) ** </span><span class="s5">2. </span><span class="s2">+ (</span><span class="s1">pt1</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] - </span><span class="s1">pt2</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]) ** </span><span class="s5">2.</span><span class="s2">)</span>


<span class="s4">def </span><span class="s1">polar_to_rect</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">theta</span><span class="s2">):</span>
    <span class="s4">return </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] + </span><span class="s1">r </span><span class="s2">* </span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] + </span><span class="s1">r </span><span class="s2">* </span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)</span>


<span class="s4">def </span><span class="s1">rect_to_polar</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s4">if </span><span class="s1">x </span><span class="s2">== </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]:</span>
        <span class="s4">if </span><span class="s1">y </span><span class="s2">== </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]:</span>
            <span class="s4">return </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span>
        <span class="s4">elif </span><span class="s1">y </span><span class="s2">&gt; </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]:</span>
            <span class="s4">return </span><span class="s1">y </span><span class="s2">- </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">pi </span><span class="s2">/ </span><span class="s5">2</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] - </span><span class="s1">y</span><span class="s2">, </span><span class="s5">3 </span><span class="s2">* </span><span class="s1">pi </span><span class="s2">/ </span><span class="s5">2</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">atan</span><span class="s2">(</span><span class="s1">float</span><span class="s2">((</span><span class="s1">y </span><span class="s2">- </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])) / (</span><span class="s1">x </span><span class="s2">- </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]))</span>
    <span class="s4">if </span><span class="s1">x </span><span class="s2">- </span><span class="s1">origin</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] &lt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">t </span><span class="s2">+= </span><span class="s1">pi</span>

    <span class="s4">if </span><span class="s1">t </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">t </span><span class="s2">+= </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">pi</span>

    <span class="s4">return </span><span class="s1">distance</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">), </span><span class="s1">t</span>


<span class="s4">class </span><span class="s1">ColorWheel</span><span class="s2">(</span><span class="s1">Widget</span><span class="s2">):</span>
    <span class="s0">'''Chromatic wheel for the ColorPicker. 
 
    .. versionchanged:: 1.7.1 
        `font_size`, `font_name` and `foreground_color` have been removed. The 
        sizing is now the same as others widget, based on 'sp'. Orientation is 
        also automatically determined according to the width/height ratio. 
 
    '''</span>

    <span class="s1">r </span><span class="s2">= </span><span class="s1">BoundedNumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s3">'''The Red value of the color currently selected. 
 
    :attr:`r` is a :class:`~kivy.properties.BoundedNumericProperty` and 
    can be a value from 0 to 1. It defaults to 0. 
    '''</span>

    <span class="s1">g </span><span class="s2">= </span><span class="s1">BoundedNumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s3">'''The Green value of the color currently selected. 
 
    :attr:`g` is a :class:`~kivy.properties.BoundedNumericProperty` 
    and can be a value from 0 to 1. It defaults to 0. 
    '''</span>

    <span class="s1">b </span><span class="s2">= </span><span class="s1">BoundedNumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s3">'''The Blue value of the color currently selected. 
 
    :attr:`b` is a :class:`~kivy.properties.BoundedNumericProperty` and 
    can be a value from 0 to 1. It defaults to 0. 
    '''</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">BoundedNumericProperty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">min</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s3">'''The Alpha value of the color currently selected. 
 
    :attr:`a` is a :class:`~kivy.properties.BoundedNumericProperty` and 
    can be a value from 0 to 1. It defaults to 0. 
    '''</span>

    <span class="s1">color </span><span class="s2">= </span><span class="s1">ReferenceListProperty</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">g</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s3">'''The holds the color currently selected. 
 
    :attr:`color` is a :class:`~kivy.properties.ReferenceListProperty` and 
    contains a list of `r`, `g`, `b`, `a` values. It defaults to `[0, 0, 0, 0]`. 
    '''</span>

    <span class="s1">_origin </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">((</span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">))</span>
    <span class="s1">_radius </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">100</span><span class="s2">)</span>

    <span class="s1">_piece_divisions </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">_pieces_of_pie </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">16</span><span class="s2">)</span>

    <span class="s1">_inertia_slowdown </span><span class="s2">= </span><span class="s5">1.25</span>
    <span class="s1">_inertia_cutoff </span><span class="s2">= </span><span class="s5">.25</span>

    <span class="s1">_num_touches </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">_pinch_flag </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arcs </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s1">pdv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_piece_divisions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_s </span><span class="s2">= [(</span><span class="s1">float</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) / </span><span class="s1">pdv</span><span class="s2">, </span><span class="s5">1</span><span class="s2">) </span><span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">pdv</span><span class="s2">)] + [</span>
            <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s1">y</span><span class="s2">) / </span><span class="s1">pdv</span><span class="s2">) </span><span class="s4">for </span><span class="s1">y </span><span class="s4">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">pdv</span><span class="s2">))]</span>

        <span class="s1">super</span><span class="s2">(</span><span class="s1">ColorWheel</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on__origin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_instance</span><span class="s2">, </span><span class="s1">_value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_reset_canvas</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on__radius</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_instance</span><span class="s2">, </span><span class="s1">_value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_reset_canvas</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_reset_canvas</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># initialize list to hold all meshes</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arcs </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">pdv </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_piece_divisions</span>
        <span class="s1">ppie </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pieces_of_pie</span>

        <span class="s4">for </span><span class="s1">r </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">pdv</span><span class="s2">):</span>
            <span class="s4">for </span><span class="s1">t </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ppie</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">arcs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                    <span class="s1">_ColorArc</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_radius </span><span class="s2">* (</span><span class="s1">float</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">pdv</span><span class="s2">)),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_radius </span><span class="s2">* (</span><span class="s1">float</span><span class="s2">(</span><span class="s1">r </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">pdv</span><span class="s2">)),</span>
                        <span class="s5">2 </span><span class="s2">* </span><span class="s1">pi </span><span class="s2">* (</span><span class="s1">float</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">ppie</span><span class="s2">)),</span>
                        <span class="s5">2 </span><span class="s2">* </span><span class="s1">pi </span><span class="s2">* (</span><span class="s1">float</span><span class="s2">(</span><span class="s1">t </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / </span><span class="s1">float</span><span class="s2">(</span><span class="s1">ppie</span><span class="s2">)),</span>
                        <span class="s1">origin</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_origin</span><span class="s2">,</span>
                        <span class="s1">color</span><span class="s2">=(</span><span class="s1">float</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) / </span><span class="s1">ppie</span><span class="s2">,</span>
                               <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_s</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">+ </span><span class="s1">r</span><span class="s2">][</span><span class="s5">0</span><span class="s2">],</span>
                               <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_s</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">+ </span><span class="s1">r</span><span class="s2">][</span><span class="s5">1</span><span class="s2">],</span>
                               <span class="s5">1</span><span class="s2">)))</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arcs</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">])</span>

    <span class="s4">def </span><span class="s1">recolor_wheel</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ppie </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pieces_of_pie</span>
        <span class="s4">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">segment </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arcs</span><span class="s2">):</span>
            <span class="s1">segment</span><span class="s2">.</span><span class="s1">change_color</span><span class="s2">(</span>
                <span class="s1">sv</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_s</span><span class="s2">[</span><span class="s1">int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">+ </span><span class="s1">idx </span><span class="s2">/ </span><span class="s1">ppie</span><span class="s2">)])</span>

    <span class="s4">def </span><span class="s1">change_alpha</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">segment </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arcs</span><span class="s2">):</span>
            <span class="s1">segment</span><span class="s2">.</span><span class="s1">change_color</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=</span><span class="s1">val</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">inertial_incr_sv_idx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s6"># if its already zoomed all the way out, cancel the inertial zoom</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_s</span><span class="s2">) - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_piece_divisions</span><span class="s2">:</span>
            <span class="s4">return False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">recolor_wheel</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">dt </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_inertia_slowdown </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_inertia_cutoff</span><span class="s2">:</span>
            <span class="s4">return False</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">inertial_incr_sv_idx</span><span class="s2">,</span>
                                <span class="s1">dt </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_inertia_slowdown</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">inertial_decr_sv_idx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s6"># if its already zoomed all the way in, cancel the inertial zoom</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">-= </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">recolor_wheel</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">dt </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_inertia_slowdown </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_inertia_cutoff</span><span class="s2">:</span>
            <span class="s4">return False</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">inertial_decr_sv_idx</span><span class="s2">,</span>
                                <span class="s1">dt </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_inertia_slowdown</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_touch_r</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">r </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_radius</span><span class="s2">:</span>
            <span class="s4">return False</span>

        <span class="s6"># code is still set up to allow pinch to zoom, but this is</span>
        <span class="s6"># disabled for now since it was fiddly with small wheels.</span>
        <span class="s6"># Comment out these lines and  adjust on_touch_move to reenable</span>
        <span class="s6"># this.</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_num_touches </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">return False</span>

        <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_num_touches </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'anchor_r'</span><span class="s2">] = </span><span class="s1">r</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_sv_idx'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_time'</span><span class="s2">] = </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">get_time</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_touch_r</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">)</span>
        <span class="s1">goal_sv_idx </span><span class="s2">= (</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_sv_idx'</span><span class="s2">] -</span>
                       <span class="s1">int</span><span class="s2">((</span><span class="s1">r </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'anchor_r'</span><span class="s2">]) /</span>
                            <span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_radius</span><span class="s2">) / </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_piece_divisions</span><span class="s2">)))</span>

        <span class="s4">if </span><span class="s2">(</span>
                <span class="s1">goal_sv_idx </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s4">and</span>
                <span class="s5">0 </span><span class="s2">&lt;= </span><span class="s1">goal_sv_idx </span><span class="s2">&lt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_s</span><span class="s2">) - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_piece_divisions</span>
        <span class="s2">):</span>
            <span class="s6"># this is a pinch to zoom</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_pinch_flag </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">= </span><span class="s1">goal_sv_idx</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">recolor_wheel</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ungrab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_num_touches </span><span class="s2">-= </span><span class="s5">1</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pinch_flag</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_num_touches </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s6"># user was pinching, and now both fingers are up. Return</span>
                <span class="s6"># to normal</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">&gt; </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_sv_idx'</span><span class="s2">]:</span>
                    <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">inertial_incr_sv_idx</span><span class="s2">,</span>
                        <span class="s2">(</span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">get_time</span><span class="s2">() - </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_time'</span><span class="s2">]) /</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_sv_idx'</span><span class="s2">]))</span>

                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">&lt; </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_sv_idx'</span><span class="s2">]:</span>
                    <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">inertial_decr_sv_idx</span><span class="s2">,</span>
                        <span class="s2">(</span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">get_time</span><span class="s2">() - </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_time'</span><span class="s2">]) /</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sv_idx </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'orig_sv_idx'</span><span class="s2">]))</span>

                <span class="s1">self</span><span class="s2">.</span><span class="s1">_pinch_flag </span><span class="s2">= </span><span class="s4">False</span>
                <span class="s4">return</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s6"># user was pinching, and at least one finger remains. We</span>
                <span class="s6"># don't want to treat the remaining fingers as touches</span>
                <span class="s4">return</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">theta </span><span class="s2">= </span><span class="s1">rect_to_polar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_origin</span><span class="s2">, *</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">)</span>
            <span class="s6"># if touch up is outside the wheel, ignore</span>
            <span class="s4">if </span><span class="s1">r </span><span class="s2">&gt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_radius</span><span class="s2">:</span>
                <span class="s4">return</span>
            <span class="s6"># compute which ColorArc is being touched (they aren't</span>
            <span class="s6"># widgets so we don't get collide_point) and set</span>
            <span class="s6"># _hsv based on the selected ColorArc</span>
            <span class="s1">piece </span><span class="s2">= </span><span class="s1">int</span><span class="s2">((</span><span class="s1">theta </span><span class="s2">/ (</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">pi</span><span class="s2">)) * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pieces_of_pie</span><span class="s2">)</span>
            <span class="s1">division </span><span class="s2">= </span><span class="s1">int</span><span class="s2">((</span><span class="s1">r </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_radius</span><span class="s2">) * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_piece_divisions</span><span class="s2">)</span>
            <span class="s1">hsva </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">arcs</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pieces_of_pie </span><span class="s2">* </span><span class="s1">division </span><span class="s2">+ </span><span class="s1">piece</span><span class="s2">].</span><span class="s1">color</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">hsv_to_rgb</span><span class="s2">(*</span><span class="s1">hsva</span><span class="s2">[:</span><span class="s5">3</span><span class="s2">])) + </span><span class="s1">hsva</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">:]</span>

    <span class="s4">def </span><span class="s1">_get_touch_r</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">distance</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_origin</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">_ColorArc</span><span class="s2">(</span><span class="s1">InstructionGroup</span><span class="s2">):</span>
    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">r_min</span><span class="s2">, </span><span class="s1">r_max</span><span class="s2">, </span><span class="s1">theta_min</span><span class="s2">, </span><span class="s1">theta_max</span><span class="s2">,</span>
                 <span class="s1">color</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">origin</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_ColorArc</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">origin </span><span class="s2">= </span><span class="s1">origin</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">r_min </span><span class="s2">= </span><span class="s1">r_min</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">r_max </span><span class="s2">= </span><span class="s1">r_max</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min </span><span class="s2">= </span><span class="s1">theta_min</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">theta_max </span><span class="s2">= </span><span class="s1">theta_max</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">color_instr </span><span class="s2">= </span><span class="s1">Color</span><span class="s2">(*</span><span class="s1">color</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'hsv'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color_instr</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mesh </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_mesh</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mesh</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">&quot;r_min: %s r_max: %s theta_min: %s theta_max: %s color: %s&quot; </span><span class="s2">% (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">r_min</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">r_max</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">theta_max</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span>
        <span class="s2">)</span>

    <span class="s4">def </span><span class="s1">get_mesh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">v </span><span class="s2">= []</span>
        <span class="s6"># first calculate the distance between endpoints of the outer</span>
        <span class="s6"># arc, so we know how many steps to use when calculating</span>
        <span class="s6"># vertices</span>
        <span class="s1">theta_step_outer </span><span class="s2">= </span><span class="s5">0.1</span>
        <span class="s1">theta </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">theta_max </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min</span>
        <span class="s1">d_outer </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">theta </span><span class="s2">/ </span><span class="s1">theta_step_outer</span><span class="s2">)</span>
        <span class="s1">theta_step_outer </span><span class="s2">= </span><span class="s1">theta </span><span class="s2">/ </span><span class="s1">d_outer</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">r_min </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">d_outer</span><span class="s2">, </span><span class="s5">2</span><span class="s2">):</span>
                <span class="s1">v </span><span class="s2">+= (</span><span class="s1">polar_to_rect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">r_max</span><span class="s2">,</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min </span><span class="s2">+ </span><span class="s1">x </span><span class="s2">* </span><span class="s1">theta_step_outer</span>
                                    <span class="s2">) * </span><span class="s5">2</span><span class="s2">)</span>
                <span class="s1">v </span><span class="s2">+= </span><span class="s1">polar_to_rect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">) * </span><span class="s5">2</span>
                <span class="s1">v </span><span class="s2">+= (</span><span class="s1">polar_to_rect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">r_max</span><span class="s2">,</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min </span><span class="s2">+ (</span><span class="s1">x </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) * </span><span class="s1">theta_step_outer</span>
                                    <span class="s2">) * </span><span class="s5">2</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">d_outer </span><span class="s2">&amp; </span><span class="s5">1</span><span class="s2">:  </span><span class="s6"># add a last point if d_outer is even</span>
                <span class="s1">v </span><span class="s2">+= (</span><span class="s1">polar_to_rect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">r_max</span><span class="s2">,</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min </span><span class="s2">+ </span><span class="s1">d_outer </span><span class="s2">* </span><span class="s1">theta_step_outer</span>
                                    <span class="s2">) * </span><span class="s5">2</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">d_outer </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
                <span class="s1">v </span><span class="s2">+= (</span><span class="s1">polar_to_rect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">r_min</span><span class="s2">,</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min </span><span class="s2">+ </span><span class="s1">x </span><span class="s2">* </span><span class="s1">theta_step_outer</span>
                                    <span class="s2">) * </span><span class="s5">2</span><span class="s2">)</span>
                <span class="s1">v </span><span class="s2">+= (</span><span class="s1">polar_to_rect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">r_max</span><span class="s2">,</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">theta_min </span><span class="s2">+ </span><span class="s1">x </span><span class="s2">* </span><span class="s1">theta_step_outer</span>
                                    <span class="s2">) * </span><span class="s5">2</span><span class="s2">)</span>

        <span class="s4">return </span><span class="s1">Mesh</span><span class="s2">(</span><span class="s1">vertices</span><span class="s2">=</span><span class="s1">v</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) / </span><span class="s5">4</span><span class="s2">)),</span>
                    <span class="s1">mode</span><span class="s2">=</span><span class="s3">'triangle_strip'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">change_color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">color_delta</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">sv</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">a</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color_instr</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">color </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span>
        <span class="s4">elif </span><span class="s1">color_delta </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] + </span><span class="s1">color_delta</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] </span><span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)]</span>
        <span class="s4">elif </span><span class="s1">sv </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">sv</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">sv</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[</span><span class="s5">3</span><span class="s2">])</span>
        <span class="s4">elif </span><span class="s1">a </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">color_instr </span><span class="s2">= </span><span class="s1">Color</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'hsv'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">color_instr</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">ColorPicker</span><span class="s2">(</span><span class="s1">RelativeLayout</span><span class="s2">):</span>
    <span class="s0">''' 
    See module documentation. 
    '''</span>

    <span class="s1">font_name </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">'data/fonts/RobotoMono-Regular.ttf'</span><span class="s2">)</span>
    <span class="s3">'''Specifies the font used on the ColorPicker. 
 
    :attr:`font_name` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'data/fonts/RobotoMono-Regular.ttf'. 
    '''</span>

    <span class="s1">color </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
    <span class="s3">'''The :attr:`color` holds the color currently selected in rgba format. 
 
    :attr:`color` is a :class:`~kivy.properties.ListProperty` and defaults to 
    (1, 1, 1, 1). 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_hsv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">rgb_to_hsv</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[:</span><span class="s5">3</span><span class="s2">])</span>

    <span class="s4">def </span><span class="s1">_set_hsv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_color</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">hsv </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_hsv</span><span class="s2">, </span><span class="s1">_set_hsv</span><span class="s2">, </span><span class="s1">bind</span><span class="s2">=(</span><span class="s3">'color'</span><span class="s2">, ))</span>
    <span class="s3">'''The :attr:`hsv` holds the color currently selected in hsv format. 
 
    :attr:`hsv` is a :class:`~kivy.properties.ListProperty` and defaults to 
    (1, 1, 1). 
    '''</span>
    <span class="s4">def </span><span class="s1">_get_hex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">get_hex_from_color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_set_hex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_color</span><span class="s2">(</span><span class="s1">get_color_from_hex</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)[:</span><span class="s5">4</span><span class="s2">])</span>

    <span class="s1">hex_color </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_hex</span><span class="s2">, </span><span class="s1">_set_hex</span><span class="s2">, </span><span class="s1">bind</span><span class="s2">=(</span><span class="s3">'color'</span><span class="s2">,), </span><span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''The :attr:`hex_color` holds the currently selected color in hex. 
 
    :attr:`hex_color` is an :class:`~kivy.properties.AliasProperty` and 
    defaults to `#ffffffff`. 
    '''</span>

    <span class="s1">wheel </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s3">'''The :attr:`wheel` holds the color wheel. 
 
    :attr:`wheel` is an :class:`~kivy.properties.ObjectProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">_update_clr_ev </span><span class="s2">= </span><span class="s1">_update_hex_ev </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s6"># now used only internally.</span>
    <span class="s1">foreground_color </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">_trigger_update_clr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">clr_idx</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_upd_clr_list </span><span class="s2">= </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">clr_idx</span><span class="s2">, </span><span class="s1">text</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_clr_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_clr_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_clr</span><span class="s2">)</span>
        <span class="s1">ev</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_update_clr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s6"># to prevent interaction between hsv/rgba, we work internally using rgba</span>
        <span class="s1">mode</span><span class="s2">, </span><span class="s1">clr_idx</span><span class="s2">, </span><span class="s1">text </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_upd_clr_list</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s1">text </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s5">255.0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s1">text</span><span class="s2">)))</span>
            <span class="s4">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s3">'rgb'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[</span><span class="s1">clr_idx</span><span class="s2">] = </span><span class="s1">text </span><span class="s2">/ </span><span class="s5">255</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">hsv </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">hsv</span><span class="s2">[:])</span>
                <span class="s1">hsv</span><span class="s2">[</span><span class="s1">clr_idx</span><span class="s2">] = </span><span class="s1">text </span><span class="s2">/ </span><span class="s5">255</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[:</span><span class="s5">3</span><span class="s2">] = </span><span class="s1">hsv_to_rgb</span><span class="s2">(*</span><span class="s1">hsv</span><span class="s2">)</span>
        <span class="s4">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">'ColorPicker: invalid value : {}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">text</span><span class="s2">))</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">def </span><span class="s1">_update_hex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_upd_hex_list</span><span class="s2">) != </span><span class="s5">9</span><span class="s2">:</span>
                <span class="s4">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">hex_color </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_upd_hex_list</span>
        <span class="s4">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">def </span><span class="s1">_trigger_update_hex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_upd_hex_list </span><span class="s2">= </span><span class="s1">text</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_hex_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_hex_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_hex</span><span class="s2">)</span>
        <span class="s1">ev</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">set_color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">color</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s4">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">color</span><span class="s2">) == </span><span class="s5">3</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color</span><span class="s2">[:</span><span class="s5">3</span><span class="s2">] = </span><span class="s1">color</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">color </span><span class="s2">= </span><span class="s1">color</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">False</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_updating_clr </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ColorPicker</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'__android__'</span><span class="s2">, </span><span class="s3">'__main__'</span><span class="s2">):</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">app </span><span class="s4">import </span><span class="s1">App</span>

    <span class="s4">class </span><span class="s1">ColorPickerApp</span><span class="s2">(</span><span class="s1">App</span><span class="s2">):</span>
        <span class="s4">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">cp </span><span class="s2">= </span><span class="s1">ColorPicker</span><span class="s2">(</span><span class="s1">pos_hint</span><span class="s2">={</span><span class="s3">'center_x'</span><span class="s2">: </span><span class="s5">.5</span><span class="s2">, </span><span class="s3">'center_y'</span><span class="s2">: </span><span class="s5">.5</span><span class="s2">},</span>
                             <span class="s1">size_hint</span><span class="s2">=(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
            <span class="s4">return </span><span class="s1">cp</span>
    <span class="s1">ColorPickerApp</span><span class="s2">().</span><span class="s1">run</span><span class="s2">()</span>
</pre>
</body>
</html>