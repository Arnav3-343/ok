<html>
<head>
<title>test_sets.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_sets.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">unittest</span>

<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">namedtuple</span>
<span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">random</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">TypingError</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">numba </span><span class="s0">import </span><span class="s1">jit</span><span class="s2">, </span><span class="s1">njit</span>
<span class="s0">from </span><span class="s1">numba</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">support </span><span class="s0">import </span><span class="s2">(</span><span class="s1">TestCase</span><span class="s2">, </span><span class="s1">enable_pyobj_flags</span><span class="s2">, </span><span class="s1">MemoryLeakMixin</span><span class="s2">,</span>
                                 <span class="s1">compile_function</span><span class="s2">)</span>


<span class="s1">Point </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'Point'</span><span class="s2">, (</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_build_set_literal_usecase</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s1">code </span><span class="s2">% {</span><span class="s3">'initializer'</span><span class="s2">: </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) </span><span class="s0">for </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">args</span><span class="s2">)}</span>
    <span class="s0">return </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s3">'build_set'</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>

<span class="s0">def </span><span class="s1">set_literal_return_usecase</span><span class="s2">(</span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
    def build_set(): 
        return {%(initializer)s} 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">_build_set_literal_usecase</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">set_literal_convert_usecase</span><span class="s2">(</span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
    def build_set(): 
        my_set = {%(initializer)s} 
        return list(my_set) 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">_build_set_literal_usecase</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">empty_constructor_usecase</span><span class="s2">():</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">constructor_usecase</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">iterator_usecase</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
    <span class="s1">l </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">l</span>

<span class="s0">def </span><span class="s1">update_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">bool_usecase</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">):</span>
    <span class="s5"># Remove one element to allow for empty sets.</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:])</span>
    <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">remove_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">discard_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">discard</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">add_discard_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">):</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">u</span><span class="s2">)</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">discard</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">pop_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">l </span><span class="s2">= []</span>
    <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) &gt; </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">())</span>
    <span class="s0">return </span><span class="s1">l</span>

<span class="s0">def </span><span class="s1">contains_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">l </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">v </span><span class="s0">in </span><span class="s1">s</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">l</span>

<span class="s0">def </span><span class="s1">difference_update_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">difference_update</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">intersection_update_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">intersection_update</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">symmetric_difference_update_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">symmetric_difference_update</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">isdisjoint_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">isdisjoint</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">issubset_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">issubset</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">issuperset_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">issuperset</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">clear_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">copy_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">ss </span><span class="s2">= </span><span class="s1">s</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">copy_usecase_empty</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s1">ss </span><span class="s2">= </span><span class="s1">s</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">copy_usecase_deleted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
    <span class="s1">ss </span><span class="s2">= </span><span class="s1">s</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ss</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">difference_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">sa </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">difference</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">intersection_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">sa </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">intersection</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">symmetric_difference_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">sa </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">symmetric_difference</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">union_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s1">sa </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">union</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">set_return_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">s</span>


<span class="s0">def </span><span class="s1">noop</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">pass</span>

<span class="s0">def </span><span class="s1">unbox_usecase</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Expect a set of numbers 
    &quot;&quot;&quot;</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">x</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">+= </span><span class="s1">v</span>
    <span class="s0">return </span><span class="s1">res</span>

<span class="s0">def </span><span class="s1">unbox_usecase2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Expect a set of tuples 
    &quot;&quot;&quot;</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">x</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">res</span>

<span class="s0">def </span><span class="s1">unbox_usecase3</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Expect a (number, set of numbers) tuple. 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">a</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">+= </span><span class="s1">v</span>
    <span class="s0">return </span><span class="s1">res</span>

<span class="s0">def </span><span class="s1">unbox_usecase4</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Expect a (number, set of tuples) tuple. 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">a</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">+= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">res</span>


<span class="s0">def </span><span class="s1">reflect_simple</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">, </span><span class="s1">sb</span><span class="s2">):</span>
    <span class="s1">sa</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">42</span><span class="s2">)</span>
    <span class="s1">sa</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">sb</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">sa</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sb</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">reflect_conditional</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">, </span><span class="s1">sb</span><span class="s2">):</span>
    <span class="s5"># `sa` may or may not actually reflect a Python set</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sb</span><span class="s2">) &gt; </span><span class="s4">1</span><span class="s2">:</span>
        <span class="s1">sa </span><span class="s2">= </span><span class="s1">set</span><span class="s2">((</span><span class="s4">11.</span><span class="s2">, </span><span class="s4">22.</span><span class="s2">, </span><span class="s4">33.</span><span class="s2">, </span><span class="s4">44.</span><span class="s2">))</span>
    <span class="s1">sa</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">42.</span><span class="s2">)</span>
    <span class="s1">sa</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">sb</span><span class="s2">)</span>
    <span class="s5"># Combine with a non-reflected set (to check method typing)</span>
    <span class="s1">sc </span><span class="s2">= </span><span class="s1">set</span><span class="s2">((</span><span class="s4">55.</span><span class="s2">, </span><span class="s4">66.</span><span class="s2">))</span>
    <span class="s1">sa</span><span class="s2">.</span><span class="s1">symmetric_difference_update</span><span class="s2">(</span><span class="s1">sc</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">sa</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sb</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">reflect_exception</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">42</span><span class="s2">)</span>
    <span class="s0">raise </span><span class="s1">ZeroDivisionError</span>

<span class="s0">def </span><span class="s1">reflect_dual</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">, </span><span class="s1">sb</span><span class="s2">):</span>
    <span class="s1">sa</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">sb</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">())</span>
    <span class="s0">return </span><span class="s1">sa </span><span class="s0">is </span><span class="s1">sb</span>


<span class="s0">def </span><span class="s1">unique_usecase</span><span class="s2">(</span><span class="s1">src</span><span class="s2">):</span>
    <span class="s1">seen </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">res </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">src</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">v </span><span class="s0">not in </span><span class="s1">seen</span><span class="s2">:</span>
            <span class="s1">seen</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
            <span class="s1">res</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">res</span>


<span class="s0">class </span><span class="s1">BaseTest</span><span class="s2">(</span><span class="s1">MemoryLeakMixin</span><span class="s2">, </span><span class="s1">TestCase</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">setUp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">setUp</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rnd </span><span class="s2">= </span><span class="s1">random</span><span class="s2">.</span><span class="s1">Random</span><span class="s2">(</span><span class="s4">42</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)).</span><span class="s1">tolist</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_random_choice</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">seq</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Choose *n* possibly duplicate items from sequence. 
        &quot;&quot;&quot;</span>
        <span class="s1">l </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rnd</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">seq</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)]</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">seq</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">l</span>

    <span class="s0">def </span><span class="s1">duplicates_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get a 1d array with many duplicate values. 
        &quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_range</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_random_choice</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Get a 1d array with values spread around. 
        &quot;&quot;&quot;</span>
        <span class="s5"># Note two calls to sparse_array() should generate reasonable overlap</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_range</span><span class="s2">(</span><span class="s1">n </span><span class="s2">** </span><span class="s4">1.3</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_random_choice</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_assert_equal_unordered</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_equal_unordered</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIsInstance</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">b</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">check</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">):</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_assert_equal_unordered</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">check</span>


<span class="s0">class </span><span class="s1">TestSetLiterals</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">njit</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">()</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">got</span><span class="s2">, </span><span class="s1">expected</span>

    <span class="s0">def </span><span class="s1">test_build_set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">set_literal_return_usecase</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_build_heterogeneous_set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">enable_pyobj_flags</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">set_literal_return_usecase</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3j</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">set_literal_return_usecase</span><span class="s2">((</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">got</span><span class="s2">, </span><span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">check</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertIs</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">got</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()))</span>

    <span class="s0">def </span><span class="s1">test_build_set_nopython</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arg </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">))</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">set_literal_convert_usecase</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">()</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">), </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">got</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestSets</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">test_constructor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">empty_constructor_usecase</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">cfunc</span><span class="s2">(), </span><span class="s1">pyfunc</span><span class="s2">())</span>

        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">constructor_usecase</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">), </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">))</span>

        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">duplicates_array</span><span class="s2">(</span><span class="s4">200</span><span class="s2">))</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">200</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_set_return</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">set_return_usecase</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">arg </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">duplicates_array</span><span class="s2">(</span><span class="s4">200</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">), </span><span class="s1">set</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_iterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">iterator_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">duplicates_array</span><span class="s2">(</span><span class="s4">200</span><span class="s2">))</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">200</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">update_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">duplicates_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">remove_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[::</span><span class="s4">10</span><span class="s2">]</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_remove_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># References are leaked on exception</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">disable_leak_check</span><span class="s2">()</span>

        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">remove_usecase</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s5"># ensure that there will be a key error</span>
        <span class="s1">items </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">items</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]</span>
        <span class="s1">b </span><span class="s2">= (</span><span class="s1">items</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">):</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_discard</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">discard_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_add_discard</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Check that the insertion logic does not create an infinite lookup 
        chain with deleted entries (insertion should happen at the first 
        deleted entry, not at the free entry at the end of the chain). 
        See issue #1913. 
        &quot;&quot;&quot;</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">add_discard_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s5"># ensure a and b are different</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">b </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">while </span><span class="s1">a </span><span class="s2">== </span><span class="s1">b</span><span class="s2">:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">((</span><span class="s1">a</span><span class="s2">,), </span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">pop_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_contains</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">contains_usecase</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_test_xxx_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">sizes </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">500</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">na</span><span class="s2">, </span><span class="s1">nb </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s1">na</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">)</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_difference_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_xxx_update</span><span class="s2">(</span><span class="s1">difference_update_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_intersection_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_xxx_update</span><span class="s2">(</span><span class="s1">intersection_update_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_symmetric_difference_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_xxx_update</span><span class="s2">(</span><span class="s1">symmetric_difference_update_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_test_comparator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">set</span><span class="s2">, [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">15</span><span class="s2">)])</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">a </span><span class="s2">&amp; </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">- </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">| </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">^ </span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">args </span><span class="s2">= [</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">args</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_isdisjoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_comparator</span><span class="s2">(</span><span class="s1">isdisjoint_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_issubset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_comparator</span><span class="s2">(</span><span class="s1">issubset_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_issuperset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_comparator</span><span class="s2">(</span><span class="s1">issuperset_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">clear_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Source set doesn't have any deleted entries</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">copy_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">))</span>

        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">copy_usecase_empty</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

        <span class="s5"># Source set has deleted entries</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">copy_usecase_deleted</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">11</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) // </span><span class="s4">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">bool_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">11</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">42</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s1">sizes </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">500</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">na</span><span class="s2">, </span><span class="s1">nb </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s1">na</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">)</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">make_operator_usecase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
        def operator_usecase(a, b): 
            s = set(a) %(op)s set(b) 
            return list(s) 
        &quot;&quot;&quot; </span><span class="s2">% </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s3">'operator_usecase'</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">make_inplace_operator_usecase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
        def inplace_operator_usecase(a, b): 
            sa = set(a) 
            sb = set(b) 
            sc = sa 
            sc %(op)s sb 
            return list(sc), list(sa) 
        &quot;&quot;&quot; </span><span class="s2">% </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s3">'inplace_operator_usecase'</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
        def comparison_usecase(a, b): 
            return set(a) %(op)s set(b) 
        &quot;&quot;&quot; </span><span class="s2">% </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s3">'comparison_usecase'</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_difference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">difference_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_intersection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">intersection_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_symmetric_difference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">symmetric_difference_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_union</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">union_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_and</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_operator_usecase</span><span class="s2">(</span><span class="s3">'&amp;'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_or</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_operator_usecase</span><span class="s2">(</span><span class="s3">'|'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_sub</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_operator_usecase</span><span class="s2">(</span><span class="s3">'-'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_xor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_operator_usecase</span><span class="s2">(</span><span class="s3">'^'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_eq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s3">'=='</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_ne</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s3">'!='</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_le</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s3">'&lt;='</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_lt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s3">'&lt;'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_ge</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s3">'&gt;='</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_gt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s3">'&gt;'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_iand</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_inplace_operator_usecase</span><span class="s2">(</span><span class="s3">'&amp;='</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_ior</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_inplace_operator_usecase</span><span class="s2">(</span><span class="s3">'|='</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_isub</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_inplace_operator_usecase</span><span class="s2">(</span><span class="s3">'-='</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_ixor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_inplace_operator_usecase</span><span class="s2">(</span><span class="s3">'^='</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestFloatSets</span><span class="s2">(</span><span class="s1">TestSets</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test sets with floating-point keys. 
    &quot;&quot;&quot;</span>
    <span class="s5"># Only a few basic tests here, as the sanity of most operations doesn't</span>
    <span class="s5"># depend on the key type.</span>

    <span class="s0">def </span><span class="s1">_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s4">0.1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestTupleSets</span><span class="s2">(</span><span class="s1">TestSets</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test sets with tuple keys. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">a </span><span class="s2">&amp; </span><span class="s4">0x5555555555555555</span>
        <span class="s1">c </span><span class="s2">= (</span><span class="s1">a </span><span class="s2">&amp; </span><span class="s4">0xaaaaaaaa</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= ((</span><span class="s1">a </span><span class="s2">&gt;&gt; </span><span class="s4">32</span><span class="s2">) &amp; </span><span class="s4">1</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestUnicodeSets</span><span class="s2">(</span><span class="s1">TestSets</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test sets with unicode keys. For the purpose of testing refcounted sets. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s3">'A{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">))]</span>


<span class="s0">class </span><span class="s1">TestSetsInvalidDtype</span><span class="s2">(</span><span class="s1">TestSets</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s5"># it is invalid to apply some set operations on</span>
        <span class="s5"># sets with different dtype</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">11</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">])</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">'All Sets must be of the same type'</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaisesRegex</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSetsInvalid</span><span class="s2">(</span><span class="s1">TestSets</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">symmetric_difference_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">symmetric_difference</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">difference_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">difference</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">intersection_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">intersection</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">union_usecase</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">union</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s5"># it is invalid to apply some set operations on</span>
        <span class="s5"># sets with different dtype</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">11</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">'All arguments must be Sets'</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaisesRegex</span><span class="s2">(</span><span class="s1">TypingError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_difference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">TestSetsInvalid</span><span class="s2">.</span><span class="s1">difference_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_intersection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">TestSetsInvalid</span><span class="s2">.</span><span class="s1">intersection_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_symmetric_difference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">TestSetsInvalid</span><span class="s2">.</span><span class="s1">symmetric_difference_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_union</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_set_operator</span><span class="s2">(</span><span class="s1">TestSetsInvalid</span><span class="s2">.</span><span class="s1">union_usecase</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">make_operator_usecase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
        def operator_usecase(a, b): 
            s = a %(op)s b 
            return list(s) 
        &quot;&quot;&quot; </span><span class="s2">% </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s3">'operator_usecase'</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">make_inplace_operator_usecase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
        def inplace_operator_usecase(a, b): 
            sa = a 
            sb = b 
            sc = sa 
            sc %(op)s sb 
            return list(sc), list(sa) 
        &quot;&quot;&quot; </span><span class="s2">% </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s3">'inplace_operator_usecase'</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">make_comparison_usecase</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s1">code </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;if 1: 
        def comparison_usecase(a, b): 
            return set(a) %(op)s b 
        &quot;&quot;&quot; </span><span class="s2">% </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">op</span><span class="s2">=</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">compile_function</span><span class="s2">(</span><span class="s3">'comparison_usecase'</span><span class="s2">, </span><span class="s1">code</span><span class="s2">, </span><span class="s1">globals</span><span class="s2">())</span>


<span class="s0">class </span><span class="s1">TestUnboxing</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test unboxing of Python sets into native Numba sets. 
    &quot;&quot;&quot;</span>

    <span class="s2">@</span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">assert_type_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s0">yield</span>
        <span class="s0">if </span><span class="s1">msg </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRegex</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">raises</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">), </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_unary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">):</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">check</span>

    <span class="s0">def </span><span class="s1">test_numbers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">check_unary</span><span class="s2">(</span><span class="s1">unbox_usecase</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]))</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s4">1j</span><span class="s2">, </span><span class="s4">2.5j</span><span class="s2">]))</span>
        <span class="s5"># Check allocation and sizing</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_tuples</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">check_unary</span><span class="s2">(</span><span class="s1">unbox_usecase2</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)]))</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2j</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4j</span><span class="s2">)]))</span>

    <span class="s0">def </span><span class="s1">test_set_inside_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">check_unary</span><span class="s2">(</span><span class="s1">unbox_usecase3</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">set</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])))</span>

    <span class="s0">def </span><span class="s1">test_set_of_tuples_inside_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">check_unary</span><span class="s2">(</span><span class="s1">unbox_usecase4</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">set</span><span class="s2">([(</span><span class="s4">2</span><span class="s2">,), (</span><span class="s4">3</span><span class="s2">,)])))</span>

    <span class="s0">def </span><span class="s1">test_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Error checking should ensure the set is homogeneous</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;can't unbox heterogeneous set&quot;</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">noop</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assert_type_error</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>
        <span class="s5"># The set hasn't been changed (bogus reflecting)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">]))</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assert_type_error</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2j</span><span class="s2">]))</span>
        <span class="s5"># Same when the set is nested in a tuple or namedtuple</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assert_type_error</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">cfunc</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2j</span><span class="s2">])))</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assert_type_error</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">Point</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2j</span><span class="s2">])))</span>
        <span class="s5"># Tuples of different size.</span>
        <span class="s5"># Note the check is really on the tuple side.</span>
        <span class="s1">lst </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>
        <span class="s5"># Depending on which tuple is examined first, we could get</span>
        <span class="s5"># a IndexError or a ValueError.</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">((</span><span class="s1">IndexError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">raises</span><span class="s2">:</span>
            <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">lst</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSetReflection</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Test reflection of native Numba sets on Python set objects. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">check_reflection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pyfunc</span><span class="s2">):</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">samples </span><span class="s2">= [(</span><span class="s1">set</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]), </span><span class="s1">set</span><span class="s2">([</span><span class="s4">0.</span><span class="s2">])),</span>
                   <span class="s2">(</span><span class="s1">set</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]), </span><span class="s1">set</span><span class="s2">([</span><span class="s4">5.</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">, </span><span class="s4">7.</span><span class="s2">, </span><span class="s4">8.</span><span class="s2">, </span><span class="s4">9.</span><span class="s2">])),</span>
                   <span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">src </span><span class="s0">in </span><span class="s1">samples</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">)</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">)</span>
            <span class="s1">pyres </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">src</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRefCount</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">src</span><span class="s2">):</span>
                <span class="s1">cres </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">src</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">cres</span><span class="s2">, </span><span class="s1">pyres</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">(</span><span class="s1">pyres</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">cres</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">got</span><span class="s2">)</span>
                <span class="s0">del </span><span class="s1">pyres</span><span class="s2">, </span><span class="s1">cres</span>

    <span class="s0">def </span><span class="s1">test_reflect_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_reflection</span><span class="s2">(</span><span class="s1">reflect_simple</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reflect_conditional</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_reflection</span><span class="s2">(</span><span class="s1">reflect_conditional</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reflect_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        When the function exits with an exception, sets should still be 
        reflected. 
        &quot;&quot;&quot;</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">reflect_exception</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRefCount</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">assertRaises</span><span class="s2">(</span><span class="s1">ZeroDivisionError</span><span class="s2">):</span>
                <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">42</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_reflect_same_set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        When the same set object is reflected twice, behaviour should 
        be consistent. 
        &quot;&quot;&quot;</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">reflect_dual</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">pyfunc</span><span class="s2">)</span>
        <span class="s1">pyset </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">cset </span><span class="s2">= </span><span class="s1">pyset</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pyfunc</span><span class="s2">(</span><span class="s1">pyset</span><span class="s2">, </span><span class="s1">pyset</span><span class="s2">)</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">cset</span><span class="s2">, </span><span class="s1">cset</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">got</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertPreciseEqual</span><span class="s2">(</span><span class="s1">pyset</span><span class="s2">, </span><span class="s1">cset</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertRefCountEqual</span><span class="s2">(</span><span class="s1">pyset</span><span class="s2">, </span><span class="s1">cset</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reflect_clean</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        When the set wasn't mutated, no reflection should take place. 
        &quot;&quot;&quot;</span>
        <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">jit</span><span class="s2">(</span><span class="s1">nopython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">noop</span><span class="s2">)</span>
        <span class="s5"># Use a complex, as Python integers can be cached</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s4">12.5j</span><span class="s2">])</span>
        <span class="s1">ids </span><span class="s2">= [</span><span class="s1">id</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">s</span><span class="s2">]</span>
        <span class="s1">cfunc</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assertEqual</span><span class="s2">([</span><span class="s1">id</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">s</span><span class="s2">], </span><span class="s1">ids</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestExamples</span><span class="s2">(</span><span class="s1">BaseTest</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Examples of using sets. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_unique</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">pyfunc </span><span class="s2">= </span><span class="s1">unique_usecase</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">pyfunc</span><span class="s2">)</span>

        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">duplicates_array</span><span class="s2">(</span><span class="s4">200</span><span class="s2">))</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sparse_array</span><span class="s2">(</span><span class="s4">200</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_type_coercion_from_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># see issue #6621</span>
        <span class="s0">def </span><span class="s1">impl</span><span class="s2">():</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">R </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
            <span class="s1">R</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">})</span>
            <span class="s1">R</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">R</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unordered_checker</span><span class="s2">(</span><span class="s1">impl</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">()</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s1">unittest</span><span class="s2">.</span><span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>