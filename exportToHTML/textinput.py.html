<html>
<head>
<title>textinput.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
textinput.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
Text Input 
========== 
 
.. versionadded:: 1.0.4 
 
.. image:: images/textinput-mono.jpg 
.. image:: images/textinput-multi.jpg 
 
The :class:`TextInput` widget provides a box for editable plain text. 
 
Unicode, multiline, cursor navigation, selection and clipboard features 
are supported. 
 
The :class:`TextInput` uses two different coordinate systems: 
 
* (x, y) - coordinates in pixels, mostly used for rendering on screen. 
* (col, row) - cursor index in characters / lines, used for selection 
  and cursor movement. 
 
 
Usage example 
------------- 
 
To create a multiline :class:`TextInput` (the 'enter' key adds a new line):: 
 
    from kivy.uix.textinput import TextInput 
    textinput = TextInput(text='Hello world') 
 
To create a singleline :class:`TextInput`, set the :class:`TextInput.multiline` 
property to False (the 'enter' key will defocus the TextInput and emit an 
:meth:`TextInput.on_text_validate` event):: 
 
    def on_enter(instance, value): 
        print('User pressed enter in', instance) 
 
    textinput = TextInput(text='Hello world', multiline=False) 
    textinput.bind(on_text_validate=on_enter) 
 
The textinput's text is stored in its :attr:`TextInput.text` property. To run a 
callback when the text changes:: 
 
    def on_text(instance, value): 
        print('The widget', instance, 'have:', value) 
 
    textinput = TextInput() 
    textinput.bind(text=on_text) 
 
You can set the :class:`focus &lt;kivy.uix.behaviors.FocusBehavior&gt;` to a 
Textinput, meaning that the input box will be highlighted and keyboard focus 
will be requested:: 
 
    textinput = TextInput(focus=True) 
 
The textinput is defocused if the 'escape' key is pressed, or if another 
widget requests the keyboard. You can bind a callback to the focus property to 
get notified of focus changes:: 
 
    def on_focus(instance, value): 
        if value: 
            print('User focused', instance) 
        else: 
            print('User defocused', instance) 
 
    textinput = TextInput() 
    textinput.bind(focus=on_focus) 
 
See :class:`~kivy.uix.behaviors.FocusBehavior`, from which the 
:class:`TextInput` inherits, for more details. 
 
 
Selection 
--------- 
 
The selection is automatically updated when the cursor position changes. 
You can get the currently selected text from the 
:attr:`TextInput.selection_text` property. 
 
Handles 
------- 
 
One can enable :attr:`TextInput.use_handles` property to enable or disable 
the usage of selection handles. This property is True by default on mobiles. 
 
Selection Handles uses the class :class:`Selector` as the base class for 
the selection handles. You can customize the color for selection handles 
like so :: 
 
    &lt;Selector&gt; 
        color: 0, 1, 0, 1 
        # or &lt;Textinput_instance&gt;.selection_color or app.selection_color 
 
TextInput instantiates the selection handles and stores it in the following 
properties. :attr:`TextInput._handle_middle`, 
:attr:`TextInput._handle_left`, :attr:`TextInput._handle_right`. 
 
You should set the selection template before the Instantiating TextInput, 
so as to get the selection handles to take the changes you set to apply. 
 
Filtering 
--------- 
 
You can control which text can be added to the :class:`TextInput` by 
overwriting :meth:`TextInput.insert_text`. Every string that is typed, pasted 
or inserted by any other means into the :class:`TextInput` is passed through 
this function. By overwriting it you can reject or change unwanted characters. 
 
For example, to write only in capitalized characters:: 
 
    class CapitalInput(TextInput): 
 
        def insert_text(self, substring, from_undo=False): 
            s = substring.upper() 
            return super().insert_text(s, from_undo=from_undo) 
 
Or to only allow floats (0 - 9 and a single period):: 
 
    class FloatInput(TextInput): 
 
        pat = re.compile('[^0-9]') 
        def insert_text(self, substring, from_undo=False): 
            pat = self.pat 
            if '.' in self.text: 
                s = re.sub(pat, '', substring) 
            else: 
                s = '.'.join( 
                    re.sub(pat, '', s) 
                    for s in substring.split('.', 1) 
                ) 
            return super().insert_text(s, from_undo=from_undo) 
 
Default shortcuts 
----------------- 
 
=============== ======================================================== 
   Shortcuts    Description 
--------------- -------------------------------------------------------- 
Left            Move cursor to left 
Right           Move cursor to right 
Up              Move cursor to up 
Down            Move cursor to down 
Home            Move cursor at the beginning of the line 
End             Move cursor at the end of the line 
PageUp          Move cursor to 3 lines before 
PageDown        Move cursor to 3 lines after 
Backspace       Delete the selection or character before the cursor 
Del             Delete the selection of character after the cursor 
Shift + &lt;dir&gt;   Start a text selection. Dir can be Up, Down, Left or 
                Right 
Control + c     Copy selection 
Control + x     Cut selection 
Control + v     Paste clipboard content 
Control + a     Select all the content 
Control + z     undo 
Control + r     redo 
=============== ======================================================== 
 
.. note:: 
    To enable Emacs-style keyboard shortcuts, you can use 
    :class:`~kivy.uix.behaviors.emacs.EmacsBehavior`. 
 
'''</span>


<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">math</span>
<span class="s2">from </span><span class="s1">os </span><span class="s2">import </span><span class="s1">environ</span>
<span class="s2">from </span><span class="s1">weakref </span><span class="s2">import </span><span class="s1">ref</span>
<span class="s2">from </span><span class="s1">itertools </span><span class="s2">import </span><span class="s1">chain</span><span class="s3">, </span><span class="s1">islice</span>

<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">animation </span><span class="s2">import </span><span class="s1">Animation</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">base </span><span class="s2">import </span><span class="s1">EventLoop</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">cache </span><span class="s2">import </span><span class="s1">Cache</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">clock </span><span class="s2">import </span><span class="s1">Clock</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">window </span><span class="s2">import </span><span class="s1">Window</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">metrics </span><span class="s2">import </span><span class="s1">inch</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">boundary</span><span class="s3">, </span><span class="s1">platform</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">uix</span><span class="s3">.</span><span class="s1">behaviors </span><span class="s2">import </span><span class="s1">FocusBehavior</span>

<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">text </span><span class="s2">import </span><span class="s1">Label</span><span class="s3">, </span><span class="s1">DEFAULT_FONT</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">graphics </span><span class="s2">import </span><span class="s1">Color</span><span class="s3">, </span><span class="s1">Rectangle</span><span class="s3">, </span><span class="s1">PushMatrix</span><span class="s3">, </span><span class="s1">PopMatrix</span><span class="s3">, </span><span class="s1">Callback</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">graphics</span><span class="s3">.</span><span class="s1">context_instructions </span><span class="s2">import </span><span class="s1">Transform</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">graphics</span><span class="s3">.</span><span class="s1">texture </span><span class="s2">import </span><span class="s1">Texture</span>

<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">uix</span><span class="s3">.</span><span class="s1">widget </span><span class="s2">import </span><span class="s1">Widget</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">uix</span><span class="s3">.</span><span class="s1">bubble </span><span class="s2">import </span><span class="s1">Bubble</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">uix</span><span class="s3">.</span><span class="s1">behaviors </span><span class="s2">import </span><span class="s1">ButtonBehavior</span>
<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">uix</span><span class="s3">.</span><span class="s1">image </span><span class="s2">import </span><span class="s1">Image</span>

<span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">properties </span><span class="s2">import </span><span class="s1">StringProperty</span><span class="s3">, </span><span class="s1">NumericProperty</span><span class="s3">, </span><span class="s1">\</span>
    <span class="s1">BooleanProperty</span><span class="s3">, </span><span class="s1">AliasProperty</span><span class="s3">, </span><span class="s1">OptionProperty</span><span class="s3">, </span><span class="s1">\</span>
    <span class="s1">ListProperty</span><span class="s3">, </span><span class="s1">ObjectProperty</span><span class="s3">, </span><span class="s1">VariableListProperty</span><span class="s3">, </span><span class="s1">ColorProperty</span><span class="s3">, </span><span class="s1">\</span>
    <span class="s1">BoundedNumericProperty</span>

<span class="s1">__all__ </span><span class="s3">= (</span><span class="s4">'TextInput'</span><span class="s3">, )</span>


<span class="s2">if </span><span class="s4">'KIVY_DOC' </span><span class="s2">in </span><span class="s1">environ</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">triggered</span><span class="s3">(*</span><span class="s1">_</span><span class="s3">, **</span><span class="s1">__</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">decorator_func</span><span class="s3">(</span><span class="s1">func</span><span class="s3">):</span>
            <span class="s2">def </span><span class="s1">decorated_func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">decorated_func</span>
        <span class="s2">return </span><span class="s1">decorator_func</span>
<span class="s2">else</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">clock </span><span class="s2">import </span><span class="s1">triggered</span>


<span class="s1">Cache_register </span><span class="s3">= </span><span class="s1">Cache</span><span class="s3">.</span><span class="s1">register</span>
<span class="s1">Cache_append </span><span class="s3">= </span><span class="s1">Cache</span><span class="s3">.</span><span class="s1">append</span>
<span class="s1">Cache_get </span><span class="s3">= </span><span class="s1">Cache</span><span class="s3">.</span><span class="s1">get</span>
<span class="s1">Cache_remove </span><span class="s3">= </span><span class="s1">Cache</span><span class="s3">.</span><span class="s1">remove</span>
<span class="s1">Cache_register</span><span class="s3">(</span><span class="s4">'textinput.label'</span><span class="s3">, </span><span class="s1">timeout</span><span class="s3">=</span><span class="s5">60.</span><span class="s3">)</span>
<span class="s1">Cache_register</span><span class="s3">(</span><span class="s4">'textinput.width'</span><span class="s3">, </span><span class="s1">timeout</span><span class="s3">=</span><span class="s5">60.</span><span class="s3">)</span>

<span class="s1">FL_IS_LINEBREAK </span><span class="s3">= </span><span class="s5">0x01</span>
<span class="s1">FL_IS_WORDBREAK </span><span class="s3">= </span><span class="s5">0x02</span>
<span class="s1">FL_IS_NEWLINE </span><span class="s3">= </span><span class="s1">FL_IS_LINEBREAK </span><span class="s3">| </span><span class="s1">FL_IS_WORDBREAK</span>

<span class="s6"># late binding</span>
<span class="s1">Clipboard </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">CutBuffer </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">MarkupLabel </span><span class="s3">= </span><span class="s2">None</span>
<span class="s1">_platform </span><span class="s3">= </span><span class="s1">platform</span>

<span class="s6"># for reloading, we need to keep a list of textinput to retrigger the rendering</span>
<span class="s1">_textinput_list </span><span class="s3">= []</span>

<span class="s6"># cache the result</span>
<span class="s1">_is_osx </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s4">'darwin'</span>

<span class="s6"># When we are generating documentation, Config doesn't exist</span>
<span class="s1">_is_desktop </span><span class="s3">= </span><span class="s2">False</span>
<span class="s1">_scroll_timeout </span><span class="s3">= </span><span class="s1">_scroll_distance </span><span class="s3">= </span><span class="s5">0</span>
<span class="s2">if </span><span class="s1">Config</span><span class="s3">:</span>
    <span class="s1">_is_desktop </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">getboolean</span><span class="s3">(</span><span class="s4">'kivy'</span><span class="s3">, </span><span class="s4">'desktop'</span><span class="s3">)</span>
    <span class="s1">_scroll_timeout </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">getint</span><span class="s3">(</span><span class="s4">'widgets'</span><span class="s3">, </span><span class="s4">'scroll_timeout'</span><span class="s3">)</span>
    <span class="s1">_scroll_distance </span><span class="s3">= </span><span class="s4">'{}sp'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">Config</span><span class="s3">.</span><span class="s1">getint</span><span class="s3">(</span><span class="s4">'widgets'</span><span class="s3">,</span>
                                                   <span class="s4">'scroll_distance'</span><span class="s3">))</span>

<span class="s6"># register an observer to clear the textinput cache when OpenGL will reload</span>
<span class="s2">if </span><span class="s4">'KIVY_DOC' </span><span class="s2">not in </span><span class="s1">environ</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">_textinput_clear_cache</span><span class="s3">(*</span><span class="s1">l</span><span class="s3">):</span>
        <span class="s1">Cache_remove</span><span class="s3">(</span><span class="s4">'textinput.label'</span><span class="s3">)</span>
        <span class="s1">Cache_remove</span><span class="s3">(</span><span class="s4">'textinput.width'</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">wr </span><span class="s2">in </span><span class="s1">_textinput_list</span><span class="s3">[:]:</span>
            <span class="s1">textinput </span><span class="s3">= </span><span class="s1">wr</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">textinput </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">_textinput_list</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">wr</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">textinput</span><span class="s3">.</span><span class="s1">_trigger_refresh_text</span><span class="s3">()</span>
                <span class="s1">textinput</span><span class="s3">.</span><span class="s1">_refresh_hint_text</span><span class="s3">()</span>

    <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">graphics</span><span class="s3">.</span><span class="s1">context </span><span class="s2">import </span><span class="s1">get_context</span>
    <span class="s1">get_context</span><span class="s3">().</span><span class="s1">add_reload_observer</span><span class="s3">(</span><span class="s1">_textinput_clear_cache</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Selector</span><span class="s3">(</span><span class="s1">ButtonBehavior</span><span class="s3">, </span><span class="s1">Image</span><span class="s3">):</span>
    <span class="s0">'''Default template for the selection Handles 
 
    In order to customize the look of the Selection Handles, 
    you should adjust its template like so :: 
 
        &lt;Selector&gt; 
            color: 1, 0, 1, 1 
    '''</span>

    <span class="s1">window </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">()</span>
    <span class="s1">target </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">()</span>
    <span class="s1">matrix </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">always_release </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">matrix </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">get_window_matrix</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">before</span><span class="s3">:</span>
            <span class="s1">Callback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">update_transform</span><span class="s3">)</span>
            <span class="s1">PushMatrix</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform </span><span class="s3">= </span><span class="s1">Transform</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">after</span><span class="s3">:</span>
            <span class="s1">PopMatrix</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">update_transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">):</span>
        <span class="s1">matrix </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">get_window_matrix</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">matrix </span><span class="s3">!= </span><span class="s1">matrix</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">matrix </span><span class="s3">= </span><span class="s1">matrix</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">matrix</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">transform_touch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s1">matrix </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">matrix</span><span class="s3">.</span><span class="s1">inverse</span><span class="s3">()</span>
        <span class="s1">touch</span><span class="s3">.</span><span class="s1">apply_transform_2d</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">matrix</span><span class="s3">.</span><span class="s1">transform_point</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)[:</span><span class="s5">2</span><span class="s3">]</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">on_touch_down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent </span><span class="s2">is not </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">push</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform_touch</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_diff </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">top </span><span class="s3">- </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">y</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">collide_point</span><span class="s3">(*</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">):</span>
                <span class="s1">FocusBehavior</span><span class="s3">.</span><span class="s1">ignored_touch</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">on_touch_down</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">TextInputCutCopyPaste</span><span class="s3">(</span><span class="s1">Bubble</span><span class="s3">):</span>
    <span class="s6"># Internal class used for showing the little bubble popup when</span>
    <span class="s6"># copy/cut/paste happen.</span>

    <span class="s1">textinput </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s4">''' Holds a reference to the TextInput this Bubble belongs to. 
    '''</span>

    <span class="s1">but_cut </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">but_copy </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">but_paste </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">but_selectall </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s1">matrix </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s1">_check_parent_ev </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s4">'normal'</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_parent_ev </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_interval</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_check_parent</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">matrix </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textinput</span><span class="s3">.</span><span class="s1">get_window_matrix</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">before</span><span class="s3">:</span>
            <span class="s1">Callback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">update_transform</span><span class="s3">)</span>
            <span class="s1">PushMatrix</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform </span><span class="s3">= </span><span class="s1">Transform</span><span class="s3">()</span>

        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">after</span><span class="s3">:</span>
            <span class="s1">PopMatrix</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">update_transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textinput</span><span class="s3">.</span><span class="s1">get_window_matrix</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">matrix </span><span class="s3">!= </span><span class="s1">m</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">matrix </span><span class="s3">= </span><span class="s1">m</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">matrix</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">transform_touch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s1">matrix </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">matrix</span><span class="s3">.</span><span class="s1">inverse</span><span class="s3">()</span>
        <span class="s1">touch</span><span class="s3">.</span><span class="s1">apply_transform_2d</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">matrix</span><span class="s3">.</span><span class="s1">transform_point</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)[:</span><span class="s5">2</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">on_touch_down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">push</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform_touch</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">collide_point</span><span class="s3">(*</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">):</span>
                <span class="s1">FocusBehavior</span><span class="s3">.</span><span class="s1">ignored_touch</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">on_touch_down</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">on_touch_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">push</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">transform_touch</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">child </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">content</span><span class="s3">.</span><span class="s1">children</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">ref</span><span class="s3">(</span><span class="s1">child</span><span class="s3">) </span><span class="s2">in </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">grab_list</span><span class="s3">:</span>
                    <span class="s1">touch</span><span class="s3">.</span><span class="s1">grab_current </span><span class="s3">= </span><span class="s1">child</span>
                    <span class="s2">break</span>
            <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">on_touch_up</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">on_textinput</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">global </span><span class="s1">Clipboard</span>
        <span class="s2">if </span><span class="s1">value </span><span class="s2">and not </span><span class="s1">Clipboard </span><span class="s2">and not </span><span class="s1">_is_desktop</span><span class="s3">:</span>
            <span class="s1">value</span><span class="s3">.</span><span class="s1">_ensure_clipboard</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_check_parent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">):</span>
        <span class="s6"># this is a prevention to get the Bubble staying on the screen, if the</span>
        <span class="s6"># attached textinput is not on the screen anymore.</span>
        <span class="s1">parent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textinput</span>
        <span class="s2">while </span><span class="s1">parent </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">parent </span><span class="s3">== </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s1">parent </span><span class="s3">= </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">parent</span>
        <span class="s2">if </span><span class="s1">parent </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_parent_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textinput</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">textinput</span><span class="s3">.</span><span class="s1">_hide_cut_copy_paste</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">on_parent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s1">parent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textinput</span>
        <span class="s1">mode </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span>

        <span class="s2">if </span><span class="s1">parent</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">content</span><span class="s3">.</span><span class="s1">clear_widgets</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">'paste'</span><span class="s3">:</span>
                <span class="s6"># show only paste on long touch</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">but_selectall</span><span class="s3">.</span><span class="s1">opacity </span><span class="s3">= </span><span class="s5">1</span>
                <span class="s1">widget_list </span><span class="s3">= [</span><span class="s1">self</span><span class="s3">.</span><span class="s1">but_selectall</span><span class="s3">, ]</span>
                <span class="s2">if not </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">readonly</span><span class="s3">:</span>
                    <span class="s1">widget_list</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">but_paste</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">readonly</span><span class="s3">:</span>
                <span class="s6"># show only copy for read only text input</span>
                <span class="s1">widget_list </span><span class="s3">= (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">but_copy</span><span class="s3">, )</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># normal mode</span>
                <span class="s1">widget_list </span><span class="s3">= (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">but_cut</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">but_copy</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">but_paste</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">widget </span><span class="s2">in </span><span class="s1">widget_list</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">content</span><span class="s3">.</span><span class="s1">add_widget</span><span class="s3">(</span><span class="s1">widget</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">do</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">action</span><span class="s3">):</span>
        <span class="s1">textinput </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textinput</span>

        <span class="s2">if </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cut'</span><span class="s3">:</span>
            <span class="s1">textinput</span><span class="s3">.</span><span class="s1">_cut</span><span class="s3">(</span><span class="s1">textinput</span><span class="s3">.</span><span class="s1">selection_text</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'copy'</span><span class="s3">:</span>
            <span class="s1">textinput</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'paste'</span><span class="s3">:</span>
            <span class="s1">textinput</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'selectall'</span><span class="s3">:</span>
            <span class="s1">textinput</span><span class="s3">.</span><span class="s1">select_all</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s4">''</span>
            <span class="s1">anim </span><span class="s3">= </span><span class="s1">Animation</span><span class="s3">(</span><span class="s1">opacity</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">.333</span><span class="s3">)</span>
            <span class="s1">anim</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">on_complete</span><span class="s3">=</span><span class="s2">lambda </span><span class="s3">*</span><span class="s1">args</span><span class="s3">:</span>
                      <span class="s1">self</span><span class="s3">.</span><span class="s1">on_parent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">))</span>
            <span class="s1">anim</span><span class="s3">.</span><span class="s1">start</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">but_selectall</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">hide</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">hide</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">parent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent</span>
        <span class="s2">if not </span><span class="s1">parent</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">anim </span><span class="s3">= </span><span class="s1">Animation</span><span class="s3">(</span><span class="s1">opacity</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">.225</span><span class="s3">)</span>
        <span class="s1">anim</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">on_complete</span><span class="s3">=</span><span class="s2">lambda </span><span class="s3">*</span><span class="s1">args</span><span class="s3">: </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">remove_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">))</span>
        <span class="s1">anim</span><span class="s3">.</span><span class="s1">start</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TextInput</span><span class="s3">(</span><span class="s1">FocusBehavior</span><span class="s3">, </span><span class="s1">Widget</span><span class="s3">):</span>
    <span class="s0">'''TextInput class. See module documentation for more information. 
 
    :Events: 
        `on_text_validate` 
            Fired only in multiline=False mode when the user hits 'enter'. 
            This will also unfocus the textinput. 
        `on_double_tap` 
            Fired when a double tap happens in the text input. The default 
            behavior selects the text around the cursor position. More info at 
            :meth:`on_double_tap`. 
        `on_triple_tap` 
            Fired when a triple tap happens in the text input. The default 
            behavior selects the line around the cursor position. More info at 
            :meth:`on_triple_tap`. 
        `on_quad_touch` 
            Fired when four fingers are touching the text input. The default 
            behavior selects the whole text. More info at 
            :meth:`on_quad_touch`. 
 
    .. warning:: 
        When changing a :class:`TextInput` property that requires re-drawing, 
        e.g. modifying the :attr:`text`, the updates occur on the next 
        clock cycle and not instantly. This might cause any changes to the 
        :class:`TextInput` that occur between the modification and the next 
        cycle to be ignored, or to use previous values. For example, after 
        a update to the :attr:`text`, changing the cursor in the same clock 
        frame will move it using the previous text and will likely end up in an 
        incorrect position. The solution is to schedule any updates to occur 
        on the next clock cycle using 
        :meth:`~kivy.clock.ClockBase.schedule_once`. 
 
    .. Note:: 
        Selection is cancelled when TextInput is focused. If you need to 
        show selection when TextInput is focused, you should delay 
        (use Clock.schedule) the call to the functions for selecting 
        text (select_all, select_text). 
 
    .. versionchanged:: 1.10.0 
        `background_disabled_active` has been removed. 
 
    .. versionchanged:: 1.9.0 
 
        :class:`TextInput` now inherits from 
        :class:`~kivy.uix.behaviors.FocusBehavior`. 
        :attr:`~kivy.uix.behaviors.FocusBehavior.keyboard_mode`, 
        :meth:`~kivy.uix.behaviors.FocusBehavior.show_keyboard`, 
        :meth:`~kivy.uix.behaviors.FocusBehavior.hide_keyboard`, 
        :meth:`~kivy.uix.behaviors.FocusBehavior.focus`, 
        and :attr:`~kivy.uix.behaviors.FocusBehavior.input_type` 
        have been removed since they are now inherited 
        from :class:`~kivy.uix.behaviors.FocusBehavior`. 
 
    .. versionchanged:: 1.7.0 
        `on_double_tap`, `on_triple_tap` and `on_quad_touch` events added. 
 
    .. versionchanged:: 2.1.0 
        :attr:`~kivy.uix.behaviors.FocusBehavior.keyboard_suggestions` 
        is now inherited from :class:`~kivy.uix.behaviors.FocusBehavior`. 
    '''</span>

    <span class="s1">__events__ </span><span class="s3">= (</span><span class="s4">'on_text_validate'</span><span class="s3">, </span><span class="s4">'on_double_tap'</span><span class="s3">, </span><span class="s4">'on_triple_tap'</span><span class="s3">,</span>
                  <span class="s4">'on_quad_touch'</span><span class="s3">)</span>

    <span class="s1">_resolved_base_dir </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_graphics_ev </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_graphics</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">is_focusable </span><span class="s3">= </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'is_focusable'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text </span><span class="s3">= </span><span class="s4">u''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_callback </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_bubble </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_flags </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_labels </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_rects </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_line_options </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboard_mode </span><span class="s3">= </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'kivy'</span><span class="s3">, </span><span class="s4">'keyboard_mode'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_command_mode </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_command </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">reset_undo</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_count </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_l </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_r </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_l </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_r </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property_ev </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_long_touch_ev </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_do_blink_cursor_ev </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_do_blink_cursor</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">, </span><span class="s1">interval</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_line_options_ev </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_x </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_y </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_enable_scroll </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_have_scrolled </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s6"># [from; to) range of lines being partially or fully rendered</span>
        <span class="s6"># in TextInput's viewport</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_visible_lines_range </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">interesting_keys </span><span class="s3">= {</span>
            <span class="s5">8</span><span class="s3">: </span><span class="s4">'backspace'</span><span class="s3">,</span>
            <span class="s5">13</span><span class="s3">: </span><span class="s4">'enter'</span><span class="s3">,</span>
            <span class="s5">127</span><span class="s3">: </span><span class="s4">'del'</span><span class="s3">,</span>
            <span class="s5">271</span><span class="s3">: </span><span class="s4">'enter'</span><span class="s3">,</span>
            <span class="s5">273</span><span class="s3">: </span><span class="s4">'cursor_up'</span><span class="s3">,</span>
            <span class="s5">274</span><span class="s3">: </span><span class="s4">'cursor_down'</span><span class="s3">,</span>
            <span class="s5">275</span><span class="s3">: </span><span class="s4">'cursor_right'</span><span class="s3">,</span>
            <span class="s5">276</span><span class="s3">: </span><span class="s4">'cursor_left'</span><span class="s3">,</span>
            <span class="s5">278</span><span class="s3">: </span><span class="s4">'cursor_home'</span><span class="s3">,</span>
            <span class="s5">279</span><span class="s3">: </span><span class="s4">'cursor_end'</span><span class="s3">,</span>
            <span class="s5">280</span><span class="s3">: </span><span class="s4">'cursor_pgup'</span><span class="s3">,</span>
            <span class="s5">281</span><span class="s3">: </span><span class="s4">'cursor_pgdown'</span><span class="s3">,</span>
            <span class="s5">303</span><span class="s3">: </span><span class="s4">'shift_L'</span><span class="s3">,</span>
            <span class="s5">304</span><span class="s3">: </span><span class="s4">'shift_R'</span><span class="s3">,</span>
            <span class="s5">305</span><span class="s3">: </span><span class="s4">'ctrl_L'</span><span class="s3">,</span>
            <span class="s5">306</span><span class="s3">: </span><span class="s4">'ctrl_R'</span><span class="s3">,</span>
            <span class="s5">308</span><span class="s3">: </span><span class="s4">'alt_L'</span><span class="s3">,</span>
            <span class="s5">307</span><span class="s3">: </span><span class="s4">'alt_R'</span>
        <span class="s3">}</span>

        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s1">fbind </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fbind</span>
        <span class="s1">refresh_line_options </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_refresh_line_options</span>
        <span class="s1">update_text_options </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_update_text_options</span>
        <span class="s1">trigger_update_graphics </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span>

        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'font_size'</span><span class="s3">, </span><span class="s1">refresh_line_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'font_name'</span><span class="s3">, </span><span class="s1">refresh_line_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'font_context'</span><span class="s3">, </span><span class="s1">refresh_line_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'font_family'</span><span class="s3">, </span><span class="s1">refresh_line_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'base_direction'</span><span class="s3">, </span><span class="s1">refresh_line_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'text_language'</span><span class="s3">, </span><span class="s1">refresh_line_options</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">handle_readonly</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">value </span><span class="s2">and </span><span class="s3">(</span><span class="s2">not </span><span class="s1">_is_desktop </span><span class="s2">or not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allow_copy</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">is_focusable </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s2">not </span><span class="s3">(</span><span class="s1">value </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">disabled</span><span class="s3">) </span><span class="s2">or </span><span class="s1">_is_desktop </span><span class="s2">and</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboard_mode </span><span class="s3">== </span><span class="s4">'system'</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_editable </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_editable </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'padding'</span><span class="s3">, </span><span class="s1">update_text_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'tab_width'</span><span class="s3">, </span><span class="s1">update_text_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'font_size'</span><span class="s3">, </span><span class="s1">update_text_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'font_name'</span><span class="s3">, </span><span class="s1">update_text_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'size'</span><span class="s3">, </span><span class="s1">update_text_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'password'</span><span class="s3">, </span><span class="s1">update_text_options</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'password_mask'</span><span class="s3">, </span><span class="s1">update_text_options</span><span class="s3">)</span>

        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'pos'</span><span class="s3">, </span><span class="s1">trigger_update_graphics</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'halign'</span><span class="s3">, </span><span class="s1">trigger_update_graphics</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'readonly'</span><span class="s3">, </span><span class="s1">handle_readonly</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'focus'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_on_textinput_focused</span><span class="s3">)</span>
        <span class="s1">handle_readonly</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">readonly</span><span class="s3">)</span>

        <span class="s1">handles </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_position_handles </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_position_handles</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_show_handles </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_show_handles</span><span class="s3">, </span><span class="s5">.05</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_cursor_reset </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_reset_cursor_blink</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_cutbuffer </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_cutbuffer</span><span class="s3">)</span>
        <span class="s1">refresh_line_options</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_refresh_text</span><span class="s3">()</span>

        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'pos'</span><span class="s3">, </span><span class="s1">handles</span><span class="s3">)</span>
        <span class="s1">fbind</span><span class="s3">(</span><span class="s4">'size'</span><span class="s3">, </span><span class="s1">handles</span><span class="s3">)</span>

        <span class="s6"># when the gl context is reloaded, trigger the text rendering again.</span>
        <span class="s1">_textinput_list</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">TextInput</span><span class="s3">.</span><span class="s1">_reload_remove_observer</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">platform </span><span class="s3">== </span><span class="s4">'linux'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ensure_clipboard</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">on_text_validate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">cursor_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">'''Return the cursor index in the text/value. 
        '''</span>
        <span class="s2">if not </span><span class="s1">cursor</span><span class="s3">:</span>
            <span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
            <span class="s2">if not </span><span class="s1">lines</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s5">0</span>

            <span class="s1">flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span>
            <span class="s1">index</span><span class="s3">, </span><span class="s1">cursor_row </span><span class="s3">= </span><span class="s1">cursor</span>

            <span class="s2">for </span><span class="s1">_</span><span class="s3">, </span><span class="s1">line</span><span class="s3">, </span><span class="s1">flag </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span>
                <span class="s1">range</span><span class="s3">(</span><span class="s1">min</span><span class="s3">(</span><span class="s1">cursor_row</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">))),</span>
                <span class="s1">lines</span><span class="s3">,</span>
                <span class="s1">flags</span>
            <span class="s3">):</span>
                <span class="s1">index </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">flag </span><span class="s3">&amp; </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">:</span>
                    <span class="s1">index </span><span class="s3">+= </span><span class="s5">1</span>

            <span class="s2">if </span><span class="s1">flags</span><span class="s3">[</span><span class="s1">cursor_row</span><span class="s3">] &amp; </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">:</span>
                <span class="s1">index </span><span class="s3">+= </span><span class="s5">1</span>
            <span class="s2">return </span><span class="s1">index</span>

        <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">0</span>

    <span class="s2">def </span><span class="s1">cursor_offset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Get the cursor x offset on the current line. 
        '''</span>
        <span class="s1">offset </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">row </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row</span><span class="s3">)</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_col</span><span class="s3">)</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s2">if </span><span class="s1">col </span><span class="s2">and </span><span class="s1">row </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">):</span>
            <span class="s1">offset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_text_width</span><span class="s3">(</span>
                <span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">][:</span><span class="s1">col</span><span class="s3">],</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tab_width</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">offset</span>

    <span class="s2">def </span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">index</span><span class="s3">):</span>
        <span class="s0">'''Return the (col, row) of the cursor from text index. 
        '''</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">boundary</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">index </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>
        <span class="s1">flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s2">if not </span><span class="s1">lines</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>

        <span class="s1">i </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s2">for </span><span class="s1">row</span><span class="s3">, </span><span class="s1">line </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">):</span>
            <span class="s1">count </span><span class="s3">= </span><span class="s1">i </span><span class="s3">+ </span><span class="s1">len</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">flags</span><span class="s3">[</span><span class="s1">row</span><span class="s3">] &amp; </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">:</span>
                <span class="s1">count </span><span class="s3">+= </span><span class="s5">1</span>
                <span class="s1">i </span><span class="s3">+= </span><span class="s5">1</span>
            <span class="s2">if </span><span class="s1">count </span><span class="s3">&gt;= </span><span class="s1">index</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">index </span><span class="s3">- </span><span class="s1">i</span><span class="s3">, </span><span class="s1">row</span>
            <span class="s1">i </span><span class="s3">= </span><span class="s1">count</span>
        <span class="s2">return </span><span class="s1">int</span><span class="s3">(</span><span class="s1">index</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">row</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">select_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">):</span>
        <span class="s0">''' Select a portion of text displayed in this TextInput. 
 
        .. versionadded:: 1.4.0 
 
        :Parameters: 
            `start` 
                Index of textinput.text from where to start selection 
            `end` 
                Index of textinput.text till which the selection should be 
                displayed 
        '''</span>
        <span class="s2">if </span><span class="s1">end </span><span class="s3">&lt; </span><span class="s1">start</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s4">'end must be superior to start'</span><span class="s3">)</span>
        <span class="s1">text_length </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">boundary</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">text_length</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">boundary</span><span class="s3">(</span><span class="s1">end</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">text_length</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_graphics_selection</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">select_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">''' Select all of the text displayed in this TextInput. 
 
        .. versionadded:: 1.4.0 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">select_text</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">))</span>

    <span class="s1">re_indent </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'^(\s*|)'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_auto_indent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">index </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">_text </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span>
            <span class="s1">line_start </span><span class="s3">= </span><span class="s1">_text</span><span class="s3">.</span><span class="s1">rfind</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">index</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">line_start </span><span class="s3">&gt; -</span><span class="s5">1</span><span class="s3">:</span>
                <span class="s1">line </span><span class="s3">= </span><span class="s1">_text</span><span class="s3">[</span><span class="s1">line_start </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">:</span><span class="s1">index</span><span class="s3">]</span>
                <span class="s1">indent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">re_indent</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">line</span><span class="s3">).</span><span class="s1">group</span><span class="s3">()</span>
                <span class="s1">substring </span><span class="s3">+= </span><span class="s1">indent</span>
        <span class="s2">return </span><span class="s1">substring</span>

    <span class="s2">def </span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">'''Insert new text at the current cursor position. Override this 
        function in order to pre-process text for input validation. 
        '''</span>
        <span class="s1">_lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">_lines_flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">readonly </span><span class="s2">or not </span><span class="s1">substring </span><span class="s2">or not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">substring</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">substring </span><span class="s3">= </span><span class="s1">substring</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'utf8'</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">replace_crlf</span><span class="s3">:</span>
            <span class="s1">substring </span><span class="s3">= </span><span class="s1">substring</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">u'</span><span class="s2">\r\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_handles</span><span class="s3">(</span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">from_undo </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">auto_indent \</span>
                <span class="s2">and </span><span class="s1">substring </span><span class="s3">== </span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">:</span>
            <span class="s1">substring </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auto_indent</span><span class="s3">(</span><span class="s1">substring</span><span class="s3">)</span>

        <span class="s1">mode </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">input_filter</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s2">not in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">'int'</span><span class="s3">, </span><span class="s4">'float'</span><span class="s3">):</span>
            <span class="s1">substring </span><span class="s3">= </span><span class="s1">mode</span><span class="s3">(</span><span class="s1">substring</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">substring</span><span class="s3">:</span>
                <span class="s2">return</span>

        <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s1">cindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]</span>
        <span class="s1">len_str </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">substring</span><span class="s3">)</span>
        <span class="s1">new_text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">[:</span><span class="s1">col</span><span class="s3">] + </span><span class="s1">substring </span><span class="s3">+ </span><span class="s1">text</span><span class="s3">[</span><span class="s1">col</span><span class="s3">:]</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">'int'</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_insert_int_pat</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">):</span>
                    <span class="s2">return</span>
            <span class="s2">elif </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">'float'</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_insert_float_pat</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">):</span>
                    <span class="s2">return</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_line_text</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">len_str </span><span class="s3">&gt; </span><span class="s5">1 </span><span class="s2">or </span><span class="s1">substring </span><span class="s3">== </span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">' </span><span class="s2">or</span><span class="s1">\</span>
            <span class="s3">(</span><span class="s1">substring </span><span class="s3">== </span><span class="s4">u' ' </span><span class="s2">and </span><span class="s1">_lines_flags</span><span class="s3">[</span><span class="s1">row</span><span class="s3">] != </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">) </span><span class="s2">or</span><span class="s1">\</span>
            <span class="s3">(</span><span class="s1">row </span><span class="s3">+ </span><span class="s5">1 </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">_lines</span><span class="s3">) </span><span class="s2">and</span>
             <span class="s1">_lines_flags</span><span class="s3">[</span><span class="s1">row </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">] != </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">) </span><span class="s2">or</span><span class="s1">\</span>
            <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_text_width</span><span class="s3">(</span>
                <span class="s1">new_text</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tab_width</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached</span><span class="s3">) &gt; (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] -</span>
                                       <span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">2</span><span class="s3">])):</span>
            <span class="s6"># Avoid refreshing text on every keystroke.</span>
            <span class="s6"># Allows for faster typing of text when the amount of text in</span>
            <span class="s6"># TextInput gets large.</span>

            <span class="s3">(</span>
                <span class="s1">start</span><span class="s3">, </span><span class="s1">finish</span><span class="s3">, </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags</span><span class="s3">, </span><span class="s1">len_lines</span>
            <span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_from_cursor</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">)</span>

            <span class="s6"># calling trigger here could lead to wrong cursor positioning</span>
            <span class="s6"># and repeating of text when keys are added rapidly in a automated</span>
            <span class="s6"># fashion. From Android Keyboard for example.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">(</span>
                <span class="s4">'insert'</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">finish</span><span class="s3">, </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags</span><span class="s3">, </span><span class="s1">len_lines</span>
            <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">cindex </span><span class="s3">+ </span><span class="s1">len_str</span><span class="s3">)</span>
        <span class="s6"># handle undo and redo</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_unredo_insert</span><span class="s3">(</span><span class="s1">cindex</span><span class="s3">, </span><span class="s1">cindex </span><span class="s3">+ </span><span class="s1">len_str</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_line_from_cursor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">, </span><span class="s1">lines</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                              <span class="s1">lines_flags</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s6"># get current paragraph from cursor position</span>
        <span class="s2">if </span><span class="s1">lines </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s2">if </span><span class="s1">lines_flags </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">lines_flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span>
        <span class="s1">finish </span><span class="s3">= </span><span class="s1">start</span>
        <span class="s1">_next </span><span class="s3">= </span><span class="s1">start </span><span class="s3">+ </span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">start </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">and </span><span class="s1">lines_flags</span><span class="s3">[</span><span class="s1">start</span><span class="s3">] != </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">:</span>
            <span class="s1">start </span><span class="s3">-= </span><span class="s5">1</span>
            <span class="s1">new_text </span><span class="s3">= </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">start</span><span class="s3">] + </span><span class="s1">new_text</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">_next</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">_next</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines_flags</span><span class="s3">)):</span>
            <span class="s2">if </span><span class="s1">lines_flags</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] == </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">:</span>
                <span class="s1">finish </span><span class="s3">= </span><span class="s1">i </span><span class="s3">- </span><span class="s5">1</span>
                <span class="s2">break</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">finish </span><span class="s3">= </span><span class="s1">i</span>

        <span class="s1">new_text </span><span class="s3">= </span><span class="s1">new_text </span><span class="s3">+ </span><span class="s4">u''</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">_next</span><span class="s3">:</span><span class="s1">finish </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_split_smart</span><span class="s3">(</span><span class="s1">new_text</span><span class="s3">)</span>

        <span class="s1">len_lines </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">start</span><span class="s3">, </span><span class="s1">finish</span><span class="s3">, </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags</span><span class="s3">, </span><span class="s1">len_lines</span>

    <span class="s2">def </span><span class="s1">_set_unredo_insert</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">sci</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">):</span>
        <span class="s6"># handle undo and redo</span>
        <span class="s2">if </span><span class="s1">from_undo</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_undo</span><span class="s3">.</span><span class="s1">append</span><span class="s3">({</span>
            <span class="s4">'undo_command'</span><span class="s3">: (</span><span class="s4">'insert'</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">sci</span><span class="s3">),</span>
            <span class="s4">'redo_command'</span><span class="s3">: (</span><span class="s1">ci</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">)</span>
        <span class="s3">})</span>
        <span class="s6"># reset redo when undo is appended to</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_redo </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">reset_undo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Reset undo and redo lists from memory. 
 
        .. versionadded:: 1.3.0 
 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_redo </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_undo </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">do_redo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Do redo operation. 
 
        .. versionadded:: 1.3.0 
 
        This action re-does any command that has been un-done by 
        do_undo/ctrl+z. This function is automatically called when 
        `ctrl+r` keys are pressed. 
        '''</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">x_item </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_redo</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">undo_type </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s1">_get_cusror_from_index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span>

            <span class="s2">if </span><span class="s1">undo_type </span><span class="s3">== </span><span class="s4">'insert'</span><span class="s3">:</span>
                <span class="s1">cindex</span><span class="s3">, </span><span class="s1">substring </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'redo_command'</span><span class="s3">]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">_get_cusror_from_index</span><span class="s3">(</span><span class="s1">cindex</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">substring</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">undo_type </span><span class="s3">== </span><span class="s4">'bkspc'</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">_get_cusror_from_index</span><span class="s3">(</span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'redo_command'</span><span class="s3">])</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">do_backspace</span><span class="s3">(</span><span class="s1">from_undo</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">undo_type </span><span class="s3">== </span><span class="s4">'shiftln'</span><span class="s3">:</span>
                <span class="s1">direction</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">, </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'redo_command'</span><span class="s3">][</span><span class="s5">1</span><span class="s3">:]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_shift_lines</span><span class="s3">(</span><span class="s1">direction</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># delsel</span>
                <span class="s1">cindex</span><span class="s3">, </span><span class="s1">scindex </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'redo_command'</span><span class="s3">]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">cindex</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">scindex</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">_get_cusror_from_index</span><span class="s3">(</span><span class="s1">cindex</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_undo</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">x_item</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
            <span class="s6"># reached at top of undo list</span>
            <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">do_undo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Do undo operation. 
 
        .. versionadded:: 1.3.0 
 
        This action un-does any edits that have been made since the last 
        call to reset_undo(). 
        This function is automatically called when `ctrl+z` keys are pressed. 
        '''</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">x_item </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_undo</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">undo_type </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">1</span><span class="s3">])</span>

            <span class="s2">if </span><span class="s1">undo_type </span><span class="s3">== </span><span class="s4">'insert'</span><span class="s3">:</span>
                <span class="s1">cindex</span><span class="s3">, </span><span class="s1">scindex </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">1</span><span class="s3">:]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">cindex</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">scindex</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">undo_type </span><span class="s3">== </span><span class="s4">'bkspc'</span><span class="s3">:</span>
                <span class="s1">substring </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">2</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]</span>
                <span class="s1">mode </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">3</span><span class="s3">]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">substring</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">'del'</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">() - </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">undo_type </span><span class="s3">== </span><span class="s4">'shiftln'</span><span class="s3">:</span>
                <span class="s1">direction</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">, </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">1</span><span class="s3">:]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_shift_lines</span><span class="s3">(</span><span class="s1">direction</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># delsel</span>
                <span class="s1">substring </span><span class="s3">= </span><span class="s1">x_item</span><span class="s3">[</span><span class="s4">'undo_command'</span><span class="s3">][</span><span class="s5">2</span><span class="s3">:][</span><span class="s5">0</span><span class="s3">]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">substring</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_redo</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">x_item</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_max_scroll_x</span><span class="s3">()</span>
        <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
            <span class="s6"># reached at top of undo list</span>
            <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">do_backspace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'bkspc'</span><span class="s3">):</span>
        <span class="s0">'''Do backspace operation from the current cursor position. 
        This action might do several things: 
 
            - removing the current selection if available. 
            - removing the previous char and move the cursor back. 
            - do nothing, if we are at the start. 
 
        '''</span>
        <span class="s6"># IME system handles its own backspaces</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">readonly </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ime_composition</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s1">_lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">_lines_flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]</span>
        <span class="s1">cursor_index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">and </span><span class="s1">row </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">start </span><span class="s3">= </span><span class="s1">row</span>
        <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">_lines_flags</span><span class="s3">[</span><span class="s1">row</span><span class="s3">] == </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">:</span>
                <span class="s1">substring </span><span class="s3">= </span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span>
                <span class="s1">new_text </span><span class="s3">= </span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row </span><span class="s3">- </span><span class="s5">1</span><span class="s3">] + </span><span class="s1">text</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">substring </span><span class="s3">= </span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row </span><span class="s3">- </span><span class="s5">1</span><span class="s3">][-</span><span class="s5">1</span><span class="s3">] </span><span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row </span><span class="s3">- </span><span class="s5">1</span><span class="s3">]) &gt; </span><span class="s5">0 </span><span class="s1">\</span>
                    <span class="s2">else </span><span class="s4">u''</span>
                <span class="s1">new_text </span><span class="s3">= </span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row </span><span class="s3">- </span><span class="s5">1</span><span class="s3">][:-</span><span class="s5">1</span><span class="s3">] + </span><span class="s1">text</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_line_text</span><span class="s3">(</span><span class="s1">row </span><span class="s3">- </span><span class="s5">1</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_delete_line</span><span class="s3">(</span><span class="s1">row</span><span class="s3">)</span>
            <span class="s1">start </span><span class="s3">= </span><span class="s1">row </span><span class="s3">- </span><span class="s5">1</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s6"># ch = text[col-1]</span>
            <span class="s1">substring </span><span class="s3">= </span><span class="s1">text</span><span class="s3">[</span><span class="s1">col </span><span class="s3">- </span><span class="s5">1</span><span class="s3">]</span>
            <span class="s1">new_text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">[:</span><span class="s1">col </span><span class="s3">- </span><span class="s5">1</span><span class="s3">] + </span><span class="s1">text</span><span class="s3">[</span><span class="s1">col</span><span class="s3">:]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_line_text</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">)</span>

        <span class="s6"># refresh just the current line instead of the whole text</span>
        <span class="s1">start</span><span class="s3">, </span><span class="s1">finish</span><span class="s3">, </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">lineflags</span><span class="s3">, </span><span class="s1">len_lines </span><span class="s3">= (</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_from_cursor</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s6"># avoid trigger refresh, leads to issue with</span>
        <span class="s6"># keys/text send rapidly through code.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">(</span>
            <span class="s4">'insert' </span><span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">else </span><span class="s4">'del'</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">finish</span><span class="s3">,</span>
            <span class="s1">lines</span><span class="s3">, </span><span class="s1">lineflags</span><span class="s3">, </span><span class="s1">len_lines</span>
        <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">cursor_index </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s6"># handle undo and redo</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_unredo_bkspc</span><span class="s3">(</span>
            <span class="s1">cursor_index</span><span class="s3">,</span>
            <span class="s1">cursor_index </span><span class="s3">- </span><span class="s5">1</span><span class="s3">,</span>
            <span class="s1">substring</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_max_scroll_x</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_set_unredo_bkspc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ol_index</span><span class="s3">, </span><span class="s1">new_index</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">,</span>
                          <span class="s1">mode</span><span class="s3">):</span>
        <span class="s6"># handle undo and redo for backspace</span>
        <span class="s2">if </span><span class="s1">from_undo</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_undo</span><span class="s3">.</span><span class="s1">append</span><span class="s3">({</span>
            <span class="s4">'undo_command'</span><span class="s3">: (</span><span class="s4">'bkspc'</span><span class="s3">, </span><span class="s1">new_index</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">),</span>
            <span class="s4">'redo_command'</span><span class="s3">: </span><span class="s1">ol_index</span><span class="s3">})</span>
        <span class="s6"># reset redo when undo is appended to</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_redo </span><span class="s3">= []</span>

    <span class="s1">_re_whitespace </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'\s+'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_move_cursor_word_left</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">pos </span><span class="s3">= </span><span class="s1">index </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">pos </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">row </span><span class="s3">-= </span><span class="s5">1</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">])</span>

        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">matches </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_re_whitespace</span><span class="s3">.</span><span class="s1">finditer</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, </span><span class="s1">col</span><span class="s3">))</span>
            <span class="s2">if not </span><span class="s1">matches</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">row </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                        <span class="s2">return </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>
                    <span class="s1">row </span><span class="s3">-= </span><span class="s5">1</span>
                    <span class="s1">col </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">])</span>
                    <span class="s2">continue</span>
                <span class="s2">return </span><span class="s5">0</span><span class="s3">, </span><span class="s1">row</span>

            <span class="s1">match </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s1">mpos </span><span class="s3">= </span><span class="s1">match</span><span class="s3">.</span><span class="s1">end</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">mpos </span><span class="s3">== </span><span class="s1">col</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">matches</span><span class="s3">) &gt; </span><span class="s5">1</span><span class="s3">:</span>
                    <span class="s1">match </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">]</span>
                    <span class="s1">mpos </span><span class="s3">= </span><span class="s1">match</span><span class="s3">.</span><span class="s1">end</span><span class="s3">()</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">start</span><span class="s3">() == </span><span class="s5">0</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">row </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                            <span class="s2">return </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>
                        <span class="s1">row </span><span class="s3">-= </span><span class="s5">1</span>
                        <span class="s1">col </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">])</span>
                        <span class="s2">continue</span>
                    <span class="s2">return </span><span class="s5">0</span><span class="s3">, </span><span class="s1">row</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">mpos</span>
            <span class="s2">return </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>

    <span class="s2">def </span><span class="s1">_move_cursor_word_right</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">pos </span><span class="s3">= </span><span class="s1">index </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
        <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">)</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">mrow </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">row </span><span class="s3">== </span><span class="s1">mrow </span><span class="s2">and </span><span class="s1">col </span><span class="s3">== </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]):</span>
            <span class="s2">return </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>
        <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]):</span>
            <span class="s1">row </span><span class="s3">+= </span><span class="s5">1</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s5">0</span>

        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">matches </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_re_whitespace</span><span class="s3">.</span><span class="s1">finditer</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">], </span><span class="s1">col</span><span class="s3">))</span>
            <span class="s2">if not </span><span class="s1">matches</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]):</span>
                    <span class="s2">if </span><span class="s1">row </span><span class="s3">== </span><span class="s1">mrow</span><span class="s3">:</span>
                        <span class="s2">return </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>
                    <span class="s1">row </span><span class="s3">+= </span><span class="s5">1</span>
                    <span class="s1">col </span><span class="s3">= </span><span class="s5">0</span>
                    <span class="s2">continue</span>
                <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]), </span><span class="s1">row</span>

            <span class="s1">match </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s1">mpos </span><span class="s3">= </span><span class="s1">match</span><span class="s3">.</span><span class="s1">start</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">mpos </span><span class="s3">== </span><span class="s1">col</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">matches</span><span class="s3">) &gt; </span><span class="s5">1</span><span class="s3">:</span>
                    <span class="s1">match </span><span class="s3">= </span><span class="s1">matches</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
                    <span class="s1">mpos </span><span class="s3">= </span><span class="s1">match</span><span class="s3">.</span><span class="s1">start</span><span class="s3">()</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">match</span><span class="s3">.</span><span class="s1">end</span><span class="s3">() == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]):</span>
                        <span class="s2">if </span><span class="s1">row </span><span class="s3">== </span><span class="s1">mrow</span><span class="s3">:</span>
                            <span class="s2">return </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>
                        <span class="s1">row </span><span class="s3">+= </span><span class="s5">1</span>
                        <span class="s1">col </span><span class="s3">= </span><span class="s5">0</span>
                        <span class="s2">continue</span>
                    <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]), </span><span class="s1">row</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">mpos</span>
            <span class="s2">return </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>

    <span class="s2">def </span><span class="s1">_expand_range</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ifrom</span><span class="s3">, </span><span class="s1">ito</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">ito </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">ito </span><span class="s3">= </span><span class="s1">ifrom</span>
        <span class="s1">rfrom </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">ifrom</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">rtcol</span><span class="s3">, </span><span class="s1">rto </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">ito</span><span class="s3">)</span>
        <span class="s1">rfrom</span><span class="s3">, </span><span class="s1">rto </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_expand_rows</span><span class="s3">(</span><span class="s1">rfrom</span><span class="s3">, </span><span class="s1">rto </span><span class="s3">+ </span><span class="s5">1 </span><span class="s2">if </span><span class="s1">rtcol </span><span class="s2">else </span><span class="s1">rto</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s1">rfrom</span><span class="s3">)),</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s1">rto</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">_expand_rows</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rfrom</span><span class="s3">, </span><span class="s1">rto</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">rto </span><span class="s2">is None or </span><span class="s1">rto </span><span class="s3">== </span><span class="s1">rfrom</span><span class="s3">:</span>
            <span class="s1">rto </span><span class="s3">= </span><span class="s1">rfrom </span><span class="s3">+ </span><span class="s5">1</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">flags </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span><span class="s3">))</span>
        <span class="s2">while </span><span class="s1">rfrom </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">and not </span><span class="s3">(</span><span class="s1">flags</span><span class="s3">[</span><span class="s1">rfrom </span><span class="s3">- </span><span class="s5">1</span><span class="s3">] &amp; </span><span class="s1">FL_IS_NEWLINE</span><span class="s3">):</span>
            <span class="s1">rfrom </span><span class="s3">-= </span><span class="s5">1</span>
        <span class="s1">rmax </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s5">1</span>
        <span class="s2">while </span><span class="s5">0 </span><span class="s3">&lt; </span><span class="s1">rto </span><span class="s3">&lt; </span><span class="s1">rmax </span><span class="s2">and not </span><span class="s3">(</span><span class="s1">flags</span><span class="s3">[</span><span class="s1">rto </span><span class="s3">- </span><span class="s5">1</span><span class="s3">] &amp; </span><span class="s1">FL_IS_NEWLINE</span><span class="s3">):</span>
            <span class="s1">rto </span><span class="s3">+= </span><span class="s5">1</span>
        <span class="s2">return </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">rfrom</span><span class="s3">), </span><span class="s1">min</span><span class="s3">(</span><span class="s1">rmax</span><span class="s3">, </span><span class="s1">rto</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_shift_lines</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">old_cursor</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_callback</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">from_undo</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_callback</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return</span>

        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">flags </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span><span class="s3">))</span>
        <span class="s1">labels </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels</span>
        <span class="s1">rects </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects</span>
        <span class="s1">orig_cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s1">sel </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">old_cursor </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">old_cursor</span>

        <span class="s2">if not </span><span class="s1">rows</span><span class="s3">:</span>
            <span class="s1">sindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_from</span>
            <span class="s1">eindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_to</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">sindex </span><span class="s2">or </span><span class="s1">eindex</span><span class="s3">) </span><span class="s2">and </span><span class="s1">sindex </span><span class="s3">!= </span><span class="s1">eindex</span><span class="s3">:</span>
                <span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">((</span><span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex</span><span class="s3">)))</span>
                <span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_expand_range</span><span class="s3">(</span><span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_expand_range</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">())</span>
            <span class="s1">srow </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">sindex</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s1">erow </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">eindex</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s1">sel </span><span class="s3">= </span><span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex</span>

            <span class="s2">if </span><span class="s1">direction </span><span class="s3">&lt; </span><span class="s5">0 </span><span class="s2">and </span><span class="s1">srow </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s1">psrow</span><span class="s3">, </span><span class="s1">perow </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_expand_rows</span><span class="s3">(</span><span class="s1">srow </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)</span>
                <span class="s1">rows </span><span class="s3">= ((</span><span class="s1">srow</span><span class="s3">, </span><span class="s1">erow</span><span class="s3">), (</span><span class="s1">psrow</span><span class="s3">, </span><span class="s1">perow</span><span class="s3">))</span>
            <span class="s2">elif </span><span class="s1">direction </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">and </span><span class="s1">erow </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">:</span>
                <span class="s1">psrow</span><span class="s3">, </span><span class="s1">perow </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_expand_rows</span><span class="s3">(</span><span class="s1">erow</span><span class="s3">)</span>
                <span class="s1">rows </span><span class="s3">= ((</span><span class="s1">srow</span><span class="s3">, </span><span class="s1">erow</span><span class="s3">), (</span><span class="s1">psrow</span><span class="s3">, </span><span class="s1">perow</span><span class="s3">))</span>

        <span class="s2">else</span><span class="s3">:</span>
            <span class="s3">(</span><span class="s1">srow</span><span class="s3">, </span><span class="s1">erow</span><span class="s3">), (</span><span class="s1">psrow</span><span class="s3">, </span><span class="s1">perow</span><span class="s3">) = </span><span class="s1">rows</span>
            <span class="s2">if </span><span class="s1">direction </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s1">m1srow</span><span class="s3">, </span><span class="s1">m1erow </span><span class="s3">= </span><span class="s1">psrow</span><span class="s3">, </span><span class="s1">perow</span>
                <span class="s1">m2srow</span><span class="s3">, </span><span class="s1">m2erow </span><span class="s3">= </span><span class="s1">srow</span><span class="s3">, </span><span class="s1">erow</span>
                <span class="s1">cdiff </span><span class="s3">= </span><span class="s1">psrow </span><span class="s3">- </span><span class="s1">perow</span>
                <span class="s1">xdiff </span><span class="s3">= </span><span class="s1">srow </span><span class="s3">- </span><span class="s1">erow</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">m1srow</span><span class="s3">, </span><span class="s1">m1erow </span><span class="s3">= </span><span class="s1">srow</span><span class="s3">, </span><span class="s1">erow</span>
                <span class="s1">m2srow</span><span class="s3">, </span><span class="s1">m2erow </span><span class="s3">= </span><span class="s1">psrow</span><span class="s3">, </span><span class="s1">perow</span>
                <span class="s1">cdiff </span><span class="s3">= </span><span class="s1">perow </span><span class="s3">- </span><span class="s1">psrow</span>
                <span class="s1">xdiff </span><span class="s3">= </span><span class="s1">erow </span><span class="s3">- </span><span class="s1">srow</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">chain</span><span class="s3">(</span>
                <span class="s1">flags</span><span class="s3">[:</span><span class="s1">m1srow</span><span class="s3">],</span>
                <span class="s1">flags</span><span class="s3">[</span><span class="s1">m2srow</span><span class="s3">:</span><span class="s1">m2erow</span><span class="s3">],</span>
                <span class="s1">flags</span><span class="s3">[</span><span class="s1">m1srow</span><span class="s3">:</span><span class="s1">m1erow</span><span class="s3">],</span>
                <span class="s1">flags</span><span class="s3">[</span><span class="s1">m2erow</span><span class="s3">:],</span>
            <span class="s3">)))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[:] = (</span>
                <span class="s1">lines</span><span class="s3">[:</span><span class="s1">m1srow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">m2srow</span><span class="s3">:</span><span class="s1">m2erow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">m1srow</span><span class="s3">:</span><span class="s1">m1erow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">m2erow</span><span class="s3">:]</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels </span><span class="s3">= (</span>
                <span class="s1">labels</span><span class="s3">[:</span><span class="s1">m1srow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">labels</span><span class="s3">[</span><span class="s1">m2srow</span><span class="s3">:</span><span class="s1">m2erow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">labels</span><span class="s3">[</span><span class="s1">m1srow</span><span class="s3">:</span><span class="s1">m1erow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">labels</span><span class="s3">[</span><span class="s1">m2erow</span><span class="s3">:]</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects </span><span class="s3">= (</span>
                <span class="s1">rects</span><span class="s3">[:</span><span class="s1">m1srow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">rects</span><span class="s3">[</span><span class="s1">m2srow</span><span class="s3">:</span><span class="s1">m2erow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">rects</span><span class="s3">[</span><span class="s1">m1srow</span><span class="s3">:</span><span class="s1">m1erow</span><span class="s3">]</span>
                <span class="s3">+ </span><span class="s1">rects</span><span class="s3">[</span><span class="s1">m2erow</span><span class="s3">:]</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
            <span class="s1">csrow </span><span class="s3">= </span><span class="s1">srow </span><span class="s3">+ </span><span class="s1">cdiff</span>
            <span class="s1">cerow </span><span class="s3">= </span><span class="s1">erow </span><span class="s3">+ </span><span class="s1">cdiff</span>
            <span class="s1">sel </span><span class="s3">= (</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s1">csrow</span><span class="s3">)),</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s1">cerow</span><span class="s3">))</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_col</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row </span><span class="s3">+ </span><span class="s1">cdiff</span>

            <span class="s2">if not </span><span class="s1">from_undo</span><span class="s3">:</span>
                <span class="s1">undo_rows </span><span class="s3">= ((</span><span class="s1">srow </span><span class="s3">+ </span><span class="s1">cdiff</span><span class="s3">, </span><span class="s1">erow </span><span class="s3">+ </span><span class="s1">cdiff</span><span class="s3">),</span>
                             <span class="s3">(</span><span class="s1">psrow </span><span class="s3">- </span><span class="s1">xdiff</span><span class="s3">, </span><span class="s1">perow </span><span class="s3">- </span><span class="s1">xdiff</span><span class="s3">))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_undo</span><span class="s3">.</span><span class="s1">append</span><span class="s3">({</span>
                    <span class="s4">'undo_command'</span><span class="s3">: (</span><span class="s4">'shiftln'</span><span class="s3">, </span><span class="s1">direction </span><span class="s3">* -</span><span class="s5">1</span><span class="s3">, </span><span class="s1">undo_rows</span><span class="s3">,</span>
                                     <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">),</span>
                    <span class="s4">'redo_command'</span><span class="s3">: (</span><span class="s4">'shiftln'</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">, </span><span class="s1">orig_cursor</span><span class="s3">),</span>
                <span class="s3">})</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_redo </span><span class="s3">= []</span>

        <span class="s2">if </span><span class="s1">sel</span><span class="s3">:</span>
            <span class="s2">def </span><span class="s1">cb</span><span class="s3">(</span><span class="s1">dt</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">select_text</span><span class="s3">(*</span><span class="s1">sel</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_callback </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_callback </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_once</span><span class="s3">(</span><span class="s1">cb</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">pgmove_speed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;how much vertical distance hitting pg_up or pg_down will move 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">int</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">height</span>
            <span class="s3">/ (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span><span class="s3">) - </span><span class="s5">1</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_move_cursor_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">control</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">alt</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline </span><span class="s2">and </span><span class="s1">control</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span><span class="s3">)</span>
        <span class="s2">elif not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">readonly </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline </span><span class="s2">and </span><span class="s1">alt</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_shift_lines</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">row </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">row </span><span class="s3">- </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]), </span><span class="s1">col</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>

    <span class="s2">def </span><span class="s1">_move_cursor_down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">control</span><span class="s3">, </span><span class="s1">alt</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline </span><span class="s2">and </span><span class="s1">control</span><span class="s3">:</span>
            <span class="s1">maxy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">minimum_height </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">height</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span>
                <span class="s5">0</span><span class="s3">,</span>
                <span class="s1">min</span><span class="s3">(</span><span class="s1">maxy</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s2">elif not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">readonly </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline </span><span class="s2">and </span><span class="s1">alt</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_shift_lines</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">row </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">row </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]), </span><span class="s1">col</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>

    <span class="s2">def </span><span class="s1">do_cursor_movement</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">action</span><span class="s3">, </span><span class="s1">control</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">alt</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">'''Move the cursor relative to its current position. 
        Action can be one of : 
 
            - cursor_left: move the cursor to the left 
            - cursor_right: move the cursor to the right 
            - cursor_up: move the cursor on the previous line 
            - cursor_down: move the cursor on the next line 
            - cursor_home: move the cursor at the start of the current line 
            - cursor_end: move the cursor at the end of current line 
            - cursor_pgup: move one &quot;page&quot; before 
            - cursor_pgdown: move one &quot;page&quot; after 
 
        In addition, the behavior of certain actions can be modified: 
 
            - control + cursor_left: move the cursor one word to the left 
            - control + cursor_right: move the cursor one word to the right 
            - control + cursor_up: scroll up one line 
            - control + cursor_down: scroll down one line 
            - control + cursor_home: go to beginning of text 
            - control + cursor_end: go to end of text 
            - alt + cursor_up: shift line(s) up 
            - alt + cursor_down: shift line(s) down 
 
        .. versionchanged:: 1.9.1 
 
        '''</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s2">if </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_up'</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_move_cursor_up</span><span class="s3">(</span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">control</span><span class="s3">, </span><span class="s1">alt</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">result</span><span class="s3">:</span>
                <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">result</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return</span>

        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_down'</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_move_cursor_down</span><span class="s3">(</span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">control</span><span class="s3">, </span><span class="s1">alt</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">result</span><span class="s3">:</span>
                <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">result</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return</span>

        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_home'</span><span class="s3">:</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s2">if </span><span class="s1">control</span><span class="s3">:</span>
                <span class="s1">row </span><span class="s3">= </span><span class="s5">0</span>

        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_end'</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">control</span><span class="s3">:</span>
                <span class="s1">row </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">) - </span><span class="s5">1</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">])</span>

        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_pgup'</span><span class="s3">:</span>
            <span class="s1">row </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">row </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pgmove_speed</span><span class="s3">)</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]), </span><span class="s1">col</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_pgdown'</span><span class="s3">:</span>
            <span class="s1">row </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">row </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pgmove_speed</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">col </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]), </span><span class="s1">col</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished</span>
            <span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">&lt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span>
            <span class="s2">and </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_left'</span>
        <span class="s3">):</span>
            <span class="s1">current_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span>
            <span class="s2">while </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">!= </span><span class="s1">current_selection_to</span><span class="s3">:</span>
                <span class="s1">current_selection_to </span><span class="s3">-= </span><span class="s5">1</span>
                <span class="s2">if </span><span class="s1">col</span><span class="s3">:</span>
                    <span class="s1">col </span><span class="s3">-= </span><span class="s5">1</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">row </span><span class="s3">-= </span><span class="s5">1</span>
                    <span class="s1">col </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">])</span>

        <span class="s2">elif </span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished</span>
            <span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">&gt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span>
            <span class="s2">and </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_right'</span>
        <span class="s3">):</span>
            <span class="s1">current_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span>
            <span class="s2">while </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">!= </span><span class="s1">current_selection_to</span><span class="s3">:</span>
                <span class="s1">current_selection_to </span><span class="s3">+= </span><span class="s5">1</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]) &gt; </span><span class="s1">col</span><span class="s3">:</span>
                    <span class="s1">col </span><span class="s3">+= </span><span class="s5">1</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">row </span><span class="s3">+= </span><span class="s5">1</span>
                    <span class="s1">col </span><span class="s3">= </span><span class="s5">0</span>

        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_left'</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password </span><span class="s2">and </span><span class="s1">control</span><span class="s3">:</span>
                <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_move_cursor_word_left</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">row</span><span class="s3">:</span>
                        <span class="s1">row </span><span class="s3">-= </span><span class="s5">1</span>
                        <span class="s1">col </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">])</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">col </span><span class="s3">- </span><span class="s5">1</span><span class="s3">, </span><span class="s1">row</span>

        <span class="s2">elif </span><span class="s1">action </span><span class="s3">== </span><span class="s4">'cursor_right'</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password </span><span class="s2">and </span><span class="s1">control</span><span class="s3">:</span>
                <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_move_cursor_word_right</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">col </span><span class="s3">== </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">row</span><span class="s3">]):</span>
                    <span class="s2">if </span><span class="s1">row </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">:</span>
                        <span class="s1">col </span><span class="s3">= </span><span class="s5">0</span>
                        <span class="s1">row </span><span class="s3">+= </span><span class="s5">1</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">col</span><span class="s3">, </span><span class="s1">row </span><span class="s3">= </span><span class="s1">col </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">row</span>

        <span class="s1">dont_move_cursor </span><span class="s3">= </span><span class="s1">control </span><span class="s2">and </span><span class="s1">action </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'cursor_up'</span><span class="s3">, </span><span class="s4">'cursor_down'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">dont_move_cursor</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">col</span><span class="s3">, </span><span class="s1">row</span>

    <span class="s2">def </span><span class="s1">get_cursor_from_xy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s0">'''Return the (col, row) of the cursor from an (x, y) position. 
        '''</span>
        <span class="s1">padding_left</span><span class="s3">, </span><span class="s1">padding_top</span><span class="s3">, </span><span class="s1">padding_right</span><span class="s3">, </span><span class="s1">padding_bottom </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span>

        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">dy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span>
        <span class="s1">cursor_x </span><span class="s3">= </span><span class="s1">x </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span>
        <span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y</span>
        <span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>
        <span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">scroll_y </span><span class="s3">/ </span><span class="s1">dy </span><span class="s2">if </span><span class="s1">scroll_y </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">else </span><span class="s5">0</span>

        <span class="s1">cursor_y </span><span class="s3">= (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">top </span><span class="s3">- </span><span class="s1">padding_top </span><span class="s3">+ </span><span class="s1">scroll_y </span><span class="s3">* </span><span class="s1">dy</span><span class="s3">) - </span><span class="s1">y</span>
        <span class="s1">cursor_y </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">boundary</span><span class="s3">(</span>
            <span class="s1">round</span><span class="s3">(</span><span class="s1">cursor_y </span><span class="s3">/ </span><span class="s1">dy </span><span class="s3">- </span><span class="s5">0.5</span><span class="s3">),</span>
            <span class="s5">0</span><span class="s3">,</span>
            <span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s5">1</span>
        <span class="s3">))</span>

        <span class="s1">get_text_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_text_width</span>
        <span class="s1">tab_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tab_width</span>
        <span class="s1">label_cached </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached</span>

        <span class="s6"># Offset for horizontal text alignment</span>
        <span class="s1">xoff </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">halign </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">halign</span>
        <span class="s1">base_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_direction </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolved_base_dir</span>
        <span class="s1">auto_halign_r </span><span class="s3">= </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'auto' </span><span class="s2">and </span><span class="s1">base_dir </span><span class="s2">and </span><span class="s4">'rtl' </span><span class="s2">in </span><span class="s1">base_dir</span>

        <span class="s2">if </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'center'</span><span class="s3">:</span>
            <span class="s1">viewport_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s1">padding_left </span><span class="s3">- </span><span class="s1">padding_right</span>
            <span class="s1">xoff </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span>
                <span class="s5">0</span><span class="s3">, </span><span class="s1">int</span><span class="s3">((</span><span class="s1">viewport_width </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_row_width</span><span class="s3">(</span><span class="s1">cursor_y</span><span class="s3">)) / </span><span class="s5">2</span><span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'right' </span><span class="s2">or </span><span class="s1">auto_halign_r</span><span class="s3">:</span>
            <span class="s1">viewport_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s1">padding_left </span><span class="s3">- </span><span class="s1">padding_right</span>
            <span class="s1">xoff </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span>
                <span class="s5">0</span><span class="s3">, </span><span class="s1">int</span><span class="s3">(</span><span class="s1">viewport_width </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_row_width</span><span class="s3">(</span><span class="s1">cursor_y</span><span class="s3">))</span>
            <span class="s3">)</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">cursor_y</span><span class="s3">])):</span>
            <span class="s1">line_y </span><span class="s3">= </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">cursor_y</span><span class="s3">]</span>

            <span class="s2">if </span><span class="s1">cursor_x </span><span class="s3">+ </span><span class="s1">scroll_x </span><span class="s3">&lt; (</span>
                <span class="s1">xoff</span>
                <span class="s3">+ </span><span class="s1">get_text_width</span><span class="s3">(</span><span class="s1">line_y</span><span class="s3">[:</span><span class="s1">i</span><span class="s3">], </span><span class="s1">tab_width</span><span class="s3">, </span><span class="s1">label_cached</span><span class="s3">)</span>
                <span class="s3">+ </span><span class="s1">get_text_width</span><span class="s3">(</span><span class="s1">line_y</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">tab_width</span><span class="s3">, </span><span class="s1">label_cached</span><span class="s3">) * </span><span class="s5">0.6</span>
                <span class="s3">+ </span><span class="s1">padding_left</span>
            <span class="s3">):</span>
                <span class="s1">cursor_x </span><span class="s3">= </span><span class="s1">i</span>
                <span class="s2">break</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">cursor_x </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">[</span><span class="s1">cursor_y</span><span class="s3">])</span>

        <span class="s2">return </span><span class="s1">cursor_x</span><span class="s3">, </span><span class="s1">cursor_y</span>

    <span class="s2">def </span><span class="s1">get_max_scroll_x</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">''' 
        Return how many pixels it needs to scroll to the right 
        to reveal the remaining content of a text that extends 
        beyond the visible width of a TextInput 
        '''</span>
        <span class="s1">minimum_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_row_width</span><span class="s3">(</span><span class="s5">0</span><span class="s3">) + </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]</span>
        <span class="s1">max_scroll_x </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">minimum_width </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">max_scroll_x</span>

    <span class="s6">#</span>
    <span class="s6"># Selection control</span>
    <span class="s6">#</span>
    <span class="s2">def </span><span class="s1">cancel_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''Cancel current selection (if any). 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text </span><span class="s3">= </span><span class="s4">u''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">delete_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">'''Delete the current text selection (if any). 
        '''</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">readonly</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_handles</span><span class="s3">(</span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">)</span>
        <span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>
        <span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y</span>
        <span class="s1">cc</span><span class="s3">, </span><span class="s1">cr </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">((</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span><span class="s3">))</span>

        <span class="s1">start </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">finish </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>
        <span class="s1">cur_line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">start</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]][:</span><span class="s1">start</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]] +</span><span class="s1">\</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">finish</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]][</span><span class="s1">finish</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]:]</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_line_text</span><span class="s3">(</span><span class="s1">start</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">cur_line</span><span class="s3">)</span>
        <span class="s1">start_del</span><span class="s3">, </span><span class="s1">finish_del</span><span class="s3">, </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags</span><span class="s3">, </span><span class="s1">len_lines </span><span class="s3">= </span><span class="s1">\</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_from_cursor</span><span class="s3">(</span><span class="s1">start</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">cur_line</span><span class="s3">,</span>
                                       <span class="s1">lines</span><span class="s3">=(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[:(</span><span class="s1">start</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">)] +</span>
                                              <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[(</span><span class="s1">finish</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">):]),</span>
                                       <span class="s1">lines_flags</span><span class="s3">=(</span>
                                           <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span><span class="s3">[:(</span><span class="s1">start</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">)] +</span>
                                           <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span><span class="s3">[(</span><span class="s1">finish</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s5">1</span><span class="s3">):])</span>
                                       <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">(</span><span class="s4">'del'</span><span class="s3">, </span><span class="s1">start_del</span><span class="s3">,</span>
                                         <span class="s1">finish_del </span><span class="s3">+ (</span><span class="s1">finish</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] - </span><span class="s1">start</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]),</span>
                                         <span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags</span><span class="s3">, </span><span class="s1">len_lines</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">scroll_x</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">scroll_y</span>
        <span class="s6"># handle undo and redo for delete selection</span>
        <span class="s2">if </span><span class="s1">text</span><span class="s3">[</span><span class="s1">a</span><span class="s3">:</span><span class="s1">b</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_unredo_delsel</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">text</span><span class="s3">[</span><span class="s1">a</span><span class="s3">:</span><span class="s1">b</span><span class="s3">], </span><span class="s1">from_undo</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cancel_selection</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_set_unredo_delsel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">):</span>
        <span class="s6"># handle undo and redo for backspace</span>
        <span class="s2">if </span><span class="s1">from_undo</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_undo</span><span class="s3">.</span><span class="s1">append</span><span class="s3">({</span>
            <span class="s4">'undo_command'</span><span class="s3">: (</span><span class="s4">'delsel'</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">substring</span><span class="s3">),</span>
            <span class="s4">'redo_command'</span><span class="s3">: (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)})</span>
        <span class="s6"># reset redo when undo is appended to</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_redo </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">_update_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">finished</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">'''Update selection text and order of from/to if finished is True. 
        Can be called multiple times until finished is True. 
        '''</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">a </span><span class="s3">&gt; </span><span class="s1">b</span><span class="s3">:</span>
            <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= </span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished </span><span class="s3">= </span><span class="s1">finished</span>
        <span class="s1">_selection_text </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">[</span><span class="s1">a</span><span class="s3">:</span><span class="s1">b</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text </span><span class="s3">= (</span><span class="s4">&quot;&quot; </span><span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allow_copy </span><span class="s2">else</span>
                               <span class="s3">((</span><span class="s1">self</span><span class="s3">.</span><span class="s1">password_mask </span><span class="s3">* (</span><span class="s1">b </span><span class="s3">- </span><span class="s1">a</span><span class="s3">)) </span><span class="s2">if</span>
                                <span class="s1">self</span><span class="s3">.</span><span class="s1">password </span><span class="s2">else </span><span class="s1">_selection_text</span><span class="s3">))</span>
        <span class="s2">if not </span><span class="s1">finished</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">_selection_text</span><span class="s3">))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">a </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s6"># update graphics only on new line</span>
            <span class="s6"># allows smoother scrolling, noticeably</span>
            <span class="s6"># faster when dealing with large text.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_graphics_selection</span><span class="s3">()</span>
            <span class="s6"># self._trigger_update_graphics()</span>

    <span class="s6">#</span>
    <span class="s6"># Touch control</span>
    <span class="s6">#</span>
    <span class="s2">def </span><span class="s1">long_touch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_long_touch_ev </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">:</span>
            <span class="s1">pos </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_local</span><span class="s3">(*</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_down</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">relative</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_show_cut_copy_paste</span><span class="s3">(</span>
                <span class="s1">pos</span><span class="s3">, </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'paste'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cancel_long_touch_event</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># schedule long touch for paste</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_long_touch_ev </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_long_touch_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_long_touch_ev </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">_select_word</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">delimiters</span><span class="s3">=</span><span class="s4">u' .,:;!?</span><span class="s2">\'</span><span class="s4">&quot;&lt;&gt;()[]{}'</span><span class="s3">):</span>
        <span class="s1">cindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_col</span>
        <span class="s1">line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row</span><span class="s3">]</span>
        <span class="s1">start </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">line</span><span class="s3">[:</span><span class="s1">col</span><span class="s3">]) -</span>
                    <span class="s1">max</span><span class="s3">(</span><span class="s1">line</span><span class="s3">[:</span><span class="s1">col</span><span class="s3">].</span><span class="s1">rfind</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">delimiters</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">end </span><span class="s3">= </span><span class="s1">min</span><span class="s3">((</span><span class="s1">line</span><span class="s3">[</span><span class="s1">col</span><span class="s3">:].</span><span class="s1">find</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) </span><span class="s2">if </span><span class="s1">line</span><span class="s3">[</span><span class="s1">col</span><span class="s3">:].</span><span class="s1">find</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) &gt; -</span><span class="s5">1</span>
                   <span class="s2">else </span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">line</span><span class="s3">) - </span><span class="s1">col</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">delimiters</span><span class="s3">)</span>
        <span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_once</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">dt</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">select_text</span><span class="s3">(</span><span class="s1">cindex </span><span class="s3">- </span><span class="s1">start</span><span class="s3">,</span>
                                                        <span class="s1">cindex </span><span class="s3">+ </span><span class="s1">end</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">on_double_tap</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''This event is dispatched when a double tap happens 
        inside TextInput. The default behavior is to select the 
        word around the current cursor position. Override this to provide 
        different behavior. Alternatively, you can bind to this 
        event to provide additional functionality. 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_select_word</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">on_triple_tap</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''This event is dispatched when a triple tap happens 
        inside TextInput. The default behavior is to select the 
        line around current cursor position. Override this to provide 
        different behavior. Alternatively, you can bind to this 
        event to provide additional functionality. 
        '''</span>
        <span class="s1">ci </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
        <span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_expand_range</span><span class="s3">(</span><span class="s1">ci</span><span class="s3">)</span>
        <span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_once</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">dt</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">select_text</span><span class="s3">(</span><span class="s1">sindex</span><span class="s3">, </span><span class="s1">eindex</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">on_quad_touch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">'''This event is dispatched when four fingers are touching 
        inside TextInput. The default behavior is to select all text. 
        Override this to provide different behavior. Alternatively, 
        you can bind to this event to provide additional functionality. 
        '''</span>
        <span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_once</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">dt</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">select_all</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">on_touch_down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">disabled</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">touch_pos </span><span class="s3">= </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">collide_point</span><span class="s3">(*</span><span class="s1">touch_pos</span><span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s2">if </span><span class="s1">super</span><span class="s3">().</span><span class="s1">on_touch_down</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">):</span>
            <span class="s2">return True</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">focus</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_cursor_reset</span><span class="s3">()</span>

        <span class="s6"># Check for scroll wheel</span>
        <span class="s2">if </span><span class="s4">'button' </span><span class="s2">in </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">profile </span><span class="s2">and </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">button</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'scroll'</span><span class="s3">):</span>
            <span class="s6"># TODO: implement 'scrollleft' and 'scrollright'</span>
            <span class="s1">scroll_type </span><span class="s3">= </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">button</span><span class="s3">[</span><span class="s5">6</span><span class="s3">:]</span>
            <span class="s2">if </span><span class="s1">scroll_type </span><span class="s3">== </span><span class="s4">'down'</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span>
                                            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">*</span>
                                            <span class="s1">self</span><span class="s3">.</span><span class="s1">lines_to_scroll</span><span class="s3">)</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">-</span>
                                            <span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span><span class="s3">)</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">scroll_type </span><span class="s3">== </span><span class="s4">'up'</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline</span><span class="s3">:</span>
                    <span class="s1">max_scroll_y </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">minimum_height </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">height</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">&lt; </span><span class="s1">max_scroll_y</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">max_scroll_y</span><span class="s3">,</span>
                                            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">*</span>
                                            <span class="s1">self</span><span class="s3">.</span><span class="s1">lines_to_scroll</span><span class="s3">)</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">max_scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_max_scroll_x</span><span class="s3">()</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">&lt; </span><span class="s1">max_scroll_x</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">max_scroll_x</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">+</span>
                                            <span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span><span class="s3">)</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
            <span class="s2">return True</span>

        <span class="s1">touch</span><span class="s3">.</span><span class="s1">grab</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_count </span><span class="s3">+= </span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">is_double_tap</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_double_tap'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">is_triple_tap</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_triple_tap'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_count </span><span class="s3">== </span><span class="s5">4</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_quad_touch'</span><span class="s3">)</span>

        <span class="s6"># stores the touch for later use</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_down </span><span class="s3">= </span><span class="s1">touch</span>

        <span class="s6"># Is a new touch_down, so previous scroll states needs to be reset</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_enable_scroll </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_have_scrolled </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_x </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_y </span><span class="s3">= </span><span class="s5">0</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_cut_copy_paste</span><span class="s3">(</span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">)</span>
        <span class="s6"># schedule long touch for paste</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_long_touch_ev </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_once</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">long_touch</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_xy</span><span class="s3">(*</span><span class="s1">touch_pos</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_from_swipe</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_update_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_down</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">CutBuffer </span><span class="s2">and </span><span class="s4">'button' </span><span class="s2">in </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">profile </span><span class="s2">and </span><span class="s1">\</span>
                <span class="s1">touch</span><span class="s3">.</span><span class="s1">button </span><span class="s3">== </span><span class="s4">'middle'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">CutBuffer</span><span class="s3">.</span><span class="s1">get_cutbuffer</span><span class="s3">())</span>
            <span class="s2">return True</span>

        <span class="s2">return True</span>

    <span class="s6"># cancel/update existing selection after a single tap</span>
    <span class="s2">def </span><span class="s1">_cancel_update_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cancel_selection</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s3">= </span><span class="s1">touch</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">on_touch_move</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">grab_current </span><span class="s2">is not </span><span class="s1">self</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">focus</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">ungrab</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s2">is </span><span class="s1">touch</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s2">return False</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_from_swipe</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_text_from_swipe</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_have_scrolled </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s2">is </span><span class="s1">touch</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_xy</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">()</span>
            <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">on_touch_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">grab_current </span><span class="s2">is not </span><span class="s1">self</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">touch</span><span class="s3">.</span><span class="s1">ungrab</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_count </span><span class="s3">-= </span><span class="s5">1</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">cancel_long_touch_event</span><span class="s3">()</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">focus</span><span class="s3">:</span>
            <span class="s2">return False</span>

        <span class="s6"># types of touch that will have higher priority in being recognized,</span>
        <span class="s6"># compared to single tap</span>
        <span class="s1">prioritized_touch_types </span><span class="s3">= (</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">is_double_tap</span>
            <span class="s2">or </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">is_triple_tap</span>
            <span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_count </span><span class="s3">== </span><span class="s5">4</span>
        <span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_have_scrolled </span><span class="s2">and not </span><span class="s1">prioritized_touch_types</span><span class="s3">:</span>
            <span class="s6"># Is a single tap and did not scrolled.</span>
            <span class="s6"># Selection needs to be canceled.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_update_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_down</span><span class="s3">)</span>

        <span class="s6"># show Bubble</span>
        <span class="s1">win </span><span class="s3">= </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_show_cut_copy_paste</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">win</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_touch </span><span class="s2">is </span><span class="s1">touch</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_handles </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_handles</span><span class="s3">()</span>
                <span class="s1">handle_middle </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span>
                <span class="s2">if </span><span class="s1">handle_middle </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle </span><span class="s3">= </span><span class="s1">handle_middle </span><span class="s3">= </span><span class="s1">Selector</span><span class="s3">(</span>
                        <span class="s1">source</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_image_middle</span><span class="s3">,</span>
                        <span class="s1">window</span><span class="s3">=</span><span class="s1">win</span><span class="s3">,</span>
                        <span class="s1">target</span><span class="s3">=</span><span class="s1">self</span><span class="s3">,</span>
                        <span class="s1">size_hint</span><span class="s3">=(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                        <span class="s1">size</span><span class="s3">=(</span><span class="s4">'45dp'</span><span class="s3">, </span><span class="s4">'45dp'</span><span class="s3">))</span>
                    <span class="s1">handle_middle</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">on_press</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_pressed</span><span class="s3">,</span>
                                       <span class="s1">on_touch_move</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_move</span><span class="s3">,</span>
                                       <span class="s1">on_release</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_released</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span><span class="s3">.</span><span class="s1">parent </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">:</span>
                    <span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">.</span><span class="s1">add_widget</span><span class="s3">(</span><span class="s1">handle_middle</span><span class="s3">, </span><span class="s1">canvas</span><span class="s3">=</span><span class="s4">'after'</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_position_handles</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'middle'</span><span class="s3">)</span>
            <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">scroll_text_from_swipe</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s1">_scroll_timeout </span><span class="s3">= (</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">time_update </span><span class="s3">- </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">time_start</span><span class="s3">) * </span><span class="s5">1000</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_x </span><span class="s3">+= </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">dx</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_y </span><span class="s3">+= </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">touch</span><span class="s3">.</span><span class="s1">dy</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_have_scrolled</span><span class="s3">:</span>
            <span class="s6"># To be considered a scroll, touch should travel more than</span>
            <span class="s6"># scroll_distance in less than the scroll_timeout since touch_down</span>
            <span class="s2">if not </span><span class="s3">(</span>
                <span class="s1">_scroll_timeout </span><span class="s3">&lt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_timeout</span>
                <span class="s2">and </span><span class="s3">(</span>
                    <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_x </span><span class="s3">&gt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_distance</span><span class="s3">)</span>
                    <span class="s2">or </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_scroll_distance_y </span><span class="s3">&gt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_distance</span><span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s3">):</span>
                <span class="s6"># Distance isn't enough (yet) to consider it as a scroll</span>
                <span class="s2">if </span><span class="s1">_scroll_timeout </span><span class="s3">&lt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_timeout</span><span class="s3">:</span>
                    <span class="s6"># Timeout is not reached, scroll is still enabled.</span>
                    <span class="s2">return False</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_enable_scroll </span><span class="s3">= </span><span class="s2">False</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_cancel_update_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_touch_down</span><span class="s3">)</span>
                    <span class="s2">return False</span>
            <span class="s6"># We have a scroll!</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_have_scrolled </span><span class="s3">= </span><span class="s2">True</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">cancel_long_touch_event</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline</span><span class="s3">:</span>
            <span class="s1">max_scroll_y </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">minimum_height </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">height</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span>
                <span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">+ </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">dy</span><span class="s3">),</span>
                <span class="s1">max_scroll_y</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">max_scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_max_scroll_x</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span>
                <span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">- </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">dx</span><span class="s3">),</span>
                <span class="s1">max_scroll_x</span>
            <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_position_handles</span><span class="s3">()</span>
        <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">_handle_pressed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_cut_copy_paste</span><span class="s3">()</span>
        <span class="s1">from_</span><span class="s3">, </span><span class="s1">to_ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_to</span>
        <span class="s2">if </span><span class="s1">from_ </span><span class="s3">&gt; </span><span class="s1">to_</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">to_</span><span class="s3">, </span><span class="s1">from_</span>

    <span class="s2">def </span><span class="s1">_handle_released</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">== </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_to</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_show_cut_copy_paste</span><span class="s3">(</span>
            <span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">right</span>
                <span class="s2">if </span><span class="s1">instance </span><span class="s2">is </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span>
                <span class="s2">else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">x</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">y </span><span class="s3">+ </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">top </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span>
            <span class="s3">),</span>
            <span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_handle_move</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">touch</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">grab_current </span><span class="s3">!= </span><span class="s1">instance</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">get_cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_xy</span>
        <span class="s1">handle_right </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span>
        <span class="s1">handle_left </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span>
        <span class="s1">handle_middle </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">push</span><span class="s3">()</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">apply_transform_2d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_widget</span><span class="s3">)</span>
            <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">pos</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">touch</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">get_cursor</span><span class="s3">(</span>
            <span class="s1">x</span><span class="s3">,</span>
            <span class="s1">y </span><span class="s3">+ </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">_touch_diff </span><span class="s3">+ (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">/ </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span>

        <span class="s2">if </span><span class="s1">instance </span><span class="s3">!= </span><span class="s1">touch</span><span class="s3">.</span><span class="s1">grab_current</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s2">if </span><span class="s1">instance </span><span class="s3">== </span><span class="s1">handle_middle</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_position_handles</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'middle'</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s1">cindex </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">instance </span><span class="s3">== </span><span class="s1">handle_left</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">cindex</span>
        <span class="s2">elif </span><span class="s1">instance </span><span class="s3">== </span><span class="s1">handle_right</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">cindex</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_position_handles</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_position_handles</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">mode </span><span class="s3">= </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'mode'</span><span class="s3">, </span><span class="s4">'both'</span><span class="s3">)</span>

        <span class="s1">lh </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span>

        <span class="s1">handle_middle </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span>
        <span class="s2">if </span><span class="s1">handle_middle</span><span class="s3">:</span>
            <span class="s1">hp_mid </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_pos</span>
            <span class="s1">pos </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_local</span><span class="s3">(*</span><span class="s1">hp_mid</span><span class="s3">, </span><span class="s1">relative</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">handle_middle</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] - </span><span class="s1">handle_middle</span><span class="s3">.</span><span class="s1">width </span><span class="s3">/ </span><span class="s5">2</span>
            <span class="s1">handle_middle</span><span class="s3">.</span><span class="s1">top </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">3</span><span class="s3">],</span>
                                    <span class="s1">min</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">height </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span>
                                        <span class="s1">pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] - </span><span class="s1">lh</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">mode</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">'m'</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s4">'selection'</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">group</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">.</span><span class="s1">remove_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span><span class="s3">)</span>

        <span class="s1">handle_left </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span>
        <span class="s2">if not </span><span class="s1">handle_left</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">hp_left </span><span class="s3">= </span><span class="s1">group</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s1">pos</span>
        <span class="s1">handle_left</span><span class="s3">.</span><span class="s1">pos </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_local</span><span class="s3">(*</span><span class="s1">hp_left</span><span class="s3">, </span><span class="s1">relative</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">handle_left</span><span class="s3">.</span><span class="s1">x </span><span class="s3">-= </span><span class="s1">handle_left</span><span class="s3">.</span><span class="s1">width</span>
        <span class="s1">handle_left</span><span class="s3">.</span><span class="s1">y </span><span class="s3">-= </span><span class="s1">handle_left</span><span class="s3">.</span><span class="s1">height</span>

        <span class="s1">handle_right </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span>
        <span class="s1">last_rect </span><span class="s3">= </span><span class="s1">group</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">hp_right </span><span class="s3">= </span><span class="s1">last_rect</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">last_rect</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_local</span><span class="s3">(*</span><span class="s1">hp_right</span><span class="s3">, </span><span class="s1">relative</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">handle_right</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">last_rect</span><span class="s3">.</span><span class="s1">size</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">handle_right</span><span class="s3">.</span><span class="s1">y </span><span class="s3">= </span><span class="s1">y </span><span class="s3">- </span><span class="s1">handle_right</span><span class="s3">.</span><span class="s1">height</span>

    <span class="s2">def </span><span class="s1">_hide_handles</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">win</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">win </span><span class="s3">= </span><span class="s1">win </span><span class="s2">or </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span>
        <span class="s2">if </span><span class="s1">win </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">win</span><span class="s3">.</span><span class="s1">remove_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span><span class="s3">)</span>
        <span class="s1">win</span><span class="s3">.</span><span class="s1">remove_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span><span class="s3">)</span>
        <span class="s1">win</span><span class="s3">.</span><span class="s1">remove_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_show_handles</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_handles </span><span class="s2">or not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">win </span><span class="s3">= </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span>

        <span class="s1">handle_right </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span>
        <span class="s1">handle_left </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left </span><span class="s3">= </span><span class="s1">handle_left </span><span class="s3">= </span><span class="s1">Selector</span><span class="s3">(</span>
                <span class="s1">source</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_image_left</span><span class="s3">,</span>
                <span class="s1">target</span><span class="s3">=</span><span class="s1">self</span><span class="s3">,</span>
                <span class="s1">window</span><span class="s3">=</span><span class="s1">win</span><span class="s3">,</span>
                <span class="s1">size_hint</span><span class="s3">=(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                <span class="s1">size</span><span class="s3">=(</span><span class="s4">'45dp'</span><span class="s3">, </span><span class="s4">'45dp'</span><span class="s3">))</span>
            <span class="s1">handle_left</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">on_press</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_pressed</span><span class="s3">,</span>
                             <span class="s1">on_touch_move</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_move</span><span class="s3">,</span>
                             <span class="s1">on_release</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_released</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right </span><span class="s3">= </span><span class="s1">handle_right </span><span class="s3">= </span><span class="s1">Selector</span><span class="s3">(</span>
                <span class="s1">source</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_image_right</span><span class="s3">,</span>
                <span class="s1">target</span><span class="s3">=</span><span class="s1">self</span><span class="s3">,</span>
                <span class="s1">window</span><span class="s3">=</span><span class="s1">win</span><span class="s3">,</span>
                <span class="s1">size_hint</span><span class="s3">=(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                <span class="s1">size</span><span class="s3">=(</span><span class="s4">'45dp'</span><span class="s3">, </span><span class="s4">'45dp'</span><span class="s3">))</span>
            <span class="s1">handle_right</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">on_press</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_pressed</span><span class="s3">,</span>
                              <span class="s1">on_touch_move</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_move</span><span class="s3">,</span>
                              <span class="s1">on_release</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_released</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_position_handles</span><span class="s3">()</span>
                <span class="s2">return</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">:</span>
                <span class="s2">return</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_position_handles</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_from </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_to</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span><span class="s3">.</span><span class="s1">opacity </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span><span class="s3">.</span><span class="s1">opacity </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s1">win</span><span class="s3">.</span><span class="s1">add_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span><span class="s3">, </span><span class="s1">canvas</span><span class="s3">=</span><span class="s4">'after'</span><span class="s3">)</span>
            <span class="s1">win</span><span class="s3">.</span><span class="s1">add_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span><span class="s3">, </span><span class="s1">canvas</span><span class="s3">=</span><span class="s4">'after'</span><span class="s3">)</span>
            <span class="s1">anim </span><span class="s3">= </span><span class="s1">Animation</span><span class="s3">(</span><span class="s1">opacity</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">.4</span><span class="s3">)</span>
            <span class="s1">anim</span><span class="s3">.</span><span class="s1">start</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span><span class="s3">)</span>
            <span class="s1">anim</span><span class="s3">.</span><span class="s1">start</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_show_cut_copy_paste</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">win</span><span class="s3">, </span><span class="s1">parent_changed</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">''</span><span class="s3">, </span><span class="s1">pos_in_window</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, *</span><span class="s1">l</span>
    <span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Show a bubble with cut copy and paste buttons&quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_bubble</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">bubble </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bubble</span>
        <span class="s2">if </span><span class="s1">bubble </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_bubble </span><span class="s3">= </span><span class="s1">bubble </span><span class="s3">= </span><span class="s1">TextInputCutCopyPaste</span><span class="s3">(</span><span class="s1">textinput</span><span class="s3">=</span><span class="s1">self</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fbind</span><span class="s3">(</span><span class="s4">'parent'</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_show_cut_copy_paste</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">win</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

            <span class="s2">def </span><span class="s1">hide_</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_cut_copy_paste</span><span class="s3">(</span><span class="s1">win</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span>
                <span class="s1">focus</span><span class="s3">=</span><span class="s1">hide_</span><span class="s3">,</span>
                <span class="s1">cursor_pos</span><span class="s3">=</span><span class="s1">hide_</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">win</span><span class="s3">.</span><span class="s1">remove_widget</span><span class="s3">(</span><span class="s1">bubble</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">:</span>
                <span class="s2">return</span>
        <span class="s2">if </span><span class="s1">parent_changed</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s6"># Search the position from the touch to the window</span>
        <span class="s1">lh</span><span class="s3">, </span><span class="s1">ls </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span>

        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">pos</span>
        <span class="s1">t_pos </span><span class="s3">= (</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) </span><span class="s2">if </span><span class="s1">pos_in_window </span><span class="s2">else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_window</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">bubble_size </span><span class="s3">= </span><span class="s1">bubble</span><span class="s3">.</span><span class="s1">size</span>
        <span class="s1">bubble_hw </span><span class="s3">= </span><span class="s1">bubble_size</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">2.</span>
        <span class="s1">win_size </span><span class="s3">= </span><span class="s1">win</span><span class="s3">.</span><span class="s1">size</span>
        <span class="s1">bubble_pos </span><span class="s3">= (</span><span class="s1">t_pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">t_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] + </span><span class="s1">inch</span><span class="s3">(</span><span class="s5">.25</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] - </span><span class="s1">bubble_hw</span><span class="s3">) &lt; </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s6"># bubble beyond left of window</span>
            <span class="s2">if </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] &gt; (</span><span class="s1">win_size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] - </span><span class="s1">bubble_size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]):</span>
                <span class="s6"># bubble above window height</span>
                <span class="s1">bubble_pos </span><span class="s3">= (</span><span class="s1">bubble_hw</span><span class="s3">, (</span><span class="s1">t_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]) - (</span><span class="s1">lh </span><span class="s3">+ </span><span class="s1">ls </span><span class="s3">+ </span><span class="s1">inch</span><span class="s3">(</span><span class="s5">.25</span><span class="s3">)))</span>
                <span class="s1">bubble</span><span class="s3">.</span><span class="s1">arrow_pos </span><span class="s3">= </span><span class="s4">'top_left'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">bubble_pos </span><span class="s3">= (</span><span class="s1">bubble_hw</span><span class="s3">, </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
                <span class="s1">bubble</span><span class="s3">.</span><span class="s1">arrow_pos </span><span class="s3">= </span><span class="s4">'bottom_left'</span>
        <span class="s2">elif </span><span class="s3">(</span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s1">bubble_hw</span><span class="s3">) &gt; </span><span class="s1">win_size</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]:</span>
            <span class="s6"># bubble beyond right of window</span>
            <span class="s2">if </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] &gt; (</span><span class="s1">win_size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] - </span><span class="s1">bubble_size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]):</span>
                <span class="s6"># bubble above window height</span>
                <span class="s1">bubble_pos </span><span class="s3">= (</span>
                    <span class="s1">win_size</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] - </span><span class="s1">bubble_hw</span><span class="s3">,</span>
                    <span class="s3">(</span><span class="s1">t_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]) - (</span><span class="s1">lh </span><span class="s3">+ </span><span class="s1">ls </span><span class="s3">+ </span><span class="s1">inch</span><span class="s3">(</span><span class="s5">.25</span><span class="s3">))</span>
                <span class="s3">)</span>
                <span class="s1">bubble</span><span class="s3">.</span><span class="s1">arrow_pos </span><span class="s3">= </span><span class="s4">'top_right'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">bubble_pos </span><span class="s3">= (</span><span class="s1">win_size</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] - </span><span class="s1">bubble_hw</span><span class="s3">, </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
                <span class="s1">bubble</span><span class="s3">.</span><span class="s1">arrow_pos </span><span class="s3">= </span><span class="s4">'bottom_right'</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] &gt; (</span><span class="s1">win_size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] - </span><span class="s1">bubble_size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]):</span>
                <span class="s6"># bubble above window height</span>
                <span class="s1">bubble_pos </span><span class="s3">= (</span>
                    <span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],</span>
                    <span class="s3">(</span><span class="s1">t_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]) - (</span><span class="s1">lh </span><span class="s3">+ </span><span class="s1">ls </span><span class="s3">+ </span><span class="s1">inch</span><span class="s3">(</span><span class="s5">.25</span><span class="s3">))</span>
                <span class="s3">)</span>
                <span class="s1">bubble</span><span class="s3">.</span><span class="s1">arrow_pos </span><span class="s3">= </span><span class="s4">'top_mid'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">bubble</span><span class="s3">.</span><span class="s1">arrow_pos </span><span class="s3">= </span><span class="s4">'bottom_mid'</span>

        <span class="s1">bubble_pos </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_widget</span><span class="s3">(*</span><span class="s1">bubble_pos</span><span class="s3">, </span><span class="s1">relative</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">bubble</span><span class="s3">.</span><span class="s1">center_x </span><span class="s3">= </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">bubble</span><span class="s3">.</span><span class="s1">arrow_pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">'t'</span><span class="s3">:</span>
            <span class="s1">bubble</span><span class="s3">.</span><span class="s1">top </span><span class="s3">= </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">bubble</span><span class="s3">.</span><span class="s1">y </span><span class="s3">= </span><span class="s1">bubble_pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">bubble</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">mode</span>
        <span class="s1">Animation</span><span class="s3">.</span><span class="s1">cancel_all</span><span class="s3">(</span><span class="s1">bubble</span><span class="s3">)</span>
        <span class="s1">bubble</span><span class="s3">.</span><span class="s1">opacity </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">win</span><span class="s3">.</span><span class="s1">add_widget</span><span class="s3">(</span><span class="s1">bubble</span><span class="s3">, </span><span class="s1">canvas</span><span class="s3">=</span><span class="s4">'after'</span><span class="s3">)</span>
        <span class="s1">Animation</span><span class="s3">(</span><span class="s1">opacity</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">.225</span><span class="s3">).</span><span class="s1">start</span><span class="s3">(</span><span class="s1">bubble</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_hide_cut_copy_paste</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">win</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">bubble </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_bubble</span>
        <span class="s2">if not </span><span class="s1">bubble</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">bubble</span><span class="s3">.</span><span class="s1">hide</span><span class="s3">()</span>

    <span class="s6">#</span>
    <span class="s6"># Private</span>
    <span class="s6">#</span>

    <span class="s3">@</span><span class="s1">staticmethod</span>
    <span class="s2">def </span><span class="s1">_reload_remove_observer</span><span class="s3">(</span><span class="s1">wr</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;called when the textinput is deleted&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">wr </span><span class="s2">in </span><span class="s1">_textinput_list</span><span class="s3">:</span>
            <span class="s1">_textinput_list</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">wr</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_on_textinput_focused</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s1">win </span><span class="s3">= </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cancel_selection</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_cut_copy_paste</span><span class="s3">(</span><span class="s1">win</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">value</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s3">(</span>
                <span class="s2">not </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">readonly </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">disabled</span><span class="s3">)</span>
                <span class="s2">or </span><span class="s1">_is_desktop</span>
                <span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboard_mode </span><span class="s3">== </span><span class="s4">'system'</span>
            <span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_cursor_reset</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_editable </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_editable </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_do_blink_cursor_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_handles</span><span class="s3">(</span><span class="s1">win</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_ensure_clipboard</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">global </span><span class="s1">Clipboard</span><span class="s3">, </span><span class="s1">CutBuffer</span>
        <span class="s2">if not </span><span class="s1">Clipboard</span><span class="s3">:</span>
            <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">clipboard </span><span class="s2">import </span><span class="s1">Clipboard</span><span class="s3">, </span><span class="s1">CutBuffer</span>

    <span class="s2">def </span><span class="s1">cut</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">''' Copy current selection to clipboard then delete it from TextInput. 
 
        .. versionadded:: 1.8.0 
 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cut</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_cut</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ensure_clipboard</span><span class="s3">()</span>
        <span class="s1">Clipboard</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">copy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">=</span><span class="s4">''</span><span class="s3">):</span>
        <span class="s0">''' Copy the value provided in argument `data` into current clipboard. 
        If data is not of type string it will be converted to string. 
        If no data is provided then current selection if present is copied. 
 
        .. versionadded:: 1.8.0 
 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ensure_clipboard</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">data</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">Clipboard</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">Clipboard</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">paste</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">''' Insert text from system :class:`~kivy.core.clipboard.Clipboard` 
        into the :class:`~kivy.uix.textinput.TextInput` at current cursor 
        position. 
 
        .. versionadded:: 1.8.0 
 
        '''</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ensure_clipboard</span><span class="s3">()</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">Clipboard</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline</span><span class="s3">:</span>
            <span class="s1">data </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">' '</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_update_cutbuffer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s1">CutBuffer</span><span class="s3">.</span><span class="s1">set_cutbuffer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_text_width</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">tab_width</span><span class="s3">, </span><span class="s1">_label_cached</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return the width of a text, according to the current line options&quot;&quot;&quot;</span>
        <span class="s1">kw </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_options</span><span class="s3">()</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">cid </span><span class="s3">= </span><span class="s4">u'{}</span><span class="s2">\0</span><span class="s4">{}</span><span class="s2">\0</span><span class="s4">{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password</span><span class="s3">, </span><span class="s1">kw</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">UnicodeDecodeError</span><span class="s3">:</span>
            <span class="s1">cid </span><span class="s3">= </span><span class="s4">'{}</span><span class="s2">\0</span><span class="s4">{}</span><span class="s2">\0</span><span class="s4">{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password</span><span class="s3">, </span><span class="s1">kw</span><span class="s3">)</span>

        <span class="s1">width </span><span class="s3">= </span><span class="s1">Cache_get</span><span class="s3">(</span><span class="s4">'textinput.width'</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">width</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">width</span>
        <span class="s2">if not </span><span class="s1">_label_cached</span><span class="s3">:</span>
            <span class="s1">_label_cached </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\t</span><span class="s4">'</span><span class="s3">, </span><span class="s4">' ' </span><span class="s3">* </span><span class="s1">tab_width</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password</span><span class="s3">:</span>
            <span class="s1">width </span><span class="s3">= </span><span class="s1">_label_cached</span><span class="s3">.</span><span class="s1">get_extents</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">width </span><span class="s3">= </span><span class="s1">_label_cached</span><span class="s3">.</span><span class="s1">get_extents</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">password_mask </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">text</span><span class="s3">))[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">Cache_append</span><span class="s3">(</span><span class="s4">'textinput.width'</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">width</span>

    <span class="s2">def </span><span class="s1">on_cursor_blink</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;trigger blink event reset to switch blinking while focused&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_reset_cursor_blink</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_do_blink_cursor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_blink</span><span class="s3">:</span>
            <span class="s6"># ignore event if not triggered,</span>
            <span class="s6"># stop if cursor_blink value changed right now</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_do_blink_cursor_ev</span><span class="s3">.</span><span class="s1">is_triggered</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_do_blink_cursor_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
            <span class="s6"># don't blink, make cursor visible</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor_blink </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">return</span>

        <span class="s6"># Callback for blinking the cursor.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor_blink </span><span class="s3">= </span><span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor_blink</span>

    <span class="s2">def </span><span class="s1">_reset_cursor_blink</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_do_blink_cursor_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor_blink </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_do_blink_cursor_ev</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">on_cursor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        When the cursor is moved, reset cursor blinking to keep it showing, 
        and update all the graphics. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">focus</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_cursor_reset</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_delete_line</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">idx</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Delete current line, and fix cursor position&quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">idx </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>

    <span class="s2">def </span><span class="s1">_set_line_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">line_num</span><span class="s3">, </span><span class="s1">text</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Set current line with other text than the default one.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels</span><span class="s3">[</span><span class="s1">line_num</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_create_line_label</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">line_num</span><span class="s3">] = </span><span class="s1">text</span>

    <span class="s2">def </span><span class="s1">_trigger_refresh_line_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_line_options_ev </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_line_options_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_line_options_ev </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">create_trigger</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_line_options</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_line_options_ev</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_refresh_line_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_line_options </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_options</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_hint_text</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_trigger_refresh_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">largs</span><span class="s3">) </span><span class="s2">and </span><span class="s1">largs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">:</span>
            <span class="s1">largs </span><span class="s3">= ()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property_ev </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property_ev </span><span class="s3">= </span><span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_once</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">dt</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">(*</span><span class="s1">largs</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_update_text_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s1">Cache_remove</span><span class="s3">(</span><span class="s4">'textinput.width'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_refresh_text</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_refresh_text_from_trigger</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">(*</span><span class="s1">largs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_refresh_text_from_property</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_refresh_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Refresh all the lines from a new text. 
        By using cache in internal functions, this method should be fast. 
        &quot;&quot;&quot;</span>
        <span class="s1">mode </span><span class="s3">= </span><span class="s4">'all'</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">largs</span><span class="s3">) &gt; </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">mode</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">finish</span><span class="s3">, </span><span class="s1">_lines</span><span class="s3">, </span><span class="s1">_lines_flags</span><span class="s3">, </span><span class="s1">len_lines </span><span class="s3">= </span><span class="s1">largs</span>
            <span class="s6"># start = max(0, start)</span>
            <span class="s1">cursor </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
            <span class="s1">_lines</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_split_smart</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
        <span class="s1">_lines_labels </span><span class="s3">= []</span>
        <span class="s1">_line_rects </span><span class="s3">= []</span>
        <span class="s1">_create_label </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_create_line_label</span>

        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">_lines</span><span class="s3">:</span>
            <span class="s1">lbl </span><span class="s3">= </span><span class="s1">_create_label</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">_lines_labels</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">lbl</span><span class="s3">)</span>
            <span class="s1">_line_rects</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">Rectangle</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">lbl</span><span class="s3">.</span><span class="s1">size</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">'all'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels </span><span class="s3">= </span><span class="s1">_lines_labels</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects </span><span class="s3">= </span><span class="s1">_line_rects</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[:] = </span><span class="s1">_lines</span>
        <span class="s2">elif </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">'del'</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">finish </span><span class="s3">&gt; </span><span class="s1">start</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_insert_lines</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">finish </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">len_lines</span><span class="s3">,</span>
                                   <span class="s1">_lines_flags</span><span class="s3">, </span><span class="s1">_lines</span><span class="s3">, </span><span class="s1">_lines_labels</span><span class="s3">,</span>
                                   <span class="s1">_line_rects</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">'insert'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_insert_lines</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">finish </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">len_lines</span><span class="s3">, </span><span class="s1">_lines_flags</span><span class="s3">,</span>
                               <span class="s1">_lines</span><span class="s3">, </span><span class="s1">_lines_labels</span><span class="s3">, </span><span class="s1">_line_rects</span><span class="s3">)</span>

        <span class="s1">min_line_ht </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached</span><span class="s3">.</span><span class="s1">get_extents</span><span class="s3">(</span><span class="s4">'_'</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s6"># with markup texture can be of height `1`</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">_lines_labels</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">height</span><span class="s3">, </span><span class="s1">min_line_ht</span><span class="s3">)</span>
        <span class="s6"># self.line_spacing = 2</span>
        <span class="s6"># now, if the text change, maybe the cursor is not at the same place as</span>
        <span class="s6"># before. so, try to set the cursor on the good place</span>
        <span class="s1">row </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">() </span><span class="s2">if </span><span class="s1">cursor </span><span class="s2">is None else </span><span class="s1">cursor</span>
        <span class="s3">)</span>

        <span class="s6"># if we back to a new line, reset the scroll, otherwise, the effect is</span>
        <span class="s6"># ugly</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row </span><span class="s3">!= </span><span class="s1">row</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s6"># with the new text don't forget to update graphics again</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_insert_lines</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">finish</span><span class="s3">, </span><span class="s1">len_lines</span><span class="s3">, </span><span class="s1">_lines_flags</span><span class="s3">,</span>
                      <span class="s1">_lines</span><span class="s3">, </span><span class="s1">_lines_labels</span><span class="s3">, </span><span class="s1">_line_rects</span><span class="s3">):</span>
        <span class="s1">self_lines_flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span>
        <span class="s1">_lins_flags </span><span class="s3">= []</span>
        <span class="s1">_lins_flags</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self_lines_flags</span><span class="s3">[:</span><span class="s1">start</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">len_lines</span><span class="s3">:</span>
            <span class="s6"># if not inserting at first line then</span>
            <span class="s2">if </span><span class="s1">start</span><span class="s3">:</span>
                <span class="s6"># make sure line flags restored for first line</span>
                <span class="s6"># _split_smart assumes first line to be not a new line</span>
                <span class="s1">_lines_flags</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s1">self_lines_flags</span><span class="s3">[</span><span class="s1">start</span><span class="s3">]</span>
            <span class="s1">_lins_flags</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">_lines_flags</span><span class="s3">)</span>
        <span class="s1">_lins_flags</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self_lines_flags</span><span class="s3">[</span><span class="s1">finish</span><span class="s3">:])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags </span><span class="s3">= </span><span class="s1">_lins_flags</span>

        <span class="s1">_lins_lbls </span><span class="s3">= []</span>
        <span class="s1">_lins_lbls</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels</span><span class="s3">[:</span><span class="s1">start</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">len_lines</span><span class="s3">:</span>
            <span class="s1">_lins_lbls</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">_lines_labels</span><span class="s3">)</span>
        <span class="s1">_lins_lbls</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels</span><span class="s3">[</span><span class="s1">finish</span><span class="s3">:])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels </span><span class="s3">= </span><span class="s1">_lins_lbls</span>

        <span class="s1">_lins_rcts </span><span class="s3">= []</span>
        <span class="s1">_lins_rcts</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects</span><span class="s3">[:</span><span class="s1">start</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">len_lines</span><span class="s3">:</span>
            <span class="s1">_lins_rcts</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">_line_rects</span><span class="s3">)</span>
        <span class="s1">_lins_rcts</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects</span><span class="s3">[</span><span class="s1">finish</span><span class="s3">:])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects </span><span class="s3">= </span><span class="s1">_lins_rcts</span>

        <span class="s1">_lins </span><span class="s3">= []</span>
        <span class="s1">_lins</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[:</span><span class="s1">start</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">len_lines</span><span class="s3">:</span>
            <span class="s1">_lins</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">_lines</span><span class="s3">)</span>
        <span class="s1">_lins</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s1">finish</span><span class="s3">:])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[:] = </span><span class="s1">_lins</span>

    <span class="s2">def </span><span class="s1">_trigger_update_graphics</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_graphics_ev</span><span class="s3">.</span><span class="s1">cancel</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_graphics_ev</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_update_graphics</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">largs</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Update all the graphics according to the current internal values. 
        &quot;&quot;&quot;</span>

        <span class="s6"># This is a little bit complex, because we have to :</span>
        <span class="s6">#     - handle scroll_x</span>
        <span class="s6">#     - handle padding</span>
        <span class="s6">#     - create rectangle for the lines matching the viewport</span>
        <span class="s6">#     - crop the texture coordinates to match the viewport</span>

        <span class="s6"># This is the first step of graphics, the second is the selection.</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>

        <span class="s1">line_height </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span>
        <span class="s1">dy </span><span class="s3">= </span><span class="s1">line_height </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span>

        <span class="s6"># adjust view if the cursor is going outside the bounds</span>
        <span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>
        <span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y</span>

        <span class="s6"># draw labels</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
            <span class="s2">or </span><span class="s3">(</span><span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">) == </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s1">rects </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_rects</span>
            <span class="s1">labels </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_labels</span>
            <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_lines</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">rects </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects</span>
            <span class="s1">labels </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels</span>
            <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>

        <span class="s1">padding_left</span><span class="s3">, </span><span class="s1">padding_top</span><span class="s3">, </span><span class="s1">padding_right</span><span class="s3">, </span><span class="s1">padding_bottom </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">padding_left</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">top </span><span class="s3">- </span><span class="s1">padding_top </span><span class="s3">+ </span><span class="s1">scroll_y</span>
        <span class="s1">miny </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y </span><span class="s3">+ </span><span class="s1">padding_bottom</span>
        <span class="s1">maxy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">top </span><span class="s3">- </span><span class="s1">padding_top</span>
        <span class="s1">halign </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">halign</span>
        <span class="s1">base_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_direction</span>

        <span class="s1">auto_halign_r </span><span class="s3">= </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'auto' </span><span class="s2">and </span><span class="s1">base_dir </span><span class="s2">and </span><span class="s4">'rtl' </span><span class="s2">in </span><span class="s1">base_dir</span>

        <span class="s1">fst_visible_ln </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">viewport_pos </span><span class="s3">= </span><span class="s1">scroll_x</span><span class="s3">, </span><span class="s5">0</span>
        <span class="s2">for </span><span class="s1">line_num</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">miny </span><span class="s3">&lt; </span><span class="s1">y </span><span class="s3">&lt; </span><span class="s1">maxy </span><span class="s3">+ </span><span class="s1">dy</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">fst_visible_ln </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s1">fst_visible_ln </span><span class="s3">= </span><span class="s1">line_num</span>

                <span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_draw_line</span><span class="s3">(</span>
                    <span class="s1">value</span><span class="s3">,</span>
                    <span class="s1">line_num</span><span class="s3">,</span>
                    <span class="s1">labels</span><span class="s3">[</span><span class="s1">line_num</span><span class="s3">],</span>
                    <span class="s1">viewport_pos</span><span class="s3">,</span>
                    <span class="s1">line_height</span><span class="s3">,</span>
                    <span class="s1">miny</span><span class="s3">,</span>
                    <span class="s1">maxy</span><span class="s3">,</span>
                    <span class="s1">x</span><span class="s3">,</span>
                    <span class="s1">y</span><span class="s3">,</span>
                    <span class="s1">base_dir</span><span class="s3">,</span>
                    <span class="s1">halign</span><span class="s3">,</span>
                    <span class="s1">rects</span><span class="s3">,</span>
                    <span class="s1">auto_halign_r</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">y </span><span class="s3">&lt;= </span><span class="s1">miny</span><span class="s3">:</span>
                <span class="s1">line_num </span><span class="s3">-= </span><span class="s5">1</span>
                <span class="s2">break</span>

            <span class="s1">y </span><span class="s3">-= </span><span class="s1">dy</span>

        <span class="s2">if </span><span class="s1">fst_visible_ln </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_visible_lines_range </span><span class="s3">= (</span><span class="s1">fst_visible_ln</span><span class="s3">, </span><span class="s1">line_num </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_visible_lines_range </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_graphics_selection</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_draw_line</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">value</span><span class="s3">,</span>
        <span class="s1">line_num</span><span class="s3">,</span>
        <span class="s1">texture</span><span class="s3">,</span>
        <span class="s1">viewport_pos</span><span class="s3">,</span>
        <span class="s1">line_height</span><span class="s3">,</span>
        <span class="s1">miny</span><span class="s3">,</span>
        <span class="s1">maxy</span><span class="s3">,</span>
        <span class="s1">x</span><span class="s3">,</span>
        <span class="s1">y</span><span class="s3">,</span>
        <span class="s1">base_dir</span><span class="s3">,</span>
        <span class="s1">halign</span><span class="s3">,</span>
        <span class="s1">rects</span><span class="s3">,</span>
        <span class="s1">auto_halign_r</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">texture</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s1">texcoords </span><span class="s3">= </span><span class="s1">texture</span><span class="s3">.</span><span class="s1">tex_coords</span><span class="s3">[:]</span>

        <span class="s6"># compute coordinate</span>
        <span class="s1">padding_left</span><span class="s3">, </span><span class="s1">padding_top</span><span class="s3">, </span><span class="s1">padding_right</span><span class="s3">, </span><span class="s1">padding_bottom </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span>
        <span class="s1">viewport_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s1">padding_left </span><span class="s3">- </span><span class="s1">padding_right</span>
        <span class="s1">viewport_height </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">height </span><span class="s3">- </span><span class="s1">padding_top </span><span class="s3">- </span><span class="s1">padding_bottom</span>
        <span class="s1">texture_width</span><span class="s3">, </span><span class="s1">texture_height </span><span class="s3">= </span><span class="s1">size</span>
        <span class="s1">original_height</span><span class="s3">, </span><span class="s1">original_width </span><span class="s3">= </span><span class="s1">tch</span><span class="s3">, </span><span class="s1">tcw </span><span class="s3">= </span><span class="s1">texcoords</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:</span><span class="s5">3</span><span class="s3">]</span>

        <span class="s6"># adjust size/texcoord according to viewport</span>
        <span class="s2">if </span><span class="s1">viewport_pos</span><span class="s3">:</span>
            <span class="s1">tcx</span><span class="s3">, </span><span class="s1">tcy </span><span class="s3">= </span><span class="s1">viewport_pos</span>
            <span class="s1">tcx </span><span class="s3">= </span><span class="s1">tcx </span><span class="s3">/ </span><span class="s1">texture_width </span><span class="s3">* </span><span class="s1">original_width</span>
            <span class="s1">tcy </span><span class="s3">= </span><span class="s1">tcy </span><span class="s3">/ </span><span class="s1">texture_height </span><span class="s3">* </span><span class="s1">original_height</span>

        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tcx</span><span class="s3">, </span><span class="s1">tcy </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span>

        <span class="s2">if </span><span class="s1">texture_width </span><span class="s3">* (</span><span class="s5">1 </span><span class="s3">- </span><span class="s1">tcx</span><span class="s3">) &lt; </span><span class="s1">viewport_width</span><span class="s3">:</span>
            <span class="s1">tcw </span><span class="s3">= </span><span class="s1">tcw </span><span class="s3">- </span><span class="s1">tcx</span>
            <span class="s1">texture_width </span><span class="s3">= </span><span class="s1">tcw </span><span class="s3">* </span><span class="s1">texture_width</span>
        <span class="s2">elif </span><span class="s1">viewport_width </span><span class="s3">&lt; </span><span class="s1">texture_width</span><span class="s3">:</span>
            <span class="s1">tcw </span><span class="s3">= (</span><span class="s1">viewport_width </span><span class="s3">/ </span><span class="s1">texture_width</span><span class="s3">) * </span><span class="s1">tcw</span>
            <span class="s1">texture_width </span><span class="s3">= </span><span class="s1">viewport_width</span>

        <span class="s2">if </span><span class="s1">viewport_height </span><span class="s3">&lt; </span><span class="s1">texture_height</span><span class="s3">:</span>
            <span class="s1">tch </span><span class="s3">= (</span><span class="s1">viewport_height </span><span class="s3">/ </span><span class="s1">texture_height</span><span class="s3">) * </span><span class="s1">tch</span>
            <span class="s1">texture_height </span><span class="s3">= </span><span class="s1">viewport_height</span>

        <span class="s6"># cropping</span>
        <span class="s2">if </span><span class="s1">y </span><span class="s3">&gt; </span><span class="s1">maxy</span><span class="s3">:</span>
            <span class="s1">viewport_height </span><span class="s3">= (</span><span class="s1">maxy </span><span class="s3">- </span><span class="s1">y </span><span class="s3">+ </span><span class="s1">line_height</span><span class="s3">)</span>
            <span class="s1">tch </span><span class="s3">= (</span><span class="s1">viewport_height </span><span class="s3">/ </span><span class="s1">line_height</span><span class="s3">) * </span><span class="s1">original_height</span>
            <span class="s1">tcy </span><span class="s3">= </span><span class="s1">original_height </span><span class="s3">- </span><span class="s1">tch</span>
            <span class="s1">texture_height </span><span class="s3">= </span><span class="s1">viewport_height</span>
        <span class="s2">if </span><span class="s1">y </span><span class="s3">- </span><span class="s1">line_height </span><span class="s3">&lt; </span><span class="s1">miny</span><span class="s3">:</span>
            <span class="s1">diff </span><span class="s3">= </span><span class="s1">miny </span><span class="s3">- (</span><span class="s1">y </span><span class="s3">- </span><span class="s1">line_height</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">+= </span><span class="s1">diff</span>
            <span class="s1">viewport_height </span><span class="s3">= </span><span class="s1">line_height </span><span class="s3">- </span><span class="s1">diff</span>
            <span class="s1">tch </span><span class="s3">= (</span><span class="s1">viewport_height </span><span class="s3">/ </span><span class="s1">line_height</span><span class="s3">) * </span><span class="s1">original_height</span>
            <span class="s1">texture_height </span><span class="s3">= </span><span class="s1">viewport_height</span>

        <span class="s2">if </span><span class="s1">tcw </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s6"># nothing to show</span>
            <span class="s2">return </span><span class="s1">y</span>

        <span class="s1">top_left_corner </span><span class="s3">= </span><span class="s1">tcx</span><span class="s3">, </span><span class="s1">tcy </span><span class="s3">+ </span><span class="s1">tch</span>
        <span class="s1">top_right_corner </span><span class="s3">= </span><span class="s1">tcx </span><span class="s3">+ </span><span class="s1">tcw</span><span class="s3">, </span><span class="s1">tcy </span><span class="s3">+ </span><span class="s1">tch</span>
        <span class="s1">bottom_right_corner </span><span class="s3">= </span><span class="s1">tcx </span><span class="s3">+ </span><span class="s1">tcw</span><span class="s3">, </span><span class="s1">tcy</span>
        <span class="s1">bottom_left_corner </span><span class="s3">= </span><span class="s1">tcx</span><span class="s3">, </span><span class="s1">tcy</span>

        <span class="s1">texcoords </span><span class="s3">= (</span>
            <span class="s1">top_left_corner</span>
            <span class="s3">+ </span><span class="s1">top_right_corner</span>
            <span class="s3">+ </span><span class="s1">bottom_right_corner</span>
            <span class="s3">+ </span><span class="s1">bottom_left_corner</span>
        <span class="s3">)</span>

        <span class="s6"># Horizontal alignment</span>
        <span class="s1">xoffset </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s2">if not </span><span class="s1">base_dir</span><span class="s3">:</span>
            <span class="s1">base_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolved_base_dir </span><span class="s3">= </span><span class="s1">Label</span><span class="s3">.</span><span class="s1">find_base_direction</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)  </span><span class="s6"># noqa</span>
            <span class="s2">if </span><span class="s1">base_dir </span><span class="s2">and </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'auto'</span><span class="s3">:</span>
                <span class="s1">auto_halign_r </span><span class="s3">= </span><span class="s4">'rtl' </span><span class="s2">in </span><span class="s1">base_dir</span>
        <span class="s2">if </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'center'</span><span class="s3">:</span>
            <span class="s1">xoffset </span><span class="s3">= </span><span class="s1">int</span><span class="s3">((</span><span class="s1">viewport_width </span><span class="s3">- </span><span class="s1">texture_width</span><span class="s3">) / </span><span class="s5">2.</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'right' </span><span class="s2">or </span><span class="s1">auto_halign_r</span><span class="s3">:</span>
            <span class="s1">xoffset </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">int</span><span class="s3">(</span><span class="s1">viewport_width </span><span class="s3">- </span><span class="s1">texture_width</span><span class="s3">))</span>

        <span class="s6"># add rectangle</span>
        <span class="s1">rect </span><span class="s3">= </span><span class="s1">rects</span><span class="s3">[</span><span class="s1">line_num</span><span class="s3">]</span>
        <span class="s1">rect</span><span class="s3">.</span><span class="s1">pos </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">xoffset </span><span class="s3">+ </span><span class="s1">x</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">y </span><span class="s3">- </span><span class="s1">line_height</span><span class="s3">)</span>
        <span class="s1">rect</span><span class="s3">.</span><span class="s1">size </span><span class="s3">= </span><span class="s1">texture_width</span><span class="s3">, </span><span class="s1">texture_height</span>
        <span class="s1">rect</span><span class="s3">.</span><span class="s1">texture </span><span class="s3">= </span><span class="s1">texture</span>
        <span class="s1">rect</span><span class="s3">.</span><span class="s1">tex_coords </span><span class="s3">= </span><span class="s1">texcoords</span>
        <span class="s6"># useful to debug rectangle sizes</span>
        <span class="s6"># self.canvas.add(Color(0, .5, 0, .5, mode='rgba'))</span>
        <span class="s6"># self.canvas.add(Rectangle(pos=rect.pos, size=rect.size))</span>
        <span class="s6"># self.canvas.add(Color())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">rect</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">y</span>

    <span class="s2">def </span><span class="s1">_update_graphics_selection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s6"># local references to avoid dot lookups later</span>
        <span class="s1">padding_left</span><span class="s3">, </span><span class="s1">padding_top</span><span class="s3">, </span><span class="s1">padding_right</span><span class="s3">, </span><span class="s1">padding_bottom </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span>
        <span class="s1">rects </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_rects</span>
        <span class="s1">label_cached </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">tab_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tab_width</span>
        <span class="s1">top </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">top</span>
        <span class="s1">get_text_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_text_width</span>
        <span class="s1">get_cursor_from_index </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span>
        <span class="s1">draw_selection </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_draw_selection</span>
        <span class="s1">canvas_add </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">add</span>
        <span class="s1">selection_color </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_color</span>

        <span class="s6"># selection borders</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">((</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span><span class="s3">))</span>
        <span class="s1">selection_start_col</span><span class="s3">, </span><span class="s1">selection_start_row </span><span class="s3">= </span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">selection_end_col</span><span class="s3">, </span><span class="s1">selection_end_row </span><span class="s3">= </span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>

        <span class="s1">dy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">top </span><span class="s3">- </span><span class="s1">padding_top </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">- </span><span class="s1">selection_start_row </span><span class="s3">* </span><span class="s1">dy</span>
        <span class="s1">width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width</span>

        <span class="s1">miny </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y </span><span class="s3">+ </span><span class="s1">padding_bottom</span>
        <span class="s1">maxy </span><span class="s3">= </span><span class="s1">top </span><span class="s3">- </span><span class="s1">padding_top </span><span class="s3">+ </span><span class="s1">dy</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">remove_group</span><span class="s3">(</span><span class="s4">'selection'</span><span class="s3">)</span>
        <span class="s1">first_visible_line </span><span class="s3">= </span><span class="s1">math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">/ </span><span class="s1">dy</span><span class="s3">)</span>
        <span class="s1">last_visible_line </span><span class="s3">= </span><span class="s1">math</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">((</span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">+ </span><span class="s1">maxy </span><span class="s3">- </span><span class="s1">miny</span><span class="s3">) / </span><span class="s1">dy</span><span class="s3">)</span>
        <span class="s1">width_minus_padding </span><span class="s3">= </span><span class="s1">width </span><span class="s3">- (</span><span class="s1">padding_right </span><span class="s3">+ </span><span class="s1">padding_left</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">line_num</span><span class="s3">, </span><span class="s1">rect </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span>
            <span class="s1">islice</span><span class="s3">(</span>
                <span class="s1">rects</span><span class="s3">,</span>
                <span class="s1">max</span><span class="s3">(</span><span class="s1">selection_start_row</span><span class="s3">, </span><span class="s1">first_visible_line</span><span class="s3">),</span>
                <span class="s1">min</span><span class="s3">(</span><span class="s1">selection_end_row </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">last_visible_line </span><span class="s3">- </span><span class="s5">1</span><span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s1">start</span><span class="s3">=</span><span class="s1">max</span><span class="s3">(</span><span class="s1">selection_start_row</span><span class="s3">, </span><span class="s1">first_visible_line</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s1">draw_selection</span><span class="s3">(</span>
                <span class="s1">rect</span><span class="s3">.</span><span class="s1">pos</span><span class="s3">,</span>
                <span class="s1">rect</span><span class="s3">.</span><span class="s1">size</span><span class="s3">,</span>
                <span class="s1">line_num</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s1">selection_start_col</span><span class="s3">, </span><span class="s1">selection_start_row</span><span class="s3">),</span>
                <span class="s3">(</span><span class="s1">selection_end_col</span><span class="s3">, </span><span class="s1">selection_end_row</span><span class="s3">),</span>
                <span class="s1">lines</span><span class="s3">,</span>
                <span class="s1">get_text_width</span><span class="s3">,</span>
                <span class="s1">tab_width</span><span class="s3">,</span>
                <span class="s1">label_cached</span><span class="s3">,</span>
                <span class="s1">width_minus_padding</span><span class="s3">,</span>
                <span class="s1">padding_left</span><span class="s3">,</span>
                <span class="s1">padding_right</span><span class="s3">,</span>
                <span class="s1">x</span><span class="s3">,</span>
                <span class="s1">canvas_add</span><span class="s3">,</span>
                <span class="s1">selection_color</span>
            <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_position_handles</span><span class="s3">(</span><span class="s4">'both'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_draw_selection</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">pos</span><span class="s3">,</span>
        <span class="s1">size</span><span class="s3">,</span>
        <span class="s1">line_num</span><span class="s3">,</span>
        <span class="s1">selection_start</span><span class="s3">,</span>
        <span class="s1">selection_end</span><span class="s3">,</span>
        <span class="s1">lines</span><span class="s3">,</span>
        <span class="s1">get_text_width</span><span class="s3">,</span>
        <span class="s1">tab_width</span><span class="s3">,</span>
        <span class="s1">label_cached</span><span class="s3">,</span>
        <span class="s1">width_minus_padding</span><span class="s3">,</span>
        <span class="s1">padding_left</span><span class="s3">,</span>
        <span class="s1">padding_right</span><span class="s3">,</span>
        <span class="s1">x</span><span class="s3">,</span>
        <span class="s1">canvas_add</span><span class="s3">,</span>
        <span class="s1">selection_color</span>
    <span class="s3">):</span>
        <span class="s1">selection_start_col</span><span class="s3">, </span><span class="s1">selection_start_row </span><span class="s3">= </span><span class="s1">selection_start</span>
        <span class="s1">selection_end_col</span><span class="s3">, </span><span class="s1">selection_end_row </span><span class="s3">= </span><span class="s1">selection_end</span>

        <span class="s6"># Draw the current selection on the widget.</span>
        <span class="s2">if not </span><span class="s1">selection_start_row </span><span class="s3">&lt;= </span><span class="s1">line_num </span><span class="s3">&lt;= </span><span class="s1">selection_end_row</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">pos</span>
        <span class="s1">w</span><span class="s3">, </span><span class="s1">h </span><span class="s3">= </span><span class="s1">size</span>
        <span class="s1">beg </span><span class="s3">= </span><span class="s1">x</span>
        <span class="s1">end </span><span class="s3">= </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">w</span>

        <span class="s2">if </span><span class="s1">line_num </span><span class="s3">== </span><span class="s1">selection_start_row</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">= </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">line_num</span><span class="s3">]</span>
            <span class="s1">beg </span><span class="s3">-= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>
            <span class="s1">beg </span><span class="s3">+= </span><span class="s1">get_text_width</span><span class="s3">(</span>
                <span class="s1">line</span><span class="s3">[:</span><span class="s1">selection_start_col</span><span class="s3">],</span>
                <span class="s1">tab_width</span><span class="s3">,</span>
                <span class="s1">label_cached</span>
            <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">line_num </span><span class="s3">== </span><span class="s1">selection_end_row</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">= </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">line_num</span><span class="s3">]</span>
            <span class="s1">end </span><span class="s3">= (</span><span class="s1">x </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span><span class="s3">) + </span><span class="s1">get_text_width</span><span class="s3">(</span>
                <span class="s1">line</span><span class="s3">[:</span><span class="s1">selection_end_col</span><span class="s3">],</span>
                <span class="s1">tab_width</span><span class="s3">,</span>
                <span class="s1">label_cached</span>
            <span class="s3">)</span>

        <span class="s1">beg </span><span class="s3">= </span><span class="s1">boundary</span><span class="s3">(</span><span class="s1">beg</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">width_minus_padding</span><span class="s3">)</span>
        <span class="s1">end </span><span class="s3">= </span><span class="s1">boundary</span><span class="s3">(</span><span class="s1">end</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">width_minus_padding</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">beg </span><span class="s3">== </span><span class="s1">end</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">canvas_add</span><span class="s3">(</span><span class="s1">Color</span><span class="s3">(*</span><span class="s1">selection_color</span><span class="s3">, </span><span class="s1">group</span><span class="s3">=</span><span class="s4">'selection'</span><span class="s3">))</span>
        <span class="s1">canvas_add</span><span class="s3">(</span>
            <span class="s1">Rectangle</span><span class="s3">(</span>
                <span class="s1">pos</span><span class="s3">=(</span><span class="s1">beg</span><span class="s3">, </span><span class="s1">y</span><span class="s3">),</span>
                <span class="s1">size</span><span class="s3">=(</span><span class="s1">end </span><span class="s3">- </span><span class="s1">beg</span><span class="s3">, </span><span class="s1">h</span><span class="s3">),</span>
                <span class="s1">group</span><span class="s3">=</span><span class="s4">'selection'</span>
            <span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">on_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s6"># if the size change, we might do invalid scrolling / text split</span>
        <span class="s6"># size the text maybe be put after size_hint have been resolved.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_refresh_text</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_hint_text</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s5">0</span>

    <span class="s2">def </span><span class="s1">_get_row_width</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">row</span><span class="s3">):</span>
        <span class="s6"># Get the pixel width of the given row.</span>
        <span class="s1">_labels </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_labels</span>
        <span class="s2">if </span><span class="s1">row </span><span class="s3">&lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">_labels</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_labels</span><span class="s3">[</span><span class="s1">row</span><span class="s3">].</span><span class="s1">width</span>
        <span class="s2">return </span><span class="s5">0</span>

    <span class="s2">def </span><span class="s1">_get_cursor_pos</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># return the current cursor x/y from the row/col</span>
        <span class="s1">dy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span>
        <span class="s1">padding_left </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">padding_top </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">padding_right </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]</span>
        <span class="s1">left </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">padding_left</span>
        <span class="s1">top </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">top </span><span class="s3">- </span><span class="s1">padding_top</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">top </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y</span>
        <span class="s1">y </span><span class="s3">-= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row </span><span class="s3">* </span><span class="s1">dy</span>

        <span class="s6"># Horizontal alignment</span>
        <span class="s1">halign </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">halign</span>
        <span class="s1">viewport_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s1">padding_left </span><span class="s3">- </span><span class="s1">padding_right</span>
        <span class="s1">cursor_offset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_offset</span><span class="s3">()</span>
        <span class="s1">base_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_direction </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolved_base_dir</span>
        <span class="s1">auto_halign_r </span><span class="s3">= </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'auto' </span><span class="s2">and </span><span class="s1">base_dir </span><span class="s2">and </span><span class="s4">'rtl' </span><span class="s2">in </span><span class="s1">base_dir</span>
        <span class="s2">if </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'center'</span><span class="s3">:</span>
            <span class="s1">row_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_row_width</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">= (</span>
                <span class="s1">left</span>
                <span class="s3">+ </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, (</span><span class="s1">viewport_width </span><span class="s3">- </span><span class="s1">row_width</span><span class="s3">) // </span><span class="s5">2</span><span class="s3">)</span>
                <span class="s3">+ </span><span class="s1">cursor_offset</span>
                <span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>
            <span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'right' </span><span class="s2">or </span><span class="s1">auto_halign_r</span><span class="s3">:</span>
            <span class="s1">row_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_row_width</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">= (</span>
                <span class="s1">left</span>
                <span class="s3">+ </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">viewport_width </span><span class="s3">- </span><span class="s1">row_width</span><span class="s3">)</span>
                <span class="s3">+ </span><span class="s1">cursor_offset</span>
                <span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">left </span><span class="s3">+ </span><span class="s1">cursor_offset </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>

        <span class="s2">return </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span>

    <span class="s2">def </span><span class="s1">_get_cursor_visual_height</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Return the height of the cursor's visible part</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">cy </span><span class="s3">= </span><span class="s1">map</span><span class="s3">(</span><span class="s1">int</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_pos</span><span class="s3">)</span>
        <span class="s1">max_y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">top </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">min_y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">y </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">3</span><span class="s3">]</span>

        <span class="s1">lh </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height</span>
        <span class="s2">if </span><span class="s1">cy </span><span class="s3">&gt; </span><span class="s1">max_y</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">lh </span><span class="s3">- </span><span class="s1">min</span><span class="s3">(</span><span class="s1">lh</span><span class="s3">, </span><span class="s1">cy </span><span class="s3">- </span><span class="s1">max_y</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">min</span><span class="s3">(</span><span class="s1">lh</span><span class="s3">, </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">cy </span><span class="s3">- </span><span class="s1">min_y</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_get_cursor_visual_pos</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Return the position of the cursor's top visible point</span>
        <span class="s1">cx</span><span class="s3">, </span><span class="s1">cy </span><span class="s3">= </span><span class="s1">map</span><span class="s3">(</span><span class="s1">int</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_pos</span><span class="s3">)</span>
        <span class="s1">max_y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">top </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">3</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">cx</span><span class="s3">, </span><span class="s1">min</span><span class="s3">(</span><span class="s1">max_y</span><span class="s3">, </span><span class="s1">cy</span><span class="s3">)]</span>

    <span class="s2">def </span><span class="s1">_get_line_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Get or create line options, to be used for Label creation</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_line_options </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_line_options </span><span class="s3">= </span><span class="s1">kw </span><span class="s3">= {</span>
                <span class="s4">'font_size'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">font_size</span><span class="s3">,</span>
                <span class="s4">'font_name'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">font_name</span><span class="s3">,</span>
                <span class="s4">'font_context'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">font_context</span><span class="s3">,</span>
                <span class="s4">'font_family'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">font_family</span><span class="s3">,</span>
                <span class="s4">'text_language'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_language</span><span class="s3">,</span>
                <span class="s4">'base_direction'</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_direction</span><span class="s3">,</span>
                <span class="s4">'anchor_x'</span><span class="s3">: </span><span class="s4">'left'</span><span class="s3">,</span>
                <span class="s4">'anchor_y'</span><span class="s3">: </span><span class="s4">'top'</span><span class="s3">,</span>
                <span class="s4">'padding_x'</span><span class="s3">: </span><span class="s5">0</span><span class="s3">,</span>
                <span class="s4">'padding_y'</span><span class="s3">: </span><span class="s5">0</span><span class="s3">,</span>
                <span class="s4">'padding'</span><span class="s3">: (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
            <span class="s3">}</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached </span><span class="s3">= </span><span class="s1">Label</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_line_options</span>

    <span class="s2">def </span><span class="s1">_create_line_label</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">hint</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s6"># Create a label from a text, using line options</span>
        <span class="s1">ntext </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">u''</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">u'</span><span class="s2">\t</span><span class="s4">'</span><span class="s3">, </span><span class="s4">u' ' </span><span class="s3">* </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tab_width</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password </span><span class="s2">and not </span><span class="s1">hint</span><span class="s3">:  </span><span class="s6"># Don't replace hint_text with *</span>
            <span class="s1">ntext </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password_mask </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ntext</span><span class="s3">)</span>

        <span class="s1">kw </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_options</span><span class="s3">()</span>
        <span class="s1">cid </span><span class="s3">= </span><span class="s4">'%s</span><span class="s2">\0</span><span class="s4">%s' </span><span class="s3">% (</span><span class="s1">ntext</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">))</span>
        <span class="s1">texture </span><span class="s3">= </span><span class="s1">Cache_get</span><span class="s3">(</span><span class="s4">'textinput.label'</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">texture </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s6"># FIXME right now, we can't render very long line...</span>
            <span class="s6"># if we move on &quot;VBO&quot; version as fallback, we won't need to</span>
            <span class="s6"># do this. try to find the maximum text we can handle</span>
            <span class="s1">label </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">label_len </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ntext</span><span class="s3">)</span>
            <span class="s1">ld </span><span class="s3">= </span><span class="s2">None</span>

            <span class="s6"># check for blank line</span>
            <span class="s2">if not </span><span class="s1">ntext</span><span class="s3">:</span>
                <span class="s1">texture </span><span class="s3">= </span><span class="s1">Texture</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
                <span class="s1">Cache_append</span><span class="s3">(</span><span class="s4">'textinput.label'</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">texture</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s1">texture</span>

            <span class="s2">while True</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">label </span><span class="s3">= </span><span class="s1">Label</span><span class="s3">(</span><span class="s1">text</span><span class="s3">=</span><span class="s1">ntext</span><span class="s3">[:</span><span class="s1">label_len</span><span class="s3">], **</span><span class="s1">kw</span><span class="s3">)</span>
                    <span class="s1">label</span><span class="s3">.</span><span class="s1">refresh</span><span class="s3">()</span>
                    <span class="s2">if </span><span class="s1">ld </span><span class="s2">is not None and </span><span class="s1">ld </span><span class="s3">&gt; </span><span class="s5">2</span><span class="s3">:</span>
                        <span class="s1">ld </span><span class="s3">//= </span><span class="s5">2</span>
                        <span class="s1">label_len </span><span class="s3">+= </span><span class="s1">ld</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">break</span>

                <span class="s2">except</span><span class="s3">:</span>
                    <span class="s6"># exception happen when we tried to render the text</span>
                    <span class="s6"># reduce it...</span>
                    <span class="s2">if </span><span class="s1">ld </span><span class="s2">is None</span><span class="s3">:</span>
                        <span class="s1">ld </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ntext</span><span class="s3">)</span>
                    <span class="s1">ld </span><span class="s3">//= </span><span class="s5">2</span>
                    <span class="s2">if </span><span class="s1">ld </span><span class="s3">&lt; </span><span class="s5">2 </span><span class="s2">and </span><span class="s1">label_len</span><span class="s3">:</span>
                        <span class="s1">label_len </span><span class="s3">-= </span><span class="s5">1</span>
                    <span class="s1">label_len </span><span class="s3">-= </span><span class="s1">ld</span>
                    <span class="s2">continue</span>

            <span class="s6"># ok, we found it.</span>
            <span class="s1">texture </span><span class="s3">= </span><span class="s1">label</span><span class="s3">.</span><span class="s1">texture</span>
            <span class="s1">Cache_append</span><span class="s3">(</span><span class="s4">'textinput.label'</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">texture</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">texture</span>

    <span class="s1">_tokenize_delimiters </span><span class="s3">= </span><span class="s4">u' .,:;!?</span><span class="s2">\r\t</span><span class="s4">'</span>

    <span class="s2">def </span><span class="s1">_tokenize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">):</span>
        <span class="s6"># Tokenize a text string from some delimiters</span>
        <span class="s2">if </span><span class="s1">text </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">delimiters </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tokenize_delimiters</span>
        <span class="s1">old_index </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">prev_char </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s2">for </span><span class="s1">index</span><span class="s3">, </span><span class="s1">char </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">char </span><span class="s2">not in </span><span class="s1">delimiters</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">char </span><span class="s3">!= </span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">index </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">and </span><span class="s3">(</span><span class="s1">prev_char </span><span class="s2">in </span><span class="s1">delimiters</span><span class="s3">):</span>
                        <span class="s2">if </span><span class="s1">old_index </span><span class="s3">&lt; </span><span class="s1">index</span><span class="s3">:</span>
                            <span class="s2">yield </span><span class="s1">text</span><span class="s3">[</span><span class="s1">old_index</span><span class="s3">:</span><span class="s1">index</span><span class="s3">]</span>
                        <span class="s1">old_index </span><span class="s3">= </span><span class="s1">index</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">old_index </span><span class="s3">&lt; </span><span class="s1">index</span><span class="s3">:</span>
                        <span class="s2">yield </span><span class="s1">text</span><span class="s3">[</span><span class="s1">old_index</span><span class="s3">:</span><span class="s1">index</span><span class="s3">]</span>
                    <span class="s2">yield </span><span class="s1">text</span><span class="s3">[</span><span class="s1">index</span><span class="s3">:</span><span class="s1">index </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">]</span>
                    <span class="s1">old_index </span><span class="s3">= </span><span class="s1">index </span><span class="s3">+ </span><span class="s5">1</span>
            <span class="s1">prev_char </span><span class="s3">= </span><span class="s1">char</span>
        <span class="s2">yield </span><span class="s1">text</span><span class="s3">[</span><span class="s1">old_index</span><span class="s3">:]</span>

    <span class="s2">def </span><span class="s1">_split_smart</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Do a &quot;smart&quot; split. If not multiline, or if wrap is set, 
        we are not doing smart split, just a split on line break. 
        Otherwise, we are trying to split as soon as possible, to prevent 
        overflow on the widget. 
        &quot;&quot;&quot;</span>

        <span class="s6"># depend of the options, split the text on line, or word</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline </span><span class="s2">or not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">do_wrap</span><span class="s3">:</span>
            <span class="s1">lines </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s1">lines_flags </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">] + [</span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">] * (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags</span>

        <span class="s6"># no autosize, do wordwrap.</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">flags </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">line </span><span class="s3">= []</span>
        <span class="s1">lines </span><span class="s3">= []</span>
        <span class="s1">lines_flags </span><span class="s3">= []</span>
        <span class="s1">_join </span><span class="s3">= </span><span class="s4">u''</span><span class="s3">.</span><span class="s1">join</span>
        <span class="s1">lines_append</span><span class="s3">, </span><span class="s1">lines_flags_append </span><span class="s3">= </span><span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">, </span><span class="s1">lines_flags</span><span class="s3">.</span><span class="s1">append</span>
        <span class="s1">padding_left </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">padding_right </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]</span>
        <span class="s1">width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s1">padding_left </span><span class="s3">- </span><span class="s1">padding_right</span>
        <span class="s1">text_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_text_width</span>
        <span class="s1">_tab_width</span><span class="s3">, </span><span class="s1">_label_cached </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tab_width</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_label_cached</span>

        <span class="s6"># try to add each word on current line.</span>
        <span class="s1">words_widths </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">word </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tokenize</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">is_newline </span><span class="s3">= (</span><span class="s1">word </span><span class="s3">== </span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">w </span><span class="s3">= </span><span class="s1">words_widths</span><span class="s3">[</span><span class="s1">word</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                <span class="s1">w </span><span class="s3">= </span><span class="s1">text_width</span><span class="s3">(</span><span class="s1">word</span><span class="s3">, </span><span class="s1">_tab_width</span><span class="s3">, </span><span class="s1">_label_cached</span><span class="s3">)</span>
                <span class="s1">words_widths</span><span class="s3">[</span><span class="s1">word</span><span class="s3">] = </span><span class="s1">w</span>
            <span class="s6"># if we have more than the width, or if it's a newline,</span>
            <span class="s6"># push the current line, and create a new one</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">w </span><span class="s3">&gt; </span><span class="s1">width </span><span class="s2">and </span><span class="s1">line</span><span class="s3">) </span><span class="s2">or </span><span class="s1">is_newline</span><span class="s3">:</span>
                <span class="s1">lines_append</span><span class="s3">(</span><span class="s1">_join</span><span class="s3">(</span><span class="s1">line</span><span class="s3">))</span>
                <span class="s1">lines_flags_append</span><span class="s3">(</span><span class="s1">flags</span><span class="s3">)</span>
                <span class="s1">flags </span><span class="s3">= </span><span class="s5">0</span>
                <span class="s1">line </span><span class="s3">= []</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s2">if </span><span class="s1">is_newline</span><span class="s3">:</span>
                <span class="s1">flags </span><span class="s3">|= </span><span class="s1">FL_IS_LINEBREAK</span>
            <span class="s2">elif </span><span class="s1">width </span><span class="s3">&gt;= </span><span class="s5">1 </span><span class="s2">and </span><span class="s1">w </span><span class="s3">&gt; </span><span class="s1">width</span><span class="s3">:</span>
                <span class="s2">while </span><span class="s1">w </span><span class="s3">&gt; </span><span class="s1">width</span><span class="s3">:</span>
                    <span class="s1">split_width </span><span class="s3">= </span><span class="s1">split_pos </span><span class="s3">= </span><span class="s5">0</span>
                    <span class="s6"># split the word</span>
                    <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">word</span><span class="s3">:</span>
                        <span class="s2">try</span><span class="s3">:</span>
                            <span class="s1">cw </span><span class="s3">= </span><span class="s1">words_widths</span><span class="s3">[</span><span class="s1">c</span><span class="s3">]</span>
                        <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                            <span class="s1">cw </span><span class="s3">= </span><span class="s1">text_width</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, </span><span class="s1">_tab_width</span><span class="s3">, </span><span class="s1">_label_cached</span><span class="s3">)</span>
                            <span class="s1">words_widths</span><span class="s3">[</span><span class="s1">c</span><span class="s3">] = </span><span class="s1">cw</span>
                        <span class="s2">if </span><span class="s1">split_width </span><span class="s3">+ </span><span class="s1">cw </span><span class="s3">&gt; </span><span class="s1">width</span><span class="s3">:</span>
                            <span class="s2">break</span>
                        <span class="s1">split_width </span><span class="s3">+= </span><span class="s1">cw</span>
                        <span class="s1">split_pos </span><span class="s3">+= </span><span class="s5">1</span>
                    <span class="s2">if </span><span class="s1">split_width </span><span class="s3">== </span><span class="s1">split_pos </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                        <span class="s6"># can't fit the word in, give up</span>
                        <span class="s2">break</span>
                    <span class="s1">lines_append</span><span class="s3">(</span><span class="s1">word</span><span class="s3">[:</span><span class="s1">split_pos</span><span class="s3">])</span>
                    <span class="s1">lines_flags_append</span><span class="s3">(</span><span class="s1">flags</span><span class="s3">)</span>
                    <span class="s1">flags </span><span class="s3">= </span><span class="s1">FL_IS_WORDBREAK</span>
                    <span class="s1">word </span><span class="s3">= </span><span class="s1">word</span><span class="s3">[</span><span class="s1">split_pos</span><span class="s3">:]</span>
                    <span class="s1">w </span><span class="s3">-= </span><span class="s1">split_width</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">w</span>
                <span class="s1">line</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">word</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">x </span><span class="s3">+= </span><span class="s1">w</span>
                <span class="s1">line</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">word</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">line </span><span class="s2">or </span><span class="s1">flags </span><span class="s3">&amp; </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">:</span>
            <span class="s1">lines_append</span><span class="s3">(</span><span class="s1">_join</span><span class="s3">(</span><span class="s1">line</span><span class="s3">))</span>
            <span class="s1">lines_flags_append</span><span class="s3">(</span><span class="s1">flags</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">lines</span><span class="s3">, </span><span class="s1">lines_flags</span>

    <span class="s2">def </span><span class="s1">_key_down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">repeat</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">displayed_str</span><span class="s3">, </span><span class="s1">internal_str</span><span class="s3">, </span><span class="s1">internal_action</span><span class="s3">, </span><span class="s1">scale </span><span class="s3">= </span><span class="s1">key</span>

        <span class="s6"># handle deletion</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span>
            <span class="s2">and </span><span class="s1">internal_action </span><span class="s2">in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">'del'</span><span class="s3">, </span><span class="s4">'backspace'</span><span class="s3">, </span><span class="s4">'enter'</span><span class="s3">)</span>
            <span class="s2">and </span><span class="s3">(</span><span class="s1">internal_action </span><span class="s3">!= </span><span class="s4">'enter' </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'del'</span><span class="s3">:</span>
            <span class="s6"># Move cursor one char to the right. If that was successful,</span>
            <span class="s6"># do a backspace (effectively deleting char right of cursor)</span>
            <span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">do_cursor_movement</span><span class="s3">(</span><span class="s4">'cursor_right'</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">cursor </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">do_backspace</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">=</span><span class="s4">'del'</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'backspace'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">do_backspace</span><span class="s3">()</span>

        <span class="s6"># handle action keys and text insertion</span>
        <span class="s2">if </span><span class="s1">internal_action </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">displayed_str</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'shift'</span><span class="s3">, </span><span class="s4">'shift_L'</span><span class="s3">, </span><span class="s4">'shift_R'</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'ctrl_L'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_l </span><span class="s3">= </span><span class="s2">True</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'ctrl_R'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_r </span><span class="s3">= </span><span class="s2">True</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'alt_L'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_l </span><span class="s3">= </span><span class="s2">True</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'alt_R'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_r </span><span class="s3">= </span><span class="s2">True</span>

        <span class="s2">elif </span><span class="s1">internal_action</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'cursor_'</span><span class="s3">):</span>
            <span class="s1">cc</span><span class="s3">, </span><span class="s1">cr </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">do_cursor_movement</span><span class="s3">(</span>
                <span class="s1">internal_action</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_l </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_r</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_l </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_r</span>
            <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s2">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_finished</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cancel_selection</span><span class="s3">()</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'enter'</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_text_validate'</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_validate_unfocus</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">focus </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'escape'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">focus </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">_key_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">repeat</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">displayed_str</span><span class="s3">, </span><span class="s1">internal_str</span><span class="s3">, </span><span class="s1">internal_action</span><span class="s3">, </span><span class="s1">scale </span><span class="s3">= </span><span class="s1">key</span>
        <span class="s2">if </span><span class="s1">internal_action </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'shift'</span><span class="s3">, </span><span class="s4">'shift_L'</span><span class="s3">, </span><span class="s4">'shift_R'</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_update_selection</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'ctrl_L'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_l </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'ctrl_R'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ctrl_r </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'alt_L'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_l </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">elif </span><span class="s1">internal_action </span><span class="s3">== </span><span class="s4">'alt_R'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_alt_r </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">keyboard_on_key_down</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">window</span><span class="s3">, </span><span class="s1">keycode</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">modifiers</span><span class="s3">):</span>
        <span class="s1">key</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">keycode</span>
        <span class="s1">win </span><span class="s3">= </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span>

        <span class="s6"># This allows *either* ctrl *or* cmd, but not both.</span>
        <span class="s1">modifiers </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">modifiers</span><span class="s3">) - {</span><span class="s4">'capslock'</span><span class="s3">, </span><span class="s4">'numlock'</span><span class="s3">}</span>
        <span class="s1">is_shortcut </span><span class="s3">= (</span>
            <span class="s1">modifiers </span><span class="s3">== {</span><span class="s4">'ctrl'</span><span class="s3">}</span>
            <span class="s2">or </span><span class="s1">_is_osx </span><span class="s2">and </span><span class="s1">modifiers </span><span class="s3">== {</span><span class="s4">'meta'</span><span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">is_interesting_key </span><span class="s3">= </span><span class="s1">key </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">interesting_keys</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s3">(</span>
            <span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">write_tab</span>
            <span class="s2">and </span><span class="s1">super</span><span class="s3">().</span><span class="s1">keyboard_on_key_down</span><span class="s3">(</span><span class="s1">window</span><span class="s3">, </span><span class="s1">keycode</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">modifiers</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s2">return True</span>

        <span class="s2">if </span><span class="s1">text </span><span class="s2">and </span><span class="s1">is_shortcut </span><span class="s2">and not </span><span class="s1">is_interesting_key</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_shortcut</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>

        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_editable </span><span class="s2">and </span><span class="s1">text </span><span class="s2">and not </span><span class="s1">is_interesting_key</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_handles</span><span class="s3">(</span><span class="s1">win</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_cut_copy_paste</span><span class="s3">(</span><span class="s1">win</span><span class="s3">)</span>
            <span class="s1">win</span><span class="s3">.</span><span class="s1">remove_widget</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span><span class="s3">)</span>

            <span class="s6"># check for command modes</span>
            <span class="s6"># we use \x01INFO\x02 to get info from IME on mobiles</span>
            <span class="s6"># pygame seems to pass \x01 as the unicode for ctrl+a</span>
            <span class="s6"># checking for modifiers ensures conflict resolution.</span>

            <span class="s1">first_char </span><span class="s3">= </span><span class="s1">ord</span><span class="s3">(</span><span class="s1">text</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
            <span class="s2">if not </span><span class="s1">modifiers </span><span class="s2">and </span><span class="s1">first_char </span><span class="s3">== </span><span class="s5">1</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_command_mode </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_command </span><span class="s3">= </span><span class="s4">''</span>
            <span class="s2">if not </span><span class="s1">modifiers </span><span class="s2">and </span><span class="s1">first_char </span><span class="s3">== </span><span class="s5">2</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_command_mode </span><span class="s3">= </span><span class="s2">False</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_command </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_command</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:]</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_command_mode</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_command </span><span class="s3">+= </span><span class="s1">text</span>
                <span class="s2">return</span>

            <span class="s1">_command </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_command</span>
            <span class="s2">if </span><span class="s1">_command </span><span class="s2">and </span><span class="s1">first_char </span><span class="s3">== </span><span class="s5">2</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_command</span><span class="s3">(</span><span class="s1">_command</span><span class="s3">)</span>
                <span class="s2">return</span>

            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">EventLoop</span><span class="s3">.</span><span class="s1">window</span><span class="s3">.</span><span class="s1">managed_textinput</span><span class="s3">:</span>
                    <span class="s6"># we expect to get managed key input via on_textinput</span>
                    <span class="s2">return</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
            <span class="s6"># self._recalc_size()</span>
            <span class="s2">return</span>

        <span class="s2">if </span><span class="s1">is_interesting_key</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_cut_copy_paste</span><span class="s3">(</span><span class="s1">win</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_hide_handles</span><span class="s3">(</span><span class="s1">win</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">key </span><span class="s3">== </span><span class="s5">27</span><span class="s3">:  </span><span class="s6"># escape</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">focus </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">return True</span>
        <span class="s2">elif </span><span class="s1">key </span><span class="s3">== </span><span class="s5">9</span><span class="s3">:  </span><span class="s6"># tab</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s4">u'</span><span class="s2">\t</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s2">return True</span>

        <span class="s1">k </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">interesting_keys</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">k</span><span class="s3">:</span>
            <span class="s1">key </span><span class="s3">= (</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_key_down</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_handle_command</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">command</span><span class="s3">):</span>
        <span class="s1">from_undo </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">command</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">command</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">':'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_command </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">command </span><span class="s3">== </span><span class="s4">'DEL'</span><span class="s3">:</span>
            <span class="s1">count </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">count</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">(</span><span class="s1">from_undo</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">end </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">end </span><span class="s3">- </span><span class="s1">count</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to </span><span class="s3">= </span><span class="s1">end</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_selection </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">(</span><span class="s1">from_undo</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s2">elif </span><span class="s1">command </span><span class="s3">== </span><span class="s4">'INSERT'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">command </span><span class="s3">== </span><span class="s4">'INSERTN'</span><span class="s3">:</span>
            <span class="s1">from_undo </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">from_undo</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">command </span><span class="s3">== </span><span class="s4">'SELWORD'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispatch</span><span class="s3">(</span><span class="s4">'on_double_tap'</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">command </span><span class="s3">== </span><span class="s4">'SEL'</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">data </span><span class="s3">== </span><span class="s4">'0'</span><span class="s3">:</span>
                <span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_once</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">dt</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cancel_selection</span><span class="s3">())</span>
        <span class="s2">elif </span><span class="s1">command </span><span class="s3">== </span><span class="s4">'CURCOL'</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row</span>

    <span class="s2">def </span><span class="s1">_handle_shortcut</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">):</span>
        <span class="s6"># actions that can be done in readonly</span>
        <span class="s2">if </span><span class="s1">key </span><span class="s3">== </span><span class="s1">ord</span><span class="s3">(</span><span class="s4">'a'</span><span class="s3">):  </span><span class="s6"># select all</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">select_all</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">key </span><span class="s3">== </span><span class="s1">ord</span><span class="s3">(</span><span class="s4">'c'</span><span class="s3">):  </span><span class="s6"># copy selection</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_editable</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s6"># actions that can be done only if editable</span>
        <span class="s2">if </span><span class="s1">key </span><span class="s3">== </span><span class="s1">ord</span><span class="s3">(</span><span class="s4">'x'</span><span class="s3">):  </span><span class="s6"># cut selection</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_cut</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">selection_text</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">key </span><span class="s3">== </span><span class="s1">ord</span><span class="s3">(</span><span class="s4">'v'</span><span class="s3">):  </span><span class="s6"># paste clipboard content</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">key </span><span class="s3">== </span><span class="s1">ord</span><span class="s3">(</span><span class="s4">'z'</span><span class="s3">):  </span><span class="s6"># undo</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">do_undo</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">key </span><span class="s3">== </span><span class="s1">ord</span><span class="s3">(</span><span class="s4">'r'</span><span class="s3">):  </span><span class="s6"># redo</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">do_redo</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">keyboard_on_key_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">window</span><span class="s3">, </span><span class="s1">keycode</span><span class="s3">):</span>
        <span class="s1">key </span><span class="s3">= </span><span class="s1">keycode</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">interesting_keys</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">k</span><span class="s3">:</span>
            <span class="s1">key </span><span class="s3">= (</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_key_up</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">keyboard_on_textinput</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">window</span><span class="s3">, </span><span class="s1">text</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">insert_text</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s6"># current IME composition in progress by the IME system, or '' if nothing</span>
    <span class="s1">_ime_composition </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s4">''</span><span class="s3">)</span>
    <span class="s6"># cursor position of last IME event</span>
    <span class="s1">_ime_cursor </span><span class="s3">= </span><span class="s1">ListProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">allownone</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_bind_keyboard</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">_bind_keyboard</span><span class="s3">()</span>
        <span class="s1">Window</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">on_textedit</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">window_on_textedit</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_unbind_keyboard</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">_unbind_keyboard</span><span class="s3">()</span>
        <span class="s1">Window</span><span class="s3">.</span><span class="s1">unbind</span><span class="s3">(</span><span class="s1">on_textedit</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">window_on_textedit</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">window_on_textedit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">window</span><span class="s3">, </span><span class="s1">ime_input</span><span class="s3">):</span>
        <span class="s1">text_lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines </span><span class="s2">or </span><span class="s3">[</span><span class="s4">''</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ime_composition</span><span class="s3">:</span>
            <span class="s1">pcc</span><span class="s3">, </span><span class="s1">pcr </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ime_cursor</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">text_lines</span><span class="s3">[</span><span class="s1">pcr</span><span class="s3">]</span>
            <span class="s1">len_ime </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ime_composition</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">text</span><span class="s3">[</span><span class="s1">pcc </span><span class="s3">- </span><span class="s1">len_ime</span><span class="s3">:</span><span class="s1">pcc</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ime_composition</span><span class="s3">:  </span><span class="s6"># always?</span>
                <span class="s1">remove_old_ime_text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">[:</span><span class="s1">pcc </span><span class="s3">- </span><span class="s1">len_ime</span><span class="s3">] + </span><span class="s1">text</span><span class="s3">[</span><span class="s1">pcc</span><span class="s3">:]</span>
                <span class="s1">ci </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">(</span>
                    <span class="s4">&quot;insert&quot;</span><span class="s3">,</span>
                    <span class="s3">*</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_from_cursor</span><span class="s3">(</span><span class="s1">pcr</span><span class="s3">, </span><span class="s1">remove_old_ime_text</span><span class="s3">)</span>
                <span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">ci </span><span class="s3">- </span><span class="s1">len_ime</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">ime_input</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">delete_selection</span><span class="s3">()</span>
            <span class="s1">cc</span><span class="s3">, </span><span class="s1">cr </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">text_lines</span><span class="s3">[</span><span class="s1">cr</span><span class="s3">]</span>
            <span class="s1">new_text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">[:</span><span class="s1">cc</span><span class="s3">] + </span><span class="s1">ime_input </span><span class="s3">+ </span><span class="s1">text</span><span class="s3">[</span><span class="s1">cc</span><span class="s3">:]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text_from_property</span><span class="s3">(</span>
                <span class="s4">&quot;insert&quot;</span><span class="s3">, *</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_line_from_cursor</span><span class="s3">(</span><span class="s1">cr</span><span class="s3">, </span><span class="s1">new_text</span><span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_index</span><span class="s3">() + </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ime_input</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ime_composition </span><span class="s3">= </span><span class="s1">ime_input</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ime_cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor</span>

    <span class="s2">def </span><span class="s1">on__hint_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_hint_text</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_refresh_hint_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_lines</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_split_smart</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">hint_text</span><span class="s3">)</span>
        <span class="s1">_hint_text_labels </span><span class="s3">= []</span>
        <span class="s1">_hint_text_rects </span><span class="s3">= []</span>
        <span class="s1">_create_label </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_create_line_label</span>

        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">_lines</span><span class="s3">:</span>
            <span class="s1">lbl </span><span class="s3">= </span><span class="s1">_create_label</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">hint</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">_hint_text_labels</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">lbl</span><span class="s3">)</span>
            <span class="s1">_hint_text_rects</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">Rectangle</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">lbl</span><span class="s3">.</span><span class="s1">size</span><span class="s3">))</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_lines</span><span class="s3">[:] = </span><span class="s1">_lines</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_labels </span><span class="s3">= </span><span class="s1">_hint_text_labels</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text_rects </span><span class="s3">= </span><span class="s1">_hint_text_rects</span>

        <span class="s6"># Remember to update graphics</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_graphics</span><span class="s3">()</span>

    <span class="s6">#</span>
    <span class="s6"># Properties</span>
    <span class="s6">#</span>

    <span class="s1">_lines </span><span class="s3">= </span><span class="s1">ListProperty</span><span class="s3">([])</span>
    <span class="s1">_hint_text_lines </span><span class="s3">= </span><span class="s1">ListProperty</span><span class="s3">([])</span>
    <span class="s1">_editable </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">_insert_int_pat </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">u'^-?[0-9]*$'</span><span class="s3">)</span>
    <span class="s1">_insert_float_pat </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">u'^-?[0-9]*</span><span class="s2">\\</span><span class="s4">.?[0-9]*$'</span><span class="s3">)</span>
    <span class="s1">_cursor_blink </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">_cursor_visual_pos </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span>
        <span class="s1">_get_cursor_visual_pos</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">bind</span><span class="s3">=[</span><span class="s4">'cursor_pos'</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">_cursor_visual_height </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span>
        <span class="s1">_get_cursor_visual_height</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">bind</span><span class="s3">=[</span><span class="s4">'cursor_pos'</span><span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">readonly </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s4">'''If True, the user will not be able to change the content of a textinput. 
 
    .. versionadded:: 1.3.0 
 
    :attr:`readonly` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to False. 
    '''</span>

    <span class="s1">text_validate_unfocus </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''If True, the :meth:`TextInput.on_text_validate` event will unfocus the 
    widget, therefore make it stop listening to the keyboard. When disabled, 
    the :meth:`TextInput.on_text_validate` event can be fired multiple times 
    as the result of TextInput keeping the focus enabled. 
 
    .. versionadded:: 1.10.1 
 
    :attr:`text_validate_unfocus` is 
    a :class:`~kivy.properties.BooleanProperty` and defaults to True. 
    '''</span>

    <span class="s1">multiline </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''If True, the widget will be able show multiple lines of text. If False, 
    the &quot;enter&quot; keypress will defocus the textinput instead of adding a new 
    line. 
 
    :attr:`multiline` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to True. 
    '''</span>

    <span class="s1">do_wrap </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''If True, and the text is multiline, then lines larger than the width of 
    the widget will wrap around to the next line, avoiding the need for 
    horizontal scrolling. Disabling this option ensure one line is always 
    displayed as one line. 
 
    :attr:`do_wrap` is a :class:`~kivy.properties.BooleanProperty` and defaults 
    to True. 
 
    versionadded:: 2.1.0 
    '''</span>

    <span class="s1">password </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s4">'''If True, the widget will display its characters as the character 
    set in :attr:`password_mask`. 
 
    .. versionadded:: 1.2.0 
 
    :attr:`password` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to False. 
    '''</span>

    <span class="s1">password_mask </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s4">'*'</span><span class="s3">)</span>
    <span class="s4">'''Sets the character used to mask the text when :attr:`password` is True. 
 
    .. versionadded:: 1.10.0 
 
    :attr:`password_mask` is a :class:`~kivy.properties.StringProperty` and 
    defaults to `'*'`. 
    '''</span>

    <span class="s1">cursor_blink </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''This property is used to set whether the graphic cursor should blink 
    or not. 
 
    .. versionchanged:: 1.10.1 
        `cursor_blink` has been refactored to enable switching the blinking 
        on/off and the previous behavior has been moved to a private 
        `_cursor_blink` property. The previous default value `False` has been 
        changed to `True`. 
 
    :attr:`cursor_blink` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to True. 
    '''</span>

    <span class="s2">def </span><span class="s1">_get_cursor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor</span>

    <span class="s2">def </span><span class="s1">_set_cursor</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_refresh_text</span><span class="s3">()</span>
            <span class="s2">return</span>
        <span class="s1">l </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">cr </span><span class="s3">= </span><span class="s1">boundary</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">l</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">cc </span><span class="s3">= </span><span class="s1">boundary</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">l</span><span class="s3">[</span><span class="s1">cr</span><span class="s3">]))</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cc</span><span class="s3">, </span><span class="s1">cr</span>

        <span class="s6"># adjust scrollview to ensure that the cursor will be always inside our</span>
        <span class="s6"># viewport.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_adjust_viewport</span><span class="s3">(</span><span class="s1">cc</span><span class="s3">, </span><span class="s1">cr</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor </span><span class="s3">== </span><span class="s1">cursor</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor </span><span class="s3">= </span><span class="s1">cursor</span>
        <span class="s2">return True</span>

    <span class="s3">@</span><span class="s1">triggered</span><span class="s3">(</span><span class="s1">timeout</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">_adjust_viewport</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cc</span><span class="s3">, </span><span class="s1">cr</span><span class="s3">):</span>
        <span class="s1">padding_left </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">padding_right </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]</span>
        <span class="s1">viewport_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">width </span><span class="s3">- </span><span class="s1">padding_left </span><span class="s3">- </span><span class="s1">padding_right</span>
        <span class="s1">sx </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x</span>
        <span class="s1">base_dir </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">base_direction </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolved_base_dir</span>
        <span class="s1">auto_halign_r </span><span class="s3">= (</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">halign </span><span class="s3">== </span><span class="s4">'auto'</span>
            <span class="s2">and </span><span class="s1">base_dir</span>
            <span class="s2">and </span><span class="s4">'rtl' </span><span class="s2">in </span><span class="s1">base_dir</span>
        <span class="s3">)</span>

        <span class="s1">offset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_offset</span><span class="s3">()</span>
        <span class="s1">row_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_row_width</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">cursor_row</span><span class="s3">)</span>

        <span class="s6"># if offset is outside the current bounds, readjust</span>
        <span class="s2">if </span><span class="s1">offset </span><span class="s3">- </span><span class="s1">sx </span><span class="s3">&gt;= </span><span class="s1">viewport_width</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">offset </span><span class="s3">- </span><span class="s1">viewport_width</span>
        <span class="s2">elif </span><span class="s1">offset </span><span class="s3">&lt; </span><span class="s1">sx </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">offset</span>

        <span class="s6"># Avoid right/center horizontal alignment issues if the viewport is at</span>
        <span class="s6"># the end of the line, if not multiline.</span>
        <span class="s1">viewport_scroll_x </span><span class="s3">= </span><span class="s1">row_width </span><span class="s3">- </span><span class="s1">viewport_width</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline</span>
            <span class="s2">and </span><span class="s1">offset </span><span class="s3">&gt;= </span><span class="s1">viewport_scroll_x</span>
            <span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">&gt;= </span><span class="s1">viewport_scroll_x</span>
            <span class="s2">and </span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">halign </span><span class="s3">== </span><span class="s4">&quot;center&quot;</span>
                <span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">halign </span><span class="s3">== </span><span class="s4">&quot;right&quot;</span>
                <span class="s2">or </span><span class="s1">auto_halign_r</span>
            <span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">viewport_scroll_x</span><span class="s3">)</span>

        <span class="s6"># do the same for Y</span>
        <span class="s6"># this algo try to center the cursor as much as possible</span>
        <span class="s1">dy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span>
        <span class="s1">offsety </span><span class="s3">= </span><span class="s1">cr </span><span class="s3">* </span><span class="s1">dy</span>

        <span class="s1">padding_top </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">padding_bottom </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">viewport_height </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">height </span><span class="s3">- </span><span class="s1">padding_top </span><span class="s3">- </span><span class="s1">padding_bottom </span><span class="s3">- </span><span class="s1">dy</span>

        <span class="s1">sy </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y</span>
        <span class="s2">if </span><span class="s1">offsety </span><span class="s3">&gt; </span><span class="s1">viewport_height </span><span class="s3">+ </span><span class="s1">sy</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">offsety </span><span class="s3">- </span><span class="s1">viewport_height</span>
        <span class="s2">elif </span><span class="s1">offsety </span><span class="s3">&lt; </span><span class="s1">sy</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">offsety</span>

    <span class="s1">cursor </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span><span class="s1">_get_cursor</span><span class="s3">, </span><span class="s1">_set_cursor</span><span class="s3">)</span>
    <span class="s4">'''Tuple of (col, row) values indicating the current cursor position. 
    You can set a new (col, row) if you want to move the cursor. The scrolling 
    area will be automatically updated to ensure that the cursor is 
    visible inside the viewport. 
 
    :attr:`cursor` is an :class:`~kivy.properties.AliasProperty`. 
    '''</span>

    <span class="s2">def </span><span class="s1">_get_cursor_col</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

    <span class="s1">cursor_col </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span><span class="s1">_get_cursor_col</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">bind</span><span class="s3">=(</span><span class="s4">'cursor'</span><span class="s3">, ))</span>
    <span class="s4">'''Current column of the cursor. 
 
    :attr:`cursor_col` is an :class:`~kivy.properties.AliasProperty` to 
    cursor[0], read-only. 
    '''</span>

    <span class="s2">def </span><span class="s1">_get_cursor_row</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cursor</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s1">cursor_row </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span><span class="s1">_get_cursor_row</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">bind</span><span class="s3">=(</span><span class="s4">'cursor'</span><span class="s3">, ))</span>
    <span class="s4">'''Current row of the cursor. 
 
    :attr:`cursor_row` is an :class:`~kivy.properties.AliasProperty` to 
    cursor[1], read-only. 
    '''</span>

    <span class="s1">cursor_pos </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span><span class="s1">_get_cursor_pos</span><span class="s3">, </span><span class="s2">None</span><span class="s3">,</span>
                               <span class="s1">bind</span><span class="s3">=(</span><span class="s4">'cursor'</span><span class="s3">, </span><span class="s4">'padding'</span><span class="s3">, </span><span class="s4">'pos'</span><span class="s3">, </span><span class="s4">'size'</span><span class="s3">,</span>
                                     <span class="s4">'focus'</span><span class="s3">, </span><span class="s4">'scroll_x'</span><span class="s3">, </span><span class="s4">'scroll_y'</span><span class="s3">,</span>
                                     <span class="s4">'line_height'</span><span class="s3">, </span><span class="s4">'line_spacing'</span><span class="s3">),</span>
                               <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s4">'''Current position of the cursor, in (x, y). 
 
    :attr:`cursor_pos` is an :class:`~kivy.properties.AliasProperty`, 
    read-only. 
    '''</span>

    <span class="s1">cursor_color </span><span class="s3">= </span><span class="s1">ColorProperty</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
    <span class="s4">'''Current color of the cursor, in (r, g, b, a) format. 
 
    .. versionadded:: 1.9.0 
 
    :attr:`cursor_color` is a :class:`~kivy.properties.ColorProperty` and 
    defaults to [1, 0, 0, 1]. 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">cursor_width </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s4">'1sp'</span><span class="s3">)</span>
    <span class="s4">'''Current width of the cursor. 
 
    .. versionadded:: 1.10.0 
 
    :attr:`cursor_width` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to '1sp'. 
    '''</span>

    <span class="s1">line_height </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s4">'''Height of a line. This property is automatically computed from the 
    :attr:`font_name`, :attr:`font_size`. Changing the line_height will have 
    no impact. 
 
    .. note:: 
 
        :attr:`line_height` is the height of a single line of text. 
        Use :attr:`minimum_height`, which also includes padding, to 
        get the height required to display the text properly. 
 
    :attr:`line_height` is a :class:`~kivy.properties.NumericProperty`, 
    read-only. 
    '''</span>

    <span class="s1">tab_width </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)</span>
    <span class="s4">'''By default, each tab will be replaced by four spaces on the text 
    input widget. You can set a lower or higher value. 
 
    :attr:`tab_width` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 4. 
    '''</span>

    <span class="s1">padding_x </span><span class="s3">= </span><span class="s1">VariableListProperty</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">length</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">deprecated</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Horizontal padding of the text: [padding_left, padding_right]. 
 
    padding_x also accepts a one argument form [padding_horizontal]. 
 
    :attr:`padding_x` is a :class:`~kivy.properties.VariableListProperty` and 
    defaults to [0, 0]. This might be changed by the current theme. 
 
    .. deprecated:: 1.7.0 
        Use :attr:`padding` instead. 
    '''</span>

    <span class="s2">def </span><span class="s1">on_padding_x</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s1">value</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">2</span><span class="s3">] = </span><span class="s1">value</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s1">padding_y </span><span class="s3">= </span><span class="s1">VariableListProperty</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">length</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">deprecated</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Vertical padding of the text: [padding_top, padding_bottom]. 
 
    padding_y also accepts a one argument form [padding_vertical]. 
 
    :attr:`padding_y` is a :class:`~kivy.properties.VariableListProperty` and 
    defaults to [0, 0]. This might be changed by the current theme. 
 
    .. deprecated:: 1.7.0 
        Use :attr:`padding` instead. 
    '''</span>

    <span class="s2">def </span><span class="s1">on_padding_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] = </span><span class="s1">value</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">3</span><span class="s3">] = </span><span class="s1">value</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s1">padding </span><span class="s3">= </span><span class="s1">VariableListProperty</span><span class="s3">([</span><span class="s5">6</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">6</span><span class="s3">])</span>
    <span class="s4">'''Padding of the text: [padding_left, padding_top, padding_right, 
    padding_bottom]. 
 
    padding also accepts a two argument form [padding_horizontal, 
    padding_vertical] and a one argument form [padding]. 
 
    .. versionchanged:: 1.7.0 
        Replaced AliasProperty with VariableListProperty. 
 
    :attr:`padding` is a :class:`~kivy.properties.VariableListProperty` and 
    defaults to [6, 6, 6, 6]. 
    '''</span>

    <span class="s1">halign </span><span class="s3">= </span><span class="s1">OptionProperty</span><span class="s3">(</span><span class="s4">'auto'</span><span class="s3">, </span><span class="s1">options</span><span class="s3">=[</span><span class="s4">'left'</span><span class="s3">, </span><span class="s4">'center'</span><span class="s3">, </span><span class="s4">'right'</span><span class="s3">,</span>
                            <span class="s4">'auto'</span><span class="s3">])</span>
    <span class="s4">'''Horizontal alignment of the text. 
 
    :attr:`halign` is an :class:`~kivy.properties.OptionProperty` and 
    defaults to 'auto'. Available options are : auto, left, center and right. 
    Auto will attempt to autodetect horizontal alignment for RTL text (Pango 
    only), otherwise it behaves like `left`. 
 
    .. versionadded:: 1.10.1 
    '''</span>

    <span class="s1">scroll_x </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s4">'''X scrolling value of the viewport. The scrolling is automatically 
    updated when the cursor is moved or text changed. If there is no 
    user input, the scroll_x and scroll_y properties may be changed. 
 
    :attr:`scroll_x` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 0. 
    '''</span>

    <span class="s1">scroll_y </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s4">'''Y scrolling value of the viewport. See :attr:`scroll_x` for more 
    information. 
 
    :attr:`scroll_y` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 0. 
    '''</span>

    <span class="s1">selection_color </span><span class="s3">= </span><span class="s1">ColorProperty</span><span class="s3">([</span><span class="s5">0.1843</span><span class="s3">, </span><span class="s5">0.6549</span><span class="s3">, </span><span class="s5">0.8313</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">])</span>
    <span class="s4">'''Current color of the selection, in (r, g, b, a) format. 
 
    .. warning:: 
 
        The color should always have an &quot;alpha&quot; component less than 1 
        since the selection is drawn after the text. 
 
    :attr:`selection_color` is a :class:`~kivy.properties.ColorProperty` and 
    defaults to [0.1843, 0.6549, 0.8313, .5]. 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">border </span><span class="s3">= </span><span class="s1">ListProperty</span><span class="s3">([</span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">])</span>
    <span class="s4">'''Border used for :class:`~kivy.graphics.vertex_instructions.BorderImage` 
    graphics instruction. Used with :attr:`background_normal` and 
    :attr:`background_active`. Can be used for a custom background. 
 
    .. versionadded:: 1.4.1 
 
    It must be a list of four values: (bottom, right, top, left). Read the 
    BorderImage instruction for more information about how to use it. 
 
    :attr:`border` is a :class:`~kivy.properties.ListProperty` and defaults 
    to (4, 4, 4, 4). 
    '''</span>

    <span class="s1">background_normal </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span>
        <span class="s4">'atlas://data/images/defaulttheme/textinput'</span><span class="s3">)</span>
    <span class="s4">'''Background image of the TextInput when it's not in focus. 
 
    .. versionadded:: 1.4.1 
 
    :attr:`background_normal` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/textinput'. 
    '''</span>

    <span class="s1">background_disabled_normal </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span>
        <span class="s4">'atlas://data/images/defaulttheme/textinput_disabled'</span><span class="s3">)</span>
    <span class="s4">'''Background image of the TextInput when disabled. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`background_disabled_normal` is a 
    :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/textinput_disabled'. 
    '''</span>

    <span class="s1">background_active </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span>
        <span class="s4">'atlas://data/images/defaulttheme/textinput_active'</span><span class="s3">)</span>
    <span class="s4">'''Background image of the TextInput when it's in focus. 
 
    .. versionadded:: 1.4.1 
 
    :attr:`background_active` is a 
    :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/textinput_active'. 
    '''</span>

    <span class="s1">background_color </span><span class="s3">= </span><span class="s1">ColorProperty</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
    <span class="s4">'''Current color of the background, in (r, g, b, a) format. 
 
    .. versionadded:: 1.2.0 
 
    :attr:`background_color` is a :class:`~kivy.properties.ColorProperty` 
    and defaults to [1, 1, 1, 1] (white). 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">foreground_color </span><span class="s3">= </span><span class="s1">ColorProperty</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
    <span class="s4">'''Current color of the foreground, in (r, g, b, a) format. 
 
    .. versionadded:: 1.2.0 
 
    :attr:`foreground_color` is a :class:`~kivy.properties.ColorProperty` 
    and defaults to [0, 0, 0, 1] (black). 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">disabled_foreground_color </span><span class="s3">= </span><span class="s1">ColorProperty</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">])</span>
    <span class="s4">'''Current color of the foreground when disabled, in (r, g, b, a) format. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`disabled_foreground_color` is a 
    :class:`~kivy.properties.ColorProperty` and 
    defaults to [0, 0, 0, 5] (50% transparent black). 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">use_bubble </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">not </span><span class="s1">_is_desktop</span><span class="s3">)</span>
    <span class="s4">'''Indicates whether the cut/copy/paste bubble is used. 
 
    .. versionadded:: 1.7.0 
 
    :attr:`use_bubble` is a :class:`~kivy.properties.BooleanProperty` 
    and defaults to True on mobile OS's, False on desktop OS's. 
    '''</span>

    <span class="s1">use_handles </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">not </span><span class="s1">_is_desktop</span><span class="s3">)</span>
    <span class="s4">'''Indicates whether the selection handles are displayed. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`use_handles` is a :class:`~kivy.properties.BooleanProperty` 
    and defaults to True on mobile OS's, False on desktop OS's. 
    '''</span>

    <span class="s1">scroll_from_swipe </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">not </span><span class="s1">_is_desktop</span><span class="s3">)</span>
    <span class="s4">'''Allow to scroll the text using swipe gesture according to 
    :attr:`scroll_timeout` and :attr:`scroll_distance`. 
 
    .. versionadded:: 2.1.0 
 
    :attr:`scroll_from_swipe` is a BooleanProperty and defaults to True on 
    mobile OSs, False on desktop OSs. 
    '''</span>

    <span class="s1">scroll_distance </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s1">_scroll_distance</span><span class="s3">)</span>
    <span class="s4">'''Minimum distance to move before change from scroll to selection mode, in 
    pixels. 
    It is advisable that you base this value on the dpi of your target device's 
    screen. 
 
    .. versionadded:: 2.1.0 
 
    :attr:`scroll_distance` is a NumericProperty and defaults to  20 pixels. 
    '''</span>

    <span class="s1">scroll_timeout </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s1">_scroll_timeout</span><span class="s3">)</span>
    <span class="s4">'''Timeout allowed to trigger the :attr:`scroll_distance`, in milliseconds. 
    If the user has not moved :attr:`scroll_distance` within the timeout, the 
    scrolling will be disabled, and the selection mode will start. 
 
    .. versionadded:: 2.1.0 
 
    :attr:`scroll_timeout` is a NumericProperty and defaults to 250 
    milliseconds. 
    '''</span>

    <span class="s2">def </span><span class="s1">get_sel_from</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_from</span>

    <span class="s1">selection_from </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span><span class="s1">get_sel_from</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s4">'''If a selection is in progress or complete, this property will represent 
    the cursor index where the selection started. 
 
    .. versionchanged:: 1.4.0 
        :attr:`selection_from` is an :class:`~kivy.properties.AliasProperty` 
        and defaults to None, readonly. 
    '''</span>

    <span class="s2">def </span><span class="s1">get_sel_to</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_selection_to</span>

    <span class="s1">selection_to </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span><span class="s1">get_sel_to</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s4">'''If a selection is in progress or complete, this property will represent 
    the cursor index where the selection started. 
 
    .. versionchanged:: 1.4.0 
        :attr:`selection_to` is an :class:`~kivy.properties.AliasProperty` and 
        defaults to None, readonly. 
    '''</span>

    <span class="s1">selection_text </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s4">u''</span><span class="s3">)</span>
    <span class="s4">'''Current content selection. 
 
    :attr:`selection_text` is a :class:`~kivy.properties.StringProperty` 
    and defaults to '', readonly. 
    '''</span>

    <span class="s2">def </span><span class="s1">on_selection_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">value</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">use_handles</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_show_handles</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">CutBuffer </span><span class="s2">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_trigger_update_cutbuffer</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_get_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">flags </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines_flags</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span>
        <span class="s1">len_lines </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">)</span>
        <span class="s1">less_flags </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">flags</span><span class="s3">) &lt; </span><span class="s1">len_lines</span>
        <span class="s2">if </span><span class="s1">less_flags</span><span class="s3">:</span>
            <span class="s1">flags</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s4">''</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
            <span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">' </span><span class="s2">if </span><span class="s3">(</span><span class="s1">flags</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] &amp; </span><span class="s1">FL_IS_LINEBREAK</span><span class="s3">) </span><span class="s2">else </span><span class="s4">''</span><span class="s3">) + </span><span class="s1">lines</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len_lines</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">less_flags</span><span class="s3">:</span>
            <span class="s1">flags</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">text</span>

    <span class="s2">def </span><span class="s1">_set_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'utf8'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">replace_crlf</span><span class="s3">:</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">u'</span><span class="s2">\r\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">u'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text </span><span class="s3">!= </span><span class="s1">text</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_refresh_text</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_cursor_from_index</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">text</span><span class="s3">))</span>

    <span class="s1">text </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span><span class="s1">_get_text</span><span class="s3">, </span><span class="s1">_set_text</span><span class="s3">, </span><span class="s1">bind</span><span class="s3">=(</span><span class="s4">'_lines'</span><span class="s3">,), </span><span class="s1">cache</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Text of the widget. 
 
    Creation of a simple hello world:: 
 
        widget = TextInput(text='Hello world') 
 
    If you want to create the widget with an unicode string, use:: 
 
        widget = TextInput(text=u'My unicode string') 
 
    :attr:`text` is an :class:`~kivy.properties.AliasProperty`. 
    '''</span>

    <span class="s1">font_name </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s1">DEFAULT_FONT</span><span class="s3">)</span>
    <span class="s4">'''Filename of the font to use. The path can be absolute or relative. 
    Relative paths are resolved by the :func:`~kivy.resources.resource_find` 
    function. 
 
    .. warning:: 
 
        Depending on your text provider, the font file may be ignored. However, 
        you can mostly use this without problems. 
 
        If the font used lacks the glyphs for the particular language/symbols 
        you are using, you will see '[]' blank box characters instead of the 
        actual glyphs. The solution is to use a font that has the glyphs you 
        need to display. For example, to display |unicodechar|, use a font like 
        freesans.ttf that has the glyph. 
 
        .. |unicodechar| image:: images/unicode-char.png 
 
    :attr:`font_name` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'Roboto'. This value is taken 
    from :class:`~kivy.config.Config`. 
    '''</span>

    <span class="s1">font_size </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s4">'15sp'</span><span class="s3">)</span>
    <span class="s4">'''Font size of the text in pixels. 
 
    :attr:`font_size` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 15 :attr:`~kivy.metrics.sp`. 
    '''</span>

    <span class="s1">font_context </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">allownone</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Font context. `None` means the font is used in isolation, so you are 
    guaranteed to be drawing with the TTF file resolved by :attr:`font_name`. 
    Specifying a value here will load the font file into a named context, 
    enabling fallback between all fonts in the same context. If a font 
    context is set, you are not guaranteed that rendering will actually use 
    the specified TTF file for all glyphs (Pango will pick the one it 
    thinks is best). 
 
    If Kivy is linked against a system-wide installation of FontConfig, 
    you can load the system fonts by specifying a font context starting 
    with the special string `system://`. This will load the system 
    fontconfig configuration, and add your application-specific fonts on 
    top of it (this imposes a significant risk of family name collision, 
    Pango may not use your custom font file, but pick one from the system) 
 
    .. note:: 
        This feature requires the Pango text provider. 
 
    .. versionadded:: 1.10.1 
 
    :attr:`font_context` is a :class:`~kivy.properties.StringProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">font_family </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">allownone</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Font family, this is only applicable when using :attr:`font_context` 
    option. The specified font family will be requested, but note that it may 
    not be available, or there could be multiple fonts registered with the 
    same family. The value can be a family name (string) available in the 
    font context (for example a system font in a `system://` context, or a 
    custom font file added using :class:`kivy.core.text.FontContextManager`). 
    If set to `None`, font selection is controlled by the :attr:`font_name` 
    setting. 
 
    .. note:: 
        If using :attr:`font_name` to reference a custom font file, you 
        should leave this as `None`. The family name is managed automatically 
        in this case. 
 
    .. note:: 
        This feature requires the Pango text provider. 
 
    .. versionadded:: 1.10.1 
 
    :attr:`font_family` is a :class:`~kivy.properties.StringProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">base_direction </span><span class="s3">= </span><span class="s1">OptionProperty</span><span class="s3">(</span>
        <span class="s2">None</span><span class="s3">,</span>
        <span class="s1">options</span><span class="s3">=[</span><span class="s4">'ltr'</span><span class="s3">, </span><span class="s4">'rtl'</span><span class="s3">, </span><span class="s4">'weak_rtl'</span><span class="s3">, </span><span class="s4">'weak_ltr'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">],</span>
        <span class="s1">allownone</span><span class="s3">=</span><span class="s2">True</span>
    <span class="s3">)</span>
    <span class="s4">'''Base direction of text, this impacts horizontal alignment when 
    :attr:`halign` is `auto` (the default). Available options are: None, 
    &quot;ltr&quot; (left to right), &quot;rtl&quot; (right to left) plus &quot;weak_ltr&quot; and 
    &quot;weak_rtl&quot;. 
 
    .. note:: 
        This feature requires the Pango text provider. 
 
    .. note:: 
        Weak modes are currently not implemented in Kivy text layout, and 
        have the same effect as setting strong mode. 
 
    .. versionadded:: 1.10.1 
 
    :attr:`base_direction` is an :class:`~kivy.properties.OptionProperty` and 
    defaults to None (autodetect RTL if possible, otherwise LTR). 
    '''</span>

    <span class="s1">text_language </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">allownone</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Language of the text, if None Pango will determine it from locale. 
    This is an RFC-3066 format language tag (as a string), for example 
    &quot;en_US&quot;, &quot;zh_CN&quot;, &quot;fr&quot; or &quot;ja&quot;. This can impact font selection, metrics 
    and rendering. For example, the same bytes of text can look different 
    for `ur` and `ar` languages, though both use Arabic script. 
 
    .. note:: 
        This feature requires the Pango text provider. 
 
    .. versionadded:: 1.10.1 
 
    :attr:`text_language` is a :class:`~kivy.properties.StringProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">_hint_text </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span><span class="s4">''</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_set_hint_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">value</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'utf8'</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text </span><span class="s3">= </span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">_get_hint_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_hint_text</span>

    <span class="s1">hint_text </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span>
        <span class="s1">_get_hint_text</span><span class="s3">, </span><span class="s1">_set_hint_text</span><span class="s3">, </span><span class="s1">bind</span><span class="s3">=(</span><span class="s4">'_hint_text'</span><span class="s3">, ))</span>
    <span class="s4">'''Hint text of the widget, shown if text is ''. 
 
    .. versionadded:: 1.6.0 
 
    .. versionchanged:: 1.10.0 
        The property is now an AliasProperty and byte values are decoded to 
        strings. The hint text will stay visible when the widget is focused. 
 
    :attr:`hint_text` a :class:`~kivy.properties.AliasProperty` and defaults 
    to ''. 
    '''</span>

    <span class="s1">hint_text_color </span><span class="s3">= </span><span class="s1">ColorProperty</span><span class="s3">([</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">])</span>
    <span class="s4">'''Current color of the hint_text text, in (r, g, b, a) format. 
 
    .. versionadded:: 1.6.0 
 
    :attr:`hint_text_color` is a :class:`~kivy.properties.ColorProperty` and 
    defaults to [0.5, 0.5, 0.5, 1.0] (grey). 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">auto_indent </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s4">'''Automatically indent multiline text. 
 
    .. versionadded:: 1.7.0 
 
    :attr:`auto_indent` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to False. 
    '''</span>

    <span class="s1">replace_crlf </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Automatically replace CRLF with LF. 
 
    .. versionadded:: 1.9.1 
 
    :attr:`replace_crlf` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to True. 
    '''</span>

    <span class="s1">allow_copy </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Decides whether to allow copying the text. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`allow_copy` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to True. 
    '''</span>

    <span class="s2">def </span><span class="s1">_get_min_height</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">(</span>
            <span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_lines</span><span class="s3">) * (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_height </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line_spacing</span><span class="s3">)</span>
            <span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
            <span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">padding</span><span class="s3">[</span><span class="s5">3</span><span class="s3">]</span>
        <span class="s3">)</span>

    <span class="s1">minimum_height </span><span class="s3">= </span><span class="s1">AliasProperty</span><span class="s3">(</span>
        <span class="s1">_get_min_height</span><span class="s3">,</span>
        <span class="s1">bind</span><span class="s3">=(</span>
            <span class="s4">'_lines'</span><span class="s3">, </span><span class="s4">'line_spacing'</span><span class="s3">, </span><span class="s4">'padding'</span><span class="s3">, </span><span class="s4">'font_size'</span><span class="s3">, </span><span class="s4">'font_name'</span><span class="s3">,</span>
            <span class="s4">'password'</span><span class="s3">, </span><span class="s4">'font_context'</span><span class="s3">, </span><span class="s4">'hint_text'</span><span class="s3">, </span><span class="s4">'line_height'</span>
        <span class="s3">),</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">True</span>
    <span class="s3">)</span>
    <span class="s4">'''Minimum height of the content inside the TextInput. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`minimum_height` is a readonly 
    :class:`~kivy.properties.AliasProperty`. 
 
    .. warning:: 
        :attr:`minimum_width` is calculated based on :attr:`width` therefore 
        code like this will lead to an infinite loop:: 
 
            &lt;FancyTextInput&gt;: 
                height: self.minimum_height 
                width: self.height 
    '''</span>

    <span class="s1">line_spacing </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s4">'''Space taken up between the lines. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`line_spacing` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 0. 
    '''</span>

    <span class="s1">lines_to_scroll </span><span class="s3">= </span><span class="s1">BoundedNumericProperty</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">min</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s4">'''Set how many lines will be scrolled at once when using the mouse scroll 
    wheel. 
 
    .. versionadded:: 2.2.0 
 
    :attr:`lines_to_scroll is a 
    :class:`~kivy.properties.BoundedNumericProperty` and defaults to 3, the 
    minimum is 1. 
    '''</span>

    <span class="s1">input_filter </span><span class="s3">= </span><span class="s1">ObjectProperty</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">allownone</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">''' Filters the input according to the specified mode, if not None. If 
    None, no filtering is applied. 
 
    .. versionadded:: 1.9.0 
 
    :attr:`input_filter` is an :class:`~kivy.properties.ObjectProperty` and 
    defaults to `None`. Can be one of `None`, `'int'` (string), or `'float'` 
    (string), or a callable. If it is `'int'`, it will only accept numbers. 
    If it is `'float'` it will also accept a single period. Finally, if it is 
    a callable it will be called with two parameters; the string to be added 
    and a bool indicating whether the string is a result of undo (True). The 
    callable should return a new substring that will be used instead. 
    '''</span>

    <span class="s1">handle_image_middle </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span>
        <span class="s4">'atlas://data/images/defaulttheme/selector_middle'</span><span class="s3">)</span>
    <span class="s4">'''Image used to display the middle handle on the TextInput for cursor 
    positioning. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`handle_image_middle` is a :class:`~kivy.properties.StringProperty` 
    and defaults to 'atlas://data/images/defaulttheme/selector_middle'. 
    '''</span>

    <span class="s2">def </span><span class="s1">on_handle_image_middle</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_middle</span><span class="s3">.</span><span class="s1">source </span><span class="s3">= </span><span class="s1">value</span>

    <span class="s1">handle_image_left </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span>
        <span class="s4">'atlas://data/images/defaulttheme/selector_left'</span><span class="s3">)</span>
    <span class="s4">'''Image used to display the Left handle on the TextInput for selection. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`handle_image_left` is a :class:`~kivy.properties.StringProperty` and 
    defaults to 'atlas://data/images/defaulttheme/selector_left'. 
    '''</span>

    <span class="s2">def </span><span class="s1">on_handle_image_left</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_left</span><span class="s3">.</span><span class="s1">source </span><span class="s3">= </span><span class="s1">value</span>

    <span class="s1">handle_image_right </span><span class="s3">= </span><span class="s1">StringProperty</span><span class="s3">(</span>
        <span class="s4">'atlas://data/images/defaulttheme/selector_right'</span><span class="s3">)</span>
    <span class="s4">'''Image used to display the Right handle on the TextInput for selection. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`handle_image_right` is a 
    :class:`~kivy.properties.StringProperty` and defaults to 
    'atlas://data/images/defaulttheme/selector_right'. 
    '''</span>

    <span class="s2">def </span><span class="s1">on_handle_image_right</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_right</span><span class="s3">.</span><span class="s1">source </span><span class="s3">= </span><span class="s1">value</span>

    <span class="s1">write_tab </span><span class="s3">= </span><span class="s1">BooleanProperty</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4">'''Whether the tab key should move focus to the next widget or if it should 
    enter a tab in the :class:`TextInput`. If `True` a tab will be written, 
    otherwise, focus will move to the next widget. 
 
    .. versionadded:: 1.9.0 
 
    :attr:`write_tab` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to `True`. 
    '''</span>


<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">'__main__'</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">textwrap </span><span class="s2">import </span><span class="s1">dedent</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">app </span><span class="s2">import </span><span class="s1">App</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">uix</span><span class="s3">.</span><span class="s1">boxlayout </span><span class="s2">import </span><span class="s1">BoxLayout</span>
    <span class="s2">from </span><span class="s1">kivy</span><span class="s3">.</span><span class="s1">lang </span><span class="s2">import </span><span class="s1">Builder</span>

    <span class="s1">KV </span><span class="s3">= </span><span class="s1">dedent</span><span class="s3">(</span><span class="s4">r''' 
    #:set font_size '20dp' 
 
    BoxLayout: 
        orientation: 'vertical' 
        padding: '20dp' 
        spacing: '10dp' 
        TextInput: 
            font_size: font_size 
            size_hint_y: None 
            height: self.minimum_height 
            multiline: False 
            text: 'monoline' 
 
        TextInput: 
            size_hint_y: None 
            font_size: font_size 
            height: self.minimum_height 
            multiline: False 
            password: True 
            password_mask: '' 
            text: 'password' 
 
        TextInput: 
            font_size: font_size 
            size_hint_y: None 
            height: self.minimum_height 
            multiline: False 
            readonly: True 
            text: 'readonly' 
 
        TextInput: 
            font_size: font_size 
            size_hint_y: None 
            height: self.minimum_height 
            multiline: False 
            disabled: True 
            text: 'disabled' 
 
        TextInput: 
            font_size: font_size 
            hint_text: 'normal with hint text' 
 
        TextInput: 
            font_size: font_size 
            text: 'default' 
 
        TextInput: 
            font_size: font_size 
            text: 'bubble &amp; handles' 
            use_bubble: True 
            use_handles: True 
 
        TextInput: 
            font_size: font_size 
            text: 'no wrap' 
            do_wrap: False 
 
        TextInput: 
            font_size: font_size 
            text: 'multiline\nreadonly' 
            disabled: app.time % 5 &lt; 2.5 
    '''</span><span class="s3">)</span>

    <span class="s2">class </span><span class="s1">TextInputApp</span><span class="s3">(</span><span class="s1">App</span><span class="s3">):</span>
        <span class="s1">time </span><span class="s3">= </span><span class="s1">NumericProperty</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">build</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">Clock</span><span class="s3">.</span><span class="s1">schedule_interval</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">update_time</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">Builder</span><span class="s3">.</span><span class="s1">load_string</span><span class="s3">(</span><span class="s1">KV</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">update_time</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">time </span><span class="s3">+= </span><span class="s1">dt</span>

    <span class="s1">TextInputApp</span><span class="s3">().</span><span class="s1">run</span><span class="s3">()</span>
</pre>
</body>
</html>