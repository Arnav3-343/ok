<html>
<head>
<title>scrollview.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
scrollview.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
ScrollView 
========== 
 
.. versionadded:: 1.0.4 
 
The :class:`ScrollView` widget provides a scrollable/pannable viewport that is 
clipped at the scrollview's bounding box. 
 
.. note:: 
    Use :class:`~kivy.uix.recycleview.RecycleView` for generating large 
    numbers of widgets in order to display many data items. 
 
 
Scrolling Behavior 
------------------ 
 
The ScrollView accepts only one child and applies a viewport/window to 
it according to the :attr:`~ScrollView.scroll_x` and 
:attr:`~ScrollView.scroll_y` properties. Touches are analyzed to 
determine if the user wants to scroll or control the child in some 
other manner: you cannot do both at the same time. To determine if 
interaction is a scrolling gesture, these properties are used: 
 
    - :attr:`~ScrollView.scroll_distance`: the minimum distance to travel, 
      defaults to 20 pixels. 
    - :attr:`~ScrollView.scroll_timeout`: the maximum time period, defaults 
      to 55 milliseconds. 
 
If a touch travels :attr:`~ScrollView.scroll_distance` pixels within the 
:attr:`~ScrollView.scroll_timeout` period, it is recognized as a scrolling 
gesture and translation (scroll/pan) will begin. If the timeout occurs, the 
touch down event is dispatched to the child instead (no translation). 
 
The default value for those settings can be changed in the configuration file:: 
 
    [widgets] 
    scroll_timeout = 250 
    scroll_distance = 20 
 
.. versionadded:: 1.1.1 
 
    ScrollView now animates scrolling in Y when a mousewheel is used. 
 
 
Limiting to the X or Y Axis 
--------------------------- 
 
By default, the ScrollView allows scrolling along both the X and Y axes. You 
can explicitly disable scrolling on an axis by setting the 
:attr:`~ScrollView.do_scroll_x` or :attr:`~ScrollView.do_scroll_y` properties 
to False. 
 
 
Managing the Content Size and Position 
-------------------------------------- 
 
The ScrollView manages the position of its children similarly to a 
:class:`~kivy.uix.relativelayout.RelativeLayout` but does not use the 
:attr:`~kivy.uix.widget.Widget.size_hint`. You must 
carefully specify the :attr:`~kivy.uix.widget.Widget.size` of your content to 
get the desired scroll/pan effect. 
 
By default, the :attr:`~kivy.uix.widget.Widget.size_hint` is (1, 1), so the 
content size will fit your ScrollView 
exactly (you will have nothing to scroll). You must deactivate at least one of 
the size_hint instructions (x or y) of the child to enable scrolling. 
Setting :attr:`~kivy.uix.widget.Widget.size_hint_min` to not be None will 
also enable scrolling for that dimension when the :class:`ScrollView` is 
smaller than the minimum size. 
 
To scroll a :class:`~kivy.uix.gridlayout.GridLayout` on it's Y-axis/vertically, 
set the child's width  to that of the ScrollView (size_hint_x=1), and set 
the size_hint_y property to None:: 
 
    from kivy.uix.gridlayout import GridLayout 
    from kivy.uix.button import Button 
    from kivy.uix.scrollview import ScrollView 
    from kivy.core.window import Window 
    from kivy.app import runTouchApp 
 
    layout = GridLayout(cols=1, spacing=10, size_hint_y=None) 
    # Make sure the height is such that there is something to scroll. 
    layout.bind(minimum_height=layout.setter('height')) 
    for i in range(100): 
        btn = Button(text=str(i), size_hint_y=None, height=40) 
        layout.add_widget(btn) 
    root = ScrollView(size_hint=(1, None), size=(Window.width, Window.height)) 
    root.add_widget(layout) 
 
    runTouchApp(root) 
 
 
Kv Example:: 
 
    ScrollView: 
        do_scroll_x: False 
        do_scroll_y: True 
 
        Label: 
            size_hint_y: None 
            height: self.texture_size[1] 
            text_size: self.width, None 
            padding: 10, 10 
            text: 
                'really some amazing text\\n' * 100 
 
Overscroll Effects 
------------------ 
 
.. versionadded:: 1.7.0 
 
When scrolling would exceed the bounds of the :class:`ScrollView`, it 
uses a :class:`~kivy.effects.scroll.ScrollEffect` to handle the 
overscroll. These effects can perform actions like bouncing back, 
changing opacity, or simply preventing scrolling beyond the normal 
boundaries. Note that complex effects may perform many computations, 
which can be slow on weaker hardware. 
 
You can change what effect is being used by setting 
:attr:`~ScrollView.effect_cls` to any effect class. Current options 
include: 
 
    - :class:`~kivy.effects.scroll.ScrollEffect`: Does not allow 
      scrolling beyond the :class:`ScrollView` boundaries. 
    - :class:`~kivy.effects.dampedscroll.DampedScrollEffect`: The 
      current default. Allows the user to scroll beyond the normal 
      boundaries, but has the content spring back once the 
      touch/click is released. 
    - :class:`~kivy.effects.opacityscroll.OpacityScrollEffect`: Similar 
      to the :class:`~kivy.effect.dampedscroll.DampedScrollEffect`, but 
      also reduces opacity during overscroll. 
 
You can also create your own scroll effect by subclassing one of these, 
then pass it as the :attr:`~ScrollView.effect_cls` in the same way. 
 
Alternatively, you can set :attr:`~ScrollView.effect_x` and/or 
:attr:`~ScrollView.effect_y` to an *instance* of the effect you want to 
use. This will override the default effect set in 
:attr:`~ScrollView.effect_cls`. 
 
All the effects are located in the :mod:`kivy.effects`. 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'ScrollView'</span><span class="s2">, )</span>

<span class="s4">from </span><span class="s1">functools </span><span class="s4">import </span><span class="s1">partial</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">animation </span><span class="s4">import </span><span class="s1">Animation</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">compat </span><span class="s4">import </span><span class="s1">string_types</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">config </span><span class="s4">import </span><span class="s1">Config</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">clock </span><span class="s4">import </span><span class="s1">Clock</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">factory </span><span class="s4">import </span><span class="s1">Factory</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">stencilview </span><span class="s4">import </span><span class="s1">StencilView</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">metrics </span><span class="s4">import </span><span class="s1">dp</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">effects</span><span class="s2">.</span><span class="s1">dampedscroll </span><span class="s4">import </span><span class="s1">DampedScrollEffect</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">BooleanProperty</span><span class="s2">, </span><span class="s1">AliasProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">ObjectProperty</span><span class="s2">, </span><span class="s1">ListProperty</span><span class="s2">, </span><span class="s1">ReferenceListProperty</span><span class="s2">, </span><span class="s1">OptionProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">ColorProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">behaviors </span><span class="s4">import </span><span class="s1">FocusBehavior</span>


<span class="s5"># When we are generating documentation, Config doesn't exist</span>
<span class="s1">_scroll_timeout </span><span class="s2">= </span><span class="s1">_scroll_distance </span><span class="s2">= </span><span class="s6">0</span>
<span class="s4">if </span><span class="s1">Config</span><span class="s2">:</span>
    <span class="s1">_scroll_timeout </span><span class="s2">= </span><span class="s1">Config</span><span class="s2">.</span><span class="s1">getint</span><span class="s2">(</span><span class="s3">'widgets'</span><span class="s2">, </span><span class="s3">'scroll_timeout'</span><span class="s2">)</span>
    <span class="s1">_scroll_distance </span><span class="s2">= </span><span class="s3">'{}sp'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">Config</span><span class="s2">.</span><span class="s1">getint</span><span class="s2">(</span><span class="s3">'widgets'</span><span class="s2">,</span>
                                                   <span class="s3">'scroll_distance'</span><span class="s2">))</span>


<span class="s4">class </span><span class="s1">ScrollView</span><span class="s2">(</span><span class="s1">StencilView</span><span class="s2">):</span>
    <span class="s0">'''ScrollView class. See module documentation for more information. 
 
    :Events: 
        `on_scroll_start` 
            Generic event fired when scrolling starts from touch. 
        `on_scroll_move` 
            Generic event fired when scrolling move from touch. 
        `on_scroll_stop` 
            Generic event fired when scrolling stops from touch. 
 
    .. versionchanged:: 1.9.0 
        `on_scroll_start`, `on_scroll_move` and `on_scroll_stop` events are 
        now dispatched when scrolling to handle nested ScrollViews. 
 
    .. versionchanged:: 1.7.0 
        `auto_scroll`, `scroll_friction`, `scroll_moves`, `scroll_stoptime' has 
        been deprecated, use :attr:`effect_cls` instead. 
    '''</span>

    <span class="s1">scroll_distance </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s1">_scroll_distance</span><span class="s2">)</span>
    <span class="s3">'''Distance to move before scrolling the :class:`ScrollView`, in pixels. As 
    soon as the distance has been traveled, the :class:`ScrollView` will start 
    to scroll, and no touch event will go to children. 
    It is advisable that you base this value on the dpi of your target device's 
    screen. 
 
    :attr:`scroll_distance` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 20 (pixels), according to the default value in user 
    configuration. 
    '''</span>

    <span class="s1">scroll_wheel_distance </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s3">'20sp'</span><span class="s2">)</span>
    <span class="s3">'''Distance to move when scrolling with a mouse wheel. 
    It is advisable that you base this value on the dpi of your target device's 
    screen. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`scroll_wheel_distance` is a 
    :class:`~kivy.properties.NumericProperty` , defaults to 20 pixels. 
    '''</span>

    <span class="s1">scroll_timeout </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s1">_scroll_timeout</span><span class="s2">)</span>
    <span class="s3">'''Timeout allowed to trigger the :attr:`scroll_distance`, in milliseconds. 
    If the user has not moved :attr:`scroll_distance` within the timeout, 
    the scrolling will be disabled, and the touch event will go to the 
    children. 
 
    :attr:`scroll_timeout` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 55 (milliseconds) according to the default value in user 
    configuration. 
 
    .. versionchanged:: 1.5.0 
        Default value changed from 250 to 55. 
    '''</span>

    <span class="s1">scroll_x </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0.</span><span class="s2">)</span>
    <span class="s3">'''X scrolling value, between 0 and 1. If 0, the content's left side will 
    touch the left side of the ScrollView. If 1, the content's right side will 
    touch the right side. 
 
    This property is controlled by :class:`ScrollView` only if 
    :attr:`do_scroll_x` is True. 
 
    :attr:`scroll_x` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 0. 
    '''</span>

    <span class="s1">scroll_y </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">1.</span><span class="s2">)</span>
    <span class="s3">'''Y scrolling value, between 0 and 1. If 0, the content's bottom side will 
    touch the bottom side of the ScrollView. If 1, the content's top side will 
    touch the top side. 
 
    This property is controlled by :class:`ScrollView` only if 
    :attr:`do_scroll_y` is True. 
 
    :attr:`scroll_y` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 1. 
    '''</span>

    <span class="s1">do_scroll_x </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Allow scroll on X axis. 
 
    :attr:`do_scroll_x` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to True. 
    '''</span>

    <span class="s1">do_scroll_y </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Allow scroll on Y axis. 
 
    :attr:`do_scroll_y` is a :class:`~kivy.properties.BooleanProperty` and 
    defaults to True. 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_do_scroll</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_set_do_scroll</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">do_scroll </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_do_scroll</span><span class="s2">, </span><span class="s1">_set_do_scroll</span><span class="s2">,</span>
                              <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'do_scroll_x'</span><span class="s2">, </span><span class="s3">'do_scroll_y'</span><span class="s2">),</span>
                              <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Allow scroll on X or Y axis. 
 
    :attr:`do_scroll` is a :class:`~kivy.properties.AliasProperty` of 
    (:attr:`do_scroll_x` + :attr:`do_scroll_y`) 
    '''</span>

    <span class="s1">always_overscroll </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Make sure user can overscroll even if there is not enough content 
    to require scrolling. 
 
    This is useful if you want to trigger some action on overscroll, but 
    there is not always enough content to trigger it. 
 
    :attr:`always_overscroll` is a 
    :class:`~kivy.properties.BooleanProperty` and defaults to `True`. 
 
    .. versionadded:: 2.0.0 
 
    The option was added and enabled by default, set to False to get the 
    previous behavior of only allowing to overscroll when there is 
    enough content to allow scrolling. 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_vbar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># must return (y, height) in %</span>
        <span class="s5"># calculate the viewport size / scrollview size %</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1.</span>
        <span class="s1">vh </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s4">if </span><span class="s1">vh </span><span class="s2">&lt; </span><span class="s1">h </span><span class="s4">or </span><span class="s1">vh </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1.</span>
        <span class="s1">ph </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.01</span><span class="s2">, </span><span class="s1">h </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">))</span>
        <span class="s1">sy </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y</span><span class="s2">))</span>
        <span class="s1">py </span><span class="s2">= (</span><span class="s6">1. </span><span class="s2">- </span><span class="s1">ph</span><span class="s2">) * </span><span class="s1">sy</span>
        <span class="s4">return </span><span class="s2">(</span><span class="s1">py</span><span class="s2">, </span><span class="s1">ph</span><span class="s2">)</span>

    <span class="s1">vbar </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_vbar</span><span class="s2">,</span>
                         <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'scroll_y'</span><span class="s2">, </span><span class="s3">'_viewport'</span><span class="s2">, </span><span class="s3">'viewport_size'</span><span class="s2">,</span>
                               <span class="s3">'height'</span><span class="s2">),</span>
                         <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Return a tuple of (position, size) of the vertical scrolling bar. 
 
    .. versionadded:: 1.2.0 
 
    The position and size are normalized between 0-1, and represent a 
    proportion of the current scrollview height. This property is used 
    internally for drawing the little vertical bar when you're scrolling. 
 
    :attr:`vbar` is a :class:`~kivy.properties.AliasProperty`, readonly. 
    '''</span>

    <span class="s4">def </span><span class="s1">_get_hbar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># must return (x, width) in %</span>
        <span class="s5"># calculate the viewport size / scrollview size %</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1.</span>
        <span class="s1">vw </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s4">if </span><span class="s1">vw </span><span class="s2">&lt; </span><span class="s1">w </span><span class="s4">or </span><span class="s1">vw </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1.</span>
        <span class="s1">pw </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.01</span><span class="s2">, </span><span class="s1">w </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">vw</span><span class="s2">))</span>
        <span class="s1">sx </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x</span><span class="s2">))</span>
        <span class="s1">px </span><span class="s2">= (</span><span class="s6">1. </span><span class="s2">- </span><span class="s1">pw</span><span class="s2">) * </span><span class="s1">sx</span>
        <span class="s4">return </span><span class="s2">(</span><span class="s1">px</span><span class="s2">, </span><span class="s1">pw</span><span class="s2">)</span>

    <span class="s1">hbar </span><span class="s2">= </span><span class="s1">AliasProperty</span><span class="s2">(</span><span class="s1">_get_hbar</span><span class="s2">,</span>
                         <span class="s1">bind</span><span class="s2">=(</span><span class="s3">'scroll_x'</span><span class="s2">, </span><span class="s3">'_viewport'</span><span class="s2">, </span><span class="s3">'viewport_size'</span><span class="s2">,</span>
                               <span class="s3">'width'</span><span class="s2">),</span>
                         <span class="s1">cache</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Return a tuple of (position, size) of the horizontal scrolling bar. 
 
    .. versionadded:: 1.2.0 
 
    The position and size are normalized between 0-1, and represent a 
    proportion of the current scrollview height. This property is used 
    internally for drawing the little horizontal bar when you're scrolling. 
 
    :attr:`hbar` is a :class:`~kivy.properties.AliasProperty`, readonly. 
    '''</span>

    <span class="s1">bar_color </span><span class="s2">= </span><span class="s1">ColorProperty</span><span class="s2">([</span><span class="s6">.7</span><span class="s2">, </span><span class="s6">.7</span><span class="s2">, </span><span class="s6">.7</span><span class="s2">, </span><span class="s6">.9</span><span class="s2">])</span>
    <span class="s3">'''Color of horizontal / vertical scroll bar, in RGBA format. 
 
    .. versionadded:: 1.2.0 
 
    :attr:`bar_color` is a :class:`~kivy.properties.ColorProperty` and defaults 
    to [.7, .7, .7, .9]. 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">bar_inactive_color </span><span class="s2">= </span><span class="s1">ColorProperty</span><span class="s2">([</span><span class="s6">.7</span><span class="s2">, </span><span class="s6">.7</span><span class="s2">, </span><span class="s6">.7</span><span class="s2">, </span><span class="s6">.2</span><span class="s2">])</span>
    <span class="s3">'''Color of horizontal / vertical scroll bar (in RGBA format), when no 
    scroll is happening. 
 
    .. versionadded:: 1.9.0 
 
    :attr:`bar_inactive_color` is a 
    :class:`~kivy.properties.ColorProperty` and defaults to [.7, .7, .7, .2]. 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">bar_width </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s3">'2dp'</span><span class="s2">)</span>
    <span class="s3">'''Width of the horizontal / vertical scroll bar. The width is interpreted 
    as a height for the horizontal bar. 
 
    .. versionadded:: 1.2.0 
 
    :attr:`bar_width` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 2. 
    '''</span>

    <span class="s1">bar_pos_x </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span><span class="s3">'bottom'</span><span class="s2">, </span><span class="s1">options</span><span class="s2">=(</span><span class="s3">'top'</span><span class="s2">, </span><span class="s3">'bottom'</span><span class="s2">))</span>
    <span class="s3">'''Which side of the ScrollView the horizontal scroll bar should go 
    on. Possible values are 'top' and 'bottom'. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`bar_pos_x` is an :class:`~kivy.properties.OptionProperty`, 
    defaults to 'bottom'. 
 
    '''</span>

    <span class="s1">bar_pos_y </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span><span class="s3">'right'</span><span class="s2">, </span><span class="s1">options</span><span class="s2">=(</span><span class="s3">'left'</span><span class="s2">, </span><span class="s3">'right'</span><span class="s2">))</span>
    <span class="s3">'''Which side of the ScrollView the vertical scroll bar should go 
    on. Possible values are 'left' and 'right'. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`bar_pos_y` is an :class:`~kivy.properties.OptionProperty` and 
    defaults to 'right'. 
 
    '''</span>

    <span class="s1">bar_pos </span><span class="s2">= </span><span class="s1">ReferenceListProperty</span><span class="s2">(</span><span class="s1">bar_pos_x</span><span class="s2">, </span><span class="s1">bar_pos_y</span><span class="s2">)</span>
    <span class="s3">'''Which side of the scroll view to place each of the bars on. 
 
    :attr:`bar_pos` is a :class:`~kivy.properties.ReferenceListProperty` of 
    (:attr:`bar_pos_x`, :attr:`bar_pos_y`) 
    '''</span>

    <span class="s1">bar_margin </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3">'''Margin between the bottom / right side of the scrollview when drawing 
    the horizontal / vertical scroll bar. 
 
    .. versionadded:: 1.2.0 
 
    :attr:`bar_margin` is a :class:`~kivy.properties.NumericProperty`, default 
    to 0 
    '''</span>

    <span class="s1">effect_cls </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s1">DampedScrollEffect</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Class effect to instantiate for X and Y axis. 
 
    .. versionadded:: 1.7.0 
 
    :attr:`effect_cls` is an :class:`~kivy.properties.ObjectProperty` and 
    defaults to :class:`DampedScrollEffect`. 
 
    .. versionchanged:: 1.8.0 
        If you set a string, the :class:`~kivy.factory.Factory` will be used to 
        resolve the class. 
 
    '''</span>

    <span class="s1">effect_x </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Effect to apply for the X axis. If None is set, an instance of 
    :attr:`effect_cls` will be created. 
 
    .. versionadded:: 1.7.0 
 
    :attr:`effect_x` is an :class:`~kivy.properties.ObjectProperty` and 
    defaults to None. 
    '''</span>

    <span class="s1">effect_y </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Effect to apply for the Y axis. If None is set, an instance of 
    :attr:`effect_cls` will be created. 
 
    .. versionadded:: 1.7.0 
 
    :attr:`effect_y` is an :class:`~kivy.properties.ObjectProperty` and 
    defaults to None, read-only. 
    '''</span>

    <span class="s1">viewport_size </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s3">'''(internal) Size of the internal viewport. This is the size of your only 
    child in the scrollview. 
    '''</span>

    <span class="s1">scroll_type </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">([</span><span class="s3">'content'</span><span class="s2">], </span><span class="s1">options</span><span class="s2">=([</span><span class="s3">'content'</span><span class="s2">], [</span><span class="s3">'bars'</span><span class="s2">],</span>
                                 <span class="s2">[</span><span class="s3">'bars'</span><span class="s2">, </span><span class="s3">'content'</span><span class="s2">], [</span><span class="s3">'content'</span><span class="s2">, </span><span class="s3">'bars'</span><span class="s2">]))</span>
    <span class="s3">'''Sets the type of scrolling to use for the content of the scrollview. 
    Available options are: ['content'], ['bars'], ['bars', 'content']. 
 
    +---------------------+------------------------------------------------+ 
    | ['content']         | Content is scrolled by dragging or swiping the | 
    |                     | content directly.                              | 
    +---------------------+------------------------------------------------+ 
    | ['bars']            | Content is scrolled by dragging or swiping the | 
    |                     | scroll bars.                                   | 
    +---------------------+------------------------------------------------+ 
    | ['bars', 'content'] | Content is scrolled by either of the above     | 
    |                     | methods.                                       | 
    +---------------------+------------------------------------------------+ 
 
    .. versionadded:: 1.8.0 
 
    :attr:`scroll_type` is an :class:`~kivy.properties.OptionProperty` and 
    defaults to ['content']. 
    '''</span>

    <span class="s1">smooth_scroll_end </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Whether smooth scroll end should be used when scrolling with the 
    mouse-wheel and the factor of transforming the scroll distance to 
    velocity. This option also enables velocity addition meaning if you 
    scroll more, you will scroll faster and further. The recommended value 
    is `10`. The velocity is calculated as :attr:`scroll_wheel_distance` * 
    :attr:`smooth_scroll_end`. 
 
    .. versionadded:: 1.11.0 
 
    :attr:`smooth_scroll_end` is a :class:`~kivy.properties.NumericProperty` 
    and defaults to None. 
    '''</span>

    <span class="s5"># private, for internal use only</span>

    <span class="s1">_viewport </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s1">_bar_color </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
    <span class="s1">_effect_x_start_width </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">_effect_y_start_height </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">_update_effect_bounds_ev </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">_bind_inactive_bar_color_ev </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">_set_viewport_size</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">viewport_size </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">on__viewport</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_set_viewport_size</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">viewport_size </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">size</span>

    <span class="s1">__events__ </span><span class="s2">= (</span><span class="s3">'on_scroll_start'</span><span class="s2">, </span><span class="s3">'on_scroll_move'</span><span class="s2">, </span><span class="s3">'on_scroll_stop'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">update_from_scroll</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">)</span>
        <span class="s5"># create a specific canvas for the viewport</span>
        <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">graphics </span><span class="s4">import </span><span class="s1">PushMatrix</span><span class="s2">, </span><span class="s1">Translate</span><span class="s2">, </span><span class="s1">PopMatrix</span><span class="s2">, </span><span class="s1">Canvas</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas_viewport </span><span class="s2">= </span><span class="s1">Canvas</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas </span><span class="s2">= </span><span class="s1">Canvas</span><span class="s2">()</span>
        <span class="s4">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas_viewport</span><span class="s2">.</span><span class="s1">before</span><span class="s2">:</span>
            <span class="s1">PushMatrix</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">g_translate </span><span class="s2">= </span><span class="s1">Translate</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s4">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas_viewport</span><span class="s2">.</span><span class="s1">after</span><span class="s2">:</span>
            <span class="s1">PopMatrix</span><span class="s2">()</span>

        <span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">register_event_type</span><span class="s2">(</span><span class="s3">'on_scroll_start'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">register_event_type</span><span class="s2">(</span><span class="s3">'on_scroll_move'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">register_event_type</span><span class="s2">(</span><span class="s3">'on_scroll_stop'</span><span class="s2">)</span>

        <span class="s5"># now add the viewport canvas to our canvas</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas_viewport</span><span class="s2">)</span>

        <span class="s1">effect_cls </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_cls</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">effect_cls</span><span class="s2">, </span><span class="s1">string_types</span><span class="s2">):</span>
            <span class="s1">effect_cls </span><span class="s2">= </span><span class="s1">Factory</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">effect_cls</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x </span><span class="s4">is None and </span><span class="s1">effect_cls </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x </span><span class="s2">= </span><span class="s1">effect_cls</span><span class="s2">(</span><span class="s1">target_widget</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y </span><span class="s4">is None and </span><span class="s1">effect_cls </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y </span><span class="s2">= </span><span class="s1">effect_cls</span><span class="s2">(</span><span class="s1">target_widget</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">)</span>

        <span class="s1">trigger_update_from_scroll </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span>
        <span class="s1">update_effect_widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_widget</span>
        <span class="s1">update_effect_x_bounds </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_x_bounds</span>
        <span class="s1">update_effect_y_bounds </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_y_bounds</span>
        <span class="s1">fbind </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'width'</span><span class="s2">, </span><span class="s1">update_effect_x_bounds</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'height'</span><span class="s2">, </span><span class="s1">update_effect_y_bounds</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'viewport_size'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_bounds</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'_viewport'</span><span class="s2">, </span><span class="s1">update_effect_widget</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'scroll_x'</span><span class="s2">, </span><span class="s1">trigger_update_from_scroll</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'scroll_y'</span><span class="s2">, </span><span class="s1">trigger_update_from_scroll</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'pos'</span><span class="s2">, </span><span class="s1">trigger_update_from_scroll</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s1">trigger_update_from_scroll</span><span class="s2">)</span>

        <span class="s1">trigger_update_from_scroll</span><span class="s2">()</span>
        <span class="s1">update_effect_widget</span><span class="s2">()</span>
        <span class="s1">update_effect_x_bounds</span><span class="s2">()</span>
        <span class="s1">update_effect_y_bounds</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_effect_x</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">scroll</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_x</span><span class="s2">)</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">target_widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>

    <span class="s4">def </span><span class="s1">on_effect_y</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">scroll</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_y</span><span class="s2">)</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">target_widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>

    <span class="s4">def </span><span class="s1">on_effect_cls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">string_types</span><span class="s2">):</span>
            <span class="s1">cls </span><span class="s2">= </span><span class="s1">Factory</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">target_widget</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">scroll</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_x</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">target_widget</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">scroll</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_y</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_update_effect_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">target_widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">target_widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>

    <span class="s4">def </span><span class="s1">_update_effect_x_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport </span><span class="s4">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">scrollable_width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">viewport_size</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">min </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">max </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">scrollable_width</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">scrollable_width </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x</span>

    <span class="s4">def </span><span class="s1">_update_effect_y_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport </span><span class="s4">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">scrollable_height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">viewport_size</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">min </span><span class="s2">= </span><span class="s6">0 </span><span class="s4">if </span><span class="s1">scrollable_height </span><span class="s2">&lt; </span><span class="s6">0 </span><span class="s4">else </span><span class="s1">scrollable_height</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">max </span><span class="s2">= </span><span class="s1">scrollable_height</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">max </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y</span>

    <span class="s4">def </span><span class="s1">_update_effect_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_x_bounds</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_y_bounds</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_update_effect_x</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">vp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>
        <span class="s4">if not </span><span class="s1">vp </span><span class="s4">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">is_manual</span><span class="s2">:</span>
            <span class="s1">sw </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_effect_x_start_width</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">sw </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s4">if </span><span class="s1">sw </span><span class="s2">&lt; </span><span class="s6">1 </span><span class="s4">and not </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x</span><span class="s2">):</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">sw </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">sx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">/ </span><span class="s1">sw</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">= -</span><span class="s1">sx</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_update_effect_y</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">vp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>
        <span class="s4">if not </span><span class="s1">vp </span><span class="s4">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">is_manual</span><span class="s2">:</span>
            <span class="s1">sh </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_effect_y_start_height</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">sh </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>

        <span class="s4">if </span><span class="s1">sh </span><span class="s2">&lt; </span><span class="s6">1 </span><span class="s4">and not </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y</span><span class="s2">):</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">sh </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">sy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">scroll </span><span class="s2">/ </span><span class="s1">sh</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">= -</span><span class="s1">sy</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">to_local</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">k</span><span class="s2">):</span>
        <span class="s1">tx</span><span class="s2">, </span><span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">g_translate</span><span class="s2">.</span><span class="s1">xy</span>
        <span class="s4">return </span><span class="s1">x </span><span class="s2">- </span><span class="s1">tx</span><span class="s2">, </span><span class="s1">y </span><span class="s2">- </span><span class="s1">ty</span>

    <span class="s4">def </span><span class="s1">to_parent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, **</span><span class="s1">k</span><span class="s2">):</span>
        <span class="s1">tx</span><span class="s2">, </span><span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">g_translate</span><span class="s2">.</span><span class="s1">xy</span>
        <span class="s4">return </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">tx</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">ty</span>

    <span class="s4">def </span><span class="s1">_apply_transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">=</span><span class="s4">None</span><span class="s2">):</span>
        <span class="s1">tx</span><span class="s2">, </span><span class="s1">ty </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">g_translate</span><span class="s2">.</span><span class="s1">xy</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">_apply_transform</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, (</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">))</span>

    <span class="s4">def </span><span class="s1">simulate_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s5"># at this point the touch is in parent coords</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s4">return </span><span class="s1">ret</span>

    <span class="s4">def </span><span class="s1">on_motion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">etype</span><span class="s2">, </span><span class="s1">me</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">me</span><span class="s2">.</span><span class="s1">type_id </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">motion_filter </span><span class="s4">and </span><span class="s3">'pos' </span><span class="s4">in </span><span class="s1">me</span><span class="s2">.</span><span class="s1">profile</span><span class="s2">:</span>
            <span class="s1">me</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
            <span class="s1">me</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
            <span class="s1">ret </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">on_motion</span><span class="s2">(</span><span class="s1">etype</span><span class="s2">, </span><span class="s1">me</span><span class="s2">)</span>
            <span class="s1">me</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s4">return </span><span class="s1">ret</span>
        <span class="s4">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">on_motion</span><span class="s2">(</span><span class="s1">etype</span><span class="s2">, </span><span class="s1">me</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_scroll_start'</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s1">touch</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">_touch_in_handle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">, </span><span class="s1">size</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">pos</span>
        <span class="s1">width</span><span class="s2">, </span><span class="s1">height </span><span class="s2">= </span><span class="s1">size</span>
        <span class="s4">return </span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">width </span><span class="s4">and </span><span class="s1">y </span><span class="s2">&lt;= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y </span><span class="s2">&lt;= </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">height</span>

    <span class="s4">def </span><span class="s1">on_scroll_start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">, </span><span class="s1">check_children</span><span class="s2">=</span><span class="s4">True</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">check_children</span><span class="s2">:</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch_children</span><span class="s2">(</span><span class="s3">'on_scroll_start'</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s4">return True</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'svavoid'</span><span class="s2">)] = </span><span class="s4">True</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">disabled</span><span class="s2">:</span>
            <span class="s4">return True</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s4">or </span><span class="s2">(</span><span class="s4">not </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y</span><span class="s2">)):</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">simulate_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>

        <span class="s5"># handle mouse scrolling, only if the viewport size is bigger than the</span>
        <span class="s5"># scrollview size, and if the user allowed to do it</span>
        <span class="s1">vp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>
        <span class="s4">if not </span><span class="s1">vp</span><span class="s2">:</span>
            <span class="s4">return True</span>
        <span class="s1">scroll_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_type</span>
        <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span>
        <span class="s1">scroll_bar </span><span class="s2">= </span><span class="s3">'bars' </span><span class="s4">in </span><span class="s1">scroll_type</span>

        <span class="s5"># check if touch is in bar_x(horizontal) or bar_y(vertical)</span>
        <span class="s5"># width_enable_overscroll or vp.width &gt; self.width</span>
        <span class="s1">width_scrollable </span><span class="s2">= (</span>
            <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x</span><span class="s2">)</span>
            <span class="s4">or </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s2">)</span>
        <span class="s1">height_scrollable </span><span class="s2">= (</span>
            <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y</span><span class="s2">)</span>
            <span class="s4">or </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s2">)</span>

        <span class="s1">d </span><span class="s2">= {</span><span class="s3">'bottom'</span><span class="s2">: </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_margin</span><span class="s2">,</span>
             <span class="s3">'top'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">top </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_margin</span><span class="s2">,</span>
             <span class="s3">'left'</span><span class="s2">: </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_margin</span><span class="s2">,</span>
             <span class="s3">'right'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">right </span><span class="s2">- </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_margin</span><span class="s2">}</span>

        <span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_x'</span><span class="s2">] = (</span><span class="s1">scroll_bar </span><span class="s4">and </span><span class="s1">width_scrollable </span><span class="s4">and</span>
                          <span class="s2">(</span><span class="s6">0 </span><span class="s2">&lt;= </span><span class="s1">d</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_pos_x</span><span class="s2">] &lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_width</span><span class="s2">))</span>
        <span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_y'</span><span class="s2">] = (</span><span class="s1">scroll_bar </span><span class="s4">and </span><span class="s1">height_scrollable </span><span class="s4">and</span>
                          <span class="s2">(</span><span class="s6">0 </span><span class="s2">&lt;= </span><span class="s1">d</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_pos_y</span><span class="s2">] &lt;= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_width</span><span class="s2">))</span>

        <span class="s4">if </span><span class="s3">'button' </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">profile </span><span class="s4">and </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">button</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'scroll'</span><span class="s2">):</span>
            <span class="s1">btn </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">button</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_wheel_distance</span>
            <span class="s1">e </span><span class="s2">= </span><span class="s4">None</span>

            <span class="s4">if </span><span class="s2">(</span>
                <span class="s2">(</span><span class="s1">btn </span><span class="s2">== </span><span class="s3">'scrolldown' </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">&gt;= </span><span class="s6">1</span><span class="s2">)</span>
                <span class="s4">or </span><span class="s2">(</span><span class="s1">btn </span><span class="s2">== </span><span class="s3">'scrollup' </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">&lt;= </span><span class="s6">0</span><span class="s2">)</span>
                <span class="s4">or </span><span class="s2">(</span><span class="s1">btn </span><span class="s2">== </span><span class="s3">'scrollleft' </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">&gt;= </span><span class="s6">1</span><span class="s2">)</span>
                <span class="s4">or </span><span class="s2">(</span><span class="s1">btn </span><span class="s2">== </span><span class="s3">'scrollright' </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">&lt;= </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s2">):</span>
                <span class="s4">return False</span>

            <span class="s4">if </span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span>
                <span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y</span>
                <span class="s4">and </span><span class="s1">height_scrollable</span>
                <span class="s4">and </span><span class="s1">btn </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'scrolldown'</span><span class="s2">, </span><span class="s3">'scrollup'</span><span class="s2">)</span>
            <span class="s2">):</span>
                <span class="s1">e </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x </span><span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_x'</span><span class="s2">] </span><span class="s4">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span>

            <span class="s4">elif </span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span>
                <span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x</span>
                <span class="s4">and </span><span class="s1">width_scrollable</span>
                <span class="s4">and </span><span class="s1">btn </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'scrollleft'</span><span class="s2">, </span><span class="s3">'scrollright'</span><span class="s2">)</span>
            <span class="s2">):</span>
                <span class="s1">e </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y </span><span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_y'</span><span class="s2">] </span><span class="s4">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span>

            <span class="s4">if </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s5"># make sure the effect's value is synced to scroll value</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_bounds</span><span class="s2">()</span>
                <span class="s4">if </span><span class="s1">btn </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'scrolldown'</span><span class="s2">, </span><span class="s3">'scrollleft'</span><span class="s2">):</span>
                    <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">smooth_scroll_end</span><span class="s2">:</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">velocity </span><span class="s2">-= </span><span class="s1">m </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">smooth_scroll_end</span>
                    <span class="s4">else</span><span class="s2">:</span>
                        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll</span><span class="s2">:</span>
                            <span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">- </span><span class="s1">m</span>
                        <span class="s4">else</span><span class="s2">:</span>
                            <span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">- </span><span class="s1">m</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">max</span><span class="s2">)</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">velocity </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s4">elif </span><span class="s1">btn </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'scrollup'</span><span class="s2">, </span><span class="s3">'scrollright'</span><span class="s2">):</span>
                    <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">smooth_scroll_end</span><span class="s2">:</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">velocity </span><span class="s2">+= </span><span class="s1">m </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">smooth_scroll_end</span>
                    <span class="s4">else</span><span class="s2">:</span>
                        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll</span><span class="s2">:</span>
                            <span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">+ </span><span class="s1">m</span>
                        <span class="s4">else</span><span class="s2">:</span>
                            <span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">value </span><span class="s2">+ </span><span class="s1">m</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">min</span><span class="s2">)</span>
                        <span class="s1">e</span><span class="s2">.</span><span class="s1">velocity </span><span class="s2">= </span><span class="s6">0</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'svavoid'</span><span class="s2">)] = </span><span class="s4">True</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">trigger_velocity_update</span><span class="s2">()</span>
            <span class="s4">return True</span>

        <span class="s1">in_bar </span><span class="s2">= </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_x'</span><span class="s2">] </span><span class="s4">or </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_y'</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">scroll_type </span><span class="s2">== [</span><span class="s3">'bars'</span><span class="s2">] </span><span class="s4">and not </span><span class="s1">in_bar</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">simulate_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">in_bar</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s2">(</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_y'</span><span class="s2">] </span><span class="s4">and not</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch_in_handle</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handle_y_pos</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_handle_y_size</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">)):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">= (</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">) / </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
            <span class="s4">elif </span><span class="s2">(</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_x'</span><span class="s2">] </span><span class="s4">and not</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch_in_handle</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_handle_x_pos</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_handle_x_size</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">)):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">= (</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">) / </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>

        <span class="s5"># no mouse scrolling, so the user is going to drag the scrollview with</span>
        <span class="s5"># this touch.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s1">touch</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()</span>

        <span class="s1">ud</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">] = {</span>
            <span class="s3">'mode'</span><span class="s2">: </span><span class="s3">'unknown'</span><span class="s2">,</span>
            <span class="s3">'dx'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">,</span>
            <span class="s3">'dy'</span><span class="s2">: </span><span class="s6">0</span><span class="s2">,</span>
            <span class="s3">'user_stopped'</span><span class="s2">: </span><span class="s1">in_bar</span><span class="s2">,</span>
            <span class="s3">'frames'</span><span class="s2">: </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">frames</span><span class="s2">,</span>
            <span class="s3">'time'</span><span class="s2">: </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">time_start</span><span class="s2">,</span>
        <span class="s2">}</span>

        <span class="s4">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x </span><span class="s4">and not </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_x'</span><span class="s2">]</span>
                <span class="s4">and not </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_y'</span><span class="s2">]):</span>
            <span class="s5"># make sure the effect's value is synced to scroll value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_bounds</span><span class="s2">()</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_effect_x_start_width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">start</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_scroll_x_mouse </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x</span>

        <span class="s4">if </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y </span><span class="s4">and not </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_x'</span><span class="s2">]</span>
                <span class="s4">and not </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'in_bar_y'</span><span class="s2">]):</span>
            <span class="s5"># make sure the effect's value is synced to scroll value</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_bounds</span><span class="s2">()</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_effect_y_start_height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">start</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_scroll_y_mouse </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y</span>

        <span class="s4">if not </span><span class="s1">in_bar</span><span class="s2">:</span>
            <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode</span><span class="s2">,</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_timeout </span><span class="s2">/ </span><span class="s6">1000.</span><span class="s2">)</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s4">is not </span><span class="s1">touch</span><span class="s2">:</span>
            <span class="s5"># don't pass on touch to children if outside the sv</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
                <span class="s5"># touch is in parent</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
                <span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">() </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s4">return True</span>

        <span class="s4">if not </span><span class="s1">any</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">) </span><span class="s4">and </span><span class="s1">key</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'sv.'</span><span class="s2">)</span>
                   <span class="s4">for </span><span class="s1">key </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">):</span>
            <span class="s5"># don't pass on touch to children if outside the sv</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
                <span class="s5"># touch is in window coordinates</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_move</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s4">return </span><span class="s1">res</span>
            <span class="s4">return False</span>

        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.handled'</span><span class="s2">] = {</span><span class="s3">'x'</span><span class="s2">: </span><span class="s4">False</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">: </span><span class="s4">False</span><span class="s2">}</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_scroll_move'</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
            <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_scroll_move</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'svavoid'</span><span class="s2">) </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s4">return False</span>

        <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch_children</span><span class="s2">(</span><span class="s3">'on_scroll_move'</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s4">return True</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s1">rv </span><span class="s2">= </span><span class="s4">True</span>

        <span class="s5"># By default this touch can be used to defocus currently focused</span>
        <span class="s5"># widget, like any touch outside of ScrollView.</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.can_defocus'</span><span class="s2">] = </span><span class="s4">True</span>

        <span class="s1">uid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">uid </span><span class="s4">not in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_scroll_start</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>
        <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">]</span>

        <span class="s5"># check if the minimum distance has been travelled</span>
        <span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] == </span><span class="s3">'unknown'</span><span class="s2">:</span>
            <span class="s4">if not </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y</span><span class="s2">):</span>
                <span class="s5"># touch is in parent, but _change expects window coords</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_window</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode</span><span class="s2">()</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s4">return</span>
            <span class="s1">ud</span><span class="s2">[</span><span class="s3">'dx'</span><span class="s2">] += </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">dx</span><span class="s2">)</span>
            <span class="s1">ud</span><span class="s2">[</span><span class="s3">'dy'</span><span class="s2">] += </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">dy</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s2">((</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'dx'</span><span class="s2">] &gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_distance </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x</span><span class="s2">) </span><span class="s4">or</span>
                    <span class="s2">(</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'dy'</span><span class="s2">] &gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_distance </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y</span><span class="s2">)):</span>
                <span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] = </span><span class="s3">'scroll'</span>

        <span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] == </span><span class="s3">'scroll'</span><span class="s2">:</span>
            <span class="s1">not_in_bar </span><span class="s2">= </span><span class="s4">not </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'in_bar_x'</span><span class="s2">, </span><span class="s4">False</span><span class="s2">) </span><span class="s4">and </span><span class="s1">\</span>
                <span class="s4">not </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'in_bar_y'</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>

            <span class="s4">if not </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.handled'</span><span class="s2">][</span><span class="s3">'x'</span><span class="s2">] </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x \</span>
                    <span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">:</span>
                <span class="s1">width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
                <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'in_bar_x'</span><span class="s2">, </span><span class="s4">False</span><span class="s2">):</span>
                    <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hbar</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] != </span><span class="s6">1</span><span class="s2">:</span>
                        <span class="s1">dx </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">dx </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">width </span><span class="s2">- </span><span class="s1">width </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">hbar</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">+ </span><span class="s1">dx</span><span class="s2">, </span><span class="s6">0.</span><span class="s2">), </span><span class="s6">1.</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span><span class="s2">()</span>
                <span class="s4">elif </span><span class="s1">not_in_bar</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>

                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">&lt; </span><span class="s6">0 </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">&gt; </span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s1">rv </span><span class="s2">= </span><span class="s4">False</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.handled'</span><span class="s2">][</span><span class="s3">'x'</span><span class="s2">] = </span><span class="s4">True</span>
                <span class="s5"># Touch resulted in scroll should not defocus focused widget</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.can_defocus'</span><span class="s2">] = </span><span class="s4">False</span>
            <span class="s4">if not </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.handled'</span><span class="s2">][</span><span class="s3">'y'</span><span class="s2">] </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y \</span>
                    <span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">:</span>
                <span class="s1">height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
                <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'in_bar_y'</span><span class="s2">, </span><span class="s4">False</span><span class="s2">) </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vbar</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] != </span><span class="s6">1.0</span><span class="s2">:</span>
                    <span class="s1">dy </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">dy </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">height </span><span class="s2">- </span><span class="s1">height </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vbar</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">+ </span><span class="s1">dy</span><span class="s2">, </span><span class="s6">0.</span><span class="s2">), </span><span class="s6">1.</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span><span class="s2">()</span>
                <span class="s4">elif </span><span class="s1">not_in_bar</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>

                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">&lt; </span><span class="s6">0 </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">&gt; </span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s1">rv </span><span class="s2">= </span><span class="s4">False</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.handled'</span><span class="s2">][</span><span class="s3">'y'</span><span class="s2">] = </span><span class="s4">True</span>
                <span class="s5"># Touch resulted in scroll should not defocus focused widget</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'sv.can_defocus'</span><span class="s2">] = </span><span class="s4">False</span>
            <span class="s1">ud</span><span class="s2">[</span><span class="s3">'dt'</span><span class="s2">] = </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">time_update </span><span class="s2">- </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'time'</span><span class="s2">]</span>
            <span class="s1">ud</span><span class="s2">[</span><span class="s3">'time'</span><span class="s2">] = </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">time_update</span>
            <span class="s1">ud</span><span class="s2">[</span><span class="s3">'user_stopped'</span><span class="s2">] = </span><span class="s4">True</span>
        <span class="s4">return </span><span class="s1">rv</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'svavoid'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s4">is not </span><span class="s1">touch </span><span class="s4">and </span><span class="s1">uid </span><span class="s4">not in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s5"># don't pass on touch to children if outside the sv</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">):</span>
                <span class="s5"># touch is in parents</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
                <span class="s4">if </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">):</span>
                    <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                    <span class="s4">return True</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s4">return False</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_scroll_stop'</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">ungrab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s4">if not </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'sv.can_defocus'</span><span class="s2">, </span><span class="s4">True</span><span class="s2">):</span>
                <span class="s5"># Focused widget should stay focused</span>
                <span class="s1">FocusBehavior</span><span class="s2">.</span><span class="s1">ignored_touch</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_scroll_stop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">, </span><span class="s1">check_children</span><span class="s2">=</span><span class="s4">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s4">if </span><span class="s1">check_children</span><span class="s2">:</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch_children</span><span class="s2">(</span><span class="s3">'on_scroll_stop'</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
                <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
                <span class="s4">return True</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s3">'svavoid'</span><span class="s2">) </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">() </span><span class="s4">not in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s4">return False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()</span>
        <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">]</span>
        <span class="s1">not_in_bar </span><span class="s2">= </span><span class="s4">not </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'in_bar_x'</span><span class="s2">, </span><span class="s4">False</span><span class="s2">) </span><span class="s4">and </span><span class="s1">\</span>
            <span class="s4">not </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'in_bar_y'</span><span class="s2">, </span><span class="s4">False</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x </span><span class="s4">and </span><span class="s1">not_in_bar</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y </span><span class="s4">and </span><span class="s1">not_in_bar</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] == </span><span class="s3">'unknown'</span><span class="s2">:</span>
            <span class="s5"># we must do the click at least..</span>
            <span class="s5"># only send the click if it was not a click to stop</span>
            <span class="s5"># autoscrolling</span>
            <span class="s4">if not </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'user_stopped'</span><span class="s2">]:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">simulate_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_do_touch_up</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">), </span><span class="s6">.2</span><span class="s2">)</span>

        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_bounds_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_bounds_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_effect_bounds</span><span class="s2">)</span>
        <span class="s1">ev</span><span class="s2">()</span>

        <span class="s5"># if we do mouse scrolling, always accept it</span>
        <span class="s4">if </span><span class="s3">'button' </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">profile </span><span class="s4">and </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">button</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'scroll'</span><span class="s2">):</span>
            <span class="s4">return True</span>

        <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">() </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span>

    <span class="s4">def </span><span class="s1">scroll_to</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, </span><span class="s1">padding</span><span class="s2">=</span><span class="s6">10</span><span class="s2">, </span><span class="s1">animate</span><span class="s2">=</span><span class="s4">True</span><span class="s2">):</span>
        <span class="s0">'''Scrolls the viewport to ensure that the given widget is visible, 
        optionally with padding and animation. If animate is True (the 
        default), then the default animation parameters will be used. 
        Otherwise, it should be a dict containing arguments to pass to 
        :class:`~kivy.animation.Animation` constructor. 
 
        .. versionadded:: 1.9.1 
        '''</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s5"># if _viewport is layout and has pending operation, reschedule</span>
        <span class="s4">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">, </span><span class="s3">'do_layout'</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">.</span><span class="s1">_trigger_layout</span><span class="s2">.</span><span class="s1">is_triggered</span><span class="s2">:</span>
                <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span>
                     <span class="s4">lambda </span><span class="s2">*</span><span class="s1">dt</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_to</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">, </span><span class="s1">padding</span><span class="s2">, </span><span class="s1">animate</span><span class="s2">))</span>
                <span class="s4">return</span>

        <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">padding</span><span class="s2">, (</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)):</span>
            <span class="s1">padding </span><span class="s2">= (</span><span class="s1">padding</span><span class="s2">, </span><span class="s1">padding</span><span class="s2">)</span>

        <span class="s1">pos </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">to_widget</span><span class="s2">(*</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">to_window</span><span class="s2">(*</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">))</span>
        <span class="s1">cor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">to_widget</span><span class="s2">(*</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">to_window</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">.</span><span class="s1">right</span><span class="s2">,</span>
                                                      <span class="s1">widget</span><span class="s2">.</span><span class="s1">top</span><span class="s2">))</span>

        <span class="s1">dx </span><span class="s2">= </span><span class="s1">dy </span><span class="s2">= </span><span class="s6">0</span>

        <span class="s4">if </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] &lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">:</span>
            <span class="s1">dy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] + </span><span class="s1">dp</span><span class="s2">(</span><span class="s1">padding</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>
        <span class="s4">elif </span><span class="s1">cor</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] &gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">top</span><span class="s2">:</span>
            <span class="s1">dy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">top </span><span class="s2">- </span><span class="s1">cor</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] - </span><span class="s1">dp</span><span class="s2">(</span><span class="s1">padding</span><span class="s2">[</span><span class="s6">1</span><span class="s2">])</span>

        <span class="s4">if </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] &lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">:</span>
            <span class="s1">dx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">pos</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] + </span><span class="s1">dp</span><span class="s2">(</span><span class="s1">padding</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>
        <span class="s4">elif </span><span class="s1">cor</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] &gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">right</span><span class="s2">:</span>
            <span class="s1">dx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">right </span><span class="s2">- </span><span class="s1">cor</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] - </span><span class="s1">dp</span><span class="s2">(</span><span class="s1">padding</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

        <span class="s1">dsx</span><span class="s2">, </span><span class="s1">dsy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_distance_to_scroll</span><span class="s2">(</span><span class="s1">dx</span><span class="s2">, </span><span class="s1">dy</span><span class="s2">)</span>
        <span class="s1">sxp </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">- </span><span class="s1">dsx</span><span class="s2">))</span>
        <span class="s1">syp </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">max</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">- </span><span class="s1">dsy</span><span class="s2">))</span>

        <span class="s4">if </span><span class="s1">animate</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">animate </span><span class="s4">is True</span><span class="s2">:</span>
                <span class="s1">animate </span><span class="s2">= {</span><span class="s3">'d'</span><span class="s2">: </span><span class="s6">0.2</span><span class="s2">, </span><span class="s3">'t'</span><span class="s2">: </span><span class="s3">'out_quad'</span><span class="s2">}</span>
            <span class="s1">Animation</span><span class="s2">.</span><span class="s1">stop_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'scroll_x'</span><span class="s2">, </span><span class="s3">'scroll_y'</span><span class="s2">)</span>
            <span class="s1">Animation</span><span class="s2">(</span><span class="s1">scroll_x</span><span class="s2">=</span><span class="s1">sxp</span><span class="s2">, </span><span class="s1">scroll_y</span><span class="s2">=</span><span class="s1">syp</span><span class="s2">, **</span><span class="s1">animate</span><span class="s2">).</span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">= </span><span class="s1">sxp</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">= </span><span class="s1">syp</span>

    <span class="s4">def </span><span class="s1">convert_distance_to_scroll</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dx</span><span class="s2">, </span><span class="s1">dy</span><span class="s2">):</span>
        <span class="s0">'''Convert a distance in pixels to a scroll distance, depending on the 
        content size and the scrollview size. 
 
        The result will be a tuple of scroll distance that can be added to 
        :data:`scroll_x` and :data:`scroll_y` 
        '''</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span>
        <span class="s1">vp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>
        <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">:</span>
            <span class="s1">sw </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
            <span class="s1">sx </span><span class="s2">= </span><span class="s1">dx </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">sw</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">sx </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">:</span>
            <span class="s1">sh </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
            <span class="s1">sy </span><span class="s2">= </span><span class="s1">dy </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">sh</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">sy </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s4">return </span><span class="s1">sx</span><span class="s2">, </span><span class="s1">sy</span>

    <span class="s4">def </span><span class="s1">update_from_scroll</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s0">'''Force the reposition of the content, according to current value of 
        :attr:`scroll_x` and :attr:`scroll_y`. 
 
        This method is automatically called when one of the :attr:`scroll_x`, 
        :attr:`scroll_y`, :attr:`pos` or :attr:`size` properties change, or 
        if the size of the content changes. 
        '''</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">g_translate</span><span class="s2">.</span><span class="s1">xy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pos</span>
            <span class="s4">return</span>
        <span class="s1">vp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span>

        <span class="s5"># update from size_hint</span>
        <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_x </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">w </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_x </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
            <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_min_x </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">w </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_min_x</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_max_x </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">w </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_max_x</span><span class="s2">)</span>
            <span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">w</span>

        <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_y </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s1">h </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_y </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
            <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_min_y </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">h </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_min_y</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_max_y </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">h </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">size_hint_max_y</span><span class="s2">)</span>
            <span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s1">h</span>

        <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll</span><span class="s2">:</span>
            <span class="s1">sw </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">width </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_x </span><span class="s2">* </span><span class="s1">sw</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span>

        <span class="s4">if </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height </span><span class="s4">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">always_overscroll</span><span class="s2">:</span>
            <span class="s1">sh </span><span class="s2">= </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scroll_y </span><span class="s2">* </span><span class="s1">sh</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">top </span><span class="s2">- </span><span class="s1">vp</span><span class="s2">.</span><span class="s1">height</span>

        <span class="s5"># from 1.8.0, we now use a matrix by default, instead of moving the</span>
        <span class="s5"># widget position behind. We set it here, but it will be a no-op most</span>
        <span class="s5"># of the time.</span>
        <span class="s1">vp</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">g_translate</span><span class="s2">.</span><span class="s1">xy </span><span class="s2">= </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span>

        <span class="s5"># New in 1.2.0, show bar when scrolling happens and (changed in 1.9.0)</span>
        <span class="s5"># fade to bar_inactive_color when no scroll is happening.</span>
        <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bind_inactive_bar_color_ev</span>
        <span class="s4">if </span><span class="s1">ev </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">ev </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bind_inactive_bar_color_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_bind_inactive_bar_color</span><span class="s2">, </span><span class="s6">.5</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">funbind</span><span class="s2">(</span><span class="s3">'bar_inactive_color'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_bar_color</span><span class="s2">)</span>
        <span class="s1">Animation</span><span class="s2">.</span><span class="s1">stop_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'_bar_color'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span><span class="s2">(</span><span class="s3">'bar_color'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_bar_color</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bar_color </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_color</span>
        <span class="s1">ev</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_bind_inactive_bar_color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">funbind</span><span class="s2">(</span><span class="s3">'bar_color'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_bar_color</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span><span class="s2">(</span><span class="s3">'bar_inactive_color'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_bar_color</span><span class="s2">)</span>
        <span class="s1">Animation</span><span class="s2">(</span>
            <span class="s1">_bar_color</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bar_inactive_color</span><span class="s2">,</span>
            <span class="s1">d</span><span class="s2">=</span><span class="s6">.5</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s3">'out_quart'</span><span class="s2">).</span><span class="s1">start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_change_bar_color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">inst</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_bar_color </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s4">def </span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">'ScrollView accept only one widget'</span><span class="s2">)</span>
        <span class="s1">canvas </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas_viewport</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas </span><span class="s2">= </span><span class="s1">canvas</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport </span><span class="s2">= </span><span class="s1">widget</span>
        <span class="s1">widget</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span><span class="s2">,</span>
                    <span class="s1">size_hint_min</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_from_scroll</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">canvas </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas_viewport</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">remove_widget</span><span class="s2">(</span><span class="s1">widget</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas </span><span class="s2">= </span><span class="s1">canvas</span>
        <span class="s4">if </span><span class="s1">widget </span><span class="s4">is </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_viewport </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s4">def </span><span class="s1">_get_uid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s3">'sv'</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s3">'{0}.{1}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">prefix</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_change_touch_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_uid</span><span class="s2">()</span>
        <span class="s1">touch </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_touch</span>
        <span class="s4">if </span><span class="s1">uid </span><span class="s4">not in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">return</span>
        <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">]</span>
        <span class="s4">if </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'mode'</span><span class="s2">] != </span><span class="s3">'unknown' </span><span class="s4">or </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'user_stopped'</span><span class="s2">]:</span>
            <span class="s4">return</span>
        <span class="s1">diff_frames </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">frames </span><span class="s2">- </span><span class="s1">ud</span><span class="s2">[</span><span class="s3">'frames'</span><span class="s2">]</span>

        <span class="s5"># in order to be able to scroll on very slow devices, let at least 3</span>
        <span class="s5"># frames displayed to accumulate some velocity. And then, change the</span>
        <span class="s5"># touch mode. Otherwise, we might never be able to compute velocity,</span>
        <span class="s5"># and no way to scroll it. See #1464 and #1499</span>
        <span class="s4">if </span><span class="s1">diff_frames </span><span class="s2">&lt; </span><span class="s6">3</span><span class="s2">:</span>
            <span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_change_touch_mode</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>
            <span class="s4">return</span>

        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_x </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_x</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">do_scroll_y </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">effect_y</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
        <span class="s5"># XXX the next line was in the condition. But this stop</span>
        <span class="s5"># the possibility to &quot;drag&quot; an object out of the scrollview in the</span>
        <span class="s5"># non-used direction: if you have an horizontal scrollview, a</span>
        <span class="s5"># vertical gesture will not &quot;stop&quot; the scroll view to look for an</span>
        <span class="s5"># horizontal gesture, until the timeout is done.</span>
        <span class="s5"># and touch.dx + touch.dy == 0:</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">ungrab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_touch </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s5"># touch is in window coords</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_widget</span><span class="s2">)</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_parent</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">simulate_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s4">return</span>

    <span class="s4">def </span><span class="s1">_do_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s5"># touch is in window coords</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_widget</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s5"># don't forget about grab event!</span>
        <span class="s4">for </span><span class="s1">x </span><span class="s4">in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_list</span><span class="s2">[:]:</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_list</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">()</span>
            <span class="s4">if not </span><span class="s1">x</span><span class="s2">:</span>
                <span class="s4">continue</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s2">= </span><span class="s1">x</span>
            <span class="s5"># touch is in window coords</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">apply_transform_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_widget</span><span class="s2">)</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">ScrollView</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s2">= </span><span class="s4">None</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">app </span><span class="s4">import </span><span class="s1">App</span>

    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">gridlayout </span><span class="s4">import </span><span class="s1">GridLayout</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">button </span><span class="s4">import </span><span class="s1">Button</span>

    <span class="s4">class </span><span class="s1">ScrollViewApp</span><span class="s2">(</span><span class="s1">App</span><span class="s2">):</span>

        <span class="s4">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">layout1 </span><span class="s2">= </span><span class="s1">GridLayout</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">=</span><span class="s6">4</span><span class="s2">, </span><span class="s1">spacing</span><span class="s2">=</span><span class="s6">10</span><span class="s2">, </span><span class="s1">size_hint</span><span class="s2">=(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">))</span>
            <span class="s1">layout1</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">minimum_height</span><span class="s2">=</span><span class="s1">layout1</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'height'</span><span class="s2">),</span>
                         <span class="s1">minimum_width</span><span class="s2">=</span><span class="s1">layout1</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'width'</span><span class="s2">))</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">40</span><span class="s2">):</span>
                <span class="s1">btn </span><span class="s2">= </span><span class="s1">Button</span><span class="s2">(</span><span class="s1">text</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">size_hint</span><span class="s2">=(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),</span>
                             <span class="s1">size</span><span class="s2">=(</span><span class="s6">200</span><span class="s2">, </span><span class="s6">100</span><span class="s2">))</span>
                <span class="s1">layout1</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">btn</span><span class="s2">)</span>
            <span class="s1">scrollview1 </span><span class="s2">= </span><span class="s1">ScrollView</span><span class="s2">(</span><span class="s1">bar_width</span><span class="s2">=</span><span class="s3">'2dp'</span><span class="s2">, </span><span class="s1">smooth_scroll_end</span><span class="s2">=</span><span class="s6">10</span><span class="s2">)</span>
            <span class="s1">scrollview1</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">layout1</span><span class="s2">)</span>

            <span class="s1">layout2 </span><span class="s2">= </span><span class="s1">GridLayout</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">=</span><span class="s6">4</span><span class="s2">, </span><span class="s1">spacing</span><span class="s2">=</span><span class="s6">10</span><span class="s2">, </span><span class="s1">size_hint</span><span class="s2">=(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">))</span>
            <span class="s1">layout2</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">minimum_height</span><span class="s2">=</span><span class="s1">layout2</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'height'</span><span class="s2">),</span>
                         <span class="s1">minimum_width</span><span class="s2">=</span><span class="s1">layout2</span><span class="s2">.</span><span class="s1">setter</span><span class="s2">(</span><span class="s3">'width'</span><span class="s2">))</span>
            <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s6">40</span><span class="s2">):</span>
                <span class="s1">btn </span><span class="s2">= </span><span class="s1">Button</span><span class="s2">(</span><span class="s1">text</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">size_hint</span><span class="s2">=(</span><span class="s4">None</span><span class="s2">, </span><span class="s4">None</span><span class="s2">),</span>
                             <span class="s1">size</span><span class="s2">=(</span><span class="s6">200</span><span class="s2">, </span><span class="s6">100</span><span class="s2">))</span>
                <span class="s1">layout2</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">btn</span><span class="s2">)</span>
            <span class="s1">scrollview2 </span><span class="s2">= </span><span class="s1">ScrollView</span><span class="s2">(</span><span class="s1">scroll_type</span><span class="s2">=[</span><span class="s3">'bars'</span><span class="s2">],</span>
                                     <span class="s1">bar_width</span><span class="s2">=</span><span class="s3">'9dp'</span><span class="s2">,</span>
                                     <span class="s1">scroll_wheel_distance</span><span class="s2">=</span><span class="s6">100</span><span class="s2">)</span>
            <span class="s1">scrollview2</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">layout2</span><span class="s2">)</span>

            <span class="s1">root </span><span class="s2">= </span><span class="s1">GridLayout</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">=</span><span class="s6">2</span><span class="s2">)</span>
            <span class="s1">root</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">scrollview1</span><span class="s2">)</span>
            <span class="s1">root</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">scrollview2</span><span class="s2">)</span>
            <span class="s4">return </span><span class="s1">root</span>

    <span class="s1">ScrollViewApp</span><span class="s2">().</span><span class="s1">run</span><span class="s2">()</span>
</pre>
</body>
</html>