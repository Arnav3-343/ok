<html>
<head>
<title>vkeyboard.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
vkeyboard.py</font>
</center></td></tr></table>
<pre><span class="s0">''' 
VKeyboard 
========= 
 
.. image:: images/vkeyboard.jpg 
    :align: right 
 
.. versionadded:: 1.0.8 
 
 
VKeyboard is an onscreen keyboard for Kivy. Its operation is intended to be 
transparent to the user. Using the widget directly is NOT recommended. Read the 
section `Request keyboard`_ first. 
 
Modes 
----- 
 
This virtual keyboard has a docked and free mode: 
 
* docked mode (:attr:`VKeyboard.docked` = True) 
  Generally used when only one person is using the computer, like a tablet or 
  personal computer etc. 
* free mode: (:attr:`VKeyboard.docked` = False) 
  Mostly for multitouch surfaces. This mode allows multiple virtual 
  keyboards to be used on the screen. 
 
If the docked mode changes, you need to manually call 
:meth:`VKeyboard.setup_mode` otherwise the change will have no impact. 
During that call, the VKeyboard, implemented on top of a 
:class:`~kivy.uix.scatter.Scatter`, will change the 
behavior of the scatter and position the keyboard near the target (if target 
and docked mode is set). 
 
 
Layouts 
------- 
 
The virtual keyboard is able to load a custom layout. If you create a new 
layout and put the JSON in :file:`&lt;kivy_data_dir&gt;/keyboards/&lt;layoutid&gt;.json`, 
you can load it by setting :attr:`VKeyboard.layout` to your layoutid. 
 
The JSON must be structured like this:: 
 
    { 
        &quot;title&quot;: &quot;Title of your layout&quot;, 
        &quot;description&quot;: &quot;Description of your layout&quot;, 
        &quot;cols&quot;: 15, 
        &quot;rows&quot;: 5, 
 
        ... 
    } 
 
Then, you need to describe the keys in each row, for either a &quot;normal&quot;, 
&quot;shift&quot; or a &quot;special&quot; (added in version 1.9.0) mode. Keys for this row 
data must be named `normal_&lt;row&gt;`, `shift_&lt;row&gt;` and `special_&lt;row&gt;`. 
Replace `row` with the row number. 
Inside each row, you will describe the key. A key is a 4 element list in 
the format:: 
 
    [ &lt;text displayed on the keyboard&gt;, &lt;text to put when the key is pressed&gt;, 
      &lt;text that represents the keycode&gt;, &lt;size of cols&gt; ] 
 
Here are example keys:: 
 
    # f key 
    [&quot;f&quot;, &quot;f&quot;, &quot;f&quot;, 1] 
    # capslock 
    [&quot;\u21B9&quot;, &quot;\t&quot;, &quot;tab&quot;, 1.5] 
 
Finally, complete the JSON:: 
 
    { 
        ... 
        &quot;normal_1&quot;: [ 
            [&quot;`&quot;, &quot;`&quot;, &quot;`&quot;, 1],    [&quot;1&quot;, &quot;1&quot;, &quot;1&quot;, 1],    [&quot;2&quot;, &quot;2&quot;, &quot;2&quot;, 1], 
            [&quot;3&quot;, &quot;3&quot;, &quot;3&quot;, 1],    [&quot;4&quot;, &quot;4&quot;, &quot;4&quot;, 1],    [&quot;5&quot;, &quot;5&quot;, &quot;5&quot;, 1], 
            [&quot;6&quot;, &quot;6&quot;, &quot;6&quot;, 1],    [&quot;7&quot;, &quot;7&quot;, &quot;7&quot;, 1],    [&quot;8&quot;, &quot;8&quot;, &quot;8&quot;, 1], 
            [&quot;9&quot;, &quot;9&quot;, &quot;9&quot;, 1],    [&quot;0&quot;, &quot;0&quot;, &quot;0&quot;, 1],    [&quot;+&quot;, &quot;+&quot;, &quot;+&quot;, 1], 
            [&quot;=&quot;, &quot;=&quot;, &quot;=&quot;, 1],    [&quot;\u232b&quot;, null, &quot;backspace&quot;, 2] 
        ], 
 
        &quot;shift_1&quot;: [ ... ], 
        &quot;normal_2&quot;: [ ... ], 
        &quot;special_2&quot;: [ ... ], 
        ... 
    } 
 
 
Request Keyboard 
---------------- 
 
The instantiation of the virtual keyboard is controlled by the configuration. 
Check `keyboard_mode` and `keyboard_layout` in the :doc:`api-kivy.config`. 
 
If you intend to create a widget that requires a keyboard, do not use the 
virtual keyboard directly, but prefer to use the best method available on 
the platform. Check the :meth:`~kivy.core.window.WindowBase.request_keyboard` 
method in the :doc:`api-kivy.core.window`. 
 
If you want a specific layout when you request the keyboard, you should write 
something like this (from 1.8.0, numeric.json can be in the same directory as 
your main.py):: 
 
    keyboard = Window.request_keyboard( 
        self._keyboard_close, self) 
    if keyboard.widget: 
        vkeyboard = self._keyboard.widget 
        vkeyboard.layout = 'numeric.json' 
 
'''</span>

<span class="s1">__all__ </span><span class="s2">= (</span><span class="s3">'VKeyboard'</span><span class="s2">, )</span>

<span class="s4">from </span><span class="s1">kivy </span><span class="s4">import </span><span class="s1">kivy_data_dir</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">vector </span><span class="s4">import </span><span class="s1">Vector</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">config </span><span class="s4">import </span><span class="s1">Config</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">scatter </span><span class="s4">import </span><span class="s1">Scatter</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">uix</span><span class="s2">.</span><span class="s1">label </span><span class="s4">import </span><span class="s1">Label</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">properties </span><span class="s4">import </span><span class="s1">ObjectProperty</span><span class="s2">, </span><span class="s1">NumericProperty</span><span class="s2">, </span><span class="s1">StringProperty</span><span class="s2">, </span><span class="s1">\</span>
    <span class="s1">BooleanProperty</span><span class="s2">, </span><span class="s1">DictProperty</span><span class="s2">, </span><span class="s1">OptionProperty</span><span class="s2">, </span><span class="s1">ListProperty</span><span class="s2">, </span><span class="s1">ColorProperty</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">logger </span><span class="s4">import </span><span class="s1">Logger</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">graphics </span><span class="s4">import </span><span class="s1">Color</span><span class="s2">, </span><span class="s1">BorderImage</span><span class="s2">, </span><span class="s1">Canvas</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">image </span><span class="s4">import </span><span class="s1">Image</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">resources </span><span class="s4">import </span><span class="s1">resource_find</span>
<span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">clock </span><span class="s4">import </span><span class="s1">Clock</span>

<span class="s4">from </span><span class="s1">io </span><span class="s4">import </span><span class="s1">open</span>
<span class="s4">from </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path </span><span class="s4">import </span><span class="s1">join</span><span class="s2">, </span><span class="s1">splitext</span><span class="s2">, </span><span class="s1">basename</span>
<span class="s4">from </span><span class="s1">os </span><span class="s4">import </span><span class="s1">listdir</span>
<span class="s4">from </span><span class="s1">json </span><span class="s4">import </span><span class="s1">loads</span>


<span class="s1">default_layout_path </span><span class="s2">= </span><span class="s1">join</span><span class="s2">(</span><span class="s1">kivy_data_dir</span><span class="s2">, </span><span class="s3">'keyboards'</span><span class="s2">)</span>


<span class="s4">class </span><span class="s1">VKeyboard</span><span class="s2">(</span><span class="s1">Scatter</span><span class="s2">):</span>
    <span class="s0">''' 
    VKeyboard is an onscreen keyboard with multitouch support. 
    Its layout is entirely customizable and you can switch between available 
    layouts using a button in the bottom right of the widget. 
 
    :Events: 
        `on_key_down`: keycode, internal, modifiers 
            Fired when the keyboard received a key down event (key press). 
        `on_key_up`: keycode, internal, modifiers 
            Fired when the keyboard received a key up event (key release). 
    '''</span>

    <span class="s1">target </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Target widget associated with the VKeyboard. If set, it will be used to 
    send keyboard events. If the VKeyboard mode is &quot;free&quot;, it will also be used 
    to set the initial position. 
 
    :attr:`target` is an :class:`~kivy.properties.ObjectProperty` instance and 
    defaults to None. 
    '''</span>

    <span class="s1">callback </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">, </span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>
    <span class="s3">'''Callback can be set to a function that will be called if the 
    VKeyboard is closed by the user. 
 
    :attr:`target` is an :class:`~kivy.properties.ObjectProperty` instance and 
    defaults to None. 
    '''</span>

    <span class="s1">layout </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s4">None</span><span class="s2">)</span>
    <span class="s3">'''Layout to use for the VKeyboard. By default, it will be the 
    layout set in the configuration, according to the `keyboard_layout` 
    in `[kivy]` section. 
 
    .. versionchanged:: 1.8.0 
        If layout is a .json filename, it will loaded and added to the 
        available_layouts. 
 
    :attr:`layout` is a :class:`~kivy.properties.StringProperty` and defaults 
    to None. 
    '''</span>

    <span class="s1">layout_path </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s1">default_layout_path</span><span class="s2">)</span>
    <span class="s3">'''Path from which layouts are read. 
 
    :attr:`layout` is a :class:`~kivy.properties.StringProperty` and 
    defaults to :file:`&lt;kivy_data_dir&gt;/keyboards/` 
    '''</span>

    <span class="s1">available_layouts </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s3">'''Dictionary of all available layouts. Keys are the layout ID, and the 
    value is the JSON (translated into a Python object). 
 
    :attr:`available_layouts` is a :class:`~kivy.properties.DictProperty` and 
    defaults to {}. 
    '''</span>

    <span class="s1">docked </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s3">'''Indicate whether the VKeyboard is docked on the screen or not. If you 
    change it, you must manually call :meth:`setup_mode` otherwise it will have 
    no impact. If the VKeyboard is created by the Window, the docked mode will 
    be automatically set by the configuration, using the `keyboard_mode` token 
    in `[kivy]` section. 
 
    :attr:`docked` is a :class:`~kivy.properties.BooleanProperty` and defaults 
    to False. 
    '''</span>

    <span class="s1">margin_hint </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([</span><span class="s5">.05</span><span class="s2">, </span><span class="s5">.06</span><span class="s2">, </span><span class="s5">.05</span><span class="s2">, </span><span class="s5">.06</span><span class="s2">])</span>
    <span class="s3">'''Margin hint, used as spacing between keyboard background and keys 
    content. The margin is composed of four values, between 0 and 1:: 
 
        margin_hint = [top, right, bottom, left] 
 
    The margin hints will be multiplied by width and height, according to their 
    position. 
 
    :attr:`margin_hint` is a :class:`~kivy.properties.ListProperty` and 
    defaults to [.05, .06, .05, .06] 
    '''</span>

    <span class="s1">key_margin </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s3">'''Key margin, used to create space between keys. The margin is composed of 
    four values, in pixels:: 
 
        key_margin = [top, right, bottom, left] 
 
    :attr:`key_margin` is a :class:`~kivy.properties.ListProperty` and defaults 
    to [2, 2, 2, 2] 
    '''</span>

    <span class="s1">font_size </span><span class="s2">= </span><span class="s1">NumericProperty</span><span class="s2">(</span><span class="s5">20.</span><span class="s2">)</span>
    <span class="s3">'''font_size, specifies the size of the text on the virtual keyboard keys. 
    It should be kept within limits to ensure the text does not extend beyond 
    the bounds of the key or become too small to read. 
 
    .. versionadded:: 1.10.0 
 
    :attr:`font_size` is a :class:`~kivy.properties.NumericProperty` and 
    defaults to 20. 
    '''</span>

    <span class="s1">background_color </span><span class="s2">= </span><span class="s1">ColorProperty</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s3">'''Background color, in the format (r, g, b, a). If a background is 
    set, the color will be combined with the background texture. 
 
    :attr:`background_color` is a :class:`~kivy.properties.ColorProperty` and 
    defaults to [1, 1, 1, 1]. 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">background </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/vkeyboard_background'</span><span class="s2">)</span>
    <span class="s3">'''Filename of the background image. 
 
    :attr:`background` is a :class:`~kivy.properties.StringProperty` and 
    defaults to :file:`atlas://data/images/defaulttheme/vkeyboard_background`. 
    '''</span>

    <span class="s1">background_disabled </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/vkeyboard_disabled_background'</span><span class="s2">)</span>
    <span class="s3">'''Filename of the background image when the vkeyboard is disabled. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`background_disabled` is a 
    :class:`~kivy.properties.StringProperty` and defaults to 
    :file:`atlas://data/images/defaulttheme/vkeyboard__disabled_background`. 
 
    '''</span>

    <span class="s1">key_background_color </span><span class="s2">= </span><span class="s1">ColorProperty</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s3">'''Key background color, in the format (r, g, b, a). If a key background is 
    set, the color will be combined with the key background texture. 
 
    :attr:`key_background_color` is a :class:`~kivy.properties.ColorProperty` 
    and defaults to [1, 1, 1, 1]. 
 
    .. versionchanged:: 2.0.0 
        Changed from :class:`~kivy.properties.ListProperty` to 
        :class:`~kivy.properties.ColorProperty`. 
    '''</span>

    <span class="s1">key_background_normal </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/vkeyboard_key_normal'</span><span class="s2">)</span>
    <span class="s3">'''Filename of the key background image for use when no touches are active 
    on the widget. 
 
    :attr:`key_background_normal` is a :class:`~kivy.properties.StringProperty` 
    and defaults to 
    :file:`atlas://data/images/defaulttheme/vkeyboard_key_normal`. 
    '''</span>

    <span class="s1">key_disabled_background_normal </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/vkeyboard_key_normal'</span><span class="s2">)</span>
    <span class="s3">'''Filename of the key background image for use when no touches are active 
    on the widget and vkeyboard is disabled. 
 
    .. versionadded:: 1.8.0 
 
    :attr:`key_disabled_background_normal` is a 
    :class:`~kivy.properties.StringProperty` and defaults to 
    :file:`atlas://data/images/defaulttheme/vkeyboard_disabled_key_normal`. 
 
    '''</span>

    <span class="s1">key_background_down </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span>
        <span class="s3">'atlas://data/images/defaulttheme/vkeyboard_key_down'</span><span class="s2">)</span>
    <span class="s3">'''Filename of the key background image for use when a touch is active 
    on the widget. 
 
    :attr:`key_background_down` is a :class:`~kivy.properties.StringProperty` 
    and defaults to 
    :file:`atlas://data/images/defaulttheme/vkeyboard_key_down`. 
    '''</span>

    <span class="s1">background_border </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([</span><span class="s5">16</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">16</span><span class="s2">])</span>
    <span class="s3">'''Background image border. Used for controlling the 
    :attr:`~kivy.graphics.vertex_instructions.BorderImage.border` property of 
    the background. 
 
    :attr:`background_border` is a :class:`~kivy.properties.ListProperty` and 
    defaults to [16, 16, 16, 16] 
    '''</span>

    <span class="s1">key_border </span><span class="s2">= </span><span class="s1">ListProperty</span><span class="s2">([</span><span class="s5">8</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">8</span><span class="s2">])</span>
    <span class="s3">'''Key image border. Used for controlling the 
    :attr:`~kivy.graphics.vertex_instructions.BorderImage.border` property of 
    the key. 
 
    :attr:`key_border` is a :class:`~kivy.properties.ListProperty` and 
    defaults to [16, 16, 16, 16] 
    '''</span>

    <span class="s6"># XXX internal variables</span>
    <span class="s1">layout_mode </span><span class="s2">= </span><span class="s1">OptionProperty</span><span class="s2">(</span><span class="s3">'normal'</span><span class="s2">,</span>
        <span class="s1">options</span><span class="s2">=(</span><span class="s3">'normal'</span><span class="s2">, </span><span class="s3">'shift'</span><span class="s2">, </span><span class="s3">'special'</span><span class="s2">))</span>
    <span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s1">have_capslock </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s1">have_shift </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s1">have_special </span><span class="s2">= </span><span class="s1">BooleanProperty</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>
    <span class="s1">active_keys </span><span class="s2">= </span><span class="s1">DictProperty</span><span class="s2">({})</span>
    <span class="s1">font_name </span><span class="s2">= </span><span class="s1">StringProperty</span><span class="s2">(</span><span class="s3">'data/fonts/DejaVuSans.ttf'</span><span class="s2">)</span>
    <span class="s1">repeat_touch </span><span class="s2">= </span><span class="s1">ObjectProperty</span><span class="s2">(</span><span class="s1">allownone</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>

    <span class="s1">_start_repeat_key_ev </span><span class="s2">= </span><span class="s4">None</span>
    <span class="s1">_repeat_key_ev </span><span class="s2">= </span><span class="s4">None</span>

    <span class="s1">__events__ </span><span class="s2">= (</span><span class="s3">'on_key_down'</span><span class="s2">, </span><span class="s3">'on_key_up'</span><span class="s2">, </span><span class="s3">'on_textinput'</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s6"># XXX move to style.kv</span>
        <span class="s4">if </span><span class="s3">'size_hint' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s3">'size_hint_x' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">size_hint_x </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">if </span><span class="s3">'size_hint_y' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">size_hint_y </span><span class="s2">= </span><span class="s4">None</span>
        <span class="s4">if </span><span class="s3">'size' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s3">'width' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s5">700</span>
            <span class="s4">if </span><span class="s3">'height' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">height </span><span class="s2">= </span><span class="s5">200</span>
        <span class="s4">if </span><span class="s3">'scale_min' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_min </span><span class="s2">= </span><span class="s5">.4</span>
        <span class="s4">if </span><span class="s3">'scale_max' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scale_max </span><span class="s2">= </span><span class="s5">1.6</span>
        <span class="s4">if </span><span class="s3">'docked' </span><span class="s4">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">docked </span><span class="s2">= </span><span class="s4">False</span>

        <span class="s1">layout_mode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_layout_mode </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_layout_mode</span><span class="s2">)</span>
        <span class="s1">layouts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_load_layouts </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_layouts</span><span class="s2">)</span>
        <span class="s1">layout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_load_layout </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">create_trigger</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_layout</span><span class="s2">)</span>
        <span class="s1">fbind </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fbind</span>

        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'docked'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">setup_mode</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'have_shift'</span><span class="s2">, </span><span class="s1">layout_mode</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'have_capslock'</span><span class="s2">, </span><span class="s1">layout_mode</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'have_special'</span><span class="s2">, </span><span class="s1">layout_mode</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'layout_path'</span><span class="s2">, </span><span class="s1">layouts</span><span class="s2">)</span>
        <span class="s1">fbind</span><span class="s2">(</span><span class="s3">'layout'</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">VKeyboard</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s6"># load all the layouts found in the layout_path directory</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_layouts</span><span class="s2">()</span>

        <span class="s6"># ensure we have default layouts</span>
        <span class="s1">available_layouts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_layouts</span>
        <span class="s4">if not </span><span class="s1">available_layouts</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">critical</span><span class="s2">(</span><span class="s3">'VKeyboard: unable to load default layouts'</span><span class="s2">)</span>

        <span class="s6"># load the default layout from configuration</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout </span><span class="s4">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">= </span><span class="s1">Config</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'kivy'</span><span class="s2">, </span><span class="s3">'keyboard_layout'</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s6"># ensure the current layout is found on the available layout</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_load_layout</span><span class="s2">()</span>

        <span class="s6"># update layout mode (shift or normal)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_update_layout_mode</span><span class="s2">()</span>

        <span class="s6"># create a top layer to draw active keys on</span>
        <span class="s4">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">background_key_layer </span><span class="s2">= </span><span class="s1">Canvas</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys_layer </span><span class="s2">= </span><span class="s1">Canvas</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">on_disabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh_keys</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_update_layout_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">l</span><span class="s2">):</span>
        <span class="s6"># update mode according to capslock and shift key</span>
        <span class="s1">mode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">have_capslock </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">have_shift</span>
        <span class="s1">mode </span><span class="s2">= </span><span class="s3">'shift' </span><span class="s4">if </span><span class="s1">mode </span><span class="s4">else </span><span class="s3">'normal'</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">have_special</span><span class="s2">:</span>
            <span class="s1">mode </span><span class="s2">= </span><span class="s3">&quot;special&quot;</span>
        <span class="s4">if </span><span class="s1">mode </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_mode</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout_mode </span><span class="s2">= </span><span class="s1">mode</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh</span><span class="s2">(</span><span class="s4">False</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_load_layout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s6"># ensure new layouts are loaded first</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_load_layouts</span><span class="s2">.</span><span class="s1">is_triggered</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_layouts</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_trigger_load_layouts</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>

        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span>
        <span class="s1">available_layouts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_layouts</span>

        <span class="s6"># it's a filename, try to load it directly</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">[-</span><span class="s5">5</span><span class="s2">:] == </span><span class="s3">'.json'</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">value </span><span class="s4">not in </span><span class="s1">available_layouts</span><span class="s2">:</span>
                <span class="s1">fn </span><span class="s2">= </span><span class="s1">resource_find</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_layout_fn</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">)</span>

        <span class="s4">if not </span><span class="s1">available_layouts</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">value </span><span class="s4">not in </span><span class="s1">available_layouts </span><span class="s4">and </span><span class="s1">value </span><span class="s2">!= </span><span class="s3">'qwerty'</span><span class="s2">:</span>
            <span class="s1">Logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span>
                <span class="s3">'Vkeyboard: &lt;%s&gt; keyboard layout mentioned in '</span>
                <span class="s3">'conf file was not found, fallback on qwerty' </span><span class="s2">%</span>
                <span class="s1">value</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">layout </span><span class="s2">= </span><span class="s3">'qwerty'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh</span><span class="s2">(</span><span class="s4">True</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_load_layouts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s6"># first load available layouts from json files</span>
        <span class="s6"># XXX fix to be able to reload layout when path is changing</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_path</span>
        <span class="s4">for </span><span class="s1">fn </span><span class="s4">in </span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_layout_fn</span><span class="s2">(</span><span class="s1">join</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">),</span>
                                 <span class="s1">basename</span><span class="s2">(</span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]))</span>

    <span class="s4">def </span><span class="s1">_load_layout_fn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">available_layouts </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_layouts</span>
        <span class="s4">if </span><span class="s1">fn</span><span class="s2">[-</span><span class="s5">5</span><span class="s2">:] != </span><span class="s3">'.json'</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s4">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">'utf-8'</span><span class="s2">) </span><span class="s4">as </span><span class="s1">fd</span><span class="s2">:</span>
            <span class="s1">json_content </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>
            <span class="s1">layout </span><span class="s2">= </span><span class="s1">loads</span><span class="s2">(</span><span class="s1">json_content</span><span class="s2">)</span>
        <span class="s1">available_layouts</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">layout</span>

    <span class="s4">def </span><span class="s1">setup_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s0">'''Call this method when you want to readjust the keyboard according to 
        options: :attr:`docked` or not, with attached :attr:`target` or not: 
 
        * If :attr:`docked` is True, it will call :meth:`setup_mode_dock` 
        * If :attr:`docked` is False, it will call :meth:`setup_mode_free` 
 
        Feel free to overload these methods to create new 
        positioning behavior. 
        '''</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">docked</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setup_mode_dock</span><span class="s2">()</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">setup_mode_free</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">setup_mode_dock</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s0">'''Setup the keyboard in docked mode. 
 
        Dock mode will reset the rotation, disable translation, rotation and 
        scale. Scale and position will be automatically adjusted to attach the 
        keyboard to the bottom of the screen. 
 
        .. note:: 
            Don't call this method directly, use :meth:`setup_mode` instead. 
        '''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_translation </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_rotation </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_scale </span><span class="s2">= </span><span class="s4">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">win </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_parent_window</span><span class="s2">()</span>
        <span class="s1">scale </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">= </span><span class="s1">scale</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span>
        <span class="s1">win</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">on_resize</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_dock_mode</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_update_dock_mode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">win</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s1">scale </span><span class="s2">= </span><span class="s1">win</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scale </span><span class="s2">= </span><span class="s1">scale</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span>

    <span class="s4">def </span><span class="s1">setup_mode_free</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">'''Setup the keyboard in free mode. 
 
        Free mode is designed to let the user control the position and 
        orientation of the keyboard. The only real usage is for a multiuser 
        environment, but you might found other ways to use it. 
        If a :attr:`target` is set, it will place the vkeyboard under the 
        target. 
 
        .. note:: 
            Don't call this method directly, use :meth:`setup_mode` instead. 
        '''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_translation </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_rotation </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">do_scale </span><span class="s2">= </span><span class="s4">True</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">target</span>
        <span class="s4">if not </span><span class="s1">target</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s6"># NOTE all math will be done in window point of view</span>
        <span class="s6"># determine rotation of the target</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">Vector</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">Vector</span><span class="s2">(</span><span class="s1">target</span><span class="s2">.</span><span class="s1">to_window</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">Vector</span><span class="s2">(</span><span class="s1">target</span><span class="s2">.</span><span class="s1">to_window</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)) - </span><span class="s1">b</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rotation </span><span class="s2">= -</span><span class="s1">a</span><span class="s2">.</span><span class="s1">angle</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>

        <span class="s6"># determine the position of center/top of the keyboard</span>
        <span class="s1">dpos </span><span class="s2">= </span><span class="s1">Vector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_window</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s5">2.</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">))</span>

        <span class="s6"># determine the position of center/bottom of the target</span>
        <span class="s1">cpos </span><span class="s2">= </span><span class="s1">Vector</span><span class="s2">(</span><span class="s1">target</span><span class="s2">.</span><span class="s1">to_window</span><span class="s2">(</span><span class="s1">target</span><span class="s2">.</span><span class="s1">center_x</span><span class="s2">, </span><span class="s1">target</span><span class="s2">.</span><span class="s1">y</span><span class="s2">))</span>

        <span class="s6"># the goal now is to map both point, calculate the diff between them</span>
        <span class="s1">diff </span><span class="s2">= </span><span class="s1">dpos </span><span class="s2">- </span><span class="s1">cpos</span>

        <span class="s6"># we still have an issue, self.pos represent the bounding box,</span>
        <span class="s6"># not the 0,0 coordinate of the scatter. we need to apply also</span>
        <span class="s6"># the diff between them (inside and outside coordinate matrix).</span>
        <span class="s6"># It's hard to explain, but do a scheme on a paper, write all</span>
        <span class="s6"># the vector i'm calculating, and you'll understand. :)</span>
        <span class="s1">diff2 </span><span class="s2">= </span><span class="s1">Vector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s5">2.</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">) - </span><span class="s1">\</span>
            <span class="s1">Vector</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_parent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s5">2.</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">))</span>
        <span class="s1">diff </span><span class="s2">-= </span><span class="s1">diff2</span>

        <span class="s6"># now we have a good &quot;diff&quot;, set it as a pos.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">= -</span><span class="s1">diff</span>

    <span class="s4">def </span><span class="s1">change_layout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># XXX implement popup with all available layouts</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">refresh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">force</span><span class="s2">=</span><span class="s4">False</span><span class="s2">):</span>
        <span class="s0">'''(internal) Recreate the entire widget and graphics according to the 
        selected layout. 
        '''</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">clear_widgets</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">force</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh_keys_hint</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh_keys</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh_active_keys_layer</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">refresh_active_keys_layer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys_layer</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s1">active_keys </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys</span>
        <span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_geometry</span>
        <span class="s1">background </span><span class="s2">= </span><span class="s1">resource_find</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_background_down</span><span class="s2">)</span>
        <span class="s1">texture </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">(</span><span class="s1">background</span><span class="s2">, </span><span class="s1">mipmap</span><span class="s2">=</span><span class="s4">True</span><span class="s2">).</span><span class="s1">texture</span>

        <span class="s4">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys_layer</span><span class="s2">:</span>
            <span class="s1">Color</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_background_color</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">line_nb</span><span class="s2">, </span><span class="s1">index </span><span class="s4">in </span><span class="s1">active_keys</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s1">pos</span><span class="s2">, </span><span class="s1">size </span><span class="s2">= </span><span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'LINE_%d' </span><span class="s2">% </span><span class="s1">line_nb</span><span class="s2">][</span><span class="s1">index</span><span class="s2">]</span>
                <span class="s1">BorderImage</span><span class="s2">(</span><span class="s1">texture</span><span class="s2">=</span><span class="s1">texture</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">=</span><span class="s1">pos</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">,</span>
                            <span class="s1">border</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_border</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">refresh_keys_hint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">layout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_layouts</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">]</span>
        <span class="s1">layout_cols </span><span class="s2">= </span><span class="s1">layout</span><span class="s2">[</span><span class="s3">'cols'</span><span class="s2">]</span>
        <span class="s1">layout_rows </span><span class="s2">= </span><span class="s1">layout</span><span class="s2">[</span><span class="s3">'rows'</span><span class="s2">]</span>
        <span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_geometry</span>
        <span class="s1">mtop</span><span class="s2">, </span><span class="s1">mright</span><span class="s2">, </span><span class="s1">mbottom</span><span class="s2">, </span><span class="s1">mleft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">margin_hint</span>

        <span class="s6"># get relative EFFICIENT surface of the layout without external margins</span>
        <span class="s1">el_hint </span><span class="s2">= </span><span class="s5">1. </span><span class="s2">- </span><span class="s1">mleft </span><span class="s2">- </span><span class="s1">mright</span>
        <span class="s1">eh_hint </span><span class="s2">= </span><span class="s5">1. </span><span class="s2">- </span><span class="s1">mtop </span><span class="s2">- </span><span class="s1">mbottom</span>
        <span class="s1">ex_hint </span><span class="s2">= </span><span class="s5">0 </span><span class="s2">+ </span><span class="s1">mleft</span>
        <span class="s1">ey_hint </span><span class="s2">= </span><span class="s5">0 </span><span class="s2">+ </span><span class="s1">mbottom</span>

        <span class="s6"># get relative unit surface</span>
        <span class="s1">uw_hint </span><span class="s2">= (</span><span class="s5">1. </span><span class="s2">/ </span><span class="s1">layout_cols</span><span class="s2">) * </span><span class="s1">el_hint</span>
        <span class="s1">uh_hint </span><span class="s2">= (</span><span class="s5">1. </span><span class="s2">/ </span><span class="s1">layout_rows</span><span class="s2">) * </span><span class="s1">eh_hint</span>
        <span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'U_HINT'</span><span class="s2">] = (</span><span class="s1">uw_hint</span><span class="s2">, </span><span class="s1">uh_hint</span><span class="s2">)</span>

        <span class="s6"># calculate individual key RELATIVE surface and pos (without key</span>
        <span class="s6"># margin)</span>
        <span class="s1">current_y_hint </span><span class="s2">= </span><span class="s1">ey_hint </span><span class="s2">+ </span><span class="s1">eh_hint</span>
        <span class="s4">for </span><span class="s1">line_nb </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">layout_rows </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s1">current_y_hint </span><span class="s2">-= </span><span class="s1">uh_hint</span>
            <span class="s6"># get line_name</span>
            <span class="s1">line_name </span><span class="s2">= </span><span class="s3">'%s_%d' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_mode</span><span class="s2">, </span><span class="s1">line_nb</span><span class="s2">)</span>
            <span class="s1">line_hint </span><span class="s2">= </span><span class="s3">'LINE_HINT_%d' </span><span class="s2">% </span><span class="s1">line_nb</span>
            <span class="s1">layout_geometry</span><span class="s2">[</span><span class="s1">line_hint</span><span class="s2">] = []</span>
            <span class="s1">current_x_hint </span><span class="s2">= </span><span class="s1">ex_hint</span>
            <span class="s6"># go through the list of keys (tuples of 4)</span>
            <span class="s4">for </span><span class="s1">key </span><span class="s4">in </span><span class="s1">layout</span><span class="s2">[</span><span class="s1">line_name</span><span class="s2">]:</span>
                <span class="s6"># calculate relative pos, size</span>
                <span class="s1">layout_geometry</span><span class="s2">[</span><span class="s1">line_hint</span><span class="s2">].</span><span class="s1">append</span><span class="s2">([</span>
                    <span class="s2">(</span><span class="s1">current_x_hint</span><span class="s2">, </span><span class="s1">current_y_hint</span><span class="s2">),</span>
                    <span class="s2">(</span><span class="s1">key</span><span class="s2">[</span><span class="s5">3</span><span class="s2">] * </span><span class="s1">uw_hint</span><span class="s2">, </span><span class="s1">uh_hint</span><span class="s2">)])</span>
                <span class="s1">current_x_hint </span><span class="s2">+= </span><span class="s1">key</span><span class="s2">[</span><span class="s5">3</span><span class="s2">] * </span><span class="s1">uw_hint</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">layout_geometry</span>

    <span class="s4">def </span><span class="s1">refresh_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">layout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_layouts</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">]</span>
        <span class="s1">layout_rows </span><span class="s2">= </span><span class="s1">layout</span><span class="s2">[</span><span class="s3">'rows'</span><span class="s2">]</span>
        <span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_geometry</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s1">kmtop</span><span class="s2">, </span><span class="s1">kmright</span><span class="s2">, </span><span class="s1">kmbottom</span><span class="s2">, </span><span class="s1">kmleft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_margin</span>
        <span class="s1">uw_hint</span><span class="s2">, </span><span class="s1">uh_hint </span><span class="s2">= </span><span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'U_HINT'</span><span class="s2">]</span>

        <span class="s4">for </span><span class="s1">line_nb </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">layout_rows </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s1">llg </span><span class="s2">= </span><span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'LINE_%d' </span><span class="s2">% </span><span class="s1">line_nb</span><span class="s2">] = []</span>
            <span class="s1">llg_append </span><span class="s2">= </span><span class="s1">llg</span><span class="s2">.</span><span class="s1">append</span>
            <span class="s4">for </span><span class="s1">key </span><span class="s4">in </span><span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'LINE_HINT_%d' </span><span class="s2">% </span><span class="s1">line_nb</span><span class="s2">]:</span>
                <span class="s1">x_hint</span><span class="s2">, </span><span class="s1">y_hint </span><span class="s2">= </span><span class="s1">key</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s1">w_hint</span><span class="s2">, </span><span class="s1">h_hint </span><span class="s2">= </span><span class="s1">key</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
                <span class="s1">kx </span><span class="s2">= </span><span class="s1">x_hint </span><span class="s2">* </span><span class="s1">w</span>
                <span class="s1">ky </span><span class="s2">= </span><span class="s1">y_hint </span><span class="s2">* </span><span class="s1">h</span>
                <span class="s1">kw </span><span class="s2">= </span><span class="s1">w_hint </span><span class="s2">* </span><span class="s1">w</span>
                <span class="s1">kh </span><span class="s2">= </span><span class="s1">h_hint </span><span class="s2">* </span><span class="s1">h</span>

                <span class="s6"># now adjust, considering the key margin</span>
                <span class="s1">kx </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">kx </span><span class="s2">+ </span><span class="s1">kmleft</span><span class="s2">)</span>
                <span class="s1">ky </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">ky </span><span class="s2">+ </span><span class="s1">kmbottom</span><span class="s2">)</span>
                <span class="s1">kw </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">kw </span><span class="s2">- </span><span class="s1">kmleft </span><span class="s2">- </span><span class="s1">kmright</span><span class="s2">)</span>
                <span class="s1">kh </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">kh </span><span class="s2">- </span><span class="s1">kmbottom </span><span class="s2">- </span><span class="s1">kmtop</span><span class="s2">)</span>

                <span class="s1">pos </span><span class="s2">= (</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky</span><span class="s2">)</span>
                <span class="s1">size </span><span class="s2">= (</span><span class="s1">kw</span><span class="s2">, </span><span class="s1">kh</span><span class="s2">)</span>
                <span class="s1">llg_append</span><span class="s2">((</span><span class="s1">pos</span><span class="s2">, </span><span class="s1">size</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">layout_geometry</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_keys</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">draw_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">layout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_layouts</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">]</span>
        <span class="s1">layout_rows </span><span class="s2">= </span><span class="s1">layout</span><span class="s2">[</span><span class="s3">'rows'</span><span class="s2">]</span>
        <span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_geometry</span>
        <span class="s1">layout_mode </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_mode</span>

        <span class="s6"># draw background</span>
        <span class="s1">background </span><span class="s2">= </span><span class="s1">resource_find</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">background_disabled</span>
                                   <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">disabled </span><span class="s4">else</span>
                                   <span class="s1">self</span><span class="s2">.</span><span class="s1">background</span><span class="s2">)</span>
        <span class="s1">texture </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">(</span><span class="s1">background</span><span class="s2">, </span><span class="s1">mipmap</span><span class="s2">=</span><span class="s4">True</span><span class="s2">).</span><span class="s1">texture</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">background_key_layer</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
        <span class="s4">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">background_key_layer</span><span class="s2">:</span>
            <span class="s1">Color</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">background_color</span><span class="s2">)</span>
            <span class="s1">BorderImage</span><span class="s2">(</span><span class="s1">texture</span><span class="s2">=</span><span class="s1">texture</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">,</span>
                        <span class="s1">border</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">background_border</span><span class="s2">)</span>

        <span class="s6"># XXX separate drawing the keys and the fonts to avoid</span>
        <span class="s6"># XXX reloading the texture each time</span>

        <span class="s6"># first draw keys without the font</span>
        <span class="s1">key_normal </span><span class="s2">= </span><span class="s1">resource_find</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_background_disabled_normal</span>
                                   <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">disabled </span><span class="s4">else</span>
                                   <span class="s1">self</span><span class="s2">.</span><span class="s1">key_background_normal</span><span class="s2">)</span>
        <span class="s1">texture </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">(</span><span class="s1">key_normal</span><span class="s2">, </span><span class="s1">mipmap</span><span class="s2">=</span><span class="s4">True</span><span class="s2">).</span><span class="s1">texture</span>
        <span class="s4">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">background_key_layer</span><span class="s2">:</span>
            <span class="s1">Color</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_background_color</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">line_nb </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">layout_rows </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
                <span class="s4">for </span><span class="s1">pos</span><span class="s2">, </span><span class="s1">size </span><span class="s4">in </span><span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'LINE_%d' </span><span class="s2">% </span><span class="s1">line_nb</span><span class="s2">]:</span>
                    <span class="s1">BorderImage</span><span class="s2">(</span><span class="s1">texture</span><span class="s2">=</span><span class="s1">texture</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">=</span><span class="s1">pos</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">,</span>
                                <span class="s1">border</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_border</span><span class="s2">)</span>

        <span class="s6"># then draw the text</span>
        <span class="s4">for </span><span class="s1">line_nb </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">layout_rows </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s1">key_nb </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s4">for </span><span class="s1">pos</span><span class="s2">, </span><span class="s1">size </span><span class="s4">in </span><span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'LINE_%d' </span><span class="s2">% </span><span class="s1">line_nb</span><span class="s2">]:</span>
                <span class="s6"># retrieve the relative text</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s1">layout</span><span class="s2">[</span><span class="s1">layout_mode </span><span class="s2">+ </span><span class="s3">'_' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">line_nb</span><span class="s2">)][</span><span class="s1">key_nb</span><span class="s2">][</span><span class="s5">0</span><span class="s2">]</span>
                <span class="s1">z </span><span class="s2">= </span><span class="s1">Label</span><span class="s2">(</span><span class="s1">text</span><span class="s2">=</span><span class="s1">text</span><span class="s2">, </span><span class="s1">font_size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">font_size</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">=</span><span class="s1">pos</span><span class="s2">,</span>
                           <span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">, </span><span class="s1">font_name</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">font_name</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">add_widget</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
                <span class="s1">key_nb </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4">def </span><span class="s1">on_key_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">on_key_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">on_textinput</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">largs</span><span class="s2">):</span>
        <span class="s4">pass</span>

    <span class="s4">def </span><span class="s1">get_key_at_pos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s1">x_hint </span><span class="s2">= </span><span class="s1">x </span><span class="s2">/ </span><span class="s1">w</span>
        <span class="s6"># focus on the surface without margins</span>
        <span class="s1">layout_geometry </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_geometry</span>
        <span class="s1">layout </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">available_layouts</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout</span><span class="s2">]</span>
        <span class="s1">layout_rows </span><span class="s2">= </span><span class="s1">layout</span><span class="s2">[</span><span class="s3">'rows'</span><span class="s2">]</span>
        <span class="s1">mtop</span><span class="s2">, </span><span class="s1">mright</span><span class="s2">, </span><span class="s1">mbottom</span><span class="s2">, </span><span class="s1">mleft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">margin_hint</span>

        <span class="s6"># get the line of the layout</span>
        <span class="s1">e_height </span><span class="s2">= </span><span class="s1">h </span><span class="s2">- (</span><span class="s1">mbottom </span><span class="s2">+ </span><span class="s1">mtop</span><span class="s2">) * </span><span class="s1">h  </span><span class="s6"># efficient height in pixels</span>
        <span class="s1">line_height </span><span class="s2">= </span><span class="s1">e_height </span><span class="s2">/ </span><span class="s1">layout_rows  </span><span class="s6"># line height in px</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">y </span><span class="s2">- </span><span class="s1">mbottom </span><span class="s2">* </span><span class="s1">h</span>
        <span class="s1">line_nb </span><span class="s2">= </span><span class="s1">layout_rows </span><span class="s2">- </span><span class="s1">int</span><span class="s2">(</span><span class="s1">y </span><span class="s2">/ </span><span class="s1">line_height</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">line_nb </span><span class="s2">&gt; </span><span class="s1">layout_rows</span><span class="s2">:</span>
            <span class="s1">line_nb </span><span class="s2">= </span><span class="s1">layout_rows</span>
        <span class="s4">if </span><span class="s1">line_nb </span><span class="s2">&lt; </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">line_nb </span><span class="s2">= </span><span class="s5">1</span>

        <span class="s6"># get the key within the line</span>
        <span class="s1">key_index </span><span class="s2">= </span><span class="s3">''</span>
        <span class="s1">current_key_index </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s4">for </span><span class="s1">key </span><span class="s4">in </span><span class="s1">layout_geometry</span><span class="s2">[</span><span class="s3">'LINE_HINT_%d' </span><span class="s2">% </span><span class="s1">line_nb</span><span class="s2">]:</span>
            <span class="s4">if </span><span class="s1">x_hint </span><span class="s2">&gt;= </span><span class="s1">key</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] </span><span class="s4">and </span><span class="s1">x_hint </span><span class="s2">&lt; </span><span class="s1">key</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] + </span><span class="s1">key</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s5">0</span><span class="s2">]:</span>
                <span class="s1">key_index </span><span class="s2">= </span><span class="s1">current_key_index</span>
                <span class="s4">break</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">current_key_index </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s4">if </span><span class="s1">key_index </span><span class="s2">== </span><span class="s3">''</span><span class="s2">:</span>
            <span class="s4">return None</span>

        <span class="s6"># get the full character</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s1">layout</span><span class="s2">[</span><span class="s3">'%s_%d' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">layout_mode</span><span class="s2">, </span><span class="s1">line_nb</span><span class="s2">)][</span><span class="s1">key_index</span><span class="s2">]</span>

        <span class="s4">return </span><span class="s2">[</span><span class="s1">key</span><span class="s2">, (</span><span class="s1">line_nb</span><span class="s2">, </span><span class="s1">key_index</span><span class="s2">)]</span>

    <span class="s4">def </span><span class="s1">collide_margin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">'''Do a collision test, and return True if the (x, y) is inside the 
        vkeyboard margin. 
        '''</span>
        <span class="s1">mtop</span><span class="s2">, </span><span class="s1">mright</span><span class="s2">, </span><span class="s1">mbottom</span><span class="s2">, </span><span class="s1">mleft </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">margin_hint</span>
        <span class="s1">x_hint </span><span class="s2">= </span><span class="s1">x </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span>
        <span class="s1">y_hint </span><span class="s2">= </span><span class="s1">y </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s4">if </span><span class="s1">x_hint </span><span class="s2">&gt; </span><span class="s1">mleft </span><span class="s4">and </span><span class="s1">x_hint </span><span class="s2">&lt; </span><span class="s5">1. </span><span class="s2">- </span><span class="s1">mright \</span>
                <span class="s4">and </span><span class="s1">y_hint </span><span class="s2">&gt; </span><span class="s1">mbottom </span><span class="s4">and </span><span class="s1">y_hint </span><span class="s2">&lt; </span><span class="s5">1. </span><span class="s2">- </span><span class="s1">mtop</span><span class="s2">:</span>
            <span class="s4">return False</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">process_key_on</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if not </span><span class="s1">touch</span><span class="s2">:</span>
            <span class="s4">return</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">(*</span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">)</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_key_at_pos</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">key</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s1">key_data </span><span class="s2">= </span><span class="s1">key</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">displayed_char</span><span class="s2">, </span><span class="s1">internal</span><span class="s2">, </span><span class="s1">special_char</span><span class="s2">, </span><span class="s1">size </span><span class="s2">= </span><span class="s1">key_data</span>
        <span class="s1">line_nb</span><span class="s2">, </span><span class="s1">key_index </span><span class="s2">= </span><span class="s1">key</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>

        <span class="s6"># save pressed key on the touch</span>
        <span class="s1">ud </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid</span><span class="s2">] = {}</span>
        <span class="s1">ud</span><span class="s2">[</span><span class="s3">'key'</span><span class="s2">] = </span><span class="s1">key</span>

        <span class="s6"># for caps lock or shift only:</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">uid</span>
        <span class="s4">if </span><span class="s1">special_char </span><span class="s4">is not None</span><span class="s2">:</span>
            <span class="s6"># Do not repeat special keys</span>
            <span class="s4">if </span><span class="s1">special_char </span><span class="s4">in </span><span class="s2">(</span><span class="s3">'capslock'</span><span class="s2">, </span><span class="s3">'shift'</span><span class="s2">, </span><span class="s3">'layout'</span><span class="s2">, </span><span class="s3">'special'</span><span class="s2">):</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key_ev </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key_ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key_ev </span><span class="s2">= </span><span class="s4">None</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">repeat_touch </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">if </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'capslock'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">have_capslock </span><span class="s2">= </span><span class="s4">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">have_capslock</span>
                <span class="s1">uid </span><span class="s2">= -</span><span class="s5">1</span>
            <span class="s4">elif </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'shift'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">have_shift </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s4">elif </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'special'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">have_special </span><span class="s2">= </span><span class="s4">True</span>
            <span class="s4">elif </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'layout'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">change_layout</span><span class="s2">()</span>

        <span class="s6"># send info to the bus</span>
        <span class="s1">b_keycode </span><span class="s2">= </span><span class="s1">special_char</span>
        <span class="s1">b_modifiers </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_modifiers</span><span class="s2">()</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_parent_window</span><span class="s2">().</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__module__ </span><span class="s2">== </span><span class="s1">\</span>
            <span class="s3">'kivy.core.window.window_sdl2' </span><span class="s4">and </span><span class="s1">internal</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_textinput'</span><span class="s2">, </span><span class="s1">internal</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_key_down'</span><span class="s2">, </span><span class="s1">b_keycode</span><span class="s2">, </span><span class="s1">internal</span><span class="s2">, </span><span class="s1">b_modifiers</span><span class="s2">)</span>

        <span class="s6"># save key as an active key for drawing</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys</span><span class="s2">[</span><span class="s1">uid</span><span class="s2">] = </span><span class="s1">key</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh_active_keys_layer</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">process_key_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s1">uid </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">uid</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid </span><span class="s4">not in </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">:</span>
            <span class="s4">return</span>

        <span class="s6"># save pressed key on the touch</span>
        <span class="s1">key_data</span><span class="s2">, </span><span class="s1">key </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">ud</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">uid</span><span class="s2">][</span><span class="s3">'key'</span><span class="s2">]</span>
        <span class="s1">displayed_char</span><span class="s2">, </span><span class="s1">internal</span><span class="s2">, </span><span class="s1">special_char</span><span class="s2">, </span><span class="s1">size </span><span class="s2">= </span><span class="s1">key_data</span>

        <span class="s6"># send info to the bus</span>
        <span class="s1">b_keycode </span><span class="s2">= </span><span class="s1">special_char</span>
        <span class="s1">b_modifiers </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_modifiers</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dispatch</span><span class="s2">(</span><span class="s3">'on_key_up'</span><span class="s2">, </span><span class="s1">b_keycode</span><span class="s2">, </span><span class="s1">internal</span><span class="s2">, </span><span class="s1">b_modifiers</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'capslock'</span><span class="s2">:</span>
            <span class="s1">uid </span><span class="s2">= -</span><span class="s5">1</span>

        <span class="s4">if </span><span class="s1">uid </span><span class="s4">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">uid</span><span class="s2">, </span><span class="s4">None</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'shift'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">have_shift </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">elif </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'special'</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">have_special </span><span class="s2">= </span><span class="s4">False</span>
            <span class="s4">if </span><span class="s1">special_char </span><span class="s2">== </span><span class="s3">'capslock' </span><span class="s4">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">have_capslock</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">active_keys</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">key</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">refresh_active_keys_layer</span><span class="s2">()</span>

    <span class="s4">def </span><span class="s1">_get_modifiers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ret </span><span class="s2">= []</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">have_shift</span><span class="s2">:</span>
            <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'shift'</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">have_capslock</span><span class="s2">:</span>
            <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'capslock'</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">ret</span>

    <span class="s4">def </span><span class="s1">_start_repeat_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_repeat_key_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_interval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_repeat_key</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">_repeat_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">process_key_on</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">repeat_touch</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">pos</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_point</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s4">return</span>
        <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">disabled</span><span class="s2">:</span>
            <span class="s4">return True</span>

        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">to_local</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s4">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collide_margin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">repeat_touch </span><span class="s4">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key_ev </span><span class="s2">= </span><span class="s1">Clock</span><span class="s2">.</span><span class="s1">schedule_once</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">repeat_touch </span><span class="s2">= </span><span class="s1">touch</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">process_key_on</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
            <span class="s1">touch</span><span class="s2">.</span><span class="s1">grab</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exclusive</span><span class="s2">=</span><span class="s4">True</span><span class="s2">)</span>

        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">VKeyboard</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_down</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>
        <span class="s4">return True</span>

    <span class="s4">def </span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">touch</span><span class="s2">):</span>
        <span class="s4">if </span><span class="s1">touch</span><span class="s2">.</span><span class="s1">grab_current </span><span class="s4">is </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">process_key_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key_ev </span><span class="s4">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key_ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_start_repeat_key_ev </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">if </span><span class="s1">touch </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">repeat_touch</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_repeat_key_ev </span><span class="s4">is not None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_repeat_key_ev</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_repeat_key_ev </span><span class="s2">= </span><span class="s4">None</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">repeat_touch </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s4">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">VKeyboard</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">on_touch_up</span><span class="s2">(</span><span class="s1">touch</span><span class="s2">)</span>


<span class="s4">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">'__main__'</span><span class="s2">:</span>
    <span class="s4">from </span><span class="s1">kivy</span><span class="s2">.</span><span class="s1">base </span><span class="s4">import </span><span class="s1">runTouchApp</span>
    <span class="s1">vk </span><span class="s2">= </span><span class="s1">VKeyboard</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'azerty'</span><span class="s2">)</span>
    <span class="s1">runTouchApp</span><span class="s2">(</span><span class="s1">vk</span><span class="s2">)</span>
</pre>
</body>
</html>